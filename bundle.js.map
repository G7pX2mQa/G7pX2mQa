{
  "version": 3,
  "sources": ["../js/util/bigNum.js", "../js/util/numFormat.js", "../js/util/storage.js", "../js/util/slotsManager.js", "../js/util/slots.js", "../js/util/audioCache.js", "../js/ui/hudLayout.js", "../js/game/xpSystem.js", "../js/util/ghostTapGuard.js", "../js/misc/merchantDialogues.js", "../js/game/gameLoop.js", "../js/game/automationUpgrades.js", "../js/ui/merchantTabs/workshopTab.js", "../js/ui/merchantTabs/dlgTab.js", "../js/game/automationEffects.js", "../js/ui/shopOverlay.js", "../js/ui/hudButtons.js", "../js/game/cursorTrail.js", "../js/game/coinPickup.js", "../js/ui/merchantTabs/resetTab.js", "../js/game/upgrades.js", "../js/util/debugPanel.js", "../js/game/mutationSystem.js", "../js/game/spawner.js", "../js/util/saveIntegrity.js", "../js/ui/popups.js", "../js/util/suspendSafeguard.js", "../js/util/globalOverlayEsc.js", "../js/game/offlinePanel.js", "../js/main.js", "../app.js"],
  "sourcesContent": ["// js/util/bigNum.js\r\nexport class BigNum {\r\n  static DEFAULT_PRECISION = 18;\r\n  static MAX_E = 1.7976931348623157e+308; // Number.MAX_VALUE\r\n  static MAX_PLAIN_DIGITS = 1_000_000;    // safety cap for plain integer strings\r\n\r\n  constructor(sig, e, p = BigNum.DEFAULT_PRECISION) {\r\n    this.p = p | 0;\r\n    this.sig = BigInt(sig);\r\n    this._eOffset = 0n;\r\n\r\n    if (e && typeof e === 'object' && ('base' in e || 'offset' in e || 'inf' in e)) {\r\n      const base = Number(e.base ?? 0);\r\n      const inf = !!e.inf;\r\n      if (inf || !Number.isFinite(base) || base >= BigNum.MAX_E) {\r\n        this.e = BigNum.MAX_E;\r\n        this.inf = true;\r\n        this._eOffset = 0n;\r\n      } else {\r\n        this.e = Math.trunc(base);\r\n        this.inf = false;\r\n        const off = e.offset ?? 0;\r\n        this._eOffset = typeof off === 'bigint' ? off : BigInt(off);\r\n      }\r\n    } else {\r\n      const ee = Number(e);\r\n      if (!Number.isFinite(ee) || ee >= BigNum.MAX_E) {\r\n        this.e = BigNum.MAX_E;\r\n        this.inf = true;\r\n      } else {\r\n        this.e = Math.trunc(ee);\r\n        this.inf = false;\r\n      }\r\n    }\r\n    this.#normalize();\r\n  }\r\n\r\n  // ---------------------- FACTORIES ----------------------\r\n  static zero(p = BigNum.DEFAULT_PRECISION) { return new BigNum(0n, 0, p); }\r\n\r\n  static fromInt(n, p = BigNum.DEFAULT_PRECISION) {\r\n    return new BigNum(BigInt(n), 0, p);\r\n  }\r\n\r\n  static fromScientific(str, p = BigNum.DEFAULT_PRECISION) {\r\n    const s = String(str ?? '').trim();\r\n    if (!s) throw new TypeError('Invalid BigNum input: ' + str);\r\n\r\n    if (/^inf(?:inity)?$/i.test(s)) {\r\n      return new BigNum(1n, BigNum.MAX_E, p);\r\n    }\r\n\r\n    const match = s.match(/^(\\d+)(?:\\.(\\d+))?(?:e([+-]?\\d+))?$/i);\r\n    if (!match) {\r\n      return new BigNum(BigInt(s), 0, p);\r\n    }\r\n\r\n    let [, intPart, fracPart = '', expPart] = match;\r\n    let exponent = expPart ? parseInt(expPart, 10) : 0;\r\n    exponent -= fracPart.length;\r\n\r\n    const digits = (intPart + fracPart).replace(/^0+/, '') || '0';\r\n    const sig = BigInt(digits);\r\n    return new BigNum(sig, exponent, p);\r\n  }\r\n\r\n  static fromStorage(str, p = BigNum.DEFAULT_PRECISION) {\r\n    if (!str) return null;\r\n    if (typeof str !== 'string') str = String(str);\r\n    if (str.startsWith('BN:')) {\r\n      const [, pStr, sigStr, eStr] = str.split(':');\r\n      const pp = parseInt(pStr, 10) || p;\r\n      let baseStr = eStr;\r\n      let offset = 0n;\r\n      const caret = eStr.indexOf('^');\r\n      if (caret >= 0) {\r\n        baseStr = eStr.slice(0, caret);\r\n        const offStr = eStr.slice(caret + 1) || '0';\r\n        try { offset = BigInt(offStr); }\r\n        catch { offset = 0n; }\r\n      }\r\n      let eNum = Number(baseStr);\r\n      if (!Number.isFinite(eNum)) eNum = BigNum.MAX_E;\r\n      return new BigNum(BigInt(sigStr), { base: eNum, offset }, pp);\r\n    }\r\n    return BigNum.fromScientific(str, p);\r\n  }\r\n\r\n  // Accepts: BigNum | \"BN:...\" | scientific string | number | bigint\r\n  static fromAny(input, p = BigNum.DEFAULT_PRECISION) {\r\n    if (input instanceof BigNum) return input;\r\n    if (typeof input === 'string') {\r\n      const trimmed = input.trim();\r\n      if (trimmed.startsWith('BN:')) return BigNum.fromStorage(trimmed, p);\r\n      if (/^inf(?:inity)?$/i.test(trimmed)) return new BigNum(1n, BigNum.MAX_E, p);\r\n      if (/^\\d+(?:\\.\\d+)?(?:e[+-]?\\d+)?$/i.test(trimmed)) return BigNum.fromScientific(trimmed, p);\r\n    }\r\n    if (typeof input === 'number') {\r\n      if (!Number.isFinite(input)) return new BigNum(1n, BigNum.MAX_E, p);\r\n      return BigNum.fromScientific(input.toString(), p);\r\n    }\r\n    if (typeof input === 'bigint') return BigNum.fromInt(input, p);\r\n    throw new TypeError('Unsupported BigNum input: ' + input);\r\n    }\r\n\r\n  // ---------------------- PERSISTENCE ----------------------\r\n  toStorage() {\r\n    if (this.inf) return `BN:${this.p}:${this.sig.toString()}:${BigNum.MAX_E}`;\r\n    const offsetSuffix = this._eOffset !== 0n ? `^${this._eOffset.toString()}` : '';\r\n    return `BN:${this.p}:${this.sig.toString()}:${this.e}${offsetSuffix}`;\r\n  }\r\n\r\n  clone() {\r\n    return new BigNum(this.sig, { base: this.e, offset: this._eOffset, inf: this.inf }, this.p);\r\n  }\r\n\r\n  // ---------------------- STATE QUERIES ----------------------\r\n  isZero() { return !this.inf && this.sig === 0n; }\r\n  isInfinite() { return !!this.inf; }\r\n  isNegative() { return false; }\r\n\r\n  sub(b) {\r\n    b = BigNum.fromAny(b, this.p);\r\n\r\n    if (this.inf) {\r\n      if (b.inf) return BigNum.zero(this.p);\r\n      return this.clone();\r\n    }\r\n    if (b.inf) return BigNum.zero(this.p);\r\n\r\n    if (this.cmp(b) <= 0) return BigNum.zero(this.p);\r\n\r\n    const expCmp = this.#compareExponent(b);\r\n    if (expCmp >= 0) {\r\n      const aligned = expCmp === 0 ? b.sig : this.#alignSig(b);\r\n      const diffSig = this.sig - aligned;\r\n      if (diffSig > 0n) {\r\n        return new BigNum(diffSig, this.#expObj(), this.p);\r\n      }\r\n    }\r\n\r\n    try {\r\n      const aPlain = this.toPlainIntegerString();\r\n      const bPlain = b.toPlainIntegerString();\r\n      if (aPlain === 'Infinity') return this.clone();\r\n      if (bPlain === 'Infinity') return BigNum.zero(this.p);\r\n      const diff = BigInt(aPlain) - BigInt(bPlain);\r\n      if (diff <= 0n) return BigNum.zero(this.p);\r\n      return BigNum.fromInt(diff, this.p);\r\n    } catch {\r\n      return BigNum.zero(this.p);\r\n    }\r\n  }\r\n\r\n  // ---------------------- PRIVATE HELPERS ----------------------\r\n  #pow10(k) { return k <= 0 ? 1n : 10n ** BigInt(k); }\r\n\r\n  #expObj() {\r\n    return { base: this.e, offset: this._eOffset, inf: this.inf };\r\n  }\r\n\r\n  #adjustExponent(delta) {\r\n    if (this.inf || !delta) return;\r\n    const prev = this.e;\r\n    const next = prev + delta;\r\n    this.e = Math.trunc(next);\r\n    const applied = this.e - prev;\r\n    const leftover = BigInt(delta - applied);\r\n    if (leftover) this._eOffset += leftover;\r\n  }\r\n\r\n  #totalExponentBigInt() {\r\n    if (this.inf) return this._eOffset >= 0n ? BigInt(Number.MAX_SAFE_INTEGER) : -BigInt(Number.MAX_SAFE_INTEGER);\r\n    const base = BigInt(Math.trunc(this.e));\r\n    return base + this._eOffset;\r\n  }\r\n\r\n  #compareExponent(other) {\r\n    if (this.inf || other.inf) {\r\n      if (this.inf && other.inf) return 0;\r\n      return this.inf ? 1 : -1;\r\n    }\r\n    const a = this.#totalExponentBigInt();\r\n    const b = other.#totalExponentBigInt();\r\n    if (a > b) return 1;\r\n    if (a < b) return -1;\r\n    return 0;\r\n  }\r\n\r\n  #expDiff(other) {\r\n    if (this.inf || other.inf) {\r\n      if (this.inf && other.inf) return 0n;\r\n      return this.inf ? BigInt(this.p + 3) : -BigInt(this.p + 3);\r\n    }\r\n    const diff = this.#totalExponentBigInt() - other.#totalExponentBigInt();\r\n    const absDiff = diff < 0n ? -diff : diff;\r\n    const limit = BigInt(this.p + 2);\r\n    if (absDiff > limit) {\r\n      return diff > 0n ? BigInt(this.p + 3) : -BigInt(this.p + 3);\r\n    }\r\n    return diff;\r\n  }\r\n\r\n  #offsetAsNumber() {\r\n    if (this._eOffset === 0n) return 0;\r\n    const offNum = Number(this._eOffset);\r\n    if (!Number.isFinite(offNum) || !Number.isSafeInteger(offNum)) {\r\n      return offNum > 0 ? Number.POSITIVE_INFINITY : Number.NEGATIVE_INFINITY;\r\n    }\r\n    return offNum;\r\n  }\r\n\r\n  #effectiveExponentNumber() {\r\n    if (this.inf) return Number.POSITIVE_INFINITY;\r\n    const offset = this.#offsetAsNumber();\r\n    if (!Number.isFinite(offset)) return this.e;\r\n    return this.e + offset;\r\n  }\r\n\r\n  #normalize() {\r\n    if (this.inf) return;\r\n    if (this.sig === 0n) { this.e = 0; return; }\r\n\r\n    let s = this.sig;\r\n    const p = this.p;\r\n    const d = s.toString().length;\r\n    const shift = d - p;\r\n\r\n    if (shift > 0) {\r\n      const base = this.#pow10(shift);\r\n      let q = s / base;\r\n      const r = s % base;\r\n      if (r * 2n >= base) q += 1n; // round half up\r\n      s = q;\r\n      this.#adjustExponent(shift);\r\n      if (this.e >= BigNum.MAX_E) { this.e = BigNum.MAX_E; this.inf = true; return; }\r\n      if (s.toString().length > p) { // carry overflow\r\n        s = s / 10n;\r\n        this.#adjustExponent(1);\r\n        if (this.e >= BigNum.MAX_E) { this.e = BigNum.MAX_E; this.inf = true; return; }\r\n      }\r\n    } else if (shift < 0) {\r\n      const k = -shift;\r\n      s = s * this.#pow10(k);\r\n      this.#adjustExponent(-k);\r\n    }\r\n\r\n    this.sig = s;\r\n  }\r\n\r\n  #alignSig(other) {\r\n    const diff = this.#expDiff(other);\r\n    const absDiff = diff < 0n ? -diff : diff;\r\n    if (absDiff === 0n) return other.sig;\r\n    if (absDiff > BigInt(this.p + 2)) return 0n; // negligible\r\n    const diffNum = Number(absDiff);\r\n    const base = this.#pow10(diffNum);\r\n    let q = other.sig / base;\r\n    const r = other.sig % base;\r\n    if (r * 2n >= base) q += 1n;\r\n    return q;\r\n  }\r\n\r\n  // ---------------------- ARITHMETIC ----------------------\r\n   add(b) {\r\n    b = BigNum.fromAny(b, this.p);\r\n    if (this.inf || b.inf) {\r\n      const out = this.clone(); out.inf = this.inf || b.inf; out.e = BigNum.MAX_E; return out;\r\n    }\r\n    if (this.isZero()) return b.clone();\r\n    if (b.isZero()) return this.clone();\r\n    if (this.#compareExponent(b) >= 0) {\r\n      return new BigNum(this.sig + this.#alignSig(b), this.#expObj(), this.p);\r\n    }\r\n    return b.add(this);\r\n  }\r\n\r\n  iadd(b) { const r = this.add(b); this.sig = r.sig; this.e = r.e; this._eOffset = r._eOffset; this.inf = r.inf; return this; }\r\n\r\n  mulSmall(k) {\r\n    if (k < 0) throw new Error('BigNum only supports non-negative values');\r\n    if (this.inf) return this.clone();\r\n    if (k === 0) return BigNum.zero(this.p);\r\n    if (k === 1) return this.clone();\r\n    const out = new BigNum(this.sig * BigInt(k), this.#expObj(), this.p);\r\n    return out;\r\n  }\r\n\r\n  imulSmall(k) { const r = this.mulSmall(k); this.sig = r.sig; this.e = r.e; this._eOffset = r._eOffset; this.inf = r.inf; return this; }\r\n\r\n  // Multiply by another non-negative integer BigNum (exact).\r\n  mulBigNumInteger(other) {\r\n    const b = BigNum.fromAny(other, this.p);\r\n    if (this.inf || b.inf) {\r\n      const out = this.clone();\r\n      out.inf = this.inf || b.inf;\r\n      out.e = BigNum.MAX_E;\r\n      return out;\r\n    }\r\n    if (this.isZero() || b.isZero()) return BigNum.zero(this.p);\r\n    const baseSum = this.e + b.e;\r\n    const offsetSum = this._eOffset + b._eOffset;\r\n    return new BigNum(this.sig * b.sig, { base: baseSum, offset: offsetSum }, this.p);\r\n  }\r\n\r\n  imulBigNumInteger(other) {\r\n    const r = this.mulBigNumInteger(other);\r\n    this.sig = r.sig; this.e = r.e; this._eOffset = r._eOffset; this.inf = r.inf;\r\n    return this;\r\n  }\r\n\r\n  // Divide by another BigNum (returns new BigNum).\r\n  div(other) {\r\n    const b = BigNum.fromAny(other, this.p);\r\n    \r\n    // Handle infinite cases\r\n    if (this.inf) {\r\n        if (b.inf) return new BigNum(1n, 0, this.p); // inf / inf -> 1 (or undefined, but 1 is safer for ratios)\r\n        return this.clone(); // inf / finite -> inf\r\n    }\r\n    if (b.inf) {\r\n        return BigNum.zero(this.p); // finite / inf -> 0\r\n    }\r\n    \r\n    // Handle zero cases\r\n    if (b.isZero()) {\r\n        // finite / 0 -> infinity (mathematically undefined but useful here)\r\n        return new BigNum(1n, BigNum.MAX_E, this.p);\r\n    }\r\n    if (this.isZero()) {\r\n        return BigNum.zero(this.p); // 0 / finite -> 0\r\n    }\r\n\r\n    // A / B = (sigA * 10^expA) / (sigB * 10^expB)\r\n    //       = (sigA / sigB) * 10^(expA - expB)\r\n    // To maintain precision, we scale sigA by 10^precision before integer division.\r\n    // result = (sigA * 10^p / sigB) * 10^(expA - expB - p)\r\n    \r\n    const scale = this.#pow10(this.p);\r\n    const numerator = this.sig * scale;\r\n    const sigQuotient = numerator / b.sig; // Integer division\r\n    \r\n    // Exponent calculation:\r\n    // We used 'this.e' and 'b.e' for base exponents, plus offsets.\r\n    // However, BigNum normalization ensures sig is roughly 10^(p-1) to 10^p.\r\n    // So the exponent math is mostly correct if we trust .e and ._eOffset.\r\n    \r\n    // The raw exponent difference:\r\n    const expDiffBase = BigInt(this.e) - BigInt(b.e);\r\n    const expDiffOffset = this._eOffset - b._eOffset;\r\n    \r\n    // Adjust for the scaling we did (subtracting p from the exponent because we added it to sig)\r\n    const pBigInt = BigInt(this.p);\r\n    const totalExpBase = expDiffBase - pBigInt;\r\n    \r\n    // Construct new BigNum\r\n    // We pass the total exponent info. The constructor/normalization will handle if sigQuotient is small/large.\r\n    \r\n    // We need to fit totalExpBase + expDiffOffset into {base, offset}.\r\n    // base is a Number, offset is a BigInt.\r\n    \r\n    // Try to put as much as possible into 'base' (Number) to keep offset small if possible,\r\n    // though normalization handles it.\r\n    \r\n    // Safe conversion of expDiffBase to Number?\r\n    // expDiffBase can be large if inputs are large.\r\n    \r\n    // Let's just put everything into offset first, then let constructor handle it?\r\n    // Constructor expects 'base' to be Number.\r\n    \r\n    let resultBase = Number(totalExpBase);\r\n    let resultOffset = expDiffOffset;\r\n    \r\n    if (!Number.isSafeInteger(resultBase)) {\r\n         // If base is too large/small for Number, move it to offset.\r\n         resultOffset += totalExpBase;\r\n         resultBase = 0;\r\n    }\r\n    \r\n    return new BigNum(sigQuotient, { base: resultBase, offset: resultOffset }, this.p);\r\n  }\r\n\r\n  cmp(b) {\r\n    b = BigNum.fromAny(b, this.p);\r\n    if (this.inf || b.inf) return this.inf === b.inf ? 0 : this.inf ? 1 : -1;\r\n    const thisIsZero = this.isZero();\r\n    const otherIsZero = typeof b.isZero === 'function' ? b.isZero() : false;\r\n    if (thisIsZero || otherIsZero) {\r\n      if (thisIsZero && otherIsZero) return 0;\r\n      return thisIsZero ? -1 : 1;\r\n    }\r\n    const expCmp = this.#compareExponent(b);\r\n    if (expCmp !== 0) return expCmp;\r\n    if (this.sig === b.sig) return 0;\r\n    return this.sig > b.sig ? 1 : -1;\r\n  }\r\n  // ----- Decimal multiply (exact, integer-safe) & flooring -----\r\n\r\n  // Parse decimal like \"2.345\" (or number) into { numer: BigInt, scale: int } with up to maxScale frac digits.\r\n  static _parseDecimalMultiplier(x, maxScale = BigNum.DEFAULT_PRECISION) {\r\n    let s = (typeof x === 'number') ? String(x) : String(x ?? '').trim();\r\n    if (!s || s === '0') return { numer: 0n, scale: 0 };\r\n\r\n    // normalize scientific like \"1e3\" to fixed decimal string\r\n    if (/e/i.test(s)) {\r\n      const n = Number(s);\r\n      if (!Number.isFinite(n) || n < 0) throw new TypeError('Invalid multiplier: ' + s);\r\n      const digits = Math.min(maxScale, 18);\r\n      s = n.toFixed(digits).replace(/\\.?0+$/, ''); // strip trailing zeros\r\n    }\r\n\r\n    if (!/^\\d+(\\.\\d+)?$/.test(s)) throw new TypeError('Invalid multiplier: ' + s);\r\n\r\n    const [intPart, fracRaw = ''] = s.split('.');\r\n    const frac = fracRaw.slice(0, maxScale); // clamp fractional length\r\n    const scale = frac.length;\r\n    const numer = BigInt(intPart + frac);\r\n    return { numer, scale };\r\n  }\r\n\r\n  // Multiply by decimal multiplier given as number/string with up to 18 fractional digits (returns new BigNum).\r\n  mulDecimal(mult, maxScale = BigNum.DEFAULT_PRECISION) {\r\n    if (this.inf || this.isZero()) return this.clone();\r\n    const { numer, scale } = BigNum._parseDecimalMultiplier(mult, maxScale);\r\n    if (numer === 0n) return BigNum.zero(this.p);\r\n    return this.mulScaledInt(numer, scale);\r\n  }\r\n\r\n  // Floor to integer value by dropping fractional digits.\r\n  floorToInteger() {\r\n    if (this.inf) return this.clone();\r\n    if (this.isZero()) return this.clone();\r\n    const exp = this.#effectiveExponentNumber();\r\n    if (!Number.isFinite(exp)) return this.clone();\r\n    const intDigits = exp + this.p; // integer digits in the value\r\n    if (intDigits <= 0) return BigNum.zero(this.p); // < 1\r\n    if (intDigits >= this.p) return this.clone();   // already integral\r\n    const drop = this.p - intDigits;                // digits to truncate\r\n    const base = 10n ** BigInt(drop);\r\n    const newSig = (this.sig / base) * base;        // drop fractional digits\r\n    return new BigNum(newSig, this.#expObj(), this.p);\r\n  }\r\n\r\n  // Convenience: multiply by decimal and floor to integer immediately.\r\n  mulDecimalFloor(mult, maxScale = BigNum.DEFAULT_PRECISION) {\r\n    return this.mulDecimal(mult, maxScale).floorToInteger();\r\n  }\r\n\r\n  mulScaledInt(numerBigInt, scale) {\r\n    if (this.inf || this.isZero()) return this.clone();\r\n    const nb = BigInt(numerBigInt);\r\n    if (nb === 0n) return BigNum.zero(this.p);\r\n    return new BigNum(this.sig * nb, this.e - (scale | 0), this.p);\r\n  }\r\n\r\n  // Same as above but floors to an integer.\r\n  mulScaledIntFloor(numerBigInt, scale) {\r\n    return this.mulScaledInt(numerBigInt, scale).floorToInteger();\r\n  }\r\n\r\n  // ---------------------- FORMATTING ----------------------\r\n  get decExp() {\r\n    if (this.inf) return Number.POSITIVE_INFINITY;\r\n    const exp = this.#effectiveExponentNumber();\r\n    if (!Number.isFinite(exp)) return this.e + (this.p - 1);\r\n    return exp + (this.p - 1);\r\n  }\r\n\r\n  toScientific(digits = 3) {\r\n    if (this.inf) return 'Infinity';\r\n    if (this.isZero()) return '0';\r\n    const s = this.sig.toString().padStart(this.p, '0');\r\n    const head = s[0];\r\n    const tail = s.slice(1, 1 + digits).replace(/0+$/g, '');\r\n    const mant = tail ? `${head}.${tail}` : head;\r\n    const exp = this.#effectiveExponentNumber();\r\n    const E = Number.isFinite(exp) ? (exp + (this.p - 1)) : (this.e + (this.p - 1));\r\n    return `${mant}e${E}`;\r\n  }\r\n\r\n  toPlainIntegerString() {\r\n    if (this.inf) return 'Infinity';\r\n    if (this.isZero()) return '0';\r\n    const exp = this.#effectiveExponentNumber();\r\n    if (!Number.isFinite(exp)) return 'Infinity';\r\n    const intDigits = exp + this.p;\r\n    if (intDigits <= 0) return '0';\r\n    if (intDigits > BigNum.MAX_PLAIN_DIGITS) return 'Infinity';\r\n\r\n    const s = this.sig.toString().padStart(this.p, '0');\r\n    if (intDigits <= this.p) {\r\n      return s.slice(0, intDigits).replace(/^0+/, '') || '0';\r\n    }\r\n\r\n    const extraZeros = intDigits - this.p;\r\n    return (s + '0'.repeat(extraZeros)).replace(/^0+/, '') || '0';\r\n  }\r\n\r\n  toString() {\r\n    return this.toPlainIntegerString();\r\n  }\r\n}\r\n", "// js/util/numFormat.js\r\n// Policy:\r\n//  - < 1e6: plain integer using the user's locale (grouping)\r\n//  - 1e6 .. < 1e303: suffix table (\"M,B,T,Qd,...\") with FOUR visible digits\r\n//  - >= 1e303: scientific, but with a pretty *recursive* exponent\r\n//\r\n// Also prettifies the exponent itself (e.g., 1.000e1,000 / 1.000e1.000Qd / 1.000e1.000e308)\r\n\r\nimport { BigNum } from './bigNum.js';\r\n\r\n// Suffixes copied from CCC (descending exponents).\r\nconst SUFFIX_ENTRIES = [\r\n  [300,'NoNg'],[297,'OcNg'],[294,'SpNg'],[291,'SxNg'],[288,'QnNg'],[285,'QdNg'],[282,'TNg'],[279,'DNg'],[276,'UNg'],[273,'Ng'],\r\n  [270,'NoOg'],[267,'OcOg'],[264,'SpOg'],[261,'SxOg'],[258,'QnOg'],[255,'QdOg'],[252,'TOg'],[249,'DOg'],[246,'UOg'],[243,'Og'],\r\n  [240,'NoSg'],[237,'OcSg'],[234,'SpSg'],[231,'SxSg'],[228,'QnSg'],[225,'QdSg'],[222,'TSg'],[219,'DSg'],[216,'USg'],[213,'Sg'],\r\n  [210,'Nosg'],[207,'Ocsg'],[204,'Spsg'],[201,'Sxsg'],[198,'Qnsg'],[195,'Qdsg'],[192,'Tsg'],[189,'Dsg'],[186,'Usg'],[183,'sg'],\r\n  [180,'NoQg'],[177,'OcQg'],[174,'SpQg'],[171,'SxQg'],[168,'QnQg'],[165,'QdQg'],[162,'TQg'],[159,'DQg'],[156,'UQg'],[153,'Qg'],\r\n  [150,'Noqg'],[147,'Ocqg'],[144,'Spqg'],[141,'Sxqg'],[138,'Qnqg'],[135,'Qdqg'],[132,'Tqg'],[129,'Dqg'],[126,'Uqg'],[123,'qg'],\r\n  [120,'NoTg'],[117,'OcTg'],[114,'SpTg'],[111,'SxTg'],[108,'QnTg'],[105,'QdTg'],[102,'TTg'],[99,'DTg'],[96,'UTg'],[93,'Tg'],\r\n  [90,'NoVt'],[87,'OcVt'],[84,'SpVt'],[81,'SxVt'],[78,'QnVt'],[75,'QdVt'],[72,'TVt'],[69,'DVt'],[66,'UVt'],[63,'Vt'],\r\n  [60,'NoDe'],[57,'OcDe'],[54,'SpDe'],[51,'SxDe'],[48,'QnDe'],[45,'QdDe'],[42,'TDe'],[39,'DDe'],[36,'UDe'],[33,'De'],\r\n  [30,'No'],[27,'Oc'],[24,'Sp'],[21,'Sx'],[18,'Qn'],[15,'Qd'],[12,'T'],[9,'B'],[6,'M']\r\n];\r\nconst SUFFIX_BY_EXP = new Map(SUFFIX_ENTRIES);\r\n\r\nconst NF_INT = new Intl.NumberFormat(undefined, { maximumFractionDigits: 0, useGrouping: true });\r\nfunction localeInt(s) {\r\n  const num = Number(s);\r\n\r\n  // Safari throws a RangeError when formatting non-finite values via Intl.NumberFormat;\r\n  // treat them as plain strings instead so the UI doesn't silently break on mobile.\r\n  if (!Number.isFinite(num)) return String(s);\r\n\r\n  try { return NF_INT.format(num); }\r\n  catch { return String(s); }\r\n}\r\n\r\n// --- add 1 to a decimal digit-string (for rounding) ---\r\nfunction addOneDigitString(str){\r\n  let carry = 1, a = str.split('');\r\n  for (let i = a.length - 1; i >= 0 && carry; i--) {\r\n    let d = a[i].charCodeAt(0) - 48 + carry;\r\n    carry = d >= 10 ? 1 : 0;\r\n    a[i] = String.fromCharCode(48 + (d % 10));\r\n  }\r\n  if (carry) a.unshift('1');\r\n  return a.join('');\r\n}\r\n\r\nfunction formatExponentString(rawDigits, sign = '') {\r\n  let ds = (rawDigits || '').replace(/^0+/, '') || '0';\r\n\r\n  if (ds.length < 4) return sign + localeInt(ds);          // < 1,000\r\n  if (ds.length <= 7) {                                     // 1,000 .. 1,000,000\r\n    const n = Number(ds);\r\n    if (Number.isFinite(n) && n <= 1_000_000) return sign + NF_INT.format(n);\r\n  }\r\n\r\n  const E = ds.length - 1;\r\n\r\n  if (E <= 300) {\r\n    const exp = Math.floor(E / 3) * 3;\r\n    const suffix = SUFFIX_BY_EXP.get(exp) || '';\r\n    const d = E - exp;              // 0..2\r\n    const intDigits = d + 1;        // 1..3\r\n    const decimals = 4 - intDigits; // to keep FOUR visible digits\r\n    const totalDigits = intDigits + decimals;\r\n\r\n    if (ds.length < totalDigits + 1) ds += '0'.repeat(totalDigits + 1 - ds.length);\r\n    let head = ds.slice(0, totalDigits);\r\n    const nextDigit = ds.charCodeAt(totalDigits) || 48;\r\n    if (nextDigit >= 53) head = addOneDigitString(head);\r\n\r\n    let intStr, fracStr;\r\n    if (head.length > totalDigits) { intStr = head.slice(0, intDigits + 1); fracStr = '0'.repeat(decimals); }\r\n    else { intStr = head.slice(0, intDigits); fracStr = head.slice(intDigits); }\r\n\r\n    return sign + `${intStr}${decimals ? '.' + fracStr : ''}${suffix}`;\r\n  }\r\n\r\n  // Beyond our table: show scientific-within-exponent with FOUR-digit mantissa\r\n  const totalDigits = 4; // 1 integer + 3 decimals\r\n  if (ds.length < totalDigits + 1) ds += '0'.repeat(totalDigits + 1 - ds.length);\r\n  let head = ds.slice(0, totalDigits);\r\n  const nextDigit = ds.charCodeAt(totalDigits) || 48;\r\n  if (nextDigit >= 53) head = addOneDigitString(head);\r\n\r\n  const mantInt  = head.slice(0, 1);\r\n  const mantFrac = head.slice(1);\r\n  return sign + `${mantInt}.${mantFrac}e` + formatExponentString(String(E));\r\n}\r\n\r\nfunction formatPowerOf10Exponent(kDigits, sign = '') {\r\n  // Fast path to detect k \u2265 303 without bigints\r\n  let ge303 = false, k = 0;\r\n  if (kDigits.length > 3) ge303 = true;\r\n  else { k = parseInt(kDigits || '0', 10) || 0; ge303 = (k >= 303); }\r\n\r\n  if (ge303) {\r\n    // Scientific inside exponent; pretty-format k itself (locale + suffix rules)\r\n    return sign + '1.000e' + formatExponentString(kDigits);\r\n  }\r\n\r\n  // 0..302 \u2192 suffix tier plus remainder-driven mantissa\r\n  const exp = Math.floor(k / 3) * 3;          // 0,3,6,...,300\r\n  const suffix = SUFFIX_BY_EXP.get(exp) || '';\r\n\r\n  const remainder = k - exp;                   // 0,1,2\r\n  // FOUR visible digits before the suffix:\r\n  //  r=0 \u2192 \"1.000\", r=1 \u2192 \"10.00\", r=2 \u2192 \"100.0\"\r\n  const intPart   = (remainder === 0) ? '1' : (remainder === 1) ? '10' : '100';\r\n  const decimals  = 4 - (remainder + 1);      // 3,2,1\r\n  const fracPart  = decimals ? ('.' + '0'.repeat(decimals)) : '';\r\n\r\n  return sign + intPart + fracPart + suffix;\r\n}\r\n\r\nfunction formatExponentChain(expRaw) {\r\n  expRaw = String(expRaw).trim();\r\n\r\n  // Optional leading sign on the whole exponent; suppress '+'\r\n  let topSign = '';\r\n  if (expRaw[0] === '+' || expRaw[0] === '-') {\r\n    topSign = (expRaw[0] === '-') ? '-' : '';\r\n    expRaw = expRaw.slice(1);\r\n  }\r\n\r\n  // Case A: pure digits (e.g., \"...e305\") \u2192 delegate to our big-int pretty printer\r\n  if (/^\\d+$/.test(expRaw)) return topSign + formatExponentString(expRaw);\r\n\r\n  // Case B: scientific inside the exponent: \"m e \u00B1 k\"\r\n  const m = expRaw.match(/^(\\d+)(?:\\.(\\d+))?e([+-]?)(\\d+)$/i);\r\n  if (!m) return topSign + expRaw; // unknown form \u2192 keep as-is\r\n\r\n  const [, int, frac = '', sign2, kDigits] = m;\r\n\r\n  // Is k >= 303? (length check avoids unsafe parse)\r\n  let kGe303 = false, k = 0;\r\n  if (kDigits.length > 3) kGe303 = true;\r\n  else { k = parseInt(kDigits || '0', 10) || 0; kGe303 = (k >= 303); }\r\n\r\n  // First, compute a FOUR-digit mantissa from m (rounded)\r\n  // We'll shift the decimal by (k % 3) for suffix-tiers.\r\n  let ds = (int + frac).replace(/^0+/, '') || '0';\r\n  if (ds.length < 5) ds += '0'.repeat(5 - ds.length);\r\n  let four = ds.slice(0, 4);\r\n  const next = ds.charCodeAt(4) || 48;\r\n  if (next >= 53) four = addOneDigitString(four); // handle rounding carry later\r\n\r\n  if (kGe303) {\r\n    // Beyond our suffix table inside the exponent \u2192 scientific-of-exponent\r\n    // Keep the (rounded) exponent mantissa (\"3.617\") and pretty-format k itself.\r\n    const mant = four.slice(0,1) + '.' + four.slice(1);\r\n    const sign2Prefix = (sign2 === '-') ? '-' : '';\r\n    return topSign + mant + 'e' + formatExponentString(kDigits, sign2Prefix);\r\n  }\r\n\r\n  // Within our suffix table: choose suffix and place the decimal based on remainder\r\n  const exp = Math.floor(k / 3) * 3;          // 0,3,6,...,300\r\n  const suffix = SUFFIX_BY_EXP.get(exp) || '';\r\n  const remainder = k - exp;                   // 0,1,2\r\n\r\n  // Shift decimal: r=0 \u2192 \"1.234\", r=1 \u2192 \"12.34\", r=2 \u2192 \"123.4\"\r\n  const intDigits = remainder + 1;             // 1..3\r\n  const decimals  = 4 - intDigits;             // 3..1\r\n  let intStr, fracStr;\r\n  if (four.length > 4) { // carry overflow \u2192 one extra int digit, pad decimals with zeros\r\n    intStr = four.slice(0, intDigits + 1);\r\n    fracStr = '0'.repeat(decimals);\r\n  } else {\r\n    intStr = four.slice(0, intDigits);\r\n    fracStr = four.slice(intDigits);\r\n  }\r\n\r\n  const sign2Prefix = (sign2 === '-') ? '-' : '';\r\n  return topSign + sign2Prefix + intStr + (decimals ? ('.' + fracStr) : '') + suffix;\r\n}\r\n\r\n /* Ensures the mantissa is always  4 digits */\r\nfunction mantissaFourDigits(sci) {\r\n  const i = sci.toLowerCase().indexOf('e');\r\n  if (i < 0) return sci;\r\n\r\n  // --- Normalize mantissa to exactly 4 significant digits (1.xxx) with rounding ---\r\n  const rawMant = sci.slice(0, i);           // e.g., \"3.2\", \"12.34\" (should be 1.x form from toScientific)\r\n  // Build digit string (no dot)\r\n  let ds = rawMant.replace('.', '');\r\n  if (!/^\\d+$/.test(ds)) return sci;         // safety: if parsing failed, bail out\r\n\r\n  // Pad to at least 5 digits (4 kept + 1 for rounding)\r\n  if (ds.length < 5) ds += '0'.repeat(5 - ds.length);\r\n\r\n  // First 4 digits are kept (rounded by the 5th)\r\n  let head = ds.slice(0, 4);\r\n  const next = ds.charCodeAt(4) || 48;       // '0' if missing\r\n  if (next >= 53) head = addOneDigitString(head);\r\n\r\n  // If carry overflow happened (e.g., 9.999 -> 10.00), re-normalize to 1.xxx by shifting\r\n  if (head.length > 4) head = head.slice(0, 4); // head is now \"1000\" after carry; that still prints as \"1.000\" below\r\n\r\n  const mantissa = head.slice(0,1) + '.' + head.slice(1); // \"1.234\" style with trailing zeros preserved\r\n\r\n  // --- Pretty-format the exponent tail (can be \"305\" or \"1e+100\" etc.) ---\r\n  const rawExp = sci.slice(i + 1);\r\n  return mantissa + 'e' + formatExponentChain(rawExp);\r\n}\r\n\r\n// Public API\r\nexport function formatNumber(bn){\r\n  if (!(bn instanceof BigNum)) return String(bn);\r\n  if (bn.isInfinite && bn.isInfinite()) return '<span class=\"infinity-symbol\">\u221E</span>';\r\n  if (bn.isZero()) return '0';\r\n\r\n  const E = bn.decExp ?? (bn.e + (bn.p - 1)); // decimal exponent\r\n\r\n  // Scientific for >= 1e303 (but pretty-print the exponent chain)\r\n  if (E >= 303) {\r\n    return mantissaFourDigits(bn.toScientific(3));\r\n  }\r\n\r\n  // Plain integers < 1e6 \u2192 locale grouping\r\n  if (E < 6) {\r\n    return localeInt(bn.toPlainIntegerString());\r\n  }\r\n\r\n  // Suffix formatting using the legacy table\r\n  const exp = Math.floor(E / 3) * 3;\r\n  const suffix = SUFFIX_BY_EXP.get(exp);\r\n  if (!suffix) return mantissaFourDigits(bn.toScientific(3));\r\n\r\n  const d = E - exp;                 // 0..2\r\n  const intDigits = d + 1;           // 1..3\r\n  const decimals  = 4 - intDigits;   // make FOUR visible digits\r\n  const totalDigits = intDigits + decimals;\r\n\r\n  let s = bn.sig.toString().padStart(bn.p, '0');\r\n  if (s.length < totalDigits + 1) s += '0'.repeat(totalDigits + 1 - s.length);\r\n\r\n  let head = s.slice(0, totalDigits);\r\n  const nextDigit = s.charCodeAt(totalDigits) || 48;\r\n  if (nextDigit >= 53) head = addOneDigitString(head);\r\n\r\n  let intStr, fracStr;\r\n  if (head.length > totalDigits) { intStr = head.slice(0, intDigits + 1); fracStr = '0'.repeat(decimals); }\r\n  else { intStr = head.slice(0, intDigits); fracStr = head.slice(intDigits); }\r\n\r\n  return `${intStr}${decimals ? '.' + fracStr : ''}${suffix}`;\r\n}\r\n", "// js/util/storage.js\r\nimport { BigNum } from '../util/bigNum.js';\r\nimport { formatNumber } from '../util/numFormat.js';\r\n\r\nconst PREFIX = 'ccc:';\r\nexport const STORAGE_PREFIX = PREFIX;\r\n\r\nconst SLOT_SIGNATURE_PREFIX = `${PREFIX}slotSig`;\r\nconst SLOT_MODIFIED_PREFIX = `${PREFIX}slotMod`;\r\n\r\nconst MULT_SCALE = 18;\r\nconst MULT_SCALE_TAG = 'XM:';\r\n\r\nconst STORAGE_WATCH_INTERVAL_MS = 140;\r\n\r\nconst storageWatchers = new Map();\r\nlet storageWatcherTimer = null;\r\n\r\nconst currencyChangeSubscribers = new Set();\r\n\r\nfunction normalizeSlotValue(slot) {\r\n  const n = parseInt(slot, 10);\r\n  return Number.isFinite(n) && n > 0 ? n : null;\r\n}\r\n\r\nfunction slotSignatureKey(slot) {\r\n  const normalized = normalizeSlotValue(slot);\r\n  if (normalized == null) return null;\r\n  return `${SLOT_SIGNATURE_PREFIX}:${normalized}`;\r\n}\r\n\r\nfunction slotModifiedKey(slot) {\r\n  const normalized = normalizeSlotValue(slot);\r\n  if (normalized == null) return null;\r\n  return `${SLOT_MODIFIED_PREFIX}:${normalized}`;\r\n}\r\n\r\nfunction notifyCurrencySubscribers(detail = {}) {\r\n  if (currencyChangeSubscribers.size === 0) return;\r\n  currencyChangeSubscribers.forEach((entry) => {\r\n    if (!entry || typeof entry.handler !== 'function') return;\r\n    if (entry.key && detail.key && entry.key !== detail.key) return;\r\n    if (entry.slot != null && detail.slot != null && entry.slot !== detail.slot) return;\r\n    try { entry.handler(detail); }\r\n    catch {}\r\n  });\r\n}\r\n\r\nexport function onCurrencyChange(handler, { key = null, slot = null } = {}) {\r\n  if (typeof handler !== 'function') {\r\n    return () => {};\r\n  }\r\n  const entry = {\r\n    handler,\r\n    key: key ?? null,\r\n    slot: slot ?? null,\r\n  };\r\n  currencyChangeSubscribers.add(entry);\r\n  return () => {\r\n    currencyChangeSubscribers.delete(entry);\r\n  };\r\n}\r\n\r\nfunction ensureStorageWatcherTimer() {\r\n  if (storageWatcherTimer != null || storageWatchers.size === 0) return;\r\n  const root = typeof window !== 'undefined' ? window : globalThis;\r\n  storageWatcherTimer = root.setInterval(runStorageWatchers, STORAGE_WATCH_INTERVAL_MS);\r\n}\r\n\r\nfunction stopStorageWatcherTimerIfIdle() {\r\n  if (storageWatchers.size !== 0 || storageWatcherTimer == null) return;\r\n  const root = typeof window !== 'undefined' ? window : globalThis;\r\n  root.clearInterval(storageWatcherTimer);\r\n  storageWatcherTimer = null;\r\n}\r\n\r\nfunction parseWith(entry, raw) {\r\n  if (!entry || typeof entry.parse !== 'function') return raw;\r\n  try {\r\n    return entry.parse(raw);\r\n  } catch {\r\n    return raw;\r\n  }\r\n}\r\n\r\nfunction valuesEqual(entry, a, b) {\r\n  if (!entry || typeof entry.equals !== 'function') {\r\n    return Object.is(a, b);\r\n  }\r\n  try {\r\n    return entry.equals(a, b);\r\n  } catch {\r\n    return Object.is(a, b);\r\n  }\r\n}\r\n\r\nfunction runStorageWatchers() {\r\n  if (storageWatchers.size === 0) {\r\n    stopStorageWatcherTimerIfIdle();\r\n    return;\r\n  }\r\n  storageWatchers.forEach((entries, key) => {\r\n    if (!entries || entries.size === 0) return;\r\n    let raw;\r\n    try {\r\n      raw = localStorage.getItem(key);\r\n    } catch {\r\n      raw = null;\r\n    }\r\n    entries.forEach((entry) => {\r\n      if (!entry) return;\r\n      const parsed = parseWith(entry, raw);\r\n      if (!entry.initialized) {\r\n        entry.lastRaw = raw;\r\n        entry.lastValue = parsed;\r\n        entry.initialized = true;\r\n        if (entry.emitCurrentValue) {\r\n          try {\r\n            entry.onChange?.(parsed, {\r\n              key,\r\n              raw,\r\n              previous: undefined,\r\n              previousRaw: undefined,\r\n              initial: true,\r\n              rawChanged: true,\r\n              valueChanged: true,\r\n            });\r\n          } catch {}\r\n        }\r\n        return;\r\n      }\r\n      const rawChanged = raw !== entry.lastRaw;\r\n      const valueChanged = !valuesEqual(entry, entry.lastValue, parsed);\r\n      if (!rawChanged && !valueChanged) return;\r\n      const previousValue = entry.lastValue;\r\n      const previousRaw = entry.lastRaw;\r\n      entry.lastRaw = raw;\r\n      entry.lastValue = parsed;\r\n      try {\r\n        entry.onChange?.(parsed, {\r\n          key,\r\n          raw,\r\n          previous: previousValue,\r\n          previousRaw,\r\n          rawChanged,\r\n          valueChanged,\r\n        });\r\n      } catch {}\r\n    });\r\n  });\r\n}\r\n\r\nexport function watchStorageKey(key, {\r\n  parse,\r\n  equals,\r\n  onChange,\r\n  emitCurrentValue = false,\r\n} = {}) {\r\n  if (!key || typeof localStorage === 'undefined') {\r\n    return () => {};\r\n  }\r\n  const entry = {\r\n    parse,\r\n    equals,\r\n    onChange,\r\n    emitCurrentValue,\r\n    lastRaw: undefined,\r\n    lastValue: undefined,\r\n    initialized: false,\r\n  };\r\n  let set = storageWatchers.get(key);\r\n  if (!set) {\r\n    set = new Set();\r\n    storageWatchers.set(key, set);\r\n  }\r\n  set.add(entry);\r\n  ensureStorageWatcherTimer();\r\n  return () => {\r\n    const entries = storageWatchers.get(key);\r\n    if (!entries) return;\r\n    entries.delete(entry);\r\n    if (entries.size === 0) {\r\n      storageWatchers.delete(key);\r\n      stopStorageWatcherTimerIfIdle();\r\n    }\r\n  };\r\n}\r\n\r\nexport function primeStorageWatcherSnapshot(key, rawValue) {\r\n  if (!key) return;\r\n  const entries = storageWatchers.get(key);\r\n  if (!entries || entries.size === 0) return;\r\n  let raw = rawValue;\r\n  if (raw === undefined) {\r\n    try {\r\n      raw = localStorage.getItem(key);\r\n    } catch {\r\n      raw = null;\r\n    }\r\n  }\r\n  entries.forEach((entry) => {\r\n    if (!entry) return;\r\n    entry.lastRaw = raw;\r\n    entry.lastValue = parseWith(entry, raw);\r\n    entry.initialized = true;\r\n  });\r\n}\r\n\r\nfunction bigNumEquals(a, b) {\r\n  if (a === b) return true;\r\n  if (a == null || b == null) return a == null && b == null;\r\n  if (a instanceof BigNum && typeof a.cmp === 'function') {\r\n    try { return a.cmp(b) === 0; } catch {}\r\n  }\r\n  if (b instanceof BigNum && typeof b.cmp === 'function') {\r\n    try { return b.cmp(a) === 0; } catch {}\r\n  }\r\n  if (typeof a?.cmp === 'function') {\r\n    try { return a.cmp(b) === 0; } catch {}\r\n  }\r\n  if (typeof b?.cmp === 'function') {\r\n    try { return b.cmp(a) === 0; } catch {}\r\n  }\r\n  try {\r\n    return Object.is(String(a), String(b));\r\n  } catch {\r\n    return Object.is(a, b);\r\n  }\r\n}\r\n\r\nfunction parseBigNumOrZero(raw) {\r\n  if (raw == null) return BigNum.fromInt(0);\r\n  try {\r\n    return BigNum.fromAny(raw);\r\n  } catch {\r\n    return BigNum.fromInt(0);\r\n  }\r\n}\r\n\r\nconst currencyWatcherCleanup = new Map();\r\nlet currencyWatcherBoundSlot = null;\r\n\r\nfunction cleanupCurrencyWatchers() {\r\n  currencyWatcherCleanup.forEach((stop) => {\r\n    try { stop?.(); } catch {}\r\n  });\r\n  currencyWatcherCleanup.clear();\r\n}\r\n\r\nfunction bindCurrencyWatchersForSlot(slot) {\r\n  if (slot === currencyWatcherBoundSlot) return;\r\n  cleanupCurrencyWatchers();\r\n  currencyWatcherBoundSlot = slot ?? null;\r\n  if (slot == null) return;\r\n  for (const currencyKey of Object.values(CURRENCIES)) {\r\n    const storageKey = `${KEYS.CURRENCY[currencyKey]}:${slot}`;\r\n    const stop = watchStorageKey(storageKey, {\r\n      parse: parseBigNumOrZero,\r\n      equals: bigNumEquals,\r\n      onChange: (value, meta) => {\r\n        if (!meta?.valueChanged) return;\r\n        if (typeof window === 'undefined') return;\r\n        const detail = { key: currencyKey, value, slot };\r\n        notifyCurrencySubscribers(detail);\r\n        try {\r\n          window.dispatchEvent(new CustomEvent('currency:change', { detail }));\r\n        } catch {}\r\n      },\r\n    });\r\n    currencyWatcherCleanup.set(storageKey, stop);\r\n  }\r\n}\r\n\r\nfunction initCurrencyStorageWatchers() {\r\n  if (typeof window === 'undefined') return;\r\n  bindCurrencyWatchersForSlot(getActiveSlot());\r\n  window.addEventListener('saveSlot:change', () => {\r\n    bindCurrencyWatchersForSlot(getActiveSlot());\r\n  });\r\n}\r\n\r\n// -------------------- HEARTBEAT / OFFLINE TRACKING --------------------\r\nlet lastSaveTimeTimer = null;\r\nlet hasEnteredGameSession = false;\r\n\r\nexport function notifyGameSessionStarted() {\r\n  hasEnteredGameSession = true;\r\n}\r\n\r\nexport function getLastSaveTimeKey(slot = getActiveSlot()) {\r\n  if (slot == null) return null;\r\n  return `${PREFIX}lastSaveTime:${slot}`;\r\n}\r\n\r\nexport function updateLastSaveTime() {\r\n  if (!hasEnteredGameSession) return;\r\n  // If the document is hidden, we STOP updating the heartbeat.\r\n  // This causes the lastSaveTime to \"drift\" into the past,\r\n  // so when the user returns, (Date.now() - lastSaveTime) reflects\r\n  // the entire time they were away/tabbed-out.\r\n  if (document.hidden) return;\r\n  \r\n  const slot = getActiveSlot();\r\n  if (slot == null) return;\r\n  const now = Date.now();\r\n  try {\r\n    localStorage.setItem(getLastSaveTimeKey(slot), String(now));\r\n  } catch {}\r\n}\r\n\r\nexport function getLastSaveTime() {\r\n  const slot = getActiveSlot();\r\n  if (slot == null) return 0;\r\n  try {\r\n    const raw = localStorage.getItem(getLastSaveTimeKey(slot));\r\n    const val = parseInt(raw, 10);\r\n    return Number.isFinite(val) ? val : 0;\r\n  } catch {\r\n    return 0;\r\n  }\r\n}\r\n\r\nfunction initHeartbeat() {\r\n  if (typeof window === 'undefined') return;\r\n  \r\n  // Update every 1 second (was 2s), but only if visible\r\n  if (!lastSaveTimeTimer) {\r\n    lastSaveTimeTimer = setInterval(updateLastSaveTime, 1000);\r\n  }\r\n\r\n  // Ensure we save immediately before unloading\r\n  window.addEventListener('beforeunload', () => {\r\n      // Force update regardless of visibility state on unload\r\n      if (!hasEnteredGameSession) return;\r\n      const slot = getActiveSlot();\r\n      if (slot != null) {\r\n          try { localStorage.setItem(getLastSaveTimeKey(slot), String(Date.now())); } catch {}\r\n      }\r\n  });\r\n  \r\n  // When coming back to visibility, we do NOT update immediately here.\r\n  // We let the game loop or offline tracker handle the time diff first.\r\n}\r\n\r\ninitHeartbeat();\r\n\r\n// -------------------- KEYS --------------------\r\nexport const KEYS = {\r\n  HAS_OPENED_SAVE_SLOT: `${PREFIX}hasOpenedSaveSlot`,\r\n  SAVE_SLOT:            `${PREFIX}saveSlot`,\r\n  CURRENCY:   {},\r\n  MULTIPLIER: {},\r\n};\r\n\r\n// -------------------- CURRENCIES --------------------\r\nexport const CURRENCIES = {\r\n  COINS: 'coins',\r\n  BOOKS: 'books',\r\n  GOLD: 'gold',\r\n  MAGIC: 'magic',\r\n  GEARS: 'gears',\r\n  WAVES: 'waves',\r\n};\r\n\r\nlet _activeSlotCache = undefined;\r\n\r\nexport function getActiveSlot() {\r\n  if (_activeSlotCache !== undefined) return _activeSlotCache;\r\n  const raw = localStorage.getItem(KEYS.SAVE_SLOT);\r\n  const n = parseInt(raw, 10);\r\n  const val = Number.isFinite(n) && n > 0 ? n : null;\r\n  _activeSlotCache = val;\r\n  return val;\r\n}\r\n\r\nexport function setActiveSlot(n) {\r\n  const v = Math.max(1, parseInt(n, 10) || 1);\r\n  _activeSlotCache = v;\r\n  localStorage.setItem(KEYS.SAVE_SLOT, String(v));\r\n  try {\r\n    window.dispatchEvent(new CustomEvent('saveSlot:change', { detail: { slot: v } }));\r\n  } catch {}\r\n}\r\n\r\nexport function clearActiveSlot() {\r\n  _activeSlotCache = null;\r\n  localStorage.removeItem(KEYS.SAVE_SLOT);\r\n}\r\n\r\nif (typeof window !== 'undefined') {\r\n  window.addEventListener('storage', (e) => {\r\n    if (e.key === KEYS.SAVE_SLOT) {\r\n      if (e.newValue === null) {\r\n        _activeSlotCache = null;\r\n      } else {\r\n        const n = parseInt(e.newValue, 10);\r\n        _activeSlotCache = Number.isFinite(n) && n > 0 ? n : null;\r\n      }\r\n      try {\r\n         window.dispatchEvent(new CustomEvent('saveSlot:change', { detail: { slot: _activeSlotCache } }));\r\n      } catch {}\r\n    }\r\n  });\r\n}\r\n\r\nfunction keyFor(base, slot = getActiveSlot()) {\r\n  if (slot == null) return null;\r\n  return `${base}:${slot}`;\r\n}\r\n\r\nfunction isDebugLocked(key) {\r\n  try {\r\n    const lockedKeys = globalThis?.__cccLockedStorageKeys;\r\n    return lockedKeys?.has?.(key) ?? false;\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\nexport function isStorageKeyLocked(key) {\r\n  return isDebugLocked(key);\r\n}\r\n\r\nexport function getSlotSignatureKey(slot = getActiveSlot()) {\r\n  return slotSignatureKey(slot);\r\n}\r\n\r\nexport function getSlotModifiedFlagKey(slot = getActiveSlot()) {\r\n  return slotModifiedKey(slot);\r\n}\r\n\r\nexport function getSlotSignature(slot = getActiveSlot()) {\r\n  if (typeof localStorage === 'undefined') return null;\r\n  const key = slotSignatureKey(slot);\r\n  if (!key) return null;\r\n  try { return localStorage.getItem(key); }\r\n  catch { return null; }\r\n}\r\n\r\nexport function setSlotSignature(slot, signature) {\r\n  if (typeof localStorage === 'undefined') return;\r\n  const key = slotSignatureKey(slot);\r\n  if (!key) return;\r\n  try {\r\n    if (signature == null) {\r\n      localStorage.removeItem(key);\r\n    } else {\r\n      localStorage.setItem(key, String(signature));\r\n    }\r\n  } catch {}\r\n}\r\n\r\nexport function hasModifiedSave(slot = getActiveSlot()) {\r\n  if (typeof localStorage === 'undefined') return false;\r\n  const key = slotModifiedKey(slot);\r\n  if (!key) return false;\r\n  try { return localStorage.getItem(key) === '1'; }\r\n  catch { return false; }\r\n}\r\n\r\nexport function markSaveSlotModified(slot = getActiveSlot()) {\r\n  if (typeof localStorage === 'undefined') return;\r\n  const normalized = normalizeSlotValue(slot);\r\n  if (normalized == null) return;\r\n  if (hasModifiedSave(normalized)) return;\r\n  const key = slotModifiedKey(normalized);\r\n  if (!key) return;\r\n  try {\r\n    localStorage.setItem(key, '1');\r\n  } catch { return; }\r\n  try {\r\n    window.dispatchEvent(new CustomEvent('saveSlot:modified', { detail: { slot: normalized } }));\r\n  } catch {}\r\n}\r\n\r\n\r\nfor (const key of Object.values(CURRENCIES)) {\r\n  KEYS.CURRENCY[key]   = `${PREFIX}${key}`;\r\n  KEYS.MULTIPLIER[key] = `${PREFIX}mult:${key}`; // one key only\r\n}\r\n\r\ninitCurrencyStorageWatchers();\r\n\r\n// -------------------- SAVE-SLOT HELPERS --------------------\r\nexport function getHasOpenedSaveSlot() {\r\n  return localStorage.getItem(KEYS.HAS_OPENED_SAVE_SLOT) === 'true';\r\n}\r\nexport function setHasOpenedSaveSlot(value) {\r\n  localStorage.setItem(KEYS.HAS_OPENED_SAVE_SLOT, value ? 'true' : 'false');\r\n}\r\n\r\n// -------------------- DEFAULTS --------------------\r\nexport function ensureStorageDefaults() {\r\n  if (localStorage.getItem(KEYS.HAS_OPENED_SAVE_SLOT) === null) {\r\n    setHasOpenedSaveSlot(false);\r\n  }\r\n}\r\n\r\nexport function ensureCurrencyDefaults() {\r\n  const slot = getActiveSlot();\r\n  if (slot == null) return; // only seed AFTER a slot is chosen\r\n  for (const key of Object.values(CURRENCIES)) {\r\n    const k = `${KEYS.CURRENCY[key]}:${slot}`;\r\n    if (!localStorage.getItem(k)) localStorage.setItem(k, '0');\r\n  }\r\n}\r\n\r\nexport function ensureMultiplierDefaults() {\r\n  const slot = getActiveSlot();\r\n  if (slot == null) return; // only seed AFTER a slot is chosen\r\n  for (const key of Object.values(CURRENCIES)) {\r\n    const km = `${KEYS.MULTIPLIER[key]}:${slot}`;\r\n    if (!localStorage.getItem(km)) {\r\n      const theor = scaledFromIntBN(BigNum.fromInt(1));\r\n      setMultiplierScaled(key, theor);\r\n    } else {\r\n      getMultiplierScaled(key);\r\n    }\r\n  }\r\n}\r\n\r\n// -------------------- AMOUNTS (BN) --------------------\r\nexport function getCurrency(key) {\r\n  const k = keyFor(KEYS.CURRENCY[key]);\r\n  if (!k) return BigNum.fromInt(0);\r\n  const raw = localStorage.getItem(k);\r\n  if (!raw) return BigNum.fromInt(0);\r\n  try { return BigNum.fromAny(raw); } catch { return BigNum.fromInt(0); }\r\n}\r\n\r\nexport function setCurrency(key, value, { delta = null, previous = null } = {}) {\r\n  const slot = getActiveSlot();\r\n  const k = keyFor(KEYS.CURRENCY[key], slot);\r\n  const prev = previous ?? getCurrency(key);\r\n  const zero = BigNum.fromInt(0);\r\n  if (!k) return prev;\r\n  if (isCurrencyLocked(key, slot)) {\r\n    let deltaBn = null;\r\n    if (delta) {\r\n      try {\r\n        deltaBn = delta instanceof BigNum ? delta.clone?.() ?? delta : BigNum.fromAny(delta);\r\n      } catch { deltaBn = null; }\r\n    }\r\n    const detail = { key, value: prev, slot, delta: deltaBn ?? undefined };\r\n    notifyCurrencySubscribers(detail);\r\n    try { window.dispatchEvent(new CustomEvent('currency:change', { detail })); } catch {}\r\n    return prev;\r\n  } // Respect debug-panel storage locks\r\n\r\n  let bn;\r\n  try { bn = BigNum.fromAny(value); }\r\n  catch { bn = BigNum.fromInt(0); }\r\n  if (bn.isNegative?.()) bn = BigNum.fromInt(0);\r\n\r\n  const expectedRaw = bn.toStorage();\r\n\r\n  try { localStorage.setItem(k, expectedRaw); }\r\n  catch {}\r\n\r\n  let persistedRaw = null;\r\n  try { persistedRaw = localStorage.getItem(k); }\r\n  catch {}\r\n\r\n  const effectiveRaw = persistedRaw ?? expectedRaw;\r\n  let effective = bn;\r\n  try {\r\n    if (persistedRaw != null) {\r\n      effective = BigNum.fromAny(persistedRaw);\r\n      if (effective.isNegative?.()) effective = BigNum.fromInt(0);\r\n    }\r\n  } catch {}\r\n  \r\n  primeStorageWatcherSnapshot(k, effectiveRaw);\r\n\r\n  const changed = !bigNumEquals(prev, effective);\r\n\r\n  const parseDelta = (source) => {\r\n    if (source == null) return null;\r\n    try {\r\n      const bnDelta = source instanceof BigNum ? source.clone?.() ?? source : BigNum.fromAny(source);\r\n      if (typeof bnDelta.cmp === 'function') {\r\n        return bnDelta.cmp(zero) > 0 ? bnDelta : null;\r\n      }\r\n      if (!bnDelta.isZero?.()) return bnDelta;\r\n    } catch {}\r\n    return null;\r\n  };\r\n\r\n  const providedDelta = parseDelta(delta);\r\n  let deltaBn = null;\r\n  if (changed) {\r\n    try { deltaBn = effective.sub?.(prev); }\r\n    catch {}\r\n  }\r\n  if (!deltaBn || deltaBn.isZero?.() || (typeof deltaBn.cmp === 'function' && deltaBn.cmp(zero) <= 0)) {\r\n    deltaBn = providedDelta;\r\n  }\r\n\r\n  if (changed || deltaBn) {\r\n    const detail = { key, value: effective, slot, delta: deltaBn ?? undefined };\r\n    notifyCurrencySubscribers(detail);\r\n    try { window.dispatchEvent(new CustomEvent('currency:change', { detail })); } catch {}\r\n  }\r\n\r\n  return effective;\r\n}\r\n\r\nfunction scaledFromIntBN(intBN) {\r\n  return intBN.mulScaledIntFloor(1n, -MULT_SCALE);\r\n}\r\n\r\n// theoretical (\u00D710^MULT_SCALE) \u2192 integer BN multiplier (floor), min 1\r\nfunction intFromScaled(theorBN) {\r\n  const bn = BigNum.fromAny(theorBN);\r\n  if (bn.isInfinite()) return bn.clone();\r\n  const scaled = bn.mulScaledIntFloor(1n, MULT_SCALE);\r\n  return scaled;\r\n}\r\n\r\nfunction getMultiplierScaled(key) {\r\n  const k = keyFor(KEYS.MULTIPLIER[key]);\r\n  if (!k) return scaledFromIntBN(BigNum.fromInt(1));\r\n  const raw = localStorage.getItem(k);\r\n  if (!raw || !raw.startsWith(MULT_SCALE_TAG)) {\r\n    const theor = scaledFromIntBN(BigNum.fromInt(1));\r\n    setMultiplierScaled(key, theor);\r\n    return theor;\r\n  }\r\n  const payload = raw.slice(MULT_SCALE_TAG.length);\r\n  try { return BigNum.fromAny(payload); } catch {\r\n    const theor = scaledFromIntBN(BigNum.fromInt(1));\r\n    setMultiplierScaled(key, theor);\r\n    return theor;\r\n  }\r\n}\r\n\r\nfunction setMultiplierScaled(key, theoreticalBN, slot = getActiveSlot()) {\r\n  const k = keyFor(KEYS.MULTIPLIER[key], slot);\r\n  if (!k) return;\r\n  if (isCurrencyLocked(key, slot)) return; // Respect debug-panel storage locks\r\n  let prev = scaledFromIntBN(BigNum.fromInt(1));\r\n  const existingRaw = localStorage.getItem(k);\r\n  if (existingRaw?.startsWith?.(MULT_SCALE_TAG)) {\r\n    try {\r\n      prev = BigNum.fromAny(existingRaw.slice(MULT_SCALE_TAG.length));\r\n    } catch {}\r\n  }\r\n  const bn = BigNum.fromAny(theoreticalBN);\r\n  const raw = MULT_SCALE_TAG + bn.toStorage();\r\n  try { localStorage.setItem(k, raw); }\r\n  catch {}\r\n\r\n  let persistedRaw = null;\r\n  try { persistedRaw = localStorage.getItem(k); }\r\n  catch {}\r\n\r\n  const effectiveRaw = persistedRaw ?? raw;\r\n  let effective = bn;\r\n  try {\r\n    const payload = effectiveRaw?.startsWith?.(MULT_SCALE_TAG)\r\n      ? effectiveRaw.slice(MULT_SCALE_TAG.length)\r\n      : null;\r\n    if (payload != null) effective = BigNum.fromAny(payload);\r\n  } catch {}\r\n  // Keep any live storage watchers (and save-integrity snapshots) aligned with the\r\n  // freshly-written multiplier so follow-up writes don't look like manual tampering.\r\n  try { primeStorageWatcherSnapshot(k, effectiveRaw); } catch {}\r\n  if (!bigNumEquals(prev, effective)) {\r\n    try {\r\n      window.dispatchEvent(new CustomEvent('currency:multiplier', {\r\n        detail: { key, mult: intFromScaled(effective), slot }\r\n      }));\r\n    } catch {}\r\n  }\r\n}\r\n\r\nexport function getCurrencyMultiplierBN(key) {\r\n  return intFromScaled(getMultiplierScaled(key));\r\n}\r\n\r\nexport function isCurrencyLocked(key, slot = getActiveSlot()) {\r\n  const k = keyFor(KEYS.CURRENCY[key], slot);\r\n  return isDebugLocked(k);\r\n}\r\n\r\n// public set integer BN multiplier (stored as scaled theoretical)\r\nexport function setCurrencyMultiplierBN(key, intBNValue) {\r\n  const v = BigNum.fromAny(intBNValue);\r\n  const theor = scaledFromIntBN(v);\r\n  setMultiplierScaled(key, theor, getActiveSlot());\r\n  return v;\r\n}\r\n\r\nexport function peekCurrency(slot, key) {\r\n  const raw = localStorage.getItem(`${KEYS.CURRENCY[key]}:${slot}`);\r\n  if (!raw) return BigNum.fromInt(0);\r\n  try { return BigNum.fromAny(raw); } catch { return BigNum.fromInt(0); }\r\n}\r\n\r\n// -------------------- UTILITIES --------------------\r\nexport function clearAllStorage() {\r\n  Object.values(KEYS).forEach((v) => {\r\n    if (typeof v === 'string') {\r\n      localStorage.removeItem(v);\r\n    } else if (typeof v === 'object') {\r\n      Object.values(v).forEach((sub) => localStorage.removeItem(sub));\r\n    }\r\n  });\r\n}\r\n\r\n// -------------------- BANK FACADE --------------------\r\nfunction makeCurrencyHandle(key) {\r\n  // callable preview: bank.coins(\"1e3\")\r\n  const fn = (x) => {\r\n    try {\r\n      const bn = BigNum.fromAny(x);\r\n      return typeof formatNumber === 'function' ? formatNumber(bn) : bn.toString();\r\n    } catch {\r\n      return 'NaN';\r\n    }\r\n  };\r\n\r\n  Object.defineProperty(fn, 'value', {\r\n    get() { return getCurrency(key); }\r\n  });\r\n\r\n  fn.toString = function toString() {\r\n    return this.value.toString();\r\n  };\r\n\r\n  // amount mutations\r\n  fn.add = function add(x) {\r\n    const amt  = BigNum.fromAny(x);\r\n    const next = this.value.add(amt);\r\n    const effective = setCurrency(key, next, { delta: amt, previous: this.value });\r\n    return effective;\r\n  };\r\n\r\nfn.sub = function sub(x) {\r\n  const amt = BigNum.fromAny(x);\r\n  const cur = this.value;\r\n\r\n  let next = cur.sub(amt);\r\n  if (next.isNegative?.()) next = BigNum.fromInt(0);\r\n\r\n  setCurrency(key, next);\r\n  return next;\r\n};\r\n\r\n  fn.set = function set(x) {\r\n    const val = BigNum.fromAny(x);\r\n    let delta = null;\r\n    let current;\r\n    try {\r\n      current = this.value;\r\n      if (current && typeof current.sub === 'function') {\r\n        delta = val.sub(current);\r\n      }\r\n    } catch {}\r\n    const effective = setCurrency(key, val, { delta, previous: current });\r\n    return effective;\r\n  };\r\n\r\n  fn.fmt = function fmt(x) {\r\n    const bn = BigNum.fromAny(x);\r\n    return typeof formatNumber === 'function' ? formatNumber(bn) : bn.toString();\r\n  };\r\n\r\n  // multiplier API (single-key theoretical + floor)\r\n  fn.mult = {\r\n    get() {\r\n      return getCurrencyMultiplierBN(key);\r\n    },\r\n    set(x) {\r\n      return setCurrencyMultiplierBN(key, x);\r\n    },\r\n    multiplyByInt(x) {\r\n      const factor = BigNum.fromAny(x).floorToInteger();\r\n      let theor = getMultiplierScaled(key).mulBigNumInteger(factor);\r\n      if (theor.isZero()) theor = scaledFromIntBN(BigNum.fromInt(1));\r\n      setMultiplierScaled(key, theor);\r\n      return intFromScaled(theor);\r\n    },\r\n    multiplyByDecimal(x) {\r\n      // parse \"1.2\" \u2192 { numer, scale }\r\n      let parsed;\r\n      try { parsed = BigNum._parseDecimalMultiplier(String(x), MULT_SCALE); }\r\n      catch { parsed = { numer: 1n, scale: 0 }; }\r\n      let theor = getMultiplierScaled(key).mulScaledIntFloor(parsed.numer, parsed.scale);\r\n      if (theor.isZero()) theor = scaledFromIntBN(BigNum.fromInt(1));\r\n      setMultiplierScaled(key, theor);\r\n      const next = intFromScaled(theor);\r\n      return next.isZero() ? BigNum.fromInt(1) : next;\r\n    },\r\n    multiplyByPercent(pct) {\r\n      const factor = (Number(pct) / 100) + 1;\r\n      return this.multiplyByDecimal(String(factor));\r\n    },\r\n    applyTo(amount) {\r\n      const mult = this.get();\r\n      if (mult.isInfinite()) {\r\n        return BigNum.fromAny('Infinity');\r\n      }\r\n      const amt = BigNum.fromAny(amount, mult.p);\r\n      if (amt.isZero() || mult.isZero()) return amt.clone();\r\n      return amt.mulBigNumInteger(mult);\r\n    }\r\n  };\r\n\r\n  fn.addWithMultiplier = function addWithMultiplier(baseAmount) {\r\n    const inc = fn.mult.applyTo(baseAmount);\r\n    return fn.add(inc);\r\n  };\r\n\r\n  return fn;\r\n}\r\n\r\nexport const bank = new Proxy({}, {\r\n  get(_, prop) {\r\n    if (Object.values(CURRENCIES).includes(prop)) return makeCurrencyHandle(prop);\r\n    if (typeof prop === 'string' && CURRENCIES[prop.toUpperCase?.()]) {\r\n      return makeCurrencyHandle(CURRENCIES[prop.toUpperCase()]);\r\n    }\r\n    return undefined;\r\n  }\r\n});\r\n\r\nif (typeof window !== 'undefined') {\r\n  window.bank = bank;\r\n  window.coins = bank.coins;\r\n  window.books = bank.books;\r\n}\r\n", "// js/util/slotsManager.js\r\nimport { KEYS, getActiveSlot } from './storage.js';\r\nimport { refreshSlotsView } from './slots.js';\r\n\r\nlet deleteMode = false;\r\nlet initialized = false;\r\n\r\nexport function isDeleteMode() { return deleteMode; }\r\n\r\nfunction setDeleteMode(on) {\r\n  deleteMode = !!on;\r\n  document.body.classList.toggle('slots-delete-mode', deleteMode);\r\n\r\n  const btn = document.getElementById('manage-saves');\r\n  if (btn) btn.textContent = deleteMode ? 'Done' : 'Manage save slots';\r\n\r\n  document.querySelectorAll('.slot-card').forEach((card) => {\r\n    card.classList.toggle('is-deleting', deleteMode);\r\n    card.setAttribute('aria-pressed', deleteMode ? 'true' : 'false');\r\n  });\r\n}\r\n\r\nfunction removeAllKeysForSlot(slot) {\r\n  const re = new RegExp(`^ccc:.*:${slot}$`);\r\n  const toRemove = [];\r\n  for (let i = 0; i < localStorage.length; i++) {\r\n    const k = localStorage.key(i);\r\n    if (re.test(k)) toRemove.push(k);\r\n  }\r\n  toRemove.forEach((k) => localStorage.removeItem(k));\r\n}\r\n\r\nexport function initSlotsManager() {\r\n  if (initialized) return;\r\n  initialized = true;\r\n\r\n  const manageBtn = document.getElementById('manage-saves');\r\n  const grid = document.querySelector('.slots-grid');\r\n  if (!manageBtn || !grid) return;\r\n\r\n  manageBtn.addEventListener('click', (e) => {\r\n    e.preventDefault();\r\n    setDeleteMode(!deleteMode);\r\n  });\r\n\r\n  window.addEventListener('keydown', (e) => {\r\n    if (deleteMode && e.key === 'Escape') setDeleteMode(false);\r\n  });\r\n\r\n  // Capture early to block the regular slot click handler\r\n  const onPointerDownCapture = (e) => {\r\n    if (!deleteMode) return;\r\n    const card = e.target.closest('.slot-card');\r\n    if (!card) return;\r\n    e.preventDefault();\r\n    e.stopPropagation();\r\n  };\r\n\r\n  const onClickCapture = (e) => {\r\n    if (!deleteMode) return;\r\n    const card = e.target.closest('.slot-card');\r\n    if (!card) return;\r\n\r\n    e.preventDefault();\r\n    e.stopPropagation();\r\n\r\n    // Figure out slot number\r\n    let slot = parseInt(card.dataset.slot, 10);\r\n    if (!Number.isFinite(slot) || slot <= 0) {\r\n      const cards = Array.from(document.querySelectorAll('.slot-card'));\r\n      slot = cards.indexOf(card) + 1;\r\n    }\r\n\r\n    // Only delete if slot has data\r\n    const hasData = localStorage.getItem(`ccc:coins:${slot}`) !== null;\r\n    if (!hasData) {\r\n      alert(`Slot ${slot} has no save data.`);\r\n      return;\r\n    }\r\n\r\n    if (!confirm(`Delete save data in Slot ${slot}? This cannot be undone.`)) return;\r\n\r\n    removeAllKeysForSlot(slot);\r\n\r\n    if (getActiveSlot() === slot) {\r\n      try { localStorage.removeItem(KEYS.SAVE_SLOT); } catch {}\r\n    }\r\n\r\n    refreshSlotsView();\r\n    setDeleteMode(false);\r\n  };\r\n\r\n  grid.addEventListener('pointerdown', onPointerDownCapture, true); // capture\r\n  grid.addEventListener('click', onClickCapture, true);             // capture\r\n\r\n  setDeleteMode(false);\r\n}\r\n\r\n// Auto-init in case nothing imports us explicitly\r\ndocument.addEventListener('DOMContentLoaded', () => {\r\n  try { initSlotsManager(); } catch {}\r\n});\r\n", "import { BigNum } from './bigNum.js';\r\nimport { formatNumber } from './numFormat.js';\r\nimport { isDeleteMode } from './slotsManager.js';\r\nimport {\r\n  setHasOpenedSaveSlot,\r\n  ensureCurrencyDefaults,\r\n  ensureMultiplierDefaults,\r\n  setActiveSlot,\r\n  peekCurrency,\r\n} from './storage.js';\r\n\r\n// A slot is considered \"used\" once it has a coins key at all (even if 0)\r\nfunction hasSlotData(slot) {\r\n  return localStorage.getItem(`ccc:coins:${slot}`) !== null;\r\n}\r\n\r\nfunction coinsTextFor(slot) {\r\n  if (!hasSlotData(slot)) return 'No Save Data';\r\n  try {\r\n    const bn = peekCurrency(slot, 'coins'); // BigNum\r\n    return formatNumber(bn);\r\n  } catch {\r\n    return '0';\r\n  }\r\n}\r\n\r\nfunction renderSlotCards() {\r\n  const cards = document.querySelectorAll('.slot-card');\r\n  cards.forEach((btn, idx) => {\r\n    const slot = idx + 1;\r\n    const titleEl = btn.querySelector('.slot-title');\r\n\r\n    if (titleEl) {\r\n      const text = coinsTextFor(slot);\r\n      titleEl.innerHTML = `<img src=\"img/currencies/coin/coin.webp\" class=\"coin-slot-icon-img\" alt=\"\">${text}`;\r\n    }\r\n\r\n    btn.dataset.slot = String(slot);\r\n  });\r\n}\r\n\r\nexport function initSlots(onSelect) {\r\n  const cards = document.querySelectorAll('.slot-card');\r\n\r\n  // Initial paint\r\n  renderSlotCards();\r\n\r\n  cards.forEach((btn, idx) => {\r\n    const slotNum = idx + 1;\r\n\r\n    const activate = (ev) => {\r\n      // Switch to this slot and seed its defaults the first time it\u2019s opened\r\n      setActiveSlot(slotNum);\r\n      ensureCurrencyDefaults();\r\n      ensureMultiplierDefaults();\r\n\r\n      setHasOpenedSaveSlot(true);\r\n      if (typeof onSelect === 'function') onSelect(slotNum, ev);\r\n\r\n      // Repaint card titles after seeding\r\n      renderSlotCards();\r\n    };\r\n\r\n    btn.addEventListener('click', (ev) => {\r\n      if (isDeleteMode()) return;\r\n      ev.preventDefault();\r\n      activate(ev);\r\n    });\r\n  });\r\n}\r\n\r\nexport function refreshSlotsView() { renderSlotCards(); }\r\n", "// js/util/audioCache.js\r\n\r\nconst cache = new Map();\r\n\r\nconst normalize = (src) => {\r\n  try {\r\n    return new URL(src, document.baseURI).href;\r\n  } catch (_) {\r\n    return src;\r\n  }\r\n};\r\n\r\nexport function registerPreloadedAudio(src, element) {\r\n  const key = normalize(src);\r\n  if (!key || !element) return;\r\n  element.pause?.();\r\n  try { element.currentTime = 0; } catch (_) {}\r\n  cache.set(key, element);\r\n}\r\n\r\nexport function takePreloadedAudio(src) {\r\n  const key = normalize(src);\r\n  if (!cache.has(key)) return null;\r\n  const el = cache.get(key);\r\n  cache.delete(key);\r\n  return el;\r\n}", "// js/ui/hudLayout.js\r\n\r\nexport function syncXpMpHudLayout() {\r\n  if (typeof document === 'undefined') return;\r\n  const hud = document.querySelector('.hud-top');\r\n  if (!hud) return;\r\n\r\n  const xpEl = document.querySelector('[data-xp-hud]');\r\n  const mpEl = document.querySelector('[data-mp-hud]');\r\n  const xpVisible = !!(xpEl && !xpEl.hasAttribute('hidden'));\r\n  const mpVisible = !!(mpEl && !mpEl.hasAttribute('hidden'));\r\n\r\n  hud.classList.toggle('hud-top--xp-only', xpVisible && !mpVisible);\r\n  hud.classList.toggle('hud-top--xp-mp', xpVisible && mpVisible);\r\n\r\n  if (!xpVisible && !mpVisible) {\r\n    hud.classList.remove('hud-top--xp-only', 'hud-top--xp-mp');\r\n  }\r\n}", "// js/game/xpSystem.js\r\n\r\nimport { BigNum } from '../util/bigNum.js';\r\nimport { bank, getActiveSlot, watchStorageKey, primeStorageWatcherSnapshot } from '../util/storage.js';\r\nimport { applyStatMultiplierOverride } from '../util/debugPanel.js';\r\nimport { formatNumber } from '../util/numFormat.js';\r\nimport { syncXpMpHudLayout } from '../ui/hudLayout.js';\r\n\r\nconst KEY_PREFIX = 'ccc:xp';\r\nconst KEY_UNLOCK = (slot) => `${KEY_PREFIX}:unlocked:${slot}`;\r\nconst KEY_XP_LEVEL = (slot) => `${KEY_PREFIX}:level:${slot}`;\r\nconst KEY_PROGRESS = (slot) => `${KEY_PREFIX}:progress:${slot}`;\r\n\r\nexport function getXpLevelStorageKey(slot = getActiveSlot()) {\r\n  const resolvedSlot = slot ?? getActiveSlot();\r\n  return resolvedSlot == null ? null : KEY_XP_LEVEL(resolvedSlot);\r\n}\r\n\r\nlet lastSlot = null;\r\nlet stateLoaded = false;\r\nlet requirementBn = BigNum.fromInt(10);\r\nconst xpRequirementCache = new Map();\r\nxpRequirementCache.set('0', requirementBn);\r\nlet highestCachedExactLevel = 0n;\r\nconst infinityRequirementBn = BigNum.fromAny('Infinity');\r\n\r\nlet lastSyncedCoinLevel = null;\r\nlet lastSyncedCoinLevelWasInfinite = false;\r\nlet lastSyncedCoinUsedApproximation = false;\r\nlet lastSyncedCoinApproxKey = null;\r\nlet externalCoinMultiplierProvider = null;\r\nlet externalXpGainMultiplierProvider = null;\r\nconst coinMultiplierProviders = new Set();\r\nconst xpGainMultiplierProviders = new Set();\r\nlet externalBookRewardProvider = null;\r\n\r\nconst EXACT_REQUIREMENT_CACHE_LEVEL = 5000n;\r\nconst LOG_STEP = Math.log10(11 / 10);\r\nconst LOG_DECADE_BONUS = Math.log10(5 / 2);\r\nconst EXACT_COIN_LEVEL_LIMIT = 200n;\r\nconst LOG_STEP_DECIMAL = '0.04139268515822507';\r\nconst LOG_DECADE_BONUS_DECIMAL = '0.3979400086720376';\r\nconst TEN_DIVISOR_DECIMAL = '0.1';\r\nconst maxLog10Bn = BigNum.fromScientific(String(BigNum.MAX_E));\r\n\r\nfunction bigIntToFloatApprox(value) {\r\n  if (value === 0n) return 0;\r\n  const str = value.toString();\r\n  const len = str.length;\r\n  const headDigits = Math.min(len, 15);\r\n  const head = Number(str.slice(0, headDigits));\r\n  const exponent = len - headDigits;\r\n  if (!Number.isFinite(head)) return Number.POSITIVE_INFINITY;\r\n  const scaled = head * Math.pow(10, exponent);\r\n  return Number.isFinite(scaled) ? scaled : Number.POSITIVE_INFINITY;\r\n}\r\n\r\nfunction bigNumIsInfinite(bn) {\r\n  return !!(bn && typeof bn === 'object' && (bn.isInfinite?.() || (typeof bn.isInfinite === 'function' && bn.isInfinite())));\r\n}\r\n\r\nfunction bigNumIsZero(bn) {\r\n  return !bn || typeof bn !== 'object' || (bn.isZero?.() || (typeof bn.isZero === 'function' && bn.isZero()));\r\n}\r\n\r\nfunction bigNumToFiniteNumber(bn) {\r\n  if (!bn || typeof bn !== 'object') return 0;\r\n  if (bigNumIsInfinite(bn)) return Number.POSITIVE_INFINITY;\r\n  const sci = typeof bn.toScientific === 'function' ? bn.toScientific(18) : String(bn);\r\n  if (!sci || sci === 'Infinity') return Number.POSITIVE_INFINITY;\r\n  const match = sci.match(/^([0-9]+(?:\\.[0-9]+)?)e([+-]?\\d+)$/i);\r\n  if (match) {\r\n    const mant = parseFloat(match[1]);\r\n    const exp = parseInt(match[2], 10);\r\n    if (!Number.isFinite(mant) || !Number.isFinite(exp)) return Number.POSITIVE_INFINITY;\r\n    if (exp >= 309) return Number.POSITIVE_INFINITY;\r\n    return mant * Math.pow(10, exp);\r\n  }\r\n  const num = Number(sci);\r\n  return Number.isFinite(num) ? num : Number.POSITIVE_INFINITY;\r\n}\r\n\r\nfunction logBigNumToNumber(bn) {\r\n  if (!bn || typeof bn !== 'object') return 0;\r\n  if (bigNumIsInfinite(bn)) return Number.POSITIVE_INFINITY;\r\n  if (typeof bn.cmp === 'function' && bn.cmp(maxLog10Bn) >= 0) {\r\n    return Number.POSITIVE_INFINITY;\r\n  }\r\n  return bigNumToFiniteNumber(bn);\r\n}\r\n\r\nfunction computeBonusCountBn(levelBn) {\r\n  if (!levelBn || typeof levelBn !== 'object') return BigNum.fromInt(0);\r\n  const divided = levelBn.mulDecimal(TEN_DIVISOR_DECIMAL, 1);\r\n  const floored = divided.floorToInteger();\r\n  if (typeof divided.cmp === 'function' && divided.cmp(floored) === 0) {\r\n    if (floored.isZero?.() || (typeof floored.isZero === 'function' && floored.isZero())) {\r\n      return floored;\r\n    }\r\n    return floored.sub?.(bnOne()) ?? BigNum.fromInt(0);\r\n  }\r\n  return floored;\r\n}\r\n\r\nfunction computeLevelLogTerm(levelBn) {\r\n  if (!levelBn || typeof levelBn !== 'object') return BigNum.fromInt(0);\r\n  return levelBn.mulDecimal(LOG_STEP_DECIMAL, 18);\r\n}\r\n\r\nfunction computeBonusLogTerm(levelBn) {\r\n  const bonusCount = computeBonusCountBn(levelBn);\r\n  if (bigNumIsZero(bonusCount)) return null;\r\n  return bonusCount.mulDecimal(LOG_DECADE_BONUS_DECIMAL, 18);\r\n}\r\n\r\nfunction bigNumPowerOf10(logBn) {\r\n  if (bigNumIsInfinite(logBn) || (typeof logBn.cmp === 'function' && logBn.cmp(maxLog10Bn) >= 0)) {\r\n      return infinityRequirementBn.clone?.() ?? infinityRequirementBn;\r\n  }\r\n\r\n  const integerPart = logBn.floorToInteger();\r\n  const fractionalPart = logBn.sub(integerPart);\r\n  const fractionalNumber = bigNumToFiniteNumber(fractionalPart);\r\n\r\n  if (!Number.isFinite(fractionalNumber)) {\r\n      return infinityRequirementBn.clone?.() ?? infinityRequirementBn;\r\n  }\r\n\r\n  let mantissa = Math.pow(10, fractionalNumber);\r\n\r\n  const precision = 18;\r\n  const scaleFactor = 10n ** BigInt(precision);\r\n\r\n  let exponentAdjustment = 0n;\r\n  if (mantissa >= 10) {\r\n      mantissa /= 10;\r\n      exponentAdjustment = 1n;\r\n  }\r\n\r\n  const sig = BigInt(Math.round(mantissa * Number(scaleFactor)));\r\n\r\n  const integerPartString = integerPart.toPlainIntegerString();\r\n  if (integerPartString === 'Infinity') {\r\n      return infinityRequirementBn.clone?.() ?? infinityRequirementBn;\r\n  }\r\n  const integerPartBigInt = BigInt(integerPartString);\r\n\r\n  const totalExponent = integerPartBigInt + exponentAdjustment - BigInt(precision);\r\n\r\n  const E_LIMIT = 250;\r\n  const eBigInt = totalExponent % BigInt(E_LIMIT);\r\n  const e = Number(eBigInt);\r\n  const offset = totalExponent - eBigInt;\r\n\r\n  return new BigNum(sig, { base: e, offset: offset });\r\n}\r\n\r\nfunction approximateCoinMultiplierFromBigNum(levelBn) {\r\n  if (!levelBn || typeof levelBn !== 'object') {\r\n    return infinityRequirementBn.clone?.() ?? infinityRequirementBn;\r\n  }\r\n  const levelLog = computeLevelLogTerm(levelBn);\r\n  let totalLog = levelLog;\r\n  const approx = bigNumPowerOf10(totalLog);\r\n  const approxIsInf = approx.isInfinite?.() || (typeof approx.isInfinite === 'function' && approx.isInfinite());\r\n  if (approxIsInf) {\r\n    return infinityRequirementBn.clone?.() ?? infinityRequirementBn;\r\n  }\r\n  const levelTerm = levelBn.clone?.() ?? (() => {\r\n    try { return BigNum.fromAny(levelBn ?? 0); }\r\n    catch { return BigNum.fromInt(0); }\r\n  })();\r\n  let combined = approx.clone?.() ?? approx;\r\n  if (typeof combined.add === 'function') {\r\n    combined = combined.add(levelTerm);\r\n  } else if (typeof levelTerm.add === 'function') {\r\n    combined = levelTerm.add(combined);\r\n  }\r\n  return combined;\r\n}\r\n\r\nconst xpState = {\r\n  unlocked: false,\r\n  xpLevel: BigNum.fromInt(0),\r\n  progress: BigNum.fromInt(0),\r\n};\r\n\r\nfunction enforceXpInfinityInvariant() {\r\n  const levelIsInf = bigNumIsInfinite(xpState.xpLevel);\r\n  const progIsInf = bigNumIsInfinite(xpState.progress);\r\n  if (!levelIsInf && !progIsInf) return false;\r\n\r\n  const inf = infinityRequirementBn.clone?.() ?? infinityRequirementBn;\r\n  xpState.xpLevel = inf.clone?.() ?? inf;\r\n  xpState.progress = inf.clone?.() ?? inf;\r\n  requirementBn = inf.clone?.() ?? inf;\r\n\r\n  if (bank?.books) {\r\n    try {\r\n      if (typeof bank.books.set === 'function') {\r\n        bank.books.set(inf.clone?.() ?? inf);\r\n      } else if (typeof bank.books.add === 'function') {\r\n        bank.books.add(inf.clone?.() ?? inf);\r\n      }\r\n    } catch {\r\n    }\r\n  }\r\n  \r\n  return true;\r\n}\r\n\r\n\r\nconst xpChangeSubscribers = new Set();\r\n\r\nfunction notifyXpSubscribers(detail = {}) {\r\n  if (xpChangeSubscribers.size === 0) return;\r\n  xpChangeSubscribers.forEach((entry) => {\r\n    if (!entry || typeof entry.handler !== 'function') return;\r\n    if (entry.slot != null && detail.slot != null && entry.slot !== detail.slot) return;\r\n    try { entry.handler(detail); }\r\n    catch {}\r\n  });\r\n}\r\n\r\nexport function onXpChange(handler, { slot = null } = {}) {\r\n  if (typeof handler !== 'function') {\r\n    return () => {};\r\n  }\r\n  const entry = { handler, slot: slot ?? null };\r\n  xpChangeSubscribers.add(entry);\r\n  return () => {\r\n    xpChangeSubscribers.delete(entry);\r\n  };\r\n}\r\n\r\nconst hudRefs = {\r\n  container: null,\r\n  bar: null,\r\n  fill: null,\r\n  xpLevelValue: null,\r\n  progress: null,\r\n};\r\n\r\nfunction bnZero() {\r\n  return BigNum.fromInt(0);\r\n}\r\n\r\nfunction bnOne() {\r\n  return BigNum.fromInt(1);\r\n}\r\n\r\nconst xpStorageWatcherCleanups = [];\r\nlet xpStorageWatchersInitialized = false;\r\nlet xpStorageWatcherSlot = null;\r\nlet handlingExternalXpStorage = false;\r\n\r\nfunction cloneBigNumSafe(value) {\r\n  if (!value) return bnZero();\r\n  if (typeof value.clone === 'function') {\r\n    try { return value.clone(); } catch {}\r\n  }\r\n  try { return BigNum.fromAny(value); } catch { return bnZero(); }\r\n}\r\n\r\nfunction bigNumEqualsSafe(a, b) {\r\n  if (a === b) return true;\r\n  if (a == null || b == null) return a == null && b == null;\r\n  if (typeof a?.cmp === 'function') {\r\n    try { return a.cmp(b) === 0; } catch {}\r\n  }\r\n  if (typeof b?.cmp === 'function') {\r\n    try { return b.cmp(a) === 0; } catch {}\r\n  }\r\n  try { return Object.is(String(a), String(b)); }\r\n  catch { return false; }\r\n}\r\n\r\nfunction cleanupXpStorageWatchers() {\r\n  while (xpStorageWatcherCleanups.length > 0) {\r\n    const stop = xpStorageWatcherCleanups.pop();\r\n    try { stop?.(); } catch {}\r\n  }\r\n}\r\n\r\nfunction parseBigNumOrZero(raw) {\r\n  if (raw == null) return bnZero();\r\n  try { return BigNum.fromAny(raw); }\r\n  catch { return bnZero(); }\r\n}\r\n\r\nfunction handleExternalXpStorageChange(reason) {\r\n  if (handlingExternalXpStorage) return;\r\n  handlingExternalXpStorage = true;\r\n  try {\r\n    const slot = xpStorageWatcherSlot ?? getActiveSlot();\r\n    const prev = {\r\n      unlocked: xpState.unlocked,\r\n      xpLevel: cloneBigNumSafe(xpState.xpLevel),\r\n      progress: cloneBigNumSafe(xpState.progress),\r\n      requirement: cloneBigNumSafe(requirementBn),\r\n    };\r\n    ensureStateLoaded(true);\r\n    updateHud();\r\n    syncCoinMultiplierWithXpLevel(true);\r\n    const current = {\r\n      unlocked: xpState.unlocked,\r\n      xpLevel: cloneBigNumSafe(xpState.xpLevel),\r\n      progress: cloneBigNumSafe(xpState.progress),\r\n      requirement: cloneBigNumSafe(requirementBn),\r\n    };\r\n    const unlockedChanged = prev.unlocked !== current.unlocked;\r\n    const levelChanged = !bigNumEqualsSafe(prev.xpLevel, current.xpLevel);\r\n    const progressChanged = !bigNumEqualsSafe(prev.progress, current.progress);\r\n    if (!unlockedChanged && !levelChanged && !progressChanged) {\r\n      return;\r\n    }\r\n    let xpLevelsGained = bnZero();\r\n    if (levelChanged) {\r\n      try { xpLevelsGained = current.xpLevel.sub?.(prev.xpLevel) ?? bnZero(); }\r\n      catch { xpLevelsGained = bnZero(); }\r\n    }\r\n    let xpAdded = null;\r\n    if (!levelChanged && progressChanged) {\r\n      try { xpAdded = current.progress.sub?.(prev.progress) ?? null; }\r\n      catch { xpAdded = null; }\r\n    }\r\n    if (typeof window !== 'undefined' || xpChangeSubscribers.size > 0) {\r\n      const detail = {\r\n        unlocked: current.unlocked,\r\n        xpLevelsGained: xpLevelsGained?.clone?.() ?? xpLevelsGained,\r\n        xpAdded: xpAdded?.clone?.() ?? xpAdded,\r\n        xpLevel: current.xpLevel?.clone?.() ?? current.xpLevel,\r\n        progress: current.progress?.clone?.() ?? current.progress,\r\n        requirement: current.requirement?.clone?.() ?? current.requirement,\r\n        source: 'storage',\r\n        changeType: reason,\r\n        slot,\r\n      };\r\n      notifyXpSubscribers(detail);\r\n      if (typeof window !== 'undefined') {\r\n        try { window.dispatchEvent(new CustomEvent('xp:change', { detail })); } catch {}\r\n      }\r\n    }\r\n  } finally {\r\n    handlingExternalXpStorage = false;\r\n  }\r\n}\r\n\r\nfunction bindXpStorageWatchersForSlot(slot) {\r\n  if (slot === xpStorageWatcherSlot) return;\r\n  cleanupXpStorageWatchers();\r\n  xpStorageWatcherSlot = slot ?? null;\r\n  if (slot == null) return;\r\n  const watch = (key, options) => {\r\n    const stop = watchStorageKey(key, options);\r\n    if (typeof stop === 'function') {\r\n      xpStorageWatcherCleanups.push(stop);\r\n    }\r\n  };\r\n  watch(KEY_UNLOCK(slot), {\r\n    parse: (raw) => raw === '1',\r\n    equals: (a, b) => a === b,\r\n    onChange: () => handleExternalXpStorageChange('unlock'),\r\n  });\r\n  watch(KEY_XP_LEVEL(slot), {\r\n    parse: parseBigNumOrZero,\r\n    equals: bigNumEqualsSafe,\r\n    onChange: () => handleExternalXpStorageChange('xpLevel'),\r\n  });\r\n  watch(KEY_PROGRESS(slot), {\r\n    parse: parseBigNumOrZero,\r\n    equals: bigNumEqualsSafe,\r\n    onChange: () => handleExternalXpStorageChange('progress'),\r\n  });\r\n}\r\n\r\nfunction ensureXpStorageWatchers() {\r\n  if (xpStorageWatchersInitialized) {\r\n    bindXpStorageWatchersForSlot(getActiveSlot());\r\n    return;\r\n  }\r\n  xpStorageWatchersInitialized = true;\r\n  bindXpStorageWatchersForSlot(getActiveSlot());\r\n  if (typeof window !== 'undefined') {\r\n    window.addEventListener('saveSlot:change', () => {\r\n      bindXpStorageWatchersForSlot(getActiveSlot());\r\n      ensureStateLoaded(true);\r\n      updateHud();\r\n      syncCoinMultiplierWithXpLevel(true);\r\n    });\r\n  }\r\n}\r\n\r\nfunction stripHtml(value) {\r\n  if (typeof value !== 'string') return '';\r\n  return value.replace(/<[^>]*>/g, '');\r\n}\r\n\r\nfunction approxLog10(bn) {\r\n  if (!bn || typeof bn !== 'object') return Number.NEGATIVE_INFINITY;\r\n  if (bn.isInfinite?.() || (typeof bn.isInfinite === 'function' && bn.isInfinite())) {\r\n    return Number.POSITIVE_INFINITY;\r\n  }\r\n  if (bn.isZero?.() || (typeof bn.isZero === 'function' && bn.isZero())) {\r\n    return Number.NEGATIVE_INFINITY;\r\n  }\r\n\r\n  // Prefer the BigNum internal representation so we can handle chained-exponent\r\n  // values (e.g. 1e8.11e21) without going through lossy string parsing.\r\n  const sig = bn.sig;\r\n  const expBase = typeof bn.e === 'number' ? bn.e : Number(bn.e ?? 0);\r\n  const expOffset = typeof bn._eOffset === 'bigint'\r\n    ? bigIntToFloatApprox(bn._eOffset)\r\n    : Number(bn._eOffset ?? 0);\r\n\r\n  if (!Number.isFinite(expBase)) {\r\n    return expBase > 0 ? Number.POSITIVE_INFINITY : Number.NEGATIVE_INFINITY;\r\n  }\r\n  if (!Number.isFinite(expOffset)) {\r\n    return expOffset > 0 ? Number.POSITIVE_INFINITY : Number.NEGATIVE_INFINITY;\r\n  }\r\n\r\n  const totalExponent = expBase + expOffset;\r\n  if (!Number.isFinite(totalExponent)) {\r\n    return totalExponent > 0 ? Number.POSITIVE_INFINITY : Number.NEGATIVE_INFINITY;\r\n  }\r\n\r\n  let mantissaLog = 0;\r\n  if (typeof sig === 'bigint') {\r\n    const sigStr = sig.toString();\r\n    const trimmed = sigStr.replace(/^0+/, '');\r\n    if (!trimmed) return Number.NEGATIVE_INFINITY;\r\n    const digits = trimmed.length;\r\n    const headDigits = Math.min(digits, 15);\r\n    const headSlice = trimmed.slice(0, headDigits);\r\n    const head = Number.parseFloat(headSlice);\r\n    if (Number.isFinite(head) && head > 0) {\r\n      mantissaLog = Math.log10(head) + (digits - headDigits);\r\n    } else {\r\n      mantissaLog = digits - 1;\r\n    }\r\n  } else {\r\n    try {\r\n      const sci = typeof bn.toScientific === 'function' ? bn.toScientific(12) : String(bn);\r\n      if (!sci || sci === '0') return Number.NEGATIVE_INFINITY;\r\n      if (sci === 'Infinity') return Number.POSITIVE_INFINITY;\r\n      const match = sci.match(/^([0-9]+(?:\\.[0-9]+)?)e([+-]?\\d+)$/i);\r\n      if (match) {\r\n        const mant = parseFloat(match[1]);\r\n        const exp = parseInt(match[2], 10) || 0;\r\n        if (!(mant > 0) || !Number.isFinite(mant)) return Number.NEGATIVE_INFINITY;\r\n        mantissaLog = Math.log10(mant) + exp;\r\n      } else {\r\n        const num = Number(sci);\r\n        if (!Number.isFinite(num) || num <= 0) return Number.NEGATIVE_INFINITY;\r\n        mantissaLog = Math.log10(num);\r\n      }\r\n    } catch {\r\n      return Number.NEGATIVE_INFINITY;\r\n    }\r\n  }\r\n\r\n  return totalExponent + mantissaLog;\r\n}\r\n\r\nfunction bonusMultipliersCount(levelBigInt) {\r\n  if (levelBigInt <= 1n) return 0n;\r\n  return (levelBigInt - 1n) / 10n;\r\n}\r\n\r\nfunction ensureExactRequirementCacheUpTo(levelBigInt) {\r\n  const target = levelBigInt < EXACT_REQUIREMENT_CACHE_LEVEL ? levelBigInt : EXACT_REQUIREMENT_CACHE_LEVEL;\r\n  if (target <= highestCachedExactLevel) return;\r\n\r\n  let currentLevel = highestCachedExactLevel;\r\n  let currentRequirement = xpRequirementCache.get(currentLevel.toString());\r\n  if (!currentRequirement) {\r\n    currentRequirement = BigNum.fromInt(10);\r\n    xpRequirementCache.set(currentLevel.toString(), currentRequirement);\r\n  }\r\n\r\n  while (currentLevel < target) {\r\n    const nextLevel = currentLevel + 1n;\r\n    let nextRequirement = currentRequirement.mulScaledIntFloor(11n, 1);\r\n    if (nextLevel > 1n && ((nextLevel - 1n) % 10n === 0n)) {\r\n      nextRequirement = nextRequirement.mulScaledIntFloor(25n, 1);\r\n    }\r\n    xpRequirementCache.set(nextLevel.toString(), nextRequirement);\r\n    currentRequirement = nextRequirement;\r\n    currentLevel = nextLevel;\r\n    const isInfinite = currentRequirement.isInfinite?.() || (typeof currentRequirement.isInfinite === 'function' && currentRequirement.isInfinite());\r\n    if (isInfinite) {\r\n      highestCachedExactLevel = currentLevel;\r\n      return;\r\n    }\r\n  }\r\n\r\n  highestCachedExactLevel = currentLevel;\r\n}\r\n\r\nfunction bigNumFromLog10(log10Value) {\r\n  if (!Number.isFinite(log10Value) || log10Value >= BigNum.MAX_E) {\r\n    return infinityRequirementBn.clone?.() ?? infinityRequirementBn;\r\n  }\r\n\r\n  let exponent = Math.floor(log10Value);\r\n  let fractional = log10Value - exponent;\r\n  if (!Number.isFinite(fractional)) {\r\n    fractional = 0;\r\n  }\r\n\r\n  let mantissa = Math.pow(10, fractional);\r\n  if (!Number.isFinite(mantissa) || mantissa <= 0) {\r\n    mantissa = 1;\r\n  }\r\n\r\n  if (mantissa >= 10) {\r\n    mantissa /= 10;\r\n    exponent += 1;\r\n  }\r\n\r\n  let exponentStr;\r\n  try {\r\n    exponentStr = Number.isFinite(exponent)\r\n      ? exponent.toLocaleString('en', { useGrouping: false })\r\n      : String(exponent);\r\n  } catch {\r\n    exponentStr = String(exponent);\r\n  }\r\n\r\n  const sci = `${mantissa.toPrecision(18)}e${exponentStr}`;\r\n  try {\r\n    return BigNum.fromScientific(sci).floorToInteger();\r\n  } catch {\r\n    return infinityRequirementBn.clone?.() ?? infinityRequirementBn;\r\n  }\r\n}\r\n\r\nfunction approximateRequirementFromLevel(levelBn) {\r\n  const baseLevel = highestCachedExactLevel > 0n ? highestCachedExactLevel : 0n;\r\n  const baseRequirement = xpRequirementCache.get(baseLevel.toString());\r\n  if (!baseRequirement || bigNumIsInfinite(baseRequirement)) {\r\n    return infinityRequirementBn.clone?.() ?? infinityRequirementBn;\r\n  }\r\n\r\n  const baseLevelBn = BigNum.fromAny(baseLevel.toString());\r\n  const baseLog = approxLog10(baseRequirement);\r\n  let totalLog = BigNum.fromInt(0);\r\n  if (Number.isFinite(baseLog) && baseLog > 0) {\r\n    try {\r\n      totalLog = BigNum.fromScientific(baseLog.toString());\r\n    } catch {\r\n      totalLog = BigNum.fromInt(0);\r\n    }\r\n  }\r\n\r\n  const deltaLevel = levelBn.sub?.(baseLevelBn) ?? BigNum.fromInt(0);\r\n  if (!bigNumIsZero(deltaLevel)) {\r\n    totalLog = totalLog.add?.(deltaLevel.mulDecimal(LOG_STEP_DECIMAL, 18)) ?? totalLog;\r\n  }\r\n\r\n  const targetBonus = computeBonusCountBn(levelBn);\r\n  const baseBonus = computeBonusCountBn(baseLevelBn);\r\n  const deltaBonus = targetBonus.sub?.(baseBonus) ?? BigNum.fromInt(0);\r\n  if (!bigNumIsZero(deltaBonus)) {\r\n    totalLog = totalLog.add?.(deltaBonus.mulDecimal(LOG_DECADE_BONUS_DECIMAL, 18)) ?? totalLog;\r\n  }\r\n\r\n  const logNumber = logBigNumToNumber(totalLog);\r\n  if (!Number.isFinite(logNumber)) {\r\n    return infinityRequirementBn.clone?.() ?? infinityRequirementBn;\r\n  }\r\n\r\n  return bigNumFromLog10(logNumber);\r\n}\r\n\r\nfunction progressRatio(progressBn, requirement) {\r\n  if (!requirement || typeof requirement !== 'object') return 0;\r\n  if (!progressBn || typeof progressBn !== 'object') return 0;\r\n\r\n  const reqIsInf = bigNumIsInfinite(requirement);\r\n  const progIsInf = bigNumIsInfinite(progressBn);\r\n\r\n  // If both are infinite, treat as a full bar.\r\n  if (reqIsInf) {\r\n    return progIsInf ? 1 : 0;\r\n  }\r\n\r\n  const reqIsZero = bigNumIsZero(requirement);\r\n  if (reqIsZero) return 0;\r\n\r\n  const progIsZero = bigNumIsZero(progressBn);\r\n  if (progIsZero) return 0;\r\n\r\n  const logProg = approxLog10(progressBn);\r\n  const logReq  = approxLog10(requirement);\r\n  if (!Number.isFinite(logProg) || !Number.isFinite(logReq)) {\r\n    return logProg >= logReq ? 1 : 0;\r\n  }\r\n  const diff = logProg - logReq;\r\n  const ratio = Math.pow(10, diff);\r\n  if (!Number.isFinite(ratio)) {\r\n    return diff >= 0 ? 1 : 0;\r\n  }\r\n  if (ratio <= 0) return 0;\r\n  if (ratio >= 1) return 1;\r\n  return ratio;\r\n}\r\n\r\nfunction ensureHudRefs() {\r\n  if (hudRefs.container && hudRefs.container.isConnected) return true;\r\n  hudRefs.container = document.querySelector('.xp-counter[data-xp-hud]');\r\n  if (!hudRefs.container) return false;\r\n  hudRefs.bar = hudRefs.container.querySelector('.xp-bar');\r\n  hudRefs.fill = hudRefs.container.querySelector('.xp-bar__fill');\r\n  hudRefs.xpLevelValue = hudRefs.container.querySelector('.xp-level-value');\r\n  hudRefs.progress = hudRefs.container.querySelector('[data-xp-progress]');\r\n  return true;\r\n}\r\n\r\nfunction xpRequirementForXpLevel(xpLevelInput) {\r\n  let xpLvlBn;\r\n  try {\r\n    xpLvlBn = xpLevelInput instanceof BigNum\r\n      ? (xpLevelInput.clone?.() ?? xpLevelInput)\r\n      : BigNum.fromAny(xpLevelInput ?? 0);\r\n  } catch {\r\n    xpLvlBn = BigNum.fromInt(0);\r\n  }\r\n\r\n  const lvlIsInf = xpLvlBn.isInfinite?.() || (typeof xpLvlBn.isInfinite === 'function' && xpLvlBn.isInfinite());\r\n  if (lvlIsInf) {\r\n    return BigNum.fromAny('Infinity');\r\n  }\r\n\r\n  let levelPlain = '0';\r\n  try {\r\n    levelPlain = xpLvlBn.toPlainIntegerString?.() ?? xpLvlBn.toString?.() ?? '0';\r\n  } catch {\r\n    levelPlain = '0';\r\n  }\r\n\r\n  let targetLevelInfo = { bigInt: null, finite: true };\r\n  if (levelPlain && levelPlain !== 'Infinity') {\r\n    try {\r\n      targetLevelInfo = { bigInt: BigInt(levelPlain), finite: true };\r\n    } catch {\r\n      targetLevelInfo = { bigInt: null, finite: true };\r\n    }\r\n  } else {\r\n    targetLevelInfo = { bigInt: null, finite: true };\r\n  }\r\n\r\n  const targetLevel = targetLevelInfo.bigInt ?? 0n;\r\n\r\n  if (targetLevelInfo.bigInt != null && targetLevel <= 0n) {\r\n    const baseRequirement = xpRequirementCache.get('0');\r\n    return baseRequirement.clone?.() ?? baseRequirement;\r\n  }\r\n\r\n  if (targetLevelInfo.bigInt != null) {\r\n    ensureExactRequirementCacheUpTo(targetLevel);\r\n    const targetKey = targetLevel.toString();\r\n    const cachedExact = xpRequirementCache.get(targetKey);\r\n    if (cachedExact) {\r\n      return cachedExact.clone?.() ?? cachedExact;\r\n    }\r\n  }\r\n\r\n  const approximate = approximateRequirementFromLevel(xpLvlBn);\r\n  const approxIsInf = approximate.isInfinite?.() || (typeof approximate.isInfinite === 'function' && approximate.isInfinite());\r\n  if (approxIsInf) {\r\n    return infinityRequirementBn.clone?.() ?? infinityRequirementBn;\r\n  }\r\n\r\n  if (targetLevelInfo.bigInt != null) {\r\n    xpRequirementCache.set(targetLevelInfo.bigInt.toString(), approximate);\r\n  }\r\n  return approximate.clone?.() ?? approximate;\r\n}\r\n\r\nfunction updateXpRequirement() {\r\n  requirementBn = xpRequirementForXpLevel(xpState.xpLevel);\r\n}\r\n\r\nfunction resetLockedXpState() {\r\n  xpState.xpLevel = bnZero();\r\n  xpState.progress = bnZero();\r\n  updateXpRequirement();\r\n  syncCoinMultiplierWithXpLevel(true);\r\n}\r\n\r\nfunction normalizeProgress(applyRewards = false) {\r\n  // If either level or progress is already \u221E, enforce the invariant and bail.\r\n  if (enforceXpInfinityInvariant()) {\r\n    return;\r\n  }\r\n\r\n  updateXpRequirement();\r\n\r\n  // If the requirement is infinite, there is nothing meaningful to normalize.\r\n  if (bigNumIsInfinite(requirementBn)) {\r\n    return;\r\n  }\r\n\r\n  let guard = 0;\r\n  const limit = 10000;\r\n  while (xpState.progress.cmp?.(requirementBn) >= 0 && guard < limit) {\r\n    try { xpState.progress = xpState.progress.sub(requirementBn); }\r\n    catch { xpState.progress = bnZero(); }\r\n\r\n    try { xpState.xpLevel = xpState.xpLevel.add(bnOne()); }\r\n    catch { xpState.xpLevel = bnZero(); }\r\n\r\n    if (applyRewards) handleXpLevelUpRewards();\r\n    updateXpRequirement();\r\n\r\n    if (bigNumIsInfinite(requirementBn)) {\r\n      break;\r\n    }\r\n    guard += 1;\r\n  }\r\n\r\n  if (guard >= limit) {\r\n    xpState.progress = bnZero();\r\n  }\r\n}\r\n\r\nfunction xpLevelBigIntInfo(xpLevelValue) {\r\n  if (!xpLevelValue || typeof xpLevelValue !== 'object') {\r\n    return { bigInt: 0n, finite: false };\r\n  }\r\n  const levelIsInfinite = xpLevelValue.isInfinite?.() || (typeof xpLevelValue.isInfinite === 'function' && xpLevelValue.isInfinite());\r\n  if (levelIsInfinite) {\r\n    return { bigInt: null, finite: false };\r\n  }\r\n  let plain = '0';\r\n  try {\r\n    plain = xpLevelValue.toPlainIntegerString?.() ?? xpLevelValue.toString?.() ?? '0';\r\n  } catch {\r\n    plain = '0';\r\n  }\r\n  if (plain === 'Infinity') {\r\n    return { bigInt: null, finite: false };\r\n  }\r\n  if (!plain) {\r\n    return { bigInt: null, finite: true };\r\n  }\r\n  try {\r\n    return { bigInt: BigInt(plain), finite: true };\r\n  } catch {\r\n    return { bigInt: null, finite: true };\r\n  }\r\n}\r\n\r\nfunction syncCoinMultiplierWithXpLevel(force = false) {\r\n  const multApi = bank?.coins?.mult;\r\n  if (!multApi || typeof multApi.set !== 'function' || typeof multApi.multiplyByDecimal !== 'function') {\r\n    return;\r\n  }\r\n\r\n  const levelInfo = xpLevelBigIntInfo(xpState.xpLevel);\r\n  const levelBigInt = levelInfo.bigInt;\r\n  const levelIsInfinite = !levelInfo.finite;\r\n  const levelStorageKey = typeof xpState.xpLevel?.toStorage === 'function' ? xpState.xpLevel.toStorage() : null;\r\n\r\n  if (!force) {\r\n    if (levelIsInfinite && lastSyncedCoinLevelWasInfinite) {\r\n      return;\r\n    }\r\n    if (!levelIsInfinite && levelBigInt != null && !lastSyncedCoinLevelWasInfinite && !lastSyncedCoinUsedApproximation && lastSyncedCoinLevel != null && levelBigInt === lastSyncedCoinLevel) {\r\n      return;\r\n    }\r\n    if (!levelIsInfinite && levelBigInt == null && lastSyncedCoinUsedApproximation && levelStorageKey && lastSyncedCoinApproxKey && levelStorageKey === lastSyncedCoinApproxKey) {\r\n      return;\r\n    }\r\n  }\r\n\r\n  if (levelIsInfinite) {\r\n    try { multApi.set(infinityRequirementBn); } catch {}\r\n    lastSyncedCoinLevel = null;\r\n    lastSyncedCoinLevelWasInfinite = true;\r\n    lastSyncedCoinUsedApproximation = false;\r\n    lastSyncedCoinApproxKey = null;\r\n    return;\r\n  }\r\n\r\n  let multiplierBn;\r\n  if (levelBigInt != null && levelBigInt <= EXACT_COIN_LEVEL_LIMIT) {\r\n    let working = BigNum.fromInt(1);\r\n    const iterations = Number(levelBigInt);\r\n    for (let i = 0; i < iterations; i += 1) {\r\n      working = working.mulDecimal('1.1', 18);\r\n    }\r\n    let levelAdd;\r\n    try { levelAdd = BigNum.fromAny(levelBigInt.toString()); }\r\n    catch { levelAdd = BigNum.fromInt(iterations); }\r\n    if (typeof working.add === 'function') {\r\n      working = working.add(levelAdd);\r\n    } else if (typeof levelAdd.add === 'function') {\r\n      working = levelAdd.add(working);\r\n    }\r\n    multiplierBn = working.clone?.() ?? working;\r\n  } else {\r\n    multiplierBn = approximateCoinMultiplierFromBigNum(xpState.xpLevel);\r\n  }\r\n\r\n  let finalMultiplier = multiplierBn.clone?.() ?? multiplierBn;\r\n  const providers = coinMultiplierProviders.size > 0\r\n    ? Array.from(coinMultiplierProviders)\r\n    : (typeof externalCoinMultiplierProvider === 'function' ? [externalCoinMultiplierProvider] : []);\r\n  for (const provider of providers) {\r\n    if (typeof provider !== 'function') continue;\r\n    try {\r\n      const maybe = provider({\r\n        baseMultiplier: finalMultiplier.clone?.() ?? finalMultiplier,\r\n        xpLevel: xpState.xpLevel.clone?.() ?? xpState.xpLevel,\r\n        xpUnlocked: xpState.unlocked,\r\n      });\r\n      if (maybe instanceof BigNum) {\r\n        finalMultiplier = maybe.clone?.() ?? maybe;\r\n      } else if (maybe != null) {\r\n        finalMultiplier = BigNum.fromAny(maybe);\r\n      }\r\n    } catch {}\r\n  }\r\n\r\n  const multIsInf = finalMultiplier.isInfinite?.() || (typeof finalMultiplier.isInfinite === 'function' && finalMultiplier.isInfinite());\r\n  try { multApi.set(finalMultiplier.clone?.() ?? finalMultiplier); } catch {}\r\n  if (multIsInf) {\r\n    lastSyncedCoinLevel = null;\r\n    lastSyncedCoinLevelWasInfinite = true;\r\n    lastSyncedCoinUsedApproximation = false;\r\n    lastSyncedCoinApproxKey = null;\r\n  } else if (levelBigInt != null && levelBigInt <= EXACT_COIN_LEVEL_LIMIT) {\r\n    lastSyncedCoinLevel = levelBigInt;\r\n    lastSyncedCoinLevelWasInfinite = false;\r\n    lastSyncedCoinUsedApproximation = false;\r\n    lastSyncedCoinApproxKey = null;\r\n  } else {\r\n    lastSyncedCoinLevel = null;\r\n    lastSyncedCoinLevelWasInfinite = false;\r\n    lastSyncedCoinUsedApproximation = true;\r\n    lastSyncedCoinApproxKey = levelStorageKey;\r\n  }\r\n}\r\n\r\nfunction ensureStateLoaded(force = false) {\r\n  const slot = getActiveSlot();\r\n  if (slot == null) {\r\n    lastSlot = null;\r\n    stateLoaded = false;\r\n    xpState.unlocked = false;\r\n    resetLockedXpState();\r\n    return xpState;\r\n  }\r\n  if (!force && stateLoaded && slot === lastSlot) return xpState;\r\n  lastSlot = slot;\r\n  stateLoaded = true;\r\n  try {\r\n    const unlockedRaw = localStorage.getItem(KEY_UNLOCK(slot));\r\n    xpState.unlocked = unlockedRaw === '1';\r\n  } catch {\r\n    xpState.unlocked = false;\r\n  }\r\n  try {\r\n    xpState.xpLevel = BigNum.fromAny(localStorage.getItem(KEY_XP_LEVEL(slot)) ?? '0');\r\n  } catch {\r\n    xpState.xpLevel = bnZero();\r\n  }\r\n  try {\r\n    xpState.progress = BigNum.fromAny(localStorage.getItem(KEY_PROGRESS(slot)) ?? '0');\r\n  } catch {\r\n    xpState.progress = bnZero();\r\n  }\r\n  if (!xpState.unlocked) {\r\n    resetLockedXpState();\r\n    return xpState;\r\n  }\r\n\r\n  enforceXpInfinityInvariant();\r\n\r\n  updateXpRequirement();\r\n  syncCoinMultiplierWithXpLevel(true);\r\n  ensureXpStorageWatchers();\r\n  return xpState;\r\n}\r\n\r\nfunction persistState() {\r\n  const slot = getActiveSlot();\r\n  if (slot == null) return;\r\n\r\n  const expected = {\r\n    unlocked: xpState.unlocked ? '1' : '0',\r\n    level: xpState.xpLevel.toStorage(),\r\n    progress: xpState.progress.toStorage(),\r\n  };\r\n\r\n  try { localStorage.setItem(KEY_UNLOCK(slot), expected.unlocked); }\r\n  catch {}\r\n  try { localStorage.setItem(KEY_XP_LEVEL(slot), expected.level); }\r\n  catch {}\r\n  try { localStorage.setItem(KEY_PROGRESS(slot), expected.progress); }\r\n  catch {}\r\n\r\n  const persisted = (() => {\r\n    let unlocked = xpState.unlocked;\r\n    let level = xpState.xpLevel;\r\n    let progress = xpState.progress;\r\n    try { unlocked = localStorage.getItem(KEY_UNLOCK(slot)) === '1'; }\r\n    catch {}\r\n    try {\r\n      const rawLevel = localStorage.getItem(KEY_XP_LEVEL(slot));\r\n      if (rawLevel) level = BigNum.fromAny(rawLevel);\r\n    } catch {}\r\n    try {\r\n      const rawProgress = localStorage.getItem(KEY_PROGRESS(slot));\r\n      if (rawProgress) progress = BigNum.fromAny(rawProgress);\r\n    } catch {}\r\n    return { unlocked, level, progress };\r\n  })();\r\n\r\n  primeStorageWatcherSnapshot(KEY_UNLOCK(slot), persisted.unlocked ? '1' : '0');\r\n  primeStorageWatcherSnapshot(KEY_XP_LEVEL(slot), persisted.level?.toStorage?.() ?? expected.level);\r\n  primeStorageWatcherSnapshot(KEY_PROGRESS(slot), persisted.progress?.toStorage?.() ?? expected.progress);\r\n\r\n  const mismatch =\r\n    persisted.unlocked !== xpState.unlocked ||\r\n    (persisted.level?.toStorage?.() ?? null) !== expected.level ||\r\n    (persisted.progress?.toStorage?.() ?? null) !== expected.progress;\r\n\r\n  if (mismatch) {\r\n    xpState.unlocked = persisted.unlocked;\r\n    xpState.xpLevel = persisted.level;\r\n    xpState.progress = persisted.progress;\r\n    updateXpRequirement();\r\n    syncCoinMultiplierWithXpLevel(true);\r\n    updateHud();\r\n  }\r\n}\r\n\r\nfunction handleXpLevelUpRewards() {\r\n  syncCoinMultiplierWithXpLevel(true);\r\n\r\n  let reward = bnOne();\r\n  if (typeof externalBookRewardProvider === 'function') {\r\n    try {\r\n      const maybe = externalBookRewardProvider({\r\n        baseReward: reward.clone?.() ?? reward,\r\n        xpLevel: xpState.xpLevel.clone?.() ?? xpState.xpLevel,\r\n        xpUnlocked: xpState.unlocked,\r\n      });\r\n      if (maybe instanceof BigNum) {\r\n        reward = maybe.clone?.() ?? maybe;\r\n      } else if (maybe != null) {\r\n        reward = BigNum.fromAny(maybe);\r\n      }\r\n    } catch {}\r\n  }\r\n\r\n  try {\r\n    if (bank?.books?.addWithMultiplier) {\r\n      bank.books.addWithMultiplier(reward);\r\n    } else if (bank?.books?.add) {\r\n      bank.books.add(reward);\r\n    }\r\n  } catch {}\r\n  const syncedLevelInfo = xpLevelBigIntInfo(xpState.xpLevel);\r\n  if (!syncedLevelInfo.finite) {\r\n    lastSyncedCoinLevel = null;\r\n    lastSyncedCoinLevelWasInfinite = true;\r\n    lastSyncedCoinUsedApproximation = false;\r\n    lastSyncedCoinApproxKey = null;\r\n  } else if (syncedLevelInfo.bigInt != null) {\r\n    lastSyncedCoinLevel = syncedLevelInfo.bigInt;\r\n    lastSyncedCoinLevelWasInfinite = false;\r\n    lastSyncedCoinUsedApproximation = false;\r\n    lastSyncedCoinApproxKey = null;\r\n  } else {\r\n    lastSyncedCoinLevel = null;\r\n    lastSyncedCoinLevelWasInfinite = false;\r\n    lastSyncedCoinUsedApproximation = true;\r\n    lastSyncedCoinApproxKey = typeof xpState.xpLevel?.toStorage === 'function' ? xpState.xpLevel.toStorage() : null;\r\n  }\r\n}\r\n\r\nfunction updateHud() {\r\n  if (!ensureHudRefs()) return;\r\n  const { container, bar, fill, xpLevelValue, progress } = hudRefs;\r\n  if (!container) return;\r\n  if (!xpState.unlocked) {\r\n    container.setAttribute('hidden', '');\r\n    if (fill) {\r\n      fill.style.setProperty('--xp-fill', '0%');\r\n      fill.style.width = '0%';\r\n    }\r\n    if (xpLevelValue) xpLevelValue.textContent = '0';\r\n    if (progress) {\r\n      const reqHtml = formatNumber(requirementBn);\r\n      progress.innerHTML = `<span class=\"xp-progress-current\">0</span><span class=\"xp-progress-separator\">/</span><span class=\"xp-progress-required\">${reqHtml}</span><span class=\"xp-progress-suffix\">XP</span>`;\r\n    }\r\n    if (bar) {\r\n      bar.setAttribute('aria-valuenow', '0');\r\n      const reqPlain = stripHtml(formatNumber(requirementBn));\r\n      bar.setAttribute('aria-valuetext', `0 / ${reqPlain || '10'} XP`);\r\n    }\r\n    syncXpMpHudLayout();\r\n    return;\r\n  }\r\n\r\n  container.removeAttribute('hidden');\r\n  const requirement = requirementBn;\r\n  const ratio = progressRatio(xpState.progress, requirement);\r\n  const pct = `${(ratio * 100).toFixed(2)}%`;\r\n  if (fill) {\r\n    fill.style.setProperty('--xp-fill', pct);\r\n    fill.style.width = pct;\r\n  }\r\n  if (xpLevelValue) {\r\n    xpLevelValue.innerHTML = formatNumber(xpState.xpLevel);\r\n  }\r\n  if (progress) {\r\n    const currentHtml = formatNumber(xpState.progress);\r\n    const reqHtml = formatNumber(requirement);\r\n    progress.innerHTML = `<span class=\"xp-progress-current\">${currentHtml}</span><span class=\"xp-progress-separator\">/</span><span class=\"xp-progress-required\">${reqHtml}</span><span class=\"xp-progress-suffix\">XP</span>`;\r\n  }\r\n  if (bar) {\r\n    bar.setAttribute('aria-valuenow', (ratio * 100).toFixed(2));\r\n    const currPlain = stripHtml(formatNumber(xpState.progress));\r\n    const reqPlain = stripHtml(formatNumber(requirement));\r\n    bar.setAttribute('aria-valuetext', `${currPlain} / ${reqPlain} XP`);\r\n  }\r\n  syncXpMpHudLayout();\r\n}\r\n\r\nexport function initXpSystem({ forceReload = false } = {}) {\r\n  ensureHudRefs();\r\n  ensureStateLoaded(forceReload);\r\n  updateXpRequirement();\r\n  updateHud();\r\n  ensureXpStorageWatchers();\r\n  return getXpState();\r\n}\r\n\r\nexport function unlockXpSystem() {\r\n  ensureStateLoaded();\r\n  if (xpState.unlocked) {\r\n    updateHud();\r\n    return false;\r\n  }\r\n  resetLockedXpState();\r\n  xpState.unlocked = true;\r\n  persistState();\r\n  updateHud();\r\n  syncCoinMultiplierWithXpLevel(true);\r\n  try {\r\n    window.dispatchEvent(new CustomEvent('xp:unlock', { detail: getXpState() }));\r\n  } catch {}\r\n  return true;\r\n}\r\n\r\nexport function resetXpProgress({ keepUnlock = true } = {}) {\r\n  ensureStateLoaded();\r\n  const wasUnlocked = xpState.unlocked;\r\n  resetLockedXpState();\r\n  xpState.unlocked = keepUnlock ? (wasUnlocked || xpState.unlocked) : false;\r\n  persistState();\r\n  updateHud();\r\n  syncCoinMultiplierWithXpLevel(true);\r\n  return getXpState();\r\n}\r\n\r\nexport function addXp(amount, { silent = false } = {}) {\r\n  ensureStateLoaded();\r\n  const slot = lastSlot ?? getActiveSlot();\r\n  \r\n  // 1. Basic Unlock Check\r\n  if (!xpState.unlocked) {\r\n    return {\r\n      unlocked: false,\r\n      xpLevelsGained: bnZero(),\r\n      xpAdded: bnZero(),\r\n      xpLevel: xpState.xpLevel,\r\n      requirement: requirementBn\r\n    };\r\n  }\r\n\r\n  // 2. Parse Input Amount\r\n  let inc;\r\n  try {\r\n    if (amount instanceof BigNum) {\r\n      inc = amount.clone?.() ?? BigNum.fromAny(amount ?? 0);\r\n    } else {\r\n      inc = BigNum.fromAny(amount ?? 0);\r\n    }\r\n  } catch {\r\n    inc = bnZero();\r\n  }\r\n\r\n  // 3. Apply Multipliers\r\n  if (!inc.isZero?.()) {\r\n    const providers = xpGainMultiplierProviders.size > 0\r\n      ? Array.from(xpGainMultiplierProviders)\r\n      : (typeof externalXpGainMultiplierProvider === 'function' ? [externalXpGainMultiplierProvider] : []);\r\n    for (const provider of providers) {\r\n      if (typeof provider !== 'function') continue;\r\n      try {\r\n        const maybe = provider({\r\n          baseGain: inc.clone?.() ?? inc,\r\n          xpLevel: xpState.xpLevel.clone?.() ?? xpState.xpLevel,\r\n          xpUnlocked: xpState.unlocked,\r\n        });\r\n        if (maybe instanceof BigNum) {\r\n          inc = maybe.clone?.() ?? maybe;\r\n        } else if (maybe != null) {\r\n          inc = BigNum.fromAny(maybe);\r\n        }\r\n      } catch {}\r\n    }\r\n  }\r\n\r\n  inc = applyStatMultiplierOverride('xp', inc);\r\n\r\n  // 4. Handle Zero Gain\r\n  if (inc.isZero?.() || (typeof inc.isZero === 'function' && inc.isZero())) {\r\n    updateHud();\r\n    return {\r\n      unlocked: true,\r\n      xpLevelsGained: bnZero(),\r\n      xpAdded: inc,\r\n      xpLevel: xpState.xpLevel,\r\n      requirement: requirementBn\r\n    };\r\n  }\r\n\r\n  // 5. Add to Progress\r\n  xpState.progress = xpState.progress.add(inc);\r\n  updateXpRequirement();\r\n\r\n  // 6. Handle Infinity (Early Exit)\r\n  const progressIsInf = bigNumIsInfinite(xpState.progress);\r\n  const levelIsInf = bigNumIsInfinite(xpState.xpLevel);\r\n  const gainIsInf = bigNumIsInfinite(inc);\r\n\r\n  if (progressIsInf || levelIsInf || gainIsInf) {\r\n    const inf = infinityRequirementBn.clone?.() ?? infinityRequirementBn;\r\n    xpState.xpLevel = inf.clone?.() ?? inf;\r\n    xpState.progress = inf.clone?.() ?? inf;\r\n    requirementBn = inf.clone?.() ?? inf;\r\n\r\n    enforceXpInfinityInvariant();\r\n    persistState();\r\n    updateHud();\r\n    syncCoinMultiplierWithXpLevel(true);\r\n\r\n    const detail = {\r\n      unlocked: true,\r\n      xpLevelsGained: bnZero(),\r\n      xpAdded: inc.clone?.() ?? inc,\r\n      xpLevel: xpState.xpLevel.clone?.() ?? xpState.xpLevel,\r\n      progress: xpState.progress.clone?.() ?? xpState.progress,\r\n      requirement: requirementBn.clone?.() ?? requirementBn,\r\n      slot,\r\n    };\r\n    notifyXpSubscribers(detail);\r\n    if (!silent && typeof window !== 'undefined') {\r\n      try { window.dispatchEvent(new CustomEvent('xp:change', { detail })); } catch {}\r\n    }\r\n    return detail;\r\n  }\r\n\r\n  // 7. Bulk Level Calculation Logic\r\n  let xpLevelsGained = bnZero();\r\n\r\n  // Safety check: if progress < requirement, we are done immediately.\r\n  if (xpState.progress.cmp(requirementBn) < 0) {\r\n    persistState();\r\n    updateHud();\r\n    const detail = {\r\n      unlocked: true,\r\n      xpLevelsGained: bnZero(),\r\n      xpAdded: inc,\r\n      xpLevel: xpState.xpLevel,\r\n      progress: xpState.progress,\r\n      requirement: requirementBn,\r\n      slot,\r\n    };\r\n    notifyXpSubscribers(detail);\r\n    if (!silent && typeof window !== 'undefined') {\r\n      try { window.dispatchEvent(new CustomEvent('xp:change', { detail })); } catch {}\r\n    }\r\n    return detail;\r\n  }\r\n\r\n  /* Optimization: \r\n     Instead of iterating one by one, we estimate the target level based on the log10 of current progress.\r\n     \r\n     The curve is roughly: Req(L) \u2248 Base * (1.1)^L * (2.5)^(L/10).\r\n     Log(Req) \u2248 Log(Base) + L * Log(1.1) + (L/10) * Log(2.5)\r\n     Log(Req) \u2248 Log(Base) + L * (Log(1.1) + 0.1 * Log(2.5))\r\n     \r\n     We reverse this to find L given the current Progress (which acts as the \"Requirement\" for that higher level).\r\n     L \u2248 (Log(Progress) - Log(Base)) / (Log(1.1) + 0.1 * Log(2.5))\r\n  */\r\n  \r\n  const currentProgressLog = approxLog10(xpState.progress);\r\n  // Constants derived from: Math.log10(1.1) + 0.1 * Math.log10(2.5)\r\n  // 0.04139... + 0.03979... \u2248 0.081186686\r\n  const COMBINED_LOG_FACTOR = 0.08118668602542883;\r\n\r\n  // We only switch to approximation if the gap is likely massive\r\n  // If the log difference is small, the standard loop is safer and more precise.\r\n  // If the log difference is > 2 (100x requirement), we try to skip.\r\n  const reqLog = approxLog10(requirementBn);\r\n  \r\n  if (currentProgressLog - reqLog > 2) {\r\n    const baseLevelBn = xpState.xpLevel;\r\n    \r\n    // Estimate how many levels we *might* gain.\r\n    // This is an over-approximation because it ignores the 'staircase' of the exact requirement,\r\n    // but it gets us close.\r\n    const logDiff = currentProgressLog - reqLog;\r\n    const estimatedGain = Math.floor(logDiff / COMBINED_LOG_FACTOR);\r\n    \r\n    if (estimatedGain > 500) {\r\n      // Calculate the jump\r\n      // We subtract a safety buffer (e.g. 5 levels) to ensure we don't overshoot\r\n      // into negative progress due to precision loss in the log math.\r\n      const safeGain = BigInt(Math.max(0, estimatedGain - 5));\r\n      \r\n      if (safeGain > 0n) {\r\n        const jumpBn = BigNum.fromAny(safeGain.toString());\r\n        xpState.xpLevel = xpState.xpLevel.add(jumpBn);\r\n        xpLevelsGained = xpLevelsGained.add(jumpBn);\r\n        \r\n        // Update requirement to the new level to check if we are still above it\r\n        updateXpRequirement();\r\n        \r\n        // Note: We deliberately DO NOT call handleXpLevelUpRewards() for every skipped level \r\n        // in a massive jump (e.g. 1 million levels) because that would freeze the UI.\r\n        // Instead, we just sync the coin multiplier at the end. \r\n        // If your game relies on per-level \"Book\" rewards, you would batch add them here:\r\n        // bank.books.add(bookRewardPerLevel.mul(jumpBn));\r\n        \r\n        // Sync rewards for the bulk jump (assuming 1 book per level flat reward structure for bulk)\r\n        // If rewards vary per level, this needs a more complex integration formula.\r\n        // For this specific system, handleXpLevelUpRewards simply calls syncCoinMultiplier \r\n        // and adds a book. We can batch the book add:\r\n         if (bank?.books?.add) {\r\n            try {\r\n              let bulkReward = jumpBn.clone();\r\n              // Apply book provider if exists (assuming it scales linearly or we take a snapshot)\r\n              // Since provider depends on level, doing it accurately for 1e100 levels is impossible iteratively.\r\n              // We effectively skip intermediate complex reward calculations for performance.\r\n              bank.books.add(bulkReward);\r\n            } catch {}\r\n         }\r\n      }\r\n    }\r\n  }\r\n\r\n  // 8. Finalize with standard loop (Cleanup)\r\n  // This handles the remaining small number of levels (or the whole thing if the jump was small)\r\n  // ensuring exact precision for the final transition.\r\n  let guard = 0;\r\n  const limit = 500; // Hard limit to prevent freezes if approximation fails\r\n  \r\n  while (xpState.progress.cmp?.(requirementBn) >= 0 && guard < limit) {\r\n    xpState.progress = xpState.progress.sub(requirementBn);\r\n    xpState.xpLevel = xpState.xpLevel.add(bnOne());\r\n    xpLevelsGained = xpLevelsGained.add(bnOne());\r\n    \r\n    // Handle specific rewards for these 'real' level ups\r\n    handleXpLevelUpRewards();\r\n    updateXpRequirement();\r\n    \r\n    const reqIsInf = bigNumIsInfinite(requirementBn);\r\n    if (reqIsInf) break;\r\n    guard += 1;\r\n  }\r\n  \r\n  // If we hit the limit, we simply cap the progress to 0 (or leave it) to prevent infinite loops.\r\n  // In a perfect system, we'd do another jump, but 500 iterations is plenty for \"cleanup\".\r\n  if (guard >= limit && xpState.progress.cmp(requirementBn) >= 0) {\r\n      // Emergency break: if we still have progress > requirement after max iterations,\r\n      // it means the growth curve is too shallow compared to progress. \r\n      // We force a sync and stop.\r\n      updateXpRequirement(); \r\n  }\r\n\r\n  // 9. Persist and Notify\r\n  persistState();\r\n  updateHud();\r\n\r\n  // Maintain sync flags logic from original\r\n  const syncedLevelAfterAdd = xpLevelBigIntInfo(xpState.xpLevel);\r\n  if (!syncedLevelAfterAdd.finite) {\r\n    lastSyncedCoinLevel = null;\r\n    lastSyncedCoinLevelWasInfinite = true;\r\n    lastSyncedCoinUsedApproximation = false;\r\n    lastSyncedCoinApproxKey = null;\r\n  } else if (syncedLevelAfterAdd.bigInt != null) {\r\n    lastSyncedCoinLevel = syncedLevelAfterAdd.bigInt;\r\n    lastSyncedCoinLevelWasInfinite = false;\r\n    lastSyncedCoinUsedApproximation = false;\r\n    lastSyncedCoinApproxKey = null;\r\n  } else {\r\n    lastSyncedCoinLevel = null;\r\n    lastSyncedCoinLevelWasInfinite = false;\r\n    lastSyncedCoinUsedApproximation = true;\r\n    lastSyncedCoinApproxKey = typeof xpState.xpLevel?.toStorage === 'function'\r\n      ? xpState.xpLevel.toStorage()\r\n      : null;\r\n  }\r\n\r\n  const detail = {\r\n    unlocked: true,\r\n    xpLevelsGained: xpLevelsGained.clone?.() ?? xpLevelsGained,\r\n    xpAdded: inc.clone?.() ?? inc,\r\n    xpLevel: xpState.xpLevel.clone?.() ?? xpState.xpLevel,\r\n    progress: xpState.progress.clone?.() ?? xpState.progress,\r\n    requirement: requirementBn.clone?.() ?? requirementBn,\r\n    slot,\r\n  };\r\n  \r\n  notifyXpSubscribers(detail);\r\n  if (!silent && typeof window !== 'undefined') {\r\n    try { window.dispatchEvent(new CustomEvent('xp:change', { detail })); } catch {}\r\n  }\r\n  return detail;\r\n}\r\n\r\nexport function getXpState() {\r\n  ensureStateLoaded();\r\n  return {\r\n    unlocked: xpState.unlocked,\r\n    xpLevel: xpState.xpLevel.clone?.() ?? xpState.xpLevel,\r\n    progress: xpState.progress.clone?.() ?? xpState.progress,\r\n    requirement: requirementBn.clone?.() ?? requirementBn,\r\n  };\r\n}\r\n\r\nexport function broadcastXpChange(detailOverrides = {}) {\r\n  ensureStateLoaded();\r\n  const slot = lastSlot ?? getActiveSlot();\r\n  const detail = {\r\n    ...getXpState(),\r\n    slot,\r\n    ...detailOverrides,\r\n  };\r\n\r\n  notifyXpSubscribers(detail);\r\n  if (typeof window !== 'undefined') {\r\n    try { window.dispatchEvent(new CustomEvent('xp:change', { detail })); } catch {}\r\n  }\r\n\r\n  return detail;\r\n}\r\n\r\nexport function isXpSystemUnlocked() {\r\n  ensureStateLoaded();\r\n  return !!xpState.unlocked;\r\n}\r\n\r\nexport function getXpRequirementForXpLevel(xpLevel) {\r\n  return xpRequirementForXpLevel(xpLevel);\r\n}\r\n\r\nexport function getXpGainMultiplier() {\r\n  ensureStateLoaded();\r\n  let mult = bnOne();\r\n  const providers = xpGainMultiplierProviders.size > 0\r\n    ? Array.from(xpGainMultiplierProviders)\r\n    : (typeof externalXpGainMultiplierProvider === 'function' ? [externalXpGainMultiplierProvider] : []);\r\n  for (const provider of providers) {\r\n    if (typeof provider !== 'function') continue;\r\n    try {\r\n      const maybe = provider({\r\n        baseGain: mult.clone?.() ?? mult,\r\n        xpLevel: xpState.xpLevel.clone?.() ?? xpState.xpLevel,\r\n        xpUnlocked: xpState.unlocked,\r\n      });\r\n      if (maybe instanceof BigNum) {\r\n        mult = maybe.clone?.() ?? maybe;\r\n      } else if (maybe != null) {\r\n        mult = BigNum.fromAny(maybe);\r\n      }\r\n    } catch {}\r\n  }\r\n  return mult;\r\n}\r\n\r\nexport function computeCoinMultiplierForXpLevel(levelValue) {\r\n  let xpLevelBn;\r\n  try {\r\n    xpLevelBn = levelValue instanceof BigNum ? levelValue : BigNum.fromAny(levelValue ?? 0);\r\n  } catch {\r\n    xpLevelBn = BigNum.fromInt(0);\r\n  }\r\n\r\n  const levelInfo = xpLevelBigIntInfo(xpLevelBn);\r\n  const levelBigInt = levelInfo.bigInt;\r\n  const levelIsInfinite = !levelInfo.finite;\r\n\r\n  if (levelIsInfinite) {\r\n    return infinityRequirementBn.clone?.() ?? infinityRequirementBn;\r\n  }\r\n\r\n  let multiplierBn;\r\n  if (levelBigInt != null && levelBigInt <= EXACT_COIN_LEVEL_LIMIT) {\r\n    let working = BigNum.fromInt(1);\r\n    const iterations = Number(levelBigInt);\r\n    for (let i = 0; i < iterations; i += 1) {\r\n      working = working.mulDecimal('1.1', 18);\r\n    }\r\n    let levelAdd;\r\n    try { levelAdd = BigNum.fromAny(levelBigInt.toString()); }\r\n    catch { levelAdd = BigNum.fromInt(iterations); }\r\n    if (typeof working.add === 'function') {\r\n      working = working.add(levelAdd);\r\n    } else if (typeof levelAdd.add === 'function') {\r\n      working = levelAdd.add(working);\r\n    }\r\n    multiplierBn = working.clone?.() ?? working;\r\n  } else {\r\n    multiplierBn = approximateCoinMultiplierFromBigNum(xpLevelBn);\r\n  }\r\n\r\n  let finalMultiplier = multiplierBn.clone?.() ?? multiplierBn;\r\n  const providers = coinMultiplierProviders.size > 0\r\n    ? Array.from(coinMultiplierProviders)\r\n    : (typeof externalCoinMultiplierProvider === 'function' ? [externalCoinMultiplierProvider] : []);\r\n  for (const provider of providers) {\r\n    if (typeof provider !== 'function') continue;\r\n    try {\r\n      const maybe = provider({\r\n        baseMultiplier: finalMultiplier.clone?.() ?? finalMultiplier,\r\n        xpLevel: xpLevelBn.clone?.() ?? xpLevelBn,\r\n        xpUnlocked: !!xpState.unlocked,\r\n      });\r\n      if (maybe instanceof BigNum) {\r\n        finalMultiplier = maybe.clone?.() ?? maybe;\r\n      } else if (maybe != null) {\r\n        finalMultiplier = BigNum.fromAny(maybe);\r\n      }\r\n    } catch {}\r\n  }\r\n\r\n  return finalMultiplier.clone?.() ?? finalMultiplier;\r\n}\r\n\r\nexport function setExternalCoinMultiplierProvider(fn) {\r\n  externalCoinMultiplierProvider = typeof fn === 'function' ? fn : null;\r\n  coinMultiplierProviders.clear();\r\n  if (externalCoinMultiplierProvider) {\r\n    coinMultiplierProviders.add(externalCoinMultiplierProvider);\r\n  }\r\n  ensureStateLoaded();\r\n  syncCoinMultiplierWithXpLevel(true);\r\n}\r\n\r\nexport function refreshCoinMultiplierFromXpLevel() {\r\n  ensureStateLoaded();\r\n  syncCoinMultiplierWithXpLevel(true);\r\n}\r\n\r\nexport function setExternalXpGainMultiplierProvider(fn) {\r\n  externalXpGainMultiplierProvider = typeof fn === 'function' ? fn : null;\r\n  xpGainMultiplierProviders.clear();\r\n  if (externalXpGainMultiplierProvider) {\r\n    xpGainMultiplierProviders.add(externalXpGainMultiplierProvider);\r\n  }\r\n}\r\n\r\nexport function addExternalCoinMultiplierProvider(fn) {\r\n  if (typeof fn !== 'function') return () => {};\r\n  coinMultiplierProviders.add(fn);\r\n  ensureStateLoaded();\r\n  syncCoinMultiplierWithXpLevel(true);\r\n  return () => {\r\n    coinMultiplierProviders.delete(fn);\r\n    ensureStateLoaded();\r\n    syncCoinMultiplierWithXpLevel(true);\r\n  };\r\n}\r\n\r\nexport function addExternalXpGainMultiplierProvider(fn) {\r\n  if (typeof fn !== 'function') return () => {};\r\n  xpGainMultiplierProviders.add(fn);\r\n  ensureStateLoaded();\r\n  return () => {\r\n    xpGainMultiplierProviders.delete(fn);\r\n  };\r\n}\r\n\r\nexport function setExternalBookRewardProvider(fn) {\r\n  externalBookRewardProvider = typeof fn === 'function' ? fn : null;\r\n}\r\n\r\nif (typeof window !== 'undefined') {\r\n  window.xpSystem = window.xpSystem || {};\r\n  Object.assign(window.xpSystem, {\r\n    initXpSystem,\r\n    unlockXpSystem,\r\n    addXp,\r\n    getXpState,\r\n    broadcastXpChange,\r\n    isXpSystemUnlocked,\r\n    getXpRequirementForXpLevel,\r\n    getXpGainMultiplier,\r\n    setExternalCoinMultiplierProvider,\r\n    addExternalCoinMultiplierProvider,\r\n    refreshCoinMultiplierFromXpLevel,\r\n    setExternalXpGainMultiplierProvider,\r\n    addExternalXpGainMultiplierProvider,\r\n    setExternalBookRewardProvider,\r\n    resetXpProgress,\r\n  });\r\n}\r\n", "// js/util/ghostTapGuard.js\r\n// Fixes issue with buttons on mobile that prevents them from being spam clicked\r\n// It's important that this is applied to every clickable button in the game\r\n\r\nconst DEFAULT_TIMEOUT_MS = 0;\r\nconst ELEMENT_SKIP_PROP = Symbol('ccc:ghostTap:skipUntil');\r\nconst GLOBAL_SKIP_PROP = '__cccGhostTapSkipUntil';\r\nconst TARGET_SELECTOR = '[data-ghost-tap-target], button, [role=\"button\"], [data-btn], .game-btn, .btn, .slot-card, a[href], input, select, textarea, summary';\r\nconst DEFAULT_LONG_PRESS_MS = 80;\r\n\r\nlet guardInstalled = false;\r\nlet selector = TARGET_SELECTOR;\r\nlet hasPointerEvents = false;\r\nlet hasTouchEvents = false;\r\nlet lastMarkedTarget = null;\r\nlet lastTouchMs = 0;\r\nlet lastTouchStartMs = 0;\r\nlet lastTouchDurationMs = 0;\r\nlet longPressMs = DEFAULT_LONG_PRESS_MS;\r\n\r\nfunction nowMs() {\r\n  if (typeof performance !== 'undefined' && typeof performance.now === 'function') {\r\n    return performance.now();\r\n  }\r\n  return Date.now();\r\n}\r\n\r\nfunction getDocument() {\r\n  if (typeof document === 'undefined') return null;\r\n  return document;\r\n}\r\n\r\nfunction findTapTarget(node) {\r\n  const doc = getDocument();\r\n  if (!doc) return null;\r\n  const ElementCtor = typeof Element !== 'undefined' ? Element : null;\r\n  if (!node || !ElementCtor) return null;\r\n  if (!(node instanceof ElementCtor)) {\r\n    node = node.parentElement;\r\n  }\r\n  if (!node || !node.closest) return null;\r\n  return node.closest(selector);\r\n}\r\n\r\nfunction clearGhostTapTarget(el) {\r\n  if (!el) return;\r\n  el[ELEMENT_SKIP_PROP] = 0;\r\n}\r\n\r\nfunction markGhostTapTarget(el, timeout = DEFAULT_TIMEOUT_MS, globalTimeout = null) {\r\n  if (!el) return;\r\n  const now = nowMs();\r\n  const delay = Number.isFinite(timeout) ? Math.max(0, Number(timeout)) : DEFAULT_TIMEOUT_MS;\r\n  if (delay > 0) {\r\n    el[ELEMENT_SKIP_PROP] = now + delay;\r\n  } else {\r\n    el[ELEMENT_SKIP_PROP] = 0;\r\n  }\r\n  lastMarkedTarget = el;\r\n\r\n  const gDelay = globalTimeout !== null\r\n    ? (Number.isFinite(globalTimeout) ? Math.max(0, Number(globalTimeout)) : DEFAULT_TIMEOUT_MS)\r\n    : delay;\r\n\r\n  if (gDelay > 0) suppressNextGhostTap(gDelay);\r\n}\r\n\r\nfunction consumeGhostTapGuard(target) {\r\n  if (typeof window === 'undefined') return false;\r\n  const until = window[GLOBAL_SKIP_PROP];\r\n  if (typeof until !== 'number') return false;\r\n\r\n  const now = nowMs();\r\n  if (now <= until) {\r\n    // We intentionally removed the \"return false if target matches\" logic\r\n    // because we now rely on !event.isTrusted to let the synthetic click pass.\r\n    // So if the guard is active, we BLOCK (return true).\r\n    return true;\r\n  }\r\n\r\n  // If expired, clear it\r\n  window[GLOBAL_SKIP_PROP] = null;\r\n  return false;\r\n}\r\n\r\nfunction shouldSkipGhostTap(el) {\r\n  if (!el) return false;\r\n  const until = Number(el[ELEMENT_SKIP_PROP] || 0);\r\n  if (!Number.isFinite(until) || until <= 0) return false;\r\n  const now = nowMs();\r\n  if (now <= until) {\r\n    // Always block if the element is marked and time hasn't passed.\r\n    // We removed the \"allow first match\" logic here too.\r\n    clearGhostTapTarget(el);\r\n    return true;\r\n  }\r\n  clearGhostTapTarget(el);\r\n  return false;\r\n}\r\n\r\nfunction suppressNextGhostTap(timeout = DEFAULT_TIMEOUT_MS) {\r\n  if (typeof window === 'undefined') return;\r\n  const now = nowMs();\r\n  const targetDelay = Math.max(0, Number.isFinite(timeout) ? timeout : DEFAULT_TIMEOUT_MS);\r\n  if (targetDelay <= 0) {\r\n    window[GLOBAL_SKIP_PROP] = null;\r\n    return;\r\n  }\r\n  const target = now + targetDelay;\r\n  const current = typeof window[GLOBAL_SKIP_PROP] === 'number'\r\n    ? window[GLOBAL_SKIP_PROP]\r\n    : 0;\r\n  window[GLOBAL_SKIP_PROP] = Math.max(current, target);\r\n}\r\n\r\nfunction onPointerStart(event) {\r\n  if (event.pointerType === 'mouse') return;\r\n  if (typeof event.button === 'number' && event.button !== 0) return;\r\n  lastTouchMs = lastTouchStartMs = nowMs();\r\n  lastTouchDurationMs = 0;\r\n  // Note: We removed consumeGhostTapGuard here to allow rapid \"spam\" taps.\r\n  // We only block the resulting *clicks* in onClickCapture.\r\n}\r\n\r\nfunction onTouchStart(event) {\r\n  lastTouchMs = lastTouchStartMs = nowMs();\r\n  lastTouchDurationMs = 0;\r\n  // Note: We removed consumeGhostTapGuard here to allow rapid \"spam\" taps.\r\n}\r\n\r\nfunction onPointerEnd(event) {\r\n  if (event.pointerType === 'mouse') return;\r\n  if (typeof event.button === 'number' && event.button !== 0) return;\r\n  const now = nowMs();\r\n  if (lastTouchStartMs > 0) {\r\n    lastTouchDurationMs = now - lastTouchStartMs;\r\n  }\r\n  lastTouchMs = now;\r\n}\r\n\r\nfunction onTouchEnd() {\r\n  const now = nowMs();\r\n  if (lastTouchStartMs > 0) {\r\n    lastTouchDurationMs = now - lastTouchStartMs;\r\n  }\r\n  lastTouchMs = now;\r\n}\r\n\r\nfunction onClickCapture(event) {\r\n  // Always allow synthetic/programmatic clicks (e.g. from handleInstantClick)\r\n  if (!event.isTrusted) return;\r\n\r\n  const now = nowMs();\r\n  const sinceTouchStart = lastTouchStartMs > 0 ? now - lastTouchStartMs : -1;\r\n  \r\n  // If we have a running guard (Element or Global), check it.\r\n  const target = findTapTarget(event.target);\r\n\r\n  // Check element-specific guard first (fixes hold-release double tap)\r\n  if (shouldSkipGhostTap(target)) {\r\n    lastTouchDurationMs = 0;\r\n    event.preventDefault();\r\n    event.stopImmediatePropagation();\r\n    return;\r\n  }\r\n\r\n  // Check global guard (fixes ghost taps on other elements)\r\n  if (consumeGhostTapGuard(target)) {\r\n    if (target) clearGhostTapTarget(target);\r\n    lastTouchDurationMs = 0;\r\n    event.preventDefault();\r\n    event.stopImmediatePropagation();\r\n    return;\r\n  }\r\n\r\n  if (sinceTouchStart < 0) return;\r\n  if (!target) return;\r\n\r\n  const effectiveDuration = lastTouchDurationMs || sinceTouchStart;\r\n\r\n  if (effectiveDuration >= longPressMs) {\r\n    clearGhostTapTarget(target);\r\n    lastTouchDurationMs = 0;\r\n    event.preventDefault();\r\n    event.stopImmediatePropagation();\r\n    return;\r\n  }\r\n  \r\n  lastTouchDurationMs = 0;\r\n}\r\n\r\n\r\nexport function installGhostTapGuard(options = {}) {\r\n  if (guardInstalled) return;\r\n  const doc = getDocument();\r\n  if (!doc || typeof window === 'undefined') return;\r\n\r\n  guardInstalled = true;\r\n  hasPointerEvents = 'PointerEvent' in window;\r\n  hasTouchEvents = !hasPointerEvents && 'ontouchstart' in window;\r\n  if (options.selector) {\r\n    selector = `${options.selector}, ${TARGET_SELECTOR}`;\r\n  }\r\n\r\n  if (Number.isFinite(options.longPressMs) && options.longPressMs >= 0) {\r\n    longPressMs = options.longPressMs;\r\n  }\r\n\r\n  doc.addEventListener('click', onClickCapture, true);\r\n\r\n  if (hasPointerEvents) {\r\n    doc.addEventListener('pointerdown', onPointerStart, { capture: true, passive: false });\r\n    doc.addEventListener('pointerup', onPointerEnd, { capture: true, passive: true });\r\n  } else if (hasTouchEvents) {\r\n    doc.addEventListener('touchstart', onTouchStart, { capture: true, passive: false });\r\n    doc.addEventListener('touchend', onTouchEnd, { capture: true, passive: true });\r\n  }\r\n}\r\n\r\nfunction handleInstantClick(event) {\r\n  if (event.pointerType === 'mouse') return;\r\n  if (typeof event.button === 'number' && event.button !== 0) return;\r\n  if (!event.isTrusted) return;\r\n\r\n  const target = event.target;\r\n  if (!target) return;\r\n\r\n  // We only want to auto-trigger elements that look like buttons\r\n  const buttonLike = target.closest(TARGET_SELECTOR);\r\n  if (!buttonLike) return;\r\n\r\n  // EXCLUSIONS:\r\n  // Scrollable areas where we don't want accidental taps during scroll starts\r\n  // (Shop lists, Merchant dialogue lists)\r\n  // NOTE: .debug-panel and .debug-panel-action-log are intentionally NOT excluded\r\n  // to allow ghost tapping on debug buttons as per user request.\r\n  \r\n  // Exclude Shop list\r\n  if (buttonLike.closest('.shop-scroller')) return;\r\n\r\n  // Exclude Automation Shop list\r\n  if (buttonLike.closest('.automation-shop-scroller')) return;\r\n  \r\n  // Exclude Dialogue list\r\n  if (buttonLike.closest('.merchant-dialogue-list') && !buttonLike.closest('.merchant-firstchat')) return;\r\n\r\n  // If a specific element asked to avoid this logic, bail\r\n  if (buttonLike.dataset.noGhost === 'true') return;\r\n\r\n  // Manually \"click\" it immediately to bypass the 300ms delay or touch-drag threshold\r\n  // Mark it so we don't double-fire if the browser also sends a click later.\r\n  // We use a long timeout (2000ms) for the element to prevent \"hold\" double-taps,\r\n  // but a short global timeout (300ms) to avoid blocking other elements if the user taps rapidly.\r\n  markGhostTapTarget(buttonLike, 2000, 300);\r\n\r\n  // We don't preventDefault() here because that might kill scrolling or other behaviors,\r\n  // but since we excluded scrollable areas, we assume these are static HUD buttons.\r\n  // Actually, for instant response we usually DO prevent default to stop the emulation...\r\n  // but let's try just triggering the click.\r\n\r\n  // Actually, standard ghost tap pattern: prevent default to stop the emulation,\r\n  // then dispatch our own click.\r\n  if (event.cancelable) event.preventDefault();\r\n  buttonLike.click();\r\n}\r\n\r\nexport function initGlobalGhostTap() {\r\n  const doc = getDocument();\r\n  if (!doc || typeof window === 'undefined') return;\r\n\r\n  const hasPointer = 'PointerEvent' in window;\r\n  if (hasPointer) {\r\n    // capturing phase to intercept before internal UI logic\r\n    doc.addEventListener('pointerdown', handleInstantClick, { capture: false, passive: false });\r\n  } else if ('ontouchstart' in window) {\r\n    doc.addEventListener('touchstart', handleInstantClick, { capture: false, passive: false });\r\n  }\r\n}\r\n\r\nexport {\r\n  clearGhostTapTarget,\r\n  markGhostTapTarget,\r\n  shouldSkipGhostTap,\r\n  suppressNextGhostTap,\r\n  consumeGhostTapGuard,\r\n  DEFAULT_TIMEOUT_MS as GHOST_TAP_TIMEOUT_MS,\r\n};\r\n\r\nexport function setGhostTapSelector(extraSelector) {\r\n  if (!extraSelector) return;\r\n  selector = `${extraSelector}, ${TARGET_SELECTOR}`;\r\n}\r\n", "export const MERCHANT_DIALOGUES = {\r\n  0: {\r\n    start: 'n0',\r\n    nodes: {\r\n      n0: { type: 'line', say: 'So you want to delve deeper within my shop, do you?', next: 'c1' },\r\n\r\n      r_who: { type: 'line', say: 'I am the Merchant.', next: 'c2' },\r\n      r_where: { type: 'line', say: 'The Cove.',          next: 'c2' },\r\n      r_confused: { type: 'line', say: 'Okay.',                next: 'c2' },\r\n\r\n      c1: { type: 'choice', options: [\r\n        { label: 'Who are you?', to: 'r_who' },\r\n        { label: 'Where am I?', to: 'r_where' },\r\n        { label: 'I just clicked on this green button and now I\u2019m confused.', to: 'r_confused' },\r\n      ]},\r\n\r\n      c2: { type: 'choice', options: [\r\n        { label: 'What?', to: 'r2_what' }, \r\n        { label: 'That\u2019s not helpful.', to: 'r2_okay' }, \r\n        { label: 'Okay.', to: 'r2_okay' }, \r\n      ]},\r\n\r\n      r2_what: { type: 'line', say: 'What?', next: 'c3' },\r\n      r2_okay:   { type: 'line', say: 'Okay.',   next: 'c3' },\r\n\r\n      c3: { type: 'choice', options: [\r\n        { label: 'What?', to: 'r2_what' },\r\n        { label: 'That\u2019s not helpful.', to: 'r2_okay' },\r\n        { label: 'Goodbye.', to: 'end' },\r\n      ]},\r\n    }\r\n  },\r\n  1: {\r\n    start: 'n0',\r\n    nodes: {\r\n      n0: { type: 'line', say: 'Hello again.', next: 'c0' },\r\n\r\n      c0: { type: 'choice', options: [\r\n        { label: 'You never answered my questions.', to: 'm1a' },\r\n        { label: 'Hello.', to: 'm1b' },\r\n        { label: 'I am still very confused.', to: 'm1c' },\r\n      ]},\r\n\r\n      m1a: { type: 'line', say: 'Yes I did.', next: 'c1a' },\r\n      m1b: { type: 'line', say: 'Hello.',    next: 'c1b' },\r\n      m1c: { type: 'line', say: 'Okay.',       next: 'c1c' },\r\n\r\n      c1a: { type: 'choice', options: [\r\n        { label: 'No you didn\u2019t.', to: 'm1a' },\r\n        { label: 'Incorrect.',          to: 'm2a' },\r\n        { label: 'Okay I guess you\u2019re right.', to: 'm2b' },\r\n      ]},\r\n\r\n      c1b: { type: 'choice', options: [\r\n        { label: 'You never answered my questions.', to: 'm1a' },\r\n        { label: 'That does not help.',              to: 'm1c' },\r\n        { label: 'Okay.',                              to: 'm2b' },\r\n      ]},\r\n\r\n      c1c: { type: 'choice', options: [\r\n        { label: 'Yes.',  to: 'm2a' },\r\n        { label: 'Hmm\u2026',  to: 'm1c' },\r\n        { label: 'Okay.',   to: 'm2b' },\r\n      ]},\r\n\r\n      m2a: { type: 'line', say: 'No.', next: 'c1c' },\r\n      m2b: { type: 'line', say: 'Would you like some Coins? Free of charge. You look like you could use some right now.', next: 'c2a' },\r\n\r\n      c2a: { type: 'choice', options: [\r\n        { label: 'What?',                to: 'm3a' },\r\n        { label: 'No.',        to: 'm3b' },\r\n        { label: 'Give me the coins now.', to: 'end' },\r\n      ]},\r\n\r\n      m3a: { type: 'line', say: 'What?', next: 'c2a' },\r\n      m3b: { type: 'line', say: 'Okay, no Coins for you then.', next: 'c2b' },\r\n\r\n      c2b: { type: 'choice', options: [\r\n        { label: 'No wait, actually I want the coins. Give them to me now.', to: 'end' },\r\n        { label: 'On second thought, maybe I do want the coins. Give them to me now.', to: 'end' },\r\n        { label: 'Okay, bye, I don\u2019t need your filthy coins anyway.', to: 'end_nr' },\r\n      ]},\r\n    }\r\n  },\r\n  2: {\r\n    start: 'n0',\r\n    nodes: {\r\n      n0: { type: 'line', say: 'I see you\u2019ve unlocked the XP system.', next: 'c0' },\r\n\r\n      c0: { type: 'choice', options: [\r\n        { label: 'What does it do?',      to: 'm1a' },\r\n        { label: 'What does that mean?',  to: 'm1b' },\r\n        { label: 'Yes I did that.',       to: 'm1c' },\r\n      ]},\r\n\r\n      m1a: { type: 'line', say: 'The XP system is a powerful ancient mechanism, allowing for rapid influx of Coin output. Increasing your XP Level grants you Books infused with my power, capable of great things.', next: 'c1a' },\r\n      m1b: { type: 'line', say: 'It means you can grow passively stronger by collecting coins.', next: 'c1b' },\r\n      m1c: { type: 'line', say: 'And do you know how the XP system works?', next: 'c1c' },\r\n\r\n      c1a: { type: 'choice', options: [\r\n        { label: 'Why does this thing even exist?', to: 'm2b' },\r\n        { label: 'What does that mean?',                               to: 'm1b' },\r\n        { label: 'Okay.',                                              to: 'm3a' },\r\n      ]},\r\n      c1b: { type: 'choice', options: [\r\n        { label: 'Can you explain in more detail?', to: 'm1a' },\r\n        { label: 'Why?',                           to: 'm2c' },\r\n        { label: 'Okay.',                          to: 'm3a' },\r\n      ]},\r\n      c1c: { type: 'choice', options: [\r\n        { label: 'I have no idea.',              to: 'm1a' },\r\n        { label: 'I don\u2019t know the full details.', to: 'm1a' },\r\n        { label: 'Yes.',                         to: 'm3a' },\r\n      ]},\r\n\t  \r\n      m2b: { type: 'line', say: 'I dunno.', next: 'c2b' },\r\n      m2c: { type: 'line', say: 'Because I dunno.', next: 'c2c' },\r\n      m2d: { type: 'line', say: 'What?',    next: 'c2c' },\r\n      m2e: { type: 'line', say: 'I\u2019ve already told you, so you can increase your Coin output.', next: 'c2c' },\r\n      m2f: { type: 'line', say: 'Are you sure you don\u2019t want free Books?', next: 'c3a' },\r\n\r\n      c2a: { type: 'choice', options: [\r\n\t    { label: 'No.',                               to: 'm2f' },\r\n\t\t{ label: 'Why are you giving me all this free stuff?', to: 'm2e' },\r\n\t\t{ label: 'Yeah, sure.',                       to: 'end' },\r\n      ]},\r\n      c2b: { type: 'choice', options: [\r\n        { label: 'What?', to: 'm2d' },\r\n        { label: 'Why not?',  to: 'm2c' },\r\n        { label: '\u2026',     to: 'm3a' },\r\n      ]},\r\n      c2c: { type: 'choice', options: [\r\n        { label: '\u2026', to: 'm3a' },\r\n        { label: '\u2026', to: 'm3a' },\r\n        { label: '\u2026', to: 'm3a' },\r\n      ]},\r\n\r\n      m3a: { type: 'line', say: 'Would you like some Books, free of charge? They will help you accelerate your Coin output.', next: 'c2a' },\r\n\r\n      c3a: { type: 'choice', options: [\r\n        { label: 'Okay, actually give me the free stuff.',        to: 'end' },\r\n        { label: 'Okay fine, I\u2019ll take those books off your hands.', to: 'end' },\r\n        { label: 'I don\u2019t need your charity.',                    to: 'end_nr' },\r\n      ]},\r\n    }\r\n  },\r\n  3: {\r\n    start: 'n0',\r\n    nodes: {\r\n      n0:  { type: 'line', say: 'What do you want now?', next: 'c0' },\r\n\r\n      c0:  { type: 'choice', options: [\r\n        { label: 'I\u2019d like to ask some questions about how the forge works.',     to: 'm1a' },\r\n        { label: 'I\u2019d like to ask some questions about how mutations work.',      to: 'm1b' },\r\n        { label: 'Oh, um, I forgot.',                                             to: 'm1c' },\r\n      ]},\r\n\r\n      m1a: { type: 'line', say: 'Sure, ask me anything about the Forge and I will answer.',     next: 'c1a' },\r\n      m1b: { type: 'line', say: 'Sure, ask me anything about Mutations and I will answer.',     next: 'c1b' },\r\n      m1c: { type: 'line', say: '\u2026',                                                            next: 'c3a' },\r\n\r\n      c1a: { type: 'choice', options: [\r\n        { label: 'Where did it come from?',                       to: 'm2a' },\r\n        { label: 'How do I get more gold from it?',              to: 'm2b' },\r\n        { label: 'What is the benefit of forging my coins?',     to: 'm2c' },\r\n      ]},\r\n\r\n      c1b: { type: 'choice', options: [\r\n        { label: 'Why do they exist?',              to: 'm2d' },\r\n        { label: 'What do mutations do for me?',    to: 'm2e' },\r\n        { label: 'Why are they important at all?',  to: 'm2e' },\r\n      ]},\r\n\r\n      m2a: { type: 'line', say: 'I made it.', next: 'c2a' },\r\n      m2b: { type: 'line', say: 'Increase your Coins and XP Level to boost the output of the Forge.', next: 'c2b' },\r\n      m2c: { type: 'line', say: 'Trust me, it\u2019ll pay off in the future.', next: 'c2c' },\r\n      m2d: { type: 'line', say: 'They just do.', next: 'c3a' },\r\n      m2e: { type: 'line', say: 'Earn double Coin and XP output for each level of Mutation applied to a Coin.', next: 'c2d' },\r\n\r\n      c2a: { type: 'choice', options: [\r\n        { label: 'Really?', to: 'm3a' },\r\n        { label: 'Wow.',    to: 'm4a' },\r\n        { label: 'Okay.',   to: 'm4a' },\r\n      ]},\r\n\r\n      c2b: { type: 'choice', options: [\r\n        { label: 'What does \u201Cincrease\u201D mean?', to: 'm3b' },\r\n        { label: 'Why does it work like that?', to: 'm3c' },\r\n        { label: 'Okay.',                       to: 'm4a' },\r\n      ]},\r\n\r\n      c2c: { type: 'choice', options: [\r\n        { label: 'That didn\u2019t really answer my question.', to: 'm3d' },\r\n        { label: 'But how can you prove that?',            to: 'm3e' },\r\n        { label: 'Okay.',                                  to: 'm4a' },\r\n      ]},\r\n\r\n      c2d: { type: 'choice', options: [\r\n        { label: 'How will I know if a coin is mutated?', to: 'm3f' },\r\n        { label: 'That sounds cool.',                     to: 'm4a' },\r\n        { label: 'Okay.',                                 to: 'm4a' },\r\n      ]},\r\n\r\n      m3a: { type: 'line', say: 'Nope. I lied.', next: 'c3a' },\r\n      m3b: { type: 'line', say: 'Number goes up. You know how this works.', next: 'c3a' },\r\n      m3c: { type: 'line', say: 'It just does.', next: 'c3a' },\r\n      m3d: { type: 'line', say: 'Yes it did.', next: 'c3a' },\r\n      m3e: { type: 'line', say: 'Trust in the process.', next: 'c3a' },\r\n      m3f: { type: 'line', say: 'Each new mutation applied to a coin alters its appearance. It could be argued that each mutation is more visually striking than the previous.', next: 'c3b' },\r\n\r\n      c3a: { type: 'choice', options: [\r\n        { label: '\u2026', to: 'm4a' },\r\n        { label: '\u2026', to: 'm4a' },\r\n        { label: '\u2026', to: 'm4a' },\r\n      ]},\r\n\r\n      c3b: { type: 'choice', options: [\r\n        { label: 'Why does it work like that?', to: 'm4b' },\r\n        { label: 'Cool.',                       to: 'm4a' },\r\n        { label: 'Okay.',                       to: 'm4a' },\r\n      ]},\r\n\r\n      m4a: { type: 'line', say: 'Any more questions?', next: 'c4a' },\r\n      m4b: { type: 'line', say: 'It just does.', next: 'c3a' },\r\n\r\n      c4a: { type: 'choice', options: [\r\n        { label: 'I\u2019d like to learn more about the forge.',     to: 'm1a' },\r\n        { label: 'I\u2019d like to learn more about mutations.',     to: 'm1b' },\r\n        { label: 'I think I\u2019m good.',                           to: 'm5a' },\r\n      ]},\r\n\r\n      m5a: { type: 'line', say: 'Here, have some Gold. I\u2019m not even going to let you decline my gift.', next: 'c5a' },\r\n\r\n      c5a: { type: 'choice', options: [\r\n        { label: 'Oh, cool, thanks for the free stuff.',      to: 'end' },\r\n        { label: 'Okay, I\u2019ll put this gold to good use.',     to: 'end' },\r\n        { label: '\u2026',                                         to: 'end' },\r\n      ]},\r\n    }\r\n  },\r\n  4: {\r\n  start: 'n0',\r\n  nodes: {\r\n    n0: { type: 'line', say: 'I\u2019m sure you came to me to learn a few things about how my Magic works, is that correct?', next: 'c0' },\r\n\r\n    c0: { type: 'choice', options: [\r\n      { label: 'Yes, I\u2019d like to know more about your magic.', to: 'm1a' },\r\n      { label: 'Actually, I\u2019m more interested in how automation works.', to: 'm1b' },\r\n      { label: 'Nah just give me free stuff.', to: 'm1c' },\r\n    ]},\r\n\r\n    m1a: { type: 'line', say: 'What would you like to know?', next: 'c1a' },\r\n    m1b: { type: 'line', say: 'What would you like to know?', next: 'c1b' },\r\n    m1c: { type: 'line', say: '\u2026', next: 'c1c' },\r\n\r\n    c1a: { type: 'choice', options: [\r\n      { label: 'Why do you have magic powers?', to: 'm2a' },\r\n      { label: 'Where did you get magic powers from?', to: 'm2b' },\r\n      { label: 'If you have magic powers, why can\u2019t you just summon all the coins in the world?', to: 'm2c' },\r\n    ]},\r\n\r\n    c1b: { type: 'choice', options: [\r\n      { label: 'Why does it exist?',                    to: 'm2d' },\r\n      { label: 'What kinds of things can be automated?', to: 'm2e' },\r\n      { label: 'How is automation different from doing things manually?', to: 'm2f' },\r\n    ]},\r\n\r\n    c1c: { type: 'choice', options: [\r\n      { label: 'What?', to: 'm2g' },\r\n      { label: 'Come on, where\u2019s the reward at?', to: 'm2g' },\r\n      { label: 'Was it something I said?', to: 'm2h' },\r\n    ]},\r\n\r\n    m2a: { type: 'line', say: 'I just do.', next: 'c2a' },\r\n    m2b: { type: 'line', say: 'I\\'ve always had them.', next: 'c2b' },\r\n    m2c: { type: 'line', say: 'Because Coins are just built different like that.', next: 'c2c' },\r\n    m2d: { type: 'line', say: 'Because it\u2019s necessary to speed up Coin collection.', next: 'c2d' },\r\n    m2e: { type: 'line', say: 'Everything.', next: 'c2e' },\r\n    m2f: { type: 'line', say: 'It\u2019s just better. I don\u2019t have to explain why.', next: 'c2f' },\r\n    m2g: { type: 'line', say: 'Don\u2019t you want to chat with me for a bit? Don\u2019t you have some questions you want to ask me?', next: 'c2g' },\r\n    m2h: { type: 'line', say: 'Yes.', next: 'c2h' },\r\n\r\n    c2a: { type: 'choice', options: [\r\n      { label: 'What?', to: 'm3a' },\r\n      { label: 'Can you actually answer my question?', to: 'm3b' },\r\n      { label: '\u2026', to: 'm6a' },\r\n    ]},\r\n\r\n    c2b: { type: 'choice', options: [\r\n      { label: 'How long have you had them?', to: 'm3c' },\r\n      { label: 'What can your magic powers do?', to: 'm3d' },\r\n      { label: 'Okay.', to: 'm6a' },\r\n    ]},\r\n\r\n    c2c: { type: 'choice', options: [\r\n      { label: 'How so?', to: 'm3e' },\r\n      { label: 'Your powers must be super weak then.', to: 'm5a' },\r\n      { label: 'Understandable.', to: 'm6a' },\r\n    ]},\r\n\r\n    c2d: { type: 'choice', options: [\r\n      { label: 'What if I just don\u2019t buy any automation?', to: 'm3f' },\r\n      { label: 'How?',                                     to: 'm3g' },\r\n      { label: 'Okay.',                                    to: 'm6a' },\r\n    ]},\r\n\r\n    c2e: { type: 'choice', options: [\r\n      { label: 'Could I even automate talking to you?', to: 'm3h' },\r\n      { label: 'So like, eventually everything would be progressing on its own?', to: 'm3i' },\r\n      { label: 'Okay.', to: 'm6a' },\r\n    ]},\r\n\r\n    c2f: { type: 'choice', options: [\r\n      { label: 'Why should I buy automation if you can\u2019t even explain why it\u2019s better than doing things manually?', to: 'm3j' },\r\n      { label: 'But I wanted an explanation.', to: 'm5a' },\r\n      { label: 'Okay.', to: 'm6a' },\r\n    ]},\r\n\r\n    c2g: { type: 'choice', options: [\r\n      { label: 'No.', to: 'm7b' },\r\n      { label: 'Not really.', to: 'm7b' },\r\n      { label: 'My bad.', to: 'm5a' },\r\n    ]},\r\n\r\n    c2h: { type: 'choice', options: [\r\n      { label: '\u2026', to: 'm6a' },\r\n      { label: '\u2026', to: 'm6a' },\r\n      { label: 'Sorry, I just was in a hurry to get free stuff so I could get back to collecting coins.', to: 'm7a' },\r\n    ]},\r\n\r\n    m3a: { type: 'line', say: 'What?', next: 'c2a' },\r\n    m3b: { type: 'line', say: 'I just did answer your question.', next: 'c3a' },\r\n    m3c: { type: 'line', say: 'At least 3.', next: 'c3b' },\r\n    m3d: { type: 'line', say: 'My Magic can do a few things.', next: 'c3c' },\r\n    m3e: { type: 'line', say: 'They\u2019re just built different.', next: 'c5a' },\r\n    m3f: { type: 'line', say: 'Don\u2019t.', next: 'c5a' },\r\n    m3g: { type: 'line', say: 'Common sense.', next: 'c5a' },\r\n    m3h: { type: 'line', say: 'Wow, that\u2019s kind of hurtful. Also no.', next: 'c5a' },\r\n    m3i: { type: 'line', say: 'Yes.', next: 'c3d' },\r\n    m3j: { type: 'line', say: 'Because I said so, and I am always right.', next: 'c5a' },\r\n\r\n    c3a: { type: 'choice', options: [\r\n      { label: 'No you didn\u2019t.', to: 'm4a' },\r\n      { label: 'Why are you like this?', to: 'm4b' },\r\n      { label: '\u2026', to: 'm6a' },\r\n    ]},\r\n\r\n    c3b: { type: 'choice', options: [\r\n      { label: '3\u2026 what?', to: 'm4c' },\r\n      { label: 'Ah, I completely understand.', to: 'm6a' },\r\n      { label: 'Okay.', to: 'm6a' },\r\n    ]},\r\n\r\n    c3c: { type: 'choice', options: [\r\n      { label: 'Like\u2026?', to: 'm4d' },\r\n      { label: 'Understandable.', to: 'm6a' },\r\n      { label: '\u2026', to: 'm6a' },\r\n    ]},\r\n\r\n    c3d: { type: 'choice', options: [\r\n      { label: 'Wouldn\u2019t that get boring?', to: 'm4e' },\r\n      { label: 'That sounds nice.', to: 'm6a' },\r\n      { label: 'Okay.', to: 'm6a' },\r\n    ]},\r\n\r\n    m4a: { type: 'line', say: 'Yes I did.', next: 'c3a' },\r\n    m4b: { type: 'line', say: 'Like what?', next: 'c4a' },\r\n    m4c: { type: 'line', say: '3.', next: 'c5a' },\r\n    m4d: { type: 'line', say: 'Okay you caught me, I\u2019m actually a fraud, my Magic is fake, nothing is real, the Coins are made of plastic, the sky is a dome, my name\u2019s not even Merchant it\u2019s Jeff.', next: 'c4b' },\r\n    m4e: { type: 'line', say: 'No.', next: 'c5a' },\r\n\r\n    c4a: { type: 'choice', options: [\r\n      { label: 'Are you trying to be annoying on purpose?', to: 'm5a' },\r\n      { label: 'You\u2019re not being helpful.', to: 'm5a' },\r\n      { label: 'Nothing, nevermind\u2026', to: 'm6a' },\r\n    ]},\r\n\r\n    c4b: { type: 'choice', options: [\r\n      { label: '???', to: 'm6a' },\r\n      { label: '???', to: 'm6a' },\r\n      { label: '???', to: 'm6a' },\r\n    ]},\r\n\r\n    m5a: { type: 'line', say: '\u2026', next: 'c5a' },\r\n\r\n    c5a: { type: 'choice', options: [\r\n      { label: '\u2026', to: 'm6a' },\r\n      { label: '\u2026', to: 'm6a' },\r\n      { label: '\u2026', to: 'm6a' },\r\n    ]},\r\n\r\n    m6a: { type: 'line', say: 'Anything else you\u2019d like to know?', next: 'c6a' },\r\n\r\n    c6a: { type: 'choice', options: [\r\n      { label: 'Tell me some more stuff about how your magic works.', to: 'm1a' },\r\n      { label: 'Tell me some more stuff about how automation works.', to: 'm1b' },\r\n      { label: 'Do you have any goodies for me?', to: 'm7a' },\r\n    ]},\r\n\r\n    m7a: { type: 'line', say: '10 Magic, take it or leave it.', next: 'c7a' },\r\n    m7b: { type: 'line', say: 'Okay, now you\u2019re just being rude. Don\u2019t expect to get anything for free if you\u2019re rude.', next: 'c7b' },\r\n\r\n    c7a: { type: 'choice', options: [\r\n      { label: 'Hmm, a bit too low for my taste.', to: 'm7b' },\r\n      { label: 'I would\u2019ve liked more, but I\u2019ll take it.', to: 'end' },\r\n      { label: 'I\u2019ll take it.', to: 'end' },\r\n    ]},\r\n\r\n    c7b: { type: 'choice', options: [\r\n      { label: '\u2026', to: 'end_nr' },\r\n      { label: '\u2026', to: 'end_nr' },\r\n      { label: '\u2026', to: 'end_nr' },\r\n    ]},\r\n    }\r\n  },\r\n};\r\n", "\r\nconst TICK_RATE = 20;\r\nconst FIXED_STEP = 1 / TICK_RATE; // 0.05s\r\n\r\nconst tickListeners = new Set();\r\nlet rafId = null;\r\nlet paused = false;\r\nlet lastTime = 0;\r\nlet accumulator = 0;\r\n\r\nfunction loop(now) {\r\n  if (paused) {\r\n      lastTime = now;\r\n      rafId = requestAnimationFrame(loop);\r\n      return;\r\n  }\r\n  \r\n  if (!lastTime) lastTime = now;\r\n  let dt = (now - lastTime) / 1000;\r\n  lastTime = now;\r\n\r\n  // Clamp dt to avoid spiral of death if tab was backgrounded for a long time\r\n  // (Offline progress handles >1s usually, but we clamp here to be safe)\r\n  if (dt > 1.0) dt = 1.0; \r\n  if (dt < 0) dt = 0;\r\n  \r\n  accumulator += dt;\r\n\r\n  // Process fixed steps\r\n  while (accumulator >= FIXED_STEP) {\r\n    tickListeners.forEach(listener => {\r\n      try {\r\n        listener(FIXED_STEP);\r\n      } catch (e) {\r\n        console.error('Error in game tick listener:', e);\r\n      }\r\n    });\r\n    accumulator -= FIXED_STEP;\r\n  }\r\n\r\n  rafId = requestAnimationFrame(loop);\r\n}\r\n\r\nexport function pauseGameLoop() {\r\n  paused = true;\r\n}\r\n\r\nexport function resumeGameLoop() {\r\n  paused = false;\r\n  lastTime = performance.now();\r\n  accumulator = 0; // Reset accumulator on resume to avoid burst\r\n}\r\n\r\nexport function startGameLoop() {\r\n  if (rafId) return;\r\n  lastTime = performance.now();\r\n  accumulator = 0;\r\n  rafId = requestAnimationFrame(loop);\r\n}\r\n\r\nexport function stopGameLoop() {\r\n  if (rafId) {\r\n    cancelAnimationFrame(rafId);\r\n    rafId = null;\r\n  }\r\n}\r\n\r\nexport function registerTick(callback) {\r\n  if (typeof callback !== 'function') return () => {};\r\n  tickListeners.add(callback);\r\n  return () => {\r\n    tickListeners.delete(callback);\r\n  };\r\n}\r\n\r\nexport class RateAccumulator {\r\n  constructor(currencyKey, bankRef) {\r\n    this.currencyKey = currencyKey;\r\n    this.bank = bankRef || window.bank;\r\n    this.buffer = 0;\r\n  }\r\n\r\n  addRate(amountPerSecond) {\r\n    // This logic assumes 20 ticks per second (FIXED_STEP)\r\n    const perTick = amountPerSecond * FIXED_STEP;\r\n    this.buffer += perTick;\r\n\r\n    if (this.buffer >= 1) {\r\n      const whole = Math.floor(this.buffer);\r\n      this.buffer -= whole;\r\n      if (this.bank && this.bank[this.currencyKey]) {\r\n        this.bank[this.currencyKey].add(whole);\r\n      }\r\n    }\r\n  }\r\n}\r\n", "import { BigNum } from '../util/bigNum.js';\r\n\r\nexport const AUTOMATION_AREA_KEY = 'automation';\r\nexport const EFFECTIVE_AUTO_COLLECT_ID = 1;\r\nexport const AUTOBUY_COIN_UPGRADES_ID = 2;\r\nexport const AUTOBUY_BOOK_UPGRADES_ID = 3;\r\nexport const AUTOBUY_GOLD_UPGRADES_ID = 4;\r\nexport const AUTOBUY_MAGIC_UPGRADES_ID = 5;\r\nexport const AUTOBUY_WORKSHOP_LEVELS_ID = 6;\r\n\r\n// Maps an Automation Upgrade ID to the cost type it controls (Master Switch logic).\r\nexport const MASTER_AUTOBUY_IDS = {\r\n  [AUTOBUY_COIN_UPGRADES_ID]: 'coins',\r\n  [AUTOBUY_BOOK_UPGRADES_ID]: 'books',\r\n  [AUTOBUY_GOLD_UPGRADES_ID]: 'gold',\r\n  [AUTOBUY_MAGIC_UPGRADES_ID]: 'magic'\r\n};\r\n\r\nconst UPGRADE_DEFINITIONS = [\r\n  {\r\n    area: AUTOMATION_AREA_KEY,\r\n    id: EFFECTIVE_AUTO_COLLECT_ID,\r\n    title: 'Effective Auto-Collect',\r\n    desc: 'Generates the equivalent of picking up a Coin on an interval\\nEach level of this upgrade will reduce the generation interval\\nAs a bonus, anything passively generated accumulates offline',\r\n    icon: 'sc_upg_icons/effective_auto_collect.webp',\r\n    lvlCap: 20,\r\n    baseCost: 100,\r\n    costType: 'gears',\r\n    upgType: 'NM',\r\n    scaling: { ratio: 2 },\r\n    costAtLevel(level) {\r\n      const lvl = Math.max(0, Math.floor(Number(level) || 0));\r\n      const base = BigInt(100);\r\n      const pow = 2n ** BigInt(lvl);\r\n      return BigNum.fromAny((base * pow).toString());\r\n    },\r\n    effectSummary(level) {\r\n      const lvl = Math.max(0, Math.floor(Number(level) || 0));\r\n      if (lvl === 0) return 'Coin generation interval: None';\r\n      const intervalMs = Math.round(1000 / lvl);\r\n      return `Coin generation interval: ${intervalMs}ms`;\r\n    }\r\n  },\r\n  {\r\n    area: AUTOMATION_AREA_KEY,\r\n    id: AUTOBUY_COIN_UPGRADES_ID,\r\n    title: 'Autobuy Coin Upgrades',\r\n    desc: 'Automatically buys Coin upgrades, but with a twist:\\nAutobuys upgrades for free, as long as you can afford the cost\\nThis is how all future autobuyers will work',\r\n    icon: 'sc_upg_icons/coin_autobuy.webp',\r\n    lvlCap: 1,\r\n    baseCost: 1e6,\r\n    costType: 'gears',\r\n    upgType: 'NM',\r\n    costAtLevel() {\r\n      return BigNum.fromInt(1e6);\r\n    },\r\n    effectSummary() {\r\n      return null;\r\n    }\r\n  },\r\n  {\r\n    area: AUTOMATION_AREA_KEY,\r\n    id: AUTOBUY_BOOK_UPGRADES_ID,\r\n    title: 'Autobuy Book Upgrades',\r\n    desc: 'Automatically buys Book upgrades',\r\n    icon: 'sc_upg_icons/book_autobuy.webp',\r\n    lvlCap: 1,\r\n    baseCost: 1e9,\r\n    costType: 'gears',\r\n    upgType: 'NM',\r\n    costAtLevel() {\r\n      return BigNum.fromInt(1e9);\r\n    },\r\n    effectSummary() {\r\n      return null;\r\n    }\r\n  },\r\n  {\r\n    area: AUTOMATION_AREA_KEY,\r\n    id: AUTOBUY_GOLD_UPGRADES_ID,\r\n    title: 'Autobuy Gold Upgrades',\r\n    desc: 'Automatically buys Gold upgrades',\r\n    icon: 'sc_upg_icons/gold_autobuy.webp',\r\n    lvlCap: 1,\r\n    baseCost: 1e12,\r\n    costType: 'gears',\r\n    upgType: 'NM',\r\n    costAtLevel() {\r\n      return BigNum.fromAny('1e12');\r\n    },\r\n    effectSummary() {\r\n      return null;\r\n    }\r\n  },\r\n  {\r\n    area: AUTOMATION_AREA_KEY,\r\n    id: AUTOBUY_MAGIC_UPGRADES_ID,\r\n    title: 'Autobuy Magic Upgrades',\r\n    desc: 'Automatically buys Magic upgrades',\r\n    icon: 'sc_upg_icons/magic_autobuy.webp',\r\n    lvlCap: 1,\r\n    baseCost: 1e15,\r\n    costType: 'gears',\r\n    upgType: 'NM',\r\n    costAtLevel() {\r\n      return BigNum.fromAny('1e15');\r\n    },\r\n    effectSummary() {\r\n      return null;\r\n    }\r\n  },\r\n  {\r\n    area: AUTOMATION_AREA_KEY,\r\n    id: AUTOBUY_WORKSHOP_LEVELS_ID,\r\n    title: 'Autobuy Workshop Levels',\r\n    desc: 'Automatically buys Workshop Levels',\r\n    icon: 'sc_upg_icons/workshop_level_autobuy.webp',\r\n    lvlCap: 1,\r\n    baseCost: 1e18,\r\n    costType: 'gears',\r\n    upgType: 'NM',\r\n    costAtLevel() {\r\n      return BigNum.fromAny('1e18');\r\n    },\r\n    effectSummary() {\r\n      return null;\r\n    }\r\n  }\r\n];\r\n\r\nexport const REGISTRY = UPGRADE_DEFINITIONS.map(u => ({\r\n  ...u,\r\n  icon: `img/${(u.icon || '').replace(/^img\\//, '')}`\r\n}));\r\n", "// js/ui/merchantTabs/workshopTab.js\r\nimport { BigNum } from '../../util/bigNum.js';\r\nimport { formatNumber } from '../../util/numFormat.js';\r\nimport { bank, CURRENCIES, getActiveSlot } from '../../util/storage.js';\r\nimport { registerTick } from '../../game/gameLoop.js';\r\nimport { openShop, playPurchaseSfx } from '../shopOverlay.js';\r\nimport { hasDoneInfuseReset } from './resetTab.js';\r\nimport { bigNumFromLog10, getLevelNumber, approxLog10BigNum } from '../../game/upgrades.js';\r\nimport { IS_MOBILE } from '../../main.js';\r\nimport { AUTOMATION_AREA_KEY, AUTOBUY_WORKSHOP_LEVELS_ID } from '../../game/automationUpgrades.js';\r\n\r\nconst GEAR_ICON_SRC = 'img/currencies/gear/gear.webp';\r\nconst GEAR_HUD_ICON_SRC = 'img/currencies/gear/gear_plus_base.webp';\r\nconst COIN_ICON_SRC = 'img/currencies/coin/coin.webp';\r\n\r\nconst MAX_GEAR_DECORATIONS = 100;\r\n\r\nlet workshopEl = null;\r\nlet initialized = false;\r\nlet accumulatorBuffer = 0; \r\nlet currentGenerationLevel = BigNum.zero();\r\nlet lastSyncedLevel = -1;\r\nlet renderFrameId = null;\r\n\r\n// Upgrade Constants\r\nconst GENERATION_UPGRADE_BASE_COST_LOG = 12; // 1T = 1e12\r\nconst LOG10_2 = 0.3010299956639812; \r\n\r\n// Scaling Thresholds & Constants\r\nconst L1 = 1e6;\r\nconst L2 = 1e9;\r\nconst L3 = 1e12;\r\n\r\nconst BASE_MULT_LOG = 1; // log10(10)\r\nconst K_LIN = 0.001;\r\n\r\n// S3 Constants\r\nconst EXP_DIV_S3 = 1000;\r\nconst LOG_EXP_BASE_S3 = Math.log10(1.00001);\r\n\r\n// S4 Constants (Explosion)\r\nconst EXPLOSION_RATE = 2.3e-10;\r\n\r\n// Precomputed Constants\r\nconst LN10 = Math.log(10);\r\nconst INV_LN10 = 1 / LN10;\r\n\r\n// Helper Integrals\r\nfunction integralLogLin(x, k) {\r\n    if (x <= 0) return 0;\r\n    const term = 1 + k * x;\r\n    const val = (term * Math.log(term) - k * x) / k;\r\n    return val * INV_LN10;\r\n}\r\n\r\n// Lazy Caches\r\nlet CACHE_S1_END_LOG = null;\r\nlet CACHE_S2_END_LOG = null;\r\nlet CACHE_S3_END_LOG = null;\r\n\r\nexport function getGenerationLevelKey(slot) {\r\n  return `ccc:workshop:genLevel:${slot}`;\r\n}\r\n\r\nconst animatedGears = new Map(); \r\n\r\n// Config\r\nconst GEAR_SPEED = 67; \r\nconst GEAR_ROTATION_SPEED_BASE = 67; \r\nconst GEAR_ROTATION_VARIANCE = 67; \r\n\r\nfunction loadGenerationLevel() {\r\n  const slot = getActiveSlot();\r\n  if (!slot) return BigNum.zero();\r\n  const raw = localStorage.getItem(getGenerationLevelKey(slot));\r\n  if (!raw) return BigNum.zero();\r\n  \r\n  try {\r\n      // Handle both legacy \"123\" and new \"BN:...\" formats\r\n      if (raw.startsWith('BN:') || /infinity/i.test(raw)) {\r\n          return BigNum.fromStorage(raw);\r\n      }\r\n      return BigNum.fromAny(raw);\r\n  } catch {\r\n      return BigNum.zero();\r\n  }\r\n}\r\n\r\nfunction saveGenerationLevel(level) {\r\n  const slot = getActiveSlot();\r\n  if (!slot) return false;\r\n  const key = getGenerationLevelKey(slot);\r\n  \r\n  let valStr;\r\n  if (level instanceof BigNum) {\r\n      valStr = level.toStorage();\r\n  } else {\r\n      valStr = String(level);\r\n  }\r\n  \r\n  try {\r\n    localStorage.setItem(key, valStr);\r\n    if (typeof window !== 'undefined') {\r\n        window.dispatchEvent(new CustomEvent('workshop:change', { detail: { slot, level } }));\r\n    }\r\n  } catch {}\r\n  \r\n  let readBack = null;\r\n  try {\r\n    readBack = localStorage.getItem(key);\r\n  } catch {}\r\n  return readBack === valStr;\r\n}\r\n\r\nfunction calculateWorkshopCostLog(level) {\r\n    // Level is BigNum here, but for calculation we need primitive\r\n    if (level.isInfinite()) return Infinity;\r\n    \r\n    // Check if level is too large for JS numbers\r\n    // 9e15 is safe integer limit approx.\r\n    // If level > 9e15, cost is definitely infinity given the super-exponential scaling\r\n    if (level.cmp(9e15) > 0) return Infinity;\r\n    \r\n    // Convert to number for internal calc\r\n    let lvlNum = 0;\r\n    try {\r\n        const str = level.toPlainIntegerString();\r\n        lvlNum = parseFloat(str);\r\n    } catch {\r\n        return Infinity;\r\n    }\r\n    \r\n    if (lvlNum <= 0) return GENERATION_UPGRADE_BASE_COST_LOG;\r\n\r\n    // S1\r\n    if (lvlNum <= L1) {\r\n        return GENERATION_UPGRADE_BASE_COST_LOG + lvlNum * BASE_MULT_LOG;\r\n    }\r\n    \r\n    if (CACHE_S1_END_LOG === null) {\r\n        CACHE_S1_END_LOG = GENERATION_UPGRADE_BASE_COST_LOG + L1 * BASE_MULT_LOG;\r\n    }\r\n\r\n    // S2\r\n    const u = lvlNum - L1;\r\n    if (lvlNum <= L2) {\r\n        return CACHE_S1_END_LOG + u + integralLogLin(u, K_LIN);\r\n    }\r\n\r\n    if (CACHE_S2_END_LOG === null) {\r\n        const u2 = L2 - L1;\r\n        CACHE_S2_END_LOG = CACHE_S1_END_LOG + u2 + integralLogLin(u2, K_LIN);\r\n    }\r\n\r\n    // S3\r\n    const v = lvlNum - L2;\r\n    const u_at_L = lvlNum - L1;\r\n    const u_at_L2 = L2 - L1;\r\n    \r\n    // Delta S2 integral + S3 quadratic term\r\n    const s2_continuation = v + (integralLogLin(u_at_L, K_LIN) - integralLogLin(u_at_L2, K_LIN));\r\n    const C3 = LOG_EXP_BASE_S3 / EXP_DIV_S3;\r\n    const s3_extra = 0.5 * C3 * v * v;\r\n    \r\n    if (lvlNum <= L3) {\r\n        return CACHE_S2_END_LOG + s2_continuation + s3_extra;\r\n    }\r\n\r\n    if (CACHE_S3_END_LOG === null) {\r\n        const v3 = L3 - L2;\r\n        const u3 = L3 - L1;\r\n        const s2_cont_3 = v3 + (integralLogLin(u3, K_LIN) - integralLogLin(u_at_L2, K_LIN));\r\n        const s3_extra_3 = 0.5 * C3 * v3 * v3;\r\n        CACHE_S3_END_LOG = CACHE_S2_END_LOG + s2_cont_3 + s3_extra_3;\r\n    }\r\n    \r\n    // S4: Exponential Explosion\r\n    // logCost grows exponentially with level delta\r\n    const scalingExp = EXPLOSION_RATE * (lvlNum - L3);\r\n    // If scalingExp > 709, Math.exp overflows to Infinity.\r\n    if (scalingExp > 709) return Infinity; \r\n    \r\n    const result = CACHE_S3_END_LOG * Math.exp(scalingExp);\r\n    \r\n    // Hard Cap at BigNum limit (approx 1.8e308)\r\n    if (!Number.isFinite(result) || result > 1.79e308) return Infinity;\r\n    \r\n    return result;\r\n}\r\n\r\nexport function getGenerationUpgradeCost(level) {\r\n  let bnLevel = level;\r\n  if (!(level instanceof BigNum)) {\r\n      bnLevel = BigNum.fromAny(level);\r\n  }\r\n  \r\n  if (bnLevel.isInfinite()) return BigNum.fromAny('Infinity');\r\n  \r\n  const logCost = calculateWorkshopCostLog(bnLevel);\r\n  return bigNumFromLog10(logCost);\r\n}\r\n\r\nfunction getGearsPerSecond(level) {\r\n  let baseRate;\r\n  let bnLevel = level;\r\n  if (!(level instanceof BigNum)) {\r\n      bnLevel = BigNum.fromAny(level);\r\n  }\r\n\r\n  if (bnLevel.isZero()) {\r\n    baseRate = BigNum.fromInt(1);\r\n  } else if (bnLevel.isInfinite()) {\r\n    baseRate = BigNum.fromAny('Infinity');\r\n  } else {\r\n    // If level is huge, we can use mulDecimal(LOG10_2)\r\n    // level * 0.301... => log10(rate)\r\n    const logValue = bnLevel.mulDecimal(LOG10_2);\r\n    // bigNumFromLog10 expects a number if possible, or handles large numbers?\r\n    // bigNumFromLog10 impl in upgrades.js:\r\n    // export function bigNumFromLog10(logVal) {\r\n    //   if (logVal === Infinity) return BigNum.fromAny('Infinity');\r\n    //   if (logVal instanceof BigNum) { ... }\r\n    // We can pass BigNum to bigNumFromLog10 if the helper supports it.\r\n    // Assuming bigNumFromLog10 only takes numbers or BigNum:\r\n    \r\n    // Actually, bigNumFromLog10(logVal) implementation usually assumes number.\r\n    // If logValue is BigNum (because level was BigNum), we need to handle it.\r\n    // If level is < 1e15, we can use numbers.\r\n    // If level is massive, rate is massive.\r\n    \r\n    if (bnLevel.cmp(9e15) <= 0) {\r\n        // Safe to use standard number math\r\n        const lvlNum = Number(bnLevel.toString());\r\n        const logVal = lvlNum * LOG10_2;\r\n        baseRate = bigNumFromLog10(logVal);\r\n    } else {\r\n        // Level is huge. \r\n        // rate = 2^level = 10^(level * log10(2))\r\n        // exponent is level * 0.30103...\r\n        // e = level * 0.30103...\r\n        // Construct BigNum directly: 10^e\r\n        // BigNum constructor takes { base: e }\r\n        \r\n        // mulDecimal returns BigNum\r\n        const logExpBn = bnLevel.mulDecimal(LOG10_2);\r\n        \r\n        // If logExpBn is massive, it becomes the exponent 'e' of the new BigNum\r\n        // We need to extract the value from BigNum logExpBn to use as exponent.\r\n        \r\n        // BigNum structure: sig * 10^e\r\n        // We want 10^(logExpBn)\r\n        // This is effectively BigNum with e = logExpBn\r\n        \r\n        // We can use BigNum internal structure or fromStorage logic\r\n        // But BigNum 'e' is limited to ~1.8e308. \r\n        // If 'level' is ~1e308, then 'e' is ~3e307. This fits in 'e'.\r\n        // If 'level' is larger than 1.8e308 (BigNum max), then the result is infinite.\r\n        \r\n        if (logExpBn.cmp(Number.MAX_VALUE) >= 0) {\r\n            baseRate = BigNum.fromAny('Infinity');\r\n        } else {\r\n            // logExpBn is finite number (though represented as BigNum)\r\n            // Extract it.\r\n            // Since it's < Number.MAX_VALUE, we can convert to number safely?\r\n            // Wait, MAX_VALUE is 1.79e308.\r\n            // Number(bn) works if it fits.\r\n            // We can try conversion.\r\n            \r\n            try {\r\n                // Approximate for very large numbers\r\n                 const logExpVal = Number(logExpBn.toScientific(10));\r\n                 if (logExpVal === Infinity) {\r\n                     baseRate = BigNum.fromAny('Infinity');\r\n                 } else {\r\n                     baseRate = bigNumFromLog10(logExpVal);\r\n                 }\r\n            } catch {\r\n                baseRate = BigNum.fromAny('Infinity');\r\n            }\r\n        }\r\n    }\r\n  }\r\n  \r\n  const mult = bank?.gears?.mult?.get?.() ?? BigNum.fromInt(1);\r\n  return baseRate.mulBigNumInteger(mult);\r\n}\r\n\r\nfunction buyGenerationUpgrade() {\r\n  const cost = getGenerationUpgradeCost(currentGenerationLevel);\r\n  if (bank.coins.value.cmp(cost) < 0) return;\r\n  // currentGenerationLevel is BigNum\r\n  const nextLevel = currentGenerationLevel.add(1);\r\n  if (saveGenerationLevel(nextLevel)) {\r\n    currentGenerationLevel = nextLevel;\r\n    bank.coins.sub(cost);\r\n    updateWorkshopTab();\r\n    playPurchaseSfx();\r\n  }\r\n}\r\n\r\nfunction onTick() {\r\n  if (!hasDoneInfuseReset()) return;\r\n  const rateBn = getGearsPerSecond(currentGenerationLevel);\r\n  const perTick = rateBn.mulDecimal('0.05');\r\n  const whole = perTick.floorToInteger();\r\n  const hasWhole = !whole.isZero();\r\n  if (hasWhole) {\r\n      if (bank.gears) bank.gears.add(whole);\r\n  }\r\n  \r\n  // Accumulator logic only for small levels < 20\r\n  if (currentGenerationLevel.cmp(20) < 0) {\r\n      // Safe to convert to number\r\n      const lvlNum = Number(currentGenerationLevel.toPlainIntegerString());\r\n      const rateNum = Math.pow(2, lvlNum);\r\n      const perTickNum = rateNum / 20;\r\n      const wholeNum = Math.floor(perTickNum);\r\n      const frac = perTickNum - wholeNum;\r\n      accumulatorBuffer += frac;\r\n      if (accumulatorBuffer >= 1) {\r\n          const accWhole = Math.floor(accumulatorBuffer);\r\n          accumulatorBuffer -= accWhole;\r\n          if (bank.gears) bank.gears.add(accWhole);\r\n      }\r\n  } else {\r\n      accumulatorBuffer = 0;\r\n  }\r\n}\r\n\r\nfunction resetWorkshopState() {\r\n    if (bank.gears) bank.gears.set(0);\r\n    if (saveGenerationLevel(BigNum.zero())) {\r\n        currentGenerationLevel = BigNum.zero();\r\n    }\r\n    accumulatorBuffer = 0;\r\n    updateWorkshopTab();\r\n}\r\n\r\nfunction syncGearDecorations(container) {\r\n  if (!container) return;\r\n  let entry = animatedGears.get(container);\r\n  if (!entry) {\r\n    const rect = container.getBoundingClientRect();\r\n    entry = { gears: [], width: rect.width, height: rect.height, needsDistribution: !rect.width || !rect.height };\r\n    animatedGears.set(container, entry);\r\n  }\r\n  const rect = container.getBoundingClientRect();\r\n  if (rect.width > 0 && rect.height > 0) {\r\n    entry.width = rect.width;\r\n    entry.height = rect.height;\r\n  }\r\n  \r\n  // Cap at 100 gears, but handle BigNum level safely\r\n  let lvlNum = 0;\r\n  if (currentGenerationLevel.cmp(MAX_GEAR_DECORATIONS) > 0) {\r\n      lvlNum = MAX_GEAR_DECORATIONS;\r\n  } else {\r\n      lvlNum = Number(currentGenerationLevel.toPlainIntegerString());\r\n  }\r\n\r\n  const targetCount = Math.min(Math.floor(lvlNum), MAX_GEAR_DECORATIONS);\r\n  const gears = entry.gears;\r\n  while (gears.length < targetCount) {\r\n    const img = document.createElement('img');\r\n    img.src = GEAR_ICON_SRC;\r\n    img.classList.add('workshop-bg-gear');\r\n    img.alt = '';\r\n    img.setAttribute('aria-hidden', 'true');\r\n    const size = 32 + Math.random() * 48;\r\n    let x = 0;\r\n    let y = 0;\r\n    if (entry.width > 0 && entry.height > 0) {\r\n      x = Math.random() * (entry.width - size);\r\n      y = Math.random() * (entry.height - size);\r\n      if (x < 0) x = 0;\r\n      if (y < 0) y = 0;\r\n    } else {\r\n      entry.needsDistribution = true;\r\n    }\r\n    const angle = Math.random() * Math.PI * 2;\r\n    const dx = Math.cos(angle) * GEAR_SPEED;\r\n    const dy = Math.sin(angle) * GEAR_SPEED;\r\n    const rotation = Math.random() * 360;\r\n    const rotationSpeed = (Math.random() < 0.5 ? -1 : 1) * (GEAR_ROTATION_SPEED_BASE + Math.random() * GEAR_ROTATION_VARIANCE);\r\n    img.style.width = `${size}px`;\r\n    img.style.transform = `translate3d(${x}px, ${y}px, 0) rotate(${rotation}deg)`;\r\n    img.style.willChange = 'transform';\r\n    container.appendChild(img);\r\n    gears.push({ element: img, x, y, dx, dy, rotation, rotationSpeed, size });\r\n  }\r\n  while (gears.length > targetCount) {\r\n    const g = gears.pop();\r\n    if (g.element.parentNode) g.element.parentNode.removeChild(g.element);\r\n  }\r\n}\r\n\r\nfunction buildWorkshopUI(container) {\r\n  let descText = 'Click the big red button below to open the Automation Shop';\r\n  if (IS_MOBILE) {\r\n    const isLargeScreen = Math.max(window.innerWidth, window.innerHeight) >= 900;\r\n    descText = isLargeScreen \r\n      ? 'Tap the big red button below to open the Automation Shop'\r\n      : 'Tap the big red button below (scroll if needed) to open the Automation Shop';\r\n  }\r\n  container.innerHTML = `<div class=\"merchant-workshop\"><div class=\"workshop-side-col workshop-side-left\"></div><div class=\"workshop-center-col\"><div class=\"workshop-info-panel\"><div class=\"workshop-gear-hud\"><img src=\"${GEAR_HUD_ICON_SRC}\" class=\"workshop-gear-plus\" alt=\"Gears\"><div class=\"workshop-gear-bar\"><span data-workshop=\"gears-amount\" class=\"workshop-gear-amount\">0</span></div></div><div class=\"workshop-rate-display\"> (+<img src=\"${GEAR_ICON_SRC}\" class=\"workshop-rate-icon\" alt=\"\"><span><span data-workshop=\"gears-rate\">0</span>/sec)</span></div><div class=\"workshop-description\"> Spend Coins to increase your Workshop Level<br> Each increase of your Workshop Level will double the rate of Gear production<br>${descText}<br> Spend Gears in the Automation Shop to unlock powerful automation upgrades<br> Automation upgrades will never be reset by any reset layer </div></div><div class=\"workshop-doubler-panel\"><button class=\"workshop-upgrade-btn\" data-workshop=\"upgrade-gen\"><span class=\"workshop-upgrade-title\">Increase Workshop Level</span><span class=\"workshop-upgrade-cost\"> Cost: <img src=\"${COIN_ICON_SRC}\" class=\"workshop-upgrade-cost-icon\" alt=\"Coins\"><span data-workshop=\"upgrade-cost\">1T</span></span></button></div><button class=\"btn-automation-shop\">Automation</button></div><div class=\"workshop-side-col workshop-side-right\"></div></div>`;\r\n  const leftCol = container.querySelector('.workshop-side-left');\r\n  const rightCol = container.querySelector('.workshop-side-right');\r\n  const upgradeBtn = container.querySelector('[data-workshop=\"upgrade-gen\"]');\r\n  upgradeBtn.addEventListener('click', () => { buyGenerationUpgrade(); });\r\n  const automationBtn = container.querySelector('.btn-automation-shop');\r\n  automationBtn.addEventListener('click', () => { openShop('automation'); });\r\n  const syncLayout = () => {\r\n      const statsBtn = document.querySelector('.hud-bottom [data-btn=\"stats\"]');\r\n      if (statsBtn && automationBtn) {\r\n          const rect = statsBtn.getBoundingClientRect();\r\n          automationBtn.style.width = `${rect.width}px`;\r\n          automationBtn.style.height = `${rect.height}px`;\r\n          automationBtn.style.minWidth = '0';\r\n          automationBtn.style.maxWidth = 'none';\r\n      }\r\n      if (workshopEl && workshopEl.isConnected) {\r\n        const left = workshopEl.querySelector('.workshop-side-left');\r\n        const right = workshopEl.querySelector('.workshop-side-right');\r\n        const updateBounds = (col) => {\r\n           if (!col) return;\r\n           const entry = animatedGears.get(col);\r\n           if (entry) {\r\n             const rect = col.getBoundingClientRect();\r\n             entry.width = rect.width;\r\n             entry.height = rect.height;\r\n             if (entry.needsDistribution && entry.width > 0 && entry.height > 0) {\r\n                 entry.needsDistribution = false;\r\n                 for (const g of entry.gears) {\r\n                     g.x = Math.random() * (entry.width - g.size);\r\n                     if (g.x < 0) g.x = 0;\r\n                     g.y = Math.random() * (entry.height - g.size);\r\n                     if (g.y < 0) g.y = 0;\r\n                     g.element.style.transform = `translate3d(${g.x}px, ${g.y}px, 0) rotate(${g.rotation}deg)`;\r\n                 }\r\n             }\r\n           }\r\n        };\r\n        updateBounds(left);\r\n        updateBounds(right);\r\n      }\r\n  };\r\n  if (typeof ResizeObserver !== 'undefined') {\r\n      const ro = new ResizeObserver(syncLayout);\r\n      const hud = document.querySelector('.hud-bottom');\r\n      if (hud) ro.observe(hud);\r\n      if (leftCol) ro.observe(leftCol);\r\n      if (rightCol) ro.observe(rightCol);\r\n      window.addEventListener('resize', syncLayout);\r\n      requestAnimationFrame(syncLayout);\r\n  } else {\r\n      window.addEventListener('resize', syncLayout);\r\n      requestAnimationFrame(syncLayout);\r\n  }\r\n  if (typeof IntersectionObserver !== 'undefined') {\r\n      const visibilityObserver = new IntersectionObserver((entries) => {\r\n          for (const entry of entries) {\r\n              if (entry.isIntersecting) { startRenderLoop(); } else { stopRenderLoop(); }\r\n          }\r\n      }, { root: null, threshold: 0 });\r\n      visibilityObserver.observe(container);\r\n  }\r\n  workshopEl = container;\r\n}\r\n\r\nexport function updateWorkshopTab() {\r\n  if (!workshopEl) return;\r\n  const gearsAmountEl = workshopEl.querySelector('[data-workshop=\"gears-amount\"]');\r\n  const gearsRateEl = workshopEl.querySelector('[data-workshop=\"gears-rate\"]');\r\n  const upgradeCostEl = workshopEl.querySelector('[data-workshop=\"upgrade-cost\"]');\r\n  const upgradeBtn = workshopEl.querySelector('[data-workshop=\"upgrade-gen\"]');\r\n  const rateBn = getGearsPerSecond(currentGenerationLevel);\r\n  const cost = getGenerationUpgradeCost(currentGenerationLevel);\r\n  if (gearsAmountEl) gearsAmountEl.innerHTML = bank.gears.fmt(bank.gears.value);\r\n  if (gearsRateEl) gearsRateEl.innerHTML = formatNumber(rateBn);\r\n  if (upgradeCostEl) {\r\n      let label = 'Coins';\r\n      try {\r\n          const isOne = !cost.isInfinite() && cost.cmp(1) === 0;\r\n          label = isOne ? 'Coin' : 'Coins';\r\n      } catch {}\r\n      upgradeCostEl.innerHTML = `${formatNumber(cost)} ${label}`;\r\n  }\r\n  if (upgradeBtn) {\r\n    const canAfford = bank.coins.value.cmp(cost) >= 0;\r\n    upgradeBtn.disabled = !canAfford;\r\n    const autoLevel = getLevelNumber(AUTOMATION_AREA_KEY, AUTOBUY_WORKSHOP_LEVELS_ID);\r\n    let isAutomated = false;\r\n    if (autoLevel > 0) {\r\n        const slot = getActiveSlot();\r\n        const slotSuffix = slot != null ? `:${slot}` : '';\r\n        const key = `ccc:autobuy:${AUTOMATION_AREA_KEY}:${AUTOBUY_WORKSHOP_LEVELS_ID}${slotSuffix}`;\r\n        isAutomated = localStorage.getItem(key) !== '0';\r\n    }\r\n    if (isAutomated) upgradeBtn.classList.add('is-automated');\r\n    else upgradeBtn.classList.remove('is-automated');\r\n  }\r\n  \r\n  // Use toScientific for large level comparisons? or just check if it changed significantly\r\n  // For animations, we just need to know if it grew.\r\n  // Using toPlainIntegerString is risky if it's huge, but fine for checking floor change if we cache properly.\r\n  // Actually, we can just use the BigNum instance itself as a key if it's immutable, but it's not.\r\n  // We can format it to a string.\r\n  \r\n  let currentIntStr = '';\r\n  if (currentGenerationLevel.isInfinite()) currentIntStr = 'Infinity';\r\n  else currentIntStr = currentGenerationLevel.floorToInteger().toStorage(); // BN:18:sig:exp\r\n\r\n  if (currentIntStr !== lastSyncedLevel) {\r\n    lastSyncedLevel = currentIntStr;\r\n    const leftCol = workshopEl.querySelector('.workshop-side-left');\r\n    const rightCol = workshopEl.querySelector('.workshop-side-right');\r\n    if (leftCol) syncGearDecorations(leftCol);\r\n    if (rightCol) syncGearDecorations(rightCol);\r\n  }\r\n}\r\n\r\nfunction stopRenderLoop() {\r\n  if (renderFrameId) {\r\n    cancelAnimationFrame(renderFrameId);\r\n    renderFrameId = null;\r\n  }\r\n}\r\n\r\nlet lastRenderTime = 0;\r\nfunction startRenderLoop() {\r\n  if (renderFrameId) return;\r\n  lastRenderTime = 0;\r\n  const loop = (timestamp) => {\r\n    if (workshopEl && workshopEl.isConnected) {\r\n        const gearsAmountEl = workshopEl.querySelector('[data-workshop=\"gears-amount\"]');\r\n        if (gearsAmountEl) {\r\n             gearsAmountEl.innerHTML = bank.gears.fmt(bank.gears.value);\r\n        }\r\n        if (!lastRenderTime) lastRenderTime = timestamp;\r\n        let dt = (timestamp - lastRenderTime) / 1000;\r\n        lastRenderTime = timestamp;\r\n        if (dt > 0.1) dt = 0.1; \r\n        for (const [container, data] of animatedGears) {\r\n            if (!container.isConnected) continue;\r\n            const { gears, width, height } = data;\r\n            if (!width || !height) continue;\r\n            for (const g of gears) {\r\n                g.x += g.dx * dt;\r\n                g.y += g.dy * dt;\r\n                if (g.x < 0) { g.x = 0; g.dx = -g.dx; }\r\n                else if (g.x + g.size > width) { g.x = width - g.size; g.dx = -g.dx; }\r\n                if (g.y < 0) { g.y = 0; g.dy = -g.dy; }\r\n                else if (g.y + g.size > height) { g.y = height - g.size; g.dy = -g.dy; }\r\n                g.rotation += g.rotationSpeed * dt;\r\n                g.element.style.transform = `translate3d(${g.x}px, ${g.y}px, 0) rotate(${g.rotation}deg)`;\r\n            }\r\n        }\r\n    }\r\n    renderFrameId = requestAnimationFrame(loop);\r\n  };\r\n  renderFrameId = requestAnimationFrame(loop);\r\n}\r\n\r\nexport function initWorkshopSystem() {\r\n  if (initialized) return;\r\n  initialized = true;\r\n  currentGenerationLevel = loadGenerationLevel();\r\n  registerTick(onTick);\r\n  if (typeof window !== 'undefined') {\r\n      window.addEventListener('saveSlot:change', () => {\r\n          currentGenerationLevel = loadGenerationLevel();\r\n          accumulatorBuffer = 0;\r\n          if (!hasDoneInfuseReset()) { resetWorkshopState(); }\r\n          updateWorkshopTab();\r\n      });\r\n      window.addEventListener('currency:change', (e) => {\r\n          if (e.detail.key === CURRENCIES.COINS) { updateWorkshopTab(); }\r\n      });\r\n      window.addEventListener('currency:multiplier', (e) => {\r\n          if (e.detail.key === CURRENCIES.GEARS) { updateWorkshopTab(); }\r\n      });\r\n      window.addEventListener('debug:change', () => {\r\n          currentGenerationLevel = loadGenerationLevel();\r\n          updateWorkshopTab();\r\n      });\r\n      window.addEventListener('unlock:change', (e) => {\r\n         const detail = e.detail || {};\r\n         if (detail.key === 'infuse') { if (!hasDoneInfuseReset()) { resetWorkshopState(); } }\r\n      });\r\n  }\r\n}\r\n\r\nexport function initWorkshopTab(panelEl) {\r\n  initWorkshopSystem();\r\n  if (panelEl.__workshopInit) return;\r\n  panelEl.__workshopInit = true;\r\n  currentGenerationLevel = loadGenerationLevel();\r\n  animatedGears.clear();\r\n  lastSyncedLevel = -1;\r\n  buildWorkshopUI(panelEl);\r\n  if (typeof IntersectionObserver === 'undefined') { startRenderLoop(); }\r\n  if (!hasDoneInfuseReset()) { resetWorkshopState(); }\r\n  updateWorkshopTab();\r\n}\r\n\r\nexport function getGearsProductionRate() {\r\n  const level = loadGenerationLevel();\r\n  return getGearsPerSecond(level);\r\n}\r\n\r\nexport function performFreeGenerationUpgrade() {\r\n  // If user has infinite coins and cost is infinite, or coins are simply infinite, snap to infinity immediately if cost is also seemingly infinite\r\n  const coinsInf = bank.coins.value.isInfinite();\r\n  const currentCost = getGenerationUpgradeCost(currentGenerationLevel);\r\n  const costInf = currentCost.isInfinite();\r\n\r\n  if (coinsInf && costInf && !currentGenerationLevel.isInfinite()) {\r\n      currentGenerationLevel = BigNum.fromAny('Infinity');\r\n      saveGenerationLevel(currentGenerationLevel);\r\n      updateWorkshopTab();\r\n      return true;\r\n  }\r\n    \r\n  if (bank.coins.value.isZero()) return false;\r\n  let coinsLog = approxLog10BigNum(bank.coins.value);\r\n  if (!Number.isFinite(coinsLog)) {\r\n     if (bank.coins.value.inf) coinsLog = Infinity;\r\n     else return false;\r\n  }\r\n  \r\n  // calculateWorkshopCostLog now expects BigNum\r\n  if (calculateWorkshopCostLog(currentGenerationLevel) > coinsLog) return false;\r\n  \r\n  // We need to find the max affordable level.\r\n  // Since level is BigNum, we have to handle potentially huge ranges.\r\n  // But calculateWorkshopCostLog crashes if level > 1e15 or so.\r\n  // If coinsLog is Finite, then level MUST be < 1e15 roughly.\r\n  // So we can convert currentGenerationLevel to number for the search if it's small.\r\n  \r\n  if (currentGenerationLevel.cmp(9e15) > 0) return false; // Too big for normal logic, handled by Infinity check above\r\n  \r\n  let low = Number(currentGenerationLevel.toPlainIntegerString());\r\n  let high = 9e15; \r\n  if (coinsLog === Infinity) high = 9e15; \r\n\r\n  let best = low;\r\n  while (low <= high) {\r\n      const mid = Math.floor((low + high) / 2);\r\n      // mid is number, need to pass BigNum to calculator\r\n      if (calculateWorkshopCostLog(BigNum.fromInt(mid)) <= coinsLog) {\r\n          best = mid;\r\n          low = mid + 1;\r\n      } else {\r\n          high = mid - 1;\r\n      }\r\n  }\r\n  \r\n  let targetLevelVal = best + 1;\r\n  let targetLevel = BigNum.fromInt(targetLevelVal);\r\n\r\n  if (targetLevel.cmp(currentGenerationLevel) > 0) {\r\n    if (saveGenerationLevel(targetLevel)) {\r\n      currentGenerationLevel = targetLevel;\r\n      updateWorkshopTab();\r\n      return true;\r\n    }\r\n  }\r\n  return false;\r\n}\r\n", "// js/ui/merchantTabs/dlgTab.js\r\nimport {\r\n  bank,\r\n  getActiveSlot,\r\n  watchStorageKey,\r\n  primeStorageWatcherSnapshot,\r\n} from '../../util/storage.js';\r\nimport { BigNum } from '../../util/bigNum.js';\r\nimport { MERCHANT_DIALOGUES } from '../../misc/merchantDialogues.js';\r\nimport { getXpState, isXpSystemUnlocked } from '../../game/xpSystem.js';\r\nimport { initResetPanel, initResetSystem, updateResetPanel, isForgeUnlocked, hasDoneForgeReset, hasDoneInfuseReset } from './resetTab.js';\r\nimport { initWorkshopTab, updateWorkshopTab } from './workshopTab.js';\r\nimport { blockInteraction } from '../shopOverlay.js';\r\nimport {\r\n  shouldSkipGhostTap,\r\n  suppressNextGhostTap,\r\n} from '../../util/ghostTapGuard.js';\r\nimport { IS_MOBILE } from '../../main.js';\r\n\r\nfunction nowMs() {\r\n  if (typeof performance !== 'undefined' && typeof performance.now === 'function') {\r\n    return performance.now();\r\n  }\r\n  return Date.now();\r\n}\r\n\r\nconst MERCHANT_ICON_SRC = 'img/misc/merchant.webp';\r\nconst MERCHANT_MET_KEY_BASE  = 'ccc:merchantMet';\r\nconst MERCHANT_TAB_KEY_BASE  = 'ccc:merchantTab';\r\nexport const MERCHANT_DLG_STATE_KEY_BASE = 'ccc:merchant:dlgState';\r\nexport const MERCHANT_MET_EVENT = 'ccc:merchant:met';\r\nconst sk = (base) => `${base}:${getActiveSlot()}`;\r\n\r\nexport function hasMetMerchant() {\r\n  try {\r\n    return localStorage.getItem(sk(MERCHANT_MET_KEY_BASE)) === '1';\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\n\r\nconst JEFF_UNLOCK_KEY_BASE = 'ccc:unlock:jeff';\r\n\r\nexport function isJeffUnlocked() {\r\n  try {\r\n    return localStorage.getItem(sk(JEFF_UNLOCK_KEY_BASE)) === '1';\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\nexport function setJeffUnlocked(value) {\r\n  const slot = getActiveSlot();\r\n  if (slot == null) return;\r\n  const key = `${JEFF_UNLOCK_KEY_BASE}:${slot}`;\r\n  const normalized = !!value;\r\n  try {\r\n    localStorage.setItem(key, normalized ? '1' : '0');\r\n    updateMerchantNameInUI();\r\n  } catch {}\r\n}\r\n\r\nfunction getMerchantName() {\r\n  return isJeffUnlocked() ? 'Jeff' : 'Merchant';\r\n}\r\n\r\nfunction updateMerchantNameInUI() {\r\n  const name = getMerchantName();\r\n  \r\n  if (merchantOverlayEl) {\r\n    const modalNames = merchantOverlayEl.querySelectorAll('.merchant-firstchat:not(.merchant-firstchat--initial) .merchant-firstchat__header .name');\r\n    modalNames.forEach((modalName) => {\r\n      if (modalName && (modalName.textContent === 'Merchant' || modalName.textContent === 'Jeff')) {\r\n        modalName.textContent = name;\r\n      }\r\n    });\r\n  }\r\n}\r\n\r\n\r\nconst MERCHANT_TABS_DEF = [\r\n  { key: 'dialogue',  label: 'Dialogue', unlocked: true },\r\n  { key: 'reset',     label: 'Reset',    unlocked: false, lockedLabel: '???' },\r\n  { key: 'workshop',  label: 'Workshop', unlocked: false, lockedLabel: '???' },\r\n];\r\n\r\nconst merchantTabUnlockState = new Map([\r\n  ['dialogue', true],\r\n  ['reset', false],\r\n  ['workshop', false],\r\n]);\r\n\r\nconst REWARD_ICON_SRC = {\r\n  coins: 'img/currencies/coin/coin.webp',\r\n  books: 'img/currencies/book/book.webp',\r\n  gold: 'img/currencies/gold/gold.webp',\r\n  magic: 'img/currencies/magic/magic.webp',\r\n};\r\n\r\nconst MYSTERIOUS_ICON_SRC = 'img/misc/mysterious.webp';\r\nconst HIDDEN_DIALOGUE_TITLE = 'Hidden Dialogue';\r\nconst LOCKED_DIALOGUE_TITLE = 'Locked Dialogue';\r\nconst DEFAULT_MYSTERIOUS_BLURB = 'Hidden Dialogue';\r\nconst DEFAULT_LOCKED_BLURB = 'Locked';\r\nconst DEFAULT_LOCK_MESSAGE = 'Locked Dialogue';\r\nconst DIALOGUE_STATUS_ORDER = { locked: 0, mysterious: 1, unlocked: 2 };\r\nconst FORGE_COMPLETED_KEY_BASE = 'ccc:reset:forge:completed';\r\n\r\nconst HAS_POINTER_EVENTS = typeof window !== 'undefined' && 'PointerEvent' in window;\r\nconst HAS_TOUCH_EVENTS = !HAS_POINTER_EVENTS && typeof window !== 'undefined' && 'ontouchstart' in window;\r\n\r\nfunction bindRapidActivation(target, handler, { once = false } = {}) {\r\n  if (!target || typeof handler !== 'function') return () => {};\r\n  let used = false;\r\n  let pointerTriggered = false;\r\n  let activePointerId = null;\r\n\r\n  const run = (event) => {\r\n    if (once && used) return;\r\n    if (event?.type === 'click' && event.isTrusted && shouldSkipGhostTap(target)) {\r\n      event.preventDefault?.();\r\n      return;\r\n    }\r\n    // markGhostTapTarget removed - global handler manages clicks\r\n    used = once ? true : used;\r\n    Promise.resolve(handler(event)).catch((e) => console.error(e));\r\n    if (once) cleanup();\r\n  };\r\n\r\n  const resetPointerTrigger = () => {\r\n    pointerTriggered = false;\r\n    activePointerId = null;\r\n  };\r\n\r\n  const onClick = (event) => {\r\n    // Simplified logic: Allow synthetic events (from ghostTapGuard) to pass through.\r\n    // The previous check blocked them because pointerTriggered was true during the synthetic click\r\n    // (which happens inside the pointerdown event dispatch on touch devices).\r\n    if (pointerTriggered) {\r\n      resetPointerTrigger();\r\n    }\r\n    run(event);\r\n  };\r\n\r\nconst onPointerDown = (event) => {\r\n  if (event.pointerType === 'mouse') return;\r\n  if (typeof event.button === 'number' && event.button !== 0) return;\r\n  pointerTriggered = true;\r\n  activePointerId = typeof event.pointerId === 'number' ? event.pointerId : null;\r\n  suppressNextGhostTap(160);\r\n};\r\n\r\n  const onPointerUp = (event) => {\r\n    if (!pointerTriggered) return;\r\n    if (activePointerId != null && typeof event.pointerId === 'number' && event.pointerId !== activePointerId) {\r\n      return;\r\n    }\r\n    resetPointerTrigger();\r\n    // run(event) removed here to prevent double-firing if global handler also triggers click\r\n    // or if standard click follows. Let 'click' event handle execution.\r\n  };\r\n\r\n  const onPointerCancel = () => {\r\n    if (!pointerTriggered) return;\r\n    resetPointerTrigger();\r\n  };\r\n\r\nconst onTouchStart = (event) => {\r\n  pointerTriggered = true;\r\n  suppressNextGhostTap(160);\r\n};\r\n\r\n  const onTouchEnd = (event) => {\r\n    if (!pointerTriggered) return;\r\n    resetPointerTrigger();\r\n    // run(event) removed here as well\r\n  };\r\n\r\n  const onTouchCancel = () => {\r\n    if (!pointerTriggered) return;\r\n    resetPointerTrigger();\r\n  };\r\n\r\n  const cleanup = () => {\r\n    target.removeEventListener('click', onClick);\r\n    if (HAS_POINTER_EVENTS) {\r\n      target.removeEventListener('pointerdown', onPointerDown);\r\n      window.removeEventListener('pointerup', onPointerUp);\r\n      window.removeEventListener('pointercancel', onPointerCancel);\r\n    } else if (HAS_TOUCH_EVENTS) {\r\n      target.removeEventListener('touchstart', onTouchStart);\r\n      window.removeEventListener('touchend', onTouchEnd);\r\n      window.removeEventListener('touchcancel', onTouchCancel);\r\n    }\r\n  };\r\n\r\n  target.addEventListener('click', onClick);\r\n  \r\n  return () => { target.removeEventListener('click', onClick); };\r\n}\r\n\r\nfunction dialogueStatusRank(status) {\r\n  return DIALOGUE_STATUS_ORDER[status] ?? 0;\r\n}\r\n\r\nfunction snapshotLockDisplay(info) {\r\n  if (!info || typeof info !== 'object') return null;\r\n  return {\r\n    title: info.title ?? null,\r\n    blurb: info.blurb ?? null,\r\n    tooltip: info.tooltip ?? null,\r\n    message: info.message ?? null,\r\n    icon: info.icon ?? null,\r\n    headerTitle: info.headerTitle ?? null,\r\n    ariaLabel: info.ariaLabel ?? null,\r\n  };\r\n}\r\n\r\nfunction buildUnlockedDialogueInfo(meta) {\r\n  return {\r\n    status: 'unlocked',\r\n    unlocked: true,\r\n    title: meta.title,\r\n    blurb: meta.blurb,\r\n    tooltip: '',\r\n    message: '',\r\n    icon: null,\r\n    headerTitle: null,\r\n    ariaLabel: meta.title || 'Merchant dialogue',\r\n  };\r\n}\r\n\r\nlet progressEventsBound = false;\r\nlet merchantDlgWatcherInitialized = false;\r\nlet forgeUnlockListenerBound = false;\r\n\r\nfunction setMerchantTabUnlocked(key, unlocked) {\r\n  const def = MERCHANT_TABS_DEF.find(t => t.key === key);\r\n  if (!def) return;\r\n\r\n  const lockedLabel = def.lockedLabel || '???';\r\n  const normalized = !!unlocked;\r\n  merchantTabUnlockState.set(key, normalized);\r\n  def.unlocked = normalized;\r\n\r\n  const btn = merchantTabs.buttons[key];\r\n  if (btn) {\r\n    btn.disabled = !normalized;\r\n    btn.classList.toggle('is-locked', !normalized);\r\n    btn.textContent = normalized ? def.label : lockedLabel;\r\n    btn.title = normalized ? (def.label || 'Tab') : '???';\r\n  }\r\n\r\n  if (!normalized && merchantTabs.buttons[key]?.classList.contains('is-active')) {\r\n    selectMerchantTab('dialogue');\r\n  }\r\n}\r\n\r\nfunction syncForgeTabUnlockState() {\r\n  let unlocked = false;\r\n  try { unlocked = !!isForgeUnlocked?.(); }\r\n  catch {}\r\n  setMerchantTabUnlocked('reset', unlocked);\r\n}\r\n\r\nfunction syncWorkshopTabUnlockState() {\r\n  let unlocked = false;\r\n  try { unlocked = !!hasDoneInfuseReset?.(); }\r\n  catch {}\r\n  setMerchantTabUnlocked('workshop', unlocked);\r\n}\r\n\r\nlet merchantDlgWatcherSlot = null;\r\nlet merchantDlgWatcherCleanup = null;\r\n\r\nfunction bigNumToSafeInteger(value) {\r\n  if (value && typeof value === 'object') {\r\n    if (typeof value.toPlainIntegerString === 'function') {\r\n      try {\r\n        const plain = value.toPlainIntegerString();\r\n        if (plain != null) {\r\n          const parsed = Number.parseInt(plain, 10);\r\n          if (Number.isFinite(parsed)) return parsed;\r\n        }\r\n      } catch {}\r\n    }\r\n    if (typeof value.toString === 'function') {\r\n      try {\r\n        const str = value.toString();\r\n        if (str != null) {\r\n          const parsed = Number.parseInt(str, 10);\r\n          if (Number.isFinite(parsed)) return parsed;\r\n        }\r\n      } catch {}\r\n    }\r\n  }\r\n\r\n  const numeric = Number(value);\r\n  if (!Number.isFinite(numeric)) return 0;\r\n  if (numeric <= 0) return 0;\r\n  return Math.floor(numeric);\r\n}\r\n\r\nfunction getPlayerProgress() {\r\n  const progress = {\r\n    xpUnlocked: false,\r\n    xpLevel: 0,\r\n    hasForgeReset: false,\r\n  };\r\n\r\n  try {\r\n    progress.xpUnlocked = typeof isXpSystemUnlocked === 'function' && isXpSystemUnlocked();\r\n  } catch {\r\n    progress.xpUnlocked = false;\r\n  }\r\n\r\n  if (progress.xpUnlocked) {\r\n    try {\r\n      const state = typeof getXpState === 'function' ? getXpState() : null;\r\n      if (state && typeof state === 'object') {\r\n        progress.xpLevel = bigNumToSafeInteger(state.xpLevel);\r\n      }\r\n    } catch {\r\n      progress.xpLevel = 0;\r\n    }\r\n  }\r\n  \r\n  try {\r\n    progress.hasForgeReset = typeof hasDoneForgeReset === 'function' && hasDoneForgeReset();\r\n  } catch {\r\n    progress.hasForgeReset = false;\r\n  }\r\n\r\n  try {\r\n    progress.hasInfuseReset = typeof hasDoneInfuseReset === 'function' && hasDoneInfuseReset();\r\n  } catch {\r\n    progress.hasInfuseReset = false;\r\n  }\r\n  \r\n  return progress;\r\n}\r\n\r\nfunction resolveDialogueLock(meta, progress) {\r\n  let rawState;\r\n  try {\r\n    rawState = typeof meta.unlock === 'function' ? meta.unlock(progress) : true;\r\n  } catch {\r\n    rawState = false;\r\n  }\r\n\r\n  const rawObj = (rawState && typeof rawState === 'object') ? rawState : null;\r\n  let status = 'locked';\r\n\r\n  if (rawState === true) {\r\n    status = 'unlocked';\r\n  } else if (rawObj) {\r\n    const normalized = String(rawObj.status ?? '').toLowerCase();\r\n    if (normalized === 'unlocked' || rawObj.unlocked === true) {\r\n      status = 'unlocked';\r\n    } else if (normalized === 'mysterious') {\r\n      status = 'mysterious';\r\n    } else {\r\n      status = 'locked';\r\n    }\r\n  } else if (rawState === false || rawState == null) {\r\n    status = 'locked';\r\n  }\r\n\r\n  const info = {\r\n    status,\r\n    unlocked: status === 'unlocked',\r\n    title: status === 'unlocked' ? meta.title : '???',\r\n    blurb: status === 'unlocked'\r\n      ? meta.blurb\r\n      : (status === 'mysterious' ? DEFAULT_MYSTERIOUS_BLURB : DEFAULT_LOCKED_BLURB),\r\n    tooltip: '',\r\n    message: '',\r\n    icon: null,\r\n    headerTitle: null,\r\n    ariaLabel: '',\r\n  };\r\n\r\n  if (status === 'unlocked') {\r\n    info.ariaLabel = meta.title || 'Merchant dialogue';\r\n    return info;\r\n  }\r\n\r\ninfo.title = rawObj?.title ?? '???'\r\ninfo.blurb = rawObj?.requirement\r\n  ?? rawObj?.message\r\n  ?? rawObj?.tooltip\r\n  ?? (status === 'mysterious' ? DEFAULT_MYSTERIOUS_BLURB : DEFAULT_LOCKED_BLURB)\r\ninfo.tooltip = rawObj?.tooltip\r\n  ?? (status === 'locked' ? 'Locked Dialogue' : 'Hidden Dialogue');\r\n\r\ninfo.message = rawObj?.message ?? (status === 'mysterious' ? DEFAULT_LOCK_MESSAGE : '');\r\ninfo.icon = rawObj?.icon ?? (status === 'mysterious' ? MYSTERIOUS_ICON_SRC : null);\r\ninfo.headerTitle = rawObj?.headerTitle ?? (status === 'mysterious' ? HIDDEN_DIALOGUE_TITLE : LOCKED_DIALOGUE_TITLE);\r\ninfo.ariaLabel = rawObj?.ariaLabel ?? (status === 'mysterious'\r\n  ? 'Hidden merchant dialogue'\r\n  : 'Locked merchant dialogue');\r\n\r\n\r\n  return info;\r\n}\r\n\r\nfunction ensureProgressEvents() {\r\n  if (progressEventsBound) return;\r\n  progressEventsBound = true;\r\n\r\n  const handler = onProgressChanged;\r\n\r\n  if (typeof window !== 'undefined') {\r\n    window.addEventListener('xp:change', handler);\r\n    window.addEventListener('xp:unlock', handler);\r\n    window.addEventListener('forge:completed', (event) => {\r\n      const detailSlot = event?.detail?.slot;\r\n      if (detailSlot != null && detailSlot !== getActiveSlot()) return;\r\n      handler();\r\n    });\r\n  }\r\n\r\n  document.addEventListener('ccc:upgrades:changed', handler);\r\n\r\n  const slot = getActiveSlot();\r\n  if (slot != null) {\r\n    const key = `${FORGE_COMPLETED_KEY_BASE}:${slot}`;\r\n    watchStorageKey(key, { onChange: handler });\r\n  }\r\n}\r\n\r\nfunction onProgressChanged() {\r\n  renderDialogueList();\r\n}\r\n\r\nfunction completeDialogueOnce(id, meta) {\r\n  const state = loadDlgState();\r\n  const k = String(id);\r\n  const prev = state[k] || {};\r\n\r\n  if (meta.once && prev.claimed) return false;\r\n\r\n  prev.claimed = true;\r\n  state[k] = prev;\r\n  saveDlgState(state);\r\n\r\n  grantReward(meta.reward);\r\n  return true;\r\n}\r\n\r\n\r\nfunction grantReward(reward) {\r\n  if (!reward) return;\r\n\r\n  if (reward.type === 'coins') {\r\n    try {\r\n      bank.coins.add(reward.amount);\r\n    } catch (e) {\r\n      console.warn('Failed to grant coin reward:', reward, e);\r\n    }\r\n    return;\r\n  }\r\n\r\n  if (reward.type === 'books') {\r\n    try {\r\n      bank.books.addWithMultiplier?.(reward.amount) ?? bank.books.add(reward.amount);\r\n    } catch (e) {\r\n      console.warn('Failed to grant book reward:', reward, e);\r\n    }\r\n    return;\r\n  }\r\n\r\n  if (reward.type === 'gold') {\r\n    try {\r\n      bank.gold.add(reward.amount);\r\n    } catch (e) {\r\n      console.warn('Failed to grant gold reward:', reward, e);\r\n    }\r\n    return;\r\n  }\r\n\r\n  if (reward.type === 'magic') {\r\n    try {\r\n      bank.magic.add(reward.amount);\r\n    } catch (e) {\r\n      console.warn('Failed to grant magic reward:', reward, e);\r\n    }\r\n    return;\r\n  }\r\n\r\n  try {\r\n    window.dispatchEvent(new CustomEvent('merchantReward', { detail: reward }));\r\n  } catch {}\r\n}\r\n\r\nfunction rewardLabel(reward) {\r\n  if (!reward) return '';\r\n  if (reward.type === 'coins') return `Reward: ${reward.amount} coins`;\r\n  if (reward.type === 'books') return `Reward: ${reward.amount} Books`;\r\n  if (reward.type === 'gold')  return `Reward: ${reward.amount} Gold`;\r\n  return 'Reward available';\r\n}\r\n\r\nexport const DLG_CATALOG = {\r\n  1: {\r\n    title: 'A Generous Gift',\r\n    blurb: 'The Merchant is feeling extra nice today',\r\n    scriptId: 1,\r\n    reward: { type: 'coins', amount: 100 },\r\n    unlock: (progress) => true,\r\n    once: true,\r\n  },\r\n  2: {\r\n    title: 'A New Experience',\r\n    blurb: 'Discuss the XP system with the Merchant',\r\n    scriptId: 2,\r\n    reward: { type: 'books', amount: 5 },\r\n    once: true,\r\n    unlock: (progress) => {\r\n      if (!progress?.xpUnlocked) {\r\n        return {\r\n          status: 'mysterious',\r\n          requirement: 'Unlock the XP system to reveal this dialogue',\r\n          message: 'Unlock the XP system to reveal this dialogue',\r\n          icon: MYSTERIOUS_ICON_SRC,\r\n          headerTitle: HIDDEN_DIALOGUE_TITLE,\r\n          ariaLabel: 'Hidden merchant dialogue, unlock the XP system to reveal this dialogue',\r\n        };\r\n      }\r\n      return true;\r\n    },\r\n  },\r\n  3: {\r\n    title: 'A Golden Opportunity',\r\n    blurb: 'Ask the Merchant a few questions about the Forge',\r\n    scriptId: 3,\r\n    reward: { type: 'gold', amount: 10 },\r\n    once: true,\r\n    unlock: (progress) => {\r\n      if (progress?.hasForgeReset) {\r\n        return true;\r\n      }\r\n\r\n      if (!progress?.xpUnlocked || (progress?.xpLevel ?? 0) < 31) {\r\n        return {\r\n          status: 'locked',\r\n          title: '???',\r\n          blurb: DEFAULT_LOCKED_BLURB,\r\n          tooltip: 'Locked Dialogue',\r\n          ariaLabel: 'Locked Dialogue',\r\n        };\r\n      }\r\n\r\n      return {\r\n        status: 'mysterious',\r\n        requirement: 'Do a Forge reset to reveal this dialogue',\r\n        message: 'Do a Forge reset to reveal this dialogue',\r\n        icon: MYSTERIOUS_ICON_SRC,\r\n        headerTitle: HIDDEN_DIALOGUE_TITLE,\r\n        ariaLabel: 'Hidden merchant dialogue, do a Forge reset to reveal this dialogue',\r\n      };\r\n    },\r\n  },\r\n  4: {\r\n    title: 'A Magic Touch',\r\n    blurb: 'Learn about the Merchant\u2019s magical powers',\r\n    scriptId: 4,\r\n    reward: { type: 'magic', amount: 10 },\r\n    once: true,\r\n    unlock: (progress) => {\r\n      if (progress?.hasInfuseReset) return true;\r\n      if (!progress?.xpUnlocked || (progress?.xpLevel ?? 0) < 101) {\r\n        return {\r\n          status: 'locked',\r\n          title: '???',\r\n          blurb: 'Locked',\r\n          tooltip: 'Locked Dialogue',\r\n          ariaLabel: 'Locked Dialogue',\r\n        };\r\n      }\r\n      return {\r\n        status: 'mysterious',\r\n        requirement: 'Do an Infuse reset to reveal this dialogue',\r\n        message: 'Do an Infuse reset to reveal this dialogue',\r\n        icon: MYSTERIOUS_ICON_SRC,\r\n        headerTitle: HIDDEN_DIALOGUE_TITLE,\r\n        ariaLabel: 'Hidden merchant dialogue, do an Infuse reset to reveal this dialogue',\r\n      };\r\n    },\r\n  },\r\n};\r\n\r\nexport function loadDlgState() {\r\n  try { return JSON.parse(localStorage.getItem(sk(MERCHANT_DLG_STATE_KEY_BASE)) || '{}'); } catch { return {}; }\r\n}\r\n\r\nexport function saveDlgState(s) {\r\n  const key = sk(MERCHANT_DLG_STATE_KEY_BASE);\r\n  try {\r\n    const payload = JSON.stringify(s);\r\n    localStorage.setItem(key, payload);\r\n    try { primeStorageWatcherSnapshot(key, payload); } catch {}\r\n  } catch {}\r\n}\r\n\r\nfunction parseDlgStateRaw(raw) {\r\n  if (!raw) return {};\r\n  try { return JSON.parse(raw); } catch { return {}; }\r\n}\r\n\r\nfunction cleanupMerchantDlgStateWatcher() {\r\n  const stop = merchantDlgWatcherCleanup;\r\n  merchantDlgWatcherCleanup = null;\r\n  if (typeof stop === 'function') {\r\n    try { stop(); } catch {}\r\n  }\r\n}\r\n\r\nfunction handleMerchantDlgStateChange(_, meta = {}) {\r\n  if (!meta?.rawChanged) return;\r\n  renderDialogueList();\r\n}\r\n\r\nfunction bindMerchantDlgStateWatcherForSlot(slot) {\r\n  if (slot === merchantDlgWatcherSlot) return;\r\n  cleanupMerchantDlgStateWatcher();\r\n  merchantDlgWatcherSlot = slot ?? null;\r\n  if (slot == null) {\r\n    renderDialogueList();\r\n    return;\r\n  }\r\n  const storageKey = `${MERCHANT_DLG_STATE_KEY_BASE}:${slot}`;\r\n  merchantDlgWatcherCleanup = watchStorageKey(storageKey, {\r\n    parse: parseDlgStateRaw,\r\n    onChange: handleMerchantDlgStateChange,\r\n  });\r\n  try { primeStorageWatcherSnapshot(storageKey); } catch {}\r\n  renderDialogueList();\r\n}\r\n\r\nfunction ensureMerchantDlgStateWatcher() {\r\n  if (merchantDlgWatcherInitialized) {\r\n    bindMerchantDlgStateWatcherForSlot(getActiveSlot());\r\n    return;\r\n  }\r\n  merchantDlgWatcherInitialized = true;\r\n  bindMerchantDlgStateWatcherForSlot(getActiveSlot());\r\n  if (typeof window !== 'undefined') {\r\n    window.addEventListener('saveSlot:change', () => {\r\n      bindMerchantDlgStateWatcherForSlot(getActiveSlot());\r\n    });\r\n  }\r\n}\r\n\r\nensureMerchantDlgStateWatcher();\r\n\r\n// ----- Module state -----\r\nlet merchantOverlayEl = null;\r\nlet merchantSheetEl   = null;\r\nlet merchantCloseBtn  = null;\r\nlet merchantOpen      = false;\r\nlet merchantDrag      = null;\r\nlet merchantLastFocus = null;\r\nlet merchantEventsBound = false;\r\nlet merchantTabs = { buttons: {}, panels: {}, tablist: null };\r\n\r\n// ========================= Typing SFX (WebAudio, zero-latency, mobile volume) =========================\r\nconst TYPING_SFX_SOURCE = ['sounds/merchant_typing.ogg']; // ensure this asset exists\r\n\r\nlet __audioCtx = null;\r\nlet __typingGain = null;\r\nlet __typingBuffer = null;     // decoded buffer (once)\r\nlet __bufferLoadPromise = null;\r\n\r\nlet __typingSfx = null;        // fallback <audio> element\r\nlet __typingSource = null;     // MediaElementSource (once)\r\nlet __bufferSource = null;     // current BufferSource (recreated each start)\r\n\r\nlet __typingSfxPrimed = false;\r\nlet __isTypingActive  = false;\r\n\r\nfunction ensureAudioCtx() {\r\n  if (!__audioCtx) {\r\n    const Ctx = window.AudioContext || window.webkitAudioContext;\r\n    __audioCtx = new Ctx();\r\n  }\r\n  if (!__typingGain) {\r\n    __typingGain = __audioCtx.createGain();\r\n    __typingGain.gain.value = IS_MOBILE ? 0.15 : 0.3;  // mobile quieter\r\n    __typingGain.connect(__audioCtx.destination);\r\n  }\r\n}\r\n\r\nfunction pickSupportedSrc() { return TYPING_SFX_SOURCE[0]; }\r\n\r\nasync function loadTypingBuffer() {\r\n  ensureAudioCtx();\r\n  if (__typingBuffer) return __typingBuffer;\r\n  if (__bufferLoadPromise) return __bufferLoadPromise;\r\n\r\n  const url = pickSupportedSrc();\r\n  __bufferLoadPromise = (async () => {\r\n    const res = await fetch(url, { cache: 'force-cache' });\r\n    const arr = await res.arrayBuffer();\r\n    return await __audioCtx.decodeAudioData(arr);\r\n  })()\r\n  .then(buf => (__typingBuffer = buf))\r\n  .catch(err => { console.warn('Typing SFX decode failed:', err); __bufferLoadPromise = null; });\r\n\r\n  return __bufferLoadPromise;\r\n}\r\n\r\nfunction ensureTypingAudioElement() {\r\n  if (__typingSfx) return __typingSfx;\r\n  const a = new Audio();\r\n  a.loop = true;\r\n  a.preload = 'auto';\r\n  a.muted = false;\r\n  a.volume = 1.0; // iOS ignores this; gain node controls volume\r\n\r\n  const url = pickSupportedSrc();\r\n  a.src = url;\r\n\r\n  __typingSfx = a;\r\n  return a;\r\n}\r\n\r\nfunction ensureElementGraph() {\r\n  ensureAudioCtx();\r\n  ensureTypingAudioElement();\r\n  if (!__typingSource) {\r\n    __typingSource = __audioCtx.createMediaElementSource(__typingSfx);\r\n    __typingSource.connect(__typingGain);\r\n  }\r\n}\r\n\r\nexport function setTypingGainForDevice() {\r\n  if (!__typingGain) return;\r\n  __typingGain.gain.value = IS_MOBILE ? 0.15 : 0.3;\r\n}\r\n\r\n// Prime from a user gesture \u2014 silent, no AbortError spam\r\nexport function primeTypingSfx() {\r\n  if (__typingSfxPrimed) return;\r\n  __typingSfxPrimed = true;\r\n\r\n  ensureAudioCtx();\r\n  __audioCtx.resume().catch(()=>{});\r\n\r\n  // Kick off buffer decode early\r\n  loadTypingBuffer();\r\n\r\n  // Satisfy autoplay policies silently via element path\r\n  const a = ensureTypingAudioElement();\r\n  ensureElementGraph();\r\n\r\n  const prevLoop = a.loop;\r\n  const prevMuted = a.muted;\r\n  a.loop = false;\r\n  a.muted = true;\r\n\r\n  a.play()\r\n    .then(() => { a.pause(); a.currentTime = 0; })\r\n    .catch((err) => {\r\n      if (err.name !== 'AbortError') {\r\n        console.warn('Typing SFX prime error:', err);\r\n        __typingSfxPrimed = false;\r\n      }\r\n    })\r\n    .finally(() => { a.loop = prevLoop; a.muted = prevMuted; });\r\n}\r\n\r\nasync function startTypingSfx() {\r\n  ensureAudioCtx();\r\n  await __audioCtx.resume().catch(()=>{});\r\n\r\n  await loadTypingBuffer();\r\n\r\n  // Prefer zero-latency buffer path\r\n  if (__isTypingActive && __typingBuffer) {\r\n    if (__bufferSource) {\r\n      try { __bufferSource.stop(0); } catch {}\r\n      try { __bufferSource.disconnect(); } catch {}\r\n      __bufferSource = null;\r\n    }\r\n    __bufferSource = __audioCtx.createBufferSource();\r\n    __bufferSource.buffer = __typingBuffer;\r\n    __bufferSource.loop = true;\r\n    __bufferSource.connect(__typingGain);\r\n    __bufferSource.start(0);\r\n    return;\r\n  }\r\n\r\n  // Fallback element path (rare first-line race)\r\n  ensureElementGraph();\r\n  if (__isTypingActive && __typingSfx) {\r\n    __typingSfx.currentTime = 0;\r\n    try { await __typingSfx.play(); }\r\n    catch {\r\n      const once = () => { if (__isTypingActive) __typingSfx.play().catch(()=>{}); document.removeEventListener('click', once); };\r\n      document.addEventListener('click', once, { once: true });\r\n    }\r\n  }\r\n}\r\n\r\nfunction stopTypingSfx() {\r\n  if (__bufferSource) {\r\n    try { __bufferSource.stop(0); } catch {}\r\n    try { __bufferSource.disconnect(); } catch {}\r\n    __bufferSource = null;\r\n  }\r\n  if (__typingSfx) {\r\n    __typingSfx.pause();\r\n    __typingSfx.currentTime = 0;\r\n  }\r\n}\r\n\r\n// Keep gain correct if device/orientation changes\r\nwindow.matchMedia?.('(any-pointer: coarse)')?.addEventListener?.('change', setTypingGainForDevice);\r\nwindow.addEventListener('orientationchange', setTypingGainForDevice);\r\n\r\n// ========================= Typewriter =========================\r\nfunction typeText(el, full, msPerChar = 22, skipTargets = []) {\r\n  return new Promise((resolve) => {\r\n    let i = 0, skipping = false;\r\n    let armed = false;\r\n\r\n    __isTypingActive = true;\r\n    startTypingSfx();\r\n\r\n    const skip = (e) => { if (!armed) return; e.preventDefault(); skipping = true; };\r\n    const onKey = (e) => { if (!armed) return; if (e.key === 'Enter' || e.key === ' ') skipping = true; };\r\n\r\n    const targets = skipTargets.length ? skipTargets : [el];\r\n\r\n    requestAnimationFrame(() => {\r\n      armed = true;\r\n      targets.forEach(t => t.addEventListener('click', skip, { once: true }));\r\n      document.addEventListener('keydown', onKey, { once: true });\r\n    });\r\n\r\n    el.classList.add('is-typing');\r\n    el.textContent = '';\r\n\r\n    const cleanup = () => {\r\n      targets.forEach(t => t.removeEventListener('click', skip));\r\n      document.removeEventListener('keydown', onKey);\r\n      el.classList.remove('is-typing');\r\n      stopTypingSfx();\r\n      __isTypingActive = false;\r\n    };\r\n\r\n    const tick = () => {\r\n      if (skipping) { el.textContent = full; cleanup(); resolve(); return; }\r\n      el.textContent = full.slice(0, i++);\r\n      if (i <= full.length) setTimeout(tick, msPerChar);\r\n      else { cleanup(); resolve(); }\r\n    };\r\n    tick();\r\n  });\r\n}\r\n\r\n// ========================= DialogueEngine =========================\r\nclass DialogueEngine {\r\n  constructor({ textEl, choicesEl, skipTargets, onEnd, onChoice }) {\r\n    this.textEl = textEl;\r\n    this.choicesEl = choicesEl;\r\n    this.skipTargets = skipTargets;\r\n    this.onEnd = onEnd || (() => {});\r\n    this.onChoice = onChoice;\r\n    this.nodes = {};\r\n    this.current = null;\r\n\r\n    this.deferNextChoices = false;\r\n    this._reservedH = 0;\r\n  }\r\n\r\n  load(script) {\r\n    this.nodes = script.nodes || {};\r\n    this.startId = script.start;\r\n  }\r\n\r\n  async start() {\r\n    if (!this.startId) return;\r\n    await this.goto(this.startId);\r\n  }\r\n\r\n  async goto(id) {\r\n    const node = this.nodes[id];\r\n    if (!node) return;\r\n    this.current = id;\r\n\r\n    if (node.type === 'line') {\r\n      const nextNode = this.nodes[node.next];\r\n\r\n      // Pre-render next choices invisibly to reserve height (unless deferring)\r\n      if (!this.deferNextChoices && nextNode && nextNode.type === 'choice') {\r\n        this._renderChoices(nextNode.options || [], true);\r\n      } else {\r\n        this._hideChoices();\r\n      }\r\n\r\n      await typeText(this.textEl, node.say, node.msPerChar ?? 22, this.skipTargets);\r\n\r\n      if (nextNode && nextNode.type === 'choice') {\r\n        this.current = node.next;\r\n\r\n        if (this.deferNextChoices) {\r\n          this.deferNextChoices = false;\r\n          this._renderChoices(nextNode.options || [], false); // build & reveal now\r\n          this.choicesEl.style.minHeight = '';\r\n          return;\r\n        }\r\n\r\n        this._revealPreparedChoices();\r\n        return;\r\n      }\r\n\r\n      this.choicesEl.style.minHeight = '';\r\n      if (node.next === 'end' || node.end === true) return this.onEnd();\r\n      if (node.next) return this.goto(node.next);\r\n      return;\r\n    }\r\n\r\n    if (node.type === 'choice') {\r\n      this._renderChoices(node.options || [], false);\r\n    }\r\n  }\r\n\r\n  _hideChoices() {\r\n    this.choicesEl.classList.remove('is-visible');\r\n    this._applyInlineChoiceHide();\r\n  }\r\n\r\n  _renderChoices(options, prepare = false) {\r\n    this.choicesEl.innerHTML = '';\r\n    for (const opt of options) {\r\n      const btn = document.createElement('button');\r\n      btn.type = 'button';\r\n      btn.className = 'choice';\r\n      btn.textContent = opt.label;\r\n      const unbind = bindRapidActivation(btn, async (event) => {\r\n        event?.stopPropagation?.();\r\n        this.onChoice?.(this.current, opt);\r\n        this._reservedH = this.choicesEl.offsetHeight | 0;\r\n        this.choicesEl.style.minHeight = this._reservedH + 'px';\r\n        this._hideChoices();\r\n        this.choicesEl.innerHTML = '';\r\n\r\n        this.deferNextChoices = true;\r\n\r\n        if (opt.to === 'end') {\r\n          return this.onEnd({ noReward: false });\r\n        }\r\n        if (opt.to === 'end_nr') {\r\n          return this.onEnd({ noReward: true });\r\n        }\r\n\r\n        await this.goto(opt.to);\r\n      }, { once: true });\r\n      this.choicesEl.appendChild(btn);\r\n    }\r\n\r\n    if (prepare) {\r\n      this.choicesEl.classList.remove('is-visible');\r\n      this._applyInlineChoiceHide();\r\n      return;\r\n    }\r\n    this._clearInlineChoiceHide();\r\n    requestAnimationFrame(() => this.choicesEl.classList.add('is-visible'));\r\n  }\r\n\r\n  _revealPreparedChoices() {\r\n    this._clearInlineChoiceHide();\r\n    requestAnimationFrame(() => this.choicesEl.classList.add('is-visible'));\r\n  }\r\n\r\n  _applyInlineChoiceHide() {\r\n    this.choicesEl.style.opacity = '0';\r\n    this.choicesEl.style.transform = 'translateY(6px)';\r\n    this.choicesEl.style.pointerEvents = 'none';\r\n  }\r\n\r\n  _clearInlineChoiceHide() {\r\n    this.choicesEl.style.opacity = '';\r\n    this.choicesEl.style.transform = '';\r\n    this.choicesEl.style.pointerEvents = '';\r\n  }\r\n}\r\n\r\nfunction openDialogueLockInfo(lockInfo = {}) {\r\n  if (!merchantOverlayEl) return;\r\n\r\n  primeTypingSfx();\r\n\r\n  const overlay = document.createElement('div');\r\n  overlay.className = 'merchant-firstchat merchant-lockinfo';\r\n  overlay.setAttribute('data-dismissible', '1');\r\n  overlay.innerHTML = `<div class=\"merchant-firstchat__card\" role=\"dialog\" aria-label=\"${lockInfo.ariaLabel || HIDDEN_DIALOGUE_TITLE}\"><div class=\"merchant-firstchat__header\"><div class=\"name\"></div><div class=\"rule\" aria-hidden=\"true\"></div></div><div class=\"merchant-firstchat__row merchant-lockinfo__row\"><img class=\"merchant-firstchat__icon\" src=\"${lockInfo.icon || MYSTERIOUS_ICON_SRC}\" alt=\"\"><div class=\"merchant-firstchat__text merchant-lockinfo__message\"></div></div><div class=\"merchant-firstchat__actions merchant-lockinfo__actions\"><button type=\"button\" class=\"merchant-firstchat__continue merchant-lockinfo__close\">Close</button></div></div>`;\r\n\r\n  merchantOverlayEl.appendChild(overlay);\r\n\r\n  const cardEl = overlay.querySelector('.merchant-firstchat__card');\r\n  const nameEl = overlay.querySelector('.merchant-firstchat__header .name');\r\n  const messageEl = overlay.querySelector('.merchant-lockinfo__message');\r\n  const closeBtn = overlay.querySelector('.merchant-lockinfo__close');\r\n\r\n  nameEl.textContent = lockInfo.headerTitle || HIDDEN_DIALOGUE_TITLE;\r\n  messageEl.textContent = lockInfo.message || DEFAULT_LOCK_MESSAGE;\r\n\r\n  requestAnimationFrame(() => overlay.classList.add('is-visible'));\r\n  merchantOverlayEl.classList.add('firstchat-active');\r\n\r\n  let closed = false;\r\n\r\n  const close = () => {\r\n    if (closed) return;\r\n    closed = true;\r\n    overlay.classList.remove('is-visible');\r\n    merchantOverlayEl.classList.remove('firstchat-active');\r\n    stopTypingSfx();\r\n    __isTypingActive = false;\r\n    document.removeEventListener('keydown', onEsc, true);\r\n    setTimeout(() => overlay.remove(), 160);\r\n  };\r\n\r\n  const onEsc = (e) => {\r\n    if (e.key !== 'Escape') return;\r\n    e.preventDefault();\r\n    close();\r\n  };\r\n\r\n  document.addEventListener('keydown', onEsc, true);\r\n\r\noverlay.addEventListener('pointerdown', (e) => {\r\n  if (!cardEl.contains(e.target)) {\r\n    // Don\u2019t arm global ghost guard for background taps \u2014 just shield briefly\r\n    e.preventDefault();\r\n    blockInteraction(160);\r\n    close();\r\n  }\r\n});\r\n\r\nconst doCloseFromBtn = (e) => {\r\n  if (!e || e.pointerType !== 'mouse') blockInteraction(160);\r\n  close();\r\n};\r\n\r\n  bindRapidActivation(closeBtn, () => { doCloseFromBtn(); }, { once: true });\r\n\r\n  closeBtn.focus?.();\r\n}\r\n\r\nfunction openDialogueModal(id, meta) {\r\n  primeTypingSfx();\r\n\r\n  const overlay = document.createElement('div');\r\n  overlay.className = 'merchant-firstchat';\r\n  overlay.setAttribute('data-dismissible', '1');\r\n  overlay.innerHTML = `<div class=\"merchant-firstchat__card\" role=\"dialog\" aria-label=\"${meta.title}\"><div class=\"merchant-firstchat__header\"><div class=\"name\">${getMerchantName()}</div><div class=\"rule\" aria-hidden=\"true\"></div></div><div class=\"merchant-firstchat__row\"><img class=\"merchant-firstchat__icon\" src=\"${MERCHANT_ICON_SRC}\" alt=\"\"><div class=\"merchant-firstchat__text\">\u2026</div></div><div class=\"merchant-firstchat__choices\"></div></div>`;\r\n  merchantOverlayEl.appendChild(overlay);\r\nconst onEscToCancel = (e) => {\r\n  if (e.key !== 'Escape') return;\r\n  if (!overlay.isConnected) return;\r\n  cancelWithoutReward();\r\n};\r\n\r\ndocument.addEventListener('keydown', onEscToCancel, { capture: true });\r\n\r\n\r\n  // fade/blur in (same behavior as first meet)\r\n  requestAnimationFrame(() => overlay.classList.add('is-visible'));\r\n  merchantOverlayEl.classList.add('firstchat-active');\r\n\r\n  // local refs\r\n  const textEl    = overlay.querySelector('.merchant-firstchat__text');\r\n  const rowEl     = overlay.querySelector('.merchant-firstchat__row');\r\n  const cardEl    = overlay.querySelector('.merchant-firstchat__card');\r\n  const choicesEl = overlay.querySelector('.merchant-firstchat__choices');\r\n\r\n  let ended = false;\r\n\r\n  // Close helpers \u2014 end (with reward) vs cancel (no reward)\r\n  const closeModal = () => {\r\n\tdocument.removeEventListener('keydown', onEscToCancel, { capture: true });\r\n    overlay.classList.remove('is-visible');\r\n    merchantOverlayEl.classList.remove('firstchat-active');\r\n    stopTypingSfx();\r\n    __isTypingActive = false;\r\n    overlay.remove();\r\n  };\r\n\r\n  const cancelWithoutReward = () => {\r\n    if (ended) return;\r\n    ended = true;\r\n    closeModal();               // no reward\r\n    renderDialogueList();       // refresh UI state\r\n  };\r\n\r\noverlay.addEventListener('pointerdown', (e) => {\r\n  if (!cardEl.contains(e.target)) {\r\n    e.preventDefault();\r\n    if (e.pointerType !== 'mouse') blockInteraction(160);\r\n    cancelWithoutReward();\r\n  }\r\n});\r\n\r\nconst engine = new DialogueEngine({\r\n  textEl,\r\n  choicesEl,\r\n  skipTargets: [textEl, rowEl, cardEl],\r\n    onChoice: (nodeId, opt) => {\r\n      if (meta.scriptId === 4 && nodeId === 'c4b') {\r\n        setJeffUnlocked(true);\r\n      }\r\n    },\r\n  onEnd: (info) => {\r\n    if (ended) return;\r\n    ended = true;\r\n\r\n    if (info && info.noReward) {\r\n      renderDialogueList();\r\n      closeModal();\r\n      return;\r\n    }\r\n\r\n    completeDialogueOnce(id, meta);\r\n    renderDialogueList();\r\n    closeModal();\r\n  }\r\n});\r\n\r\n  const state = loadDlgState();\r\n  const claimed = !!state[id]?.claimed;\r\n\r\n  const script = structuredClone(MERCHANT_DIALOGUES[meta.scriptId]);\r\n\r\n  if (claimed && script.nodes.m2b && script.nodes.c2a && meta.scriptId === 1) {\r\n    script.nodes.m2b.say = 'I\\'ve already given you Coins, goodbye.';\r\n    script.nodes.c2a.options = [\r\n      { label: 'Goodbye.', to: 'end_nr' },\r\n      { label: 'Goodbye.', to: 'end_nr' },\r\n      { label: 'Goodbye.', to: 'end_nr' },\r\n    ];\r\n  }\r\n\r\n  if (claimed && meta.scriptId === 2 && script.nodes.m2a) {\r\n    script.nodes.m2a.say = 'I\\'ve already given you Books, goodbye.';\r\n\tif (script.nodes.c2a) {\r\n      script.nodes.c2a.options = [\r\n        { label: 'Goodbye.', to: 'end_nr' },\r\n        { label: 'Goodbye.', to: 'end_nr' },\r\n        { label: 'Goodbye.', to: 'end_nr' },\r\n      ];\r\n    }\r\n  }\r\n  \r\n  if (claimed && meta.scriptId === 3 && script.nodes.m5a) {\r\n    script.nodes.m5a.say = 'I\\'ve already given you Gold, goodbye.';\r\n    if (script.nodes.c5a) {\r\n      script.nodes.c5a.options = [\r\n        { label: 'Goodbye.', to: 'end_nr' },\r\n        { label: 'Goodbye.', to: 'end_nr' },\r\n        { label: 'Goodbye.', to: 'end_nr' },\r\n      ];\r\n    }\r\n  }\r\n\r\n  if (claimed && meta.scriptId === 4 && script.nodes.m7a) {\r\n    script.nodes.m7a.say = 'I\\'ve already given you Magic, goodbye.';\r\n    if (script.nodes.c7a) {\r\n      script.nodes.c7a.options = [\r\n        { label: 'Goodbye.', to: 'end_nr' },\r\n        { label: 'Goodbye.', to: 'end_nr' },\r\n        { label: 'Goodbye.', to: 'end_nr' },\r\n      ];\r\n    }\r\n  }\r\n\r\n  engine.load(script);\r\n  engine.start();\r\n}\r\n\r\n// ========================= Merchant Overlay (Delve) =========================\r\nfunction ensureMerchantScrollbar() {\r\n  const scroller = merchantOverlayEl?.querySelector('.merchant-content');\r\n  if (!scroller || scroller.__customScroll) return;\r\n  if (!merchantSheetEl) return;\r\n\r\n  const bar = document.createElement('div');\r\n  bar.className = 'merchant-scrollbar';\r\n  const thumb = document.createElement('div');\r\n  thumb.className = 'merchant-scrollbar__thumb';\r\n  bar.appendChild(thumb);\r\n  merchantSheetEl.appendChild(bar);\r\n\r\n  const isTouch = window.matchMedia?.('(hover: none) and (pointer: coarse)')?.matches;\r\n  const FADE_SCROLL_MS = 150;\r\n  const FADE_DRAG_MS = 120;\r\n  const supportsScrollEnd = 'onscrollend' in window;\r\n  let fadeTimer = null;\r\n\r\n  const syncScrollShadow = () => {\r\n    const hasShadow = (scroller.scrollTop || 0) > 0;\r\n    merchantSheetEl?.classList.toggle('has-scroll-shadow', hasShadow);\r\n  };\r\n\r\n  const updateBounds = () => {\r\n    const grabber = merchantOverlayEl.querySelector('.merchant-grabber');\r\n    const header  = merchantOverlayEl.querySelector('.merchant-header');\r\n    const actions = merchantOverlayEl.querySelector('.merchant-actions');\r\n\r\n    const top = ((grabber?.offsetHeight || 0) + (header?.offsetHeight || 0)) | 0;\r\n    const bottom = (actions?.offsetHeight || 0) | 0;\r\n\r\n    bar.style.top = top + 'px';\r\n    bar.style.bottom = bottom + 'px';\r\n  };\r\n\r\n  const updateThumb = () => {\r\n    const { scrollHeight, clientHeight, scrollTop } = scroller;\r\n    const barH = bar.clientHeight || scroller.clientHeight || 1;\r\n\r\n    const visibleRatio = clientHeight / Math.max(1, scrollHeight);\r\n    const thumbH = Math.max(28, Math.round(barH * visibleRatio));\r\n\r\n    const maxScroll = Math.max(1, scrollHeight - clientHeight);\r\n    const range = Math.max(0, barH - thumbH);\r\n    const y = Math.round((scrollTop / maxScroll) * range);\r\n\r\n    thumb.style.height = thumbH + 'px';\r\n    thumb.style.transform = `translateY(${y}px)`;\r\n\r\n    bar.style.display = (scrollHeight <= clientHeight + 1) ? 'none' : '';\r\n  };\r\n\r\n  const updateAll = () => {\r\n    updateBounds();\r\n    updateThumb();\r\n    syncScrollShadow();\r\n  };\r\n\r\n  const showBar = () => {\r\n    if (!isTouch) return;\r\n    merchantSheetEl.classList.add('is-scrolling');\r\n    if (fadeTimer) clearTimeout(fadeTimer);\r\n  };\r\n\r\n  const scheduleHide = (delay) => {\r\n    if (!isTouch) return;\r\n    if (fadeTimer) clearTimeout(fadeTimer);\r\n    fadeTimer = setTimeout(() => {\r\n      merchantSheetEl.classList.remove('is-scrolling');\r\n    }, delay);\r\n  };\r\n\r\n  const onScroll = () => {\r\n    updateThumb();\r\n    syncScrollShadow();\r\n    if (isTouch) showBar();\r\n    if (!supportsScrollEnd) scheduleHide(FADE_SCROLL_MS);\r\n  };\r\n\r\n  const onScrollEnd = () => scheduleHide(FADE_SCROLL_MS);\r\n\r\n  scroller.addEventListener('scroll', onScroll, { passive: true });\r\n  if (supportsScrollEnd) {\r\n    scroller.addEventListener('scrollend', onScrollEnd, { passive: true });\r\n  }\r\n\r\n  const ro = new ResizeObserver(updateAll);\r\n  ro.observe(scroller);\r\n  window.addEventListener('resize', updateAll);\r\n  requestAnimationFrame(updateAll);\r\n\r\n  // ----- Drag thumb to scroll -----\r\n  let dragging = false;\r\n  let dragStartY = 0;\r\n  let startScrollTop = 0;\r\n\r\n  const startDrag = (e) => {\r\n    dragging = true;\r\n    dragStartY = e.clientY;\r\n    startScrollTop = scroller.scrollTop;\r\n    thumb.classList.add('dragging');\r\n    showBar();\r\n    try { thumb.setPointerCapture(e.pointerId); } catch {}\r\n    e.preventDefault();\r\n  };\r\n\r\n  const onDragMove = (e) => {\r\n    if (!dragging) return;\r\n    const barH = bar.clientHeight || 1;\r\n    const thH = thumb.clientHeight || 1;\r\n    const range = Math.max(1, barH - thH);\r\n    const scrollMax = Math.max(1, scroller.scrollHeight - scroller.clientHeight);\r\n    const deltaY = e.clientY - dragStartY;\r\n    const scrollDelta = (deltaY / range) * scrollMax;\r\n    scroller.scrollTop = startScrollTop + scrollDelta;\r\n  };\r\n\r\n  const endDrag = (e) => {\r\n    if (!dragging) return;\r\n    dragging = false;\r\n    thumb.classList.remove('dragging');\r\n    scheduleHide(FADE_DRAG_MS);\r\n    try { thumb.releasePointerCapture(e.pointerId); } catch {}\r\n  };\r\n\r\n  thumb.addEventListener('pointerdown', startDrag);\r\n  window.addEventListener('pointermove', onDragMove, { passive: true });\r\n  window.addEventListener('pointerup', endDrag);\r\n  window.addEventListener('pointercancel', endDrag);\r\n\r\n  // Click track to jump\r\n  bar.addEventListener('pointerdown', (e) => {\r\n    if (e.target === thumb) return;\r\n    const rect = bar.getBoundingClientRect();\r\n    const clickY = e.clientY - rect.top;\r\n\r\n    const barH = bar.clientHeight || 1;\r\n    const thH = thumb.clientHeight || 1;\r\n    const range = Math.max(0, barH - thH);\r\n    const targetY = Math.max(0, Math.min(clickY - thH / 2, range));\r\n\r\n    const scrollMax = Math.max(1, scroller.scrollHeight - scroller.clientHeight);\r\n    scroller.scrollTop = (targetY / Math.max(1, range)) * scrollMax;\r\n\r\n    showBar();\r\n    scheduleHide(FADE_SCROLL_MS);\r\n  });\r\n\r\n  // mark so we don't double-init\r\n  scroller.__customScroll = { bar, thumb, ro, updateAll };\r\n  updateAll();\r\n}\r\n\r\nfunction ensureMerchantOverlay() {\r\n  if (merchantOverlayEl) return;\r\n\r\n  merchantOverlayEl = document.createElement('div');\r\n  merchantOverlayEl.className = 'merchant-overlay';\r\n  merchantOverlayEl.id = 'merchant-overlay';\r\n  merchantOverlayEl.setAttribute('inert', '');\r\n\r\n  merchantSheetEl = document.createElement('div');\r\n  merchantSheetEl.className = 'merchant-sheet';\r\n  merchantSheetEl.setAttribute('role', 'dialog');\r\n  merchantSheetEl.setAttribute('aria-modal', 'false');\r\n  merchantSheetEl.setAttribute('aria-label', 'Merchant');\r\n\r\n  const grabber = document.createElement('div');\r\n  grabber.className = 'merchant-grabber';\r\n  grabber.innerHTML = `<div class=\"grab-handle\" aria-hidden=\"true\"></div>`;\r\n\r\n  const header = document.createElement('header');\r\n  header.className = 'merchant-header';\r\n  header.innerHTML = `<div class=\"merchant-title\">Merchant</div><div class=\"merchant-line\" aria-hidden=\"true\"></div>`;\r\n\r\n  const content = document.createElement('div');\r\n  content.className = 'merchant-content';\r\n\r\n  const tabs = document.createElement('div');\r\n  tabs.className = 'merchant-tabs';\r\n  tabs.setAttribute('role', 'tablist');\r\n\r\n  const panelsWrap = document.createElement('div');\r\n  panelsWrap.className = 'merchant-panels';\r\n\r\n  const panelDialogue = document.createElement('section');\r\n  panelDialogue.className = 'merchant-panel is-active';\r\n  panelDialogue.id = 'merchant-panel-dialogue';\r\n\r\n  const panelReset = document.createElement('section');\r\n  panelReset.className = 'merchant-panel';\r\n  panelReset.id = 'merchant-panel-reset';\r\n\r\n  const panelWorkshop = document.createElement('section');\r\n  panelWorkshop.className = 'merchant-panel';\r\n  panelWorkshop.id = 'merchant-panel-workshop';\r\n\r\n  syncForgeTabUnlockState();\r\n  syncWorkshopTabUnlockState();\r\n\r\n  MERCHANT_TABS_DEF.forEach(def => {\r\n    if (def.key === 'dialogue') merchantTabUnlockState.set('dialogue', true);\r\n    const stored = merchantTabUnlockState.get(def.key);\r\n    const unlocked = stored != null ? stored : !!def.unlocked;\r\n    const btn = document.createElement('button');\r\n    btn.type = 'button';\r\n    btn.className = 'merchant-tab';\r\n    btn.dataset.tab = def.key;\r\n    const lockedLabel = def.lockedLabel || '???';\r\n    btn.textContent = unlocked ? def.label : lockedLabel;\r\n      if (!unlocked) {\r\n        btn.classList.add('is-locked');\r\n        btn.disabled = true;\r\n        btn.title = '???';\r\n      } else {\r\n      btn.title = def.label || 'Tab';\r\n    }\r\n    def.unlocked = unlocked;\r\n    merchantTabUnlockState.set(def.key, unlocked);\r\n    bindRapidActivation(btn, (event) => {\r\n      if (btn.disabled) {\r\n        event?.preventDefault?.();\r\n        return;\r\n      }\r\n      selectMerchantTab(def.key);\r\n    });\r\n\r\n    tabs.appendChild(btn);\r\n    merchantTabs.buttons[def.key] = btn;\r\n  });\r\n\r\n  merchantTabs.panels['dialogue']  = panelDialogue;\r\n  merchantTabs.panels['reset']     = panelReset;\r\n  merchantTabs.panels['workshop']  = panelWorkshop;\r\n  merchantTabs.tablist = tabs;\r\n\r\n  panelsWrap.append(panelDialogue, panelReset, panelWorkshop);\r\n  content.append(tabs, panelsWrap);\r\n\r\n  syncForgeTabUnlockState();\r\n  syncWorkshopTabUnlockState();\r\n\r\n  try { initResetSystem(); } catch {}\r\n  try { initResetPanel(panelReset); } catch {}\r\n  try { updateResetPanel(); } catch {}\r\n  \r\n  try { initWorkshopTab(panelWorkshop); } catch {}\r\n\r\n  if (!forgeUnlockListenerBound && typeof window !== 'undefined') {\r\n    const handleUnlockChange = (event) => {\r\n      const { key, slot } = event?.detail ?? {};\r\n      if (slot != null && slot !== getActiveSlot()) return;\r\n      \r\n      if (key === 'forge' || !key) syncForgeTabUnlockState();\r\n      if (key === 'infuse' || !key) syncWorkshopTabUnlockState();\r\n    };\r\n    window.addEventListener('unlock:change', handleUnlockChange, { passive: true });\r\n    window.addEventListener('saveSlot:change', handleUnlockChange, { passive: true });\r\n    forgeUnlockListenerBound = true;\r\n  }\r\n\r\n    const actions = document.createElement('div');\r\n    actions.className = 'merchant-actions';\r\n    const closeBtn = document.createElement('button');\r\n    closeBtn.type = 'button';\r\n    closeBtn.className = 'merchant-close';\r\n    closeBtn.textContent = 'Close';\r\n    merchantCloseBtn = closeBtn;\r\n    actions.appendChild(closeBtn);\r\n\r\n  // First-time chat overlay\r\n  const firstChat = document.createElement('div');\r\n  firstChat.className = 'merchant-firstchat merchant-firstchat--initial';\r\n  firstChat.innerHTML = `<div class=\"merchant-firstchat__card\" role=\"dialog\" aria-label=\"First chat\"><div class=\"merchant-firstchat__header\"><div class=\"name\">Merchant</div><div class=\"rule\" aria-hidden=\"true\"></div></div><div class=\"merchant-firstchat__row\"><img class=\"merchant-firstchat__icon\" src=\"${MERCHANT_ICON_SRC}\" alt=\"\"><div class=\"merchant-firstchat__text\" id=\"merchant-first-line\">\u2026</div></div><div class=\"merchant-firstchat__choices\" id=\"merchant-first-choices\"></div></div>`;\r\n\r\n  merchantSheetEl.append(grabber, header, content, actions, firstChat);\r\n  merchantOverlayEl.appendChild(merchantSheetEl);\r\n  document.body.appendChild(merchantOverlayEl);\r\n  initDialogueTab();\r\n  ensureMerchantScrollbar();\r\n\r\n  if (!merchantEventsBound) {\r\n    merchantEventsBound = true;\r\n\r\n    const onCloseClick = () => { closeMerchant(); };\r\n\r\n    bindRapidActivation(closeBtn, onCloseClick, { once: false });\r\n    document.addEventListener('keydown', onKeydownForMerchant);\r\n    grabber.addEventListener('pointerdown', onMerchantDragStart);\r\n    grabber.addEventListener('touchstart', (e) => e.preventDefault(), { passive: false });\r\n\r\n    // Allow priming via any pointer in the overlay (mobile-safe)\r\n    merchantOverlayEl.addEventListener('pointerdown', primeTypingSfx, { once: true });\r\n  }\r\n}\r\n\r\n// Called once when Merchant overlay is created\r\nfunction initDialogueTab() {\r\n  const panel = document.getElementById('merchant-panel-dialogue');\r\n  if (!panel || panel.__dlgInit) return;\r\n  panel.__dlgInit = true;\r\n\r\n  const list = document.createElement('div');\r\n  list.className = 'merchant-dialogue-list';\r\n  panel.appendChild(list);\r\n\r\n  panel.__dlgList = list;\r\n  ensureProgressEvents();\r\n  renderDialogueList();\r\n}\r\n\r\nfunction handleDialogueCardClick(event) {\r\n  const card = event.currentTarget;\r\n  if (!card) return;\r\n  const ctx = card._dlgCtx;\r\n  if (!ctx) return;\r\n\r\n  if (card.classList.contains('is-locked') && !ctx.isMysterious) {\r\n    event?.preventDefault?.();\r\n    return;\r\n  }\r\n  if (ctx.unlocked) {\r\n    openDialogueModal(ctx.id, ctx.meta);\r\n  } else if (ctx.isMysterious) {\r\n    openDialogueLockInfo(ctx.lockInfo);\r\n  }\r\n}\r\n\r\nfunction renderDialogueList() {\r\n  const panel = document.getElementById('merchant-panel-dialogue');\r\n  if (!panel) return;\r\n\r\n  const list = panel.__dlgList;\r\n  if (!list) return;\r\n\r\n  const progress = getPlayerProgress();\r\n  const state = loadDlgState();\r\n  let stateDirty = false;\r\n\r\n  const seenIds = new Set();\r\n\r\n  Object.entries(DLG_CATALOG).forEach(([id, meta]) => {\r\n    seenIds.add(String(id));\r\n    const entryState = state[id] || {};\r\n    const storedStatus = entryState.status || 'locked';\r\n    const storedRank = dialogueStatusRank(storedStatus);\r\n\r\n    let lockInfo = resolveDialogueLock(meta, progress);\r\n    let status = lockInfo.status;\r\n    let rank = dialogueStatusRank(status);\r\n\r\n    if (rank > storedRank) {\r\n      entryState.status = status;\r\n      if (status === 'mysterious') {\r\n        entryState.lockSnapshot = snapshotLockDisplay(lockInfo);\r\n      } else if (status === 'unlocked') {\r\n        delete entryState.lockSnapshot;\r\n      }\r\n      state[id] = entryState;\r\n      stateDirty = true;\r\n    } else if (rank < storedRank) {\r\n      if (storedStatus === 'unlocked') {\r\n        lockInfo = buildUnlockedDialogueInfo(meta);\r\n        status = 'unlocked';\r\n        rank = dialogueStatusRank(status);\r\n      } else if (storedStatus === 'mysterious') {\r\n        const snapshot = entryState.lockSnapshot || snapshotLockDisplay(lockInfo) || {};\r\n        lockInfo = {\r\n          status: 'mysterious',\r\n          unlocked: false,\r\n          title: snapshot.title ?? lockInfo.title ?? '???',\r\n          blurb: snapshot.blurb ?? lockInfo.blurb ?? DEFAULT_MYSTERIOUS_BLURB,\r\n          tooltip: snapshot.tooltip ?? lockInfo.tooltip ?? 'Hidden Dialogue',\r\n          message: snapshot.message ?? lockInfo.message ?? DEFAULT_LOCK_MESSAGE,\r\n          icon: snapshot.icon ?? lockInfo.icon ?? MYSTERIOUS_ICON_SRC,\r\n          headerTitle: snapshot.headerTitle ?? lockInfo.headerTitle ?? HIDDEN_DIALOGUE_TITLE,\r\n          ariaLabel: snapshot.ariaLabel ?? lockInfo.ariaLabel ?? 'Hidden merchant dialogue',\r\n        };\r\n        status = 'mysterious';\r\n        rank = dialogueStatusRank(status);\r\n      }\r\n    }\r\n\r\n    const unlocked = status === 'unlocked';\r\n    const isMysterious = status === 'mysterious';\r\n    const locked = status === 'locked';\r\n    const claimed = !!entryState.claimed;\r\n    const showComplete = unlocked && !!(meta.once && claimed);\r\n\r\n    let card = list.querySelector(`.dlg-card[data-dlg-id=\"${id}\"]`);\r\n    if (!card) {\r\n      card = document.createElement('button');\r\n      card.type = 'button';\r\n      card.className = 'dlg-card';\r\n      card.dataset.dlgId = String(id);\r\n      \r\n      const titleEl = document.createElement('div');\r\n      titleEl.className = 'dlg-title';\r\n      \r\n      const blurbEl = document.createElement('div');\r\n      blurbEl.className = 'dlg-blurb';\r\n      \r\n      const rewardEl = document.createElement('div');\r\n      rewardEl.className = 'dlg-reward';\r\n      \r\n      card.append(titleEl, blurbEl, rewardEl);\r\n      list.appendChild(card);\r\n      \r\n      // Bind once; handler uses element context\r\n      bindRapidActivation(card, handleDialogueCardClick);\r\n    }\r\n\r\n    // Update Context\r\n    card._dlgCtx = { id, meta, lockInfo, unlocked, isMysterious };\r\n\r\n    // Update Classes\r\n    card.dataset.dlgStatus = status;\r\n    if (card.disabled !== !!locked) card.disabled = !!locked;\r\n    card.classList.toggle('is-locked', locked);\r\n    card.classList.toggle('is-mysterious', isMysterious);\r\n    card.classList.toggle('is-complete', !!showComplete);\r\n    card.classList.toggle('has-again', !!showComplete);\r\n\r\n    if (locked) {\r\n      if (card.getAttribute('aria-disabled') !== 'true') card.setAttribute('aria-disabled', 'true');\r\n      if (card.getAttribute('tabindex') !== '-1') card.setAttribute('tabindex', '-1');\r\n    } else {\r\n      if (card.hasAttribute('aria-disabled')) card.removeAttribute('aria-disabled');\r\n      if (card.hasAttribute('tabindex')) card.removeAttribute('tabindex');\r\n    }\r\n\r\n    // Update Content\r\n    const titleEl = card.querySelector('.dlg-title');\r\n    const titleText = unlocked ? meta.title : (lockInfo.title ?? '???');\r\n    if (titleEl.textContent !== titleText) titleEl.textContent = titleText;\r\n\r\n    const blurbEl = card.querySelector('.dlg-blurb');\r\n    const blurbText = unlocked ? meta.blurb : (lockInfo.blurb ?? '');\r\n    if (blurbEl.textContent !== blurbText) blurbEl.textContent = blurbText;\r\n\r\n    const rewardEl = card.querySelector('.dlg-reward');\r\n    if (unlocked && meta.reward) {\r\n      const iconSrc = REWARD_ICON_SRC[meta.reward.type];\r\n      if (iconSrc) {\r\n        // Reuse inner structure if it matches, to avoid flicker\r\n        if (!rewardEl.classList.contains('has-reward')) {\r\n           rewardEl.classList.add('has-reward');\r\n           rewardEl.innerHTML = `<span class=\"reward-label\">Reward:</span><span class=\"reward-chunk\"><span class=\"reward-icon\" aria-hidden=\"true\"></span><span class=\"amt\"></span><span class=\"currency-name\"></span></span>`;\r\n        }\r\n        \r\n        // Update reward visual data\r\n        if (rewardEl.style.getPropertyValue('--reward-icon') !== `url('${iconSrc}')`) {\r\n            rewardEl.style.setProperty('--reward-icon', `url('${iconSrc}')`);\r\n        }\r\n        const amtEl = rewardEl.querySelector('.amt');\r\n        const amtText = String(meta.reward.amount);\r\n        if (amtEl && amtEl.textContent !== amtText) amtEl.textContent = amtText;\r\n\r\n        const nameEl = rewardEl.querySelector('.currency-name');\r\n        if (nameEl) {\r\n          const typeStr = String(meta.reward.type || '');\r\n          const capText = typeStr.charAt(0).toUpperCase() + typeStr.slice(1);\r\n          if (nameEl.textContent !== capText) nameEl.textContent = capText;\r\n        }\r\n        \r\n        const rewardLabelText = `Reward: ${meta.reward.amount} ${meta.reward.type}`;\r\n        if (rewardEl.getAttribute('aria-label') !== rewardLabelText) {\r\n            rewardEl.setAttribute('aria-label', rewardLabelText);\r\n        }\r\n      } else {\r\n        rewardEl.classList.remove('has-reward');\r\n        const text = rewardLabel(meta.reward);\r\n        if (rewardEl.textContent !== text) rewardEl.textContent = text;\r\n        if (rewardEl.style.display !== '') rewardEl.style.display = '';\r\n        rewardEl.removeAttribute('aria-label');\r\n      }\r\n      if (rewardEl.style.display === 'none') rewardEl.style.display = '';\r\n    } else {\r\n      if (rewardEl.textContent !== '') rewardEl.textContent = '';\r\n      if (rewardEl.style.display !== 'none') rewardEl.style.display = 'none';\r\n    }\r\n\r\n    const ariaLabel = unlocked\r\n      ? `${meta.title}${showComplete ? ' (completed)' : ''}`\r\n      : (lockInfo.ariaLabel || (isMysterious ? 'Hidden merchant dialogue' : 'Locked merchant dialogue'));\r\n    if (card.getAttribute('aria-label') !== ariaLabel) card.setAttribute('aria-label', ariaLabel);\r\n\r\n    if (lockInfo.tooltip) {\r\n      if (card.title !== lockInfo.tooltip) card.title = lockInfo.tooltip;\r\n    } else if (unlocked) {\r\n      const hint = 'Left-click: Start Dialogue';\r\n      if (card.title !== hint) card.title = hint;\r\n    } else {\r\n      if (card.hasAttribute('title')) card.removeAttribute('title');\r\n    }\r\n\r\n    // \"Ask Again\" footer\r\n    let againEl = card.querySelector('.dlg-again');\r\n    if (showComplete) {\r\n      if (!againEl) {\r\n        againEl = document.createElement('div');\r\n        againEl.className = 'dlg-again';\r\n        againEl.textContent = 'Ask Again?';\r\n        card.appendChild(againEl);\r\n      }\r\n    } else if (againEl) {\r\n      againEl.remove();\r\n    }\r\n  });\r\n  \r\n  // Cleanup stale\r\n  Array.from(list.children).forEach(child => {\r\n      if (child.dataset.dlgId && !seenIds.has(child.dataset.dlgId)) {\r\n          child.remove();\r\n      }\r\n  });\r\n\r\n  if (stateDirty) {\r\n    saveDlgState(state);\r\n  }\r\n}\r\n\r\n// Runs a conversation inside the Dialogue tab (not the first-time overlay)\r\nfunction startConversation(id, meta) {\r\n  const panel = document.getElementById('merchant-panel-dialogue');\r\n  if (!panel) return;\r\n\r\n  const textEl = panel.querySelector('.merchant-text');     // from your bubble\r\n  const bubble = panel.querySelector('.merchant-bubble');\r\n  const row = panel;                                        // big tap target\r\n  let choicesEl = panel.querySelector('.merchant-choices');\r\n\r\n  // Ensure blank + hide choices before typing\r\n  choicesEl.classList.remove('is-visible');\r\n  choicesEl.innerHTML = '';\r\n\r\n  const engine = new DialogueEngine({\r\n    textEl,\r\n    choicesEl,\r\n    skipTargets: [textEl, row, bubble],\r\n    onEnd: (info) => {\r\n\t  if (info && info.noReward) {\r\n        textEl.textContent = '\u2026';\r\n        renderDialogueList();\r\n        return;\r\n      }\r\n      completeDialogueOnce(id, meta);\r\n\ttextEl.textContent = '\u2026';\r\n\trenderDialogueList();\r\n\t}\r\n  });\r\n\r\n  const script = MERCHANT_DIALOGUES[meta.scriptId];\r\n  engine.load(script);\r\n  engine.start();\r\n}\r\n\r\nfunction runFirstMeet() {\r\n  const fc = merchantOverlayEl.querySelector('.merchant-firstchat');\r\n  const textEl = fc.querySelector('#merchant-first-line');\r\n  const rowEl  = fc.querySelector('.merchant-firstchat__row');\r\n  const cardEl = fc.querySelector('.merchant-firstchat__card');\r\n  const choicesEl = fc.querySelector('#merchant-first-choices');\r\n\r\n  const engine = new DialogueEngine({\r\n    textEl,\r\n    choicesEl,\r\n    skipTargets: [textEl, rowEl, cardEl],\r\n    onEnd: () => {\r\n      try { localStorage.setItem(sk(MERCHANT_MET_KEY_BASE), '1'); } catch {}\r\n      try { window.dispatchEvent(new Event(MERCHANT_MET_EVENT)); } catch {}\r\n      fc.classList.remove('is-visible');\r\n      merchantOverlayEl.classList.remove('firstchat-active');\r\n    }\r\n  });\r\n\r\n  engine.load(MERCHANT_DIALOGUES[0]);\r\n  engine.start();\r\n}\r\n\r\nfunction resetFirstChatOverlayState() {\r\n  if (!merchantOverlayEl) return;\r\n  const fc = merchantOverlayEl.querySelector('.merchant-firstchat--initial');\r\n  if (!fc) return;\r\n\r\n  fc.classList.remove('is-visible');\r\n\r\n  const textEl = fc.querySelector('#merchant-first-line');\r\n  if (textEl) {\r\n    textEl.classList.remove('is-typing');\r\n    textEl.textContent = '\u2026';\r\n  }\r\n\r\n  const choicesEl = fc.querySelector('#merchant-first-choices');\r\n  if (choicesEl) {\r\n    choicesEl.classList.remove('is-visible');\r\n    choicesEl.style.opacity = '0';\r\n    choicesEl.style.transform = 'translateY(6px)';\r\n    choicesEl.style.pointerEvents = 'none';\r\n    choicesEl.style.minHeight = '';\r\n    choicesEl.innerHTML = '';\r\n  }\r\n\r\n  merchantOverlayEl.classList.remove('firstchat-active');\r\n}\r\n\r\nexport function openMerchant() {\r\n  ensureMerchantOverlay();\r\n  if (merchantOpen) return;\r\n\r\n  const activeEl = document.activeElement;\r\n  if (activeEl instanceof HTMLElement && !merchantOverlayEl.contains(activeEl)) {\r\n    merchantLastFocus = activeEl;\r\n  } else {\r\n    merchantLastFocus = null;\r\n  }\r\n  merchantOpen = true;\r\n\r\n  // Check whether this is the very first time we\u2019re meeting the Merchant\r\n  let met = false;\r\n  try {\r\n    met = localStorage.getItem(sk(MERCHANT_MET_KEY_BASE)) === '1';\r\n  } catch {\r\n    met = false;\r\n  }\r\n\r\n  // For the very first chat, pin the sheet in place (no slide-up animation)\r\n  if (!met) {\r\n    merchantOverlayEl.classList.add('firstchat-instant');\r\n  }\r\n\r\n  // Reset transform and transition\r\n  merchantSheetEl.style.transition = 'none';\r\n  merchantSheetEl.style.transform = '';\r\n  merchantOverlayEl.removeAttribute('inert');\r\n\r\n  // Animate in next frame\r\n  void merchantSheetEl.offsetHeight;\r\n  requestAnimationFrame(() => {\r\n    // Only restore the sheet transition for normal opens\r\n    if (!merchantOverlayEl.classList.contains('firstchat-instant')) {\r\n      merchantSheetEl.style.transition = '';\r\n    }\r\n\r\n    merchantOverlayEl.classList.add('is-open');\r\n    blockInteraction(140);\r\n\r\n    if (merchantCloseBtn && typeof merchantCloseBtn.focus === 'function') {\r\n      try { merchantCloseBtn.focus({ preventScroll: true }); } catch {}\r\n    }\r\n\r\n    // Restore last tab\r\n    let last = 'dialogue';\r\n    try { last = localStorage.getItem(sk(MERCHANT_TAB_KEY_BASE)) || 'dialogue'; } catch {}\r\n    selectMerchantTab(last);\r\n\r\n    // Ensure no orphaned audio\r\n    stopTypingSfx();\r\n\r\n    // First-time chat\r\n    if (!met) {\r\n      const fc = merchantOverlayEl.querySelector('.merchant-firstchat');\r\n      fc?.classList.add('is-visible');\r\n      merchantOverlayEl.classList.add('firstchat-active');\r\n      runFirstMeet();\r\n    }\r\n  });\r\n}\r\n\r\nexport function closeMerchant() {\r\n  if (!merchantOpen) return;\r\n  \r\n  if (IS_MOBILE) {\r\n    try { suppressNextGhostTap(100); } catch {}\r\n    try { blockInteraction(80); } catch {}\r\n  }\r\n\r\n  merchantOpen = false;\r\n  merchantSheetEl.style.transition = '';\r\n  merchantSheetEl.style.transform = '';\r\n  merchantOverlayEl.classList.remove('is-open');\r\n  merchantOverlayEl.classList.remove('firstchat-instant');\r\n  resetFirstChatOverlayState();\r\n\r\n  const activeEl = document.activeElement;\r\n  if (activeEl && merchantOverlayEl.contains(activeEl)) {\r\n    let target = merchantLastFocus;\r\n    if (!target || !target.isConnected) {\r\n      target = document.querySelector('[data-btn=\"shop\"], .btn-shop');\r\n    }\r\n    if (target && typeof target.focus === 'function') {\r\n      try { target.focus({ preventScroll: true }); } catch {}\r\n    }\r\n  }\r\n\r\n  merchantOverlayEl.setAttribute('inert', '');\r\n  merchantLastFocus = null;\r\n  stopTypingSfx();\r\n  __isTypingActive = false;\r\n}\r\n\r\nfunction onKeydownForMerchant(e) {\r\n  if (!merchantOpen) return;\r\n\r\n  if (['INPUT', 'TEXTAREA', 'SELECT'].includes(document.activeElement?.tagName)) return;\r\n\r\n  if (/^[0-9]$/.test(e.key)) {\r\n    const num = parseInt(e.key, 10);\r\n    const requestedIndex = (num === 0 ? 9 : num - 1);\r\n\r\n    let maxUnlockedIndex = -1;\r\n    for (let i = 0; i < MERCHANT_TABS_DEF.length; i++) {\r\n      if (merchantTabUnlockState.get(MERCHANT_TABS_DEF[i].key)) {\r\n        maxUnlockedIndex = i;\r\n      }\r\n    }\r\n\r\n    if (maxUnlockedIndex === -1) maxUnlockedIndex = 0;\r\n\r\n    let targetIndex = requestedIndex;\r\n    if (targetIndex > maxUnlockedIndex) {\r\n      targetIndex = maxUnlockedIndex;\r\n    }\r\n\r\n    if (targetIndex >= 0 && targetIndex < MERCHANT_TABS_DEF.length) {\r\n      e.preventDefault();\r\n      selectMerchantTab(MERCHANT_TABS_DEF[targetIndex].key);\r\n    }\r\n  }\r\n}\r\n\r\n// Drag to dismiss\r\nfunction onMerchantDragStart(e) {\r\n  if (!merchantOpen) return;\r\n\r\n  const clientY = typeof e.clientY === 'number'\r\n    ? e.clientY\r\n    : (e.touches && e.touches[0] ? e.touches[0].clientY : 0);\r\n\r\n  merchantDrag = {\r\n    startY: clientY,\r\n    lastY: clientY,\r\n    startT: performance.now(),\r\n    moved: 0,\r\n    canceled: false,\r\n  };\r\n\r\n  merchantSheetEl.style.transition = 'none';\r\n\r\n  window.addEventListener('pointermove', onMerchantDragMove, { passive: true });\r\n  window.addEventListener('pointerup', onMerchantDragEnd);\r\n  window.addEventListener('pointercancel', onMerchantDragCancel);\r\n}\r\n\r\nfunction onMerchantDragMove(e) {\r\n  if (!merchantDrag || merchantDrag.canceled) return;\r\n  const y = e.clientY;\r\n  if (typeof y !== 'number') return;\r\n  const dy = Math.max(0, y - merchantDrag.startY);\r\n  merchantDrag.lastY = y;\r\n  merchantDrag.moved = dy;\r\n  merchantSheetEl.style.transform = `translateY(${dy}px)`;\r\n}\r\n\r\nfunction onMerchantDragEnd() {\r\n  if (!merchantDrag || merchantDrag.canceled) { cleanupMerchantDrag(); return; }\r\n  const dt = Math.max(1, performance.now() - merchantDrag.startT);\r\n  const dy = merchantDrag.moved;\r\n  const velocity = dy / dt;\r\n  const shouldClose = (velocity > 0.55 && dy > 40) || dy > 140;\r\n\r\n  if (shouldClose) {\r\n    suppressNextGhostTap(160);\r\n    merchantSheetEl.style.transition = 'transform 140ms ease-out';\r\n    merchantSheetEl.style.transform = 'translateY(100%)';\r\n    setTimeout(() => { closeMerchant(); }, 150);\r\n  } else {\r\n    merchantSheetEl.style.transition = 'transform 180ms ease';\r\n    merchantSheetEl.style.transform = 'translateY(0)';\r\n  }\r\n  cleanupMerchantDrag();\r\n}\r\n\r\nfunction onMerchantDragCancel() {\r\n  if (!merchantDrag) return;\r\n  merchantDrag.canceled = true;\r\n  merchantSheetEl.style.transition = 'transform 180ms ease';\r\n  merchantSheetEl.style.transform = 'translateY(0)';\r\n  cleanupMerchantDrag();\r\n}\r\n\r\nfunction cleanupMerchantDrag() {\r\n  window.removeEventListener('pointermove', onMerchantDragMove);\r\n  window.removeEventListener('pointerup', onMerchantDragEnd);\r\n  window.removeEventListener('pointercancel', onMerchantDragCancel);\r\n  merchantDrag = null;\r\n}\r\n\r\nfunction selectMerchantTab(key) {\r\n  const def = MERCHANT_TABS_DEF.find(t => t.key === key);\r\n  const unlocked = merchantTabUnlockState.get(key);\r\n  if (!def || !unlocked) key = 'dialogue';\r\n\r\n  for (const k in merchantTabs.buttons) {\r\n    merchantTabs.buttons[k].classList.toggle('is-active', k === key);\r\n  }\r\n  for (const k in merchantTabs.panels) {\r\n    merchantTabs.panels[k].classList.toggle('is-active', k === key);\r\n  }\r\n\r\n  if (key === 'dialogue') {\r\n    try { renderDialogueList(); } catch {}\r\n  }\r\n\r\n  try { localStorage.setItem(sk(MERCHANT_TAB_KEY_BASE), key); } catch {}\r\n\r\n  requestAnimationFrame(() => {\r\n    requestAnimationFrame(() => {\r\n      const scroller = merchantOverlayEl?.querySelector(\".merchant-content\");\r\n      if (scroller && scroller.__customScroll && typeof scroller.__customScroll.updateAll === \"function\") {\r\n        scroller.__customScroll.updateAll();\r\n      } else {\r\n      }\r\n    });\r\n  });\r\n}\r\n\r\nexport function unlockMerchantTabs(keys = []) {\r\n  keys.forEach(key => setMerchantTabUnlocked(key, true));\r\n}\r\n\r\n// Expose for other modules that may build UI later\r\nexport { ensureMerchantOverlay };\r\n", "import { registerTick } from './gameLoop.js';\r\nimport { getLevelNumber, performFreeAutobuy, getUpgradesForArea, AREA_KEYS } from './upgrades.js';\r\nimport { triggerPassiveCollect } from './coinPickup.js';\r\nimport { \r\n  AUTOMATION_AREA_KEY, \r\n  EFFECTIVE_AUTO_COLLECT_ID, \r\n  AUTOBUY_COIN_UPGRADES_ID,\r\n  AUTOBUY_BOOK_UPGRADES_ID,\r\n  AUTOBUY_GOLD_UPGRADES_ID,\r\n  AUTOBUY_MAGIC_UPGRADES_ID,\r\n  AUTOBUY_WORKSHOP_LEVELS_ID\r\n} from './automationUpgrades.js';\r\nimport { performFreeGenerationUpgrade } from '../ui/merchantTabs/workshopTab.js';\r\nimport { getActiveSlot } from '../util/storage.js';\r\n\r\nlet accumulator = 0;\r\nlet autobuyIndex = 0;\r\nlet workshopTicker = 0;\r\n\r\n// Autobuyer Toggle Cache\r\n// Structure: Map<string, string> where key is the localStorage key and value is the setting ('0' or '1')\r\nconst autobuyerCache = new Map();\r\nlet cacheSlot = null;\r\n\r\nfunction ensureCacheSlot(slot) {\r\n  if (cacheSlot !== slot) {\r\n    autobuyerCache.clear();\r\n    cacheSlot = slot;\r\n  }\r\n}\r\n\r\n/**\r\n * Gets the autobuyer toggle state for a specific upgrade.\r\n * Caches the result to minimize localStorage reads.\r\n * Default is '1' (Active) if not set.\r\n */\r\nexport function getAutobuyerToggle(area, id) {\r\n  const slot = getActiveSlot();\r\n  ensureCacheSlot(slot);\r\n\r\n  const slotSuffix = slot != null ? `:${slot}` : '';\r\n  const key = `ccc:autobuy:${area}:${id}${slotSuffix}`;\r\n\r\n  if (autobuyerCache.has(key)) {\r\n    return autobuyerCache.get(key);\r\n  }\r\n\r\n  let val = '1'; // Default active\r\n  try {\r\n    const stored = localStorage.getItem(key);\r\n    if (stored !== null) val = stored;\r\n  } catch {}\r\n\r\n  autobuyerCache.set(key, val);\r\n  return val;\r\n}\r\n\r\n/**\r\n * Sets the autobuyer toggle state for a specific upgrade.\r\n * Updates both the cache and localStorage.\r\n */\r\nexport function setAutobuyerToggle(area, id, value) {\r\n  const slot = getActiveSlot();\r\n  ensureCacheSlot(slot);\r\n\r\n  const slotSuffix = slot != null ? `:${slot}` : '';\r\n  const key = `ccc:autobuy:${area}:${id}${slotSuffix}`;\r\n\r\n  const valStr = String(value);\r\n  autobuyerCache.set(key, valStr);\r\n  try {\r\n    localStorage.setItem(key, valStr);\r\n  } catch {}\r\n}\r\n\r\nfunction onTick(dt) {\r\n  updateAutomation(dt);\r\n  updateAutobuyers(dt);\r\n}\r\n\r\nfunction updateAutobuyers(dt) {\r\n  const coinAutobuy = getLevelNumber(AUTOMATION_AREA_KEY, AUTOBUY_COIN_UPGRADES_ID) > 0;\r\n  const bookAutobuy = getLevelNumber(AUTOMATION_AREA_KEY, AUTOBUY_BOOK_UPGRADES_ID) > 0;\r\n  const goldAutobuy = getLevelNumber(AUTOMATION_AREA_KEY, AUTOBUY_GOLD_UPGRADES_ID) > 0;\r\n  const magicAutobuy = getLevelNumber(AUTOMATION_AREA_KEY, AUTOBUY_MAGIC_UPGRADES_ID) > 0;\r\n  const workshopAutobuy = getLevelNumber(AUTOMATION_AREA_KEY, AUTOBUY_WORKSHOP_LEVELS_ID) > 0;\r\n\r\n  if (!coinAutobuy && !bookAutobuy && !goldAutobuy && !magicAutobuy && !workshopAutobuy) return;\r\n\r\n  const slot = getActiveSlot();\r\n  ensureCacheSlot(slot);\r\n\r\n  // Tick-sliced processing for standard upgrades\r\n  if (coinAutobuy || bookAutobuy || goldAutobuy || magicAutobuy) {\r\n    const upgrades = getUpgradesForArea(AREA_KEYS.STARTER_COVE);\r\n    if (upgrades.length > 0) {\r\n      // Process 2 upgrades per tick (20Hz) -> 40 upgrades/sec check rate\r\n      // Spreads out localStorage writes to avoid INP spikes\r\n      for (let i = 0; i < 2; i++) {\r\n        autobuyIndex = (autobuyIndex + 1) % upgrades.length;\r\n        const upg = upgrades[autobuyIndex];\r\n        \r\n        let shouldAutobuy = false;\r\n        if (upg.costType === 'coins' && coinAutobuy) shouldAutobuy = true;\r\n        else if (upg.costType === 'books' && bookAutobuy) shouldAutobuy = true;\r\n        else if (upg.costType === 'gold' && goldAutobuy) shouldAutobuy = true;\r\n        else if (upg.costType === 'magic' && magicAutobuy) shouldAutobuy = true;\r\n\r\n        if (shouldAutobuy) {\r\n          const setting = getAutobuyerToggle(AREA_KEYS.STARTER_COVE, upg.id);\r\n          if (setting !== '0') {\r\n            performFreeAutobuy(AREA_KEYS.STARTER_COVE, upg.id);\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  // Process workshop levels (throttled to ~4Hz)\r\n  if (workshopAutobuy) {\r\n    workshopTicker++;\r\n    if (workshopTicker >= 5) {\r\n      workshopTicker = 0;\r\n      const setting = getAutobuyerToggle(AUTOMATION_AREA_KEY, AUTOBUY_WORKSHOP_LEVELS_ID);\r\n      if (setting !== '0') {\r\n        performFreeGenerationUpgrade();\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nexport function updateAutomation(dt) {\r\n  const level = getLevelNumber(AUTOMATION_AREA_KEY, EFFECTIVE_AUTO_COLLECT_ID);\r\n  const rate = level; // Rate = level (coins/sec)\r\n\r\n  if (rate <= 0) {\r\n    accumulator = 0;\r\n    return;\r\n  }\r\n\r\n  accumulator += dt;\r\n  const interval = 1 / rate;\r\n\r\n  if (accumulator >= interval) {\r\n    const count = Math.floor(accumulator / interval);\r\n    if (count > 0) {\r\n      triggerPassiveCollect(count);\r\n      accumulator -= count * interval;\r\n    }\r\n  }\r\n}\r\n\r\nexport function initAutomationEffects() {\r\n  registerTick(onTick);\r\n  \r\n  // Listen for save slot changes to clear cache\r\n  if (typeof window !== 'undefined') {\r\n    window.addEventListener('saveSlot:change', (e) => {\r\n        const newSlot = e.detail?.slot;\r\n        if (newSlot && newSlot !== cacheSlot) {\r\n            autobuyerCache.clear();\r\n            cacheSlot = newSlot;\r\n        }\r\n    });\r\n  }\r\n}\r\n", "// js/ui/shopOverlay.js\r\n\r\nimport { bank, getActiveSlot } from '../util/storage.js';\r\nimport { BigNum } from '../util/bigNum.js';\r\nimport { formatNumber } from '../util/numFormat.js';\r\nimport { IS_MOBILE } from '../main.js';\r\nimport { openMerchant,\r\n    ensureMerchantOverlay,\r\n    primeTypingSfx,\r\n    unlockMerchantTabs,\r\n    hasMetMerchant,\r\n    MERCHANT_MET_EVENT\r\n} from './merchantTabs/dlgTab.js';\r\nimport { takePreloadedAudio } from '../util/audioCache.js';\r\nimport {\r\n  AREA_KEYS,\r\n  UPGRADE_TIES,\r\n  getCurrentAreaKey,\r\n  getUpgradesForArea,\r\n  getLevel,\r\n  getLevelNumber,\r\n  getIconUrl,\r\n  formatMultForUi,\r\n  upgradeUiModel,\r\n  buyOne,\r\n  buyMax,\r\n  buyTowards,\r\n  evaluateBulkPurchase,\r\n  getUpgradeLockState,\r\n  evolveUpgrade,\r\n  HM_EVOLUTION_INTERVAL,\r\n} from '../game/upgrades.js';\r\nimport {\r\n  shouldSkipGhostTap,\r\n  suppressNextGhostTap,\r\n} from '../util/ghostTapGuard.js';\r\nimport { \r\n  AUTOMATION_AREA_KEY, \r\n  AUTOBUY_COIN_UPGRADES_ID,\r\n  AUTOBUY_BOOK_UPGRADES_ID,\r\n  AUTOBUY_GOLD_UPGRADES_ID,\r\n  AUTOBUY_MAGIC_UPGRADES_ID,\r\n  AUTOBUY_WORKSHOP_LEVELS_ID,\r\n  MASTER_AUTOBUY_IDS\r\n} from '../game/automationUpgrades.js';\r\nimport { getAutobuyerToggle, setAutobuyerToggle } from '../game/automationEffects.js';\r\n\r\n// --- Shared State ---\r\nconst ICON_DIR = 'img/';\r\nconst BASE_ICON_SRC_BY_COST = {\r\n  coins: 'img/currencies/coin/coin_base.webp',\r\n  books: 'img/currencies/book/book_base.webp',\r\n  gold: 'img/currencies/gold/gold_base.webp',\r\n  magic: 'img/currencies/magic/magic_base.webp',\r\n  gears: 'img/currencies/gear/gear_base.webp',\r\n};\r\nconst LOCKED_BASE_ICON_SRC = 'img/misc/locked_base.webp';\r\nconst MAXED_BASE_OVERLAY_SRC = 'img/misc/maxed.webp';\r\nconst AUTOMATED_OVERLAY_SRC = 'img/misc/green_border.webp';\r\nconst CURRENCY_ICON_SRC = {\r\n  coins: 'img/currencies/coin/coin.webp',\r\n  books: 'img/currencies/book/book.webp',\r\n  gold: 'img/currencies/gold/gold.webp',\r\n  magic: 'img/currencies/magic/magic.webp',\r\n  gears: 'img/currencies/gear/gear.webp',\r\n};\r\n\r\nconst FORGE_UNLOCK_UPGRADE_ID = 7;\r\n\r\nconst COST_TYPE_TO_AUTO_ID = {\r\n  coins: AUTOBUY_COIN_UPGRADES_ID,\r\n  books: AUTOBUY_BOOK_UPGRADES_ID,\r\n  gold: AUTOBUY_GOLD_UPGRADES_ID,\r\n  magic: AUTOBUY_MAGIC_UPGRADES_ID\r\n};\r\n\r\nfunction isUpgradeAutomated(upgDef) {\r\n    if (!upgDef || !upgDef.costType) return false;\r\n    const autoId = COST_TYPE_TO_AUTO_ID[upgDef.costType];\r\n    if (!autoId) return false;\r\n    \r\n    // Check if player has the automation upgrade\r\n    const autoLevel = getLevelNumber(AUTOMATION_AREA_KEY, autoId);\r\n    if (autoLevel <= 0) return false;\r\n    \r\n    // Check toggle\r\n    const val = getAutobuyerToggle(upgDef.area, upgDef.id);\r\n    \r\n    // Default is ON (if not '0')\r\n    return val !== '0';\r\n}\r\n\r\n// --- Automation Mappings ---\r\n// Maps standard cost types to the ID of the automation upgrade that unlocks autobuy for them.\r\nconst COST_TYPE_TO_AUTOBUY_ID = {\r\n  coins: AUTOBUY_COIN_UPGRADES_ID,\r\n  books: AUTOBUY_BOOK_UPGRADES_ID,\r\n  gold: AUTOBUY_GOLD_UPGRADES_ID,\r\n  magic: AUTOBUY_MAGIC_UPGRADES_ID\r\n};\r\n\r\n\r\n\r\nfunction resolveUpgradeId(upgLike) {\r\n  if (!upgLike) return null;\r\n  const rawId = typeof upgLike.id !== 'undefined' ? upgLike.id : upgLike;\r\n  if (typeof rawId === 'number') {\r\n    return Number.isFinite(rawId) ? Math.trunc(rawId) : null;\r\n  }\r\n  if (typeof rawId === 'string') {\r\n    const parsed = Number.parseInt(rawId.trim(), 10);\r\n    return Number.isFinite(parsed) ? parsed : null;\r\n  }\r\n  return null;\r\n}\r\n\r\nfunction isForgeUnlockUpgrade(upgLike, mode) {\r\n  return mode === 'standard' && resolveUpgradeId(upgLike) === FORGE_UNLOCK_UPGRADE_ID;\r\n}\r\n\r\nfunction getShopUiData(areaKey) {\r\n    const defs = getUpgradesForArea(areaKey);\r\n    const upgrades = {};\r\n    for (const def of defs) {\r\n        const lvlBn = getLevel(areaKey, def.id);\r\n        const lvlNum = getLevelNumber(areaKey, def.id);\r\n        const lockState = getUpgradeLockState(areaKey, def.id);\r\n        const icon = lockState.iconOverride ?? getIconUrl(def);\r\n        const title = lockState.titleOverride ?? def.title;\r\n        const desc = lockState.descOverride ?? def.desc;\r\n        const locked = !!lockState.locked;\r\n        const hmReady = (def.upgType === 'HM')\r\n            ? !!upgradeUiModel(areaKey, def.id)?.hmReadyToEvolve\r\n            : false;\r\n        upgrades[def.id] = {\r\n            id: def.id,\r\n            icon,\r\n            title,\r\n            desc,\r\n            level: lvlBn,\r\n            levelNumeric: lvlNum,\r\n            area: def.area,\r\n            meta: def,\r\n            locked,\r\n            lockState,\r\n            useLockedBase: !!lockState.useLockedBase || locked,\r\n            baseIconOverride: def.baseIconOverride || lockState.baseIconOverride || null,\r\n            hmReady,\r\n        };\r\n    }\r\n    return upgrades;\r\n}\r\n\r\nconst SHOP_ADAPTERS = {\r\n    standard: {\r\n        title: 'Shop',\r\n        delveButtonVisible: true,\r\n        getUiData: () => getShopUiData(getCurrentAreaKey()),\r\n        getUiModel: (id) => upgradeUiModel(getCurrentAreaKey(), id),\r\n        buyOne: (id) => buyOne(getCurrentAreaKey(), id),\r\n        buyMax: (id) => buyMax(getCurrentAreaKey(), id),\r\n        buyNext: (id, amount) => buyTowards(getCurrentAreaKey(), id, amount),\r\n        getLockState: (id) => getUpgradeLockState(getCurrentAreaKey(), id),\r\n        evolve: (id) => evolveUpgrade(getCurrentAreaKey(), id),\r\n        events: ['ccc:upgrades:changed', 'currency:change', 'xp:change', 'xp:unlock', MERCHANT_MET_EVENT, 'forge:completed', 'unlock:change']\r\n    },\r\n    automation: {\r\n        title: 'Automation Shop',\r\n        delveButtonVisible: false,\r\n        getUiData: () => getShopUiData(AUTOMATION_AREA_KEY),\r\n        getUiModel: (id) => upgradeUiModel(AUTOMATION_AREA_KEY, id),\r\n        buyOne: (id) => buyOne(AUTOMATION_AREA_KEY, id),\r\n        buyMax: (id) => buyMax(AUTOMATION_AREA_KEY, id),\r\n        buyNext: (id, amount) => buyTowards(AUTOMATION_AREA_KEY, id, amount),\r\n        getLockState: (id) => getUpgradeLockState(AUTOMATION_AREA_KEY, id),\r\n        evolve: () => ({ evolved: false }),\r\n        events: ['ccc:upgrades:changed', 'currency:change']\r\n    }\r\n};\r\n\r\nfunction getAdapter(mode) {\r\n    return SHOP_ADAPTERS[mode] || SHOP_ADAPTERS.standard;\r\n}\r\n\r\nif (typeof window !== 'undefined') {\r\n  window.addEventListener('debug:change', (e) => {\r\n    const activeSlot = typeof getActiveSlot === 'function' ? getActiveSlot() : null;\r\n    const targetSlot = e?.detail?.slot ?? activeSlot;\r\n    if (activeSlot != null && targetSlot != null && activeSlot !== targetSlot) return;\r\n    updateShopOverlay(true);\r\n  });\r\n}\r\n\r\n// --- Utils ---\r\nexport function blockInteraction(ms = 140) {\r\n  if (!IS_MOBILE) return;\r\n\r\n  let shield = document.getElementById('ccc-tap-shield');\r\n  if (!shield) {\r\n    shield = document.createElement('div');\r\n    shield.id = 'ccc-tap-shield';\r\n    Object.assign(shield.style, {\r\n      position: 'fixed', inset: '0', zIndex: '2147483647',\r\n      pointerEvents: 'auto', background: 'transparent'\r\n    });\r\n    const eat = (e) => { e.stopPropagation(); e.preventDefault(); };\r\n    ['pointerdown','pointerup','click','touchstart','touchend','mousedown','mouseup']\r\n      .forEach(ev => shield.addEventListener(ev, eat, { capture: true, passive: false }));\r\n  }\r\n  document.body.appendChild(shield);\r\n  clearTimeout(shield.__t);\r\n  shield.__t = setTimeout(() => shield.remove(), ms);\r\n}\r\n\r\nfunction stripTags(html) {\r\n  return String(html ?? '').replace(/<[^>]*>/g, '');\r\n}\r\n\r\nexport function getCurrencyLabel(type, amountBn) {\r\n  if (type === 'gold') return 'Gold';\r\n  if (type === 'magic') return 'Magic';\r\n  \r\n  let isOne = false;\r\n  if (amountBn && typeof amountBn.cmp === 'function') {\r\n      isOne = !amountBn.isInfinite() && amountBn.cmp(1) === 0;\r\n  } else {\r\n      try {\r\n          const bn = BigNum.fromAny(amountBn);\r\n          isOne = !bn.isInfinite() && bn.cmp(1) === 0;\r\n      } catch {\r\n          isOne = (amountBn == 1 || amountBn === '1');\r\n      }\r\n  }\r\n\r\n  if (type === 'coins') return isOne ? 'Coin' : 'Coins';\r\n  if (type === 'books') return isOne ? 'Book' : 'Books';\r\n  if (type === 'gears') return isOne ? 'Gear' : 'Gears';\r\n  \r\n  return type ? (type.charAt(0).toUpperCase() + type.slice(1)) : '';\r\n}\r\n\r\n// --- Audio ---\r\nconst PURCHASE_SFX_SRC = 'sounds/purchase_upg.ogg';\r\nconst EVOLVE_SFX_SRC = 'sounds/evolve_upg.ogg';\r\nconst MOBILE_PURCHASE_VOLUME = 0.12;\r\nconst DESKTOP_PURCHASE_VOLUME = 0.3;\r\n\r\nfunction createSfxPlayer({ src, mobileVolume, desktopVolume }) {\r\n  let base = null;\r\n  \r\n  let ac = null;\r\n  let gain = null;\r\n  let buffer = null;\r\n  let bufferPromise = null;\r\n  let bufferPromiseHandled = false;\r\n  let pendingPlays = 0;\r\n\r\n  function ensureBase() {\r\n    if (base) return base;\r\n    const preloaded = takePreloadedAudio(src);\r\n    const el = preloaded || new Audio(src);\r\n    el.preload = 'auto';\r\n    el.playsInline = true;\r\n    el.crossOrigin = 'anonymous';\r\n    el.load?.();\r\n    base = el;\r\n    return base;\r\n  }\r\n\r\n  function ensureWebAudio() {\r\n    if (!IS_MOBILE) return false;\r\n    const baseAudio = ensureBase();\r\n    if (!baseAudio) return false;\r\n    if (!('AudioContext' in window || 'webkitAudioContext' in window)) return false;\r\n    try { ac = ac || new (window.AudioContext || window.webkitAudioContext)(); } catch (_) { ac = null; return false; }\r\n    if (!ac) return false;\r\n    if (ac.state === 'suspended') { try { ac.resume(); } catch (_) {} }\r\n    if (!gain) { gain = ac.createGain(); gain.connect(ac.destination); }\r\n    return true;\r\n  }\r\n\r\n  function ensureBuffer() {\r\n    if (!ac) return null;\r\n    if (buffer) return buffer;\r\n    if (bufferPromise) return null;\r\n    const srcUrl = ensureBase()?.currentSrc || src;\r\n    try {\r\n      bufferPromise = fetch(srcUrl)\r\n        .then((resp) => (resp.ok ? resp.arrayBuffer() : Promise.reject(resp.status)))\r\n        .then((buf) => new Promise((resolve, reject) => {\r\n          let settled = false;\r\n          ac.decodeAudioData(buf, (decoded) => { if (!settled) { settled = true; resolve(decoded); } }, (err) => { if (!settled) { settled = true; reject(err); } });\r\n        }))\r\n        .then((decoded) => { buffer = decoded; bufferPromise = null; return decoded; })\r\n        .catch(() => { bufferPromise = null; return null; });\r\n    } catch (_) { bufferPromise = null; }\r\n    return buffer || null;\r\n  }\r\n\r\n  function playMobileFallback() {\r\n    const baseAudio = ensureBase();\r\n    if (!baseAudio) return;\r\n    baseAudio.muted = false;\r\n    baseAudio.volume = mobileVolume;\r\n    try { baseAudio.currentTime = 0; } catch (_) {}\r\n    baseAudio.play().catch(() => {});\r\n  }\r\n\r\n  function playMobileWebAudio() {\r\n    if (!ensureWebAudio()) return false;\r\n    if (!ac || !gain) return false;\r\n\r\n    const playBuffer = (decoded) => {\r\n      if (!decoded) return false;\r\n      try {\r\n        const node = ac.createBufferSource();\r\n        node.buffer = decoded;\r\n        node.connect(gain);\r\n        try { gain.gain.setValueAtTime(mobileVolume, ac.currentTime); } catch (_) { gain.gain.value = mobileVolume; }\r\n        node.start();\r\n        return true;\r\n      } catch (_) { return false; }\r\n    };\r\n\r\n    if (buffer) return playBuffer(buffer);\r\n    pendingPlays += 1;\r\n    if (!bufferPromise) ensureBuffer();\r\n    \r\n    if (bufferPromise && !bufferPromiseHandled) {\r\n      bufferPromiseHandled = true;\r\n      bufferPromise.then((decoded) => {\r\n        const plays = Math.max(1, pendingPlays);\r\n        pendingPlays = 0;\r\n        if (!decoded) { for (let i = 0; i < plays; i++) playMobileFallback(); return; }\r\n        for (let i = 0; i < plays; i++) { if (!playBuffer(decoded)) { playMobileFallback(); break; } }\r\n      });\r\n    }\r\n    return true;\r\n  }\r\n\r\n  return {\r\n    play() {\r\n      try {\r\n        if (IS_MOBILE) {\r\n          if (playMobileWebAudio()) return;\r\n          playMobileFallback();\r\n          return;\r\n        }\r\n        const baseAudio = ensureBase();\r\n        if (baseAudio) {\r\n           baseAudio.volume = desktopVolume;\r\n           const a = baseAudio.cloneNode();\r\n           a.volume = desktopVolume;\r\n           a.play().catch(() => {});\r\n        }\r\n      } catch {}\r\n    },\r\n  };\r\n}\r\n\r\nconst purchaseSfx = createSfxPlayer({ src: PURCHASE_SFX_SRC, mobileVolume: MOBILE_PURCHASE_VOLUME, desktopVolume: DESKTOP_PURCHASE_VOLUME });\r\nconst evolveSfx = createSfxPlayer({ src: EVOLVE_SFX_SRC, mobileVolume: MOBILE_PURCHASE_VOLUME * 2, desktopVolume: DESKTOP_PURCHASE_VOLUME * 2 });\r\n\r\nexport function playPurchaseSfx() { purchaseSfx.play(); }\r\nfunction playEvolveSfx() { evolveSfx.play(); }\r\n\r\nfunction currencyIconHTML(type) {\r\n  const src = CURRENCY_ICON_SRC[type] || CURRENCY_ICON_SRC.coins;\r\n  return `<img alt=\"\" src=\"${src}\" class=\"currency-ico\">`;\r\n}\r\n\r\n// 1\u00D71 transparent WebP\r\nconst TRANSPARENT_PX = \"data:image/webp;base64,UklGRhIAAABXRUJQVlA4IBgAAAAwAQCdASoIAAIAAAAcJaQAA3AA\";\r\n\r\n// --- Custom Scrollbar ---\r\nexport function ensureCustomScrollbar(overlayEl, sheetEl, scrollerSelector = '.shop-scroller') {\r\n  const scroller = overlayEl?.querySelector(scrollerSelector);\r\n  if (!scroller || scroller.__customScroll) return;\r\n\r\n  const bar = document.createElement('div');\r\n  bar.className = 'shop-scrollbar';\r\n  const thumb = document.createElement('div');\r\n  thumb.className = 'shop-scrollbar__thumb';\r\n  bar.appendChild(thumb);\r\n  sheetEl.appendChild(bar);\r\n\r\n  scroller.__customScroll = { bar, thumb };\r\n\r\n  const isTouch = window.matchMedia('(hover: none) and (pointer: coarse)').matches;\r\n  const FADE_SCROLL_MS = 150;\r\n  const FADE_DRAG_MS = 120;\r\n  const supportsScrollEnd = 'onscrollend' in window;\r\n\r\n  const syncScrollShadow = () => {\r\n    const hasShadow = (scroller.scrollTop || 0) > 0;\r\n    sheetEl?.classList.toggle('has-scroll-shadow', hasShadow);\r\n  };\r\n\r\n  const updateBounds = () => {\r\n    if (!scroller.isConnected || !sheetEl.isConnected) return;\r\n    const scrollerRect = scroller.getBoundingClientRect();\r\n    const sheetRect = sheetEl.getBoundingClientRect();\r\n    const top = Math.max(0, scrollerRect.top - sheetRect.top);\r\n    const bottom = Math.max(0, sheetRect.bottom - scrollerRect.bottom);\r\n    bar.style.top = top + 'px';\r\n    bar.style.bottom = bottom + 'px';\r\n  };\r\n\r\n  const updateThumb = () => {\r\n    const { scrollHeight, clientHeight, scrollTop } = scroller;\r\n    const barH = bar.clientHeight || scroller.clientHeight;\r\n    const visibleRatio = clientHeight / Math.max(1, scrollHeight);\r\n    const thumbH = Math.max(28, Math.round(barH * visibleRatio));\r\n    const maxScroll = Math.max(1, scrollHeight - clientHeight);\r\n    const range = Math.max(0, barH - thumbH);\r\n    const y = Math.round((scrollTop / maxScroll) * range);\r\n    thumb.style.height = thumbH + 'px';\r\n    thumb.style.transform = `translateY(${y}px)`;\r\n    bar.style.display = (scrollHeight <= clientHeight + 1) ? 'none' : '';\r\n  };\r\n\r\n  const updateAll = () => { updateBounds(); updateThumb(); syncScrollShadow(); };\r\n  const showBar = () => { if (!isTouch) return; sheetEl.classList.add('is-scrolling'); clearTimeout(scroller.__fadeTimer); };\r\n  const scheduleHide = (delay) => { if (!isTouch) return; clearTimeout(scroller.__fadeTimer); scroller.__fadeTimer = setTimeout(() => { sheetEl.classList.remove('is-scrolling'); }, delay); };\r\n  const onScroll = () => { updateThumb(); syncScrollShadow(); if (isTouch) showBar(); if (!supportsScrollEnd) scheduleHide(FADE_SCROLL_MS); };\r\n  const onScrollEnd = () => scheduleHide(FADE_SCROLL_MS);\r\n\r\n  scroller.addEventListener('scroll', onScroll, { passive: true });\r\n  if (supportsScrollEnd) scroller.addEventListener('scrollend', onScrollEnd, { passive: true });\r\n\r\n  const ro = new ResizeObserver(updateAll);\r\n  ro.observe(scroller);\r\n  window.addEventListener('resize', updateAll);\r\n  requestAnimationFrame(updateAll);\r\n\r\n  // Drag logic omitted for brevity as it's purely UI polish, but we can keep it if space permits.\r\n  // ...Keeping logic...\r\n  let dragging = false;\r\n  let dragStartY = 0;\r\n  let startScrollTop = 0;\r\n  const startDrag = (e) => { dragging = true; dragStartY = e.clientY; startScrollTop = scroller.scrollTop; thumb.classList.add('dragging'); showBar(); try { thumb.setPointerCapture(e.pointerId); } catch {} e.preventDefault(); };\r\n  const onDragMove = (e) => { if (!dragging) return; const range = Math.max(1, bar.clientHeight - thumb.clientHeight); const scrollMax = Math.max(1, scroller.scrollHeight - scroller.clientHeight); const deltaY = e.clientY - dragStartY; scroller.scrollTop = startScrollTop + (deltaY / range) * scrollMax; };\r\n  const endDrag = (e) => { if (!dragging) return; dragging = false; thumb.classList.remove('dragging'); scheduleHide(FADE_DRAG_MS); try { thumb.releasePointerCapture(e.pointerId); } catch {} };\r\n  thumb.addEventListener('pointerdown', startDrag);\r\n  window.addEventListener('pointermove', onDragMove, { passive: true });\r\n  window.addEventListener('pointerup', endDrag);\r\n  window.addEventListener('pointercancel', endDrag);\r\n  \r\n  bar.addEventListener('pointerdown', (e) => { if (e.target === thumb) return; const rect = bar.getBoundingClientRect(); const clickY = e.clientY - rect.top; const thH = thumb.clientHeight; const range = Math.max(0, bar.clientHeight - thH); const targetY = Math.max(0, Math.min(clickY - thH / 2, range)); const scrollMax = Math.max(1, scroller.scrollHeight - scroller.clientHeight); scroller.scrollTop = (targetY / Math.max(1, range)) * scrollMax; showBar(); scheduleHide(FADE_SCROLL_MS); });\r\n\r\n  updateAll();\r\n}\r\n\r\n// --- Logic Helpers ---\r\nfunction levelsRemainingToCap(upg, currentLevelBn, currentLevelNumber) {\r\n  if (!upg) return BigNum.fromInt(0);\r\n  const capBn = upg.lvlCapBn?.clone?.() ?? (Number.isFinite(upg.lvlCap) ? BigNum.fromAny(upg.lvlCap) : null);\r\n  if (!capBn) return BigNum.fromInt(0);\r\n  if (capBn.isInfinite?.()) return BigNum.fromAny('Infinity');\r\n\r\n  let lvlBn;\r\n  try { lvlBn = currentLevelBn instanceof BigNum ? currentLevelBn : BigNum.fromAny(currentLevelBn ?? currentLevelNumber ?? 0); } \r\n  catch { const fallback = Math.max(0, Math.floor(Number(currentLevelNumber) || 0)); lvlBn = BigNum.fromInt(fallback); }\r\n  \r\n  if (lvlBn.isInfinite?.()) return BigNum.fromInt(0);\r\n  try {\r\n    const capPlain = capBn.toPlainIntegerString?.();\r\n    const lvlPlain = lvlBn.toPlainIntegerString?.();\r\n    if (capPlain === 'Infinity') return BigNum.fromAny('Infinity');\r\n    if (capPlain && lvlPlain && capPlain !== 'Infinity' && lvlPlain !== 'Infinity') {\r\n      const delta = BigInt(capPlain) - BigInt(lvlPlain);\r\n      if (delta > 0n) return BigNum.fromAny(delta.toString());\r\n      return BigNum.fromInt(0);\r\n    }\r\n  } catch {}\r\n  \r\n  const capNumber = Number.isFinite(upg.lvlCap) ? Math.max(0, Math.floor(upg.lvlCap)) : Infinity;\r\n  if (!Number.isFinite(capNumber)) return BigNum.fromAny('Infinity');\r\n  const lvlNumber = Math.max(0, Math.floor(Number(currentLevelNumber) || 0));\r\n  const room = Math.max(0, capNumber - lvlNumber);\r\n  return BigNum.fromInt(room);\r\n}\r\n\r\nfunction computeAffordableLevels(upg, currentLevelNumeric, currentLevelBn) {\r\n  let lvlBn;\r\n  try { lvlBn = currentLevelBn instanceof BigNum ? currentLevelBn : BigNum.fromAny(currentLevelBn ?? currentLevelNumeric ?? 0); }\r\n  catch { const fallback = Math.max(0, Math.floor(Number(currentLevelNumeric) || 0)); lvlBn = BigNum.fromInt(fallback); }\r\n  if (lvlBn.isInfinite?.()) return BigNum.fromInt(0);\r\n\r\n  const lvl = Math.max(0, Math.floor(Number(currentLevelNumeric) || 0));\r\n  const cap = Number.isFinite(upg.lvlCap) ? Math.max(0, Math.floor(upg.lvlCap)) : Infinity;\r\n\r\n  const walletEntry = bank[upg.costType];\r\n  const walletValue = walletEntry?.value;\r\n  const walletBn = walletValue instanceof BigNum ? walletValue : BigNum.fromAny(walletValue ?? 0);\r\n  if (walletBn.isZero?.()) return BigNum.fromInt(0);\r\n\r\n  if (walletBn.isInfinite?.()) {\r\n    const isHmType = upg?.upgType === 'HM';\r\n    const maxed = Number.isFinite(cap) && lvl >= cap;\r\n    if ((isHmType && !maxed) || !Number.isFinite(cap)) return BigNum.fromAny('Infinity');\r\n    return levelsRemainingToCap(upg, lvlBn, currentLevelNumeric);\r\n  }\r\n  if (Number.isFinite(cap) && lvl >= cap) return BigNum.fromInt(0);\r\n\r\n  try {\r\n    if (typeof upg.costAtLevel === 'function') {\r\n        const c0 = BigNum.fromAny(upg.costAtLevel(lvl));\r\n        const c1 = BigNum.fromAny(upg.costAtLevel(lvl + 1)); \r\n        const farProbeLevel = Math.min(Number.isFinite(cap) ? cap : lvl + 32, lvl + 32);\r\n        const cFar = BigNum.fromAny(upg.costAtLevel(farProbeLevel));\r\n        const isTrulyFlat = c0.cmp(c1) === 0 && c0.cmp(cFar) === 0;\r\n\r\n        if (isTrulyFlat) {\r\n          const remainingBn = levelsRemainingToCap(upg, lvlBn, lvl);\r\n          const room = Number.isFinite(upg.lvlCap) ? Math.min(Math.max(0, Math.floor(Number(remainingBn.toString()))), Number.MAX_SAFE_INTEGER - 2) : Number.MAX_SAFE_INTEGER;\r\n          let lo = 0, hi = Math.max(0, room);\r\n          while (lo < hi) {\r\n            const mid = Math.floor((lo + hi + 1) / 2);\r\n            const midBn = BigNum.fromInt(mid);\r\n            const total = typeof c0.mulBigNumInteger === 'function' ? c0.mulBigNumInteger(midBn) : BigNum.fromAny(c0 ?? 0).mulBigNumInteger(midBn);\r\n            if (total.cmp(walletBn) <= 0) lo = mid; else hi = mid - 1;\r\n          }\r\n          return BigNum.fromInt(lo);\r\n        }\r\n    }\r\n  } catch {}\r\n  \r\n  const room = Number.isFinite(cap) ? Math.max(0, cap - lvl) : undefined;\r\n  const { count } = evaluateBulkPurchase(upg, lvlBn, walletBn, room, { fastOnly: true });\r\n  return count ?? BigNum.fromInt(0);\r\n}\r\n\r\n// --- Shop Instance Class ---\r\n\r\nclass ShopInstance {\r\n    constructor(mode) {\r\n        this.mode = mode;\r\n        this.overlayEl = null;\r\n        this.sheetEl = null;\r\n        this.isOpen = false;\r\n        this.eventsBound = false;\r\n        this.closeTimer = null;\r\n        this.postOpenPointer = false;\r\n        this.upgrades = {};\r\n        this.delveBtnEl = null;\r\n        this.updateHandler = this.update.bind(this);\r\n    }\r\n    \r\n    get adapter() {\r\n        return getAdapter(this.mode);\r\n    }\r\n    \r\n    get delveButtonVisible() {\r\n        return this.adapter.delveButtonVisible;\r\n    }\r\n    \r\n    updateDelveGlow() {\r\n        if (!this.delveBtnEl || this.mode !== 'standard') return;\r\n        const met = hasMetMerchant();\r\n        this.delveBtnEl.classList.toggle('is-new', !met);\r\n    }\r\n\r\n    buildUpgradesData() {\r\n        this.upgrades = this.adapter.getUiData();\r\n    }\r\n    \r\n    render() {\r\n        const grid = this.overlayEl?.querySelector('.shop-grid');\r\n        if (!grid) return;\r\n        \r\n        const seenIds = new Set();\r\n        \r\n        for (const key in this.upgrades) {\r\n            const upg = this.upgrades[key];\r\n            seenIds.add(String(upg.id));\r\n            \r\n            let btn = grid.querySelector(`.shop-upgrade[data-upg-id=\"${upg.id}\"]`);\r\n            if (!btn) {\r\n                btn = document.createElement('button');\r\n                btn.className = 'shop-upgrade';\r\n                btn.setAttribute('data-upgid', upg.id);\r\n                btn.type = 'button';\r\n                btn.setAttribute('role', 'gridcell');\r\n                btn.dataset.upgId = String(upg.id);\r\n                \r\n                const tile = document.createElement('div');\r\n                tile.className = 'shop-tile';\r\n                const baseImg = document.createElement('img');\r\n                baseImg.className = 'base';\r\n                baseImg.alt = '';\r\n                const iconImg = document.createElement('img');\r\n                iconImg.className = 'icon';\r\n                iconImg.alt = '';\r\n                iconImg.addEventListener('error', () => { iconImg.src = TRANSPARENT_PX; });\r\n                \r\n                tile.appendChild(baseImg);\r\n                tile.appendChild(iconImg);\r\n                btn.appendChild(tile);\r\n                grid.appendChild(btn);\r\n                \r\n                // Listeners\r\n                btn.addEventListener('click', (event) => {\r\n                    const el = event.currentTarget;\r\n                    if (el.disabled || el.dataset.lockedPlain === '1') {\r\n                        event.preventDefault();\r\n                        event.stopImmediatePropagation();\r\n                        return;\r\n                    }\r\n                    if (shouldSkipGhostTap(el)) {\r\n                        event.preventDefault();\r\n                        event.stopImmediatePropagation();\r\n                        return;\r\n                    }\r\n                    if (el.upgMeta) openUpgradeOverlay(el.upgMeta, this.mode);\r\n                });\r\n                \r\n                btn.addEventListener('contextmenu', (e) => {\r\n                    if (IS_MOBILE) return;\r\n                    const el = e.currentTarget;\r\n                    if (el.dataset.locked === '1') return;\r\n                    e.preventDefault();\r\n                    e.stopPropagation();\r\n                    \r\n                    if (!el.upgMeta) return;\r\n\t\t\t\t\t\r\n                    const model = this.adapter.getUiModel(el.upgMeta.id);\r\n                    if (model?.hmReadyToEvolve) {\r\n                        const { evolved } = this.adapter.evolve(el.upgMeta.id);\r\n                        if (evolved) {\r\n                            playEvolveSfx();\r\n                            this.update();\r\n                        }\r\n                        return;\r\n                    }\r\n\t\t\t\t\t\r\n                    const { bought } = this.adapter.buyMax(el.upgMeta.id);\r\n                    const boughtBn = bought instanceof BigNum ? bought : BigNum.fromAny(bought ?? 0);\r\n                    \r\n                    if (!boughtBn.isZero?.()) {\r\n                        playPurchaseSfx();\r\n                        if (isForgeUnlockUpgrade(el.upgMeta, this.mode)) {\r\n                            try { unlockMerchantTabs(['reset']); } catch {}\r\n                        }\r\n                        this.update();\r\n                    }\r\n                });\r\n            }\r\n            \r\n            // Update Meta\r\n            btn.upgMeta = upg.meta;\r\n            \r\n            // Logic derived from original renderShopGrid...\r\n            const locked = !!upg.locked;\r\n            const lockIcon = upg.lockState?.iconOverride;\r\n            const hasMysteriousIcon = typeof lockIcon === 'string' && lockIcon.includes('mysterious');\r\n            const isMysterious = locked && (upg.lockState?.hidden || hasMysteriousIcon);\r\n            const isPlainLocked = locked && !isMysterious;\r\n\r\n            btn.classList.toggle('is-locked', locked);\r\n            btn.classList.toggle('is-locked-plain', isPlainLocked);\r\n            btn.disabled = isPlainLocked;\r\n            if (isPlainLocked) {\r\n              btn.setAttribute('aria-disabled', 'true');\r\n              btn.setAttribute('tabindex', '-1');\r\n            } else {\r\n              btn.removeAttribute('aria-disabled');\r\n              btn.removeAttribute('tabindex');\r\n            }\r\n            btn.dataset.locked = locked ? '1' : '0';\r\n            btn.dataset.lockedPlain = isPlainLocked ? '1' : '0';\r\n            btn.dataset.mysterious = isMysterious ? '1' : '0';\r\n\r\n            const isHM = upg.meta?.upgType === 'HM';\r\n            const evolveReady = isHM && upg.hmReady;\r\n            btn.classList.toggle('hm-evolve-ready', evolveReady);\r\n            \r\n            const canPlusBn = locked ? BigNum.fromInt(0) : computeAffordableLevels(upg.meta, upg.levelNumeric, upg.level);\r\n            const plusBn = canPlusBn instanceof BigNum ? canPlusBn : BigNum.fromAny(canPlusBn);\r\n            const levelHtml = formatNumber(upg.level);\r\n            const levelPlain = stripTags(levelHtml);\r\n            const plusHtml = formatNumber(plusBn);\r\n            const plusPlain = stripTags(plusHtml);\r\n            const hasPlus = !plusBn.isZero?.();\r\n            \r\n            const rawCap = Number.isFinite(upg.lvlCap) ? upg.lvlCap : (Number.isFinite(upg.meta?.lvlCap) ? upg.meta.lvlCap : Infinity);\r\n            const capNumber = Number.isFinite(rawCap) ? Math.max(0, Math.floor(rawCap)) : Infinity;\r\n            const levelNumber = Number.isFinite(upg.levelNumeric) ? upg.levelNumeric : NaN;\r\n            const capReached = evolveReady ? false : (upg.level?.isInfinite?.() ? true : (Number.isFinite(capNumber) && Number.isFinite(levelNumber) ? levelNumber >= capNumber : false));\r\n            \r\n            const isSingleLevelCap = Number.isFinite(capNumber) && capNumber === 1;\r\n            const isUnlockUpgrade = !!upg.meta?.unlockUpgrade;\r\n            const showUnlockableBadge = !locked && isUnlockUpgrade && !capReached;\r\n            const showUnlockedBadge = !locked && isUnlockUpgrade && !showUnlockableBadge && capReached;\r\n\r\n            let badgeHtml, badgePlain, needsTwoLines = false, isTextBadge = false;\r\n\r\n            if (locked) {\r\n                badgeHtml = ''; badgePlain = '';\r\n                const reason = isMysterious ? (upg.lockState?.reason || '').trim() : '';\r\n                const ariaLabel = reason ? `${upg.title} (Locked, ${reason})` : `${upg.title} (Locked)`;\r\n                btn.setAttribute('aria-label', ariaLabel);\r\n            } else {\r\n                if (showUnlockableBadge || showUnlockedBadge) {\r\n                    badgeHtml = showUnlockableBadge ? 'Unlockable' : 'Unlocked';\r\n                    badgePlain = badgeHtml;\r\n                    isTextBadge = true;\r\n                } else if (!locked && isSingleLevelCap && !isUnlockUpgrade) {\r\n                    if (capReached) { badgeHtml = 'Owned'; badgePlain = 'Owned'; }\r\n                    else if (hasPlus) { badgeHtml = 'Purchasable'; badgePlain = 'Purchasable'; }\r\n                    else { badgeHtml = 'Not Owned'; badgePlain = 'Not Owned'; }\r\n                    isTextBadge = true;\r\n                } else {\r\n                    const numericLevel = Number.isFinite(upg.levelNumeric) ? upg.levelNumeric : NaN;\r\n                    const plainDigits = String(levelPlain || '').replace(/,/g, '');\r\n                    const isInf = /\u221E|Infinity/i.test(plainDigits);\r\n                    const over999 = Number.isFinite(numericLevel) ? numericLevel >= 1000 : (isInf || /^\\d{4,}$/.test(plainDigits));\r\n                    needsTwoLines = hasPlus && over999;\r\n                    if (needsTwoLines) {\r\n                        badgeHtml = `<span class=\"badge-lvl\">${levelHtml}</span><span class=\"badge-plus\">(+${plusHtml})</span>`;\r\n                        badgePlain = `${levelPlain} (+${plusPlain})`;\r\n                    } else {\r\n                        badgeHtml = hasPlus ? `${levelHtml} (+${plusHtml})` : levelHtml;\r\n                        badgePlain = hasPlus ? `${levelPlain} (+${plusPlain})` : levelPlain;\r\n                    }\r\n                }\r\n                btn.setAttribute('aria-label', `${upg.title}, ${badgePlain}`);\r\n            }\r\n            \r\n            if (locked) btn.title = isMysterious ? 'Hidden Upgrade' : 'Locked Upgrade';\r\n            else if (upg.meta?.unlockUpgrade) btn.title = 'Left-click: Details \u2022 Right-click: Unlock';\r\n            else btn.title = 'Left-click: Details \u2022 Right-click: Buy Max';\r\n            \r\n            // DOM Structure Update\r\n            const tileEl = btn.firstElementChild;\r\n            const baseImgEl = tileEl.querySelector('.base');\r\n            const iconImgEl = tileEl.querySelector('.icon');\r\n            \r\n            const costType = upg.meta?.costType || 'coins';\r\n            const useLockedBase = upg.useLockedBase || locked;\r\n            const baseSrc = useLockedBase ? LOCKED_BASE_ICON_SRC : (upg.baseIconOverride || BASE_ICON_SRC_BY_COST[costType] || BASE_ICON_SRC_BY_COST.coins);\r\n            if (baseImgEl.src !== baseSrc) baseImgEl.src = baseSrc;\r\n            \r\n            const rawIcon = upg.icon;\r\n            if (!rawIcon) {\r\n                if (!iconImgEl.hidden) iconImgEl.hidden = true;\r\n            } else {\r\n                if (iconImgEl.hidden) iconImgEl.hidden = false;\r\n                const iconSrc = rawIcon;\r\n                if (iconImgEl._lastSrc !== iconSrc) { iconImgEl.src = iconSrc; iconImgEl._lastSrc = iconSrc; }\r\n            }\r\n            \r\n            let maxedOverlay = tileEl.querySelector('.maxed-overlay');\r\n            const isAutomated = !locked && isUpgradeAutomated(upg.meta);\r\n            const showMaxed = !locked && capReached;\r\n            const showAutomated = !locked && !capReached && !evolveReady && isAutomated;\r\n\r\n            if (showMaxed || showAutomated) {\r\n                if (!maxedOverlay) {\r\n                    maxedOverlay = document.createElement('img');\r\n                    maxedOverlay.className = 'maxed-overlay';\r\n                    maxedOverlay.alt = '';\r\n                    tileEl.insertBefore(maxedOverlay, iconImgEl);\r\n                }\r\n\t\t\t\tconst targetSrc = showMaxed ? MAXED_BASE_OVERLAY_SRC : AUTOMATED_OVERLAY_SRC;\r\n                if (maxedOverlay.src !== targetSrc) maxedOverlay.src = targetSrc;\r\n            } else if (maxedOverlay) maxedOverlay.remove();\r\n            \r\n            let badge = tileEl.querySelector('.level-badge');\r\n            if (!locked) {\r\n                if (!badge) { badge = document.createElement('span'); badge.className = 'level-badge'; tileEl.appendChild(badge); }\r\n                badge.className = 'level-badge';\r\n                if (isTextBadge) badge.classList.add('text-badge');\r\n                if (needsTwoLines) badge.classList.add('two-line');\r\n                if (hasPlus || showUnlockableBadge) badge.classList.add('can-buy');\r\n                if (capReached) badge.classList.add('is-maxed');\r\n                if (badgeHtml === badgePlain) { if (badge.textContent !== badgeHtml) badge.textContent = badgeHtml; }\r\n                else { if (badge.innerHTML !== badgeHtml) badge.innerHTML = badgeHtml; }\r\n            } else if (badge) badge.remove();\r\n        }\r\n        \r\n        // Cleanup stale\r\n        Array.from(grid.children).forEach(child => {\r\n            if (child.dataset.upgId && !seenIds.has(child.dataset.upgId)) child.remove();\r\n        });\r\n    }\r\n\r\n    ensureOverlay() {\r\n        if (this.overlayEl) return;\r\n        \r\n        this.overlayEl = document.createElement('div');\r\n        this.overlayEl.className = 'shop-overlay';\r\n        if (this.mode === 'automation') {\r\n            this.overlayEl.classList.add('automation-shop-overlay');\r\n            // Unique ID not strictly required by CSS but useful\r\n            this.overlayEl.id = 'automation-shop-overlay'; \r\n        } else {\r\n            this.overlayEl.id = 'shop-overlay';\r\n        }\r\n        \r\n        this.sheetEl = document.createElement('div');\r\n        this.sheetEl.className = 'shop-sheet';\r\n        this.sheetEl.setAttribute('role', 'dialog');\r\n        \r\n        const grabber = document.createElement('div');\r\n        grabber.className = 'shop-grabber';\r\n        grabber.innerHTML = `<div class=\"grab-handle\" aria-hidden=\"true\"></div>`;\r\n        \r\n        const content = document.createElement('div');\r\n        content.className = 'shop-content';\r\n        \r\n        const header = document.createElement('header');\r\n        header.className = 'shop-header';\r\n        header.innerHTML = `<div class=\"shop-title\">${this.adapter.title}</div><div class=\"shop-line\" aria-hidden=\"true\"></div>`;\r\n        \r\n        const grid = document.createElement('div');\r\n        grid.className = 'shop-grid';\r\n        if (this.mode === 'standard') grid.id = 'shop-grid'; // backwards compat for ID query\r\n        grid.setAttribute('role', 'grid');\r\n        \r\n        const scroller = document.createElement('div');\r\n        scroller.className = 'shop-scroller';\r\n        scroller.appendChild(grid);\r\n        \r\n        content.append(header, scroller);\r\n        ensureCustomScrollbar(this.overlayEl, this.sheetEl, '.shop-scroller');\r\n        \r\n        const actions = document.createElement('div');\r\n        actions.className = 'shop-actions';\r\n        \r\n        const closeBtn = document.createElement('button');\r\n        closeBtn.type = 'button';\r\n        closeBtn.className = 'shop-close';\r\n        closeBtn.textContent = 'Close';\r\n        \r\n        actions.appendChild(closeBtn);\r\n        \r\n        if (this.delveButtonVisible) {\r\n            const delveBtn = document.createElement('button');\r\n            delveBtn.type = 'button';\r\n            delveBtn.className = 'shop-delve';\r\n            delveBtn.textContent = 'Delve';\r\n            delveBtn.addEventListener('click', (e) => {\r\n                if (e && e.isTrusted && shouldSkipGhostTap(delveBtn)) return;\r\n                primeTypingSfx();\r\n                openMerchant();\r\n            });\r\n            this.delveBtnEl = delveBtn;\r\n            this.updateDelveGlow();\r\n            actions.append(delveBtn);\r\n        }\r\n        \r\n        this.sheetEl.append(grabber, content, actions);\r\n        this.overlayEl.appendChild(this.sheetEl);\r\n        document.body.appendChild(this.overlayEl);\r\n        \r\n        // Listeners\r\n        this.overlayEl.addEventListener('pointerdown', (e) => {\r\n            if (e.pointerType === 'mouse') return;\r\n            this.postOpenPointer = true;\r\n        }, { capture: true, passive: true });\r\n        \r\n        this.overlayEl.addEventListener('touchstart', (e) => {\r\n             this.postOpenPointer = true;\r\n        }, { capture: true, passive: true });\r\n        \r\n        this.overlayEl.addEventListener('click', (e) => {\r\n            if (!IS_MOBILE) return;\r\n            if (!this.postOpenPointer) {\r\n                e.preventDefault(); e.stopImmediatePropagation();\r\n                return;\r\n            }\r\n        }, { capture: true });\r\n        \r\n        closeBtn.addEventListener('click', () => {\r\n             if (IS_MOBILE) blockInteraction(80);\r\n             this.close();\r\n        }, { passive: true });\r\n        \r\n        setupDragToClose(grabber, this.sheetEl, () => this.isOpen, () => {\r\n             this.isOpen = false;\r\n             this.closeTimer = setTimeout(() => {\r\n                 this.closeTimer = null;\r\n                 this.close(true);\r\n             }, 150);\r\n        });\r\n        \r\n        this.update(true);\r\n    }\r\n    \r\n    open() {\r\n        this.ensureOverlay();\r\n        \r\n        if (this.closeTimer) { clearTimeout(this.closeTimer); this.closeTimer = null; }\r\n        \r\n        // Bind events if needed\r\n        if (!this.eventsBound) {\r\n            this.adapter.events.forEach(evt => window.addEventListener(evt, this.updateHandler));\r\n            if (this.mode === 'standard') {\r\n                document.addEventListener('ccc:upgrades:changed', this.updateHandler);\r\n            }\r\n            this.eventsBound = true;\r\n        }\r\n        \r\n        this.update(true);\r\n        if (this.isOpen) return;\r\n        \r\n        this.isOpen = true;\r\n        this.sheetEl.style.transition = 'none';\r\n        this.sheetEl.style.transform = 'translateY(100%)';\r\n        this.overlayEl.style.pointerEvents = 'auto';\r\n        \r\n        void this.sheetEl.offsetHeight;\r\n        \r\n        requestAnimationFrame(() => {\r\n            requestAnimationFrame(() => {\r\n                this.sheetEl.style.transition = '';\r\n                this.sheetEl.style.transform = '';\r\n                this.overlayEl.classList.add('is-open');\r\n                this.postOpenPointer = false;\r\n                \r\n                if (IS_MOBILE) {\r\n                    try { setTimeout(() => suppressNextGhostTap(240), 120); } catch {}\r\n                }\r\n                \r\n                blockInteraction(10);\r\n                ensureCustomScrollbar(this.overlayEl, this.sheetEl);\r\n                \r\n                const focusable = this.overlayEl.querySelector('.shop-upgrade') || this.overlayEl.querySelector('.shop-grid');\r\n                if (focusable) focusable.focus();\r\n            });\r\n        });\r\n    }\r\n    \r\n    close(force = false) {\r\n        const forceClose = force === true;\r\n        const overlayOpen = this.overlayEl?.classList?.contains('is-open');\r\n        \r\n        if (!forceClose && !this.isOpen && !overlayOpen) {\r\n            if (this.closeTimer) { clearTimeout(this.closeTimer); this.closeTimer = null; }\r\n            return;\r\n        }\r\n        \r\n        if (this.closeTimer) { clearTimeout(this.closeTimer); this.closeTimer = null; }\r\n        \r\n        this.isOpen = false;\r\n        if (this.sheetEl) {\r\n            this.sheetEl.style.transition = '';\r\n            this.sheetEl.style.transform = '';\r\n        }\r\n        if (this.overlayEl) {\r\n            this.overlayEl.classList.remove('is-open');\r\n            this.overlayEl.style.pointerEvents = 'none';\r\n        }\r\n        this.postOpenPointer = false;\r\n        \r\n        if (this.eventsBound) {\r\n             this.adapter.events.forEach(evt => window.removeEventListener(evt, this.updateHandler));\r\n             if (this.mode === 'standard') {\r\n                 document.removeEventListener('ccc:upgrades:changed', this.updateHandler);\r\n             }\r\n             this.eventsBound = false;\r\n        }\r\n    }\r\n    \r\n    update(force = false) {\r\n        if (!force && !this.isOpen) return;\r\n        this.buildUpgradesData();\r\n        this.render();\r\n        this.updateDelveGlow();\r\n    }\r\n}\r\n\r\n// --- Static Instances ---\r\nconst shops = {\r\n    standard: new ShopInstance('standard'),\r\n    automation: new ShopInstance('automation')\r\n};\r\n\r\nexport function openShop(mode = 'standard') {\r\n    const instance = shops[mode] || shops.standard;\r\n    instance.open();\r\n}\r\n\r\nexport function closeShop(force = false) {\r\n    // Attempt to close all open shops\r\n    Object.values(shops).forEach(s => s.close(force));\r\n}\r\n\r\nexport function updateShopOverlay(force = false) {\r\n    // Update all open shops\r\n    Object.values(shops).forEach(s => s.update(force));\r\n}\r\n\r\nexport function setUpgradeCount() { updateShopOverlay(true); }\r\n\r\nexport function getUpgrades() { \r\n    // Return standard upgrades for backward compat? \r\n    // Or merge? getUpgrades was previously only returning current adapter data.\r\n    // If standard is open, return standard. If automation is open, return automation.\r\n    // If both, prioritizing automation makes sense? \r\n    // Or standard is \"main\" upgrades.\r\n    // Let's assume this is mostly for standard shop.\r\n    return shops.standard.upgrades;\r\n}\r\n\r\n// --- Upgrade Overlay (Shared) ---\r\nlet upgOverlayEl = null;\r\nlet upgSheetEl = null;\r\nlet upgOpen = false;\r\nlet upgOverlayCleanup = null;\r\n\r\nfunction ensureUpgradeOverlay() {\r\n  if (upgOverlayEl) return;\r\n  upgOverlayEl = document.createElement('div');\r\n  upgOverlayEl.className = 'upg-overlay';\r\n\r\n  upgSheetEl = document.createElement('div');\r\n  upgSheetEl.className = 'upg-sheet';\r\n  upgSheetEl.setAttribute('role', 'dialog');\r\n  upgSheetEl.setAttribute('aria-modal', 'false');\r\n  upgSheetEl.setAttribute('aria-label', 'Upgrade');\r\n\r\n  const grab = document.createElement('div');\r\n  grab.className = 'upg-grabber';\r\n  grab.innerHTML = `<div class=\"grab-handle\" aria-hidden=\"true\"></div>`;\r\n\r\n  const header = document.createElement('header');\r\n  header.className = 'upg-header';\r\n  const content = document.createElement('div');\r\n  content.className = 'upg-content';\r\n  const actions = document.createElement('div');\r\n  actions.className = 'upg-actions';\r\n\r\n  upgSheetEl.append(grab, header, content, actions);\r\n  upgOverlayEl.appendChild(upgSheetEl);\r\n  document.body.appendChild(upgOverlayEl);\r\n\r\n  upgOverlayEl.addEventListener('pointerdown', (e) => {\r\n    if (!IS_MOBILE) return;\r\n    if (e.pointerType === 'mouse') return;\r\n    if (e.target === upgOverlayEl) { e.preventDefault(); e.stopPropagation(); }\r\n  }, true);\r\n  upgOverlayEl.addEventListener('click', (e) => {\r\n    if (!IS_MOBILE) return;\r\n    if (e.target === upgOverlayEl) { e.preventDefault(); e.stopImmediatePropagation(); }\r\n  }, true);\r\n\r\n  let drag = null;\r\n  function onDragStart(e) {\r\n    if (!upgOpen) return;\r\n    const y = typeof e.clientY === 'number' ? e.clientY : (e.touches?.[0]?.clientY || 0);\r\n    drag = { startY: y, lastY: y, moved: 0 };\r\n    upgSheetEl.style.transition = 'none';\r\n    window.addEventListener('pointermove', onDragMove);\r\n    window.addEventListener('pointerup', onDragEnd);\r\n    window.addEventListener('pointercancel', onDragEnd);\r\n  }\r\n  function onDragMove(e) {\r\n    if (!drag) return;\r\n    const y = e.clientY;\r\n    if (typeof y !== 'number') return;\r\n    const dy = Math.max(0, y - drag.startY);\r\n    drag.lastY = y;\r\n    drag.moved = dy;\r\n    upgSheetEl.style.transform = `translateY(${dy}px)`;\r\n  }\r\n  function onDragEnd(e) {\r\n    if (!drag) return;\r\n    const shouldClose = drag.moved > 140;\r\n    upgSheetEl.style.transition = 'transform 160ms ease';\r\n    upgSheetEl.style.transform = shouldClose ? 'translateY(100%)' : 'translateY(0)';\r\n    if (shouldClose) {\r\n      if (IS_MOBILE && (!e || e.pointerType !== 'mouse')) try { blockInteraction(120); } catch {}\r\n      setTimeout(closeUpgradeMenu, 160);\r\n    }\r\n    drag = null;\r\n    window.removeEventListener('pointermove', onDragMove);\r\n    window.removeEventListener('pointerup', onDragEnd);\r\n    window.removeEventListener('pointercancel', onDragEnd);\r\n  }\r\n  grab.addEventListener('pointerdown', onDragStart, { passive: true });\r\n}\r\n\r\nfunction closeUpgradeMenu() {\r\n  if (IS_MOBILE) try { blockInteraction(160); } catch {}\r\n  if (typeof upgOverlayCleanup === 'function') { const fn = upgOverlayCleanup; upgOverlayCleanup = null; try { fn(); } catch {} }\r\n  upgOpen = false;\r\n  if (!upgOverlayEl || !upgSheetEl) return;\r\n  upgSheetEl.style.transition = '';\r\n  upgSheetEl.style.transform = '';\r\n  upgOverlayEl.classList.remove('is-open');\r\n  upgOverlayEl.style.pointerEvents = 'none';\r\n}\r\n\r\nfunction openHmMilestoneDialog(lines) {\r\n  // ... (Re-implement logic or use existing. I will copy existing logic for brevity)\r\n  const existing = document.querySelector('.hm-milestones-overlay');\r\n  if (existing) existing.remove();\r\n  const overlay = document.createElement('div');\r\n  overlay.className = 'hm-milestones-overlay';\r\n  overlay.setAttribute('role', 'dialog');\r\n  const dialog = document.createElement('div');\r\n  dialog.className = 'hm-milestones-dialog';\r\n  const title = document.createElement('h3');\r\n  title.className = 'hm-milestones-title';\r\n  title.textContent = 'Milestones';\r\n  const list = document.createElement('ul');\r\n  list.className = 'hm-milestones-list';\r\n  for (const line of lines) {\r\n    const li = document.createElement('li');\r\n    const text = document.createElement('span');\r\n    text.className = 'hm-milestone-text';\r\n    if (line && typeof line === 'object') { text.textContent = line.text ?? ''; if (line.achieved) li.classList.add('hm-milestone-achieved'); } \r\n    else { text.textContent = line; }\r\n    li.appendChild(text); list.appendChild(li);\r\n  }\r\n  const closeBtn = document.createElement('button');\r\n  closeBtn.type = 'button';\r\n  closeBtn.className = 'hm-milestones-close';\r\n  closeBtn.textContent = 'Close';\r\n  const close = () => { overlay.remove(); document.removeEventListener('keydown', onKeydown); };\r\n  const onKeydown = (event) => { if (event.key === 'Escape') { event.preventDefault(); close(); } };\r\n  overlay.addEventListener('click', (event) => { if (event.target === overlay) close(); });\r\n  closeBtn.addEventListener('click', close);\r\n  document.addEventListener('keydown', onKeydown);\r\n  dialog.append(title, list, closeBtn);\r\n  overlay.appendChild(dialog);\r\n  document.body.appendChild(overlay);\r\n  if (typeof closeBtn.focus === 'function') closeBtn.focus({ preventScroll: true });\r\n}\r\n\r\nexport function openUpgradeOverlay(upgDef, mode = 'standard') {\r\n  ensureUpgradeOverlay();\r\n  upgOpen = true;\r\n  let upgOpenLocal = true;\r\n\r\n  const adapter = getAdapter(mode);\r\n  \r\n  // Initial checks\r\n  const initialLockState = adapter.getLockState(upgDef.id) || {};\r\n  const initialLocked = !!initialLockState.locked;\r\n  const initialMysterious = initialLocked && (initialLockState.hidden || initialLockState.hideEffect || initialLockState.hideCost || (typeof initialLockState.iconOverride === 'string' && initialLockState.iconOverride.includes('mysterious')));\r\n  if (initialLocked && !initialMysterious) { upgOpen = false; return; }\r\n\r\n  const isHM = (upgDef.upgType === 'HM');\r\n  const isEndlessXp = (upgDef.tie === UPGRADE_TIES.ENDLESS_XP);\r\n  \r\n  function ensureChild(parent, className, tagName = 'div') {\r\n      const targetClasses = className.split(' ').filter(c => c.length > 0);\r\n      let el = null; const extras = [];\r\n      for (let i = 0; i < parent.children.length; i++) {\r\n          const child = parent.children[i];\r\n          if (tagName && child.tagName.toLowerCase() !== tagName.toLowerCase()) continue;\r\n          if (targetClasses.every(cls => child.classList.contains(cls))) { if (!el) el = child; else extras.push(child); }\r\n      }\r\n      extras.forEach(e => e.remove());\r\n      if (!el) { el = document.createElement(tagName); el.className = className; parent.appendChild(el); }\r\n      return el;\r\n  }\r\n  const spacer = (h) => { const s = document.createElement('div'); s.style.height = h; return s; };\r\n  const makeLine = (html) => { const d = document.createElement('div'); d.className = 'upg-line'; d.innerHTML = html; return d; };\r\n  \r\n  function recenterUnlockOverlayIfNeeded(model) {\r\n     const content = upgSheetEl.querySelector('.upg-content');\r\n     if (!content) return;\r\n     const lockState = model?.lockState || adapter.getLockState(upgDef.id) || {};\r\n     const isHiddenUpgrade = !!(lockState.hidden || lockState.hideEffect || lockState.hideCost);\r\n     if (!model || !model.unlockUpgrade || isHiddenUpgrade) { content.style.marginTop = ''; return; }\r\n     \r\n     const header = upgSheetEl.querySelector('.upg-header');\r\n     const actions = upgSheetEl.querySelector('.upg-actions');\r\n     if (!header || !actions) return;\r\n     \r\n     content.style.marginTop = '';\r\n     const headerRect = header.getBoundingClientRect();\r\n     const actionsRect = actions.getBoundingClientRect();\r\n     const contentRect = content.getBoundingClientRect();\r\n     const available = actionsRect.top - headerRect.bottom;\r\n     const freeSpace = available - contentRect.height;\r\n     if (freeSpace <= 0) return;\r\n     content.style.marginTop = `${freeSpace * 0.42}px`;\r\n  }\r\n  \r\n  let initialRender = true;\r\n  \r\n  const rerender = () => {\r\n      const model = adapter.getUiModel(upgDef.id);\r\n      if (!model) return;\r\n      \r\n      const lockState = model.lockState || adapter.getLockState(upgDef.id);\r\n      const locked = !!lockState?.locked;\r\n      const isHiddenUpgrade = locked && (lockState?.hidden || lockState?.hideEffect || lockState?.hideCost);\r\n      const isUnlockVisible = !!model.unlockUpgrade && !isHiddenUpgrade;\r\n      \r\n      upgSheetEl.classList.toggle('is-locked-hidden', isHiddenUpgrade);\r\n      \r\n      const header = upgSheetEl.querySelector('.upg-header');\r\n      const title = ensureChild(header, 'upg-title');\r\n      if (title.textContent !== (model.displayTitle || model.upg.title)) title.textContent = model.displayTitle || model.upg.title;\r\n      \r\n      const evolveReady = !!model.hmReadyToEvolve;\r\n      const capReached = evolveReady ? false : (model.lvlBn?.isInfinite?.() ? true : (Number.isFinite(model.upg.lvlCap) ? model.lvl >= model.upg.lvlCap : false));\r\n      \r\n      const level = ensureChild(header, 'upg-level');\r\n      const capHtml = model.lvlCapFmtHtml ?? model.upg.lvlCapFmtHtml ?? formatNumber(model.lvlCapBn);\r\n      const capPlain = model.lvlCapFmtText ?? model.upg.lvlCapFmtText ?? stripTags(capHtml);\r\n      const levelHtml = evolveReady ? `Level ${model.lvlFmtHtml} / ${capHtml} (EVOLVE READY)` : (capReached ? `Level ${model.lvlFmtHtml} / ${capHtml} (MAXED)` : `Level ${model.lvlFmtHtml} / ${capHtml}`);\r\n      const levelPlain = stripTags(levelHtml);\r\n      if (level.innerHTML !== levelHtml) level.innerHTML = levelHtml;\r\n      if (level.getAttribute('aria-label') !== levelPlain) level.setAttribute('aria-label', levelPlain);\r\n      level.hidden = isHiddenUpgrade;\r\n      if (!isHiddenUpgrade) level.removeAttribute('aria-hidden');\r\n      \r\n      upgSheetEl.classList.toggle('is-maxed', capReached);\r\n      upgSheetEl.classList.toggle('hm-evolve-ready', evolveReady);\r\n      upgSheetEl.classList.toggle('is-unlock-upgrade', isUnlockVisible);\r\n      upgSheetEl.classList.toggle('is-hm-upgrade', isHM && !isHiddenUpgrade);\r\n      upgSheetEl.classList.toggle('is-endless-xp', isEndlessXp);\r\n      upgSheetEl.classList.toggle('is-magnet-upgrade', upgDef.tie === UPGRADE_TIES.MAGNET);\r\n\t  upgSheetEl.classList.toggle('is-no-effect', !model.effect);\r\n\r\n            // --- Automation Toggle Logic ---\r\n      let autoToggleWrapper = header.querySelector('.auto-toggle-wrapper');\r\n\r\n      // Check for Master Upgrade logic in Automation Shop\r\n      const masterCostType = (mode === 'automation') ? MASTER_AUTOBUY_IDS[upgDef.id] : null;\r\n      // Also check for Workshop Level Master Switch (ID 6 in automation shop)\r\n      const isWorkshopMaster = (mode === 'automation' && upgDef.id === AUTOBUY_WORKSHOP_LEVELS_ID);\r\n\r\n      const isAutomationMaster = !!masterCostType;\r\n      \r\n      // Check for Standard Upgrade logic in Standard Shop\r\n      const standardAutobuyId = (mode === 'standard') ? COST_TYPE_TO_AUTOBUY_ID[upgDef.costType] : null;\r\n\r\n      let autobuyLevel = 0;\r\n      if (standardAutobuyId) {\r\n          autobuyLevel = getLevelNumber(AUTOMATION_AREA_KEY, standardAutobuyId);\r\n      } else if (isAutomationMaster || isWorkshopMaster) {\r\n          // If viewing the master upgrade itself, we check its own level\r\n          autobuyLevel = getLevelNumber(AUTOMATION_AREA_KEY, upgDef.id);\r\n      }\r\n\r\n      const hasAutobuyer = autobuyLevel > 0;\r\n      const showAutoToggle = hasAutobuyer && (isAutomationMaster || standardAutobuyId || isWorkshopMaster);\r\n\r\n      if (!showAutoToggle) {\r\n          if (autoToggleWrapper) autoToggleWrapper.remove();\r\n      } else {\r\n         if (!autoToggleWrapper) {\r\n             autoToggleWrapper = document.createElement('div');\r\n             autoToggleWrapper.className = 'auto-toggle-wrapper hm-view-milestones-row';\r\n             autoToggleWrapper.style.marginTop = '12px';\r\n             header.appendChild(autoToggleWrapper);\r\n         }\r\n         \r\n         let toggleBtn = autoToggleWrapper.querySelector('button');\r\n         if (!toggleBtn) {\r\n             toggleBtn = document.createElement('button');\r\n             toggleBtn.type = 'button';\r\n             toggleBtn.style.padding = '10px 14px';\r\n             toggleBtn.style.fontSize = '16px';\r\n             toggleBtn.style.width = 'auto';\r\n             toggleBtn.style.minWidth = '180px';\r\n             \r\n             toggleBtn.addEventListener('click', (e) => {\r\n                 if (typeof toggleBtn._onClick === 'function') toggleBtn._onClick(e);\r\n             });\r\n             \r\n             autoToggleWrapper.appendChild(toggleBtn);\r\n         }\r\n         \r\n         const activeSlot = getActiveSlot();\r\n         const slotSuffix = activeSlot != null ? `:${activeSlot}` : '';\r\n\r\n         let isEnabled = true;\r\n         if (isAutomationMaster) {\r\n             const key = `ccc:autobuy:master:${masterCostType}${slotSuffix}`;\r\n             // Check if ANY child upgrade is enabled\r\n             const upgrades = getUpgradesForArea(AREA_KEYS.STARTER_COVE);\r\n             let anyEnabled = false;\r\n             for (const u of upgrades) {\r\n                 if (u.costType === masterCostType) {\r\n                     const childKey = `ccc:autobuy:${u.area}:${u.id}${slotSuffix}`;\r\n                     // Use cached getter if available or fallback (here master check logic is slightly complex)\r\n                     // But wait, the master logic sums up children. \r\n                     // We should use getAutobuyerToggle(u.area, u.id) here to be consistent!\r\n                     if (getAutobuyerToggle(u.area, u.id) !== '0') {\r\n                         anyEnabled = true;\r\n                         break;\r\n                     }\r\n                 }\r\n             }\r\n             isEnabled = anyEnabled;\r\n         } else {\r\n             // Standard or Workshop Master\r\n             const val = getAutobuyerToggle(upgDef.area, upgDef.id);\r\n             isEnabled = val !== '0';\r\n         }\r\n\r\n         if (isEnabled) {\r\n             toggleBtn.className = 'shop-delve';\r\n             toggleBtn.textContent = 'Automation: ON';\r\n             toggleBtn.style.backgroundColor = '';\r\n         } else {\r\n             toggleBtn.className = 'shop-close';\r\n             toggleBtn.textContent = 'Automation: OFF';\r\n             toggleBtn.style.backgroundColor = '';\r\n         }\r\n         \r\n         toggleBtn._onClick = (e) => {\r\n             e.preventDefault(); e.stopPropagation();\r\n             if (IS_MOBILE) blockInteraction(50);\r\n             \r\n             const newState = !isEnabled;\r\n             const val = newState ? '1' : '0';\r\n             \r\n             if (isAutomationMaster) {\r\n                 localStorage.setItem(`ccc:autobuy:master:${masterCostType}${slotSuffix}`, val);\r\n                 const upgrades = getUpgradesForArea(AREA_KEYS.STARTER_COVE); \r\n                 upgrades.forEach(u => {\r\n                    if (u.costType === masterCostType) {\r\n                        setAutobuyerToggle(u.area, u.id, val);\r\n                    }\r\n                 });\r\n             } else {\r\n                 setAutobuyerToggle(upgDef.area, upgDef.id, val);\r\n             }\r\n             rerender();\r\n         };\r\n      }\r\n      // -------------------------------\r\n      \r\n      const content = upgSheetEl.querySelector('.upg-content');\r\n      if (initialRender) { content.scrollTop = 0; initialRender = false; }\r\n      \r\n      const desc = ensureChild(content, 'upg-desc centered');\r\n      desc.classList.toggle('lock-desc', isHiddenUpgrade);\r\n      const baseDesc = (model.displayDesc || model.upg.desc || '').trim();\r\n      if (evolveReady) {\r\n          desc.classList.add('hm-evolve-note');\r\n          if (desc.textContent !== 'Evolve this upgrade to multiply its effect by 1000x') desc.textContent = 'Evolve this upgrade to multiply its effect by 1000x';\r\n      } else if (baseDesc) {\r\n          desc.classList.remove('hm-evolve-note');\r\n          if (desc.textContent !== baseDesc) desc.textContent = baseDesc;\r\n          desc.hidden = false;\r\n      } else desc.hidden = true;\r\n      \r\n      const info = ensureChild(content, 'upg-info');\r\n      info.innerHTML = '';\r\n      info.appendChild(spacer('12px'));\r\n      \r\n      if (locked && lockState?.reason && !isHiddenUpgrade) {\r\n          const descText = (model.displayDesc || '').trim();\r\n          const reasonText = String(lockState.reason ?? '').trim();\r\n          if (descText !== reasonText) {\r\n              const note = document.createElement('div'); note.className = 'upg-line lock-note'; note.textContent = lockState.reason;\r\n              info.appendChild(note); info.appendChild(spacer('12px'));\r\n          }\r\n      }\r\n      if (model.effect && !(locked && lockState?.hideEffect)) {\r\n          info.appendChild(makeLine(`<span class=\"bonus-line\">${model.effect}</span>`)); info.appendChild(spacer('12px'));\r\n      }\r\n      \r\n      const iconHTML = currencyIconHTML(model.upg.costType);\r\n      const nextPriceBn = model.nextPrice instanceof BigNum ? model.nextPrice : BigNum.fromAny(model.nextPrice || 0);\r\n      const stopBuying = capReached || evolveReady;\r\n      \r\n      if (!model.unlockUpgrade && !stopBuying && (!locked || !lockState?.hideCost)) {\r\n          const costs = document.createElement('div'); costs.className = 'upg-costs';\r\n          \r\n          const costLabel = getCurrencyLabel(model.upg.costType, nextPriceBn);\r\n          const lineCost = document.createElement('div'); lineCost.className = 'upg-line';\r\n          lineCost.innerHTML = `Cost: ${iconHTML} ${bank[model.upg.costType].fmt(nextPriceBn)} ${costLabel}`;\r\n          costs.appendChild(lineCost);\r\n          \r\n          if (isHM) {\r\n             const lineMilestone = document.createElement('div'); lineMilestone.className = 'upg-line';\r\n             let milestoneCost = '\u2014';\r\n             let milestoneLabel = '';\r\n             const isAutomated = isUpgradeAutomated(model.upg);\r\n             try {\r\n                if (model.hmNextMilestone && model.hmNextMilestone.cmp(model.lvlBn) > 0) {\r\n                    if (isAutomated) {\r\n                        const targetLevelBn = model.hmNextMilestone.sub(BigNum.fromInt(1));\r\n                        let targetLevelNum = 0;\r\n                        try {\r\n                            const s = targetLevelBn.toPlainIntegerString?.();\r\n                            if (s && s !== 'Infinity') targetLevelNum = Number(s);\r\n                            else targetLevelNum = Number(targetLevelBn.toString());\r\n                        } catch { targetLevelNum = 0; }\r\n                        \r\n                        let costAt = BigNum.fromInt(0);\r\n                        try {\r\n                            costAt = BigNum.fromAny(model.upg.costAtLevel(targetLevelNum));\r\n                        } catch {}\r\n                        \r\n                        milestoneCost = bank[model.upg.costType].fmt(costAt);\r\n                        milestoneLabel = getCurrencyLabel(model.upg.costType, costAt);\r\n                    } else {\r\n                        const deltaBn = model.hmNextMilestone.sub(model.lvlBn);\r\n                        const deltaPlain = deltaBn.toPlainIntegerString?.();\r\n                        const deltaNum = Math.max(0, Math.floor(Number(deltaPlain && deltaPlain !== 'Infinity' ? deltaPlain : Number(deltaBn.toString() || 0))));\r\n                        const { spent } = evaluateBulkPurchase(model.upg, model.lvlBn, BigNum.fromAny('Infinity'), deltaNum);\r\n                        milestoneCost = bank[model.upg.costType].fmt(spent);\r\n                        milestoneLabel = getCurrencyLabel(model.upg.costType, spent);\r\n                    }\r\n                }\r\n             } catch {}\r\n             const prefix = isAutomated ? 'Cost at next milestone:' : 'Cost to next milestone:';\r\n             lineMilestone.innerHTML = `${prefix} ${iconHTML} ${milestoneCost} ${milestoneLabel}`;\r\n             costs.appendChild(lineMilestone);\r\n          }\r\n          \r\n          const haveLabel = getCurrencyLabel(model.upg.costType, model.have);\r\n          const lineHave = document.createElement('div'); lineHave.className = 'upg-line';\r\n          lineHave.innerHTML = `You have: ${iconHTML} ${bank[model.upg.costType].fmt(model.have)} ${haveLabel}`;\r\n          costs.appendChild(lineHave);\r\n          info.appendChild(costs);\r\n      }\r\n      \r\n      // Milestones Row\r\n      if (isHM && !isHiddenUpgrade) {\r\n          let milestonesRow = content.querySelector('.hm-view-milestones-row');\r\n          if (!milestonesRow) {\r\n              milestonesRow = document.createElement('div'); milestonesRow.className = 'hm-view-milestones-row';\r\n              const btn = document.createElement('button'); btn.type='button'; btn.className='shop-delve hm-view-milestones'; btn.textContent='View Milestones';\r\n              btn.addEventListener('click', () => {\r\n                 const milestones = Array.isArray(model.hmMilestones) ? model.hmMilestones : [];\r\n                 const evolutions = Math.max(0, Math.floor(Number(model.hmEvolutions ?? 0)));\r\n                 const evolutionOffset = (() => { try { return BigInt(HM_EVOLUTION_INTERVAL) * BigInt(evolutions); } catch { return 0n; } })();\r\n                 const lines = milestones.sort((a,b)=>(Number(a?.level||0)-Number(b?.level||0))).map(m => {\r\n                     const lvl = Math.max(0, Math.floor(Number(m?.level||0)));\r\n                     const milestoneLevelBn = (() => {\r\n                         if (model.lvlBn?.isInfinite?.()) return BigNum.fromAny('Infinity');\r\n                         try { return BigNum.fromAny((BigInt(lvl) + evolutionOffset).toString()); } catch { return BigNum.fromAny(lvl + (HM_EVOLUTION_INTERVAL * evolutions)); }\r\n                     })();\r\n                     const levelText = milestoneLevelBn?.isInfinite?.() ? 'Infinity' : formatNumber(milestoneLevelBn);\r\n                     const mult = formatMultForUi(m?.multiplier??m?.mult??m?.value??1);\r\n                     const target = `${m?.target??m?.type??'self'}`.toLowerCase();\r\n                     const achieved = (() => {\r\n                        if (model.lvlBn?.isInfinite?.()) return true;\r\n                        try { return model.lvlBn?.cmp?.(milestoneLevelBn) >= 0; } catch {}\r\n                        return false; \r\n                     })();\r\n                     let text = `Level ${levelText}: Multiplies this upgrade\u2019s effect by ${mult}x`;\r\n                     if (target === 'xp') text = `Level ${levelText}: Multiplies XP value by ${mult}x`;\r\n                     if (target === 'coin'||target==='coins') text = `Level ${levelText}: Multiplies Coin value by ${mult}x`;\r\n                     if (target === 'mp') text = `Level ${levelText}: Multiplies MP value by ${mult}x`;\r\n                     return { text, achieved };\r\n                 });\r\n                 openHmMilestoneDialog(lines);\r\n              });\r\n              milestonesRow.appendChild(btn); content.appendChild(milestonesRow);\r\n          }\r\n      } else {\r\n          const mr = content.querySelector('.hm-view-milestones-row'); if(mr) mr.remove();\r\n      }\r\n      \r\n      // Actions\r\n      const actions = upgSheetEl.querySelector('.upg-actions');\r\n      let closeBtn = actions.querySelector('.shop-close');\r\n      if (!closeBtn) {\r\n          closeBtn = document.createElement('button'); closeBtn.type='button'; closeBtn.className='shop-close'; closeBtn.textContent='Close';\r\n          closeBtn.addEventListener('click', () => { upgOpenLocal = false; closeUpgradeMenu(); });\r\n          actions.appendChild(closeBtn);\r\n      }\r\n      \r\n      if (locked || capReached) {\r\n          actions.querySelectorAll('button:not(.shop-close)').forEach(btn => btn.remove());\r\n          if (document.activeElement && document.activeElement !== closeBtn && !actions.contains(document.activeElement)) closeBtn.focus();\r\n      } else {\r\n          const canAffordNext = model.have.cmp(nextPriceBn) >= 0;\r\n          const ensureButton = (className, text, onClick, index, disabled=false) => {\r\n              let btn = actions.querySelector(`.${className.split(' ').join('.')}`);\r\n              if (!btn) {\r\n                  btn = document.createElement('button'); btn.type='button'; btn.className=className; btn.textContent=text;\r\n                  \r\n                  const invoke = () => { if (typeof btn._onClick === 'function') btn._onClick(); };\r\n                  if ('PointerEvent' in window) btn.addEventListener('pointerdown', (e) => { if(e.pointerType==='mouse'||(typeof e.button==='number'&&e.button!==0))return; invoke(); e.preventDefault(); }, {passive:false});\r\n                  else btn.addEventListener('touchstart', (e)=>{ invoke(); e.preventDefault(); }, {passive:false});\r\n                  btn.addEventListener('click', ()=>{ if(IS_MOBILE)return; invoke(); });\r\n                  \r\n                  const siblings = actions.children;\r\n                  if (index >= siblings.length) actions.appendChild(btn); else actions.insertBefore(btn, siblings[index]);\r\n              }\r\n              btn._onClick = onClick;\r\n              if(btn.textContent!==text) btn.textContent=text;\r\n              if(btn.disabled!==disabled) btn.disabled=disabled;\r\n              return btn;\r\n          };\r\n          \r\n          if (evolveReady) {\r\n              actions.querySelectorAll('button:not(.shop-close):not(.hm-evolve-btn)').forEach(b => b.remove());\r\n              ensureButton('shop-delve hm-evolve-btn', 'Evolve', () => {\r\n                  const { evolved } = adapter.evolve(upgDef.id);\r\n                  if (evolved) { playEvolveSfx(); updateShopOverlay(); rerender(); }\r\n              }, 1, false);\r\n              recenterUnlockOverlayIfNeeded(model);\r\n              return;\r\n          }\r\n          \r\n          if (model.unlockUpgrade) {\r\n               actions.querySelectorAll('button:not(.shop-close):not(.btn-unlock)').forEach(b => b.remove());\r\n               ensureButton('shop-delve btn-unlock', 'Unlock', () => {\r\n                   const { bought } = adapter.buyOne(upgDef.id);\r\n                   const boughtBn = bought instanceof BigNum ? bought : BigNum.fromAny(bought ?? 0);\r\n                   if (!boughtBn.isZero?.()) {\r\n                       playPurchaseSfx();\r\n                       if (isForgeUnlockUpgrade(upgDef, mode)) try { unlockMerchantTabs(['reset']); } catch {}\r\n                       updateShopOverlay(); rerender();\r\n                   }\r\n               }, 1, !canAffordNext);\r\n               recenterUnlockOverlayIfNeeded(model);\r\n               return;\r\n          }\r\n          \r\n          actions.querySelectorAll('.hm-evolve-btn, .btn-unlock').forEach(b => b.remove());\r\n          \r\n          const performBuy = () => {\r\n              const fresh = adapter.getUiModel(upgDef.id);\r\n              if (fresh.have.cmp(fresh.nextPrice instanceof BigNum ? fresh.nextPrice : BigNum.fromAny(fresh.nextPrice||0)) < 0) return;\r\n              const { bought } = adapter.buyOne(upgDef.id);\r\n              const boughtBn = bought instanceof BigNum ? bought : BigNum.fromAny(bought ?? 0);\r\n              if (!boughtBn.isZero?.()) { playPurchaseSfx(); updateShopOverlay(); rerender(); }\r\n          };\r\n          ensureButton('shop-delve btn-buy-one', 'Buy', performBuy, 1, !canAffordNext);\r\n          \r\n          const capNumber = Number.isFinite(model.upg.lvlCap) ? model.upg.lvlCap : Infinity;\r\n          const isSingleLevelCap = capNumber === 1;\r\n\r\n          if (!isSingleLevelCap) {\r\n              const performBuyMax = () => {\r\n                  const fresh = adapter.getUiModel(upgDef.id);\r\n                  if (fresh.have.cmp(BigNum.fromInt(1)) < 0) return;\r\n                  const { bought } = adapter.buyMax(upgDef.id);\r\n                  const boughtBn = bought instanceof BigNum ? bought : BigNum.fromAny(bought ?? 0);\r\n                  if (!boughtBn.isZero?.()) { playPurchaseSfx(); updateShopOverlay(); rerender(); }\r\n              };\r\n              ensureButton('shop-delve btn-buy-max', 'Buy Max', performBuyMax, 2, !canAffordNext);\r\n          } else {\r\n              const stale = actions.querySelector('.btn-buy-max');\r\n              if (stale) stale.remove();\r\n          }\r\n          \r\n          if (isHM) {\r\n              const performBuyNext = () => {\r\n                  const fresh = adapter.getUiModel(upgDef.id);\r\n                  if (fresh.hmReadyToEvolve) return;\r\n                  const target = fresh.hmNextMilestone;\r\n                  if (!target || !fresh.lvlBn || target.cmp(fresh.lvlBn) <= 0) {\r\n                      const { bought } = adapter.buyMax(upgDef.id);\r\n                      if ((bought instanceof BigNum ? bought : BigNum.fromAny(bought??0)).isZero?.()) return;\r\n                      playPurchaseSfx(); updateShopOverlay(); rerender(); return;\r\n                  }\r\n                  let deltaNum = 0;\r\n                  try { const diffPlain = target.sub(fresh.lvlBn).toPlainIntegerString?.(); deltaNum = Math.max(0, Math.floor(Number((diffPlain&&diffPlain!=='Infinity')?diffPlain:target.sub(fresh.lvlBn).toString()))); } catch {}\r\n                  const walletRaw = bank[fresh.upg.costType]?.value;\r\n                  const walletBn = walletRaw instanceof BigNum ? walletRaw : BigNum.fromAny(walletRaw??0);\r\n                  const evalResult = evaluateBulkPurchase(fresh.upg, fresh.lvlBn, walletBn, deltaNum);\r\n                  const count = evalResult.count;\r\n                  let reachable = false;\r\n                  try { const plain = count?.toPlainIntegerString?.(); reachable = (plain&&plain!=='Infinity') ? Number(plain)>=deltaNum : Number(count??0)>=deltaNum; } catch {}\r\n                  const purchase = reachable ? adapter.buyNext(upgDef.id, deltaNum) : adapter.buyMax(upgDef.id);\r\n                  const boughtBn = purchase.bought instanceof BigNum ? purchase.bought : BigNum.fromAny(purchase.bought??0);\r\n                  if (!boughtBn.isZero?.()) { playPurchaseSfx(); updateShopOverlay(); rerender(); }\r\n              };\r\n              ensureButton('shop-delve btn-buy-next', 'Buy Next', performBuyNext, 3, model.have.cmp(BigNum.fromInt(1)) < 0);\r\n          } else {\r\n              const stale = actions.querySelector('.btn-buy-next'); if (stale) stale.remove();\r\n          }\r\n      }\r\n      recenterUnlockOverlayIfNeeded(model);\r\n  };\r\n  \r\n  const onUpdate = () => { if (!upgOpenLocal) return; rerender(); };\r\n  adapter.events.forEach(evt => window.addEventListener(evt, onUpdate));\r\n  if (mode === 'standard') document.addEventListener('ccc:upgrades:changed', onUpdate);\r\n  \r\n  rerender();\r\n  upgOverlayEl.classList.add('is-open');\r\n  upgOverlayEl.classList.toggle('is-automation-upgrade', mode === 'automation');\r\n  upgOverlayEl.style.pointerEvents = 'auto';\r\n  blockInteraction(140);\r\n  upgSheetEl.style.transition = 'none';\r\n  upgSheetEl.style.transform = 'translateY(100%)';\r\n  void upgSheetEl.offsetHeight;\r\n  requestAnimationFrame(() => { upgSheetEl.style.transition = ''; upgSheetEl.style.transform = ''; });\r\n  \r\n  upgOverlayCleanup = () => {\r\n     upgOpenLocal = false;\r\n     adapter.events.forEach(evt => window.removeEventListener(evt, onUpdate));\r\n     if (mode === 'standard') document.removeEventListener('ccc:upgrades:changed', onUpdate);\r\n  };\r\n}\r\n\r\nexport function setupDragToClose(grabberEl, sheetEl, isOpenFn, performCloseFn) {\r\n  let drag = null;\r\n  function onDragStart(e) {\r\n    if (!isOpenFn()) return;\r\n    const clientY = typeof e.clientY === 'number' ? e.clientY : (e.touches?.[0]?.clientY || 0);\r\n    drag = { startY: clientY, lastY: clientY, startT: performance.now(), moved: 0, canceled: false };\r\n    sheetEl.style.transition = 'none';\r\n    window.addEventListener('pointermove', onDragMove);\r\n    window.addEventListener('pointerup', onDragEnd);\r\n    window.addEventListener('pointercancel', onDragEnd);\r\n  }\r\n  function onDragMove(e) {\r\n    if (!drag || drag.canceled) return;\r\n    const y = e.clientY;\r\n    if (typeof y !== 'number') return;\r\n    const dy = Math.max(0, y - drag.startY);\r\n    drag.lastY = y;\r\n    drag.moved = dy;\r\n    sheetEl.style.transform = `translateY(${dy}px)`;\r\n  }\r\n  function onDragEnd() {\r\n    if (!drag || drag.canceled) return cleanupDrag();\r\n    const dt = Math.max(1, performance.now() - drag.startT);\r\n    const dy = drag.moved;\r\n    const velocity = dy / dt;\r\n    const shouldClose = (velocity > 0.55 && dy > 40) || dy > 140;\r\n    if (shouldClose) {\r\n      suppressNextGhostTap(100);\r\n      blockInteraction(80);\r\n      sheetEl.style.transition = 'transform 140ms ease-out';\r\n      sheetEl.style.transform = 'translateY(100%)';\r\n      performCloseFn();\r\n    } else {\r\n      sheetEl.style.transition = 'transform 180ms ease';\r\n      sheetEl.style.transform = 'translateY(0)';\r\n    }\r\n    cleanupDrag();\r\n  }\r\n  function onDragCancel() {\r\n    if (!drag) return;\r\n    drag.canceled = true;\r\n    sheetEl.style.transition = 'transform 180ms ease';\r\n    sheetEl.style.transform = 'translateY(0)';\r\n    cleanupDrag();\r\n  }\r\n  function cleanupDrag() {\r\n    window.removeEventListener('pointermove', onDragMove);\r\n    window.removeEventListener('pointerup', onDragEnd);\r\n    window.removeEventListener('pointercancel', onDragEnd);\r\n    drag = null;\r\n  }\r\n  grabberEl.addEventListener('pointerdown', onDragStart);\r\n  grabberEl.addEventListener('touchstart', (e) => e.preventDefault(), { passive: false });\r\n}\r\n", "// js/ui/hudButtons.js\r\n\r\nimport { openShop } from './shopOverlay.js';\r\nimport { getActiveSlot, hasModifiedSave } from '../util/storage.js';\r\nimport {\r\n  shouldSkipGhostTap,\r\n} from '../util/ghostTapGuard.js';\r\n\r\nconst BASE_KEYS = {\r\n  SHOP: 'ccc:unlock:shop',\r\n  MAP:  'ccc:unlock:map',\r\n};\r\n\r\nfunction slotKey(base) {\r\n  const slot = getActiveSlot();\r\n  return slot == null ? base : `${base}:${slot}`;\r\n}\r\n\r\nfunction isUnlocked(base) {\r\n  const key = slotKey(base);\r\n  const slotRaw = localStorage.getItem(key);\r\n  if (slotRaw != null) return slotRaw === '1';\r\n  return localStorage.getItem(base) === '1';\r\n}\r\n\r\nexport function isShopUnlocked() {\r\n  ensureUnlockDefaults();\r\n  return isUnlocked(BASE_KEYS.SHOP);\r\n}\r\n\r\nexport function isMapUnlocked() {\r\n  ensureUnlockDefaults();\r\n  return isUnlocked(BASE_KEYS.MAP);\r\n}\r\n\r\nfunction setUnlocked(base, v) {\r\n  const val = v ? '1' : '0';\r\n  const key = slotKey(base);\r\n  localStorage.setItem(key, val);\r\n  if (key !== base && localStorage.getItem(base) != null) {\r\n    localStorage.setItem(base, val);\r\n  }\r\n  try {\r\n    window.dispatchEvent(new CustomEvent('unlock:change', {\r\n      detail: { key: base, slot: getActiveSlot() },\r\n    }));\r\n  } catch {}\r\n}\r\n\r\nfunction ensureUnlockDefaults() {\r\n  for (const key of Object.values(BASE_KEYS)) {\r\n    const sk = slotKey(key);\r\n    const hasSlot = localStorage.getItem(sk) != null;\r\n    if (!hasSlot) localStorage.setItem(sk, '0');\r\n  }\r\n}\r\n\r\nfunction setButtonVisible(key, visible) {\r\n  const el = document.querySelector(`.hud-bottom [data-btn=\"${key}\"]`);\r\n  if (el) el.hidden = !visible;\r\n}\r\n\r\nfunction updateShopButtonTamperState() {\r\n  const btn = document.querySelector('.hud-bottom [data-btn=\"shop\"]');\r\n  if (!btn) return;\r\n  btn.classList.toggle('btn-shop--modified', hasModifiedSave());\r\n}\r\n\r\nfunction phonePortrait() {\r\n  const isCoarse = window.matchMedia('(pointer: coarse)').matches;\r\n  const isPortrait = window.innerHeight >= window.innerWidth;\r\n  return isCoarse && isPortrait;\r\n}\r\n\r\nlet listenersBound = false;\r\nlet actionsBound = false;\r\n\r\n// ===============================\r\n// HUD layout\r\n// ===============================\r\nexport function applyHudLayout() {\r\n  const hud = document.querySelector('.hud-bottom');\r\n  if (!hud) return;\r\n\r\n  const mapBtn = hud.querySelector('[data-btn=\"map\"]');\r\n  const isMapVisible = !!(mapBtn && !mapBtn.hidden);\r\n  const isPhonePortrait = phonePortrait();\r\n  const baseOrder = ['help', 'shop', 'stats', 'map'];\r\n  const mobileMapOrder = ['help', 'stats', 'shop', 'map'];\r\n\r\n  const desiredOrder = isPhonePortrait && isMapVisible ? mobileMapOrder : baseOrder;\r\n\r\n  const desiredNodes = desiredOrder\r\n    .map(key => hud.querySelector(`.game-btn[data-btn=\"${key}\"]`))\r\n    .filter(Boolean);\r\n  const remainingNodes = [...hud.children].filter(el => !desiredNodes.includes(el));\r\n  const finalOrder = [...desiredNodes, ...remainingNodes];\r\n\r\n  const needsReorder = finalOrder.length && finalOrder.some((el, idx) => hud.children[idx] !== el);\r\n  if (needsReorder) {\r\n    const frag = document.createDocumentFragment();\r\n    finalOrder.forEach(node => frag.appendChild(node));\r\n    hud.appendChild(frag);\r\n  }\r\n\r\n  const all = [...hud.querySelectorAll('.game-btn')];\r\n  const visible = all.filter(el => !el.hidden);\r\n\r\n  // Reset previous hints\r\n  hud.classList.remove('is-2','is-3','is-4');\r\n  visible.forEach(el => {\r\n    el.style.gridColumn = '';\r\n    el.style.gridRow = '';\r\n    el.classList.remove('span-2');\r\n    el.style.order = '';\r\n  });\r\n  hud.style.gridTemplateColumns = '';\r\n  hud.classList.add(`is-${visible.length}`);\r\n\r\n  // Desktop centering\r\n  if (!isPhonePortrait) {\r\n    const cs  = getComputedStyle(hud);\r\n    const gap = parseFloat(cs.columnGap || cs.gap || '0') || 0;\r\n    const cw  = hud.clientWidth;\r\n    const per = Math.max(180, Math.floor((cw - 3 * gap) / 4));\r\n\r\n    if (visible.length === 2) {\r\n      hud.style.gridTemplateColumns = `1fr ${per}px ${per}px 1fr`;\r\n      visible[0].style.gridColumn = '2';\r\n      visible[1].style.gridColumn = '3';\r\n      return;\r\n    }\r\n    if (visible.length === 3) {\r\n      hud.style.gridTemplateColumns = `1fr ${per}px ${per}px ${per}px 1fr`;\r\n      visible[0].style.gridColumn = '2';\r\n      visible[1].style.gridColumn = '3';\r\n      visible[2].style.gridColumn = '4';\r\n      return;\r\n    }\r\n  }\r\n\r\n  // Mobile portrait (2\u00D72): Help & Stats top; Shop full width bottom\r\n  if (isPhonePortrait && visible.length === 3) {\r\n    const help  = hud.querySelector('[data-btn=\"help\"]:not([hidden])');\r\n    const stats = hud.querySelector('[data-btn=\"stats\"]:not([hidden])');\r\n    const shop  = hud.querySelector('[data-btn=\"shop\"]:not([hidden])');\r\n\r\n    if (help && stats && shop) {\r\n      help.style.gridColumn  = '1'; help.style.gridRow  = '1';\r\n      stats.style.gridColumn = '2'; stats.style.gridRow = '1';\r\n      shop.style.gridColumn  = '1 / -1'; shop.style.gridRow = '2';\r\n    }\r\n  }\r\n}\r\n\r\nexport function initHudButtons() {\r\n  ensureUnlockDefaults();\r\n\r\n  // Always-on buttons\r\n  setButtonVisible('help',  true);\r\n  setButtonVisible('stats', true);\r\n\r\n  setButtonVisible('shop', isUnlocked(BASE_KEYS.SHOP));\r\n  setButtonVisible('map',  isUnlocked(BASE_KEYS.MAP));\r\n  updateShopButtonTamperState();\r\n\r\n  applyHudLayout();\r\n\r\n  if (!listenersBound) {\r\n    listenersBound = true;\r\n    window.addEventListener('resize', applyHudLayout);\r\n    window.addEventListener('orientationchange', applyHudLayout);\r\n    window.addEventListener('saveSlot:change', () => {\r\n      setButtonVisible('shop', isUnlocked(BASE_KEYS.SHOP));\r\n      setButtonVisible('map',  isUnlocked(BASE_KEYS.MAP));\r\n      updateShopButtonTamperState();\r\n      applyHudLayout();\r\n    });\r\n    window.addEventListener('saveSlot:modified', (event) => {\r\n      const active = getActiveSlot();\r\n      const slot = event?.detail?.slot;\r\n      if (slot != null && active != null && slot !== active) return;\r\n      updateShopButtonTamperState();\r\n    });\r\n  }\r\n\r\n  // Bind actions once (click \u2192 open shop)\r\n  if (!actionsBound) {\r\n    actionsBound = true;\r\n    const hud = document.querySelector('.hud-bottom');\r\n    if (hud) {\r\n      const activate = (btn) => {\r\n        if (!btn) return;\r\n        const key = btn.getAttribute('data-btn');\r\n        if (key === 'shop') {\r\n          openShop();\r\n        }\r\n        // future: help/settings/map can import their own modules, too\r\n      };\r\n\r\n      const onClick = (e) => {\r\n        const btn = e.target.closest('.game-btn');\r\n        if (!btn) return;\r\n        const key = btn.getAttribute('data-btn');\r\n        if (key !== 'shop') return;\r\n        if (e.isTrusted && shouldSkipGhostTap(btn)) return;\r\n        // markGhostTapTarget removed - global handler manages clicks\r\n        activate(btn);\r\n      };\r\n\r\n      hud.addEventListener('click', onClick, { passive: true });\r\n    }\r\n  }\r\n}\r\n\r\n// Convenience helpers (write both keys)\r\nexport function unlockShop() { setUnlocked(BASE_KEYS.SHOP, true);  setButtonVisible('shop', true); applyHudLayout(); }\r\nexport function unlockMap()  { setUnlocked(BASE_KEYS.MAP,  true);  setButtonVisible('map',  true); applyHudLayout(); }\r\nexport function lockShop()   { setUnlocked(BASE_KEYS.SHOP, false); setButtonVisible('shop', false); applyHudLayout(); }\r\nexport function lockMap()    { setUnlocked(BASE_KEYS.MAP,  false); setButtonVisible('map',  false); applyHudLayout(); }\r\n", "// js/game/cursorTrail.js\r\n\r\nexport function createCursorTrail(playfield) {\r\n  if (!playfield || typeof window === 'undefined') {\r\n    return { destroy() {} };\r\n  }\r\n\r\n  // Idempotency check\r\n  if (playfield.querySelector('.cursor-trail-canvas')) {\r\n      const old = playfield.querySelectorAll('.cursor-trail-canvas');\r\n      old.forEach(el => el.remove());\r\n  }\r\n\r\n  // --- Configuration ---\r\n  const CAPACITY = 10000;\r\n  const PARTICLE_LIFETIME = 500; // ms\r\n  const INTERPOLATION_STEP = 10; // px\r\n  // MAX_SPAWN_PER_FRAME is less relevant with coalesced events but still good for sanity\r\n  const MAX_SPAWN_PER_FRAME = 200; \r\n  \r\n  // Visuals\r\n  const PARTICLE_SIZE = 16; \r\n  const PARTICLE_RADIUS = PARTICLE_SIZE / 2;\r\n  const GLOW_RADIUS = 8;\r\n  const TEXTURE_SIZE = 32; \r\n  const CENTER = TEXTURE_SIZE / 2;\r\n\r\n  // --- State ---\r\n  const STRIDE = 4;\r\n  const data = new Float32Array(CAPACITY * STRIDE);\r\n  \r\n  for (let i = 0; i < CAPACITY; i++) {\r\n    data[i * STRIDE + 2] = Infinity;\r\n  }\r\n  \r\n  const freeSlots = new Int16Array(CAPACITY);\r\n  let freeCount = CAPACITY;\r\n  // Reverse fill so we pop low indices first\r\n  for (let i = 0; i < CAPACITY; i++) freeSlots[i] = CAPACITY - 1 - i;\r\n\r\n  let maxActiveIndex = -1;\r\n\r\n  // --- DOM Setup ---\r\n  const canvas = document.createElement('canvas');\r\n  canvas.className = 'cursor-trail-canvas';\r\n  Object.assign(canvas.style, {\r\n    position: 'absolute',\r\n    top: '0',\r\n    left: '0',\r\n    width: '100%',\r\n    height: '100%',\r\n    pointerEvents: 'none',\r\n    zIndex: '5',\r\n    touchAction: 'none'\r\n  });\r\n  \r\n  playfield.appendChild(canvas);\r\n\r\n  // Use desynchronized for lower latency\r\n  const ctx = canvas.getContext('2d', { \r\n    alpha: true,\r\n    desynchronized: true \r\n  });\r\n\r\n  // --- Texture Generation ---\r\n  const texture = document.createElement('canvas');\r\n  texture.width = TEXTURE_SIZE;\r\n  texture.height = TEXTURE_SIZE;\r\n  const tCtx = texture.getContext('2d');\r\n  \r\n  tCtx.shadowColor = '#FFEB3B';\r\n  tCtx.shadowBlur = GLOW_RADIUS;\r\n  tCtx.fillStyle = '#FFEB3B';\r\n  \r\n  tCtx.beginPath();\r\n  tCtx.arc(CENTER, CENTER, PARTICLE_RADIUS, 0, Math.PI * 2);\r\n  tCtx.fill();\r\n\r\n  // --- Interaction State ---\r\n  let pointerInside = false;\r\n  let lastSpawnX = null;\r\n  let lastSpawnY = null;\r\n  \r\n  let rect = { left: 0, top: 0, width: 0, height: 0 };\r\n  let dpr = 1;\r\n  let destroyed = false;\r\n  let rafId = 0;\r\n  let lastTime = 0;\r\n  let wasDirty = false;\r\n  let lastClearRect = null;\r\n\r\n  // Queue for incoming pointer points (from coalesced events)\r\n  // Each entry is { x, y } in local coordinates\r\n  const pointsQueue = [];\r\n\r\n  // --- Methods ---\r\n\r\n  const updateBounds = () => {\r\n    if (destroyed) return;\r\n    rect = playfield.getBoundingClientRect();\r\n  };\r\n\r\n  const resize = () => {\r\n    if (destroyed) return;\r\n    updateBounds();\r\n    const baseDpr = Math.min(window.devicePixelRatio || 1, 2);\r\n    const MAX_CANVAS_WIDTH = 512;\r\n    const widthScale = (rect.width > 0) ? Math.min(baseDpr, MAX_CANVAS_WIDTH / rect.width) : baseDpr;\r\n    dpr = widthScale;\r\n\r\n    canvas.width = rect.width * dpr;\r\n    canvas.height = rect.height * dpr;\r\n    \r\n    ctx.scale(dpr, dpr);\r\n    lastClearRect = null; \r\n  };\r\n\r\n  let resizeObserver = null;\r\n  if (typeof ResizeObserver !== 'undefined') {\r\n    resizeObserver = new ResizeObserver(() => {\r\n        resize();\r\n    });\r\n    resizeObserver.observe(playfield);\r\n  }\r\n\r\n  const spawn = (x, y) => {\r\n    if (freeCount <= 0) return;\r\n    const idx = freeSlots[--freeCount];\r\n    if (idx > maxActiveIndex) maxActiveIndex = idx;\r\n    const offset = idx * STRIDE;\r\n    data[offset] = x;\r\n    data[offset + 1] = y;\r\n    data[offset + 2] = 0;\r\n    data[offset + 3] = PARTICLE_LIFETIME;\r\n  };\r\n\r\n  const processPoint = (localX, localY, budgetRef) => {\r\n      // Spawn at this point, interpolating from lastSpawnX if needed\r\n      if (lastSpawnX === null || lastSpawnY === null) {\r\n          if (budgetRef.count < MAX_SPAWN_PER_FRAME) {\r\n            spawn(localX, localY);\r\n            budgetRef.count++;\r\n          }\r\n      } else {\r\n        const dx = localX - lastSpawnX;\r\n        const dy = localY - lastSpawnY;\r\n        const dist = Math.hypot(dx, dy);\r\n        \r\n        if (dist >= INTERPOLATION_STEP) {\r\n          const steps = Math.floor(dist / INTERPOLATION_STEP);\r\n          for (let i = 1; i <= steps; i++) {\r\n             if (budgetRef.count >= MAX_SPAWN_PER_FRAME) break;\r\n             const fraction = (i * INTERPOLATION_STEP) / dist;\r\n             spawn(lastSpawnX + dx * fraction, lastSpawnY + dy * fraction);\r\n             budgetRef.count++;\r\n          }\r\n        }\r\n        // Always spawn the point itself if we haven't blown budget drastically\r\n        // (Actually, we should prioritize the *end* points of the coalesced events, \r\n        // but spawning intermediate interpolated points is fine too)\r\n        if (budgetRef.count < MAX_SPAWN_PER_FRAME) {\r\n            spawn(localX, localY);\r\n            budgetRef.count++;\r\n        }\r\n      }\r\n      lastSpawnX = localX;\r\n      lastSpawnY = localY;\r\n  };\r\n\r\n  const onPointerMove = (e) => {\r\n    if (destroyed) return;\r\n    if (!rafId) {\r\n      lastTime = performance.now();\r\n      rafId = requestAnimationFrame(loop);\r\n    }\r\n    if (!rect.width) updateBounds();\r\n\r\n    // Calculate offset once per event\r\n    // Note: rect.left/top are screen coordinates. clientX/Y are screen coordinates.\r\n    const offsetX = rect.left;\r\n    const offsetY = rect.top;\r\n\r\n    // Helper to check bounds\r\n    const isIn = (x, y) => (x >= 0 && x <= rect.width && y >= 0 && y <= rect.height);\r\n    \r\n    // Process coalesced events if available to get high-frequency path\r\n    if (e.getCoalescedEvents) {\r\n        const events = e.getCoalescedEvents();\r\n        if (events.length > 0) {\r\n            for (const ev of events) {\r\n                const lx = ev.clientX - offsetX;\r\n                const ly = ev.clientY - offsetY;\r\n                pointsQueue.push({ x: lx, y: ly, inside: isIn(lx, ly) });\r\n            }\r\n        } else {\r\n            // Fallback if empty list returned\r\n            const lx = e.clientX - offsetX;\r\n            const ly = e.clientY - offsetY;\r\n            pointsQueue.push({ x: lx, y: ly, inside: isIn(lx, ly) });\r\n        }\r\n    } else {\r\n        const lx = e.clientX - offsetX;\r\n        const ly = e.clientY - offsetY;\r\n        pointsQueue.push({ x: lx, y: ly, inside: isIn(lx, ly) });\r\n    }\r\n  };\r\n  \r\n  const onPointerLeave = () => {\r\n    pointerInside = false;\r\n    lastSpawnX = null;\r\n    lastSpawnY = null;\r\n    pointsQueue.length = 0; // Clear queue on leave\r\n  };\r\n\r\n  const loop = (now) => {\r\n    if (destroyed) return;\r\n    \r\n    if (!lastTime) lastTime = now;\r\n    let dt = now - lastTime;\r\n    lastTime = now;\r\n    if (dt > 100) dt = 100;\r\n\r\n    // --- Spawning Logic (Process Queue) ---\r\n    const budget = { count: 0 };\r\n    \r\n    if (pointsQueue.length > 0) {\r\n        // We have new input data\r\n        for (const pt of pointsQueue) {\r\n            if (pt.inside) {\r\n                pointerInside = true;\r\n                processPoint(pt.x, pt.y, budget);\r\n            } else {\r\n                pointerInside = false;\r\n                lastSpawnX = null;\r\n                lastSpawnY = null;\r\n            }\r\n        }\r\n        // Force the last point to be spawned exactly, to ensure tip connectivity\r\n        // (processPoint already does this, but let's double check logic)\r\n        // processPoint spawns at (localX, localY). \r\n        // If the budget ran out, we might have skipped it. \r\n        // Let's force the very last point of the queue if it was inside.\r\n        const lastPt = pointsQueue[pointsQueue.length - 1];\r\n        if (lastPt.inside) {\r\n             // If we haven't spawned at exact last location yet (due to budget), force it.\r\n             // (Simple check: compare lastSpawnX/Y with lastPt)\r\n             if (lastSpawnX !== lastPt.x || lastSpawnY !== lastPt.y) {\r\n                 spawn(lastPt.x, lastPt.y);\r\n                 lastSpawnX = lastPt.x;\r\n                 lastSpawnY = lastPt.y;\r\n             }\r\n        }\r\n        \r\n        pointsQueue.length = 0; // Consumed\r\n    } else if (pointerInside && lastSpawnX !== null && lastSpawnY !== null) {\r\n        spawn(lastSpawnX, lastSpawnY);\r\n    }\r\n\r\n    // --- Render & Update ---\r\n    const activeParticles = CAPACITY - freeCount;\r\n    \r\n    if (activeParticles === 0 && !wasDirty) {\r\n      rafId = 0;\r\n      return;\r\n    }\r\n\r\n    if (lastClearRect) {\r\n      ctx.clearRect(lastClearRect.x, lastClearRect.y, lastClearRect.w, lastClearRect.h);\r\n    } else {\r\n      ctx.clearRect(0, 0, rect.width, rect.height);\r\n    }\r\n    wasDirty = false;\r\n    \r\n    let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;\r\n\r\n    let newMaxIndex = -1;\r\n    if (activeParticles > 0) {\r\n      for (let i = 0; i <= maxActiveIndex; i++) {\r\n        const offset = i * STRIDE;\r\n        let age = data[offset + 2];\r\n        \r\n        if (age >= data[offset + 3]) continue;\r\n        \r\n        age += dt;\r\n        data[offset + 2] = age;\r\n        \r\n        if (age >= data[offset + 3]) {\r\n          freeSlots[freeCount++] = i;\r\n          continue;\r\n        }\r\n\r\n        newMaxIndex = i;\r\n        \r\n        const maxAge = data[offset + 3];\r\n        const progress = age / maxAge;\r\n        const opacity = 1 - progress;\r\n        const scale = 1 - (0.4 * progress);\r\n        \r\n        wasDirty = true;\r\n        ctx.globalAlpha = opacity;\r\n        \r\n        const size = TEXTURE_SIZE * scale;\r\n        const halfSize = size / 2;\r\n        const x = data[offset];\r\n        const y = data[offset + 1];\r\n        \r\n        const drawX = Math.round(x - halfSize);\r\n        const drawY = Math.round(y - halfSize);\r\n        const drawSize = Math.round(size);\r\n        \r\n        ctx.drawImage(texture, drawX, drawY, drawSize, drawSize);\r\n\r\n        if (drawX < minX) minX = drawX;\r\n        if (drawY < minY) minY = drawY;\r\n        const right = drawX + drawSize;\r\n        const bottom = drawY + drawSize;\r\n        if (right > maxX) maxX = right;\r\n        if (bottom > maxY) maxY = bottom;\r\n      }\r\n    }\r\n    maxActiveIndex = newMaxIndex;\r\n\r\n    if (minX !== Infinity) {\r\n        const PADDING = 2;\r\n        minX -= PADDING;\r\n        minY -= PADDING;\r\n        maxX += PADDING;\r\n        maxY += PADDING;\r\n        lastClearRect = { x: minX, y: minY, w: maxX - minX, h: maxY - minY };\r\n    } else {\r\n        lastClearRect = null;\r\n    }\r\n    \r\n    rafId = requestAnimationFrame(loop);\r\n  };\r\n\r\n  // --- Listeners ---\r\n  window.addEventListener('resize', resize);\r\n  window.addEventListener('scroll', updateBounds, { passive: true });\r\n  \r\n  const opts = { passive: true };\r\n  \r\n  const onPointerEnter = (e) => {\r\n      updateBounds();\r\n      onPointerMove(e);\r\n  };\r\n\r\n  playfield.addEventListener('pointermove', onPointerMove, opts);\r\n  playfield.addEventListener('pointerdown', onPointerMove, opts);\r\n  playfield.addEventListener('pointerenter', onPointerEnter, opts);\r\n  playfield.addEventListener('pointerleave', onPointerLeave, opts);\r\n  playfield.addEventListener('pointercancel', onPointerLeave, opts);\r\n\r\n  resize();\r\n  rafId = requestAnimationFrame(loop);\r\n\r\n  const destroy = () => {\r\n    destroyed = true;\r\n    if (rafId) cancelAnimationFrame(rafId);\r\n    \r\n    if (resizeObserver) {\r\n        resizeObserver.disconnect();\r\n        resizeObserver = null;\r\n    }\r\n\r\n    try { window.removeEventListener('resize', resize); } catch {}\r\n    try { window.removeEventListener('scroll', updateBounds); } catch {}\r\n    \r\n    try {\r\n      playfield.removeEventListener('pointermove', onPointerMove);\r\n      playfield.removeEventListener('pointerdown', onPointerMove);\r\n      playfield.removeEventListener('pointerenter', onPointerEnter); \r\n      playfield.removeEventListener('pointerleave', onPointerLeave);\r\n      playfield.removeEventListener('pointercancel', onPointerLeave);\r\n    } catch {}\r\n    \r\n    canvas.remove();\r\n  };\r\n\r\n  return { destroy };\r\n}\r\n", "// js/game/coinPickup.js\r\n\r\nimport { bank, CURRENCIES, getActiveSlot, isCurrencyLocked } from '../util/storage.js';\r\nimport { BigNum } from '../util/bigNum.js';\r\nimport { formatNumber } from '../util/numFormat.js';\r\nimport { unlockShop } from '../ui/hudButtons.js';\r\nimport { addXp, isXpSystemUnlocked } from './xpSystem.js';\r\nimport { IS_MOBILE } from '../main.js';\r\nimport {\r\n  addMutationPower,\r\n  isMutationUnlocked,\r\n  getMutationState,\r\n  onMutationChange,\r\n  computeMutationMultiplierForLevel,\r\n} from './mutationSystem.js';\r\nimport { getMpValueMultiplierBn, getMagnetLevel } from './upgrades.js';\r\nimport { createCursorTrail } from './cursorTrail.js';\r\n\r\nlet mutationUnlockedSnapshot = false;\r\nlet mutationLevelIsInfiniteSnapshot = false;\r\nlet mutationCurrentLevelStr = '0';\r\nlet mutationUnsub = null;\r\n\r\nfunction updateMutationSnapshot(state) {\r\n  if (!state || typeof state !== 'object') {\r\n    mutationUnlockedSnapshot = false;\r\n    mutationLevelIsInfiniteSnapshot = false;\r\n    mutationCurrentLevelStr = '0';\r\n    mutationMultiplierCache.clear();\r\n    return;\r\n  }\r\n\r\n  mutationUnlockedSnapshot = !!state.unlocked;\r\n  mutationLevelIsInfiniteSnapshot = !!state.level?.isInfinite?.();\r\n  try {\r\n    mutationCurrentLevelStr = state.level?.toPlainIntegerString?.() ?? '0';\r\n  } catch {\r\n    mutationCurrentLevelStr = '0';\r\n  }\r\n\r\n  if (!mutationUnlockedSnapshot) {\r\n    mutationMultiplierCache.clear();\r\n  } else if (mutationLevelIsInfiniteSnapshot) {\r\n    mutationMultiplierCache.clear();\r\n  }\r\n}\r\n\r\nfunction initMutationSnapshot() {\r\n  if (typeof mutationUnsub === 'function') {\r\n    try { mutationUnsub(); } catch {}\r\n  }\r\n  try {\r\n    updateMutationSnapshot(getMutationState());\r\n  } catch {\r\n    mutationUnlockedSnapshot = false;\r\n    mutationMultiplierCache.clear();\r\n  }\r\n  try {\r\n    mutationUnsub = onMutationChange((snapshot) => { updateMutationSnapshot(snapshot); });\r\n  } catch {\r\n    mutationUnsub = null;\r\n  }\r\n}\r\n\r\nlet coinPickup = null;\r\n\r\nconst XP_PER_COIN = BigNum.fromInt(1);\r\nconst BASE_COIN_VALUE = BigNum.fromInt(1);\r\nconst BN_ONE = BigNum.fromInt(1);\r\n\r\nlet BN_INF;\r\ntry {\r\n  BN_INF = BigNum.fromAny('Infinity');\r\n} catch {\r\n  BN_INF = null;\r\n}\r\n\r\nconst mutationMultiplierCache = new Map();\r\nlet COIN_MULTIPLIER = '1';\r\nlet mpValueMultiplierBn = BigNum.fromInt(1);\r\nlet mpMultiplierListenersBound = false;\r\n\r\n// Module-level state for queuing and HUD updates\r\nlet pendingCoinGain = null;\r\nlet pendingXpGain = null;\r\nlet pendingMutGain = null;\r\nlet flushScheduled = false;\r\nlet coinsVal = null; // Cached BigNum value for HUD\r\nlet updateHudFn = () => {}; // No-op until initialized\r\n\r\nlet hudUpdateScheduled = false;\r\nconst scheduleHudUpdate = () => {\r\n  if (hudUpdateScheduled) return;\r\n  hudUpdateScheduled = true;\r\n  requestAnimationFrame(() => {\r\n    hudUpdateScheduled = false;\r\n    updateHudFn();\r\n  });\r\n};\r\n\r\nexport function setCoinMultiplier(x) {\r\n  COIN_MULTIPLIER = x;\r\n  try {\r\n    if (bank.coins?.mult?.set) {\r\n      bank.coins.mult.set(x);\r\n    }\r\n  } catch {}\r\n}\r\n\r\nfunction refreshMpValueMultiplierCache() {\r\n  try {\r\n    const next = getMpValueMultiplierBn();\r\n    if (next instanceof BigNum) {\r\n      mpValueMultiplierBn = next.clone?.() ?? next;\r\n    } else if (next != null) {\r\n      mpValueMultiplierBn = BigNum.fromAny(next);\r\n    } else {\r\n      mpValueMultiplierBn = BigNum.fromInt(1);\r\n    }\r\n  } catch {\r\n    mpValueMultiplierBn = BigNum.fromInt(1);\r\n  }\r\n}\r\n\r\nfunction ensureMpValueMultiplierSync() {\r\n  if (mpMultiplierListenersBound) return;\r\n  mpMultiplierListenersBound = true;\r\n  refreshMpValueMultiplierCache();\r\n  if (typeof document !== 'undefined') {\r\n    document.addEventListener('ccc:upgrades:changed', refreshMpValueMultiplierCache);\r\n  }\r\n  if (typeof window !== 'undefined') {\r\n    window.addEventListener('saveSlot:change', refreshMpValueMultiplierCache);\r\n  }\r\n}\r\n\r\nfunction resolveCoinBase(el) {\r\n  if (el?.dataset?.bn) {\r\n    try { return BigNum.fromAny(el.dataset.bn); } catch {}\r\n  }\r\n  if (el?.dataset?.value) {\r\n    try { return BigNum.fromAny(el.dataset.value); } catch {}\r\n  }\r\n  try { return BASE_COIN_VALUE.clone?.() ?? BigNum.fromInt(1); }\r\n  catch { return BigNum.fromInt(1); }\r\n}\r\n\r\nconst MAGNET_UNIT_RATIO = 0.03;\r\nconst MAGNET_COLLECTION_BUFFER = 8; // Small buffer for collection feel\r\n\r\nfunction computeMagnetUnitPx() {\r\n  if (typeof window === 'undefined' || typeof document === 'undefined') return 0;\r\n  const root = document.documentElement;\r\n  const vw = Math.max(0, window.innerWidth || root?.clientWidth || 0);\r\n  const vh = Math.max(0, window.innerHeight || root?.clientHeight || 0);\r\n  if (!(vw > 0 && vh > 0)) return 0;\r\n  const minDim = Math.min(vw, vh);\r\n  return minDim * MAGNET_UNIT_RATIO;\r\n}\r\n\r\nfunction createMagnetController({ playfield, coinsLayer, coinSelector, collectFn, collectBatchFn, spawner }) {\r\n  if (!playfield || !coinsLayer || typeof collectFn !== 'function') {\r\n    return { destroy() {} };\r\n  }\r\n  if (typeof window === 'undefined' || typeof document === 'undefined') {\r\n    return { destroy() {} };\r\n  }\r\n\r\n  const indicator = document.createElement('div');\r\n  indicator.className = 'magnet-indicator';\r\n  indicator.setAttribute('aria-hidden', 'true');\r\n  playfield.appendChild(indicator);\r\n\r\n  let pointerInside = false;\r\n  let hasPointer = false;\r\n  let pointerClientX = 0;\r\n  let pointerClientY = 0;\r\n  let localX = 0;\r\n  let localY = 0;\r\n  // Track last local position for interpolation\r\n  let lastLocalX = null;\r\n  let lastLocalY = null;\r\n\r\n  let unitPx = computeMagnetUnitPx();\r\n  let magnetLevel = 0;\r\n  let radiusPx = 0;\r\n  let rafId = 0;\r\n  let destroyed = false;\r\n  let playfieldRect = null;\r\n\r\n  const updatePlayfieldRect = () => {\r\n    if (destroyed) return;\r\n    playfieldRect = playfield.getBoundingClientRect();\r\n  };\r\n\r\n  const hideIndicator = () => {\r\n    indicator.classList.remove('is-visible');\r\n    indicator.style.transform = 'translate3d(-9999px, -9999px, 0)';\r\n    lastLocalX = null;\r\n    lastLocalY = null;\r\n  };\r\n\r\n  const updateIndicator = () => {\r\n    if (!pointerInside || radiusPx <= 0) {\r\n      hideIndicator();\r\n      return;\r\n    }\r\n    const diameter = radiusPx * 2;\r\n    indicator.style.width = `${diameter}px`;\r\n    indicator.style.height = `${diameter}px`;\r\n    indicator.style.transform = `translate3d(${localX - radiusPx}px, ${localY - radiusPx}px, 0)`;\r\n    indicator.classList.add('is-visible');\r\n  };\r\n\r\n  const sweepCoins = () => {\r\n    if (!pointerInside || radiusPx <= 0) return;\r\n    \r\n    // Optimized: Use Spawner's spatial lookup if available\r\n    if (spawner && typeof spawner.findCoinsInRadius === 'function') {\r\n        // spawner operates in local playfield coordinates (x, y relative to top-left of playfield)\r\n        // localX, localY are already relative to playfieldRect\r\n        \r\n        const radiusWithBuffer = radiusPx + MAGNET_COLLECTION_BUFFER;\r\n        \r\n        let candidates = [];\r\n        // Use swept path check if available && we have a previous position\r\n        if (typeof spawner.findCoinsInPath === 'function' && lastLocalX !== null && lastLocalY !== null) {\r\n             candidates = spawner.findCoinsInPath(lastLocalX, lastLocalY, localX, localY, radiusWithBuffer);\r\n        } else {\r\n             candidates = spawner.findCoinsInRadius(localX, localY, radiusWithBuffer);\r\n        }\r\n\r\n        // Update last position\r\n        lastLocalX = localX;\r\n        lastLocalY = localY;\r\n        \r\n        if (candidates && candidates.length > 0) {\r\n            // Helper to resolve transform from spawner or DOM\r\n            const getTransform = (el) => {\r\n                if (spawner && typeof spawner.getCoinTransform === 'function') {\r\n                    return spawner.getCoinTransform(el);\r\n                }\r\n                return el.style.transform || 'translate3d(0,0,0)';\r\n            };\r\n\r\n            if (typeof collectBatchFn === 'function') {\r\n                 const items = [];\r\n                 for (let i = 0; i < candidates.length; i++) {\r\n                     const el = candidates[i];\r\n                     items.push({ el, opts: { transform: getTransform(el) } });\r\n                 }\r\n                 collectBatchFn(items);\r\n            } else {\r\n                const transforms = [];\r\n                for (let i = 0; i < candidates.length; i++) {\r\n                    const el = candidates[i];\r\n                    transforms.push(getTransform(el));\r\n                }\r\n                for (let i = 0; i < candidates.length; i++) {\r\n                    collectFn(candidates[i], { transform: transforms[i] });\r\n                }\r\n            }\r\n        }\r\n    } else {\r\n        // Fallback (Slow) - should not be hit if spawner is passed\r\n        const coins = coinsLayer.children;\r\n        const radiusWithBuffer = radiusPx + MAGNET_COLLECTION_BUFFER;\r\n        const toCollect = [];\r\n        \r\n        for (let i = coins.length - 1; i >= 0; i--) {\r\n          const coin = coins[i];\r\n          if (coin.dataset.collected === '1') continue;\r\n          if (!coin.matches(coinSelector)) continue;\r\n    \r\n          const rect = coin.getBoundingClientRect();\r\n          const coinX = rect.left + rect.width / 2;\r\n          const coinY = rect.top + rect.height / 2;\r\n          const dx = coinX - pointerClientX;\r\n          const dy = coinY - pointerClientY;\r\n          if (Math.hypot(dx, dy) <= radiusWithBuffer) {\r\n            toCollect.push(coin);\r\n          }\r\n        }\r\n    \r\n        if (!toCollect.length) return;\r\n    \r\n        if (typeof collectBatchFn === 'function') {\r\n            const items = [];\r\n            for (let i = 0; i < toCollect.length; i++) {\r\n                const el = toCollect[i];\r\n                const cs = window.getComputedStyle(el);\r\n                items.push({ el, opts: { transform: cs.transform } });\r\n            }\r\n            collectBatchFn(items);\r\n        } else {\r\n            const transforms = [];\r\n            for (let i = 0; i < toCollect.length; i++) {\r\n                const el = toCollect[i];\r\n                const cs = window.getComputedStyle(el);\r\n                transforms.push(cs.transform);\r\n            }\r\n            for (let i = 0; i < toCollect.length; i++) {\r\n                collectFn(toCollect[i], { transform: transforms[i] });\r\n            }\r\n        }\r\n    }\r\n  };\r\n\r\n  const runSweep = () => {\r\n    rafId = 0;\r\n    updateIndicator();\r\n    if (!pointerInside || radiusPx <= 0 || destroyed) return;\r\n    sweepCoins();\r\n    ensureSweepLoop();\r\n  };\r\n\r\n  const ensureSweepLoop = () => {\r\n    if (!pointerInside || radiusPx <= 0 || rafId || destroyed) return;\r\n    rafId = requestAnimationFrame(runSweep);\r\n  };\r\n\r\n  const updatePointerFromEvent = (e) => {\r\n    if (!e || destroyed) return;\r\n    if (typeof e.clientX !== 'number' || typeof e.clientY !== 'number') return;\r\n    hasPointer = true;\r\n    pointerClientX = e.clientX;\r\n    pointerClientY = e.clientY;\r\n    \r\n    if (!playfieldRect) updatePlayfieldRect();\r\n    const rect = playfieldRect;\r\n\r\n    localX = pointerClientX - rect.left;\r\n    localY = pointerClientY - rect.top;\r\n    pointerInside = localX >= 0 && localX <= rect.width && localY >= 0 && localY <= rect.height;\r\n    \r\n    ensureSweepLoop();\r\n  };\r\n\r\n  const handlePointerLeave = () => {\r\n    pointerInside = false;\r\n    hideIndicator();\r\n    lastLocalX = null;\r\n    lastLocalY = null;\r\n  };\r\n\r\n  const refreshMagnetLevel = () => {\r\n    const nextLevel = getMagnetLevel();\r\n    magnetLevel = nextLevel;\r\n    radiusPx = magnetLevel * unitPx;\r\n    updateIndicator();\r\n    ensureSweepLoop();\r\n  };\r\n\r\n  const handleScroll = () => {\r\n    if (destroyed || !hasPointer) return;\r\n    updatePlayfieldRect();\r\n    if (playfieldRect) {\r\n        const rect = playfieldRect;\r\n        localX = pointerClientX - rect.left;\r\n        localY = pointerClientY - rect.top;\r\n        pointerInside = localX >= 0 && localX <= rect.width && localY >= 0 && localY <= rect.height;\r\n    }\r\n    ensureSweepLoop();\r\n  };\r\n\r\n  const handleResize = () => {\r\n    unitPx = computeMagnetUnitPx();\r\n    radiusPx = magnetLevel * unitPx;\r\n    updatePlayfieldRect();\r\n    if (hasPointer && playfieldRect) {\r\n        const rect = playfieldRect;\r\n        localX = pointerClientX - rect.left;\r\n        localY = pointerClientY - rect.top;\r\n        pointerInside = localX >= 0 && localX <= rect.width && localY >= 0 && localY <= rect.height;\r\n    }\r\n    ensureSweepLoop();\r\n  };\r\n\r\n  const destroy = () => {\r\n    destroyed = true;\r\n    if (rafId) {\r\n      cancelAnimationFrame(rafId);\r\n      rafId = 0;\r\n    }\r\n    try { window.removeEventListener('scroll', handleScroll); } catch {}\r\n    try { window.removeEventListener('resize', handleResize); } catch {}\r\n    try { window.removeEventListener('saveSlot:change', refreshMagnetLevel); } catch {}\r\n    try { document.removeEventListener('ccc:upgrades:changed', refreshMagnetLevel); } catch {}\r\n    try { playfield.removeEventListener('pointermove', updatePointerFromEvent); } catch {}\r\n    try { playfield.removeEventListener('pointerdown', updatePointerFromEvent); } catch {}\r\n    try { playfield.removeEventListener('pointerenter', updatePointerFromEvent); } catch {}\r\n    try { playfield.removeEventListener('pointerleave', handlePointerLeave); } catch {}\r\n    try { playfield.removeEventListener('pointercancel', handlePointerLeave); } catch {}\r\n    try { indicator.remove(); } catch {}\r\n  };\r\n\r\n  const pointerOpts = { passive: true };\r\n  playfield.addEventListener('pointermove', updatePointerFromEvent, pointerOpts);\r\n  playfield.addEventListener('pointerdown', updatePointerFromEvent, pointerOpts);\r\n  playfield.addEventListener('pointerenter', updatePointerFromEvent, pointerOpts);\r\n  playfield.addEventListener('pointerleave', handlePointerLeave, pointerOpts);\r\n  playfield.addEventListener('pointercancel', handlePointerLeave, pointerOpts);\r\n  window.addEventListener('resize', handleResize);\r\n  window.addEventListener('scroll', handleScroll, { passive: true });\r\n  window.addEventListener('saveSlot:change', refreshMagnetLevel);\r\n  document.addEventListener('ccc:upgrades:changed', refreshMagnetLevel);\r\n\r\n  refreshMagnetLevel();\r\n\r\n  return { destroy };\r\n}\r\n\r\n// Queue helpers moved to module scope\r\nconst cloneBn = (value) => {\r\n  if (!value) return BigNum.fromInt(0);\r\n  if (typeof value.clone === 'function') {\r\n    try { return value.clone(); } catch {}\r\n  }\r\n  try { return BigNum.fromAny(value); } catch { return BigNum.fromInt(0); }\r\n};\r\n\r\nconst mergeGain = (current, gain) => {\r\n  if (!gain) return current;\r\n  if (!current) return cloneBn(gain);\r\n  try { return current.add(gain); }\r\n  catch {\r\n    try {\r\n      const base = cloneBn(current);\r\n      return base.add(gain);\r\n    } catch {\r\n      return cloneBn(gain);\r\n    }\r\n  }\r\n};\r\n\r\nconst flushPendingGains = () => {\r\n  const coinGain = pendingCoinGain;\r\n  pendingCoinGain = null;\r\n  if (coinGain && !coinGain.isZero?.()) {\r\n    try { bank.coins.add(coinGain); } catch {}\r\n  }\r\n\r\n  const xpGain = pendingXpGain;\r\n  pendingXpGain = null;\r\n  if (xpGain && !xpGain.isZero?.()) {\r\n    try { addXp(xpGain); } catch {}\r\n  }\r\n\r\n  const mutGain = pendingMutGain;\r\n  pendingMutGain = null;\r\n  if (mutGain && !mutGain.isZero?.()) {\r\n    try { addMutationPower(mutGain); } catch {}\r\n  }\r\n};\r\n\r\nconst scheduleFlush = () => {\r\n  if (flushScheduled) return;\r\n  flushScheduled = true;\r\n  requestAnimationFrame(() => {\r\n    flushScheduled = false;\r\n    flushPendingGains();\r\n  });\r\n};\r\n\r\nconst queueCoinGain = (gain) => {\r\n  pendingCoinGain = mergeGain(pendingCoinGain, gain);\r\n  scheduleFlush();\r\n};\r\n\r\nconst queueXpGain = (gain) => {\r\n  pendingXpGain = mergeGain(pendingXpGain, gain);\r\n  scheduleFlush();\r\n};\r\n\r\nconst queueMutationGain = (gain) => {\r\n  pendingMutGain = mergeGain(pendingMutGain, gain);\r\n  scheduleFlush();\r\n};\r\n\r\nif (typeof window !== 'undefined') {\r\n  window.addEventListener('beforeunload', flushPendingGains, { passive: true });\r\n}\r\n\r\nexport function clearPendingGains() {\r\n  pendingCoinGain = null;\r\n  pendingXpGain = null;\r\n  pendingMutGain = null;\r\n}\r\n\r\nlet coinMultiplierBn = null;\r\nlet coinMultiplierIsInfinite = false;\r\n\r\nconst refreshCoinMultiplierCache = () => {\r\n  try {\r\n    const multHandle = bank?.coins?.mult;\r\n    if (!multHandle || typeof multHandle.get !== 'function') {\r\n      coinMultiplierBn = null;\r\n      coinMultiplierIsInfinite = false;\r\n      return;\r\n    }\r\n    const next = multHandle.get();\r\n    if (!next) {\r\n      coinMultiplierBn = BigNum.fromInt(1);\r\n      coinMultiplierIsInfinite = false;\r\n      return;\r\n    }\r\n    coinMultiplierBn = next.clone?.() ?? BigNum.fromAny(next);\r\n    coinMultiplierIsInfinite = !!coinMultiplierBn?.isInfinite?.();\r\n  } catch {\r\n    coinMultiplierBn = null;\r\n    coinMultiplierIsInfinite = false;\r\n  }\r\n};\r\n\r\nconst applyCoinMultiplier = (value) => {\r\n  let base;\r\n  try {\r\n    base = value instanceof BigNum\r\n      ? (value.clone?.() ?? value)\r\n      : BigNum.fromAny(value ?? 0);\r\n  } catch {\r\n    try {\r\n      return bank?.coins?.mult?.applyTo ? bank.coins.mult.applyTo(value) : BigNum.fromInt(0);\r\n    } catch {\r\n      return BigNum.fromInt(0);\r\n    }\r\n  }\r\n\r\n  if (!coinMultiplierBn) refreshCoinMultiplierCache();\r\n  const mult = coinMultiplierBn;\r\n  if (!mult) {\r\n    try { return bank?.coins?.mult?.applyTo ? bank.coins.mult.applyTo(base) : base.clone?.() ?? base; }\r\n    catch { return base.clone?.() ?? base; }\r\n  }\r\n  const multIsInf = coinMultiplierIsInfinite || mult.isInfinite?.();\r\n  if (multIsInf) {\r\n    try { return BigNum.fromAny('Infinity'); }\r\n    catch { return base.clone?.() ?? base; }\r\n  }\r\n  if (base.isZero?.()) {\r\n    return base.clone?.() ?? base;\r\n  }\r\n  try {\r\n    return base.mulBigNumInteger(mult);\r\n  } catch {\r\n    try { return bank?.coins?.mult?.applyTo ? bank.coins.mult.applyTo(base) : base.clone?.() ?? base; }\r\n    catch { return base.clone?.() ?? base; }\r\n  }\r\n};\r\n\r\nconst computeMutationMultiplier = (spawnLevelStr) => {\r\n  if (!mutationUnlockedSnapshot) return null;\r\n\r\n  if (mutationLevelIsInfiniteSnapshot) {\r\n    if (BN_INF) {\r\n      try { return BN_INF.clone?.() ?? BN_INF; }\r\n      catch { return BN_INF; }\r\n    }\r\n    return null;\r\n  }\r\n\r\n  if (!spawnLevelStr) return null;\r\n  const key = String(spawnLevelStr).trim();\r\n  if (!key) return null;\r\n\r\n  const cached = mutationMultiplierCache.get(key);\r\n  if (cached) {\r\n    try { return cached.clone?.() ?? BigNum.fromAny(cached); }\r\n    catch { mutationMultiplierCache.delete(key); }\r\n  }\r\n\r\n  let levelBn;\r\n  try {\r\n    levelBn = BigNum.fromAny(key);\r\n  } catch {\r\n    return null;\r\n  }\r\n\r\n  let multiplier;\r\n  try {\r\n    multiplier = computeMutationMultiplierForLevel(levelBn);\r\n  } catch {\r\n    multiplier = null;\r\n  }\r\n\r\n  if (!multiplier) return null;\r\n  const isIdentity = multiplier.cmp?.(BN_ONE) === 0;\r\n  const stored = multiplier.clone?.() ?? multiplier;\r\n  mutationMultiplierCache.set(key, stored);\r\n  if (isIdentity) return null;\r\n  try { return stored.clone?.() ?? stored; }\r\n  catch { return stored; }\r\n};\r\n\r\n// --- New Logic for Passive/Active Automation ---\r\n\r\nfunction calculateCoinValue(spawnLevelStr) {\r\n  const base = BASE_COIN_VALUE.clone?.() ?? BigNum.fromInt(1);\r\n  let inc = applyCoinMultiplier(base);\r\n  let xpInc = cloneBn(XP_PER_COIN);\r\n\r\n  // If spawnLevelStr is null/undefined, use current mutation level (passive generation)\r\n  const levelStr = spawnLevelStr ?? mutationCurrentLevelStr;\r\n  const mutationMultiplier = computeMutationMultiplier(levelStr);\r\n  \r\n  if (mutationMultiplier) {\r\n    try { inc = inc.mulBigNumInteger(mutationMultiplier); } catch {}\r\n    try { xpInc = xpInc.mulBigNumInteger(mutationMultiplier); } catch {}\r\n  }\r\n  \r\n  const mpGain = (typeof isMutationUnlocked === 'function' && isMutationUnlocked())\r\n    ? cloneBn(mpValueMultiplierBn)\r\n    : BigNum.fromInt(0);\r\n\r\n  return { coinGain: inc, xpGain: xpInc, mpGain };\r\n}\r\n\r\nexport function getPassiveCoinReward() {\r\n  const { coinGain, xpGain, mpGain } = calculateCoinValue(null);\r\n  return { \r\n    coins: coinGain, \r\n    xp: xpGain, \r\n    mp: mpGain \r\n  };\r\n}\r\n\r\nexport function triggerPassiveCollect(count = 1) {\r\n  if (count <= 0) return;\r\n  const { coinGain, xpGain, mpGain } = calculateCoinValue(null);\r\n  \r\n  const totalCoin = coinGain.mulBigNumInteger(BigNum.fromInt(count));\r\n  const totalXp = xpGain.mulBigNumInteger(BigNum.fromInt(count));\r\n  const totalMp = mpGain.mulBigNumInteger(BigNum.fromInt(count));\r\n\r\n  const coinsLocked = isCurrencyLocked(CURRENCIES.COINS);\r\n  const incIsZero = typeof totalCoin?.isZero === 'function' ? totalCoin.isZero() : false;\r\n\r\n  if (!incIsZero && !coinsLocked) {\r\n    try {\r\n      coinsVal = coinsVal?.add ? coinsVal.add(totalCoin) : cloneBn(totalCoin);\r\n    } catch {\r\n      coinsVal = cloneBn(totalCoin);\r\n    }\r\n  }\r\n  scheduleHudUpdate();\r\n\r\n  if (!incIsZero) {\r\n    queueCoinGain(totalCoin);\r\n  }\r\n\r\n  const xpEnabled = typeof isXpSystemUnlocked === 'function' ? isXpSystemUnlocked() : true;\r\n  const xpIsZero = typeof totalXp?.isZero === 'function' ? totalXp.isZero() : false;\r\n  if (xpEnabled && !xpIsZero) {\r\n    queueXpGain(totalXp);\r\n  }\r\n\r\n  if (!totalMp.isZero?.()) {\r\n    queueMutationGain(totalMp);\r\n  }\r\n}\r\n\r\nexport function initCoinPickup({\r\n  spawner,\r\n  playfieldSelector   = '.area-cove .playfield',\r\n  coinsLayerSelector  = '.area-cove .coins-layer',\r\n  hudAmountSelector   = '.hud-top .coin-amount',\r\n  coinSelector        = '.coin, [data-coin], .coin-sprite',\r\n  soundSrc            = 'sounds/coin_pickup.ogg',\r\n  storageKey          = 'ccc:coins',\r\n  disableAnimation    = false, // Force false to re-enable on mobile\r\n} = {}) {\r\n  if (coinPickup?.destroy) {\r\n    coinPickup.destroy();\r\n  }\r\n  \r\n  const pf  = document.querySelector(playfieldSelector);\r\n  const cl  = document.querySelector(coinsLayerSelector);\r\n  const amt = document.querySelector(hudAmountSelector);\r\n  if (!pf || !cl || !amt) {\r\n    console.warn('[coinPickup] missing required nodes', { pf: !!pf, cl: !!cl, amt: !!amt });\r\n    return { destroy(){} };\r\n  }\r\n\r\n  initMutationSnapshot();\r\n  ensureMpValueMultiplierSync();\r\n\r\n  pf.style.touchAction = 'none';\r\n\r\n  let magnetController = null;\r\n  let cursorTrail = null;\r\n  coinsVal = bank.coins.value;\r\n  \r\n  updateHudFn = () => {\r\n    const formatted = formatNumber(coinsVal);\r\n    if (formatted.includes('<span')) {\r\n      amt.innerHTML = formatted;\r\n    } else {\r\n      amt.textContent = formatted;\r\n    }\r\n  };\r\n  \r\n  refreshCoinMultiplierCache();\r\n  scheduleHudUpdate();\r\n\r\n  const onCurrencyChange = (e) => {\r\n    if (!e?.detail) return;\r\n    if (e.detail.key === 'coins') {\r\n      coinsVal = e.detail.value;\r\n      scheduleHudUpdate();\r\n    }\r\n  };\r\n  window.addEventListener('currency:change', onCurrencyChange);\r\n\r\n  const onCoinMultiplierChange = (event) => {\r\n    if (!event?.detail || event.detail.key !== 'coins') return;\r\n    try {\r\n      const { mult } = event.detail;\r\n      if (mult instanceof BigNum) {\r\n        coinMultiplierBn = mult.clone?.() ?? mult;\r\n      } else if (mult != null) {\r\n        coinMultiplierBn = BigNum.fromAny(mult);\r\n      } else {\r\n        coinMultiplierBn = BigNum.fromInt(1);\r\n      }\r\n      coinMultiplierIsInfinite = !!coinMultiplierBn?.isInfinite?.();\r\n    } catch {\r\n      coinMultiplierBn = null;\r\n      coinMultiplierIsInfinite = false;\r\n    }\r\n  };\r\n  window.addEventListener('currency:multiplier', onCoinMultiplierChange);\r\n\r\n  // ----- Slot-scoped shop unlock/progress keys -----\r\n  const slot = getActiveSlot();\r\n  if (slot == null) {\r\n    console.warn('[coinPickup] init called before a save slot is selected.');\r\n    return { destroy(){} };\r\n  }\r\n  const SHOP_UNLOCK_KEY   = `ccc:unlock:shop:${slot}`;\r\n  const SHOP_PROGRESS_KEY = `ccc:unlock:shop:progress:${slot}`;\r\n\r\n  const legacyP = localStorage.getItem('ccc:unlock:shop:progress');\r\n  const legacyU = localStorage.getItem('ccc:unlock:shop');\r\n  if (legacyP != null && localStorage.getItem(SHOP_PROGRESS_KEY) == null) {\r\n    localStorage.setItem(SHOP_PROGRESS_KEY, legacyP);\r\n  }\r\n  if (legacyU != null && localStorage.getItem(SHOP_UNLOCK_KEY) == null) {\r\n    localStorage.setItem(SHOP_UNLOCK_KEY, legacyU);\r\n  }\r\n  localStorage.removeItem('ccc:unlock:shop:progress');\r\n  localStorage.removeItem('ccc:unlock:shop');\r\n\r\n  {\r\n    const p = parseInt(localStorage.getItem(SHOP_PROGRESS_KEY) || '0', 10);\r\n    localStorage.setItem(SHOP_PROGRESS_KEY, String(p));\r\n    if (p >= 10 && localStorage.getItem(SHOP_UNLOCK_KEY) !== '1') {\r\n      try { unlockShop(); } catch {}\r\n      localStorage.setItem(SHOP_UNLOCK_KEY, '1');\r\n    }\r\n  }\r\n\r\n  const resolvedSrc = new URL(soundSrc, document.baseURI).href;\r\n  \r\n  // Optimization: use _coinObj if present, fallback to dataset/matches\r\n  const isCoin = (el) => {\r\n      if (!(el instanceof HTMLElement)) return false;\r\n      // Fast path: Check for attached object\r\n      if (el._coinObj) return !el._coinObj.isRemoved && el.dataset.collected !== '1';\r\n      return el.dataset.collected !== '1' && el.matches(coinSelector);\r\n  };\r\n\r\n  function ensureInteractive(el){ try { el.style.pointerEvents = 'auto'; } catch {} }\r\n  cl.querySelectorAll(coinSelector).forEach(ensureInteractive);\r\n  \r\n  // ----- Audio (Mobile: WebAudio + fallback) -----\r\n  let ac = null, masterGain = null, buffer = null;\r\n  let webAudioReady = false, webAudioLoading = false;\r\n\r\n  let mobileFallback = null;\r\n  function playCoinMobileFallback(){\r\n    if (!mobileFallback){\r\n      mobileFallback = new Audio(resolvedSrc);\r\n      mobileFallback.preload = 'auto';\r\n    }\r\n    mobileFallback.muted = false;\r\n    mobileFallback.volume = 0.12; // Const\r\n    try {\r\n      mobileFallback.currentTime = 0;\r\n      mobileFallback.play();\r\n    } catch {}\r\n  }\r\n\r\n  async function initWebAudioOnce(){\r\n    if (webAudioReady || webAudioLoading) return;\r\n    if (!('AudioContext' in window || 'webkitAudioContext' in window)) return;\r\n\r\n    webAudioLoading = true;\r\n    ac = new (window.AudioContext || window.webkitAudioContext)();\r\n    masterGain = ac.createGain();\r\n    masterGain.gain.value = 0.12; // Const\r\n    masterGain.connect(ac.destination);\r\n\r\n    try {\r\n      const res = await fetch(resolvedSrc, { cache: 'force-cache' });\r\n      const arr = await res.arrayBuffer();\r\n      buffer = await new Promise((ok, err) => ac.decodeAudioData(arr, ok, err));\r\n      if (ac.state === 'suspended') { try { await ac.resume(); } catch {} }\r\n      webAudioReady = true;\r\n    } catch (e) {\r\n      console.warn('[coinPickup] WebAudio init failed:', e);\r\n    } finally {\r\n      webAudioLoading = false;\r\n    }\r\n  }\r\n\r\n  function playCoinWebAudio(){\r\n    if (ac && ac.state === 'suspended'){ try { ac.resume(); } catch {} }\r\n\r\n    if (IS_MOBILE && (!webAudioReady || !ac || !buffer || !masterGain || (ac && ac.state !== 'running'))) {\r\n      if (!webAudioLoading) initWebAudioOnce();\r\n      playCoinMobileFallback();\r\n      return true;\r\n    }\r\n\r\n    if (!webAudioReady || !ac || !buffer || !masterGain) {\r\n      if (!webAudioLoading) initWebAudioOnce();\r\n      return true;\r\n    }\r\n\r\n    try {\r\n      const src = ac.createBufferSource();\r\n      src.buffer = buffer;\r\n      try { src.detune = 0; } catch {}\r\n      masterGain.gain.setValueAtTime(0.12, ac.currentTime);\r\n      src.connect(masterGain);\r\n      const t = ac.currentTime + Math.random()*0.006;\r\n      src.start(t);\r\n      return true;\r\n    } catch (e){\r\n      console.warn('[coinPickup] playCoinWebAudio error:', e);\r\n      if (IS_MOBILE) playCoinMobileFallback();\r\n      return false;\r\n    }\r\n  }\r\n\r\n  function playSound(){\r\n    if (IS_MOBILE) return playCoinWebAudio();\r\n    return playCoinHtmlAudio();\r\n  }\r\n\r\n  const warm = () => { if (IS_MOBILE) initWebAudioOnce(); };\r\n  ['pointerdown', 'touchstart', 'click'].forEach(evt => {\r\n    window.addEventListener(evt, warm, { once: true, passive: true, capture: true });\r\n    pf.addEventListener(evt, warm, { once: true, passive: true, capture: true });\r\n  });\r\n\r\n  let pool = null, pIdx = 0, lastAt = 0;\r\n  if (!IS_MOBILE){\r\n    pool = Array.from({ length: 8 }, () => { const a = new Audio(resolvedSrc); a.preload = 'auto'; a.volume = 0.3; return a; });\r\n  }\r\n  function playCoinHtmlAudio(){\r\n    const now = performance.now(); if ((now - lastAt) < 40) return; lastAt = now;\r\n    const a = pool[pIdx++ % pool.length];\r\n    try { a.currentTime = 0; a.play(); } catch {}\r\n  }\r\n\r\n  function animateAndRemove(el, opts = {}){\r\n    // Notify spawner that this coin is \"taken\" so physics stops\r\n    if (spawner && typeof spawner.detachCoin === 'function') {\r\n        spawner.detachCoin(el);\r\n    }\r\n\r\n    const recycle = () => {\r\n        if (!el) return;\r\n        if (spawner && typeof spawner.recycleCoin === 'function') {\r\n            spawner.recycleCoin(el);\r\n        } else {\r\n            el.remove();\r\n        }\r\n    };\r\n\r\n    if (disableAnimation || IS_MOBILE) {\r\n        recycle();\r\n        return; \r\n    }\r\n    \r\n    let start = 'translate3d(0,0,0)';\r\n    if (opts.transform) {\r\n        if (opts.transform !== 'none') start = opts.transform;\r\n    } else {\r\n        // Fallback if no transform passed (shouldn't happen with new logic)\r\n        start = el.style.transform || 'translate3d(0,0,0)';\r\n    }\r\n\r\n    el.style.setProperty('--ccc-start', start);\r\n    el.classList.add('coin--collected');\r\n    \r\n    let complete = false;\r\n    const done = () => { \r\n        if (complete) return;\r\n        complete = true;\r\n        el.removeEventListener('animationend', done); \r\n        recycle();\r\n    };\r\n    el.addEventListener('animationend', done);\r\n    setTimeout(done, 600);\r\n  }\r\n\r\n  function collectBatch(items) {\r\n    if (!items || !items.length) return;\r\n    \r\n    // Play sound once per batch\r\n    playSound();\r\n\r\n    let totalCoin = null;\r\n    let totalXp = null;\r\n    let totalMp = null;\r\n    let collectedCount = 0;\r\n\r\n    const coinsLocked = isCurrencyLocked(CURRENCIES.COINS);\r\n    const xpEnabled = typeof isXpSystemUnlocked === 'function' ? isXpSystemUnlocked() : true;\r\n    const mutEnabled = typeof isMutationUnlocked === 'function' && isMutationUnlocked();\r\n\r\n    for (const { el, opts } of items) {\r\n      if (!isCoin(el)) continue;\r\n      el.dataset.collected = '1';\r\n      collectedCount++;\r\n\r\n      animateAndRemove(el, opts || {});\r\n\r\n      const base = resolveCoinBase(el);\r\n      // Fast path: use attached object if available\r\n      const spawnLevelStr = el._coinObj?.mutationLevel ?? (el.dataset.mutationLevel || null);\r\n      \r\n      let inc = applyCoinMultiplier(base);\r\n      let xpInc = cloneBn(XP_PER_COIN);\r\n\r\n      const mutationMultiplier = computeMutationMultiplier(spawnLevelStr);\r\n      if (mutationMultiplier) {\r\n        try { inc = inc.mulBigNumInteger(mutationMultiplier); } catch {}\r\n        try { xpInc = xpInc.mulBigNumInteger(mutationMultiplier); } catch {}\r\n      }\r\n      \r\n      if (!coinsLocked) {\r\n         totalCoin = mergeGain(totalCoin, inc);\r\n      }\r\n      if (xpEnabled) {\r\n         totalXp = mergeGain(totalXp, xpInc);\r\n      }\r\n      if (mutEnabled) {\r\n         totalMp = mergeGain(totalMp, mpValueMultiplierBn);\r\n      }\r\n    }\r\n\r\n    if (collectedCount === 0) return;\r\n\r\n    if (totalCoin && !totalCoin.isZero?.()) {\r\n      try {\r\n        coinsVal = coinsVal?.add ? coinsVal.add(totalCoin) : cloneBn(totalCoin);\r\n      } catch {\r\n        coinsVal = cloneBn(totalCoin);\r\n      }\r\n      queueCoinGain(totalCoin);\r\n      scheduleHudUpdate();\r\n    }\r\n    \r\n    if (totalXp && !totalXp.isZero?.()) {\r\n      queueXpGain(totalXp);\r\n    }\r\n    \r\n    if (totalMp && !totalMp.isZero?.()) {\r\n      queueMutationGain(totalMp);\r\n    }\r\n\r\n    if (localStorage.getItem(SHOP_UNLOCK_KEY) !== '1') {\r\n      const current = parseInt(localStorage.getItem(SHOP_PROGRESS_KEY) || '0', 10);\r\n      const next = current + collectedCount;\r\n      localStorage.setItem(SHOP_PROGRESS_KEY, String(next));\r\n      if (next >= 10) {\r\n        try { unlockShop(); } catch {}\r\n        localStorage.setItem(SHOP_UNLOCK_KEY, '1');\r\n      }\r\n    }\r\n  }\r\n\r\n  function collect(el, opts = {}) {\r\n    collectBatch([{ el, opts }]);\r\n    return true;\r\n  }\r\n\r\n  magnetController = createMagnetController({\r\n    playfield: pf,\r\n    coinsLayer: cl,\r\n    coinSelector,\r\n    collectFn: collect,\r\n    collectBatchFn: collectBatch,\r\n    spawner, // Pass spawner for optimized lookup\r\n  });\r\n  \r\n    cursorTrail = createCursorTrail(pf);\r\n\r\n  const onDelegatedInteract = (e) => {\r\n    if (e.target === cl) return;\r\n    const target = e.target.closest(coinSelector);\r\n    if (target && isCoin(target)) {\r\n      let opts = {};\r\n      if (spawner && typeof spawner.getCoinTransform === 'function') {\r\n          opts.transform = spawner.getCoinTransform(target);\r\n      }\r\n      collect(target, opts);\r\n    }\r\n  };\r\n\r\n  cl.addEventListener('pointerdown', onDelegatedInteract, { passive: true });\r\n  if (!IS_MOBILE) {\r\n    cl.addEventListener('mouseover', onDelegatedInteract, { passive: true });\r\n  }\r\n\r\n  const BRUSH_R = 25; // Slightly larger for single check\r\n  let cachedPfRect = null;\r\n  const updateCachedRect = () => { cachedPfRect = pf.getBoundingClientRect(); };\r\n  window.addEventListener('resize', updateCachedRect);\r\n  window.addEventListener('scroll', updateCachedRect, { passive: true });\r\n  updateCachedRect();\r\n\r\n  let lastBrushLocalX = null;\r\n  let lastBrushLocalY = null;\r\n\r\n  // Reset brush history on leave\r\n  pf.addEventListener('pointerleave', () => {\r\n      lastBrushLocalX = null;\r\n      lastBrushLocalY = null;\r\n  }, { passive: true });\r\n\r\n  function brushAt(x,y){\r\n    if (spawner && typeof spawner.findCoinsInRadius === 'function') {\r\n        if (!cachedPfRect) updateCachedRect();\r\n        const localX = x - cachedPfRect.left;\r\n        const localY = y - cachedPfRect.top;\r\n        \r\n        let candidates = [];\r\n        if (typeof spawner.findCoinsInPath === 'function' && lastBrushLocalX !== null && lastBrushLocalY !== null) {\r\n            candidates = spawner.findCoinsInPath(lastBrushLocalX, lastBrushLocalY, localX, localY, BRUSH_R);\r\n        } else {\r\n            candidates = spawner.findCoinsInRadius(localX, localY, BRUSH_R);\r\n        }\r\n        \r\n        lastBrushLocalX = localX;\r\n        lastBrushLocalY = localY;\r\n\r\n        if (candidates && candidates.length > 0) {\r\n            const items = [];\r\n            for (let i = 0; i < candidates.length; i++) {\r\n                const el = candidates[i];\r\n                const transform = (spawner && typeof spawner.getCoinTransform === 'function') \r\n                    ? spawner.getCoinTransform(el) \r\n                    : (el.style.transform || 'translate3d(0,0,0)');\r\n                items.push({ el, opts: { transform } });\r\n            }\r\n            collectBatch(items);\r\n        }\r\n    } else {\r\n        // Fallback: Legacy slow method (forced sync layout)\r\n        const OFF = [[0,0],[18,0],[-18,0],[0,18],[0,-18]];\r\n        const found = new Set();\r\n        for (let k=0;k<OFF.length;k++){\r\n          const px = x + OFF[k][0], py = y + OFF[k][1];\r\n          const stack = document.elementsFromPoint(px, py);\r\n          for (let i=0;i<stack.length;i++){\r\n            const el = stack[i];\r\n            if (isCoin(el) && !found.has(el)) { found.add(el); }\r\n          }\r\n        }\r\n        if (found.size > 0) {\r\n            const items = [];\r\n            found.forEach(el => items.push({ el }));\r\n            collectBatch(items);\r\n        }\r\n    }\r\n  }\r\n\r\n  let pending = null, brushScheduled = false;\r\n  function scheduleBrush(x,y){\r\n    pending = {x,y};\r\n    if (!brushScheduled){\r\n      brushScheduled = true;\r\n      requestAnimationFrame(() => {\r\n        if (pending){ brushAt(pending.x, pending.y); pending = null; }\r\n        brushScheduled = false;\r\n      });\r\n    }\r\n  }\r\n\r\n  pf.addEventListener('pointerdown', (e) => { scheduleBrush(e.clientX, e.clientY); }, { passive: true });\r\n  pf.addEventListener('pointermove', (e) => { if (e.pointerType !== 'mouse') scheduleBrush(e.clientX, e.clientY); }, { passive: true });\r\n  pf.addEventListener('pointerup',   (e) => { if (e.pointerType !== 'mouse') scheduleBrush(e.clientX, e.clientY); }, { passive: true });\r\n  pf.addEventListener('mousemove', (e) => { scheduleBrush(e.clientX, e.clientY); }, { passive: true });\r\n\r\n  function setMobileVolume(v){\r\n    const vol = Math.max(0, Math.min(1, Number(v) || 0));\r\n    if (masterGain && ac) masterGain.gain.setValueAtTime(vol, ac.currentTime);\r\n    if (mobileFallback) mobileFallback.volume = vol;\r\n  }\r\n\r\n  const destroy = () => {\r\n    flushPendingGains();\r\n    updateHudFn = () => {};\r\n    if (typeof window !== 'undefined') {\r\n      window.removeEventListener('resize', updateCachedRect);\r\n      window.removeEventListener('beforeunload', flushPendingGains);\r\n      window.removeEventListener('currency:multiplier', onCoinMultiplierChange);\r\n      window.removeEventListener('currency:change', onCurrencyChange);\r\n    }\r\n    if (typeof mutationUnsub === 'function') {\r\n      try { mutationUnsub(); } catch {}\r\n      mutationUnsub = null;\r\n    }\r\n    if (magnetController?.destroy) {\r\n      try { magnetController.destroy(); } catch {}\r\n      magnetController = null;\r\n    }\r\n    if (cursorTrail?.destroy) {\r\n      try { cursorTrail.destroy(); } catch {}\r\n      cursorTrail = null;\r\n    }\r\n    try {\r\n      cl.removeEventListener('pointerdown', onDelegatedInteract);\r\n      if (!IS_MOBILE) {\r\n        cl.removeEventListener('mouseover', onDelegatedInteract);\r\n      }\r\n    } catch {}\r\n    try { ['pointerdown','pointermove','pointerup','mousemove'].forEach(evt => pf.replaceWith(pf.cloneNode(true))); } catch {}\r\n  };\r\n\r\n  coinPickup = { destroy };\r\n\r\n  return {\r\n    get count(){ return coinsVal; },\r\n    set count(v){\r\n      coinsVal = BigNum.fromAny ? BigNum.fromAny(v) : BigNum.fromInt(Number(v) || 0);\r\n      scheduleHudUpdate();\r\n    },\r\n    setMobileVolume,\r\n    destroy,\r\n  };\r\n}\r\n", "// js/ui/merchantTabs/resetTab.js\r\nimport { BigNum } from '../../util/bigNum.js';\r\nimport {\r\n  bank,\r\n  getActiveSlot,\r\n  watchStorageKey,\r\n  primeStorageWatcherSnapshot,\r\n  onCurrencyChange,\r\n  CURRENCIES,\r\n} from '../../util/storage.js';\r\nimport { formatNumber } from '../../util/numFormat.js';\r\nimport {\r\n  getXpState,\r\n  resetXpProgress,\r\n  onXpChange,\r\n} from '../../game/xpSystem.js';\r\nimport {\r\n  AREA_KEYS,\r\n  UPGRADE_TIES,\r\n  getUpgradesForArea,\r\n  getLevelNumber,\r\n  setLevel,\r\n  approxLog10BigNum,\r\n  bigNumFromLog10,\r\n} from '../../game/upgrades.js';\r\nimport {\r\n  initMutationSystem,\r\n  unlockMutationSystem,\r\n  isMutationUnlocked,\r\n  getMutationCoinSprite,\r\n  onMutationChange,\r\n  getMutationState,\r\n  getTotalCumulativeMp,\r\n} from '../../game/mutationSystem.js';\r\nimport { shouldSkipGhostTap } from '../../util/ghostTapGuard.js';\r\nimport { clearPendingGains } from '../../game/coinPickup.js';\r\n\r\nconst BN = BigNum;\r\nconst LOG1_1 = Math.log10(1.1);\r\nconst bnZero = () => BN.fromInt(0);\r\nconst bnOne = () => BN.fromInt(1);\r\n\r\nconst GOLD_ICON_SRC = 'img/currencies/gold/gold.webp';\r\nconst MAGIC_ICON_SRC = 'img/currencies/magic/magic.webp';\r\nconst RESET_ICON_SRC = 'img/misc/forge.webp';\r\nconst INFUSE_ICON_SRC = 'img/misc/infuse.webp';\r\nconst SURGE_ICON_SRC = 'img/misc/surge.webp';\r\nconst WAVES_ICON_SRC = 'img/currencies/wave/wave.webp';\r\nconst FORGE_RESET_SOUND_SRC = 'sounds/forge_reset.ogg';\r\nconst INFUSE_RESET_SOUND_SRC = 'sounds/infuse_reset.ogg';\r\nconst SURGE_RESET_SOUND_SRC = 'sounds/surge_reset.ogg';\r\n\r\n// Add reset names here (e.g. 'forge', 'infuse', 'surge') to exclude them from wiping the playfield\r\nconst RESET_WIPE_EXCLUSIONS = [];\r\n\r\nfunction shouldWipePlayfield(resetType) {\r\n  return !RESET_WIPE_EXCLUSIONS.includes(resetType);\r\n}\r\n\r\nlet forgeResetAudio = null;\r\nfunction playForgeResetSound() {\r\n  try {\r\n    if (!forgeResetAudio) {\r\n      forgeResetAudio = new Audio(FORGE_RESET_SOUND_SRC);\r\n    } else {\r\n      forgeResetAudio.currentTime = 0;\r\n    }\r\n    forgeResetAudio.play().catch(() => {});\r\n  } catch {}\r\n}\r\n\r\nlet infuseResetAudio = null;\r\nfunction playInfuseResetSound() {\r\n  try {\r\n    if (!infuseResetAudio) {\r\n      infuseResetAudio = new Audio(INFUSE_RESET_SOUND_SRC);\r\n    } else {\r\n      infuseResetAudio.currentTime = 0;\r\n    }\r\n    infuseResetAudio.play().catch(() => {});\r\n  } catch {}\r\n}\r\n\r\nlet surgeResetAudio = null;\r\nfunction playSurgeResetSound() {\r\n  try {\r\n    if (!surgeResetAudio) {\r\n      surgeResetAudio = new Audio(SURGE_RESET_SOUND_SRC);\r\n    } else {\r\n      surgeResetAudio.currentTime = 0;\r\n    }\r\n    surgeResetAudio.play().catch(() => {});\r\n  } catch {}\r\n}\r\n\r\nconst FORGE_UNLOCK_KEY = (slot) => `ccc:reset:forge:${slot}`;\r\nconst FORGE_COMPLETED_KEY = (slot) => `ccc:reset:forge:completed:${slot}`;\r\nconst FORGE_DEBUG_OVERRIDE_KEY = (slot) => `ccc:debug:forgeUnlocked:${slot}`;\r\n\r\nconst INFUSE_UNLOCK_KEY = (slot) => `ccc:reset:infuse:${slot}`;\r\nconst INFUSE_COMPLETED_KEY = (slot) => `ccc:reset:infuse:completed:${slot}`;\r\nconst INFUSE_DEBUG_OVERRIDE_KEY = (slot) => `ccc:debug:infuseUnlocked:${slot}`;\r\n\r\nconst SURGE_UNLOCK_KEY = (slot) => `ccc:reset:surge:${slot}`;\r\nconst SURGE_DEBUG_OVERRIDE_KEY = (slot) => `ccc:debug:surgeUnlocked:${slot}`;\r\nconst SURGE_COMPLETED_KEY = (slot) => `ccc:reset:surge:completed:${slot}`;\r\nconst SURGE_BAR_LEVEL_KEY = (slot) => `ccc:reset:surge:barLevel:${slot}`;\r\n\r\nconst MIN_FORGE_LEVEL = BN.fromInt(31);\r\nconst MIN_INFUSE_MUTATION_LEVEL = BN.fromInt(7);\r\n\r\nlet isUpdatingWaveBar = false;\r\n\r\nconst resetState = {\r\n  slot: null,\r\n  forgeUnlocked: false,\r\n  forgeDebugOverride: null,\r\n  hasDoneForgeReset: false,\r\n  infuseUnlocked: false,\r\n  infuseDebugOverride: null,\r\n  hasDoneInfuseReset: false,\r\n  surgeUnlocked: false,\r\n  surgeDebugOverride: null,\r\n  hasDoneSurgeReset: false,\r\n  pendingGold: bnZero(),\r\n  pendingMagic: bnZero(),\r\n  pendingWaves: bnZero(),\r\n  panel: null,\r\n  elements: {\r\n    forge: {\r\n      card: null,\r\n      status: null,\r\n      btn: null,\r\n    },\r\n    infuse: {\r\n      card: null,\r\n      status: null,\r\n      btn: null,\r\n    },\r\n    surge: {\r\n      card: null,\r\n      status: null,\r\n      btn: null,\r\n      bar: null,\r\n      barFill: null,\r\n      barText: null,\r\n    },\r\n  },\r\n  layerButtons: {},\r\n  flagsPrimed: false,\r\n};\r\n\r\nconst watchers = [];\r\nlet watchersBoundSlot = null;\r\nlet initialized = false;\r\nlet mutationUnsub = null;\r\nlet pendingGoldInputSignature = null;\r\nlet coinChangeUnsub = null;\r\nlet xpChangeUnsub = null;\r\n\r\nfunction resetPendingGoldSignature() {\r\n  pendingGoldInputSignature = null;\r\n}\r\n\r\nfunction notifyForgeUnlockChange() {\r\n  const slot = resetState.slot ?? getActiveSlot();\r\n  try {\r\n    window.dispatchEvent(new CustomEvent('unlock:change', { detail: { key: 'forge', slot } }));\r\n  } catch {}\r\n}\r\n\r\nfunction notifyInfuseUnlockChange() {\r\n  const slot = resetState.slot ?? getActiveSlot();\r\n  try {\r\n    window.dispatchEvent(new CustomEvent('unlock:change', { detail: { key: 'infuse', slot } }));\r\n  } catch {}\r\n}\r\n\r\nfunction notifySurgeUnlockChange() {\r\n  const slot = resetState.slot ?? getActiveSlot();\r\n  try {\r\n    window.dispatchEvent(new CustomEvent('unlock:change', { detail: { key: 'surge', slot } }));\r\n  } catch {}\r\n}\r\n\r\nfunction getPendingGoldWithMultiplier(multiplierOverride = null) {\r\n  try {\r\n    if (multiplierOverride) {\r\n      const mult = multiplierOverride instanceof BN ? multiplierOverride : BN.fromAny(multiplierOverride ?? 1);\r\n      if (mult.isInfinite?.()) return BN.fromAny('Infinity');\r\n      return resetState.pendingGold.mulBigNumInteger(mult);\r\n    }\r\n    return bank.gold?.mult?.applyTo?.(resetState.pendingGold) ?? resetState.pendingGold;\r\n  } catch {\r\n    return resetState.pendingGold;\r\n  }\r\n}\r\n\r\nfunction cleanupWatchers() {\r\n  while (watchers.length) {\r\n    const stop = watchers.pop();\r\n    try { stop?.(); } catch {}\r\n  }\r\n}\r\n\r\nfunction ensureValueListeners() {\r\n  if (!coinChangeUnsub && typeof onCurrencyChange === 'function') {\r\n    coinChangeUnsub = onCurrencyChange((detail = {}) => {\r\n      if (detail?.key && detail.key !== CURRENCIES.COINS && detail.key !== CURRENCIES.WAVES) return;\r\n      if (detail?.slot != null && resetState.slot != null && detail.slot !== resetState.slot) return;\r\n      \r\n      if (detail?.key === CURRENCIES.WAVES) {\r\n          updateWaveBar();\r\n          updateResetPanel();\r\n      } else {\r\n          recomputePendingGold();\r\n          recomputePendingMagic();\r\n          recomputePendingWaves();\r\n      }\r\n    });\r\n  }\r\n  if (!xpChangeUnsub && typeof onXpChange === 'function') {\r\n    xpChangeUnsub = onXpChange((detail = {}) => {\r\n      if (detail?.slot != null && resetState.slot != null && detail.slot !== resetState.slot) return;\r\n      recomputePendingGold();\r\n      recomputePendingWaves();\r\n      updateResetPanel();\r\n    });\r\n  }\r\n}\r\n\r\nfunction levelToNumber(levelBn) {\r\n  if (!levelBn || typeof levelBn !== 'object') return 0;\r\n  if (levelBn.isInfinite?.()) return Number.POSITIVE_INFINITY;\r\n  try {\r\n    const plain = levelBn.toPlainIntegerString?.();\r\n    if (plain && plain !== 'Infinity' && plain.length <= 15) {\r\n      const num = Number(plain);\r\n      if (Number.isFinite(num)) return num;\r\n    }\r\n  } catch {}\r\n  const approx = approxLog10BigNum(levelBn);\r\n  if (!Number.isFinite(approx)) return Number.POSITIVE_INFINITY;\r\n  if (approx > 308) return Number.POSITIVE_INFINITY;\r\n  return Math.pow(10, approx);\r\n}\r\n\r\nfunction getXpLevelBn() {\r\n  try {\r\n    const state = getXpState();\r\n    if (state && state.xpLevel) return state.xpLevel;\r\n  } catch {}\r\n  return bnZero();\r\n}\r\n\r\nfunction computeForgeGold(coinsBn, levelBn) {\r\n  if (!coinsBn || typeof coinsBn !== 'object') return bnZero();\r\n  const logCoins = approxLog10BigNum(coinsBn);\r\n  if (!Number.isFinite(logCoins)) {\r\n    if (logCoins > 0) return BN.fromAny('Infinity');\r\n  }\r\n  const logScaled = Math.max(0, logCoins - 5);\r\n  if (!Number.isFinite(logScaled)) return bnZero();\r\n  const pow2 = bigNumFromLog10(logScaled * Math.log10(2));\r\n  const levelNum = Math.max(0, levelToNumber(levelBn));\r\n  const levelFactor = Math.max(0, (levelNum - 30) / 5);\r\n  const pow14 = levelFactor <= 0\r\n    ? bnOne()\r\n    : bigNumFromLog10(levelFactor * Math.log10(1.4));\r\n  const floorLog = Math.floor(logScaled);\r\n  const pow115 = floorLog <= 0\r\n    ? bnOne()\r\n    : bigNumFromLog10(floorLog * Math.log10(1.15));\r\n  let total = BN.fromInt(10);\r\n  total = total.mulBigNumInteger(pow2);\r\n  total = total.mulBigNumInteger(pow14);\r\n  total = total.mulBigNumInteger(pow115);\r\n  const floored = total.floorToInteger();\r\n  return floored.isZero?.() ? bnZero() : floored;\r\n}\r\n\r\nfunction computeInfuseMagicBase(coinsBn, cumulativeMpBn) {\r\n  if (!coinsBn) return bnZero();\r\n\r\n\r\n  const logCoins = approxLog10BigNum(coinsBn);\r\n  if (!Number.isFinite(logCoins)) { if (logCoins > 0) return BN.fromAny('Infinity'); }\r\n\r\n  const logCRatio = Math.max(0, logCoins - 12);\r\n\r\n  const LOG_BASE = 0.811078; // Math.log10(6.4726)\r\n  const LOG_1_5 = 0.176091;  // Math.log10(1.5)\r\n  const LOG_1_03 = 0.012837; // Math.log10(1.03)\r\n  const LOG_2 = 0.301030;    // Math.log10(2)\r\n\r\n  let logMpRatio = 0;\r\n  if (cumulativeMpBn && !cumulativeMpBn.isZero?.()) {\r\n    const logMp = approxLog10BigNum(cumulativeMpBn);\r\n    if (Number.isFinite(logMp)) {\r\n       logMpRatio = Math.max(0, logMp - 4);\r\n    }\r\n  }\r\n\r\n  const term1 = logCRatio * LOG_1_5;\r\n  const term2 = Math.floor(logCRatio) * LOG_1_03;\r\n  const term3 = logMpRatio * LOG_2;\r\n\r\n  const totalLog = LOG_BASE + term1 + term2 + term3;\r\n  \r\n  if (!Number.isFinite(totalLog)) return BN.fromAny('Infinity');\r\n  \r\n  return bigNumFromLog10(totalLog).floorToInteger();\r\n}\r\n\r\nfunction computeInfuseMagic(coinsBn, cumulativeMpBn, multiplierOverride = null) {\r\n  const base = computeInfuseMagicBase(coinsBn, cumulativeMpBn);\r\n  if (multiplierOverride) {\r\n    const mult = multiplierOverride instanceof BN ? multiplierOverride : BN.fromAny(multiplierOverride ?? 1);\r\n    if (mult.isInfinite?.()) return BN.fromAny('Infinity');\r\n    return base.mulBigNumInteger(mult);\r\n  }\r\n  return bank.magic?.mult?.applyTo?.(base) ?? base;\r\n}\r\n\r\nexport function computeForgeGoldFromInputs(coinsBn, levelBn) {\r\n  return computeForgeGold(coinsBn, levelBn);\r\n}\r\n\r\nexport function computeInfuseMagicFromInputs(coinsBn, cumulativeMpBn) {\r\n  return computeInfuseMagic(coinsBn, cumulativeMpBn);\r\n}\r\n\r\nfunction computeSurgeWaves(xpLevelBn, coinsBn, goldBn, magicBn, mpBn) {\r\n  const xpLevel = levelToNumber(xpLevelBn);\r\n  if (xpLevel < 201) return bnZero();\r\n\r\n  // Formula: 10 * 10^((XP - 201)/20) * Multipliers\r\n  const xpTerm = (xpLevel - 201) / 20;\r\n  \r\n  // Log-based multipliers\r\n  const logCoins = approxLog10BigNum(coinsBn);\r\n  const logGold = approxLog10BigNum(goldBn);\r\n  const logMagic = approxLog10BigNum(magicBn);\r\n  const logMp = approxLog10BigNum(mpBn);\r\n\r\n  // Handle Infinity\r\n  if (logCoins === Number.POSITIVE_INFINITY || \r\n      logGold === Number.POSITIVE_INFINITY || \r\n      logMagic === Number.POSITIVE_INFINITY || \r\n      logMp === Number.POSITIVE_INFINITY) {\r\n    return BN.fromAny('Infinity');\r\n  }\r\n\r\n  let logSum = 0;\r\n\r\n  if (Number.isFinite(logCoins) && logCoins > 24) {\r\n    logSum += (logCoins - 24) * LOG1_1;\r\n  }\r\n  if (Number.isFinite(logGold) && logGold > 13) {\r\n    logSum += (logGold - 13) * LOG1_1;\r\n  }\r\n  if (Number.isFinite(logMagic) && logMagic > 5) {\r\n    logSum += (logMagic - 5) * LOG1_1;\r\n  }\r\n  if (Number.isFinite(logMp) && logMp > 12) {\r\n    logSum += (logMp - 12) * LOG1_1;\r\n  }\r\n  \r\n  // Combine: 10 * 10^logSum * 10^(xpTerm)\r\n  // log10(Waves) = 1 + logSum + xpTerm\r\n  \r\n  const logTotal = 1 + logSum + xpTerm;\r\n  if (!Number.isFinite(logTotal)) return BN.fromAny('Infinity');\r\n  \r\n  return bigNumFromLog10(logTotal).floorToInteger();\r\n}\r\n\r\nfunction getXpLevelNumber() {\r\n  return Math.max(0, levelToNumber(getXpLevelBn()));\r\n}\r\n\r\nfunction ensureResetSlot() {\r\n  if (resetState.slot != null) return resetState.slot;\r\n  const slot = getActiveSlot();\r\n  resetState.slot = slot;\r\n  return slot;\r\n}\r\n\r\nexport function setForgeResetCompleted(value) {\r\n  const slot = ensureResetSlot();\r\n  if (slot == null) return;\r\n  resetState.hasDoneForgeReset = !!value;\r\n  try { localStorage.setItem(FORGE_COMPLETED_KEY(slot), resetState.hasDoneForgeReset ? '1' : '0'); }\r\n  catch {}\r\n  try { window.dispatchEvent(new CustomEvent('forge:completed', { detail: { slot } })); }\r\n  catch {}\r\n}\r\n\r\nexport function setInfuseResetCompleted(value) {\r\n  const slot = ensureResetSlot();\r\n  if (slot == null) return;\r\n  resetState.hasDoneInfuseReset = !!value;\r\n  try { localStorage.setItem(INFUSE_COMPLETED_KEY(slot), resetState.hasDoneInfuseReset ? '1' : '0'); }\r\n  catch {}\r\n  try { window.dispatchEvent(new CustomEvent('unlock:change', { detail: { key: 'infuse', slot } })); }\r\n  catch {}\r\n}\r\n\r\nexport function setSurgeResetCompleted(value) {\r\n  const slot = ensureResetSlot();\r\n  if (slot == null) return;\r\n  resetState.hasDoneSurgeReset = !!value;\r\n  try { localStorage.setItem(SURGE_COMPLETED_KEY(slot), resetState.hasDoneSurgeReset ? '1' : '0'); }\r\n  catch {}\r\n  // Notify for \"Unlock Warps\" toggle in debug panel\r\n  try { window.dispatchEvent(new CustomEvent('unlock:change', { detail: { key: 'surge_completed', slot } })); }\r\n  catch {}\r\n}\r\n\r\nfunction getForgeDebugOverride(slot = getActiveSlot()) {\r\n  if (slot == null) return null;\r\n  try {\r\n    const raw = localStorage.getItem(FORGE_DEBUG_OVERRIDE_KEY(slot));\r\n    if (raw === '1') return true;\r\n    if (raw === '0') return false;\r\n  } catch {}\r\n  return null;\r\n}\r\n\r\nexport function getForgeDebugOverrideState(slot = getActiveSlot()) {\r\n  return getForgeDebugOverride(slot);\r\n}\r\n\r\nexport function setForgeDebugOverride(value, slot = getActiveSlot()) {\r\n  if (slot == null) return;\r\n  const normalized = value == null ? null : !!value;\r\n  if (resetState.forgeDebugOverride === normalized) return;\r\n\r\n  resetState.forgeDebugOverride = normalized;\r\n\r\n  if (normalized == null) {\r\n    try { localStorage.removeItem(FORGE_DEBUG_OVERRIDE_KEY(slot)); } catch {}\r\n  } else {\r\n    try { localStorage.setItem(FORGE_DEBUG_OVERRIDE_KEY(slot), normalized ? '1' : '0'); }\r\n    catch {}\r\n  }\r\n  primeStorageWatcherSnapshot(FORGE_DEBUG_OVERRIDE_KEY(slot));\r\n  notifyForgeUnlockChange();\r\n  updateResetPanel();\r\n}\r\n\r\nfunction getInfuseDebugOverride(slot = getActiveSlot()) {\r\n  if (slot == null) return null;\r\n  try {\r\n    const raw = localStorage.getItem(INFUSE_DEBUG_OVERRIDE_KEY(slot));\r\n    if (raw === '1') return true;\r\n    if (raw === '0') return false;\r\n  } catch {}\r\n  return null;\r\n}\r\n\r\nexport function getInfuseDebugOverrideState(slot = getActiveSlot()) {\r\n  return getInfuseDebugOverride(slot);\r\n}\r\n\r\nexport function setInfuseUnlockedForDebug(value) {\r\n  setInfuseUnlocked(value);\r\n}\r\n\r\nexport function setInfuseDebugOverride(value, slot = getActiveSlot()) {\r\n  if (slot == null) return;\r\n  const normalized = value == null ? null : !!value;\r\n  if (resetState.infuseDebugOverride === normalized) return;\r\n\r\n  resetState.infuseDebugOverride = normalized;\r\n\r\n  if (normalized == null) {\r\n    try { localStorage.removeItem(INFUSE_DEBUG_OVERRIDE_KEY(slot)); } catch {}\r\n  } else {\r\n    try { localStorage.setItem(INFUSE_DEBUG_OVERRIDE_KEY(slot), normalized ? '1' : '0'); }\r\n    catch {}\r\n  }\r\n  primeStorageWatcherSnapshot(INFUSE_DEBUG_OVERRIDE_KEY(slot));\r\n  notifyInfuseUnlockChange();\r\n  updateResetPanel();\r\n}\r\n\r\nfunction setInfuseUnlocked(value) {\r\n  const slot = ensureResetSlot();\r\n  if (slot == null) return;\r\n  const next = !!value;\r\n  if (resetState.infuseUnlocked === next) return;\r\n  resetState.infuseUnlocked = next;\r\n  try { localStorage.setItem(INFUSE_UNLOCK_KEY(slot), resetState.infuseUnlocked ? '1' : '0'); }\r\n  catch {}\r\n  primeStorageWatcherSnapshot(INFUSE_UNLOCK_KEY(slot));\r\n  notifyInfuseUnlockChange();\r\n}\r\n\r\nfunction setForgeUnlocked(value) {\r\n  const slot = ensureResetSlot();\r\n  if (slot == null) return;\r\n  const next = !!value;\r\n  if (resetState.forgeUnlocked === next) return;\r\n  resetState.forgeUnlocked = next;\r\n  try { localStorage.setItem(FORGE_UNLOCK_KEY(slot), resetState.forgeUnlocked ? '1' : '0'); }\r\n  catch {}\r\n  primeStorageWatcherSnapshot(FORGE_UNLOCK_KEY(slot));\r\n  notifyForgeUnlockChange();\r\n}\r\n\r\nfunction getSurgeDebugOverride(slot = getActiveSlot()) {\r\n  if (slot == null) return null;\r\n  try {\r\n    const raw = localStorage.getItem(SURGE_DEBUG_OVERRIDE_KEY(slot));\r\n    if (raw === '1') return true;\r\n    if (raw === '0') return false;\r\n  } catch {}\r\n  return null;\r\n}\r\n\r\nexport function getSurgeDebugOverrideState(slot = getActiveSlot()) {\r\n  return getSurgeDebugOverride(slot);\r\n}\r\n\r\nexport function setSurgeUnlockedForDebug(value) {\r\n  setSurgeUnlocked(value);\r\n}\r\n\r\nfunction setSurgeUnlocked(value) {\r\n  const slot = ensureResetSlot();\r\n  if (slot == null) return;\r\n  const next = !!value;\r\n  if (resetState.surgeUnlocked === next) return;\r\n  resetState.surgeUnlocked = next;\r\n  try { localStorage.setItem(SURGE_UNLOCK_KEY(slot), resetState.surgeUnlocked ? '1' : '0'); }\r\n  catch {}\r\n  primeStorageWatcherSnapshot(SURGE_UNLOCK_KEY(slot));\r\n  notifySurgeUnlockChange();\r\n}\r\n\r\nfunction readPersistentFlags(slot) {\r\n  if (slot == null) {\r\n    resetState.forgeUnlocked = false;\r\n    resetState.forgeDebugOverride = null;\r\n    resetState.hasDoneForgeReset = false;\r\n    resetState.infuseUnlocked = false;\r\n    resetState.infuseDebugOverride = null;\r\n    resetState.hasDoneInfuseReset = false;\r\n    resetState.surgeUnlocked = false;\r\n    resetState.surgeDebugOverride = null;\r\n    resetState.hasDoneSurgeReset = false;\r\n    resetState.flagsPrimed = false;\r\n    return;\r\n  }\r\n  try {\r\n    resetState.forgeUnlocked = localStorage.getItem(FORGE_UNLOCK_KEY(slot)) === '1';\r\n  } catch {\r\n    resetState.forgeUnlocked = false;\r\n  }\r\n  resetState.forgeDebugOverride = getForgeDebugOverride(slot);\r\n  try {\r\n    resetState.hasDoneForgeReset = localStorage.getItem(FORGE_COMPLETED_KEY(slot)) === '1';\r\n  } catch {\r\n    resetState.hasDoneForgeReset = false;\r\n  }\r\n  try {\r\n    resetState.infuseUnlocked = localStorage.getItem(INFUSE_UNLOCK_KEY(slot)) === '1';\r\n  } catch {\r\n    resetState.infuseUnlocked = false;\r\n  }\r\n  try {\r\n    resetState.hasDoneInfuseReset = localStorage.getItem(INFUSE_COMPLETED_KEY(slot)) === '1';\r\n  } catch {\r\n    resetState.hasDoneInfuseReset = false;\r\n  }\r\n  resetState.infuseDebugOverride = getInfuseDebugOverride(slot);\r\n  \r\n  try {\r\n    resetState.surgeUnlocked = localStorage.getItem(SURGE_UNLOCK_KEY(slot)) === '1';\r\n  } catch {\r\n    resetState.surgeUnlocked = false;\r\n  }\r\n  resetState.surgeDebugOverride = getSurgeDebugOverride(slot);\r\n  try {\r\n    resetState.hasDoneSurgeReset = localStorage.getItem(SURGE_COMPLETED_KEY(slot)) === '1';\r\n  } catch {\r\n    resetState.hasDoneSurgeReset = false;\r\n  }\r\n\r\n  resetState.flagsPrimed = true;\r\n}\r\n\r\nfunction ensurePersistentFlagsPrimed() {\r\n  const slot = getActiveSlot();\r\n  if (slot == null) {\r\n    resetState.flagsPrimed = false;\r\n    return;\r\n  }\r\n  if (resetState.slot !== slot) {\r\n    resetState.slot = slot;\r\n    resetPendingGoldSignature();\r\n    resetState.flagsPrimed = false;\r\n  }\r\n  if (!resetState.flagsPrimed) {\r\n    readPersistentFlags(slot);\r\n  }\r\n}\r\n\r\nfunction bindStorageWatchers(slot) {\r\n  if (watchersBoundSlot === slot) return;\r\n  cleanupWatchers();\r\n  watchersBoundSlot = slot;\r\n  if (slot == null) return;\r\n  watchers.push(watchStorageKey(FORGE_UNLOCK_KEY(slot), {\r\n    onChange(value) {\r\n      const next = value === '1';\r\n      if (resetState.forgeUnlocked !== next) {\r\n        resetState.forgeUnlocked = next;\r\n        notifyForgeUnlockChange();\r\n        updateResetPanel();\r\n      }\r\n    },\r\n  }));\r\n  watchers.push(watchStorageKey(FORGE_COMPLETED_KEY(slot), {\r\n    onChange(value) {\r\n      const next = value === '1';\r\n      if (resetState.hasDoneForgeReset !== next) {\r\n        resetState.hasDoneForgeReset = next;\r\n        updateResetPanel();\r\n      }\r\n    },\r\n  }));\r\n  watchers.push(watchStorageKey(FORGE_DEBUG_OVERRIDE_KEY(slot), {\r\n    onChange(value) {\r\n      let next = null;\r\n      if (value === '1') next = true;\r\n      else if (value === '0') next = false;\r\n      if (resetState.forgeDebugOverride !== next) {\r\n        resetState.forgeDebugOverride = next;\r\n        notifyForgeUnlockChange();\r\n        updateResetPanel();\r\n      }\r\n    },\r\n  }));\r\n  watchers.push(watchStorageKey(INFUSE_UNLOCK_KEY(slot), {\r\n    onChange(value) {\r\n      const next = value === '1';\r\n      if (resetState.infuseUnlocked !== next) {\r\n        resetState.infuseUnlocked = next;\r\n        notifyInfuseUnlockChange();\r\n        updateResetPanel();\r\n      }\r\n    },\r\n  }));\r\n  watchers.push(watchStorageKey(INFUSE_COMPLETED_KEY(slot), {\r\n    onChange(value) {\r\n      const next = value === '1';\r\n      if (resetState.hasDoneInfuseReset !== next) {\r\n        resetState.hasDoneInfuseReset = next;\r\n        updateResetPanel();\r\n      }\r\n    },\r\n  }));\r\n  watchers.push(watchStorageKey(INFUSE_DEBUG_OVERRIDE_KEY(slot), {\r\n    onChange(value) {\r\n      let next = null;\r\n      if (value === '1') next = true;\r\n      else if (value === '0') next = false;\r\n      if (resetState.infuseDebugOverride !== next) {\r\n        resetState.infuseDebugOverride = next;\r\n        notifyInfuseUnlockChange();\r\n        updateResetPanel();\r\n      }\r\n    },\r\n  }));\r\n  watchers.push(watchStorageKey(SURGE_UNLOCK_KEY(slot), {\r\n    onChange(value) {\r\n      const next = value === '1';\r\n      if (resetState.surgeUnlocked !== next) {\r\n        resetState.surgeUnlocked = next;\r\n        notifySurgeUnlockChange();\r\n        updateResetPanel();\r\n      }\r\n    },\r\n  }));\r\n  watchers.push(watchStorageKey(SURGE_DEBUG_OVERRIDE_KEY(slot), {\r\n    onChange(value) {\r\n      let next = null;\r\n      if (value === '1') next = true;\r\n      else if (value === '0') next = false;\r\n      if (resetState.surgeDebugOverride !== next) {\r\n        resetState.surgeDebugOverride = next;\r\n        notifySurgeUnlockChange();\r\n        updateResetPanel();\r\n      }\r\n    },\r\n  }));\r\n  watchers.push(watchStorageKey(SURGE_COMPLETED_KEY(slot), {\r\n    onChange(value) {\r\n      const next = value === '1';\r\n      if (resetState.hasDoneSurgeReset !== next) {\r\n        resetState.hasDoneSurgeReset = next;\r\n        updateResetPanel();\r\n      }\r\n    },\r\n  }));\r\n}\r\n\r\nfunction getPendingInputSignature(coins, level) {\r\n  const coinSig = coins?.toStorage?.()\r\n    ?? coins?.toString?.()\r\n    ?? String(coins ?? '');\r\n  const levelSig = level?.toStorage?.()\r\n    ?? level?.toString?.()\r\n    ?? String(level ?? '');\r\n  return `${coinSig}|${levelSig}`;\r\n}\r\n\r\nfunction recomputePendingGold(force = false) {\r\n  const coins = bank.coins?.value ?? bnZero();\r\n  const level = getXpLevelBn();\r\n  const signature = getPendingInputSignature(coins, level);\r\n  if (!force && pendingGoldInputSignature === signature) {\r\n    return;\r\n  }\r\n  pendingGoldInputSignature = signature;\r\n\r\n  if (!meetsLevelRequirement()) {\r\n    resetState.pendingGold = bnZero();\r\n  } else {\r\n    resetState.pendingGold = computeForgeGold(coins, level);\r\n  }\r\n\r\n  updateResetPanel();\r\n}\r\n\r\nexport function recomputePendingMagic(multiplierOverride = null) {\r\n  const coins = bank.coins?.value ?? bnZero();\r\n  const cumulativeMp = getTotalCumulativeMp();\r\n  \r\n  if (!meetsInfuseRequirement()) {\r\n    resetState.pendingMagic = bnZero();\r\n  } else {\r\n    resetState.pendingMagic = computeInfuseMagic(coins, cumulativeMp, multiplierOverride);\r\n  }\r\n  recomputePendingWaves();\r\n  updateResetPanel();\r\n}\r\n\r\nfunction recomputePendingWaves() {\r\n  if (!isSurgeUnlocked()) {\r\n    resetState.pendingWaves = bnZero();\r\n    return;\r\n  }\r\n  const xpLevel = getXpLevelBn();\r\n  const coins = bank.coins?.value ?? bnZero();\r\n  const gold = bank.gold?.value ?? bnZero();\r\n  const magic = bank.magic?.value ?? bnZero();\r\n  const mp = getTotalCumulativeMp();\r\n\r\n  resetState.pendingWaves = computeSurgeWaves(xpLevel, coins, gold, magic, mp);\r\n\r\n  if (!hasDoneSurgeReset()) {\r\n    if (resetState.pendingWaves.cmp(BN.fromInt(10)) > 0) {\r\n      resetState.pendingWaves = BN.fromInt(10);\r\n    }\r\n  }\r\n}\r\n\r\nfunction canAccessForgeTab() {\r\n  const override = getForgeDebugOverride();\r\n  if (override != null) return !!override;\r\n  return resetState.forgeUnlocked || getLevelNumber(AREA_KEYS.STARTER_COVE, UPGRADE_TIES.UNLOCK_FORGE) >= 1;\r\n}\r\n\r\nfunction meetsLevelRequirement() {\r\n  try {\r\n    const levelBn = getXpLevelBn();\r\n    if (levelBn && typeof levelBn.cmp === 'function') {\r\n      return levelBn.cmp(MIN_FORGE_LEVEL) >= 0;\r\n    }\r\n  } catch {}\r\n  return false;\r\n}\r\n\r\nfunction meetsInfuseRequirement() {\r\n  try {\r\n    const mState = getMutationState();\r\n    if (mState && mState.level && typeof mState.level.cmp === 'function') {\r\n      return mState.level.cmp(MIN_INFUSE_MUTATION_LEVEL) >= 0;\r\n    }\r\n  } catch {}\r\n  return false;\r\n}\r\n\r\nexport function isForgeUnlocked() {\r\n  ensurePersistentFlagsPrimed();\r\n  const override = getForgeDebugOverride();\r\n  if (override != null) return !!override;\r\n  return !!resetState.forgeUnlocked || canAccessForgeTab();\r\n}\r\n\r\nexport function isInfuseUnlocked() {\r\n  ensurePersistentFlagsPrimed();\r\n  const override = getInfuseDebugOverride();\r\n  if (override != null) return !!override;\r\n  return !!resetState.infuseUnlocked;\r\n}\r\n\r\nexport function isSurgeUnlocked() {\r\n  ensurePersistentFlagsPrimed();\r\n  const override = getSurgeDebugOverride();\r\n  if (override != null) return !!override;\r\n  return !!resetState.surgeUnlocked;\r\n}\r\n\r\nexport function hasDoneForgeReset() {\r\n  ensurePersistentFlagsPrimed();\r\n  return !!resetState.hasDoneForgeReset;\r\n}\r\n\r\nexport function hasDoneInfuseReset() {\r\n  ensurePersistentFlagsPrimed();\r\n  return !!resetState.hasDoneInfuseReset;\r\n}\r\n\r\nexport function hasDoneSurgeReset() {\r\n  ensurePersistentFlagsPrimed();\r\n  return !!resetState.hasDoneSurgeReset;\r\n}\r\n\r\nexport function computePendingForgeGold() {\r\n  recomputePendingGold();\r\n  return resetState.pendingGold.clone?.() ?? resetState.pendingGold;\r\n}\r\n\r\nexport function canPerformForgeReset() {\r\n  if (!isForgeUnlocked()) return false;\r\n  if (!meetsLevelRequirement()) return false;\r\n  if (resetState.pendingGold.isZero?.()) return false;\r\n  return true;\r\n}\r\n\r\nexport function canPerformInfuseReset() {\r\n  if (!isInfuseUnlocked()) return false;\r\n  if (!meetsInfuseRequirement()) return false;\r\n  if (resetState.pendingMagic.isZero?.()) return false;\r\n  return true;\r\n}\r\n\r\nfunction resetUpgrades({ resetGold = false, resetMagic = false } = {}) {\r\n  const upgrades = getUpgradesForArea(AREA_KEYS.STARTER_COVE);\r\n  for (const upg of upgrades) {\r\n    if (!upg) continue;\r\n    const tieKey = upg.tieKey || upg.tie;\r\n    if (tieKey === UPGRADE_TIES.UNLOCK_XP || tieKey === UPGRADE_TIES.UNLOCK_FORGE || tieKey === UPGRADE_TIES.UNLOCK_INFUSE || tieKey === UPGRADE_TIES.UNLOCK_SURGE) continue;\r\n    if (upg.costType === 'gold' && !resetGold) continue;\r\n    if (upg.costType === 'magic' && !resetMagic) continue;\r\n    setLevel(AREA_KEYS.STARTER_COVE, upg.id, 0, true, { resetHmEvolutions: true });\r\n  }\r\n}\r\n\r\nfunction applyForgeResetEffects({ resetGold = false, resetMagic = false } = {}) {\r\n  try { bank.coins.set(0); } catch {}\r\n  try { bank.books.set(0); } catch {}\r\n  try { resetXpProgress({ keepUnlock: true }); } catch {}\r\n  try { clearPendingGains(); } catch {}\r\n  resetUpgrades({ resetGold, resetMagic });\r\n}\r\n\r\nexport function performForgeReset() {\r\n  if (!canPerformForgeReset()) return false;\r\n  const reward = resetState.pendingGold.clone?.() ?? resetState.pendingGold;\r\n  try {\r\n    const withMultiplier = bank.gold?.mult?.applyTo?.(reward) ?? reward;\r\n    if (bank.gold?.add) {\r\n      bank.gold.add(withMultiplier);\r\n    }\r\n  } catch {}\r\n  \r\n  applyForgeResetEffects({ resetGold: false });\r\n\r\n  recomputePendingGold();\r\n  setForgeUnlocked(true);\r\n  if (!resetState.hasDoneForgeReset) {\r\n    setForgeResetCompleted(true);\r\n  }\r\n  initMutationSystem();\r\n  unlockMutationSystem();\r\n  \r\n  if (shouldWipePlayfield('forge')) {\r\n    try { window.spawner?.clearPlayfield?.(); } catch {}\r\n  }\r\n\r\n  updateResetPanel();\r\n  return true;\r\n}\r\n\r\nexport function performInfuseReset() {\r\n  if (!canPerformInfuseReset()) return false;\r\n  const reward = resetState.pendingMagic.clone?.() ?? resetState.pendingMagic;\r\n  try {\r\n    if (bank.magic?.add) {\r\n       bank.magic.add(reward);\r\n    }\r\n  } catch {}\r\n\r\n  applyForgeResetEffects({ resetGold: true });\r\n\r\n  try { bank.gold.set(0); } catch {}\r\n  \r\n  try {\r\n     const slot = getActiveSlot();\r\n     const KEY_LEVEL = (s) => `ccc:mutation:level:${s}`;\r\n     const KEY_PROGRESS = (s) => `ccc:mutation:progress:${s}`;\r\n     localStorage.setItem(KEY_LEVEL(slot), '0');\r\n     localStorage.setItem(KEY_PROGRESS(slot), '0');\r\n     initMutationSystem({ forceReload: true });\r\n  } catch {}\r\n\r\n  recomputePendingGold();\r\n  recomputePendingMagic();\r\n  \r\n  if (shouldWipePlayfield('infuse')) {\r\n    try { window.spawner?.clearPlayfield?.(); } catch {}\r\n  }\r\n\r\n  setInfuseUnlocked(true);\r\n  if (!resetState.hasDoneInfuseReset) {\r\n    setInfuseResetCompleted(true);\r\n  }\r\n\r\n  updateResetPanel();\r\n  return true;\r\n}\r\n\r\nexport function performSurgeReset() {\r\n  if (!isSurgeUnlocked()) return false;\r\n  if (getXpLevelNumber() < 201) return false;\r\n  \r\n  const reward = resetState.pendingWaves.clone?.() ?? resetState.pendingWaves;\r\n  if (reward.isZero?.()) return false;\r\n\r\n  try {\r\n    if (bank.waves?.add) {\r\n      bank.waves.add(reward);\r\n    }\r\n  } catch {}\r\n\r\n  applyForgeResetEffects({ resetGold: true, resetMagic: true });\r\n  try { bank.gold.set(0); } catch {}\r\n  try { bank.magic.set(0); } catch {}\r\n  \r\n  try {\r\n     const slot = getActiveSlot();\r\n     const KEY_LEVEL = (s) => `ccc:mutation:level:${s}`;\r\n     const KEY_PROGRESS = (s) => `ccc:mutation:progress:${s}`;\r\n     localStorage.setItem(KEY_LEVEL(slot), '0');\r\n     localStorage.setItem(KEY_PROGRESS(slot), '0');\r\n     initMutationSystem({ forceReload: true });\r\n  } catch {}\r\n\r\n  updateWaveBar();\r\n\r\n  setSurgeUnlocked(true);\r\n  if (!resetState.hasDoneSurgeReset) {\r\n    setSurgeResetCompleted(true);\r\n  }\r\n\r\n  recomputePendingGold();\r\n  recomputePendingMagic();\r\n  recomputePendingWaves();\r\n  \r\n  playSurgeResetSound();\r\n  triggerSurgeWaveAnimation();\r\n  \r\n  if (shouldWipePlayfield('surge')) {\r\n    try { window.spawner?.clearPlayfield?.(); } catch {}\r\n  }\r\n  \r\n  updateResetPanel();\r\n  return true;\r\n}\r\n\r\nfunction triggerSurgeWaveAnimation() {\r\n  if (typeof document === 'undefined') return;\r\n  const existing = document.querySelector('.surge-wipe-overlay');\r\n  if (existing) existing.remove();\r\n\r\n  const overlay = document.createElement('div');\r\n  overlay.className = 'surge-wipe-overlay';\r\n  \r\n  const wave = document.createElement('div');\r\n  wave.className = 'surge-wipe-wave';\r\n  \r\n  overlay.appendChild(wave);\r\n  document.body.appendChild(overlay);\r\n\r\n  void wave.offsetWidth;\r\n  wave.classList.add('animate');\r\n\r\n  wave.addEventListener('animationend', () => {\r\n     overlay.remove();\r\n  }, { once: true });\r\n  \r\n  setTimeout(() => {\r\n     if (document.body.contains(overlay)) overlay.remove();\r\n  }, 2000);\r\n}\r\n\r\nfunction getSurgeBarLevel(slot) {\r\n  let barLevel = 0n;\r\n  try {\r\n    const raw = localStorage.getItem(SURGE_BAR_LEVEL_KEY(slot));\r\n    if (raw) {\r\n       if (raw === 'Infinity') return 0n;\r\n       barLevel = BigInt(raw);\r\n    }\r\n  } catch {}\r\n  return barLevel < 0n ? 0n : barLevel;\r\n}\r\n\r\nfunction getLog10BigInt(val) {\r\n    if (!Number.isFinite(val)) return 0n;\r\n    if (val <= Number.MAX_SAFE_INTEGER) return BigInt(Math.floor(val));\r\n    try {\r\n        const str = val.toLocaleString('en-US', { useGrouping: false });\r\n        return BigInt(str.split('.')[0]); \r\n    } catch {\r\n        return 0n;\r\n    }\r\n}\r\n\r\nfunction updateWaveBar() {\r\n  const slot = ensureResetSlot();\r\n  if (slot == null) return;\r\n  if (!isSurgeUnlocked()) return;\r\n  if (isUpdatingWaveBar) return;\r\n\r\n  let currentWaves = bank.waves?.value ?? bnZero();\r\n  \r\n  let barLevel = getSurgeBarLevel(slot);\r\n\r\n  // Requirement: 10 * 10^Level\r\n  let req = new BigNum(10n, { base: 0, offset: barLevel });\r\n  \r\n  let changed = false;\r\n\r\n  // Optimization for massive waves: jump to the approximate level\r\n  let logCurrent = approxLog10BigNum(currentWaves);\r\n  const logReq = approxLog10BigNum(req);\r\n\r\n  if (!Number.isFinite(logCurrent) && currentWaves.isInfinite?.()) {\r\n    logCurrent = Number.MAX_VALUE;\r\n  }\r\n\r\n  if (Number.isFinite(logCurrent) && Number.isFinite(logReq) && logCurrent > logReq + 5) {\r\n    try {\r\n        const logCurrentBigInt = getLog10BigInt(logCurrent);\r\n        const targetLevel = logCurrentBigInt > 0n ? logCurrentBigInt - 1n : 0n;\r\n\r\n        if (targetLevel > barLevel) {\r\n            const nextReq = new BigNum(10n, { base: 0, offset: targetLevel });\r\n            \r\n            // Cost = (10^(targetLevel+1) - 10^(barLevel+1)) / 9\r\n            const cost = nextReq.sub(req).div(BigNum.fromInt(9));\r\n\r\n            if (currentWaves.cmp(cost) >= 0) {\r\n              currentWaves = currentWaves.sub(cost);\r\n              barLevel = targetLevel;\r\n              changed = true;\r\n              req = nextReq;\r\n            }\r\n        }\r\n    } catch {}\r\n  }\r\n  \r\n  let safety = 0;\r\n  \r\n  while (safety < 100) {\r\n      if (currentWaves.cmp(req) < 0) break;\r\n      \r\n      currentWaves = currentWaves.sub(req);\r\n      \r\n      barLevel += 1n;\r\n      changed = true;\r\n      \r\n      req = req.mulBigNumInteger(BigNum.fromInt(10));\r\n      safety++;\r\n  }\r\n  \r\n  if (changed) {\r\n      localStorage.setItem(SURGE_BAR_LEVEL_KEY(slot), barLevel.toString());\r\n      \r\n      isUpdatingWaveBar = true;\r\n      try {\r\n        bank.waves.set(currentWaves);\r\n      } finally {\r\n        isUpdatingWaveBar = false;\r\n      }\r\n\r\n      updateResetPanel();\r\n\r\n      if (safety >= 100) {\r\n        setTimeout(updateWaveBar, 0);\r\n      }\r\n  }\r\n}\r\n\r\nfunction formatBn(value) {\r\n  if (value && (value === 'Infinity' || (typeof value.isInfinite === 'function' && value.isInfinite()))) {\r\n    return '<span class=\"infinity-symbol\">\u221E</span>';\r\n  }\r\n  try { return formatNumber(value); }\r\n  catch { return value?.toString?.() ?? '0'; }\r\n}\r\n\r\nfunction buildPanel(panelEl) {\r\n  panelEl.innerHTML = `<div class=\"merchant-reset\"><aside class=\"merchant-reset__sidebar\"><button type=\"button\" class=\"merchant-reset__layer\" data-reset-layer=\"forge\"><img src=\"${RESET_ICON_SRC}\" alt=\"\"><span>Forge</span></button><button type=\"button\" class=\"merchant-reset__layer\" data-reset-layer=\"infuse\" style=\"display:none\"><img src=\"${INFUSE_ICON_SRC}\" alt=\"\"><span>Infuse</span></button><button type=\"button\" class=\"merchant-reset__layer\" data-reset-layer=\"surge\" style=\"display:none\"><img src=\"${SURGE_ICON_SRC}\" alt=\"\"><span>Surge</span></button></aside><div class=\"merchant-reset__list\"><div class=\"merchant-reset__card merchant-reset__main\" id=\"reset-card-forge\"><div class=\"merchant-reset__layout\"><header class=\"merchant-reset__header\"><div class=\"merchant-reset__titles\"><h3>Forge</h3></div></header><div class=\"merchant-reset__content\"><div class=\"merchant-reset__titles\"><p data-reset-desc=\"forge\"> Resets Coins, Books, XP, Coin upgrades, and Book upgrades for Gold<br> Increase pending Gold amount by increasing Coins and XP Level<br> The button below shows how much Gold you will get upon reset </p></div><div class=\"merchant-reset__status\" data-reset-status=\"forge\"></div></div><div class=\"merchant-reset__actions\"><button type=\"button\" class=\"merchant-reset__action\" data-reset-action=\"forge\"><span class=\"merchant-reset__action-plus\">+</span><span class=\"merchant-reset__action-icon\"><img src=\"${GOLD_ICON_SRC}\" alt=\"\"></span><span class=\"merchant-reset__action-amount\" data-reset-pending=\"forge\">0</span></button></div></div></div><div class=\"merchant-reset__card merchant-reset__main is-infuse\" id=\"reset-card-infuse\" style=\"display:none\"><div class=\"merchant-reset__layout\"><header class=\"merchant-reset__header\"><div class=\"merchant-reset__titles\"><h3>Infuse</h3></div></header><div class=\"merchant-reset__content\"><div class=\"merchant-reset__titles\"><p data-reset-desc=\"infuse\"> Resets everything Forge does as well as Gold, MP, and Gold upgrades for Magic<br> Increase pending Magic amount by increasing Coins and MP </p></div><div class=\"merchant-reset__status\" data-reset-status=\"infuse\"></div></div><div class=\"merchant-reset__actions\"><button type=\"button\" class=\"merchant-reset__action\" data-reset-action=\"infuse\"><span class=\"merchant-reset__action-plus\">+</span><span class=\"merchant-reset__action-icon\"><img src=\"${MAGIC_ICON_SRC}\" alt=\"\"></span><span class=\"merchant-reset__action-amount\" data-reset-pending=\"infuse\">0</span></button></div></div></div><div class=\"merchant-reset__card merchant-reset__main is-surge\" id=\"reset-card-surge\" style=\"display:none\"><div class=\"merchant-reset__layout\"><header class=\"merchant-reset__header\"><div class=\"merchant-reset__titles\"><h3>Surge</h3></div></header><div class=\"merchant-reset__content\"><div class=\"merchant-reset__titles\"><p data-reset-desc=\"surge\"> Resets everything Infuse does as well as Magic and Magic upgrades for Waves<br> Increase pending Wave amount by increasing Coins, XP Level, Gold, MP, and Magic<br> Waves cannot be spent on upgrades, rather they are only useful for filling a bar<br> The bar below shows how much Wave progress you have until the next Surge<br> Each Surge provides a powerful boost, but Wave requirement increases 10x each Surge </p></div><div class=\"merchant-reset__status\" data-reset-status=\"surge\"></div><div class=\"merchant-reset__bar-container\" style=\"margin-top: 8px;\"><div class=\"merchant-reset__bar-wrapper\" style=\"background: rgba(0,0,0,0.3); height: 24px; border-radius: 4px; position: relative; overflow: hidden; border: 1px solid rgba(255,255,255,0.1);\"><div class=\"merchant-reset__bar-fill\" data-reset-bar-fill=\"surge\" style=\"width: 0%; height: 100%; background: linear-gradient(90deg, #00c6ff, #0072ff); transition: width 0.2s;\"></div><span class=\"merchant-reset__bar-text\" data-reset-bar-text=\"surge\" style=\"position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.8);\">0 / 10</span></div></div></div><div class=\"merchant-reset__actions\"><button type=\"button\" class=\"merchant-reset__action\" data-reset-action=\"surge\"><span class=\"merchant-reset__action-plus\">+</span><span class=\"merchant-reset__action-icon\"><img src=\"${WAVES_ICON_SRC}\" alt=\"\"></span><span class=\"merchant-reset__action-amount\" data-reset-pending=\"surge\">0</span></button></div></div></div></div><div class=\"merchant-reset__spacer\"></div></div>`;\r\n  resetState.panel = panelEl;\r\n  \r\n  // Bind Forge Elements\r\n  resetState.elements.forge.card = panelEl.querySelector('#reset-card-forge');\r\n  resetState.elements.forge.status = panelEl.querySelector('[data-reset-status=\"forge\"]');\r\n  resetState.elements.forge.btn = panelEl.querySelector('[data-reset-action=\"forge\"]');\r\n  resetState.elements.forge.pending = panelEl.querySelector('[data-reset-pending=\"forge\"]');\r\n\r\n  // Bind Infuse Elements\r\n  resetState.elements.infuse.card = panelEl.querySelector('#reset-card-infuse');\r\n  resetState.elements.infuse.status = panelEl.querySelector('[data-reset-status=\"infuse\"]');\r\n  resetState.elements.infuse.btn = panelEl.querySelector('[data-reset-action=\"infuse\"]');\r\n  resetState.elements.infuse.pending = panelEl.querySelector('[data-reset-pending=\"infuse\"]');\r\n\r\n  // Bind Surge Elements\r\n  resetState.elements.surge.card = panelEl.querySelector('#reset-card-surge');\r\n  resetState.elements.surge.status = panelEl.querySelector('[data-reset-status=\"surge\"]');\r\n  resetState.elements.surge.btn = panelEl.querySelector('[data-reset-action=\"surge\"]');\r\n  resetState.elements.surge.barFill = panelEl.querySelector('[data-reset-bar-fill=\"surge\"]');\r\n  resetState.elements.surge.barText = panelEl.querySelector('[data-reset-bar-text=\"surge\"]');\r\n\r\n  // Sidebar Buttons\r\n  resetState.layerButtons = {\r\n    forge: panelEl.querySelector('[data-reset-layer=\"forge\"]'),\r\n    infuse: panelEl.querySelector('[data-reset-layer=\"infuse\"]'),\r\n    surge: panelEl.querySelector('[data-reset-layer=\"surge\"]'),\r\n  };\r\n  \r\n  // Sidebar Click Handlers (Scroll)\r\n  Object.entries(resetState.layerButtons).forEach(([key, btn]) => {\r\n    if (!btn) return;\r\n\r\n    let lastPointerType = null;\r\n    const handleClick = (e) => {\r\n      if (e && e.isTrusted && shouldSkipGhostTap(btn)) return;\r\n      // markGhostTapTarget removed - global handler manages clicks\r\n      \r\n      const card = resetState.elements[key]?.card;\r\n      if (card) {\r\n        const scrollContainer = card.closest('.merchant-content');\r\n        if (key === 'forge' && scrollContainer) {\r\n          scrollContainer.scrollTo({ top: 0, behavior: 'smooth' });\r\n        } else {\r\n          card.scrollIntoView({ behavior: 'smooth', block: 'start' });\r\n        }\r\n      }\r\n    };\r\n\r\n    btn.addEventListener('click', (e) => {\r\n        if (lastPointerType && lastPointerType !== 'mouse') {\r\n            lastPointerType = null;\r\n            return;\r\n        }\r\n        lastPointerType = null;\r\n        handleClick(e);\r\n    });\r\n  });\r\n  \r\n  // Action Button Handlers\r\n  if (resetState.elements.forge.btn) {\r\n    resetState.elements.forge.btn.addEventListener('click', () => {\r\n       if (performForgeReset()) {\r\n         playForgeResetSound();\r\n         updateResetPanel();\r\n       }\r\n    });\r\n  }\r\n\r\n  if (resetState.elements.infuse.btn) {\r\n    resetState.elements.infuse.btn.addEventListener('click', () => {\r\n       if (performInfuseReset()) {\r\n         playInfuseResetSound();\r\n         updateResetPanel();\r\n       }\r\n    });\r\n  }\r\n\r\n  if (resetState.elements.surge.btn) {\r\n    resetState.elements.surge.btn.addEventListener('click', () => {\r\n       if (performSurgeReset()) {\r\n         // performSurgeReset handles playing sound\r\n         updateResetPanel();\r\n       }\r\n    });\r\n  }\r\n\r\n  updateResetPanel();\r\n}\r\n\r\nexport function initResetPanel(panelEl) {\r\n  if (!panelEl || panelEl.__resetInit) return;\r\n  panelEl.__resetInit = true;\r\n  buildPanel(panelEl);\r\n}\r\n\r\nfunction updateResetButtonContent(btn, state, iconSrc, pendingAmountBn) {\r\n  if (!btn) return;\r\n  const { disabled, msg } = state;\r\n  \r\n  if (btn.disabled !== disabled) btn.disabled = disabled;\r\n  \r\n  // State: \"msg\" or \"action\"\r\n  const targetMode = msg ? 'msg' : 'action';\r\n  const currentMode = btn.dataset.mode;\r\n  \r\n  if (targetMode === 'msg') {\r\n      if (currentMode !== 'msg' || btn.textContent !== msg) {\r\n          btn.innerHTML = `<span class=\"merchant-reset__req-msg\">${msg}</span>`;\r\n          btn.dataset.mode = 'msg';\r\n      }\r\n      return;\r\n  }\r\n  \r\n  // Action mode\r\n  const amountStr = formatBn(pendingAmountBn);\r\n  \r\n  if (currentMode !== 'action') {\r\n      // Build structure\r\n      btn.innerHTML = `<span class=\"merchant-reset__action-plus\">+</span><span class=\"merchant-reset__action-icon\"><img src=\"${iconSrc}\" alt=\"\"></span><span class=\"merchant-reset__action-amount\">${amountStr}</span>`;\r\n      btn.dataset.mode = 'action';\r\n  } else {\r\n      // Update amount only\r\n      const amountEl = btn.querySelector('.merchant-reset__action-amount');\r\n      if (amountEl && amountEl.innerHTML !== amountStr) {\r\n          amountEl.innerHTML = amountStr;\r\n      }\r\n      // Ensure icon (in case it was somehow lost or incorrect, though unlikely here)\r\n      const iconImg = btn.querySelector('.merchant-reset__action-icon img');\r\n      if (iconImg && !iconImg.src.includes(iconSrc)) iconImg.src = iconSrc;\r\n  }\r\n}\r\n\r\nfunction updateForgeCard({ goldMult = null } = {}) {\r\n  const el = resetState.elements.forge;\r\n  if (!el.card || !el.btn) return;\r\n\r\n  if (!isForgeUnlocked()) {\r\n     updateResetButtonContent(el.btn, { disabled: true, msg: 'Unlock the Forge upgrade to access resets' });\r\n     return;\r\n  }\r\n\r\n  ensurePersistentFlagsPrimed();\r\n  el.card.classList.toggle('is-forge-complete', !!resetState.hasDoneForgeReset);\r\n  \r\n  if (el.status) {\r\n      if (resetState.hasDoneForgeReset) {\r\n        if (el.status.innerHTML !== '') el.status.innerHTML = '';\r\n      } else {\r\n        const expected = `<span style=\"color:#02e815; text-shadow: 0 3px 6px rgba(0,0,0,0.55);\"> Forging for the first time will unlock new Shop upgrades, a new Merchant dialogue, and <strong style=\"color:#ffb347; text-shadow: 0 3px 6px rgba(0,0,0,0.55); \">Mutations</strong><br> Mutated Coins will yield more Coin and XP value than normal </span>`.trim();\r\n        // Simple length check or substring to avoid constant re-render\r\n        if (!el.status.innerHTML.includes('Mutations')) el.status.innerHTML = expected;\r\n      }\r\n  }\r\n\r\n  if (!meetsLevelRequirement()) {\r\n    updateResetButtonContent(el.btn, { disabled: true, msg: 'Reach XP Level 31 to perform a Forge reset' });\r\n    return;\r\n  }\r\n\r\n\r\n  updateResetButtonContent(el.btn, { disabled: false }, GOLD_ICON_SRC, getPendingGoldWithMultiplier(goldMult));\r\n}\r\n\r\nfunction updateInfuseCard() {\r\n  const el = resetState.elements.infuse;\r\n  if (!el.card || !el.btn) return;\r\n\r\n  if (!isInfuseUnlocked()) {\r\n    if (el.card.style.display !== 'none') el.card.style.display = 'none';\r\n    if (resetState.layerButtons.infuse && resetState.layerButtons.infuse.style.display !== 'none') {\r\n        resetState.layerButtons.infuse.style.display = 'none';\r\n    }\r\n    return;\r\n  }\r\n\r\n  if (el.card.style.display !== 'flex') el.card.style.display = 'flex';\r\n  if (resetState.layerButtons.infuse && resetState.layerButtons.infuse.style.display !== 'flex') {\r\n      resetState.layerButtons.infuse.style.display = 'flex';\r\n  }\r\n\r\n  ensurePersistentFlagsPrimed();\r\n  \r\n  el.card.classList.toggle('is-complete', !!resetState.hasDoneInfuseReset);\r\n\r\n  if (el.status) {\r\n      if (resetState.hasDoneInfuseReset) {\r\n        if (el.status.innerHTML !== '') el.status.innerHTML = '';\r\n      } else {\r\n         const expected = `<span style=\"color:#02e815; text-shadow: 0 3px 6px rgba(0,0,0,0.55);\"> Infusing for the first time will unlock new Shop upgrades, a new Merchant dialogue, and a new tab: <strong style=\"color:#c68cff\">Workshop</strong><br> This new tab will allow you to passively generate Gears<br> Spend Gears on new upgrades in the Shop to automate various things </span>`.trim();\r\n         if (!el.status.innerHTML.includes('Workshop')) el.status.innerHTML = expected;\r\n      }\r\n  }\r\n\r\n  if (!meetsInfuseRequirement()) {\r\n    updateResetButtonContent(el.btn, { disabled: true, msg: 'Reach Mutation Level 7 to perform an Infuse reset' });\r\n    return;\r\n  }\r\n  \r\n  \r\n  updateResetButtonContent(el.btn, { disabled: false }, MAGIC_ICON_SRC, resetState.pendingMagic);\r\n}\r\n\r\nfunction updateSurgeCard() {\r\n  const el = resetState.elements.surge;\r\n  if (!el.card || !el.btn) return;\r\n\r\n  if (!isSurgeUnlocked()) {\r\n    if (el.card.style.display !== 'none') el.card.style.display = 'none';\r\n    if (resetState.layerButtons.surge && resetState.layerButtons.surge.style.display !== 'none') {\r\n        resetState.layerButtons.surge.style.display = 'none';\r\n    }\r\n    return;\r\n  }\r\n\r\n  if (el.card.style.display !== 'flex') el.card.style.display = 'flex';\r\n  if (resetState.layerButtons.surge && resetState.layerButtons.surge.style.display !== 'flex') {\r\n      resetState.layerButtons.surge.style.display = 'flex';\r\n  }\r\n\r\n  ensurePersistentFlagsPrimed();\r\n  \r\n  // Bar Logic Visualization\r\n  const slot = ensureResetSlot();\r\n  const currentWaves = bank.waves?.value ?? bnZero();\r\n  let barLevel = 0n;\r\n  try { barLevel = getSurgeBarLevel(slot); } catch {}\r\n  \r\n  let req = new BigNum(10n, { base: 0, offset: barLevel });\r\n  \r\n  let pct = 0;\r\n  if (currentWaves && req && !req.isZero?.()) {\r\n      try {\r\n          const ratio = currentWaves.div(req);\r\n          // Convert to number for percentage\r\n          const rNum = Number(ratio.toScientific?.() ?? '0');\r\n          pct = Math.min(100, Math.max(0, rNum * 100));\r\n      } catch { pct = 0; }\r\n  }\r\n  \r\n  if (el.barFill) el.barFill.style.width = `${pct}%`;\r\n  if (el.barText) el.barText.innerHTML = `<span class=\"wave-bar-nums\">${formatBn(currentWaves)} / ${formatBn(req)}</span>`;\r\n\r\n  el.card.classList.toggle('is-complete', !!resetState.hasDoneSurgeReset);\r\n\r\n  if (el.status) {\r\n      if (resetState.hasDoneSurgeReset) {\r\n        if (el.status.innerHTML !== '') el.status.innerHTML = '';\r\n      } else {\r\n         const expected = `<span style=\"color:#02e815; text-shadow: 0 3px 6px rgba(0,0,0,0.55);\"> Surging for the first time will unlock a new Merchant dialogue and a new tab: <span style=\"color:#00e5ff\"><strong>Warps</strong></span><br> Warps may speed up gameplay a bit, so definitely check them out<br> You can only get 10 Waves on your first Surge, so you should do it immediately </span>`.trim();\r\n         if (!el.status.innerHTML.includes('Warps')) el.status.innerHTML = expected;\r\n      }\r\n  }\r\n\r\n  if (getXpLevelNumber() < 201) {\r\n    updateResetButtonContent(el.btn, { disabled: true, msg: 'Reach XP Level 201 to perform a Surge reset' });\r\n    return;\r\n  }\r\n  \r\n  if (resetState.pendingWaves.isZero?.()) {\r\n    updateResetButtonContent(el.btn, { disabled: true, msg: 'Collect more coins/resources to earn Waves from a Surge reset' });\r\n    return;\r\n  }\r\n  \r\n  updateResetButtonContent(el.btn, { disabled: false }, WAVES_ICON_SRC, resetState.pendingWaves);\r\n}\r\n\r\nexport function updateResetPanel({ goldMult = null } = {}) {\r\n  if (!resetState.panel) return;\r\n  updateForgeCard({ goldMult });\r\n  updateInfuseCard();\r\n  updateSurgeCard();\r\n}\r\n\r\nexport function onForgeUpgradeUnlocked() {\r\n  initResetSystem();\r\n  setForgeUnlocked(true);\r\n  updateResetPanel();\r\n}\r\n\r\nexport function onInfuseUpgradeUnlocked() {\r\n  initResetSystem();\r\n  setInfuseUnlocked(true);\r\n  updateResetPanel();\r\n}\r\n\r\nexport function onSurgeUpgradeUnlocked() {\r\n  initResetSystem();\r\n  setSurgeUnlocked(true);\r\n  updateResetPanel();\r\n}\r\n\r\nfunction bindGlobalEvents() {\r\n  if (typeof window === 'undefined') return;\r\n  window.addEventListener('currency:change', (e) => {\r\n    if (e.detail?.key === 'coins') {\r\n      recomputePendingGold();\r\n      recomputePendingMagic();\r\n      recomputePendingWaves();\r\n    }\r\n    if (e.detail?.key === 'waves') {\r\n        updateWaveBar();\r\n        updateResetPanel();\r\n    }\r\n  });\r\n  window.addEventListener('currency:multiplier', (e) => {\r\n    const detail = e?.detail;\r\n    if (!detail) return;\r\n    if (detail.key === CURRENCIES.GOLD) {\r\n      if (detail.slot != null && resetState.slot != null && detail.slot !== resetState.slot) return;\r\n      recomputePendingGold(true);\r\n      // Pass the new multiplier explicitly so visual updates are instant\r\n      const goldMult = detail.mult instanceof BigNum ? detail.mult : BN.fromAny(detail.mult ?? 1);\r\n      \r\n      // Force update with explicit override to ensure reactivity\r\n      if (resetState.panel) {\r\n        updateForgeCard({ goldMult });\r\n      }\r\n      return;\r\n    }\r\n    if (detail.key === CURRENCIES.MAGIC) {\r\n      if (detail.slot != null && resetState.slot != null && detail.slot !== resetState.slot) return;\r\n      const magicMult = detail.mult instanceof BigNum ? detail.mult : BN.fromAny(detail.mult ?? 1);\r\n      recomputePendingMagic(magicMult);\r\n      // Ensure visual update happens immediately with the new multiplier\r\n      if (resetState.panel) {\r\n        updateInfuseCard();\r\n      }\r\n      return;\r\n    }\r\n  });\r\n  window.addEventListener('xp:change', () => {\r\n    recomputePendingGold();\r\n    recomputePendingWaves();\r\n    updateResetPanel();\r\n  });\r\n  window.addEventListener('mutation:change', () => {\r\n    recomputePendingMagic();\r\n    recomputePendingWaves();\r\n    updateResetPanel();\r\n  });\r\n  window.addEventListener('debug:change', (e) => {\r\n    if (e?.detail?.slot != null && resetState.slot != null && e.detail.slot !== resetState.slot) return;\r\n    resetPendingGoldSignature();\r\n    recomputePendingGold(true);\r\n    recomputePendingMagic();\r\n    recomputePendingWaves();\r\n    updateResetPanel();\r\n  });\r\n}\r\n\r\nexport function initResetSystem() {\r\n  if (initialized) {\r\n    resetState.slot = getActiveSlot();\r\n    resetPendingGoldSignature();\r\n    ensureValueListeners();\r\n    recomputePendingGold(true);\r\n    recomputePendingMagic();\r\n    recomputePendingWaves();\r\n    return;\r\n  }\r\n  \r\n  // Guard against circular dependency initialization issues\r\n  try {\r\n    initMutationSystem();\r\n  } catch (e) {\r\n    // If initMutationSystem fails (likely due to accessing hudRefs before mutationSystem fully loads in a circular dep cycle),\r\n    // we abort initialization. This allows a subsequent call (e.g. from main.js) to succeed later.\r\n    return;\r\n  }\r\n\r\n  initialized = true;\r\n  const slot = getActiveSlot();\r\n  resetState.slot = slot;\r\n  resetPendingGoldSignature();\r\n  readPersistentFlags(slot);\r\n  if (resetState.hasDoneForgeReset && !isMutationUnlocked()) {\r\n    try { unlockMutationSystem(); } catch {}\r\n  }\r\n  if (!resetState.forgeUnlocked && canAccessForgeTab()) {\r\n    setForgeUnlocked(true);\r\n  }\r\n  bindStorageWatchers(slot);\r\n  ensureValueListeners();\r\n  bindGlobalEvents();\r\n  recomputePendingGold(true);\r\n  recomputePendingMagic();\r\n  recomputePendingWaves();\r\n  if (mutationUnsub) {\r\n    try { mutationUnsub(); } catch {}\r\n    mutationUnsub = null;\r\n  }\r\n  mutationUnsub = onMutationChange(() => {\r\n    const sprite = getMutationCoinSprite();\r\n    if (typeof window !== 'undefined' && window.spawner && typeof window.spawner.setCoinSprite === 'function') {\r\n      try { window.spawner.setCoinSprite(sprite); } catch {}\r\n    }\r\n  });\r\n  if (typeof window !== 'undefined') {\r\n    window.addEventListener('saveSlot:change', () => {\r\n      const nextSlot = getActiveSlot();\r\n      resetState.slot = nextSlot;\r\n      resetPendingGoldSignature();\r\n      readPersistentFlags(nextSlot);\r\n      if (resetState.hasDoneForgeReset && !isMutationUnlocked()) {\r\n        try { unlockMutationSystem(); } catch {}\r\n      }\r\n      if (!resetState.forgeUnlocked && canAccessForgeTab()) {\r\n        setForgeUnlocked(true);\r\n      }\r\n      bindStorageWatchers(nextSlot);\r\n      ensureValueListeners();\r\n      recomputePendingGold(true);\r\n      recomputePendingMagic();\r\n      recomputePendingWaves();\r\n      updateResetPanel();\r\n    });\r\n  }\r\n}\r\n\r\nif (typeof window !== 'undefined') {\r\n  window.resetSystem = window.resetSystem || {};\r\n  Object.assign(window.resetSystem, {\r\n    initResetSystem,\r\n    performForgeReset,\r\n    performInfuseReset,\r\n    performSurgeReset,\r\n    computePendingForgeGold,\r\n    computeForgeGoldFromInputs,\r\n    computeInfuseMagicFromInputs,\r\n    getForgeDebugOverrideState,\r\n    hasDoneForgeReset,\r\n    isForgeUnlocked,\r\n    setForgeDebugOverride,\r\n    setForgeResetCompleted,\r\n    updateResetPanel,\r\n    isInfuseUnlocked,\r\n    setInfuseDebugOverride,\r\n    getInfuseDebugOverrideState,\r\n    recomputePendingMagic,\r\n    setInfuseUnlockedForDebug,\r\n    setInfuseResetCompleted,\r\n    hasDoneInfuseReset,\r\n    isSurgeUnlocked,\r\n    setSurgeUnlockedForDebug,\r\n    getSurgeDebugOverrideState,\r\n    setSurgeResetCompleted,\r\n    hasDoneSurgeReset,\r\n  });\r\n}\r\n", "// js/game/upgrades.js\r\nimport { bank, getActiveSlot, watchStorageKey, primeStorageWatcherSnapshot, isStorageKeyLocked } from '../util/storage.js';\r\nimport { BigNum } from '../util/bigNum.js';\r\nimport { formatNumber } from '../util/numFormat.js';\r\nimport {\r\n  unlockXpSystem,\r\n  isXpSystemUnlocked,\r\n  getXpState,\r\n  addExternalCoinMultiplierProvider,\r\n  setExternalBookRewardProvider,\r\n  addExternalXpGainMultiplierProvider,\r\n  refreshCoinMultiplierFromXpLevel,\r\n} from './xpSystem.js';\r\nimport { getMutationMultiplier } from './mutationSystem.js';\r\nimport {\r\n  initResetSystem,\r\n  onForgeUpgradeUnlocked,\r\n  isForgeUnlocked,\r\n  hasDoneForgeReset,\r\n  onInfuseUpgradeUnlocked,\r\n  isInfuseUnlocked,\r\n  hasDoneInfuseReset,\r\n  onSurgeUpgradeUnlocked,\r\n} from '../ui/merchantTabs/resetTab.js';\r\nimport { REGISTRY as AUTOMATION_REGISTRY, AUTOMATION_AREA_KEY } from './automationUpgrades.js';\r\n\r\nexport const MAX_LEVEL_DELTA = BigNum.fromAny('Infinity');\r\n\r\nexport const HM_EVOLUTION_INTERVAL = 1000;\r\nconst HM_EVOLUTION_EFFECT_MULT_BN = BigNum.fromInt(1000);\r\nconst DEFAULT_AREA_KEY = '';\r\n\r\nexport const AREA_KEYS = {\r\n  STARTER_COVE: 'starter_cove',\r\n  AUTOMATION: AUTOMATION_AREA_KEY,\r\n};\r\n\r\nlet isBatching = false;\r\nconst pendingAreaSaves = new Map(); // key -> {areaKey, stateArr, slot} [Legacy/Fallback]\r\nconst pendingUpgradeSaves = new Map(); // key -> {areaKey, upgId, state, slot}\r\nlet pendingNotify = false;\r\n\r\nconst deferredWrites = new Map();\r\nlet deferredFlushTimer = null;\r\n\r\nfunction flushDeferredWrites() {\r\n  if (deferredWrites.size === 0) return;\r\n  deferredWrites.forEach(({ areaKey, upgId, state, slot }, key) => {\r\n    try {\r\n      const payload = JSON.stringify(state);\r\n      localStorage.setItem(key, payload);\r\n      try { primeStorageWatcherSnapshot(key, payload); } catch {}\r\n    } catch (e) {\r\n      console.warn('Failed to save deferred upgrade state', areaKey, upgId, e);\r\n    }\r\n  });\r\n  deferredWrites.clear();\r\n}\r\n\r\nfunction initDeferredFlush() {\r\n  if (typeof window === 'undefined') return;\r\n  if (deferredFlushTimer) return;\r\n  deferredFlushTimer = setInterval(flushDeferredWrites, 2000);\r\n  try { window.addEventListener('beforeunload', flushDeferredWrites); } catch {}\r\n  try { window.addEventListener('pagehide', flushDeferredWrites); } catch {}\r\n  try { document.addEventListener('visibilitychange', () => {\r\n      if (document.hidden) flushDeferredWrites();\r\n  }); } catch {}\r\n}\r\n\r\nexport function batchUpgradeOperations(fn) {\r\n  if (isBatching) {\r\n    return fn();\r\n  }\r\n  isBatching = true;\r\n  try {\r\n    return fn();\r\n  } finally {\r\n    isBatching = false;\r\n    pendingUpgradeSaves.forEach(({ areaKey, upgId, state, slot }) => {\r\n        try { saveUpgradeState(areaKey, upgId, state, slot); }\r\n        catch (e) { console.warn('Deferred upgrade save failed', e); }\r\n    });\r\n    pendingUpgradeSaves.clear();\r\n    \r\n    // Legacy/Fallback flush\r\n    pendingAreaSaves.forEach(({ areaKey, stateArr, slot }) => {\r\n      try { saveAreaState(areaKey, stateArr, slot); }\r\n      catch (e) { console.warn('Deferred area save failed', e); }\r\n    });\r\n    pendingAreaSaves.clear();\r\n\r\n    if (pendingNotify) {\r\n      pendingNotify = false;\r\n      notifyChanged();\r\n    }\r\n  }\r\n}\r\n\r\nfunction hasScaling(upg) {\r\n  try {\r\n    const scaling = ensureUpgradeScaling(upg);\r\n    if (!scaling) return false;\r\n    if (scaling.ratioMinus1 > 0) return true;\r\n\r\n    const c0 = BigNum.fromAny(upg.costAtLevel?.(0) ?? 0);\r\n    const c1 = BigNum.fromAny(upg.costAtLevel?.(1) ?? 0);\r\n    const cF = BigNum.fromAny(upg.costAtLevel?.(32) ?? 0);\r\n    return !(c0.cmp(c1) === 0 && c0.cmp(cF) === 0);\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\nconst SCALED_INFINITY_LVL_LOG10 = 308;\r\nfunction isInfinityLevelForScaled(upg, lvlBn) {\r\n  if (!hasScaling(upg)) return false;\r\n  try {\r\n    const bn = lvlBn?.clone ? lvlBn : BigNum.fromAny(lvlBn ?? 0);\r\n    if (bn.isInfinite?.()) return true;\r\n    const log10 = approxLog10BigNum(bn);\r\n    return Number.isFinite(log10) && log10 >= SCALED_INFINITY_LVL_LOG10;\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\nconst MAX_LEVEL_STORAGE_LENGTH = 1024;\r\n\r\nfunction sanitizeStoredLevelValue(raw, { allowEmpty = false } = {}) {\r\n  if (typeof raw !== 'string') return raw;\r\n  const trimmed = raw.trim();\r\n  if (!trimmed) return allowEmpty ? '' : '0';\r\n  if (trimmed.length > MAX_LEVEL_STORAGE_LENGTH) return 'Infinity';\r\n\r\n  if (trimmed.startsWith('BN:')) {\r\n    const expPart = trimmed.slice(trimmed.lastIndexOf(':') + 1);\r\n    const caret = expPart.indexOf('^');\r\n    const expDigits = caret >= 0 ? expPart.slice(0, caret) : expPart;\r\n    if (expPart.length > MAX_LEVEL_STORAGE_LENGTH / 2) return 'Infinity';\r\n    if (expDigits.length > MAX_LEVEL_STORAGE_LENGTH / 2) return 'Infinity';\r\n  }\r\n\r\n  return trimmed;\r\n}\r\n\r\nexport function approxLog10BigNum(value) {\r\n  if (!(value instanceof BigNum)) {\r\n    try {\r\n      value = BigNum.fromAny(value ?? 0);\r\n    } catch {\r\n      return Number.NEGATIVE_INFINITY;\r\n    }\r\n  }\r\n  if (!value) return Number.NEGATIVE_INFINITY;\r\n  if (value.isZero?.()) return Number.NEGATIVE_INFINITY;\r\n  if (value.isInfinite?.()) return Number.POSITIVE_INFINITY;\r\n\r\n  if (typeof value.sig === 'bigint') {\r\n    const sigNum = Number(value.sig);\r\n    if (sigNum > 0) {\r\n      const sigLog = Math.log10(sigNum);\r\n      const e = value.e || 0;\r\n      const off = Number(value._eOffset || 0n);\r\n      return sigLog + e + off;\r\n    }\r\n  }\r\n\r\n  let storage;\r\n  try {\r\n    storage = value.toStorage();\r\n  } catch {\r\n    return Number.NEGATIVE_INFINITY;\r\n  }\r\n  const parts = storage.split(':');\r\n  const sigStr = parts[2] ?? '0';\r\n  let expPart = parts[3] ?? '0';\r\n  let offsetStr = '0';\r\n  const caret = expPart.indexOf('^');\r\n  if (caret >= 0) {\r\n    offsetStr = expPart.slice(caret + 1) || '0';\r\n    expPart = expPart.slice(0, caret) || '0';\r\n  }\r\n  const baseExp = Number(expPart || '0');\r\n  const offset = Number(offsetStr || '0');\r\n  const digits = sigStr.replace(/^0+/, '') || '0';\r\n  if (digits === '0') return Number.NEGATIVE_INFINITY;\r\n\r\n  let sigLog;\r\n  if (digits.length <= 15) {\r\n    const sigNum = Number(digits);\r\n    if (!Number.isFinite(sigNum) || sigNum <= 0) return Number.NEGATIVE_INFINITY;\r\n    sigLog = Math.log10(sigNum);\r\n  } else {\r\n    const head = Number(digits.slice(0, 15));\r\n    if (!Number.isFinite(head) || head <= 0) return Number.NEGATIVE_INFINITY;\r\n    sigLog = Math.log10(head) + (digits.length - 15);\r\n  }\r\n\r\n  const expSum = (Number.isFinite(baseExp) ? baseExp : 0) + (Number.isFinite(offset) ? offset : 0);\r\n  return sigLog + expSum;\r\n}\r\n\r\nexport function bigNumFromLog10(log10Value) {\r\n  if (!Number.isFinite(log10Value)) {\r\n    return log10Value > 0 ? BigNum.fromAny('Infinity') : BigNum.fromInt(0);\r\n  }\r\n  \r\n  if (log10Value <= -1e12) return BigNum.fromInt(0);\r\n  const p = BigNum.DEFAULT_PRECISION;\r\n  let intPart = Math.floor(log10Value);\r\n  let frac = log10Value - intPart;\r\n  if (frac < 0) {\r\n    frac += 1;\r\n    intPart -= 1;\r\n  }\r\n  const mantissa = Math.pow(10, frac + (p - 1));\r\n  const sig = BigInt(Math.max(1, Math.round(mantissa)));\r\n  const exp = intPart - (p - 1);\r\n  return new BigNum(sig, exp, p);\r\n}\r\n\r\nexport const UPGRADE_TIES = {\r\n  FASTER_COINS: 'coin_1',\r\n  UNLOCK_XP: 'none_1',\r\n  FASTER_COINS_II: 'book_1',\r\n  COIN_VALUE_I: 'book_2',\r\n  BOOK_VALUE_I: 'book_3',\r\n  XP_VALUE_I: 'coin_2',\r\n  UNLOCK_FORGE: 'none_2',\r\n  COIN_VALUE_II: 'gold_1',\r\n  XP_VALUE_II: 'gold_2',\r\n  MP_VALUE_I: 'gold_3',\r\n  MAGNET: 'gold_4',\r\n  ENDLESS_XP: 'coin_3',\r\n  UNLOCK_INFUSE: 'none_3',\r\n  COIN_VALUE_III: 'magic_1',\r\n  XP_VALUE_III: 'magic_2',\r\n  MP_VALUE_II: 'magic_3',\r\n  FASTER_COINS_III: 'magic_4',\r\n  ENDLESS_MP: 'coin_4',\r\n  UNLOCK_SURGE: 'none_4',\r\n};\r\n\r\nconst HM_MILESTONES_STARTER_COVE = [\r\n  { level: 10, multiplier: 1.5, target: 'self' },\r\n  { level: 25, multiplier: 2, target: 'self' },\r\n  { level: 50, multiplier: 5, target: 'mp' },\r\n  { level: 100, multiplier: 10, target: 'xp' },\r\n  { level: 200, multiplier: 15, target: 'coin' },\r\n  { level: 400, multiplier: 25, target: 'self' },\r\n  { level: 800, multiplier: 100, target: 'self' },\r\n];\r\n\r\nconst HM_MILESTONES_BY_AREA = {\r\n  [AREA_KEYS.STARTER_COVE]: HM_MILESTONES_STARTER_COVE,\r\n};\r\n\r\nconst LOCKED_UPGRADE_ICON_DATA_URL = 'img/misc/locked.webp';\r\nconst MYSTERIOUS_UPGRADE_ICON_DATA_URL = 'img/misc/mysterious.webp';\r\nconst HIDDEN_UPGRADE_TITLE = 'Hidden Upgrade';\r\nconst LOCKED_UPGRADE_TITLE = 'Locked Upgrade';\r\nconst FORGE_PLACEHOLDER_TIES = new Set([\r\n  UPGRADE_TIES.COIN_VALUE_II,\r\n  UPGRADE_TIES.XP_VALUE_II,\r\n  UPGRADE_TIES.MP_VALUE_I,\r\n  UPGRADE_TIES.MAGNET,\r\n  UPGRADE_TIES.ENDLESS_XP,\r\n]);\r\nconst INFUSE_PLACEHOLDER_TIES = new Set([\r\n  UPGRADE_TIES.COIN_VALUE_III,\r\n  UPGRADE_TIES.XP_VALUE_III,\r\n  UPGRADE_TIES.MP_VALUE_II,\r\n  UPGRADE_TIES.FASTER_COINS_III,\r\n  UPGRADE_TIES.ENDLESS_MP,\r\n]);\r\nconst SPECIAL_LOCK_STATE_TIES = new Set([\r\n  UPGRADE_TIES.UNLOCK_XP,\r\n  UPGRADE_TIES.UNLOCK_FORGE,\r\n  UPGRADE_TIES.UNLOCK_INFUSE,\r\n  UPGRADE_TIES.UNLOCK_SURGE,\r\n  ...FORGE_PLACEHOLDER_TIES,\r\n  ...INFUSE_PLACEHOLDER_TIES,\r\n]);\r\nconst XP_MYSTERY_UPGRADE_TIES = new Set([\r\n  UPGRADE_TIES.FASTER_COINS_II,\r\n  UPGRADE_TIES.COIN_VALUE_I,\r\n  UPGRADE_TIES.BOOK_VALUE_I,\r\n  UPGRADE_TIES.XP_VALUE_I,\r\n]);\r\nconst XP_MYSTERY_LEGACY_KEYS = new Set([\r\n  'starter_cove:3',\r\n  'starter_cove:4',\r\n  'starter_cove:5',\r\n  'starter_cove:6',\r\n]);\r\nconst MERCHANT_MET_KEY_BASE = 'ccc:merchantMet';\r\nconst SHOP_REVEAL_STATE_KEY_BASE = 'ccc:shop:reveals';\r\nconst SHOP_PERMA_UNLOCK_KEY_BASE = 'ccc:shop:permaUnlocks';\r\nconst SHOP_PERMA_MYST_KEY_BASE   = 'ccc:shop:permaMyst';\r\nconst SHOP_REVEAL_STATUS_ORDER = { locked: 0, mysterious: 1, unlocked: 2 };\r\nconst shopRevealStateCache = new Map();\r\nconst shopPermaUnlockStateCache = new Map();\r\nconst shopPermaMystStateCache   = new Map();\r\nconst upgradeTieLookup = new Map();\r\nconst BOOK_VALUE_TIE_KEY = normalizeUpgradeTie(UPGRADE_TIES.BOOK_VALUE_I);\r\n\r\nconst BN = BigNum;\r\nconst toBn = (x) => BN.fromAny(x ?? 0);\r\n\r\nfunction effectBN(fn) {\r\n  return (level) => {\r\n    const L = toBn(level);\r\n    let out;\r\n    try { out = fn({ L, BN }); } catch { out = 1; }\r\n    if (out instanceof BN) return out;\r\n    const n = Number(out);\r\n    if (Number.isFinite(n)) return n;\r\n    try { return BN.fromAny(out ?? 1); } catch { return BN.fromInt(1); }\r\n  };\r\n}\r\n\r\nconst E = {\r\n  addPctPerLevel(p) {\r\n    const pNum = Number(p);\r\n    const pStr = String(pNum);\r\n    return (level) => {\r\n      const L = toBn(level);\r\n      try {\r\n        const plain = L.toPlainIntegerString?.();\r\n        if (plain && plain !== 'Infinity' && plain.length <= 15) {\r\n          const lvl = Math.max(0, Number(plain));\r\n          return 1 + pNum * lvl;\r\n        }\r\n      } catch {}\r\n      try { return BN.fromInt(1).add(L.mulDecimal(pStr)); }\r\ncatch {\r\n  const logL = approxLog10BigNum(L);\r\n  if (Number.isFinite(logL)) {\r\n    const logTerm = logL + Math.log10(Math.abs(pNum || 0));\r\n    return bigNumFromLog10(logTerm);\r\n  }\r\n  return BigNum.fromAny('Infinity');\r\n}\r\n\r\n    };\r\n  },\r\n\r\n  addFlatPerLevel(x) {\r\n    const xNum = Number(x);\r\n    const xStr = String(xNum);\r\n    return (level) => {\r\n      const L = toBn(level);\r\n      try {\r\n        const plain = L.toPlainIntegerString?.();\r\n        if (plain && plain !== 'Infinity' && plain.length <= 15) {\r\n          const lvl = Math.max(0, Number(plain));\r\n          return 1 + xNum * lvl;\r\n        }\r\n      } catch {}\r\n      try { return BN.fromInt(1).add(L.mulDecimal(xStr)); } catch { return 1; }\r\n    };\r\n  },\r\n\r\n  powPerLevel(base) {\r\n    const baseNum = Number(base);\r\n    const b = Number.isFinite(baseNum) ? baseNum : Number(toBn(base).toScientific(6));\r\n    const log10b = Math.log10(b);\r\n    const LOG10_INFINITY_TRIGGER = 1e305;\r\n\r\n    return (level) => {\r\n      const L = toBn(level);\r\n\r\n      if (log10b > 0) {\r\n        const approxLevelLog = approxLog10BigNum(L);\r\n\r\n        if (!Number.isFinite(approxLevelLog)) {\r\n          if (approxLevelLog > 0) return BigNum.fromAny('Infinity');\r\n        } else {\r\n          const triggerLevelLog = Math.log10(LOG10_INFINITY_TRIGGER / log10b);\r\n          if (approxLevelLog >= triggerLevelLog) return BigNum.fromAny('Infinity');\r\n        }\r\n      }\r\n\r\n      try {\r\n        const plain = L.toPlainIntegerString?.();\r\n        if (plain && plain !== 'Infinity' && plain.length <= 7) {\r\n          const lvl = Math.max(0, Number(plain));\r\n          const log10 = log10b * lvl;\r\n\r\n          if (log10 < 308) {\r\n            const val = Math.pow(b, lvl);\r\n            if (Number.isFinite(val)) return val;\r\n          }\r\n          return bigNumFromLog10(log10);\r\n        }\r\n      } catch {}\r\n\r\n      try {\r\n        const approxLvl = levelBigNumToNumber(L);\r\n        const log10 = log10b * approxLvl;\r\n        return bigNumFromLog10(log10);\r\n      } catch {\r\n        return BigNum.fromInt(1);\r\n      }\r\n    };\r\n  }\r\n};\r\n\r\nfunction shopStatusRank(status) {\r\n  return SHOP_REVEAL_STATUS_ORDER[status] ?? 0;\r\n}\r\n\r\nfunction classifyUpgradeStatus(lockState) {\r\n  if (!lockState || lockState.locked === false) return 'unlocked';\r\n  if (lockState.hidden) return 'mysterious';\r\n  return 'locked';\r\n}\r\n\r\nfunction upgradeRevealKey(areaKey, upg) {\r\n  const normArea = normalizeAreaKey(areaKey || upg?.area);\r\n  if (!normArea) return null;\r\n  const tieKey = normalizeUpgradeTie(upg?.tie ?? upg?.tieKey);\r\n  if (tieKey) {\r\n    return `${normArea}:${tieKey}`;\r\n  }\r\n  const rawId = normalizeUpgradeId(upg?.id);\r\n  let idStr = '';\r\n  if (typeof rawId === 'number') {\r\n    if (!Number.isFinite(rawId)) return null;\r\n    idStr = String(Math.trunc(rawId));\r\n  } else if (typeof rawId === 'string') {\r\n    const trimmed = rawId.trim();\r\n    if (!trimmed) return null;\r\n    idStr = trimmed;\r\n  } else {\r\n    return null;\r\n  }\r\n  return `${normArea}:${idStr}`;\r\n}\r\n\r\nfunction upgradeLegacyRevealKey(areaKey, upg) {\r\n  const normArea = normalizeAreaKey(areaKey || upg?.area);\r\n  if (!normArea) return null;\r\n  const rawId = normalizeUpgradeId(upg?.id);\r\n  if (rawId == null) return null;\r\n  if (typeof rawId === 'number') {\r\n    if (!Number.isFinite(rawId)) return null;\r\n    return `${normArea}:${Math.trunc(rawId)}`;\r\n  }\r\n  const trimmed = String(rawId).trim();\r\n  return trimmed ? `${normArea}:${trimmed}` : null;\r\n}\r\n\r\nfunction migrateUpgradeStateKey(state, fromKey, toKey) {\r\n  if (!state || !state.upgrades || typeof state.upgrades !== 'object') return false;\r\n  if (!fromKey || !toKey || fromKey === toKey) return false;\r\n  if (state.upgrades[toKey]) return false;\r\n  if (!state.upgrades[fromKey]) return false;\r\n  state.upgrades[toKey] = state.upgrades[fromKey];\r\n  delete state.upgrades[fromKey];\r\n  return true;\r\n}\r\n\r\nfunction ensureShopRevealState(slot = getActiveSlot()) {\r\n  const slotKey = String(slot ?? 'default');\r\n  if (shopRevealStateCache.has(slotKey)) {\r\n    return shopRevealStateCache.get(slotKey);\r\n  }\r\n\r\n  let parsed = { upgrades: {} };\r\n  if (typeof localStorage !== 'undefined') {\r\n    try {\r\n      const raw = localStorage.getItem(`${SHOP_REVEAL_STATE_KEY_BASE}:${slotKey}`);\r\n      if (raw) {\r\n        const obj = JSON.parse(raw);\r\n        if (obj && typeof obj === 'object') {\r\n          const upgrades = (obj.upgrades && typeof obj.upgrades === 'object') ? obj.upgrades : {};\r\n          parsed = { upgrades };\r\n        }\r\n      }\r\n    } catch {}\r\n  }\r\n\r\n  if (!parsed || typeof parsed !== 'object') parsed = { upgrades: {} };\r\n  if (!parsed.upgrades || typeof parsed.upgrades !== 'object') parsed.upgrades = {};\r\n\r\n  shopRevealStateCache.set(slotKey, parsed);\r\n  return parsed;\r\n}\r\n\r\nfunction saveShopRevealState(state, slot = getActiveSlot()) {\r\n  const slotKey = String(slot ?? 'default');\r\n  if (!state || typeof state !== 'object') {\r\n    state = { upgrades: {} };\r\n  }\r\n  if (!state.upgrades || typeof state.upgrades !== 'object') {\r\n    state.upgrades = {};\r\n  }\r\n  shopRevealStateCache.set(slotKey, state);\r\n  if (typeof localStorage === 'undefined') return;\r\n  try {\r\n    localStorage.setItem(`${SHOP_REVEAL_STATE_KEY_BASE}:${slotKey}`, JSON.stringify(state));\r\n  } catch {}\r\n}\r\n\r\nfunction ensureShopPermaUnlockState(slot = getActiveSlot()) {\r\n  const slotKey = String(slot ?? 'default');\r\n  if (shopPermaUnlockStateCache.has(slotKey)) {\r\n    return shopPermaUnlockStateCache.get(slotKey);\r\n  }\r\n\r\n  let parsed = { upgrades: {} };\r\n  if (typeof localStorage !== 'undefined') {\r\n    try {\r\n      const raw = localStorage.getItem(`${SHOP_PERMA_UNLOCK_KEY_BASE}:${slotKey}`);\r\n      if (raw) {\r\n        const obj = JSON.parse(raw);\r\n        if (obj && typeof obj === 'object') {\r\n          const upgrades = (obj.upgrades && typeof obj.upgrades === 'object') ? obj.upgrades : {};\r\n          parsed = { upgrades };\r\n        }\r\n      }\r\n    } catch {}\r\n  }\r\n\r\n  if (!parsed || typeof parsed !== 'object') parsed = { upgrades: {} };\r\n  if (!parsed.upgrades || typeof parsed.upgrades !== 'object') parsed.upgrades = {};\r\n\r\n  shopPermaUnlockStateCache.set(slotKey, parsed);\r\n  return parsed;\r\n}\r\n\r\nfunction saveShopPermaUnlockState(state, slot = getActiveSlot()) {\r\n  const slotKey = String(slot ?? 'default');\r\n  if (!state || typeof state !== 'object') {\r\n    state = { upgrades: {} };\r\n  }\r\n  if (!state.upgrades || typeof state.upgrades !== 'object') {\r\n    state.upgrades = {};\r\n  }\r\n  shopPermaUnlockStateCache.set(slotKey, state);\r\n  if (typeof localStorage === 'undefined') return;\r\n  try {\r\n    localStorage.setItem(`${SHOP_PERMA_UNLOCK_KEY_BASE}:${slotKey}`, JSON.stringify(state));\r\n  } catch {}\r\n}\r\n\r\nfunction ensureShopPermaMystState(slot = getActiveSlot()) {\r\n  const slotKey = String(slot ?? 'default');\r\n  if (shopPermaMystStateCache.has(slotKey)) {\r\n    return shopPermaMystStateCache.get(slotKey);\r\n  }\r\n  let parsed = { upgrades: {} };\r\n  if (typeof localStorage !== 'undefined') {\r\n    try {\r\n      const raw = localStorage.getItem(`${SHOP_PERMA_MYST_KEY_BASE}:${slotKey}`);\r\n      if (raw) {\r\n        const obj = JSON.parse(raw);\r\n        if (obj && typeof obj === 'object') {\r\n          const upgrades = (obj.upgrades && typeof obj.upgrades === 'object') ? obj.upgrades : {};\r\n          parsed = { upgrades };\r\n        }\r\n      }\r\n    } catch {}\r\n  }\r\n  if (!parsed || typeof parsed !== 'object') parsed = { upgrades: {} };\r\n  if (!parsed.upgrades || typeof parsed.upgrades !== 'object') parsed.upgrades = {};\r\n  shopPermaMystStateCache.set(slotKey, parsed);\r\n  return parsed;\r\n}\r\n\r\nfunction saveShopPermaMystState(state, slot = getActiveSlot()) {\r\n  const slotKey = String(slot ?? 'default');\r\n  if (!state || typeof state !== 'object') state = { upgrades: {} };\r\n  if (!state.upgrades || typeof state.upgrades !== 'object') state.upgrades = {};\r\n  shopPermaMystStateCache.set(slotKey, state);\r\n  if (typeof localStorage === 'undefined') return;\r\n  try {\r\n    localStorage.setItem(`${SHOP_PERMA_MYST_KEY_BASE}:${slotKey}`, JSON.stringify(state));\r\n  } catch {}\r\n}\r\n\r\nfunction markUpgradePermanentlyMysterious(areaKey, upg, slot = getActiveSlot()) {\r\n  const key = upgradeRevealKey(areaKey, upg);\r\n  if (!key) return;\r\n  const legacyKey = upgradeLegacyRevealKey(areaKey, upg);\r\n  const state = ensureShopPermaMystState(slot);\r\n  if (state.upgrades[key]) return;\r\n  state.upgrades[key] = true;\r\n  if (legacyKey && state.upgrades[legacyKey]) {\r\n    delete state.upgrades[legacyKey];\r\n  }\r\n  saveShopPermaMystState(state, slot);\r\n}\r\n\r\nfunction isUpgradePermanentlyMysterious(areaKey, upg, slot = getActiveSlot()) {\r\n  const key = upgradeRevealKey(areaKey, upg);\r\n  if (!key) return false;\r\n  const legacyKey = upgradeLegacyRevealKey(areaKey, upg);\r\n  const state = ensureShopPermaMystState(slot);\r\n  if (state.upgrades[key]) return true;\r\n  if (legacyKey && state.upgrades[legacyKey]) {\r\n    state.upgrades[key] = state.upgrades[legacyKey];\r\n    delete state.upgrades[legacyKey];\r\n    saveShopPermaMystState(state, slot);\r\n    return true;\r\n  }\r\n  return false;\r\n}\r\n\r\nexport function markUpgradePermanentlyUnlocked(areaKey, upg, slot = getActiveSlot()) {\r\n  const key = upgradeRevealKey(areaKey, upg);\r\n  if (!key) return;\r\n  const legacyKey = upgradeLegacyRevealKey(areaKey, upg);\r\n  const state = ensureShopPermaUnlockState(slot);\r\n  if (state.upgrades[key]) return;\r\n  state.upgrades[key] = true;\r\n  if (legacyKey && state.upgrades[legacyKey]) {\r\n    delete state.upgrades[legacyKey];\r\n  }\r\n  saveShopPermaUnlockState(state, slot);\r\n}\r\n\r\nexport function clearPermanentUpgradeUnlock(areaKey, upg, slot = getActiveSlot()) {\r\n  const key = upgradeRevealKey(areaKey, upg);\r\n  if (!key) return;\r\n\r\n  const permaState = ensureShopPermaUnlockState(slot);\r\n  if (permaState.upgrades[key]) {\r\n    delete permaState.upgrades[key];\r\n    saveShopPermaUnlockState(permaState, slot);\r\n  }\r\n\r\n  const revealState = ensureShopRevealState(slot);\r\n  if (!revealState.upgrades[key] || revealState.upgrades[key].status !== 'locked') {\r\n    revealState.upgrades[key] = { status: 'locked' };\r\n    saveShopRevealState(revealState, slot);\r\n  }\r\n\r\n  const upgId = typeof upg?.id !== 'undefined' ? upg.id : upg;\r\n  if (upgId != null) {\r\n    invalidateUpgradeState(areaKey, upgId, slot);\r\n  }\r\n  notifyChanged();\r\n}\r\n\r\nfunction isUpgradePermanentlyUnlocked(areaKey, upg, slot = getActiveSlot()) {\r\n  const key = upgradeRevealKey(areaKey, upg);\r\n  if (!key) return false;\r\n  const legacyKey = upgradeLegacyRevealKey(areaKey, upg);\r\n  const state = ensureShopPermaUnlockState(slot);\r\n  if (state.upgrades[key]) return true;\r\n  if (legacyKey && state.upgrades[legacyKey]) {\r\n    state.upgrades[key] = state.upgrades[legacyKey];\r\n    delete state.upgrades[legacyKey];\r\n    saveShopPermaUnlockState(state, slot);\r\n    return true;\r\n  }\r\n  return false;\r\n}\r\n\r\nfunction determineLockState(ctx) {\r\n  // Be robust if called unbound or without ctx.upg\r\n  const upgRef = (ctx && ctx.upg) ? ctx.upg : (this && typeof this === 'object' ? this : null);\r\n  const tieKey = normalizeUpgradeTie(upgRef?.tie ?? upgRef?.tieKey);\r\n  const area = ctx?.areaKey || AREA_KEYS.STARTER_COVE;\r\n\r\n  if (!tieKey || !SPECIAL_LOCK_STATE_TIES.has(tieKey)) {\r\n    return { locked: true, iconOverride: LOCKED_UPGRADE_ICON_DATA_URL, useLockedBase: true };\r\n  }\r\n\r\n  // If any level has already been bought, it\u2019s unlocked.\r\n  let currentLevel = 0;\r\n  try {\r\n    currentLevel = (upgRef && typeof upgRef.id !== 'undefined') ? getLevelNumber(area, upgRef.id) : 0;\r\n  } catch {}\r\n  if (currentLevel >= 1) {\r\n    return { locked: false, hidden: false, useLockedBase: false };\r\n  }\r\n\r\n  // XPs unlocked?\r\n  let xpUnlocked = false;\r\n  try {\r\n    xpUnlocked = (ctx && typeof ctx.xpUnlocked !== 'undefined')\r\n      ? !!ctx.xpUnlocked\r\n      : safeIsXpUnlocked();\r\n  } catch {}\r\n\r\n  function determineUnlockXpLockState() {\r\n    if (safeHasMetMerchant()) {\r\n      // Merchant met -> upgrade is fully visible and purchasable\r\n      return {\r\n        locked: false,\r\n        hidden: false,\r\n        hideCost: false,\r\n        hideEffect: false,\r\n        useLockedBase: false,\r\n      };\r\n    }\r\n\r\n    // Merchant not met -> mysterious placeholder\r\n    const revealText = 'Explore the Delve menu to reveal this upgrade';\r\n    return {\r\n      locked: true,\r\n      iconOverride: MYSTERIOUS_UPGRADE_ICON_DATA_URL,\r\n      titleOverride: HIDDEN_UPGRADE_TITLE,\r\n      descOverride: revealText,\r\n      reason: revealText,\r\n      hidden: true,\r\n      hideCost: true,\r\n      hideEffect: true,\r\n      useLockedBase: true,\r\n    };\r\n  }\r\n\r\n  // ==== Unlock XP ====\r\n  if (tieKey === UPGRADE_TIES.UNLOCK_XP) {\r\n    return determineUnlockXpLockState();\r\n  }\r\n\r\n  // ==== Unlock Forge ====\r\n  if (tieKey === UPGRADE_TIES.UNLOCK_FORGE) {\r\n    // No XP system -> LOCKED padlock\r\n    if (!xpUnlocked) {\r\n      return { locked: true, iconOverride: LOCKED_UPGRADE_ICON_DATA_URL, useLockedBase: true };\r\n    }\r\n    // Before 31 -> show same requirement text as mysterious, but without generic \"hidden\" line\r\n    let xp31 = false;\r\n    try { const xpBn = currentXpLevelBigNum(); xp31 = levelBigNumToNumber(xpBn) >= 31; } catch {}\r\n    if (!xp31) {\r\n      const revealText = (upgRef?.revealRequirement) || 'Reach XP Level 31 to reveal this upgrade';\r\n      return {\r\n        locked: true,\r\n        iconOverride: MYSTERIOUS_UPGRADE_ICON_DATA_URL,\r\n        hidden: true,\r\n        hideCost: true,\r\n        hideEffect: true,\r\n        useLockedBase: true,\r\n        titleOverride: HIDDEN_UPGRADE_TITLE,\r\n        descOverride: revealText,\r\n        reason: revealText,\r\n      };\r\n    }\r\n    // XP \u2265 31 -> visible/unlocked\r\n    return { locked: false };\r\n  }\r\n\r\n  // ==== Unlock Infuse ====\r\n  if (tieKey === UPGRADE_TIES.UNLOCK_INFUSE) {\r\n    if (!hasDoneForgeReset()) {\r\n      return {\r\n        locked: true,\r\n        iconOverride: LOCKED_UPGRADE_ICON_DATA_URL,\r\n        useLockedBase: true,\r\n        hidden: false,\r\n        hideCost: true,\r\n        hideEffect: true,\r\n        titleOverride: LOCKED_UPGRADE_TITLE,\r\n        descOverride: 'Do a Forge reset to reveal this upgrade',\r\n        reason: 'Do a Forge reset to reveal this upgrade',\r\n      };\r\n    }\r\n\r\n    let xp101 = false;\r\n    try { const xpBn = currentXpLevelBigNum(); xp101 = levelBigNumToNumber(xpBn) >= 101; } catch {}\r\n    if (!xp101) {\r\n      const revealText = (upgRef?.revealRequirement) || 'Reach XP Level 101 to reveal this upgrade';\r\n      return {\r\n        locked: true,\r\n        iconOverride: MYSTERIOUS_UPGRADE_ICON_DATA_URL,\r\n        hidden: true,\r\n        hideCost: true, hideEffect: true, useLockedBase: true,\r\n        titleOverride: HIDDEN_UPGRADE_TITLE,\r\n        descOverride: revealText,\r\n        reason: revealText,\r\n      };\r\n    }\r\n    return { locked: false };\r\n  }\r\n\r\n  // ==== Unlock Surge ====\r\n  if (tieKey === UPGRADE_TIES.UNLOCK_SURGE) {\r\n    if (!hasDoneInfuseReset()) {\r\n      return {\r\n        locked: true,\r\n        iconOverride: LOCKED_UPGRADE_ICON_DATA_URL,\r\n        useLockedBase: true,\r\n        hidden: false,\r\n        hideCost: true,\r\n        hideEffect: true,\r\n        titleOverride: LOCKED_UPGRADE_TITLE,\r\n        descOverride: 'Do an Infuse reset to reveal this upgrade',\r\n        reason: 'Do an Infuse reset to reveal this upgrade',\r\n      };\r\n    }\r\n\r\n    let xp201 = false;\r\n    try { const xpBn = currentXpLevelBigNum(); xp201 = levelBigNumToNumber(xpBn) >= 201; } catch {}\r\n    if (!xp201) {\r\n      const revealText = (upgRef?.revealRequirement) || 'Reach XP Level 201 to reveal this upgrade';\r\n      return {\r\n        locked: true,\r\n        iconOverride: MYSTERIOUS_UPGRADE_ICON_DATA_URL,\r\n        hidden: true,\r\n        hideCost: true, hideEffect: true, useLockedBase: true,\r\n        titleOverride: HIDDEN_UPGRADE_TITLE,\r\n        descOverride: revealText,\r\n        reason: revealText,\r\n      };\r\n    }\r\n    return { locked: false };\r\n  }\r\n\r\n  // ==== Infuse Placeholders ====\r\n  if (INFUSE_PLACEHOLDER_TIES.has(tieKey)) {\r\n    if (hasDoneInfuseReset() || isUpgradePermanentlyUnlocked(area, upgRef)) {\r\n      try { markUpgradePermanentlyUnlocked(area, upgRef); } catch {}\r\n      return { locked: false, hidden: false, useLockedBase: false };\r\n    }\r\n\r\n    let xp101 = false;\r\n    try { const xpBn = currentXpLevelBigNum(); xp101 = levelBigNumToNumber(xpBn) >= 101; } catch {}\r\n\r\n    // Before 101 -> hard LOCKED\r\n    if (!xp101) {\r\n      return {\r\n        locked: true,\r\n        iconOverride: LOCKED_UPGRADE_ICON_DATA_URL,\r\n        useLockedBase: true,\r\n        titleOverride: LOCKED_UPGRADE_TITLE,\r\n        descOverride: 'Locked',\r\n        reason: 'Locked',\r\n        hidden: false,\r\n        hideCost: false,\r\n        hideEffect: false,\r\n      };\r\n    }\r\n\r\n    // 101+ -> Mysterious\r\n    const revealText = 'Do an Infuse reset to reveal this upgrade';\r\n    try { markUpgradePermanentlyMysterious(area, upgRef); } catch {}\r\n    return {\r\n      locked: true,\r\n      iconOverride: MYSTERIOUS_UPGRADE_ICON_DATA_URL,\r\n      hidden: true, hideCost: true, hideEffect: true, useLockedBase: true,\r\n      titleOverride: HIDDEN_UPGRADE_TITLE,\r\n      descOverride: revealText,\r\n      reason: revealText,\r\n    };\r\n  }\r\n\r\n  if (hasDoneForgeReset() || isUpgradePermanentlyUnlocked(area, upgRef)) {\r\n    try { markUpgradePermanentlyUnlocked(area, upgRef); } catch {}\r\n    return { locked: false, hidden: false, useLockedBase: false };\r\n  }\r\n\r\n  // No XP system -> LOCKED padlock\r\n  if (!xpUnlocked) {\r\n    return { locked: true, iconOverride: LOCKED_UPGRADE_ICON_DATA_URL, useLockedBase: true };\r\n  }\r\n\r\n  if (isUpgradePermanentlyMysterious(area, upgRef)) {\r\n    const revealText = 'Do a Forge reset to reveal this upgrade';\r\n    return {\r\n      locked: true,\r\n      iconOverride: MYSTERIOUS_UPGRADE_ICON_DATA_URL,\r\n      hidden: true, hideCost: true, hideEffect: true, useLockedBase: true,\r\n      titleOverride: HIDDEN_UPGRADE_TITLE,\r\n      descOverride: revealText,\r\n      reason: revealText,\r\n    };\r\n  }\r\n\r\n  // Compute XP \u2265 31 once (for the *first-time* reveal/burn)\r\n  let xp31 = false;\r\n  try { const xpBn = currentXpLevelBigNum(); xp31 = levelBigNumToNumber(xpBn) >= 31; } catch {}\r\n\r\n// Before 31 -> hard LOCKED (not mysterious, not clickable)\r\nif (!xp31) {\r\n  const revealText = 'Do a Forge reset to reveal this upgrade';\r\n  return {\r\n    locked: true,\r\n    iconOverride: LOCKED_UPGRADE_ICON_DATA_URL,\r\n    useLockedBase: true,\r\n    titleOverride: LOCKED_UPGRADE_TITLE,\r\n    descOverride: revealText,\r\n    reason: revealText,\r\n    hidden: false,\r\n    hideCost: false,\r\n    hideEffect: false,\r\n  };\r\n}\r\n\r\n  // First time hitting 31 -> burn perma-mysterious and show MYSTERIOUS\r\n  try { markUpgradePermanentlyMysterious(area, upgRef); } catch {}\r\n  return {\r\n    locked: true,\r\n    iconOverride: MYSTERIOUS_UPGRADE_ICON_DATA_URL,\r\n    hidden: true, hideCost: true, hideEffect: true, useLockedBase: true,\r\n  };\r\n}\r\n\r\nfunction snapshotUpgradeLockState(lockState) {\r\n  if (!lockState || typeof lockState !== 'object') return null;\r\n  const snapshot = {};\r\n  const keys = [\r\n    'iconOverride',\r\n    'titleOverride',\r\n    'descOverride',\r\n    'reason',\r\n    'hideCost',\r\n    'hideEffect',\r\n    'hidden',\r\n    'useLockedBase',\r\n  ];\r\n  for (const key of keys) {\r\n    if (lockState[key] !== undefined) snapshot[key] = lockState[key];\r\n  }\r\n  return snapshot;\r\n}\r\n\r\nfunction normalizeAreaKey(areaKey) {\r\n  if (typeof areaKey === 'string') {\r\n    const trimmed = areaKey.trim();\r\n    if (trimmed) {\r\n      return trimmed.toLowerCase().replace(/[^a-z0-9]+/g, '_');\r\n    }\r\n  }\r\n  return '';\r\n}\r\n\r\nfunction normalizeUpgradeTie(tieValue) {\r\n  if (typeof tieValue === 'string') {\r\n    const trimmed = tieValue.trim();\r\n    if (trimmed) {\r\n      return trimmed.toLowerCase().replace(/[^a-z0-9]+/g, '_');\r\n    }\r\n  }\r\n  return '';\r\n}\r\n\r\n\r\nfunction isXpAdjacentUpgrade(areaKey, upg) {\r\n  const tieKey = normalizeUpgradeTie(upg?.tie ?? upg?.tieKey);\r\n  if (tieKey && XP_MYSTERY_UPGRADE_TIES.has(tieKey)) {\r\n    return true;\r\n  }\r\n  const normalizedId = normalizeUpgradeId(upg?.id);\r\n  const numericId = typeof normalizedId === 'number'\r\n    ? normalizedId\r\n    : Number.parseInt(normalizedId, 10);\r\n  const idKey = Number.isFinite(numericId)\r\n    ? String(numericId)\r\n    : (normalizedId != null ? String(normalizedId) : '');\r\n  if (!idKey) return false;\r\n\r\n  const areaCandidates = [];\r\n  if (areaKey != null) areaCandidates.push(areaKey);\r\n  if (upg?.area != null) areaCandidates.push(upg.area);\r\n\r\n  for (const candidate of areaCandidates) {\r\n    const normArea = normalizeAreaKey(candidate);\r\n    if (!normArea) continue;\r\n    if (XP_MYSTERY_LEGACY_KEYS.has(`${normArea}:${idKey}`)) {\r\n      return true;\r\n    }\r\n  }\r\n\r\n  return false;\r\n}\r\n\r\nfunction safeIsXpUnlocked() {\r\n  try {\r\n    return !!isXpSystemUnlocked();\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\nfunction safeHasMetMerchant(slot = getActiveSlot()) {\r\n  const slotKey = String(slot ?? 'default');\r\n  if (typeof localStorage === 'undefined') return false;\r\n  try {\r\n    return localStorage.getItem(`${MERCHANT_MET_KEY_BASE}:${slotKey}`) === '1';\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\nfunction currentXpLevelBigNum() {\r\n  try {\r\n    const state = typeof getXpState === 'function' ? getXpState() : null;\r\n    if (state?.xpLevel instanceof BigNum) {\r\n      return state.xpLevel.clone?.() ?? state.xpLevel;\r\n    }\r\n    if (state?.xpLevel != null) {\r\n      return BigNum.fromAny(state.xpLevel);\r\n    }\r\n  } catch {}\r\n  return BigNum.fromInt(0);\r\n}\r\n\r\nfunction bookValueMultiplierBn(level) {\r\n  const L = ensureLevelBigNum(level);\r\n  try {\r\n    const plain = L.toPlainIntegerString?.();\r\n    if (plain && plain !== 'Infinity' && plain.length <= 15) {\r\n      const lvl = Math.max(0, Number(plain));\r\n      return bigNumFromLog10(lvl * Math.log10(2)).floorToInteger();\r\n    }\r\n  } catch {}\r\n\r\n  return BigNum.fromAny('Infinity');\r\n}\r\n\r\nfunction normalizedUpgradeLevel(levelValue) {\r\n  if (typeof levelValue === 'number' && Number.isFinite(levelValue)) {\r\n    return Math.max(0, Math.floor(levelValue));\r\n  }\r\n  if (typeof levelValue === 'bigint') {\r\n    if (levelValue < 0n) return 0;\r\n    const maxSafe = BigInt(Number.MAX_SAFE_INTEGER);\r\n    const clamped = levelValue > maxSafe ? maxSafe : levelValue;\r\n    return Number(clamped);\r\n  }\r\n  if (levelValue instanceof BigNum) {\r\n    try {\r\n      const plain = levelValue.toPlainIntegerString?.();\r\n      if (plain && plain !== 'Infinity') {\r\n        const parsed = Number.parseInt(plain, 10);\r\n        if (Number.isFinite(parsed)) {\r\n          return Math.max(0, parsed);\r\n        }\r\n      }\r\n    } catch {}\r\n  }\r\n  return 0;\r\n}\r\n\r\nfunction getLinearBonusMultiplier(levelValue, amountPerLevel) {\r\n  const lvl = normalizedUpgradeLevel(levelValue);\r\n  if (lvl <= 0) {\r\n    return BigNum.fromInt(1);\r\n  }\r\n  const perLevel = Math.max(0, Math.floor(Number(amountPerLevel) || 0));\r\n  if (perLevel === 0) return BigNum.fromInt(1);\r\n\r\n  try {\r\n    const asBigInt = (BigInt(lvl) * BigInt(perLevel)) + 1n;\r\n    return BigNum.fromAny(asBigInt.toString());\r\n  } catch {\r\n    try {\r\n      return BigNum.fromAny(String(1 + perLevel * lvl));\r\n    } catch {\r\n      return BigNum.fromInt(1);\r\n    }\r\n  }\r\n}\r\n\r\nfunction mergeLockStates(base, override) {\r\n  const merged = Object.assign({ locked: false }, base || {});\r\n  if (!override || typeof override !== 'object') return merged;\r\n  const keys = [\r\n    'locked',\r\n    'iconOverride',\r\n    'titleOverride',\r\n    'descOverride',\r\n    'reason',\r\n    'hideCost',\r\n    'hideEffect',\r\n    'hidden',\r\n    'useLockedBase',\r\n  ];\r\n  for (const key of keys) {\r\n    if (override[key] !== undefined) merged[key] = override[key];\r\n  }\r\n  return merged;\r\n}\r\n\r\nfunction normalizeUpgradeId(upgId) {\r\n  if (typeof upgId === 'number') {\r\n    if (!Number.isFinite(upgId)) return upgId;\r\n    return Math.trunc(upgId);\r\n  }\r\n  if (typeof upgId === 'string') {\r\n    const trimmed = upgId.trim();\r\n    if (!trimmed) return trimmed;\r\n    if (/^[+-]?\\d+$/.test(trimmed)) {\r\n      const parsed = Number.parseInt(trimmed, 10);\r\n      if (Number.isFinite(parsed)) return parsed;\r\n    }\r\n    return trimmed;\r\n  }\r\n  return upgId;\r\n}\r\n\r\nfunction ensureLevelBigNum(value) {\r\n  try {\r\n    value = sanitizeStoredLevelValue(value, { allowEmpty: true });\r\n    if (typeof value === 'string') {\r\n      const trimmed = value.trim();\r\n      if (!trimmed) return BigNum.fromInt(0);\r\n      if (/^inf(?:inity)?$/i.test(trimmed)) return BigNum.fromAny('Infinity');\r\n\r\n      // If the value is an enormous integer string, avoid constructing a huge BigInt.\r\n      if (!trimmed.startsWith('BN:') && /^[+-]?\\d+$/.test(trimmed)) {\r\n        const unsigned = trimmed.replace(/^[+-]/, '').replace(/^0+(?=\\d)/, '');\r\n        if (!unsigned) return BigNum.fromInt(0);\r\n        if (unsigned.length > BigNum.MAX_PLAIN_DIGITS) return BigNum.fromAny('Infinity');\r\n        if (unsigned.length > 32) {\r\n          return bigNumFromLog10(unsigned.length - 1);\r\n        }\r\n      }\r\n    }\r\n\r\n    const bn = value instanceof BigNum ? value : BigNum.fromAny(value ?? 0);\r\n    if (bn.isInfinite?.()) return bn.clone?.() ?? bn;\r\n\r\n    const approxDigits = approxLog10BigNum(bn);\r\n    if (!Number.isFinite(approxDigits)) {\r\n      return approxDigits > 0 ? BigNum.fromAny('Infinity') : BigNum.fromInt(0);\r\n    }\r\n    if (approxDigits + 1 > BigNum.MAX_PLAIN_DIGITS) return bn.clone?.() ?? bn;\r\n    if (approxDigits > 32) return bn.clone?.() ?? bn;\r\n\r\n    const plain = bn.toPlainIntegerString?.();\r\n    if (plain === 'Infinity') return BigNum.fromAny('Infinity');\r\n    if (!plain) return BigNum.fromInt(0);\r\n    const normalized = plain.replace(/^0+(?=\\d)/, '');\r\n    if (!normalized) return BigNum.fromInt(0);\r\n    return BigNum.fromAny(normalized);\r\n  } catch {\r\n    const num = Math.max(0, Math.floor(Number(value) || 0));\r\n    return BigNum.fromInt(num);\r\n  }\r\n}\r\n\r\nfunction levelBigNumToNumber(value) {\r\n  let bn;\r\n  try {\r\n    bn = value instanceof BigNum ? value : BigNum.fromAny(value ?? 0);\r\n  } catch {\r\n    return 0;\r\n  }\r\n\r\n  if (bn.isInfinite?.()) return Number.POSITIVE_INFINITY;\r\n\r\n  const approx = approxLog10BigNum(bn);\r\n  if (!Number.isFinite(approx)) return approx > 0 ? Number.MAX_VALUE : 0;\r\n  if (approx > 308) return Number.MAX_VALUE;\r\n  if (approx < -324) return 0;\r\n  if (approx > 20) {\r\n    const value = Math.pow(10, approx);\r\n    return Number.isFinite(value) ? value : Number.MAX_VALUE;\r\n  }\r\n\r\n  try {\r\n    const plain = bn.toPlainIntegerString?.();\r\n    if (!plain || plain === 'Infinity') {\r\n      return plain === 'Infinity' ? Number.MAX_VALUE : 0;\r\n    }\r\n\r\n    const digits = plain.replace(/^0+/, '');\r\n    if (!digits) return 0;\r\n\r\n    if (digits.length <= 15) {\r\n      const num = Number(digits);\r\n      return Number.isFinite(num) ? num : 0;\r\n    }\r\n\r\n    const lead = digits.slice(0, 15);\r\n    const leadNum = Number(lead);\r\n    const leadLen = lead.length;\r\n    if (!Number.isFinite(leadNum) || leadNum <= 0) return 0;\r\n\r\n    let mantissa = leadNum / Math.pow(10, leadLen - 1);\r\n    let exponent = digits.length - 1;\r\n\r\n    if (mantissa <= 0 || !Number.isFinite(mantissa)) return 0;\r\n\r\n    if (mantissa >= 10) {\r\n      const shift = Math.floor(Math.log10(mantissa));\r\n      if (Number.isFinite(shift) && shift > 0) {\r\n        mantissa /= Math.pow(10, shift);\r\n        exponent += shift;\r\n      }\r\n    } else if (mantissa < 1) {\r\n      const shift = Math.ceil(Math.log10(1 / mantissa));\r\n      if (Number.isFinite(shift) && shift > 0) {\r\n        mantissa *= Math.pow(10, shift);\r\n        exponent -= shift;\r\n      }\r\n    }\r\n\r\n    if (exponent > 308) {\r\n      return Number.MAX_VALUE;\r\n    }\r\n    if (exponent < -324) {\r\n      return 0;\r\n    }\r\n\r\n    const approx = mantissa * Math.pow(10, exponent);\r\n    if (!Number.isFinite(approx)) {\r\n      return exponent > 0 ? Number.MAX_VALUE : 0;\r\n    }\r\n    return approx;\r\n  } catch {\r\n    const approx = approxLog10BigNum(bn);\r\n    if (!Number.isFinite(approx)) return Number.MAX_VALUE;\r\n    if (approx > 308) return Number.MAX_VALUE;\r\n    if (approx < -324) return 0;\r\n    const value = Math.pow(10, approx);\r\n    return Number.isFinite(value) ? value : Number.MAX_VALUE;\r\n  }\r\n}\r\n\r\nconst LN10 = Math.log(10);\r\n\r\nfunction plainLevelDelta(nextLevelBn, prevLevelBn) {\r\n  const next = ensureLevelBigNum(nextLevelBn);\r\n  const prev = ensureLevelBigNum(prevLevelBn);\r\n\r\n  if (next.isInfinite?.()) {\r\n    return prev.isInfinite?.() ? BigNum.fromInt(0) : BigNum.fromAny('Infinity');\r\n  }\r\n  if (prev.isInfinite?.()) {\r\n    return BigNum.fromInt(0);\r\n  }\r\n\r\n  try {\r\n    const nextDigits = Math.floor(approxLog10BigNum(next)) + 1;\r\n    const prevDigits = Math.floor(approxLog10BigNum(prev)) + 1;\r\n    if (!Number.isFinite(nextDigits) || nextDigits > 120 || !Number.isFinite(prevDigits)) {\r\n      if (!Number.isFinite(prevDigits) || nextDigits <= prevDigits) return BigNum.fromInt(0);\r\n      return BigNum.fromAny('Infinity');\r\n    }\r\n\r\n    const nextPlain = next.toPlainIntegerString?.();\r\n    const prevPlain = prev.toPlainIntegerString?.();\r\n    if (!nextPlain || !prevPlain) return BigNum.fromInt(0);\r\n    if (nextPlain === 'Infinity') return BigNum.fromAny('Infinity');\r\n    if (prevPlain === 'Infinity') return BigNum.fromInt(0);\r\n    if (nextPlain === prevPlain) return BigNum.fromInt(0);\r\n    const diff = BigInt(nextPlain) - BigInt(prevPlain);\r\n    if (diff <= 0n) return BigNum.fromInt(0);\r\n    return BigNum.fromAny(diff.toString());\r\n  } catch {\r\n    return BigNum.fromInt(0);\r\n  }\r\n}\r\n\r\nfunction decimalMultiplierString(value) {\r\n  if (!Number.isFinite(value) || value <= 0) return '1';\r\n  let out = value.toFixed(12);\r\n  out = out.replace(/0+$/, '');\r\n  if (out.endsWith('.')) out += '0';\r\n  return out;\r\n}\r\n\r\nfunction normalizeHmEvolutionCount(value) {\r\n  const n = Number(value);\r\n  if (Number.isFinite(n) && n > 0) return Math.max(0, Math.floor(n));\r\n  return 0;\r\n}\r\n\r\nfunction activeEvolutionsForUpgrade(upg) {\r\n  if (!upg) return 0;\r\n  const active = Number(upg.activeEvolutions);\r\n  if (Number.isFinite(active) && active >= 0) return active;\r\n  return normalizeHmEvolutionCount(upg.numUpgEvolutions);\r\n}\r\n\r\nexport function computeDefaultUpgradeCost(baseCost, level, upgType = 'NM') {\r\n  let baseBn;\r\n  try { baseBn = BigNum.fromAny(baseCost ?? 0); }\r\n  catch { baseBn = BigNum.fromInt(0); }\r\n\r\n  const levelNumber = levelBigNumToNumber(level);\r\n\r\n  const upg = { upgType, numUpgEvolutions: 0 };\r\n  if (`${upgType ?? ''}`.toUpperCase() === 'HM') {\r\n    const evolutions = Math.max(0, Math.floor(levelNumber / HM_EVOLUTION_INTERVAL));\r\n    if (Number.isFinite(evolutions)) {\r\n      upg.numUpgEvolutions = evolutions;\r\n    }\r\n  }\r\n\r\n  const preset = resolveDefaultScalingRatio(upg);\r\n  let ratio = (preset?.ratio > 0) ? preset.ratio : 1;\r\n  // If ratio is infinite, treat it as > 1 logic but ensure we have ratioLog10\r\n  if (ratio === Infinity && preset?.ratioLog10 == null) {\r\n      // Fallback if no explicit log provided for infinity?\r\n      // Just keep ratio as Infinity, Math.log10(Infinity) is Infinity.\r\n  }\r\n  \r\n  let ratioLog10 = (preset && preset.ratioLog10 != null)\r\n      ? preset.ratioLog10\r\n      : Math.log10(Math.max(ratio, 1));\r\n      \r\n  const scaling = {\r\n    baseBn,\r\n    baseLog10: approxLog10BigNum(baseBn),\r\n    ratio,\r\n    ratioMinus1: Math.max(0, ratio - 1),\r\n    ratioLog10,\r\n    ratioLn: ratioLog10 * Math.LN10,\r\n    ratioStr: decimalMultiplierString(Math.max(ratio, 1)),\r\n    defaultPreset: preset?.preset,\r\n  };\r\n\r\n  upg.scaling = scaling;\r\n\r\n  return costAtLevelUsingScaling(upg, levelNumber);\r\n}\r\n\r\nconst DEFAULT_SCALING_PRESETS = {\r\n  STANDARD(upg) {\r\n    const upgType = `${upg?.upgType ?? ''}`.toUpperCase();\r\n    if (upgType === 'HM') {\r\n      const evol = activeEvolutionsForUpgrade(upg);\r\n      const evolThreshold = 1000; // Corresponds to level 1M\r\n      if (evol > evolThreshold) {\r\n        const evol_after_1m = evol - evolThreshold;\r\n        const base_scaling = 0.1 * evolThreshold;\r\n        const r = 1.001;\r\n        // Sum of a geometric series: 0.1 * r * (r^n - 1) / (r - 1)\r\n        const extra_scaling = 0.1 * (r / (r - 1)) * (Math.pow(r, evol_after_1m) - 1);\r\n        return 1.50 + base_scaling + extra_scaling;\r\n      }\r\n      return 1.50 + (0.10 * evol);\r\n    }\r\n    return 1.20;\r\n  },\r\n  HM(upg) {\r\n    const evol = activeEvolutionsForUpgrade(upg);\r\n    // Relaxed linear scaling for Phase 1 & 2 (up to 1,000,000 evolutions / Level 1B)\r\n    let ratio = 1.50 + (0.10 * evol);\r\n\r\n    // Phase 3: Double-Exponential Softcap starting at Level 1 Billion\r\n    const softcapStart = 1_000_000;\r\n    if (evol > softcapStart) {\r\n      const delta = evol - softcapStart;\r\n      // Calibrated to hit BN Infinity around Level 4 Trillion (4e9 evolutions)\r\n      const rate = 1.8e-7;\r\n      const baseLog = 5;\r\n      const ratioLog10 = baseLog * Math.exp(rate * delta);\r\n      let ratio = Infinity;\r\n      if (ratioLog10 < 308) {\r\n        ratio = Math.pow(10, ratioLog10);\r\n      }\r\n      return { ratio, ratioLog10 };\r\n    }\r\n    return ratio;\r\n  },\r\n  NM() {\r\n    return 1.20;\r\n  },\r\n};\r\n\r\nfunction hmLevelCapForEvolutions(evolutions) {\r\n  const cycles = normalizeHmEvolutionCount(evolutions);\r\n  const cap = HM_EVOLUTION_INTERVAL * (cycles + 1);\r\n  const capBn = BigNum.fromAny(cap);\r\n  return {\r\n    cap,\r\n    capBn,\r\n    capFmtHtml: formatBigNumAsHtml(capBn),\r\n    capFmtText: formatBigNumAsPlain(capBn),\r\n  };\r\n}\r\n\r\nfunction hmMilestoneHits(levelBn, milestoneLevel) {\r\n  if (!levelBn || typeof milestoneLevel !== 'number') return 0;\r\n  const approxDigits = Math.floor(approxLog10BigNum(levelBn)) + 1;\r\n  if (!Number.isFinite(approxDigits)) return 0;\r\n  if (approxDigits > 120) {\r\n    const approx = levelBigNumToNumber(levelBn);\r\n    if (!Number.isFinite(approx) || approx < milestoneLevel) return 0;\r\n    const delta = approx - milestoneLevel;\r\n    return Math.max(0, Math.floor(delta / HM_EVOLUTION_INTERVAL) + 1);\r\n  }\r\n  try {\r\n    const plain = levelBn.toPlainIntegerString?.();\r\n    if (!plain || plain === 'Infinity') return 0;\r\n    const lvl = BigInt(plain);\r\n    const base = BigInt(Math.max(0, Math.floor(milestoneLevel)));\r\n    const interval = BigInt(HM_EVOLUTION_INTERVAL);\r\n    if (lvl < base) return 0;\r\n    const delta = lvl - base;\r\n    const cycles = delta / interval;\r\n    return Number(cycles + 1n);\r\n  } catch {\r\n    const approx = levelBigNumToNumber(levelBn);\r\n    if (!Number.isFinite(approx) || approx < milestoneLevel) return 0;\r\n    const delta = approx - milestoneLevel;\r\n    return Math.max(0, Math.floor(delta / HM_EVOLUTION_INTERVAL) + 1);\r\n  }\r\n}\r\n\r\nfunction hmMilestoneMultiplier(multiplier, hits) {\r\n  if (!(hits > 0)) return BigNum.fromInt(1);\r\n\r\n  let base;\r\n  try { base = BigNum.fromAny(multiplier ?? 1); }\r\n  catch { base = BigNum.fromInt(1); }\r\n\r\n  const hitCount = Math.max(0, Math.floor(hits));\r\n  if (!Number.isFinite(hitCount)) return BigNum.fromAny('Infinity');\r\n  if (hitCount <= 1) return base.clone?.() ?? base;\r\n\r\n  const multiply = (a, b) => {\r\n    try { return a.mulBigNumInteger(b); } catch {}\r\n    try { return a.mulDecimal(b.toScientific?.(12) ?? String(multiplier ?? '1'), 18); } catch {}\r\n    try { return b.mulDecimal(a.toScientific?.(12) ?? String(multiplier ?? '1'), 18); } catch {}\r\n    return BigNum.fromAny('Infinity');\r\n  };\r\n\r\n  // For small hit counts preserve precision with a short loop.\r\n  if (hitCount <= 8) {\r\n    let result = base.clone?.() ?? base;\r\n    for (let i = 1; i < hitCount; i += 1) {\r\n      result = multiply(result, base);\r\n    }\r\n    return result;\r\n  }\r\n\r\n  // Use exponentiation by squaring to avoid O(hits) loops for huge levels.\r\n  let result = BigNum.fromInt(1);\r\n  let factor = base.clone?.() ?? base;\r\n  let exp = hitCount;\r\n\r\n  while (exp > 0) {\r\n    if (exp % 2 === 1) result = multiply(result, factor);\r\n    exp = Math.floor(exp / 2);\r\n    if (exp > 0) factor = multiply(factor, factor);\r\n  }\r\n\r\n  return result;\r\n}\r\n\r\nfunction resolveHmMilestones(upg, areaKey = DEFAULT_AREA_KEY) {\r\n  if (Array.isArray(upg?.hmMilestones)) return upg.hmMilestones;\r\n  const normalizedArea = normalizeAreaKey(areaKey || upg?.area || DEFAULT_AREA_KEY);\r\n  return HM_MILESTONES_BY_AREA[normalizedArea] || HM_MILESTONES_STARTER_COVE;\r\n}\r\n\r\nfunction safeMultiplyBigNum(base, factor) {\r\n  let out = base instanceof BigNum ? base : BigNum.fromAny(base ?? 1);\r\n  let f = factor instanceof BigNum ? factor : null;\r\n  if (!f) {\r\n    try { f = BigNum.fromAny(factor ?? 1); }\r\n    catch { return out; }\r\n  }\r\n  try { return out.mulBigNumInteger(f); }\r\n  catch {}\r\n  try { return out.mulDecimal(f.toScientific?.(12) ?? String(factor ?? '1'), 18); }\r\n  catch {}\r\n  return out;\r\n}\r\n\r\nfunction applyHmEvolutionMeta(upg, evolutions = 0) {\r\n  if (!upg || upg.upgType !== 'HM') return;\r\n  delete upg.scaling;\r\n  const { cap, capBn, capFmtHtml, capFmtText } = hmLevelCapForEvolutions(evolutions);\r\n  upg.activeEvolutions = evolutions;\r\n  upg.lvlCap = cap;\r\n  upg.lvlCapBn = capBn;\r\n  upg.lvlCapFmtHtml = capFmtHtml;\r\n  upg.lvlCapFmtText = capFmtText;\r\n}\r\n\r\nfunction computeHmMultipliers(upg, levelBn, areaKey = DEFAULT_AREA_KEY) {\r\n  if (!upg || upg.upgType !== 'HM') {\r\n    return {\r\n      selfMult: BigNum.fromInt(1),\r\n      xpMult: BigNum.fromInt(1),\r\n      coinMult: BigNum.fromInt(1),\r\n      mpMult: BigNum.fromInt(1),\r\n    };\r\n  }\r\n\r\n  const milestones = resolveHmMilestones(upg, areaKey);\r\n  let selfMult = BigNum.fromInt(1);\r\n  let xpMult = BigNum.fromInt(1);\r\n  let coinMult = BigNum.fromInt(1);\r\n  let mpMult = BigNum.fromInt(1);\r\n\r\n  for (const m of milestones) {\r\n    const hits = hmMilestoneHits(levelBn, Number(m?.level ?? m?.lvl ?? 0));\r\n    if (!(hits > 0)) continue;\r\n    const mult = hmMilestoneMultiplier(m.multiplier ?? m.mult ?? m.value ?? 1, hits);\r\n    const target = `${m.target ?? m.type ?? 'self'}`.toLowerCase();\r\n    if (target === 'xp') {\r\n      xpMult = safeMultiplyBigNum(xpMult, mult);\r\n    } else if (target === 'coin' || target === 'coins') {\r\n      coinMult = safeMultiplyBigNum(coinMult, mult);\r\n    } else if (target === 'mp') {\r\n      mpMult = safeMultiplyBigNum(mpMult, mult);\r\n    } else {\r\n      selfMult = safeMultiplyBigNum(selfMult, mult);\r\n    }\r\n  }\r\n\r\n  const evolutions = activeEvolutionsForUpgrade(upg);\r\n  for (let i = 0; i < evolutions; i += 1) {\r\n    selfMult = safeMultiplyBigNum(selfMult, HM_EVOLUTION_EFFECT_MULT_BN);\r\n  }\r\n\r\n  return { selfMult, xpMult, coinMult, mpMult };\r\n}\r\n\r\nfunction hmNextMilestoneLevel(upg, levelBn, areaKey = DEFAULT_AREA_KEY) {\r\n  if (!upg || upg.upgType !== 'HM') return null;\r\n  if (levelBn?.isInfinite?.()) return BigNum.fromAny('Infinity');\r\n  const milestones = resolveHmMilestones(upg, areaKey);\r\n  if (!milestones.length) return null;\r\n\r\n  let best = null;\r\n  for (const m of milestones) {\r\n    const lvl = Math.max(0, Math.floor(Number(m?.level ?? m?.lvl ?? 0)));\r\n    const hits = hmMilestoneHits(levelBn, lvl);\r\n    let candidate = null;\r\n    try {\r\n      const base = BigInt(lvl);\r\n      const nextHits = BigInt(Math.max(0, hits));\r\n      const targetBi = base + (BigInt(HM_EVOLUTION_INTERVAL) * nextHits);\r\n      if (targetBi > 0n) {\r\n        candidate = BigNum.fromAny(targetBi.toString());\r\n      }\r\n    } catch {}\r\n    if (!candidate) {\r\n      const increment = BigNum.fromAny(HM_EVOLUTION_INTERVAL * Math.max(0, hits));\r\n      try { candidate = increment.add(BigNum.fromAny(lvl)); }\r\n      catch { candidate = BigNum.fromAny(lvl + HM_EVOLUTION_INTERVAL * hits); }\r\n    }\r\n    if (!candidate) continue;\r\n    if (levelBn?.cmp?.(candidate) >= 0) {\r\n      try { candidate = candidate.add(BigNum.fromAny(HM_EVOLUTION_INTERVAL)); }\r\n      catch {}\r\n    }\r\n    if (!best || best.cmp(candidate) > 0) {\r\n      best = candidate;\r\n    }\r\n  }\r\n  return best;\r\n}\r\n\r\nfunction resolveDefaultScalingRatio(upg) {\r\n  if (!upg) return null;\r\n\r\n  const tryPreset = (name) => {\r\n    const presetName = `${name ?? ''}`.toUpperCase();\r\n    if (!presetName) return null;\r\n    const presetFn = DEFAULT_SCALING_PRESETS[presetName];\r\n    if (typeof presetFn !== 'function') return null;\r\n    const res = presetFn(upg);\r\n    if (typeof res === 'object' && res !== null) {\r\n      // Allow objects with ratioLog10 even if ratio is infinite\r\n      if (res.ratioLog10 != null || res.ratio > 0) {\r\n        return {\r\n          ratio: res.ratio ?? 1,\r\n          ratioLog10: res.ratioLog10,\r\n          preset: presetName\r\n        };\r\n      }\r\n      return null;\r\n    }\r\n    const ratio = res;\r\n    if ((!Number.isFinite(ratio) && ratio !== Infinity) || ratio <= 0) return null;\r\n    return { ratio, preset: presetName };\r\n  };\r\n\r\n  return (\r\n    tryPreset(upg.scalingPreset)\r\n    || tryPreset(upg.upgType)\r\n    || tryPreset('STANDARD')\r\n  );\r\n}\r\n\r\nfunction ensureUpgradeScaling(upg) {\r\n  if (!upg) return null;\r\n  if (upg.scaling && upg.scaling.baseBn) return upg.scaling;\r\n  try {\r\n    const baseBn = BigNum.fromAny(upg.baseCost ?? upg.baseCostBn ?? 0);\r\n\r\n    const providedScaling = upg.scaling ?? {};\r\n    let ratio = Number(providedScaling.ratio);\r\n    if (!(ratio > 0) || (!Number.isFinite(ratio) && ratio !== Infinity)) ratio = null;\r\n\r\n    let ratioStr = typeof providedScaling.ratioStr === 'string'\r\n      ? providedScaling.ratioStr.trim()\r\n      : '';\r\n    if (!ratio && ratioStr) {\r\n      const parsed = Number(ratioStr);\r\n      if (Number.isFinite(parsed) && parsed > 0) {\r\n        ratio = parsed;\r\n      }\r\n    }\r\n\r\n    let ratioLog10 = Number(providedScaling.ratioLog10);\r\n    if (!Number.isFinite(ratioLog10)) ratioLog10 = null;\r\n    if (!ratio && ratioLog10 != null) {\r\n      const pow = Math.pow(10, ratioLog10);\r\n      if (Number.isFinite(pow) && pow > 0) ratio = pow;\r\n    }\r\n\r\n    let ratioLn = Number(providedScaling.ratioLn);\r\n    if (!Number.isFinite(ratioLn)) ratioLn = null;\r\n    if (!ratio && ratioLn != null) {\r\n      const exp = Math.exp(ratioLn);\r\n      if (Number.isFinite(exp) && exp > 0) ratio = exp;\r\n    }\r\n\r\n    if (!ratio) {\r\n      const ratioMinus1 = Number(providedScaling.ratioMinus1);\r\n      if (Number.isFinite(ratioMinus1) && ratioMinus1 > 0) {\r\n        ratio = ratioMinus1 + 1;\r\n      }\r\n    }\r\n\r\n    let defaultPreset = null;\r\n    if (!ratio) {\r\n      const resolved = resolveDefaultScalingRatio(upg);\r\n      if (resolved) {\r\n        ratio = resolved.ratio;\r\n        if (resolved.ratioLog10 != null) ratioLog10 = resolved.ratioLog10;\r\n        defaultPreset = resolved.preset;\r\n      }\r\n    }\r\n\r\n    if (!(ratio > 1)) {\r\n      ratio = 1;\r\n      ratioStr = '1';\r\n      ratioLog10 = 0;\r\n      ratioLn = 0;\r\n      var ratioMinus1 = 0;\r\n    } else {\r\n      ratio = Number(ratio);\r\n      ratioStr = decimalMultiplierString(ratio);\r\n      \r\n      // Use existing ratioLog10 if available and we are handling the Infinity case,\r\n      // or if normal calculation would be redundant/less precise.\r\n      if (ratioLog10 == null || (ratio === Infinity && Number.isFinite(ratioLog10))) {\r\n          // keep current ratioLog10 if it's finite and ratio is infinite\r\n          if (ratioLog10 == null) ratioLog10 = Math.log10(ratio);\r\n      } else {\r\n          // Standard case: sync log10 to ratio if ratio is finite\r\n          if (Number.isFinite(ratio)) {\r\n             ratioLog10 = Math.log10(ratio);\r\n          }\r\n      }\r\n      \r\n      if (Number.isFinite(ratioLog10)) {\r\n          ratioLn = ratioLog10 * Math.LN10;\r\n      } else {\r\n          ratioLn = Math.log(ratio);\r\n      }\r\n      var ratioMinus1 = Math.max(1e-12, ratio - 1);\r\n    }\r\n\r\n    const baseLog10 = approxLog10BigNum(baseBn);\r\n\r\n    const scaling = Object.assign({}, providedScaling, {\r\n      baseBn,\r\n      baseLog10,\r\n      ratio,\r\n      ratioMinus1,\r\n      ratioLog10,\r\n      ratioLn,\r\n      ratioStr,\r\n      defaultPreset: defaultPreset ?? providedScaling.defaultPreset,\r\n    });\r\n\r\n    // Expose the in-progress scaling so recursive cost checks can use it\r\n    upg.scaling = scaling;\r\n\r\n    try {\r\n      const c0 = BigNum.fromAny(upg.costAtLevel?.(0) ?? 0);\r\n      const c1 = BigNum.fromAny(upg.costAtLevel?.(1) ?? 0);\r\n      const cF = BigNum.fromAny(upg.costAtLevel?.(32) ?? 0);\r\n      if (c0.cmp(c1) === 0 && c0.cmp(cF) === 0) {\r\n        scaling.ratio = 1;\r\n        scaling.ratioMinus1 = 0;\r\n        scaling.ratioLog10 = 0;\r\n        scaling.ratioLn = 0;\r\n        scaling.ratioStr = '1';\r\n      }\r\n    } catch {}\r\n\r\n    return scaling;\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\nfunction costAtLevelUsingScaling(upg, level) {\r\n  const scaling = ensureUpgradeScaling(upg);\r\n  if (!scaling) return BigNum.fromInt(0);\r\n  const lvl = Math.max(0, Math.floor(Number(level) || 0));\r\n  if (lvl === 0) return BigNum.fromAny(scaling.baseBn);\r\n\r\n  // Approach A (robust & simple): multiply without flooring, floor once at end\r\n  if (lvl <= 100) {\r\n    let price = BigNum.fromAny(scaling.baseBn);\r\n    for (let i = 0; i < lvl; i += 1) {\r\n      // precise decimal multiply (no truncation each step)\r\n      price = price.mulDecimal(scaling.ratioStr);\r\n    }\r\n    return price.floorToInteger();\r\n  }\r\n\r\n  // Existing mid-range anchor + tail (kept as-is)\r\n  if (lvl < 10000) {\r\n    const anchor = Math.max(0, lvl - 10);\r\n    let price = bigNumFromLog10(scaling.baseLog10 + anchor * scaling.ratioLog10);\r\n    for (let step = anchor; step < lvl; step += 1) {\r\n      price = price.mulDecimal(scaling.ratioStr);\r\n    }\r\n    return price.floorToInteger();\r\n  }\r\n\r\n  // Very large levels: closed form via logs\r\n  return bigNumFromLog10(scaling.baseLog10 + lvl * scaling.ratioLog10).floorToInteger();\r\n}\r\n\r\n\r\nfunction logExpMinus1(x) {\r\n  if (!Number.isFinite(x)) return x;\r\n  if (x < 1e-6) {\r\n    return Math.log(Math.expm1(x));\r\n  }\r\n  if (x < 50) {\r\n    return Math.log(Math.expm1(x));\r\n  }\r\n  const negExp = Math.exp(-x);\r\n  return x + Math.log1p(-negExp);\r\n}\r\n\r\nfunction logSeriesTotal(upg, startLevel, count) {\r\n  if (!(count > 0)) return Number.NEGATIVE_INFINITY;\r\n  const scaling = ensureUpgradeScaling(upg);\r\n  if (!scaling) return Number.NEGATIVE_INFINITY;\r\n  if (!Number.isFinite(scaling.ratioLn)) {\r\n    if (count > 1) return Number.POSITIVE_INFINITY;\r\n    // For count=1, it is just startLn\r\n    const startLn = (scaling.baseLog10 * LN10) + (startLevel * scaling.ratioLn);\r\n    return startLn / LN10;\r\n  }\r\n  if (!(scaling.ratioMinus1 > 0)) {\r\n    return Number.POSITIVE_INFINITY;\r\n  }\r\n\r\n  const startLn = (scaling.baseLog10 * LN10) + (startLevel * scaling.ratioLn);\r\n  const growth = scaling.ratioLn * count;\r\n  const numerLn = logExpMinus1(growth);\r\n  if (!Number.isFinite(numerLn)) return Number.POSITIVE_INFINITY;\r\n  const denomLn = Math.log(scaling.ratioMinus1);\r\n  const totalLn = startLn + numerLn - denomLn;\r\n  return totalLn / LN10;\r\n}\r\n\r\nfunction totalCostBigNum(upg, startLevel, count) {\r\n  if (!(count > 0)) return BigNum.fromInt(0);\r\n  const scaling = ensureUpgradeScaling(upg);\r\n  if (!scaling) return BigNum.fromInt(0);\r\n  const targetLevel = startLevel + count;\r\n\r\n  if (targetLevel <= 100) {\r\n    let price = BigNum.fromAny(upg.costAtLevel(startLevel));\r\n    let total = BigNum.fromInt(0);\r\n    for (let i = 0; i < count; i += 1) {\r\n      total = total.add(price);\r\n      if (i + 1 < count) price = price.mulDecimalFloor(scaling.ratioStr);\r\n    }\r\n    return total;\r\n  }\r\n\r\n  if (targetLevel < 10000) {\r\n    const tailCount = Math.min(10, count);\r\n    const headCount = count - tailCount;\r\n    let total = BigNum.fromInt(0);\r\n    if (headCount > 0) {\r\n      const headLog = logSeriesTotal(upg, startLevel, headCount);\r\n      total = total.add(bigNumFromLog10(headLog));\r\n    }\r\n    if (tailCount > 0) {\r\n      const tailStart = startLevel + headCount;\r\n      let price = BigNum.fromAny(upg.costAtLevel(tailStart));\r\n      for (let i = 0; i < tailCount; i += 1) {\r\n        total = total.add(price);\r\n        if (i + 1 < tailCount) price = price.mulDecimalFloor(scaling.ratioStr);\r\n      }\r\n    }\r\n    return total;\r\n  }\r\n\r\n  const totalLog = logSeriesTotal(upg, startLevel, count);\r\n  return bigNumFromLog10(totalLog);\r\n}\r\n\r\nfunction log10OnePlusPow10(exponent) {\r\n  if (!Number.isFinite(exponent)) {\r\n    if (exponent > 0) return exponent;\r\n    if (exponent === 0) return Math.log10(2);\r\n    return 0;\r\n  }\r\n  if (exponent > 308) return exponent;\r\n  if (exponent < -20) {\r\n    const pow = Math.pow(10, exponent);\r\n    return pow / LN10;\r\n  }\r\n  const pow = Math.pow(10, exponent);\r\n  if (!Number.isFinite(pow)) return exponent > 0 ? exponent : 0;\r\n  return Math.log1p(pow) / LN10;\r\n}\r\n\r\nconst MAX_LEVEL_DELTA_LIMIT = (() => {\r\n  try {\r\n    const approx = levelBigNumToNumber(MAX_LEVEL_DELTA);\r\n    if (!Number.isFinite(approx)) return Number.POSITIVE_INFINITY;\r\n    if (approx <= 0) return 0;\r\n    return Math.floor(approx);\r\n  } catch {\r\n    return Number.MAX_SAFE_INTEGER;\r\n  }\r\n})();\r\n\r\nconst FLOAT64_BUFFER = new ArrayBuffer(8);\r\nconst FLOAT64_VIEW = new Float64Array(FLOAT64_BUFFER);\r\nconst INT64_VIEW = new BigInt64Array(FLOAT64_BUFFER);\r\n\r\nfunction nextDownPositive(value) {\r\n  if (!(value > 0) || !Number.isFinite(value)) return value;\r\n  FLOAT64_VIEW[0] = value;\r\n  if (FLOAT64_VIEW[0] <= 0) return 0;\r\n  INT64_VIEW[0] -= 1n;\r\n  const next = FLOAT64_VIEW[0];\r\n  return next > 0 ? next : 0;\r\n}\r\n\r\nfunction nextUpPositive(value) {\r\n  if (!(value >= 0) || !Number.isFinite(value)) return value;\r\n  FLOAT64_VIEW[0] = value;\r\n  INT64_VIEW[0] += 1n;\r\n  const next = FLOAT64_VIEW[0];\r\n  return next > value ? next : value;\r\n}\r\n\r\nfunction safeDecrementCount(value) {\r\n  if (!(value > 0)) return 0;\r\n  const dec = Math.floor(value - 1);\r\n  if (dec < value) return dec;\r\n  const next = nextDownPositive(value);\r\n  if (next < value) return next;\r\n  return value > 1 ? value / 2 : 0;\r\n}\r\n\r\nfunction countToBigNum(count) {\r\n  if (!(count > 0) || !Number.isFinite(count)) return BigNum.fromInt(0);\r\n  const floored = Math.floor(count);\r\n  if (!(floored > 0)) return BigNum.fromInt(0);\r\n  if (floored <= Number.MAX_SAFE_INTEGER) {\r\n    return BigNum.fromInt(floored);\r\n  }\r\n  let str;\r\n  try {\r\n    str = floored.toLocaleString('fullwide', { useGrouping: false, maximumFractionDigits: 0 });\r\n  } catch {\r\n    str = floored.toString();\r\n  }\r\n  if (!str || !/\\d/.test(str)) return BigNum.fromInt(0);\r\n  return BigNum.fromAny(str);\r\n}\r\n\r\nfunction calculateBulkPurchase(upg, startLevel, walletBn, maxLevels = MAX_LEVEL_DELTA, options = {}) {\r\n  const scaling = ensureUpgradeScaling(upg);\r\n  const zero = BigNum.fromInt(0);\r\n  const opts = options || {};\r\n  const fastOnly = !!opts.fastOnly;\r\n  walletBn = walletBn instanceof BigNum ? walletBn : BigNum.fromAny(walletBn ?? 0);\r\n  if (!scaling) {\r\n    return { count: zero, spent: zero, nextPrice: zero, numericCount: 0 };\r\n  }\r\n\r\n  const startLevelNum = Math.max(0, Math.floor(levelBigNumToNumber(startLevel)));\r\n\r\n  const cap = Number.isFinite(upg.lvlCap)\r\n    ? Math.max(0, Math.floor(upg.lvlCap))\r\n    : Number.POSITIVE_INFINITY;\r\n  const maxLevelsNum = typeof maxLevels === 'number'\r\n    ? maxLevels\r\n    : levelBigNumToNumber(maxLevels);\r\n  const capRoom = Number.isFinite(cap)\r\n    ? Math.max(0, cap - startLevelNum)\r\n    : MAX_LEVEL_DELTA_LIMIT;\r\n  let room = Number.isFinite(maxLevelsNum)\r\n    ? Math.max(0, Math.floor(maxLevelsNum))\r\n    : MAX_LEVEL_DELTA_LIMIT;\r\n  room = Math.min(room, MAX_LEVEL_DELTA_LIMIT, capRoom);\r\n  if (!(room > 0)) {\r\n    const nextPrice = capRoom <= 0 ? zero : BigNum.fromAny(upg.costAtLevel(startLevelNum));\r\n    return { count: zero, spent: zero, nextPrice, numericCount: 0 };\r\n  }\r\n\r\n  // For small levels we can cheaply compute an exact floored progression, which\r\n  // avoids undercounting caused by geometric approximations that ignore per-step\r\n  // flooring (e.g., costs like 3 \u2192 3 \u2192 4 instead of 3 \u2192 3.6 \u2192 4.32).\r\n  const remainingToHundred = 100 - startLevelNum;\r\n  if (Number.isFinite(startLevelNum) && remainingToHundred > 0) {\r\n    const limit = Math.min(room, remainingToHundred);\r\n    let price = BigNum.fromAny(upg.costAtLevel(startLevelNum));\r\n    let spent = zero;\r\n    let count = 0;\r\n\r\n    while (count < limit) {\r\n      // Use the exact per-level cost function (with its own flooring logic)\r\n      // instead of multiplying by ratio, so we don't drift when costs change\r\n      // non-geometrically around low levels.\r\n      price = BigNum.fromAny(upg.costAtLevel(startLevelNum + count));\r\n      const newSpent = spent.add(price);\r\n      if (newSpent.cmp(walletBn) > 0) break;\r\n      spent = newSpent;\r\n      count += 1;\r\n    }\r\n\r\n    const nextLevel = startLevelNum + count;\r\n    const reachedCap = Number.isFinite(cap) && nextLevel >= cap;\r\n    const countBn = countToBigNum(count);\r\n\r\n    if (count < limit || reachedCap || room <= count) {\r\n      const nextPrice = reachedCap\r\n        ? zero\r\n        : BigNum.fromAny(upg.costAtLevel(nextLevel));\r\n      return { count: countBn, spent, nextPrice, numericCount: count };\r\n    }\r\n\r\n    const nextStartLevel = (() => {\r\n      try { return toUpgradeBigNum(startLevel ?? startLevelNum, startLevelNum).add(countBn); }\r\n      catch { return startLevelNum + count; }\r\n    })();\r\n    const tail = calculateBulkPurchase(\r\n      upg,\r\n      nextStartLevel,\r\n      walletBn.sub(spent),\r\n      room - count,\r\n      options,\r\n    );\r\n\r\n    const tailCount = tail?.count instanceof BigNum ? tail.count : countToBigNum(tail?.numericCount ?? 0);\r\n    const totalCount = countBn.add(tailCount);\r\n    const totalSpent = (tail?.spent ?? zero).add(spent);\r\n\r\n    return {\r\n      count: totalCount,\r\n      spent: totalSpent,\r\n      nextPrice: tail?.nextPrice ?? zero,\r\n      numericCount: count + (tail?.numericCount ?? 0),\r\n    };\r\n  }\r\n\r\nlet walletLog = approxLog10BigNum(walletBn);\r\n\r\nconst ratioLog10 = scaling.ratioLog10;\r\nconst ratioMinus1 = scaling.ratioMinus1;\r\nconst firstPrice = BigNum.fromAny(upg.costAtLevel(startLevelNum));\r\n\r\n\r\nconst startPriceLog = scaling.baseLog10 + (startLevelNum * ratioLog10);\r\n\r\n// Fallback: if walletLog isn't finite *or* magnitudes are so huge that\r\n// double-precision subtraction will be meaningless, do a pure-BigNum search.\r\nconst needBnSearch =\r\n  (ratioMinus1 > 0) && (\r\n    !Number.isFinite(walletLog) ||\r\n    (Math.abs(walletLog) > 1e6 && Math.abs(startPriceLog) > 1e6)\r\n  );\r\n\r\nif (needBnSearch) {\r\n  // Quick \"can't even buy 1\" check\r\n  const firstPrice = BigNum.fromAny(upg.costAtLevel(startLevelNum));\r\n  if (walletBn.cmp(firstPrice) < 0) {\r\n    return { count: zero, spent: zero, nextPrice: firstPrice, numericCount: 0 };\r\n  }\r\n\r\n  // Bound the affordable count using only BigNum compares\r\n  const hardLimit = Number.isFinite(room) ? Math.max(1, Math.floor(room)) : Number.MAX_VALUE;\r\n  let lo = 1;\r\n  let hi = 1;\r\n\r\nwhile (hi < hardLimit) {\r\n  const spentLog = logSeriesTotal(upg, startLevelNum, hi);\r\n  const spentBn  = bigNumFromLog10(spentLog);\r\n  if (spentBn.cmp(walletBn) <= 0) {\r\n    const doubled = hi * 2;\r\n    if (!Number.isFinite(doubled) || doubled <= hi) { hi = hardLimit; break; }\r\n    lo = hi;\r\n    hi = Math.min(doubled, hardLimit);\r\n  } else {\r\n    break;\r\n  }\r\n}\r\n\r\n  let steps = 0;\r\n  while (lo < hi && steps < 256) {\r\n    const mid = Math.max(lo + 1, Math.floor((lo + hi + 1) / 2));\r\n    const spentLog = logSeriesTotal(upg, startLevelNum, mid);\r\n    const spentBn  = bigNumFromLog10(spentLog);\r\n    if (spentBn.cmp(walletBn) <= 0) {\r\n      lo = mid;\r\n    } else {\r\n      hi = mid - 1;\r\n    }\r\n    steps++;\r\n  }\r\n\r\n  const count = Math.max(1, lo);\r\n  const countBn = countToBigNum(count);\r\n\r\n  // In fastOnly mode we can skip exact 'spent'; otherwise compute precisely.\r\n  let spent = zero;\r\n  let nextPrice = zero;\r\n  if (!fastOnly) {\r\n    spent = totalCostBigNum(upg, startLevelNum, count);\r\n    if (Number.isFinite(cap)) {\r\n      const capRoom = Math.max(0, Math.floor(cap - Math.min(startLevelNum, cap)));\r\n      if (count >= capRoom) {\r\n        nextPrice = zero;\r\n      } else {\r\n        nextPrice = bigNumFromLog10(startPriceLog + count * ratioLog10);\r\n      }\r\n    } else {\r\n      nextPrice = bigNumFromLog10(startPriceLog + count * ratioLog10);\r\n    }\r\n  }\r\n\r\n  return {\r\n    count: countBn,\r\n    spent,\r\n    nextPrice,\r\n    numericCount: count,\r\n  };\r\n}\r\n\r\n  if (walletBn.cmp(firstPrice) < 0) {\r\n    return { count: zero, spent: zero, nextPrice: firstPrice, numericCount: 0 };\r\n  }\r\n\r\nlet isConstantCost = false;\r\nlet secondPrice = null, farPrice = null;\r\n\r\ntry { secondPrice = BigNum.fromAny(upg.costAtLevel(startLevelNum + 1)); } catch {}\r\ntry {\r\n  const farProbe = Math.min(\r\n    Number.isFinite(cap) ? Math.max(startLevelNum + 1, Math.floor(cap)) : startLevelNum + 32,\r\n    startLevelNum + 32\r\n  );\r\n  farPrice = BigNum.fromAny(upg.costAtLevel(farProbe));\r\n} catch {}\r\nif (!isConstantCost && !(scaling.ratioMinus1 > 0)) {\r\n  isConstantCost = true;\r\n}\r\n\r\nif (secondPrice && farPrice) {\r\n  isConstantCost =\r\n    secondPrice.cmp(firstPrice) === 0 &&\r\n    farPrice.cmp(firstPrice) === 0;\r\n}\r\n\r\nif (!isConstantCost && !(scaling.ratioMinus1 > 0)) {\r\n  isConstantCost = true;\r\n}\r\n\r\n  const limit = Number.isFinite(room)\r\n    ? Math.max(0, Math.floor(room))\r\n    : Number.MAX_VALUE;\r\n\r\n  if (isConstantCost) {\r\n  const capBn = toUpgradeBigNum(upg.lvlCapBn ?? 'Infinity', 'Infinity');\r\n  const lvlBn = toUpgradeBigNum(startLevel ?? 0, 0);\r\n  const roomBn = capBn.isInfinite?.()\r\n    ? BigNum.fromAny('Infinity')\r\n    : capBn.sub(lvlBn).floorToInteger();\r\n\r\n  const { count, countBn, spent, nextPrice } = estimateFlatBulk(\r\n    firstPrice,\r\n    walletBn,\r\n    roomBn\r\n  );\r\n\r\n  return {\r\n    count: countBn,\r\n    spent,\r\n    nextPrice,\r\n    numericCount: count,\r\n  };\r\n}\r\n\r\nif (!(ratioLog10 > 0) || !(ratioMinus1 > 0)) {\r\n  const capBn = toUpgradeBigNum(upg.lvlCapBn ?? 'Infinity', 'Infinity');\r\n  const lvlBn = toUpgradeBigNum(startLevel ?? 0, 0);\r\n  const roomBn = capBn.isInfinite?.()\r\n    ? BigNum.fromAny('Infinity')\r\n    : capBn.sub(lvlBn).floorToInteger();\r\n\r\n  const { count, countBn, spent, nextPrice } =\r\n    estimateFlatBulk(firstPrice, walletBn, roomBn);\r\n\r\n  return { count: countBn, spent, nextPrice, numericCount: count };\r\n}\r\n\r\n  const ratioMinus1Log = Math.log10(ratioMinus1);\r\n  if (!Number.isFinite(ratioMinus1Log)) {\r\n    return { count: zero, spent: zero, nextPrice: firstPrice, numericCount: 0 };\r\n  }\r\n\r\n  const logTarget = log10OnePlusPow10(walletLog + ratioMinus1Log - startPriceLog);\r\n  let approxCount = logTarget / ratioLog10;\r\n  if (!Number.isFinite(approxCount) || approxCount < 0) approxCount = 0;\r\n\r\n  let count = Math.floor(Math.min(limit, approxCount));\r\n  if (!Number.isFinite(count)) count = limit;\r\n  if (count <= 0) count = 1;\r\n\r\n  const EPS = 1e-7;\r\n  let spentLog = logSeriesTotal(upg, startLevelNum, count);\r\n  let tuneSteps = 0;\r\n  const MAX_TUNE_STEPS = 2048;\r\n\r\n  while (count > 0 && (!Number.isFinite(spentLog) || spentLog > walletLog + EPS) && tuneSteps < MAX_TUNE_STEPS) {\r\n    const overshoot = Number.isFinite(spentLog)\r\n      ? Math.max(1, Math.ceil((spentLog - walletLog) / Math.max(ratioLog10, 1e-12)))\r\n      : Math.max(1, Math.floor(count / 2));\r\n    const reduced = Math.max(0, Math.floor(count - overshoot));\r\n    if (reduced < count) {\r\n      count = reduced;\r\n    } else {\r\n      const next = nextDownPositive(count);\r\n      if (!(next < count)) break;\r\n      count = next;\r\n    }\r\n    spentLog = count > 0 ? logSeriesTotal(upg, startLevelNum, count) : Number.NEGATIVE_INFINITY;\r\n    tuneSteps += 1;\r\n  }\r\n\r\n  if (count <= 0 || !Number.isFinite(count)) {\r\n    if (walletBn.cmp(firstPrice) >= 0) {\r\n      count = 1;\r\n      spentLog = approxLog10BigNum(firstPrice);\r\n    } else {\r\n      return { count: zero, spent: zero, nextPrice: firstPrice, numericCount: 0 };\r\n    }\r\n  }\r\n\r\n  if (count < limit) {\r\n  const safeTimes2 = (x) => {\r\n    const y = x * 2;\r\n    return Number.isFinite(y) ? y : Number.MAX_VALUE;\r\n  };\r\n\r\n  let lo = count;\r\n  let hi = Math.min(limit, Math.max(count + 1, safeTimes2(count)));\r\n  let hiLog = logSeriesTotal(upg, startLevelNum, hi);\r\n\r\n  while (lo < hi && Number.isFinite(hiLog) && hiLog <= walletLog + EPS && hi < limit) {\r\n    lo = hi;\r\n    hi = Math.min(limit, safeTimes2(hi));\r\n    hiLog = logSeriesTotal(upg, startLevelNum, hi);\r\n  }\r\n\r\n  let left = lo, right = hi;\r\n  for (let i = 0; i < 256 && left < right; i += 1) {\r\n    const mid = Math.floor((left + right + 1) / 2);\r\n    const midLog = logSeriesTotal(upg, startLevelNum, mid);\r\n    if (Number.isFinite(midLog) && midLog <= walletLog + EPS) {\r\n      left = mid;\r\n      spentLog = midLog;\r\n    } else {\r\n      right = mid - 1;\r\n    }\r\n  }\r\n  count = left;\r\n}\r\n\r\n  let spent = null;\r\n  if (!fastOnly) {\r\n    spent = totalCostBigNum(upg, startLevelNum, count);\r\n    let guard = 0;\r\n    while (spent.cmp(walletBn) > 0 && count > 0 && guard < MAX_TUNE_STEPS) {\r\n      const decremented = safeDecrementCount(count);\r\n      if (!(decremented < count)) break;\r\n      count = decremented;\r\n      spent = totalCostBigNum(upg, startLevelNum, count);\r\n      guard += 1;\r\n    }\r\n    if (count <= 0) {\r\n      return { count: zero, spent: zero, nextPrice: firstPrice, numericCount: 0 };\r\n    }\r\n\r\n    if (count < limit && guard < MAX_TUNE_STEPS) {\r\n      while (count < limit && guard < MAX_TUNE_STEPS) {\r\n        const nextLevel = startLevelNum + count;\r\n        let nextCost;\r\n\r\n        try {\r\n          if (Number.isFinite(nextLevel) && nextLevel < Number.MAX_SAFE_INTEGER / 2) {\r\n            nextCost = BigNum.fromAny(upg.costAtLevel(nextLevel));\r\n          } else {\r\n            const nextLog = startPriceLog + (count * ratioLog10);\r\n            nextCost = bigNumFromLog10(nextLog).floorToInteger();\r\n          }\r\n        } catch {\r\n          break;\r\n        }\r\n\r\n        const newSpent = spent.add(nextCost);\r\n        if (newSpent.cmp(walletBn) > 0) {\r\n          break;\r\n        }\r\n\r\n        spent = newSpent;\r\n        count += 1;\r\n        guard += 1;\r\n      }\r\n    }\r\n  }\r\n\r\nlet nextPrice = zero;\r\n\r\nconst canUseNumericFinal =\r\n  !fastOnly &&\r\n  Number.isFinite(startLevelNum) &&\r\n  Number.isFinite(count) &&\r\n  startLevelNum < Number.MAX_SAFE_INTEGER / 2 &&\r\n  count < Number.MAX_SAFE_INTEGER / 2;\r\n\r\nif (!fastOnly) {\r\n  if (Number.isFinite(cap)) {\r\n    const capRoom = Math.max(0, Math.floor(cap - Math.min(startLevelNum, cap)));\r\n    if (count >= capRoom) {\r\n      nextPrice = zero;\r\n    } else if (canUseNumericFinal) {\r\n      const finalLevel = Math.floor(startLevelNum + count);\r\n      nextPrice = BigNum.fromAny(upg.costAtLevel(finalLevel));\r\n    } else {\r\n      // Fallback: compute via logs to avoid unsafe integer math\r\n      const nextLog = startPriceLog + count * ratioLog10;\r\n      nextPrice = bigNumFromLog10(nextLog);\r\n    }\r\n  } else {\r\n    if (canUseNumericFinal) {\r\n      const finalLevel = Math.floor(startLevelNum + count);\r\n      nextPrice = BigNum.fromAny(upg.costAtLevel(finalLevel));\r\n    } else {\r\n      const nextLog = startPriceLog + count * ratioLog10;\r\n      nextPrice = bigNumFromLog10(nextLog);\r\n    }\r\n  }\r\n}\r\n\r\n  const countBn = countToBigNum(count);\r\n  return {\r\n    count: countBn,\r\n    spent,\r\n    nextPrice,\r\n    numericCount: count,\r\n  };\r\n}\r\n\r\nfunction computeBulkMeta(upg) {\r\n  try {\r\n    const basePrice = BigNum.fromAny(upg.costAtLevel(0));\r\n    const nextPrice = BigNum.fromAny(\r\n      typeof upg.nextCostAfter === 'function'\r\n        ? upg.nextCostAfter(basePrice, 1)\r\n        : upg.costAtLevel(1)\r\n    );\r\n    const logBase = approxLog10BigNum(basePrice);\r\n    const logNext = approxLog10BigNum(nextPrice);\r\n    if (!Number.isFinite(logBase) || !Number.isFinite(logNext)) return null;\r\n    const ratioLog = logNext - logBase;\r\n    if (!Number.isFinite(ratioLog) || ratioLog <= 0) return null;\r\n    const ratio = Math.pow(10, ratioLog);\r\n    if (!Number.isFinite(ratio) || ratio <= 1) return null;\r\n    const denom = ratio - 1;\r\n    if (!(denom > 0) || !Number.isFinite(denom)) return null;\r\n    return {\r\n      ratio,\r\n      ratioLog,\r\n      logDenom: Math.log10(denom),\r\n    };\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\nexport function estimateFlatBulk(priceBn, walletBn, roomBn) {\r\n  // Guardrails\r\n  if (!(priceBn instanceof BigNum)) priceBn = BigNum.fromAny(priceBn ?? 0);\r\n  if (!(walletBn instanceof BigNum)) walletBn = BigNum.fromAny(walletBn ?? 0);\r\n  if (!(roomBn instanceof BigNum)) roomBn = BigNum.fromAny(roomBn ?? 0);\r\n  if (priceBn.isZero?.()) return { count: 0 };\r\n  if (walletBn.isZero?.()) return { count: 0 };\r\n\r\nconst wPlain = walletBn.toPlainIntegerString?.();\r\nconst pPlain = priceBn.toPlainIntegerString?.();\r\nif (wPlain && wPlain !== 'Infinity' && pPlain && pPlain !== 'Infinity') {\r\n  const q = BigInt(wPlain) / BigInt(pPlain);\r\n  let countBn = BigNum.fromAny(q.toString());\r\n  if (!roomBn.isInfinite?.() && countBn.cmp(roomBn) > 0) countBn = roomBn;\r\n  const spent = priceBn.mulBigNumInteger(countBn);\r\n  return { count: levelCapToNumber(countBn), countBn, spent, nextPrice: priceBn };\r\n}\r\n\r\nconst wl = approxLog10BigNum(walletBn);\r\nconst pl = approxLog10BigNum(priceBn);\r\nif (!Number.isFinite(wl) || !Number.isFinite(pl) || wl < pl) return { count: 0 };\r\nlet countBn = bigNumFromLog10(wl - pl).floorToInteger();\r\n  \r\n  if (!roomBn.isInfinite?.() && countBn.cmp(roomBn) > 0) countBn = roomBn;\r\n  \r\n  const spent = priceBn.mulBigNumInteger(countBn);\r\n  const nextPrice = priceBn;\r\n  \r\n  return { count: levelCapToNumber(countBn), countBn, spent, nextPrice };\r\n}\r\n\r\nexport function estimateGeometricBulk(priceBn, walletBn, meta, maxLevels) {\r\n  if (!meta || maxLevels <= 0) return { count: 0 };\r\n  const walletLog = approxLog10BigNum(walletBn);\r\n  const priceLog = approxLog10BigNum(priceBn);\r\n  if (!Number.isFinite(walletLog) || !Number.isFinite(priceLog)) return { count: 0 };\r\n  if (walletLog < priceLog) return { count: 0 };\r\n\r\n  const numerator = walletLog - priceLog + meta.logDenom;\r\n  if (!Number.isFinite(numerator) || numerator <= 0) return { count: 0 };\r\n\r\n  let hi = Math.floor(numerator / meta.ratioLog);\r\n  if (!Number.isFinite(hi) || hi <= 0) return { count: 0 };\r\n  hi = Math.min(hi, maxLevels);\r\n  if (hi <= 0) return { count: 0 };\r\n\r\n  let lo = 0;\r\n  let hiBound = hi;\r\n  for (let iter = 0; iter < 64 && lo < hiBound; iter += 1) {\r\n    const mid = Math.max(0, Math.floor((lo + hiBound + 1) / 2));\r\n    const spentLog = priceLog + mid * meta.ratioLog - meta.logDenom;\r\n    if (spentLog <= walletLog) {\r\n      lo = mid;\r\n    } else {\r\n      hiBound = mid - 1;\r\n    }\r\n  }\r\n\r\n  const best = Math.min(lo, maxLevels);\r\n  if (best <= 0) return { count: 0 };\r\n  const spentLog = priceLog + best * meta.ratioLog - meta.logDenom;\r\n  if (spentLog > walletLog) return { count: 0 };\r\n  const nextPriceLog = priceLog + best * meta.ratioLog;\r\n  const spent = bigNumFromLog10(spentLog);\r\n  const nextPrice = bigNumFromLog10(nextPriceLog);\r\n  return {\r\n    count: best,\r\n    spent,\r\n    nextPrice,\r\n    spentLog,\r\n    nextPriceLog,\r\n  };\r\n}\r\n\r\nfunction toUpgradeBigNum(value, fallback) {\r\n  try {\r\n    return BigNum.fromAny(value ?? fallback ?? 0);\r\n  } catch {\r\n    return BigNum.fromAny(fallback ?? 0);\r\n  }\r\n}\r\n\r\nfunction levelCapToNumber(bn) {\r\n  if (!(bn instanceof BigNum)) return Infinity;\r\n  if (bn.isInfinite?.()) return Infinity;\r\n  try {\r\n    const plain = bn.toPlainIntegerString();\r\n    if (plain === 'Infinity') return Infinity;\r\n    if (!plain) return 0;\r\n    if (plain.length > 15) return Number.MAX_SAFE_INTEGER;\r\n    const num = Number(plain);\r\n    if (!Number.isFinite(num)) return Number.MAX_SAFE_INTEGER;\r\n    return Math.max(0, Math.floor(num));\r\n  } catch {\r\n    return Number.MAX_SAFE_INTEGER;\r\n  }\r\n}\r\n\r\nfunction formatBigNumAsHtml(bn) {\r\n  return formatNumber(bn instanceof BigNum ? bn : BigNum.fromAny(bn ?? 0));\r\n}\r\n\r\nexport function formatMultForUi(value) {\r\n  try {\r\n    if (value && (value instanceof BigNum || value.toPlainIntegerString)) {\r\n      const log10 = approxLog10BigNum(value);\r\n      if (Number.isFinite(log10) && log10 < 3) {\r\n        const approx = Math.pow(10, log10);\r\n        return String(approx.toFixed(3))\r\n          .replace(/\\.0+$/, '')\r\n          .replace(/(\\.\\d*?)0+$/, '$1');\r\n      }\r\n      return formatNumber(value);\r\n    }\r\n\r\n    const n = Number(value) || 0;\r\n    if (Math.abs(n) < 1000) {\r\n      return String(n.toFixed(3))\r\n        .replace(/\\.0+$/, '')\r\n        .replace(/(\\.\\d*?)0+$/, '$1');\r\n    }\r\n    return formatNumber(BigNum.fromAny(n));\r\n  } catch {\r\n    return '1';\r\n  }\r\n}\r\n\r\n\r\nfunction formatBigNumAsPlain(bn) {\r\n  return formatBigNumAsHtml(bn).replace(/<[^>]*>/g, '');\r\n}\r\n\r\nfunction safeCloneBigNum(value) {\r\n  if (value instanceof BigNum) {\r\n    try { return value.clone?.() ?? BigNum.fromAny(value); }\r\n    catch { return BigNum.fromInt(0); }\r\n  }\r\n  try {\r\n    return BigNum.fromAny(value ?? 0);\r\n  } catch {\r\n    return BigNum.fromInt(0);\r\n  }\r\n}\r\n\r\nfunction emitUpgradeLevelChange(upg, prevLevelNum, prevLevelBn, nextLevelNum, nextLevelBn) {\r\n  if (!upg || typeof upg.onLevelChange !== 'function') return;\r\n\r\n  const oldBn = safeCloneBigNum(prevLevelBn ?? prevLevelNum ?? 0);\r\n  const newBn = safeCloneBigNum(nextLevelBn ?? nextLevelNum ?? 0);\r\n  const payload = {\r\n    upgrade: upg,\r\n    oldLevel: Number.isFinite(prevLevelNum)\r\n      ? prevLevelNum\r\n      : levelBigNumToNumber(oldBn),\r\n    newLevel: Number.isFinite(nextLevelNum)\r\n      ? nextLevelNum\r\n      : levelBigNumToNumber(newBn),\r\n    oldLevelBn: oldBn,\r\n    newLevelBn: newBn,\r\n  };\r\n\r\n  try {\r\n    upg.onLevelChange(payload);\r\n  } catch {}\r\n}\r\n\r\nfunction nmCostBN(upg, level) {\r\n  return costAtLevelUsingScaling(upg, level);\r\n}\r\n\r\n\r\nfunction syncBookCurrencyMultiplierFromUpgrade(levelOverride) {\r\n  const multHandle = bank?.books?.mult;\r\n  if (!multHandle || typeof multHandle.set !== 'function') return;\r\n\r\n  let resolvedLevel = 0;\r\n  const xpUnlocked = safeIsXpUnlocked();\r\n  if (xpUnlocked) {\r\n    if (Number.isFinite(levelOverride)) {\r\n      resolvedLevel = Math.max(0, Math.floor(levelOverride));\r\n    } else {\r\n      const storedLevel = getLevelNumber(AREA_KEYS.STARTER_COVE, UPGRADE_TIES.BOOK_VALUE_I);\r\n      resolvedLevel = Math.max(0, Number.isFinite(storedLevel) ? storedLevel : 0);\r\n    }\r\n  }\r\n\r\n  let multiplier;\r\n  try {\r\n    multiplier = bookValueMultiplierBn(resolvedLevel);\r\n  } catch {\r\n    multiplier = BigNum.fromInt(1);\r\n  }\r\n\r\n  try {\r\n    multHandle.set(multiplier.clone?.() ?? multiplier);\r\n  } catch {}\r\n}\r\n\r\n/**\r\n * upgType:\r\n *  - \"NM\" = No Milestones\r\n *  - \"HM\" = Has Milestones\r\n *\r\n * Optional field:\r\n *  - scaling: Manually change the multiplicative scaling ratio of an upgrade; not necessary for upgrades that have no scaling\r\n */\r\nexport const REGISTRY = [\r\n  {\r\n    area: AREA_KEYS.STARTER_COVE,\r\n    id: 1,\r\n    tie: UPGRADE_TIES.FASTER_COINS,\r\n    title: \"Faster Coins\",\r\n    desc: \"Increases Coin Spawn Rate by +10% per level\",\r\n    lvlCap: 10,\r\n    baseCost: 10,\r\n    costType: \"coins\",\r\n    upgType: \"NM\",\r\n    effectType: \"coin_spawn\",\r\n    icon: \"sc_upgrade_icons/faster_coins1.webp\",\r\n    costAtLevel(level) { return nmCostBN(this, level); },\r\n    nextCostAfter(_, nextLevel) { return nmCostBN(this, nextLevel); },\r\n    effectSummary(level) {\r\n      const mult = this.effectMultiplier(level);\r\n      return `Coin Spawn Rate bonus: ${formatMultForUi(mult)}x`;\r\n    },\r\n    effectMultiplier: E.addPctPerLevel(0.10),\r\n  },\r\n  {\r\n    area: AREA_KEYS.STARTER_COVE,\r\n    id: 2,\r\n    tie: UPGRADE_TIES.UNLOCK_XP,\r\n    title: \"Unlock XP\",\r\n    desc: \"Unlocks the XP system and a new Merchant dialogue\\nXP system: Collect Coins for XP to level up and gain Books\\nEach XP Level also boosts Coin value by a decent amount\",\r\n    lvlCap: 1,\r\n    upgType: \"NM\",\r\n    icon: \"stats/xp/xp.webp\",\r\n    baseIconOverride: \"img/stats/xp/xp_base.webp\",\r\n    unlockUpgrade: true,\r\n    costAtLevel() { return BigNum.fromInt(0); },\r\n    nextCostAfter() { return BigNum.fromInt(0); },\r\n    computeLockState: determineLockState,\r\n    effectSummary() { return \"\"; },\r\n    onLevelChange({ newLevel, newLevelBn }) {\r\n      const reached = Number.isFinite(newLevel)\r\n        ? newLevel >= 1\r\n        : (newLevelBn?.cmp?.(BigNum.fromInt(1)) ?? -1) >= 0;\r\n      if (reached) { try { unlockXpSystem(); } catch {} }\r\n    },\r\n  },\r\n  {\r\n    area: AREA_KEYS.STARTER_COVE,\r\n    id: 3,\r\n    tie: UPGRADE_TIES.FASTER_COINS_II,\r\n    title: \"Faster Coins II\",\r\n    desc: \"Increases Coin Spawn Rate by +10% per level\",\r\n    lvlCap: 15,\r\n    baseCost: 1,\r\n    costType: \"books\",\r\n    upgType: \"NM\",\r\n    effectType: \"coin_spawn\",\r\n    icon: \"sc_upgrade_icons/faster_coins2.webp\",\r\n    requiresUnlockXp: true,\r\n    costAtLevel() { return this.baseCostBn?.clone?.() ?? BigNum.fromInt(1); },\r\n    nextCostAfter() { return this.costAtLevel(); },\r\n    effectSummary(level) {\r\n      const mult = this.effectMultiplier(level);\r\n      return `Coin Spawn Rate bonus: ${formatMultForUi(mult)}x`;\r\n    },\r\n    effectMultiplier: E.addPctPerLevel(0.10),\r\n  },\r\n  {\r\n    area: AREA_KEYS.STARTER_COVE,\r\n    id: 4,\r\n    tie: UPGRADE_TIES.COIN_VALUE_I,\r\n    title: \"Coin Value\",\r\n    desc: \"Increases Coin value by +50% per level\",\r\n    lvlCap: 100,\r\n    baseCost: 1,\r\n    costType: \"books\",\r\n    upgType: \"NM\",\r\n    effectType: \"coin_value\",\r\n    icon: \"sc_upgrade_icons/coin_val1.webp\",\r\n    requiresUnlockXp: true,\r\n    costAtLevel() { return this.baseCostBn?.clone?.() ?? BigNum.fromInt(1); },\r\n    nextCostAfter() { return this.costAtLevel(); },\r\n    effectSummary(level) {\r\n      const mult = this.effectMultiplier(level);\r\n      return `Coin value bonus: ${formatMultForUi(mult)}x`;\r\n    },\r\n    effectMultiplier: E.addPctPerLevel(0.50),\r\n    onLevelChange() { try { refreshCoinMultiplierFromXpLevel(); } catch {} },\r\n  },\r\n  {\r\n    area: AREA_KEYS.STARTER_COVE,\r\n    id: 5,\r\n    tie: UPGRADE_TIES.BOOK_VALUE_I,\r\n    title: \"Book Value\",\r\n    desc: \"Doubles Books gained when increasing XP Level\",\r\n    lvlCap: 1,\r\n    baseCost: 10,\r\n    costType: \"books\",\r\n    upgType: \"NM\",\r\n    effectType: \"book_value\",\r\n    icon: \"sc_upgrade_icons/book_val1.webp\",\r\n    requiresUnlockXp: true,\r\n    costAtLevel() { return this.baseCostBn?.clone?.() ?? BigNum.fromInt(1); },\r\n    nextCostAfter() { return this.costAtLevel(); },\r\n    effectSummary(level) {\r\n      return `Book value bonus: 2x`;\r\n    },\r\n    effectMultiplier: (lvl) => normalizedUpgradeLevel(lvl) > 0 ? 2 : 1,\r\n    onLevelChange({ newLevel }) { syncBookCurrencyMultiplierFromUpgrade(newLevel); },\r\n  },\r\n  {\r\n    area: AREA_KEYS.STARTER_COVE,\r\n    id: 6,\r\n    tie: UPGRADE_TIES.XP_VALUE_I,\r\n    title: \"XP Value\",\r\n    desc: \"Increases XP value by +200% per level\",\r\n    lvlCap: 10,\r\n    baseCost: 1000,\r\n    costType: \"coins\",\r\n    upgType: \"NM\",\r\n    effectType: \"xp_value\",\r\n    icon: \"sc_upgrade_icons/xp_val1.webp\",\r\n    requiresUnlockXp: true,\r\n    costAtLevel(level) { return nmCostBN(this, level); },\r\n    nextCostAfter(_, nextLevel) { return nmCostBN(this, nextLevel); },\r\n    effectSummary(level) {\r\n      const mult = this.effectMultiplier(level);\r\n      return `XP value bonus: ${formatMultForUi(mult)}x`;\r\n    },\r\n    effectMultiplier: E.addFlatPerLevel(2),\r\n  },\r\n  {\r\n    area: AREA_KEYS.STARTER_COVE,\r\n    id: 7,\r\n    tie: UPGRADE_TIES.UNLOCK_FORGE,\r\n    title: \"Unlock Forge\",\r\n    desc: \"Unlocks the Reset tab and the Forge reset in the Delve menu\",\r\n    lvlCap: 1,\r\n    upgType: \"NM\",\r\n    icon: \"misc/forge.webp\",\r\n    baseIconOverride: \"img/stats/mp/mp_base.webp\",\r\n    requiresUnlockXp: true,\r\n    revealRequirement: 'Reach XP Level 31 to reveal this upgrade',\r\n    unlockUpgrade: true,\r\n    costAtLevel() { return BigNum.fromInt(0); },\r\n    nextCostAfter() { return BigNum.fromInt(0); },\r\n    computeLockState: determineLockState,\r\n    onLevelChange({ newLevel }) {\r\n      if ((newLevel ?? 0) >= 1) {\r\n        try { onForgeUpgradeUnlocked(); } catch {}\r\n      }\r\n    },\r\n  },\r\n  {\r\n    area: AREA_KEYS.STARTER_COVE,\r\n    id: 8,\r\n    tie: UPGRADE_TIES.COIN_VALUE_II,\r\n    title: \"Coin Value II\",\r\n    desc: `Increases Coin value by +${formatNumber(BigNum.fromInt(1000))}% per level`,\r\n    lvlCap: 100,\r\n    baseCost: 1,\r\n    costType: \"gold\",\r\n    upgType: \"NM\",\r\n    effectType: \"coin_value\",\r\n    icon: \"sc_upgrade_icons/coin_val2.webp\",\r\n    requiresUnlockXp: true,\r\n    costAtLevel(level) { return nmCostBN(this, level); },\r\n    nextCostAfter(_, nextLevel) { return nmCostBN(this, nextLevel); },\r\n    computeLockState: determineLockState,\r\n    effectSummary(level) {\r\n      const mult = this.effectMultiplier(level);\r\n      return `Coin value bonus: ${formatMultForUi(mult)}x`;\r\n    },\r\n    effectMultiplier: E.addPctPerLevel(10),\r\n    onLevelChange() { try { refreshCoinMultiplierFromXpLevel(); } catch {} },\r\n  },\r\n  {\r\n    area: AREA_KEYS.STARTER_COVE,\r\n    id: 9,\r\n    tie: UPGRADE_TIES.XP_VALUE_II,\r\n    title: \"XP Value II\",\r\n    desc: \"Increases XP value by +100% per level\",\r\n    lvlCap: 100,\r\n    baseCost: 3,\r\n    costType: \"gold\",\r\n    upgType: \"NM\",\r\n    effectType: \"xp_value\",\r\n    icon: \"sc_upgrade_icons/xp_val2.webp\",\r\n    requiresUnlockXp: true,\r\n    costAtLevel(level) { return nmCostBN(this, level); },\r\n    nextCostAfter(_, nextLevel) { return nmCostBN(this, nextLevel); },\r\n    computeLockState: determineLockState,\r\n    effectSummary(level) {\r\n      const mult = this.effectMultiplier(level);\r\n      return `XP value bonus: ${formatMultForUi(mult)}x`;\r\n    },\r\n    effectMultiplier: E.addPctPerLevel(1),\r\n  },\r\n  {\r\n    area: AREA_KEYS.STARTER_COVE,\r\n    id: 10,\r\n    tie: UPGRADE_TIES.MP_VALUE_I,\r\n    title: \"MP Value\",\r\n    desc: \"Increases MP value by +100% per level\",\r\n    lvlCap: 100,\r\n    baseCost: 25,\r\n    costType: \"gold\",\r\n    upgType: \"NM\",\r\n    effectType: \"mp_value\",\r\n    icon: \"sc_upgrade_icons/mp_val1.webp\",\r\n    requiresUnlockXp: true,\r\n    costAtLevel(level) { return nmCostBN(this, level); },\r\n    nextCostAfter(_, nextLevel) { return nmCostBN(this, nextLevel); },\r\n    computeLockState: determineLockState,\r\n    effectSummary(level) {\r\n      const mult = this.effectMultiplier(level);\r\n      return `MP value bonus: ${formatMultForUi(mult)}x`;\r\n    },\r\n    effectMultiplier: E.addPctPerLevel(1),\r\n  },\r\n  {\r\n    area: AREA_KEYS.STARTER_COVE,\r\n    id: 11,\r\n    tie: UPGRADE_TIES.MAGNET,\r\n    title: \"Magnet\",\r\n    desc: \"Increases Magnet radius by +1 Unit per level\\nMagnet: Increases the distance from which you can collect Coins\",\r\n    lvlCap: 10,\r\n    baseCost: 100,\r\n    costType: \"gold\",\r\n    upgType: \"NM\",\r\n    effectType: \"magnet_radius\",\r\n    icon: \"sc_upgrade_icons/magnet.webp\",\r\n    requiresUnlockXp: true,\r\n    scaling: { ratio: 2 },\r\n    costAtLevel(level) { return nmCostBN(this, level); },\r\n    nextCostAfter(_, nextLevel) { return nmCostBN(this, nextLevel); },\r\n    computeLockState: determineLockState,\r\n    effectSummary(level) {\r\n      const units = normalizedUpgradeLevel(level); // zero-based (+0 units at level 0)\r\n      const unitsText = formatMultForUi(units);\r\n      const suffix = (unitsText === '1') ? 'Unit' : 'Units';\r\n      return `Magnet radius: ${unitsText} ${suffix}`;\r\n    },\r\n    effectMultiplier: (lvl) => normalizedUpgradeLevel(lvl),\r\n  },\r\n  {\r\n    area: AREA_KEYS.STARTER_COVE,\r\n    id: 12,\r\n    tie: UPGRADE_TIES.ENDLESS_XP,\r\n    title: \"Endless XP\",\r\n    desc: \"The first Milestone-type upgrade\\nMilestones: Reach a certain upgrade level for powerful buffs\\nMultiplies XP value by 1.1x per level\",\r\n    lvlCap: HM_EVOLUTION_INTERVAL,\r\n    baseCost: 1e6,\r\n    costType: \"coins\",\r\n    upgType: \"HM\",\r\n    effectType: \"xp_value\",\r\n    icon: \"sc_upg_icons/xp_val_hm.webp\",\r\n    requiresUnlockXp: true,\r\n    scalingPreset: 'HM',\r\n    costAtLevel(level) { return costAtLevelUsingScaling(this, level); },\r\n    nextCostAfter(_, nextLevel) { return costAtLevelUsingScaling(this, nextLevel); },\r\n    computeLockState: determineLockState,\r\n    effectSummary(level) {\r\n      const lvlBn = ensureLevelBigNum(level);\r\n      let baseMult;\r\n      try { baseMult = this.effectMultiplier(lvlBn); }\r\n      catch { baseMult = 1; }\r\n      const { selfMult } = computeHmMultipliers(this, lvlBn, this.area);\r\n      const total = safeMultiplyBigNum(baseMult, selfMult);\r\n      return `XP value bonus: ${formatMultForUi(total)}x`;\r\n    },\r\n    effectMultiplier: E.powPerLevel(1.1),\r\n  },\r\n  {\r\n    area: AREA_KEYS.STARTER_COVE,\r\n    id: 13,\r\n    tie: UPGRADE_TIES.UNLOCK_INFUSE,\r\n    title: \"Unlock Infuse\",\r\n    desc: \"Unlocks the Infuse reset\",\r\n    lvlCap: 1,\r\n    upgType: \"NM\",\r\n    icon: \"misc/infuse.webp\",\r\n    baseIconOverride: \"img/misc/infuse_base.webp\",\r\n    requiresUnlockXp: true,\r\n    revealRequirement: 'Reach XP Level 101 to reveal this upgrade',\r\n    unlockUpgrade: true,\r\n    costAtLevel() { return BigNum.fromInt(0); },\r\n    nextCostAfter() { return BigNum.fromInt(0); },\r\n    computeLockState: determineLockState,\r\n    onLevelChange({ newLevel }) {\r\n      if ((newLevel ?? 0) >= 1) {\r\n        try { onInfuseUpgradeUnlocked(); } catch {}\r\n      }\r\n    },\r\n  },\r\n  {\r\n    area: AREA_KEYS.STARTER_COVE,\r\n    id: 14,\r\n    tie: UPGRADE_TIES.COIN_VALUE_III,\r\n    title: \"Coin Value III\",\r\n    desc: `Increases Coin value by +${formatNumber(BigNum.fromInt(30000))}% per level`,\r\n    lvlCap: 100,\r\n    baseCost: 1,\r\n    costType: \"magic\",\r\n    upgType: \"NM\",\r\n    effectType: \"coin_value\",\r\n    icon: \"sc_upg_icons/coin_val3.webp\",\r\n    requiresUnlockXp: true,\r\n    costAtLevel(level) { return nmCostBN(this, level); },\r\n    nextCostAfter(_, nextLevel) { return nmCostBN(this, nextLevel); },\r\n    computeLockState: determineLockState,\r\n    effectSummary(level) {\r\n      const mult = this.effectMultiplier(level);\r\n      return `Coin value bonus: ${formatMultForUi(mult)}x`;\r\n    },\r\n    effectMultiplier: E.addPctPerLevel(300),\r\n  },\r\n  {\r\n    area: AREA_KEYS.STARTER_COVE,\r\n    id: 15,\r\n    tie: UPGRADE_TIES.XP_VALUE_III,\r\n    title: \"XP Value III\",\r\n    desc: \"Increases XP value by +200% per level\",\r\n    lvlCap: 100,\r\n    baseCost: 3,\r\n    costType: \"magic\",\r\n    upgType: \"NM\",\r\n    effectType: \"xp_value\",\r\n    icon: \"sc_upg_icons/xp_val3.webp\",\r\n    requiresUnlockXp: true,\r\n    costAtLevel(level) { return nmCostBN(this, level); },\r\n    nextCostAfter(_, nextLevel) { return nmCostBN(this, nextLevel); },\r\n    computeLockState: determineLockState,\r\n    effectSummary(level) {\r\n      const mult = this.effectMultiplier(level);\r\n      return `XP value bonus: ${formatMultForUi(mult)}x`;\r\n    },\r\n    effectMultiplier: E.addPctPerLevel(2),\r\n  },\r\n  {\r\n    area: AREA_KEYS.STARTER_COVE,\r\n    id: 16,\r\n    tie: UPGRADE_TIES.MP_VALUE_II,\r\n    title: \"MP Value II\",\r\n    desc: \"Increases MP value by +100% per level\",\r\n    lvlCap: 100,\r\n    baseCost: 25,\r\n    costType: \"magic\",\r\n    upgType: \"NM\",\r\n    effectType: \"mp_value\",\r\n    icon: \"sc_upg_icons/mp_val2.webp\",\r\n    requiresUnlockXp: true,\r\n    costAtLevel(level) { return nmCostBN(this, level); },\r\n    nextCostAfter(_, nextLevel) { return nmCostBN(this, nextLevel); },\r\n    computeLockState: determineLockState,\r\n    effectSummary(level) {\r\n      const mult = this.effectMultiplier(level);\r\n      return `MP value bonus: ${formatMultForUi(mult)}x`;\r\n    },\r\n    effectMultiplier: E.addPctPerLevel(1),\r\n  },\r\n  {\r\n    area: AREA_KEYS.STARTER_COVE,\r\n    id: 17,\r\n    tie: UPGRADE_TIES.FASTER_COINS_III,\r\n    title: \"Faster Coins III\",\r\n    desc: \"Doubles Coin Spawn Rate\",\r\n    lvlCap: 1,\r\n    baseCost: 100,\r\n    costType: \"magic\",\r\n    upgType: \"NM\",\r\n    effectType: \"coin_spawn\",\r\n    icon: \"sc_upg_icons/faster_coins3.webp\",\r\n    requiresUnlockXp: true,\r\n    costAtLevel(level) { return nmCostBN(this, level); },\r\n    nextCostAfter(_, nextLevel) { return nmCostBN(this, nextLevel); },\r\n    computeLockState: determineLockState,\r\n    effectSummary(level) {\r\n      const mult = this.effectMultiplier(level);\r\n      return `Coin Spawn Rate bonus: ${formatMultForUi(mult)}x`;\r\n    },\r\n    effectMultiplier: E.addPctPerLevel(1),\r\n  },\r\n  {\r\n    area: AREA_KEYS.STARTER_COVE,\r\n    id: 18,\r\n    tie: UPGRADE_TIES.ENDLESS_MP,\r\n    title: \"Endless MP\",\r\n    desc: \"Multiplies MP value by 1.1x per level\",\r\n    lvlCap: HM_EVOLUTION_INTERVAL,\r\n    baseCost: 1e12,\r\n    costType: \"coins\",\r\n    upgType: \"HM\",\r\n    effectType: \"mp_value\",\r\n    icon: \"sc_upg_icons/mp_val_hm.webp\",\r\n    requiresUnlockXp: true,\r\n    scalingPreset: 'HM',\r\n    costAtLevel(level) { return costAtLevelUsingScaling(this, level); },\r\n    nextCostAfter(_, nextLevel) { return costAtLevelUsingScaling(this, nextLevel); },\r\n    computeLockState: determineLockState,\r\n    effectSummary(level) {\r\n      const lvlBn = ensureLevelBigNum(level);\r\n      let baseMult;\r\n      try { baseMult = this.effectMultiplier(lvlBn); }\r\n      catch { baseMult = 1; }\r\n      const { selfMult } = computeHmMultipliers(this, lvlBn, this.area);\r\n      const total = safeMultiplyBigNum(baseMult, selfMult);\r\n      return `MP value bonus: ${formatMultForUi(total)}x`;\r\n    },\r\n    effectMultiplier: E.powPerLevel(1.1),\r\n  },\r\n  {\r\n    area: AREA_KEYS.STARTER_COVE,\r\n    id: 19,\r\n    tie: UPGRADE_TIES.UNLOCK_SURGE,\r\n    title: \"Unlock Surge\",\r\n    desc: \"Unlocks the Surge reset\",\r\n    lvlCap: 1,\r\n    upgType: \"NM\",\r\n    icon: \"\",\r\n    baseIconOverride: \"img/misc/surge_plus_base.webp\",\r\n    requiresUnlockXp: true,\r\n    revealRequirement: 'Reach XP Level 201 to reveal this upgrade',\r\n    unlockUpgrade: true,\r\n    costAtLevel() { return BigNum.fromInt(0); },\r\n    nextCostAfter() { return BigNum.fromInt(0); },\r\n    computeLockState: determineLockState,\r\n    onLevelChange({ newLevel }) {\r\n      if ((newLevel ?? 0) >= 1) {\r\n        try { onSurgeUpgradeUnlocked(); } catch {}\r\n      }\r\n    },\r\n  },\r\n  ...AUTOMATION_REGISTRY,\r\n\r\n];\r\nfor (const upg of REGISTRY) {\r\n  const tieKey = normalizeUpgradeTie(upg.tie ?? upg.tieKey);\r\n  if (tieKey && !upgradeTieLookup.has(tieKey)) {\r\n    upgradeTieLookup.set(tieKey, upg);\r\n  }\r\n  upg.baseCost = toUpgradeBigNum(upg.baseCost ?? 0, 0);\r\n  upg.baseCostBn = upg.baseCost;\r\n  upg.numUpgEvolutions = normalizeHmEvolutionCount(upg.numUpgEvolutions);\r\n  if (upg.upgType === 'HM') {\r\n    applyHmEvolutionMeta(upg, upg.numUpgEvolutions);\r\n  } else {\r\n    upg.lvlCapBn = toUpgradeBigNum(upg.lvlCap ?? Infinity, Infinity);\r\n    upg.lvlCap = levelCapToNumber(upg.lvlCapBn);\r\n    upg.lvlCapFmtHtml = formatBigNumAsHtml(upg.lvlCapBn);\r\n    upg.lvlCapFmtText = formatBigNumAsPlain(upg.lvlCapBn);\r\n  }\r\n\r\n  upg.bulkMeta = computeBulkMeta(upg);\r\n  ensureUpgradeScaling(upg);\r\n}\r\n\r\nconst areaStatePayloadCache = new Map(); // key \u2192 last serialized payload\r\nconst areaStateMemoryCache = new Map(); // key \u2192 last parsed array reference\r\nconst upgradeStateCache = new Map(); // key \u2192 { areaKey, upgId, upg, rec, arr, lvl, nextCostBn }\r\nconst areaUpgradeOrderCache = new Map();\r\n\r\nfunction getAreaUpgradeOrder(areaKey) {\r\n  const normalizedArea = normalizeAreaKey(areaKey);\r\n  if (!normalizedArea) return null;\r\n\r\n  if (areaUpgradeOrderCache.has(normalizedArea)) {\r\n    return areaUpgradeOrderCache.get(normalizedArea);\r\n  }\r\n\r\n  const order = new Map();\r\n  let rank = 0;\r\n  for (const upg of REGISTRY) {\r\n    if (normalizeAreaKey(upg?.area) !== normalizedArea) continue;\r\n    const normalizedId = normalizeUpgradeId(upg?.id);\r\n    if (normalizedId == null || order.has(normalizedId)) continue;\r\n    order.set(normalizedId, rank);\r\n    rank += 1;\r\n  }\r\n\r\n  areaUpgradeOrderCache.set(normalizedArea, order);\r\n  return order;\r\n}\r\n\r\nfunction normalizeAreaStateRecordOrder(areaKey, arr) {\r\n  if (!Array.isArray(arr) || arr.length <= 1) return false;\r\n  const order = getAreaUpgradeOrder(areaKey);\r\n  if (!(order?.size)) return false;\r\n\r\n  const baseRank = order.size;\r\n  const entries = arr.map((rec, idx) => {\r\n    const normalizedId = normalizeUpgradeId(rec?.id);\r\n    const rank = order.has(normalizedId)\r\n      ? order.get(normalizedId)\r\n      : baseRank + idx;\r\n    return { rec, rank, idx };\r\n  });\r\n\r\n  let needsSort = false;\r\n  for (let i = 1; i < entries.length; i += 1) {\r\n    const prev = entries[i - 1];\r\n    const curr = entries[i];\r\n    if (curr.rank < prev.rank || (curr.rank === prev.rank && curr.idx < prev.idx)) {\r\n      needsSort = true;\r\n      break;\r\n    }\r\n  }\r\n\r\n  if (!needsSort) return false;\r\n\r\n  entries.sort((a, b) => (a.rank - b.rank) || (a.idx - b.idx));\r\n  arr.length = 0;\r\n  for (const entry of entries) arr.push(entry.rec);\r\n  return true;\r\n}\r\n\r\nfunction parseUpgradeStateArray(raw) {\r\n  if (typeof raw !== 'string' || !raw) return null;\r\n  if (raw.length > 1_000_000) return null;\r\n  try {\r\n    const parsed = JSON.parse(raw);\r\n    return Array.isArray(parsed) ? parsed : null;\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\nfunction readStateFromAvailableStorage(key, options = {}) {\r\n  const {\r\n    includeLocal = true,\r\n  } = options || {};\r\n\r\n  const result = {\r\n    data: null,\r\n    raw: null,\r\n    storageChecked: false,\r\n    storageFound: false,\r\n    checkedLocal: false,\r\n    foundLocal: false,\r\n    sourceType: null,\r\n  };\r\n\r\n  if (!key) return result;\r\n\r\n  const storages = [];\r\n  try {\r\n    if (includeLocal && typeof localStorage !== 'undefined') {\r\n      storages.push({ storage: localStorage, type: 'local' });\r\n      result.storageChecked = true;\r\n      result.checkedLocal = true;\r\n    }\r\n  } catch {}\r\n\r\n  for (const entry of storages) {\r\n    const { storage, type } = entry || {};\r\n    const getItem = storage?.getItem;\r\n    if (typeof getItem !== 'function') continue;\r\n    let raw;\r\n    try { raw = getItem.call(storage, key); }\r\n    catch { raw = null; }\r\n    if (raw != null) {\r\n      result.storageFound = true;\r\n      if (type === 'local') result.foundLocal = true;\r\n    }\r\n    const parsed = parseUpgradeStateArray(raw);\r\n    if (parsed) {\r\n      const payload = typeof raw === 'string' && raw ? raw : (() => {\r\n        try { return JSON.stringify(parsed); } catch { return null; }\r\n      })();\r\n      result.data = parsed;\r\n      result.raw = payload;\r\n      result.sourceType = type;\r\n      return result;\r\n    }\r\n  }\r\n\r\n  return result;\r\n}\r\n\r\nfunction cacheAreaState(key, arr, raw) {\r\n  if (!key) return;\r\n  if (Array.isArray(arr)) {\r\n    areaStateMemoryCache.set(key, arr);\r\n  }\r\n  if (typeof raw === 'string') {\r\n    areaStatePayloadCache.set(key, raw);\r\n  }\r\n}\r\n\r\nfunction clearCachedAreaState(storageKey) {\r\n  if (!storageKey) return;\r\n  areaStateMemoryCache.delete(storageKey);\r\n  areaStatePayloadCache.delete(storageKey);\r\n}\r\n\r\nfunction clearCachedUpgradeStates(areaKey, slot) {\r\n  const slotKey = slot == null ? 'null' : String(slot);\r\n  const prefix = `${slotKey}:${areaKey}:`;\r\n  for (const key of upgradeStateCache.keys()) {\r\n    if (key.startsWith(prefix)) {\r\n      upgradeStateCache.delete(key);\r\n    }\r\n  }\r\n}\r\n\r\nfunction keyForArea(areaKey, slot = getActiveSlot()) {\r\n  if (slot == null) return null;\r\n  return `ccc:upgrades:${areaKey}:${slot}`;\r\n}\r\n\r\nexport function getUpgradeStorageKey(areaKey, upgId, slot = getActiveSlot()) {\r\n    if (slot == null) return null;\r\n    const normalizedArea = normalizeAreaKey(areaKey);\r\n    const resolvedId = resolveUpgradeIdentifier(areaKey, upgId);\r\n    if (!normalizedArea || resolvedId == null) return null;\r\n    return `ccc:upgrades:${normalizedArea}:${resolvedId}:${slot}`;\r\n}\r\n\r\nconst upgradeStorageWatcherCleanup = new Map();\r\nlet upgradeStorageWatcherBoundSlot = null;\r\n\r\nfunction cleanupUpgradeStorageWatchers() {\r\n  upgradeStorageWatcherCleanup.forEach((stop) => {\r\n    try { stop?.(); } catch {}\r\n  });\r\n  upgradeStorageWatcherCleanup.clear();\r\n}\r\n\r\nfunction handleUpgradeStorageChange(areaKey, slot, storageKey, rawPayload, meta = {}) {\r\n    // In the new system, listeners on individual keys would be too expensive/complex to maintain\r\n    // for every single upgrade. We rely on the game loop and events.\r\n    // However, if we need to detect external changes (e.g. other tabs), we might just\r\n    // broadcast a generic change event.\r\n    clearCachedUpgradeStates(areaKey, slot);\r\n    notifyChanged();\r\n}\r\n\r\nfunction bindUpgradeStorageWatchersForSlot(slot) {\r\n  // Deprecated: We don't watch hundreds of individual keys.\r\n  // Reliance is on in-memory state and explicit events.\r\n  // If multi-tab sync is required, we can revisit a more sophisticated strategy.\r\n  cleanupUpgradeStorageWatchers();\r\n}\r\n\r\nif (typeof window !== 'undefined') {\r\n  bindUpgradeStorageWatchersForSlot(getActiveSlot());\r\n  window.addEventListener('saveSlot:change', () => {\r\n    bindUpgradeStorageWatchersForSlot(getActiveSlot());\r\n    notifyChanged();\r\n  });\r\n}\r\n\r\nfunction migrateLegacyStorage(areaKey, slot) {\r\n    if (typeof localStorage === 'undefined') return;\r\n    const legacyKey = keyForArea(areaKey, slot);\r\n    const raw = localStorage.getItem(legacyKey);\r\n    if (!raw) return;\r\n\r\n    try {\r\n        const arr = JSON.parse(raw);\r\n        if (Array.isArray(arr)) {\r\n            let migratedCount = 0;\r\n            arr.forEach(rec => {\r\n                if (rec && rec.id != null) {\r\n                    const key = getUpgradeStorageKey(areaKey, rec.id, slot);\r\n                    if (key) {\r\n                        // Only write if individual key doesn't exist to prevent overwriting\r\n                        // if migration ran partially before.\r\n                        if (localStorage.getItem(key) === null) {\r\n                            localStorage.setItem(key, JSON.stringify(rec));\r\n                            migratedCount++;\r\n                        }\r\n                    }\r\n                }\r\n            });\r\n            console.log(`[UpgradeMigration] Migrated ${migratedCount} upgrades for area ${areaKey} slot ${slot}`);\r\n        }\r\n    } catch (e) {\r\n        console.warn('Failed to migrate legacy upgrade storage', e);\r\n    }\r\n\r\n    // Rename legacy key to .bak or delete\r\n    try {\r\n        localStorage.removeItem(legacyKey);\r\n        localStorage.removeItem(`${legacyKey}:backup`);\r\n    } catch {}\r\n}\r\n\r\nfunction loadUpgradeFromStorage(areaKey, upgId, slot) {\r\n    migrateLegacyStorage(areaKey, slot);\r\n    const key = getUpgradeStorageKey(areaKey, upgId, slot);\r\n    if (!key) return null;\r\n\r\n    if (isBatching && pendingUpgradeSaves.has(key)) {\r\n        try {\r\n            const pending = pendingUpgradeSaves.get(key);\r\n            if (pending?.state) {\r\n                return JSON.parse(JSON.stringify(pending.state));\r\n            }\r\n        } catch {}\r\n    }\r\n\r\n    if (deferredWrites.has(key)) {\r\n        try {\r\n            const deferred = deferredWrites.get(key);\r\n            if (deferred?.state) {\r\n                return JSON.parse(JSON.stringify(deferred.state));\r\n            }\r\n        } catch {}\r\n    }\r\n\r\n    try {\r\n        const raw = localStorage.getItem(key);\r\n        return raw ? JSON.parse(raw) : null;\r\n    } catch {\r\n        return null;\r\n    }\r\n}\r\n\r\nfunction loadAreaState(areaKey, slot = getActiveSlot(), options = {}) {\r\n  const { forceReload = false } = options || {};\r\n  // For compatibility, we return an array of all upgrade states for the area.\r\n  // This function now eagerly reads all individual keys.\r\n  \r\n  migrateLegacyStorage(areaKey, slot);\r\n\r\n  const upgrades = getUpgradesForArea(areaKey);\r\n  const arr = [];\r\n\r\n  upgrades.forEach(upg => {\r\n      const rec = loadUpgradeFromStorage(areaKey, upg.id, slot);\r\n      if (rec) {\r\n          // Ensure ID is correct\r\n          rec.id = normalizeUpgradeId(upg.id);\r\n          arr.push(rec);\r\n      }\r\n  });\r\n\r\n  // Cache is less relevant for the \"whole area array\" concept now,\r\n  // but we can still populate it to satisfy ensureUpgradeState's expected finding logic\r\n  // if we want to keep ensuring 'arr' exists.\r\n  const storageKey = keyForArea(areaKey, slot); // virtual key for cache\r\n  if (storageKey) {\r\n      cacheAreaState(storageKey, arr, JSON.stringify(arr));\r\n  }\r\n\r\n  return arr;\r\n}\r\n\r\nfunction saveUpgradeState(areaKey, upgId, state, slot = getActiveSlot(), options = {}) {\r\n    const key = getUpgradeStorageKey(areaKey, upgId, slot);\r\n    if (!key) return;\r\n    \r\n    if (isBatching) {\r\n        pendingUpgradeSaves.set(key, { areaKey, upgId, state, slot });\r\n        return;\r\n    }\r\n\r\n    if (options && options.deferSave) {\r\n        deferredWrites.set(key, { areaKey, upgId, state, slot });\r\n        return;\r\n    }\r\n\r\n    try {\r\n        const payload = JSON.stringify(state);\r\n        localStorage.setItem(key, payload);\r\n        try { primeStorageWatcherSnapshot(key, payload); } catch {}\r\n    } catch (e) {\r\n        console.warn('Failed to save upgrade state', areaKey, upgId, e);\r\n    }\r\n}\r\n\r\nfunction saveAreaState(areaKey, stateArr, slot = getActiveSlot()) {\r\n  // Deprecated: Loops and saves individual upgrades\r\n  if (!Array.isArray(stateArr)) return;\r\n  stateArr.forEach(rec => {\r\n      if (rec && rec.id != null) {\r\n          saveUpgradeState(areaKey, rec.id, rec, slot);\r\n      }\r\n  });\r\n}\r\n\r\nfunction resolveUpgradeIdentifier(areaKey, upgId) {\r\n  if (upgId && typeof upgId === 'object' && typeof upgId.id !== 'undefined') {\r\n    return normalizeUpgradeId(upgId.id);\r\n  }\r\n  const normalized = normalizeUpgradeId(upgId);\r\n  if (typeof normalized === 'number' || normalized == null) {\r\n    return normalized;\r\n  }\r\n  if (typeof normalized === 'string') {\r\n    const tieKey = normalizeUpgradeTie(normalized);\r\n    if (tieKey) {\r\n      const upg = upgradeTieLookup.get(tieKey);\r\n      if (upg) {\r\n        const requestedArea = normalizeAreaKey(areaKey);\r\n        if (!requestedArea || normalizeAreaKey(upg.area) === requestedArea) {\r\n          return normalizeUpgradeId(upg.id);\r\n        }\r\n      }\r\n    }\r\n  }\r\n  return normalized;\r\n}\r\n\r\nfunction upgradeCacheKey(areaKey, upgId, slot = getActiveSlot()) {\r\n  const slotKey = slot == null ? 'null' : String(slot);\r\n  const resolvedId = resolveUpgradeIdentifier(areaKey, upgId);\r\n  return `${slotKey}:${areaKey}:${normalizeUpgradeId(resolvedId)}`;\r\n}\r\n\r\nfunction ensureUpgradeState(areaKey, upgId) {\r\n  const resolvedId = resolveUpgradeIdentifier(areaKey, upgId);\r\n  const normalizedId = normalizeUpgradeId(resolvedId);\r\n  const slot = getActiveSlot();\r\n  const key = upgradeCacheKey(areaKey, normalizedId, slot);\r\n  let state = upgradeStateCache.get(key);\r\n  if (state) return state;\r\n\r\n  const upg = getUpgrade(areaKey, normalizedId);\r\n  // We can try to load just this specific upgrade first\r\n  let rec = loadUpgradeFromStorage(areaKey, normalizedId, slot);\r\n  \r\n  // If we found it, great. If not, it might be because loadAreaState hasn't run yet to migrate?\r\n  // But migrateLegacyStorage handles key conversion.\r\n  // For safety, we can fall back to array load, but loadAreaState now just calls loadUpgradeFromStorage iteratively anyway.\r\n  \r\n  let recNeedsSave = false;\r\n  if (!rec) {\r\n    // Migration check implicit in loadAreaState or we can run it here for this area if totally missing?\r\n    // Let's assume loadAreaState runs on init. If we access an upgrade, it should exist if persisted.\r\n    // If not, it's new.\r\n    rec = { id: normalizedId, lvl: BigNum.fromInt(0).toStorage() };\r\n    if (upg) {\r\n      try {\r\n        rec.nextCost = BigNum.fromAny(upg.costAtLevel(0)).toStorage();\r\n      } catch {\r\n        rec.nextCost = BigNum.fromInt(0).toStorage();\r\n      }\r\n    }\r\n    rec.nextCostLvl = rec.lvl;\r\n    saveUpgradeState(areaKey, normalizedId, rec, slot);\r\n  } else if (rec.id !== normalizedId) {\r\n    rec.id = normalizedId;\r\n    recNeedsSave = true;\r\n  }\r\n\r\n  const prevLvlStorage = rec.lvl;\r\n  const prevNextCost = rec.nextCost;\r\n  const prevNextCostLvl = rec.nextCostLvl;\r\n  rec.lvl = sanitizeStoredLevelValue(rec.lvl);\r\n  rec.nextCost = sanitizeStoredLevelValue(rec.nextCost, { allowEmpty: true });\r\n  rec.nextCostLvl = sanitizeStoredLevelValue(rec.nextCostLvl, { allowEmpty: true });\r\n  if (\r\n    rec.lvl !== prevLvlStorage\r\n    || rec.nextCost !== prevNextCost\r\n    || rec.nextCostLvl !== prevNextCostLvl\r\n  ) {\r\n    recNeedsSave = true;\r\n  }\r\n\r\n  let hmEvolutions = 0;\r\n  if (upg?.upgType === 'HM') {\r\n    hmEvolutions = normalizeHmEvolutionCount(\r\n      rec.hmEvolutions ?? rec.evolutions ?? rec.evol ?? upg.numUpgEvolutions\r\n    );\r\n    applyHmEvolutionMeta(upg, hmEvolutions);\r\n  }\r\n\r\n  const lvlBn = ensureLevelBigNum(rec.lvl);\r\n  let lvl = levelBigNumToNumber(lvlBn);\r\ntry {\r\n  const capBn = upg?.lvlCapBn ?? BigNum.fromAny('Infinity');\r\n  if (!(capBn.isInfinite?.()) && lvlBn.cmp(capBn) > 0) {\r\n    const clamped = capBn.clone?.() ?? capBn;\r\n    lvl = levelBigNumToNumber(clamped);\r\n    const clampedStorage = clamped.toStorage();\r\n    rec.lvl = clampedStorage;\r\n    rec.nextCost = BigNum.fromInt(0).toStorage();\r\n    rec.nextCostLvl = clampedStorage;\r\n    saveUpgradeState(areaKey, normalizedId, rec, slot);\r\n  }\r\n} catch {}\r\n\r\n  let normalizedLvlStorage = null;\r\n  try {\r\n    normalizedLvlStorage = lvlBn?.toStorage?.() ?? ensureLevelBigNum(lvl).toStorage();\r\n  } catch {}\r\n  if (normalizedLvlStorage && rec.lvl !== normalizedLvlStorage) {\r\n    rec.lvl = normalizedLvlStorage;\r\n    recNeedsSave = true;\r\n  }\r\n\r\n  const costLevelStorage = typeof rec.nextCostLvl === 'string' ? rec.nextCostLvl : null;\r\n  let nextCostStale = !costLevelStorage || costLevelStorage !== normalizedLvlStorage;\r\n\r\n  let nextCostBn = null;\r\n  if (!nextCostStale && rec.nextCost != null) {\r\n    try {\r\n      nextCostBn = BigNum.fromAny(rec.nextCost);\r\n    } catch {\r\n      nextCostBn = null;\r\n      nextCostStale = true;\r\n    }\r\n  }\r\n\r\n  if (!nextCostBn || nextCostStale) {\r\n    if (upg) {\r\n      try {\r\n        nextCostBn = BigNum.fromAny(upg.costAtLevel(lvl));\r\n      } catch {\r\n        nextCostBn = BigNum.fromInt(0);\r\n      }\r\n    } else {\r\n      nextCostBn = BigNum.fromInt(0);\r\n    }\r\n    try {\r\n      rec.nextCost = nextCostBn.toStorage();\r\n      if (normalizedLvlStorage) {\r\n        rec.nextCostLvl = normalizedLvlStorage;\r\n      } else {\r\n        delete rec.nextCostLvl;\r\n      }\r\n      recNeedsSave = true;\r\n    } catch {}\r\n  }\r\n\r\n  if (recNeedsSave) {\r\n    try { saveUpgradeState(areaKey, normalizedId, rec, slot); }\r\n    catch {}\r\n  }\r\n\r\n  if (upg?.upgType === 'HM' && lvlBn?.isInfinite?.()) {\r\n    if (!upg.lvlCapBn?.isInfinite?.()) {\r\n      const infCap = BigNum.fromAny('Infinity');\r\n      upg.lvlCapBn = infCap;\r\n      upg.lvlCap = Number.POSITIVE_INFINITY;\r\n      upg.lvlCapFmtHtml = formatBigNumAsHtml(infCap);\r\n      upg.lvlCapFmtText = formatBigNumAsPlain(infCap);\r\n    }\r\n  }\r\n\r\n  // We no longer strictly maintain 'arr' in state, but we can pass an empty [] or null\r\n  // since most consumers should look at 'rec'.\r\n  state = { areaKey, upgId: normalizedId, upg, rec, arr: [], lvl, lvlBn, nextCostBn, slot, hmEvolutions };\r\n  upgradeStateCache.set(key, state);\r\n  return state;\r\n}\r\n\r\nfunction commitUpgradeState(state, options = {}) {\r\n  if (!state) return;\r\n  const { areaKey } = state;\r\n  const slot = state.slot ?? getActiveSlot();\r\n  if (!areaKey || slot == null) return;\r\n\r\n  const normalizedId = normalizeUpgradeId(state.upgId ?? state.rec?.id);\r\n  // We do NOT reload the whole area here. We work on the cached rec.\r\n  \r\n  let rec = state.rec;\r\n  if (!rec) {\r\n      rec = { id: normalizedId };\r\n      state.rec = rec;\r\n  }\r\n\r\ntry {\r\n  const capBn = state.upg?.lvlCapBn ?? BigNum.fromAny('Infinity');\r\n  let inBn = state.lvlBn?.clone?.() ?? ensureLevelBigNum(state.lvlBn ?? state.lvl);\r\n  if (!(capBn.isInfinite?.()) && inBn.cmp(capBn) > 0) {\r\n    inBn = capBn.clone?.() ?? capBn;\r\n    state.lvlBn = inBn;\r\n    state.lvl = levelBigNumToNumber(inBn);\r\n  }\r\n} catch {}\r\n\r\n  try {\r\n    rec.lvl = state.lvlBn?.toStorage?.() ?? ensureLevelBigNum(state.lvlBn ?? state.lvl).toStorage();\r\n  } catch {\r\n    rec.lvl = ensureLevelBigNum(state.lvl ?? 0).toStorage();\r\n  }\r\n  rec.lvl = sanitizeStoredLevelValue(rec.lvl);\r\n  const currentLvlStorage = rec.lvl;\r\n\r\n  if (state.nextCostBn != null) {\r\n    try {\r\n      rec.nextCost = BigNum.fromAny(state.nextCostBn).toStorage();\r\n    } catch {\r\n      try { rec.nextCost = BigNum.fromAny(state.nextCostBn ?? 0).toStorage(); }\r\n      catch { rec.nextCost = BigNum.fromInt(0).toStorage(); }\r\n    }\r\n    rec.nextCost = sanitizeStoredLevelValue(rec.nextCost, { allowEmpty: true });\r\n    rec.nextCostLvl = currentLvlStorage;\r\n  } else {\r\n    delete rec.nextCostLvl;\r\n  }\r\n\r\n  if (state.hmEvolutions != null) {\r\n    rec.hmEvolutions = normalizeHmEvolutionCount(state.hmEvolutions);\r\n  }\r\n\r\n  saveUpgradeState(areaKey, normalizedId, rec, slot, options);\r\n  state.slot = slot;\r\n}\r\n\r\nfunction invalidateUpgradeState(areaKey, upgId, slot = getActiveSlot()) {\r\n  upgradeStateCache.delete(upgradeCacheKey(areaKey, upgId, slot));\r\n}\r\n\r\nexport function getLevelNumber(areaKey, upgId) {\r\n  return ensureUpgradeState(areaKey, upgId).lvl;\r\n}\r\n\r\nexport function getHmEvolutions(areaKey, upgId) {\r\n  return ensureUpgradeState(areaKey, upgId).hmEvolutions ?? 0;\r\n}\r\n\r\n\r\nexport function getMpValueMultiplierBn() {\r\n  try {\r\n    const { mpValue } = calculateUpgradeMultipliers(AREA_KEYS.STARTER_COVE);\r\n    return mpValue;\r\n  } catch {\r\n    return BigNum.fromInt(1);\r\n  }\r\n}\r\nexport function getMagnetLevel() {\r\n  try {\r\n    const { magnetRadius } = calculateUpgradeMultipliers(AREA_KEYS.STARTER_COVE);\r\n    return magnetRadius || 0;\r\n  } catch {\r\n    return 0;\r\n  }\r\n}\r\n\r\nfunction computeUpgradeLockStateFor(areaKey, upg) {\r\n  if (!upg) return { locked: false };\r\n\r\n  const xpUnlocked = safeIsXpUnlocked();\r\n  const xpLevelBn = xpUnlocked ? currentXpLevelBigNum() : BigNum.fromInt(0);\r\n  const xpLevel = xpUnlocked ? levelBigNumToNumber(xpLevelBn) : 0;\r\n\r\n  let baseState = { locked: false };\r\nif (upg.requiresUnlockXp && !xpUnlocked) {\r\n  const isXpAdj = isXpAdjacentUpgrade(areaKey, upg);\r\n  const xpRevealText = 'Unlock the XP system to reveal this upgrade';\r\n  const unlockXpVisible = safeHasMetMerchant();\r\n\r\n  if (isXpAdj) {\r\n    if (!unlockXpVisible) {\r\n      const meetText = 'Meet the Merchant to reveal \"Unlock XP\"';\r\n      baseState = {\r\n        locked: true,\r\n        iconOverride: LOCKED_UPGRADE_ICON_DATA_URL,\r\n        titleOverride: LOCKED_UPGRADE_TITLE,\r\n        descOverride: meetText,\r\n        reason: meetText,\r\n        hidden: false,\r\n        hideCost: false,\r\n        hideEffect: false,\r\n        useLockedBase: true,\r\n      };\r\n    } else {\r\n      baseState = {\r\n        locked: true,\r\n        iconOverride: MYSTERIOUS_UPGRADE_ICON_DATA_URL,\r\n        titleOverride: HIDDEN_UPGRADE_TITLE,\r\n        descOverride: xpRevealText,\r\n        reason: xpRevealText,\r\n        hidden: true,\r\n        hideCost: true,\r\n        hideEffect: true,\r\n        useLockedBase: true,\r\n      };\r\n    }\r\n  } else {\r\n    baseState = {\r\n      locked: true,\r\n      iconOverride: LOCKED_UPGRADE_ICON_DATA_URL,\r\n      titleOverride: LOCKED_UPGRADE_TITLE,\r\n      descOverride: xpRevealText,\r\n      reason: 'Purchase \"Unlock XP\" to reveal this upgrade',\r\n      hidden: false,\r\n      hideCost: false,\r\n      hideEffect: false,\r\n      useLockedBase: true,\r\n    };\r\n  }\r\n}\r\n\r\n  let state = mergeLockStates({ locked: false }, baseState);\r\n  if (typeof upg.computeLockState === 'function') {\r\n    try {\r\n      const ctx = {\r\n        areaKey,\r\n        upg,\r\n        xpUnlocked,\r\n        xpLevelBn,\r\n        xpLevel,\r\n        baseLocked: state.locked,\r\n        getUpgradeLevel(targetId) { return getLevelNumber(areaKey, targetId); },\r\n      };\r\n      const custom = upg.computeLockState(ctx);\r\n      state = mergeLockStates(state, custom);\r\n    } catch {}\r\n  }\r\n\r\n  const slot = getActiveSlot();\r\n  const revealKey = upgradeRevealKey(areaKey, upg);\r\n  const permaUnlocked = revealKey ? isUpgradePermanentlyUnlocked(areaKey, upg, slot) : false;\r\n  if (revealKey) {\r\n    const revealState = ensureShopRevealState(slot);\r\n    const permaState  = ensureShopPermaUnlockState(slot);\r\n    const permaMystState = ensureShopPermaMystState(slot);\r\n    const hyphenKey   = revealKey.replace(/_/g, '-');\r\n    const legacyKey   = upgradeLegacyRevealKey(areaKey, upg);\r\n\r\n    let needsRevealSave = false;\r\n    if (migrateUpgradeStateKey(revealState, hyphenKey, revealKey)) {\r\n      needsRevealSave = true;\r\n    }\r\n    if (legacyKey && migrateUpgradeStateKey(revealState, legacyKey, revealKey)) {\r\n      needsRevealSave = true;\r\n    }\r\n    if (needsRevealSave) {\r\n      saveShopRevealState(revealState, slot);\r\n    }\r\n\r\n    let needsPermaSave = false;\r\n    if (migrateUpgradeStateKey(permaState, hyphenKey, revealKey)) {\r\n      needsPermaSave = true;\r\n    }\r\n    if (legacyKey && migrateUpgradeStateKey(permaState, legacyKey, revealKey)) {\r\n      needsPermaSave = true;\r\n    }\r\n    if (needsPermaSave) {\r\n      saveShopPermaUnlockState(permaState, slot);\r\n    }\r\n\r\n    let needsPermaMystSave = false;\r\n    if (migrateUpgradeStateKey(permaMystState, hyphenKey, revealKey)) {\r\n      needsPermaMystSave = true;\r\n    }\r\n    if (legacyKey && migrateUpgradeStateKey(permaMystState, legacyKey, revealKey)) {\r\n      needsPermaMystSave = true;\r\n    }\r\n    if (needsPermaMystSave) {\r\n      saveShopPermaMystState(permaMystState, slot);\r\n    }\r\n  }\r\n\r\n  if (state.locked) {\r\n    const hiddenState = !!state.hidden;\r\n    if (!state.iconOverride) state.iconOverride = LOCKED_UPGRADE_ICON_DATA_URL;\r\n\r\n    if (hiddenState) {\r\n      if (!state.titleOverride) state.titleOverride = HIDDEN_UPGRADE_TITLE;\r\n    } else if (!state.titleOverride || state.titleOverride === HIDDEN_UPGRADE_TITLE) {\r\n      state.titleOverride = LOCKED_UPGRADE_TITLE;\r\n    }\r\n\r\n    if (state.useLockedBase == null) state.useLockedBase = true;\r\n    if (!state.reason && upg?.revealRequirement) state.reason = upg.revealRequirement;\r\n\r\n    if (!state.descOverride) {\r\n      if (state.reason) {\r\n        state.descOverride = `${state.reason}`;\r\n      } else if (upg?.revealRequirement) {\r\n        state.descOverride = upg.revealRequirement;\r\n      } else if (hiddenState) {\r\n        state.descOverride = 'This upgrade is currently hidden.';\r\n      }\r\n    }\r\n  } else {\r\n    state.hidden = false;\r\n    state.hideCost = false;\r\n    state.hideEffect = false;\r\n    state.useLockedBase = false;\r\n    if (state.iconOverride === LOCKED_UPGRADE_ICON_DATA_URL ||\r\n        state.iconOverride === MYSTERIOUS_UPGRADE_ICON_DATA_URL) {\r\n      delete state.iconOverride;\r\n    }\r\n    if (state.titleOverride === HIDDEN_UPGRADE_TITLE ||\r\n        state.titleOverride === LOCKED_UPGRADE_TITLE) {\r\n      delete state.titleOverride;\r\n    }\r\n    delete state.descOverride;\r\n    delete state.reason;\r\n  }\r\n\r\n  if (state.locked && upg.requiresUnlockXp && !xpUnlocked && !state.iconOverride) {\r\n    state.iconOverride = LOCKED_UPGRADE_ICON_DATA_URL;\r\n  }\r\n\r\n  if (revealKey) {\r\n    const revealState = ensureShopRevealState(slot);\r\n    const rec = revealState.upgrades[revealKey] || {};\r\n    const tieKey = normalizeUpgradeTie(upg?.tie ?? upg?.tieKey);\r\n    const isForgePlaceholder = tieKey && FORGE_PLACEHOLDER_TIES.has(tieKey);\r\n    const isInfusePlaceholder = tieKey && INFUSE_PLACEHOLDER_TIES.has(tieKey);\r\n\r\n    let storedStatus = rec.status || 'locked';\r\n\r\n    if (isUpgradePermanentlyUnlocked(areaKey, upg, slot)) {\r\n      storedStatus = 'unlocked';\r\n    } else if (\r\n      isUpgradePermanentlyMysterious(areaKey, upg, slot) &&\r\n      storedStatus === 'locked'\r\n    ) {\r\n      let xpReached31 = false;\r\n      try { xpReached31 = levelBigNumToNumber(currentXpLevelBigNum()) >= 31; } catch {}\r\n      let xpReached101 = false;\r\n      try { xpReached101 = levelBigNumToNumber(currentXpLevelBigNum()) >= 101; } catch {}\r\n\r\n      if (isForgePlaceholder && !xpReached31) {\r\n        storedStatus = 'locked';\r\n      } else if (isInfusePlaceholder && !xpReached101) {\r\n        storedStatus = 'locked';\r\n      } else {\r\n        storedStatus = 'mysterious';\r\n      }\r\n    }\r\n\r\n    let storedRank = shopStatusRank(storedStatus);\r\n\r\n    let currentStatus = classifyUpgradeStatus(state);\r\n    let currentRank = shopStatusRank(currentStatus);\r\n\r\n    const applyStoredMysterious = () => {\r\n      state.locked = true;\r\n\r\n      const snap = rec.snapshot;\r\n      if (snap && typeof snap === 'object') {\r\n        state = mergeLockStates(state, snap);\r\n      }\r\n\r\n      state.iconOverride  = MYSTERIOUS_UPGRADE_ICON_DATA_URL;\r\n      state.titleOverride = HIDDEN_UPGRADE_TITLE;\r\n\r\n      const reasonText =\r\n        upg?.revealRequirement ||\r\n        state.reason ||\r\n        state.descOverride ||\r\n        'This upgrade is currently hidden.';\r\n      state.descOverride = reasonText;\r\n      if (!state.reason && upg?.revealRequirement) state.reason = upg.revealRequirement;\r\n\r\n      state.hidden      = true;\r\n      state.hideCost    = true;\r\n      state.hideEffect  = true;\r\n      state.useLockedBase = true;\r\n    };\r\n\r\n    if (storedRank > currentRank) {\r\n      if (storedStatus === 'unlocked') {\r\n        state.locked = false;\r\n        state.hidden = false;\r\n        state.hideCost = false;\r\n        state.hideEffect = false;\r\n        state.useLockedBase = false;\r\n      } else if (storedStatus === 'mysterious') {\r\n        applyStoredMysterious();\r\n      }\r\n      currentStatus = classifyUpgradeStatus(state);\r\n      currentRank = shopStatusRank(currentStatus);\r\n    }\r\n\r\n    let shouldSave = false;\r\n    let normalizedStatus = (rec && typeof rec === 'object' && typeof rec.status === 'string')\r\n      ? rec.status\r\n      : 'locked';\r\n\r\n    const isForgePlaceholderForSave = isForgePlaceholder;\r\n\r\n    let xpReached31Now = false;\r\n    try { xpReached31Now = levelBigNumToNumber(currentXpLevelBigNum()) >= 31; } catch {}\r\n    let xpReached101Now = false;\r\n    try { xpReached101Now = levelBigNumToNumber(currentXpLevelBigNum()) >= 101; } catch {}\r\n\r\n    if (isForgePlaceholderForSave && !xpReached31Now && normalizedStatus === 'mysterious') {\r\n      normalizedStatus = 'locked';\r\n    } else if (isInfusePlaceholder && !xpReached101Now && normalizedStatus === 'mysterious') {\r\n      normalizedStatus = 'locked';\r\n    }\r\n\r\n    if (!rec || typeof rec !== 'object' || Object.keys(rec).length !== 1 || rec.status !== normalizedStatus) {\r\n      revealState.upgrades[revealKey] = { status: normalizedStatus };\r\n      shouldSave = true;\r\n    }\r\n\r\n    if (currentRank > storedRank) {\r\n      rec.status = currentStatus;\r\n      revealState.upgrades[revealKey] = { status: rec.status };\r\n      shouldSave = true;\r\n\r\n      storedStatus = currentStatus;\r\n      storedRank   = currentRank;\r\n\r\n      if (currentStatus === 'unlocked') {\r\n        markUpgradePermanentlyUnlocked(areaKey, upg, slot);\r\n      } else if (currentStatus === 'mysterious') {\r\n        let xpReached31 = false;\r\n        try { xpReached31 = levelBigNumToNumber(currentXpLevelBigNum()) >= 31; } catch {}\r\n\r\n        if (!isForgePlaceholder || xpReached31) {\r\n          markUpgradePermanentlyMysterious(areaKey, upg, slot);\r\n        }\r\n      }\r\n    }\r\n\r\n    if (storedStatus === 'unlocked') {\r\n      state.locked = false;\r\n      state.hidden = false;\r\n      state.hideCost = false;\r\n      state.hideEffect = false;\r\n      state.useLockedBase = false;\r\n\r\n      if (state.iconOverride === LOCKED_UPGRADE_ICON_DATA_URL ||\r\n          state.iconOverride === MYSTERIOUS_UPGRADE_ICON_DATA_URL) {\r\n        delete state.iconOverride;\r\n      }\r\n      if (state.titleOverride === HIDDEN_UPGRADE_TITLE ||\r\n          state.titleOverride === LOCKED_UPGRADE_TITLE) {\r\n        delete state.titleOverride;\r\n      }\r\n      delete state.descOverride;\r\n      delete state.reason;\r\n\r\n      if (rec.status !== 'unlocked') {\r\n        revealState.upgrades[revealKey] = { status: 'unlocked' };\r\n        shouldSave = true;\r\n      }\r\n      markUpgradePermanentlyUnlocked(areaKey, upg, slot);\r\n\r\n    } else if (storedStatus === 'mysterious' && currentStatus !== 'mysterious') {\r\n      applyStoredMysterious();\r\n      currentStatus = classifyUpgradeStatus(state);\r\n      currentRank = shopStatusRank(currentStatus);\r\n    }\r\n\r\n    if (shouldSave) saveShopRevealState(revealState, slot);\r\n  }\r\n  \r\n  return state;\r\n}\r\n\r\nfunction isUpgradeLocked(areaKey, upg) {\r\n  return !!computeUpgradeLockStateFor(areaKey, upg).locked;\r\n}\r\n\r\nfunction isHmReadyToEvolve(upg, lvlBn, evolutions = null) {\r\n  if (!upg || upg.upgType !== 'HM') return false;\r\n\r\n  // Once an HM upgrade reaches BN Infinity, treat it as permanently maxed\r\n  // and suppress further evolutions so the UI can show the maxed frame.\r\n  if (lvlBn?.isInfinite?.()) return false;\r\n  const safeEvol = Number.isFinite(evolutions)\r\n    ? evolutions\r\n    : activeEvolutionsForUpgrade(upg);\r\n  const { capBn, cap } = hmLevelCapForEvolutions(safeEvol);\r\n  try { return lvlBn?.cmp?.(capBn) >= 0; }\r\n  catch {}\r\n  const lvlNum = levelBigNumToNumber(lvlBn);\r\n  return Number.isFinite(lvlNum) && lvlNum >= cap;\r\n}\r\n\r\nexport function getLevel(areaKey, upgId) {\r\n  const state = ensureUpgradeState(areaKey, upgId);\r\n  if (state.lvlBn?.clone) return state.lvlBn.clone();\r\n  return ensureLevelBigNum(state.lvl ?? 0);\r\n}\r\n\r\nexport function peekNextPrice(areaKey, upgId) {\r\n  const state = ensureUpgradeState(areaKey, upgId);\r\n  const upg = state.upg;\r\n  if (!upg) return BigNum.fromInt(0);\r\n\r\n  if (state.nextCostBn && !state.nextCostBn.isZero?.()) {\r\n    return state.nextCostBn.clone?.() ?? BigNum.fromAny(state.nextCostBn);\r\n  }\r\n\r\n  const lvlBn  = state.lvlBn ?? ensureLevelBigNum(state.lvl ?? 0);\r\n  const currentNum = levelBigNumToNumber(lvlBn);\r\n  try {\r\n    return BigNum.fromAny(upg.costAtLevel(currentNum));\r\n  } catch {\r\n    return BigNum.fromInt(0);\r\n  }\r\n}\r\n\r\n\r\nexport function setLevel(areaKey, upgId, lvl, clampToCap = true, options = {}) {\r\n  const state = ensureUpgradeState(areaKey, upgId);\r\n  const upg = state.upg;\r\n  const { resetHmEvolutions = false } = options ?? {};\r\n\r\n  if (resetHmEvolutions && upg?.upgType === 'HM') {\r\n    state.hmEvolutions = 0;\r\n    applyHmEvolutionMeta(upg, 0);\r\n  }\r\n  const cap = upg?.lvlCap ?? Infinity;\r\n  const prevLevelNum = state.lvl;\r\n  const prevLevelBn = safeCloneBigNum(state.lvlBn ?? ensureLevelBigNum(state.lvl ?? 0));\r\n  let desiredBn = ensureLevelBigNum(lvl);\r\n  if (desiredBn.isInfinite?.()) {\r\n    desiredBn = BigNum.fromAny('Infinity');\r\n  }\r\n   let nextBn = desiredBn;\r\n  try {\r\n    if (upg && isInfinityLevelForScaled(upg, nextBn)) {\r\n      nextBn = BigNum.fromAny('Infinity');\r\n    }\r\n  } catch {}\r\n  if (clampToCap && Number.isFinite(cap)) {\r\n    const capBn = ensureLevelBigNum(cap);\r\n    if (nextBn.cmp(capBn) > 0) nextBn = capBn;\r\n  }\r\n  if (clampToCap && Number.isFinite(cap)) {\r\n    const capBn = ensureLevelBigNum(cap);\r\n    if (nextBn.cmp(capBn) > 0) nextBn = capBn;\r\n  }\r\n\r\n  if (state.lvlBn?.cmp && state.lvlBn.cmp(nextBn) === 0) return state.lvl;\r\n  const nextNum = levelBigNumToNumber(nextBn);\r\n\r\n  if (!upg) {\r\n    state.lvl = nextNum;\r\n    state.lvlBn = nextBn;\r\n    state.nextCostBn = BigNum.fromInt(0);\r\n    commitUpgradeState(state);\r\n    invalidateUpgradeState(areaKey, upgId);\r\n    notifyChanged();\r\n    return state.lvl;\r\n  }\r\n\r\n  state.lvl = nextNum;\r\n  state.lvlBn = nextBn;\r\n  try {\r\n    state.nextCostBn = BigNum.fromAny(upg.costAtLevel(nextNum));\r\n  } catch {\r\n    state.nextCostBn = BigNum.fromInt(0);\r\n  }\r\n\r\n  commitUpgradeState(state, { deferSave: options?.deferSave });\r\n  invalidateUpgradeState(areaKey, upgId);\r\n  emitUpgradeLevelChange(upg, prevLevelNum, prevLevelBn, state.lvl, state.lvlBn);\r\n  notifyChanged();\r\n  return state.lvl;\r\n}\r\n\r\n/* ---------------------------- Registry helpers ---------------------------- */\r\n\r\nexport function getUpgradesForArea(areaKey) {\r\n  return REGISTRY.filter(u => u.area === areaKey);\r\n}\r\n\r\nexport function getUpgrade(areaKey, upgId) {\r\n  const normalizedArea = normalizeAreaKey(areaKey);\r\n  const normalizedId = normalizeUpgradeId(upgId);\r\n  const tieKey = (typeof normalizedId === 'string')\r\n    ? normalizeUpgradeTie(normalizedId)\r\n    : normalizeUpgradeTie(upgId);\r\n  return REGISTRY.find((u) => {\r\n    if (normalizedArea && normalizeAreaKey(u.area) !== normalizedArea) return false;\r\n    if (normalizeUpgradeId(u.id) === normalizedId) return true;\r\n    if (tieKey && u.tieKey === tieKey) return true;\r\n    return false;\r\n  }) || null;\r\n}\r\n\r\nexport function getUpgradeLockState(areaKey, upgId) {\r\n  const upg = typeof upgId === 'object' && upgId ? upgId : getUpgrade(areaKey, upgId);\r\n  return computeUpgradeLockStateFor(areaKey, upg);\r\n}\r\n\r\nfunction normalizeUpgradeIconPath(iconPath) {\r\n  const raw = String(iconPath ?? '').trim();\r\n  if (!raw) return '';\r\n\r\n  if (/^(?:https?:|data:|blob:)/i.test(raw)) return raw;\r\n  if (raw.startsWith('//')) return raw;\r\n\r\n  const replaceSlashes = (value) => value.replace(/\\\\+/g, '/');\r\n  let path = replaceSlashes(raw);\r\n\r\n  if (path.startsWith('/')) {\r\n    return path.replace(/\\/{2,}/g, '/');\r\n  }\r\n\r\n  path = path.replace(/^\\.\\/+/u, '');\r\n  while (path.startsWith('../')) {\r\n    path = path.slice(3);\r\n  }\r\n\r\n  const segments = path\r\n    .split('/')\r\n    .map(seg => seg.trim())\r\n    .filter(seg => seg && seg !== '.');\r\n\r\n  if (!segments.length) return '';\r\n\r\n  const normalized = [];\r\n  for (const segment of segments) {\r\n    if (segment === '..') {\r\n      normalized.pop();\r\n      continue;\r\n    }\r\n    normalized.push(segment);\r\n  }\r\n\r\n  if (!normalized.length) return '';\r\n\r\n  const SHARED_ROOTS = new Set(['stats', 'currencies', 'misc']);\r\n\r\n  for (let i = 0; i < normalized.length; i += 1) {\r\n    const lower = normalized[i].toLowerCase();\r\n    if (lower === 'img') {\r\n      normalized.splice(i, 1);\r\n      i -= 1;\r\n      continue;\r\n    }\r\n\r\n    if (lower === 'sc_upgrade_icons' || lower === 'sc_upg_icons') {\r\n      normalized[i] = 'sc_upg_icons';\r\n      while (normalized[i + 1] && /^(?:sc_upgrade_icons|sc_upg_icons)$/i.test(normalized[i + 1])) {\r\n        normalized.splice(i + 1, 1);\r\n      }\r\n    }\r\n  }\r\n\r\n  if (!normalized.length) return '';\r\n\r\n  if (\r\n    normalized.length > 1\r\n    && normalized[0].toLowerCase() === 'sc_upg_icons'\r\n    && SHARED_ROOTS.has(normalized[1].toLowerCase())\r\n  ) {\r\n    normalized.shift();\r\n  }\r\n\r\n  if (normalized.length === 1) {\r\n    normalized.unshift('sc_upg_icons');\r\n  }\r\n\r\n  const result = normalized.join('/');\r\n  if (!result) return '';\r\n\r\n  return `img/${result}`;\r\n}\r\n\r\nexport function getIconUrl(upg) {\r\n  if (!upg) return '';\r\n  return normalizeUpgradeIconPath(upg.icon);\r\n}\r\n\r\n/* ------------------------------ Cost helpers ------------------------------ */\r\n\r\nfunction sumNextNLevelsCost(upg, currentLevel, n) {\r\n  let total = 0;\r\n  for (let i = 0; i < n; i++) {\r\n    total += upg.costAtLevel(currentLevel + i);\r\n  }\r\n  return total;\r\n}\r\n\r\nexport function costToBuyOne(areaKey, upgId) {\r\n  const upg = getUpgrade(areaKey, upgId);\r\n  const lvlBn = getLevel(areaKey, upgId);\r\n  const lvl = levelBigNumToNumber(lvlBn);\r\n  if (!upg) return 0;\r\n  if (lvl >= upg.lvlCap) return 0;\r\n  return upg.costAtLevel(lvl);\r\n}\r\n\r\nexport function buyOne(areaKey, upgId) {\r\n  const state = ensureUpgradeState(areaKey, upgId);\r\n  const upg = state.upg;\r\n  if (!upg) return { bought: 0, spent: 0 };\r\n\r\n  if (isUpgradeLocked(areaKey, upg)) {\r\n    return { bought: 0, spent: 0 };\r\n  }\r\n\r\n  const lvlNum = state.lvl;\r\n  const lvlBn = state.lvlBn ?? ensureLevelBigNum(lvlNum);\r\n  const prevLevelBn = safeCloneBigNum(lvlBn);\r\n\r\n  if (lvlNum >= upg.lvlCap) return { bought: 0, spent: 0 };\r\n\r\n  if (isInfinityLevelForScaled(upg, lvlBn)) {\r\n    state.lvlBn = BigNum.fromAny('Infinity');\r\n    state.lvl = levelBigNumToNumber(state.lvlBn);\r\n    state.nextCostBn = BigNum.fromAny('Infinity');\r\n    commitUpgradeState(state);\r\n    invalidateUpgradeState(areaKey, upgId);\r\n    notifyChanged();\r\n    return { bought: 0, spent: 0 };\r\n  }\r\n\r\n  const rawPrice = state.nextCostBn ?? BigNum.fromAny(upg.costAtLevel(lvlNum));\r\n  const priceBn = rawPrice instanceof BigNum\r\n    ? rawPrice\r\n    : BigNum.fromAny(rawPrice ?? 0);\r\n\r\n  const costType = upg.costType;\r\n  const walletEntry = costType ? bank[costType] : null;\r\n\r\n  let spent = BigNum.fromInt(0);\r\n\r\n  if (walletEntry && !priceBn.isZero?.()) {\r\n    const haveRaw = walletEntry.value;\r\n    const have = haveRaw instanceof BigNum\r\n      ? haveRaw\r\n      : BigNum.fromAny(haveRaw ?? 0);\r\n\r\n    if (have.cmp(priceBn) < 0) {\r\n      return { bought: 0, spent: 0 };\r\n    }\r\n\r\n    spent = priceBn.clone?.() ?? BigNum.fromAny(priceBn);\r\n    walletEntry.sub(spent);\r\n  } else {\r\n    if (!priceBn.isZero?.()) {\r\n      return { bought: 0, spent: 0 };\r\n    }\r\n    spent = BigNum.fromInt(0);\r\n  }\r\n\r\n  const nextLevelBn = lvlBn.add(BigNum.fromInt(1));\r\n  state.lvlBn = nextLevelBn;\r\n  state.lvl = levelBigNumToNumber(nextLevelBn);\r\n  state.nextCostBn = BigNum.fromAny(\r\n    typeof upg.nextCostAfter === 'function'\r\n      ? upg.nextCostAfter(spent, state.lvl)\r\n      : upg.costAtLevel(state.lvl)\r\n  );\r\n\r\n  commitUpgradeState(state);\r\n  invalidateUpgradeState(areaKey, upgId);\r\n  emitUpgradeLevelChange(upg, lvlNum, prevLevelBn, state.lvl, state.lvlBn);\r\n  notifyChanged();\r\n\r\n  return { bought: 1, spent };\r\n}\r\n\r\nexport function evolveUpgrade(areaKey, upgId) {\r\n  const state = ensureUpgradeState(areaKey, upgId);\r\n  const upg = state.upg;\r\n  if (!upg || upg.upgType !== 'HM') return { evolved: false };\r\n\r\n  const lvlBn = state.lvlBn ?? ensureLevelBigNum(state.lvl);\r\n  if (!isHmReadyToEvolve(upg, lvlBn, state.hmEvolutions)) {\r\n    return { evolved: false };\r\n  }\r\n\r\n  const nextEvol = normalizeHmEvolutionCount(state.hmEvolutions) + 1;\r\n  state.hmEvolutions = nextEvol;\r\n  applyHmEvolutionMeta(upg, nextEvol);\r\n\r\n  try { state.nextCostBn = BigNum.fromAny(upg.costAtLevel(state.lvl)); }\r\n  catch { state.nextCostBn = BigNum.fromAny('Infinity'); }\r\n\r\n  commitUpgradeState(state);\r\n  invalidateUpgradeState(areaKey, upgId);\r\n  emitUpgradeLevelChange(upg, state.lvl, lvlBn, state.lvl, lvlBn);\r\n  notifyChanged();\r\n\r\n  return { evolved: true };\r\n}\r\n\r\nexport function buyMax(areaKey, upgId) {\r\n  const state = ensureUpgradeState(areaKey, upgId);\r\n  const upg = state.upg;\r\n  if (!upg) return { bought: 0, spent: BigNum.fromInt(0) };\r\n\r\n  if (isUpgradeLocked(areaKey, upg)) {\r\n    return { bought: BigNum.fromInt(0), spent: BigNum.fromInt(0) };\r\n  }\r\n\r\n  const lvlNum = state.lvl;\r\n  const lvlBn = state.lvlBn ?? ensureLevelBigNum(lvlNum);\r\n  const cap = Number.isFinite(upg.lvlCap)\r\n    ? Math.max(0, Math.floor(upg.lvlCap))\r\n    : Infinity;\r\n  if (Number.isFinite(cap) && lvlNum >= cap) return { bought: 0, spent: BigNum.fromInt(0) };\r\n\r\n  const walletHandle = bank[upg.costType];\r\n  const walletValue = walletHandle?.value;\r\n  const wallet = walletValue instanceof BigNum\r\n    ? walletValue.clone?.() ?? BigNum.fromAny(walletValue)\r\n    : BigNum.fromAny(walletValue ?? 0);\r\n\r\n  if (upg.unlockUpgrade) {\r\n    const nextCost = state.nextCostBn?.clone?.() ?? BigNum.fromInt(0);\r\n    if (nextCost.isZero?.()) {\r\n      return buyOne(areaKey, upgId);\r\n    }\r\n  }\r\n\r\n  if (wallet.isZero?.()) return { bought: BigNum.fromInt(0), spent: BigNum.fromInt(0) };\r\n\r\n  if (wallet.isInfinite?.()) {\r\n    const prevLevel = lvlBn.clone?.() ?? ensureLevelBigNum(lvlBn);\r\n    const prevLevelNum = levelBigNumToNumber(prevLevel);\r\n    const prevLevelStorage = prevLevel.toStorage?.();\r\n    let targetLevelBn;\r\n\r\n    if (upg.upgType === 'HM') {\r\n      targetLevelBn = BigNum.fromAny('Infinity');\r\n\r\n      if (!upg.lvlCapBn?.isInfinite?.()) {\r\n        const infCap = BigNum.fromAny('Infinity');\r\n        upg.lvlCapBn = infCap;\r\n        upg.lvlCap = Number.POSITIVE_INFINITY;\r\n        upg.lvlCapFmtHtml = formatBigNumAsHtml(infCap);\r\n        upg.lvlCapFmtText = formatBigNumAsPlain(infCap);\r\n      }\r\n    } else {\r\n      const capBn = upg.lvlCapBn?.clone?.() ?? toUpgradeBigNum(upg.lvlCap ?? Infinity, Infinity);\r\n      targetLevelBn = capBn?.clone?.() ?? capBn;\r\n    }\r\n\r\n    let purchased = targetLevelBn.sub(prevLevel);\r\n    if (purchased.isZero?.()) {\r\n      const plainDelta = plainLevelDelta(targetLevelBn, prevLevel);\r\n      if (!plainDelta.isZero?.()) {\r\n        purchased = plainDelta;\r\n      }\r\n    }\r\n    if (purchased.isZero?.()) {\r\n      const nextStorage = targetLevelBn.toStorage?.();\r\n      if (prevLevelStorage && nextStorage && prevLevelStorage !== nextStorage) {\r\n        if (targetLevelBn.isInfinite?.()) {\r\n          try { purchased = BigNum.fromAny('Infinity'); }\r\n          catch { purchased = BigNum.fromInt(1); }\r\n        } else {\r\n          purchased = BigNum.fromInt(1);\r\n        }\r\n      }\r\n    }\r\n    state.lvlBn = targetLevelBn.clone?.() ?? targetLevelBn;\r\n    if (upg.upgType === 'NM' && Number.isFinite(upg.lvlCap)) {\r\n      state.lvl = upg.lvlCap;\r\n    } else {\r\n      state.lvl = levelBigNumToNumber(state.lvlBn);\r\n    }\r\n    state.nextCostBn = BigNum.fromAny('Infinity');\r\n\r\n    bank[upg.costType].set(wallet);\r\n\r\n    commitUpgradeState(state);\r\n    invalidateUpgradeState(areaKey, upgId);\r\n    emitUpgradeLevelChange(\r\n      upg,\r\n      prevLevelNum,\r\n      prevLevel,\r\n      state.lvl,\r\n      state.lvlBn,\r\n    );\r\n    notifyChanged();\r\n\r\n    return { bought: purchased, spent: BigNum.fromInt(0) };\r\n  }\r\n\r\n  const nextCost = state.nextCostBn?.clone?.() ?? BigNum.fromAny(upg.costAtLevel(lvlNum));\r\n  if (wallet.cmp(nextCost) < 0) {\r\n    return { bought: BigNum.fromInt(0), spent: BigNum.fromInt(0) };\r\n  }\r\n\r\n  const room = Number.isFinite(cap) ? Math.max(0, cap - lvlNum) : MAX_LEVEL_DELTA;\r\n  if (!(room > 0)) {\r\n    return { bought: BigNum.fromInt(0), spent: BigNum.fromInt(0) };\r\n  }\r\n\r\n  const outcome = calculateBulkPurchase(upg, lvlBn, wallet, room);\r\n  const countBn = outcome.count instanceof BigNum\r\n    ? outcome.count\r\n    : BigNum.fromAny(outcome.count ?? 0);\r\n  if (countBn.isZero?.()) {\r\n    return { bought: BigNum.fromInt(0), spent: BigNum.fromInt(0) };\r\n  }\r\n\r\n  const spent = outcome.spent ?? BigNum.fromInt(0);\r\n  const remaining = wallet.sub(spent);\r\n  bank[upg.costType].set(remaining);\r\n\r\n  const nextLevelBn = lvlBn.add(countBn);\r\n  state.lvlBn = nextLevelBn;\r\n  state.lvl = levelBigNumToNumber(nextLevelBn);\r\n  if (outcome.nextPrice) {\r\n    state.nextCostBn = outcome.nextPrice;\r\n  } else if (Number.isFinite(state.lvl)) {\r\n    state.nextCostBn = BigNum.fromAny(upg.costAtLevel(state.lvl));\r\n  } else {\r\n    state.nextCostBn = BigNum.fromAny('Infinity');\r\n  }\r\n  commitUpgradeState(state);\r\n  invalidateUpgradeState(areaKey, upgId);\r\n  emitUpgradeLevelChange(upg, lvlNum, lvlBn, state.lvl, state.lvlBn);\r\n  notifyChanged();\r\n\r\n  return { bought: countBn, spent };\r\n}\r\n\r\nexport function buyTowards(areaKey, upgId, maxLevels) {\r\n  const state = ensureUpgradeState(areaKey, upgId);\r\n  const upg = state.upg;\r\n  if (!upg) return { bought: 0, spent: BigNum.fromInt(0) };\r\n\r\n  if (isUpgradeLocked(areaKey, upg)) {\r\n    return { bought: BigNum.fromInt(0), spent: BigNum.fromInt(0) };\r\n  }\r\n\r\n  const lvlNum = state.lvl;\r\n  const lvlBn = state.lvlBn ?? ensureLevelBigNum(lvlNum);\r\n  const cap = Number.isFinite(upg.lvlCap)\r\n    ? Math.max(0, Math.floor(upg.lvlCap))\r\n    : Infinity;\r\n  if (Number.isFinite(cap) && lvlNum >= cap) return { bought: 0, spent: BigNum.fromInt(0) };\r\n\r\n  const walletHandle = bank[upg.costType];\r\n  const walletValue = walletHandle?.value;\r\n  const wallet = walletValue instanceof BigNum\r\n    ? walletValue.clone?.() ?? BigNum.fromAny(walletValue)\r\n    : BigNum.fromAny(walletValue ?? 0);\r\n\r\n  if (wallet.isZero?.()) return { bought: BigNum.fromInt(0), spent: BigNum.fromInt(0) };\r\n\r\n  const capRoom = Number.isFinite(cap) ? Math.max(0, cap - lvlNum) : undefined;\r\n  const maxRoom = Number.isFinite(maxLevels)\r\n    ? Math.max(0, Math.floor(maxLevels))\r\n    : (maxLevels instanceof BigNum ? levelBigNumToNumber(maxLevels) : undefined);\r\n  const room = Number.isFinite(capRoom)\r\n    ? (Number.isFinite(maxRoom) ? Math.min(capRoom, maxRoom) : capRoom)\r\n    : maxRoom;\r\n\r\n  const outcome = calculateBulkPurchase(upg, lvlBn, wallet, room);\r\n  const countBn = outcome.count instanceof BigNum\r\n    ? outcome.count\r\n    : BigNum.fromAny(outcome.count ?? 0);\r\n  if (countBn.isZero?.()) {\r\n    return { bought: BigNum.fromInt(0), spent: BigNum.fromInt(0) };\r\n  }\r\n\r\n  const spent = outcome.spent ?? BigNum.fromInt(0);\r\n  const remaining = wallet.sub(spent);\r\n  bank[upg.costType].set(remaining);\r\n\r\n  const nextLevelBn = lvlBn.add(countBn);\r\n  state.lvlBn = nextLevelBn;\r\n  state.lvl = levelBigNumToNumber(nextLevelBn);\r\n  if (outcome.nextPrice) {\r\n    state.nextCostBn = outcome.nextPrice;\r\n  } else if (Number.isFinite(state.lvl)) {\r\n    state.nextCostBn = BigNum.fromAny(upg.costAtLevel(state.lvl));\r\n  } else {\r\n    state.nextCostBn = BigNum.fromAny('Infinity');\r\n  }\r\n  commitUpgradeState(state);\r\n  invalidateUpgradeState(areaKey, upgId);\r\n  emitUpgradeLevelChange(upg, lvlNum, lvlBn, state.lvl, state.lvlBn);\r\n  notifyChanged();\r\n\r\n  return { bought: countBn, spent };\r\n}\r\n\r\nexport function evaluateBulkPurchase(upg, startLevel, walletBn, maxLevels = MAX_LEVEL_DELTA, options = {}) {\r\n  const wallet = walletBn instanceof BigNum ? walletBn : BigNum.fromAny(walletBn ?? 0);\r\n  const outcome = calculateBulkPurchase(upg, startLevel, wallet, maxLevels, options);\r\n  return {\r\n    count: outcome.count,\r\n    spent: outcome.spent ?? BigNum.fromInt(0),\r\n    nextPrice: outcome.nextPrice ?? BigNum.fromInt(0),\r\n    numericCount: outcome.numericCount ?? 0,\r\n  };\r\n}\r\n\r\n/* ------------------------------ Effects wiring ---------------------------- */\r\n\r\nconst BASE_CPS = 1;\r\n\r\nlet _cachedUpgradeMultipliers = null;\r\n\r\nexport function calculateUpgradeMultipliers(areaKey = AREA_KEYS.STARTER_COVE) {\r\n  if (_cachedUpgradeMultipliers) return _cachedUpgradeMultipliers;\r\n\r\n  const upgrades = getUpgradesForArea(areaKey);\r\n  const acc = {\r\n    coinValue: BigNum.fromInt(1),\r\n    xpValue: BigNum.fromInt(1),\r\n    mpValue: BigNum.fromInt(1),\r\n    bookValue: BigNum.fromInt(1),\r\n    coinSpawn: 1.0,\r\n    magnetRadius: 0,\r\n  };\r\n\r\n  for (const upg of upgrades) {\r\n    if (!upg.effectType) continue;\r\n\r\n    const lvlBn = getLevel(areaKey, upg.id);\r\n    const lvlNum = levelBigNumToNumber(lvlBn);\r\n\r\n    let baseEffect = null;\r\n    if (typeof upg.effectMultiplier === 'function') {\r\n      baseEffect = upg.effectMultiplier(lvlNum);\r\n      // normalize to BigNum if it's not a number/BigNum\r\n      if (!(baseEffect instanceof BigNum) && typeof baseEffect !== 'number') {\r\n        baseEffect = BigNum.fromAny(baseEffect ?? 1);\r\n      }\r\n    } else {\r\n      baseEffect = BigNum.fromInt(1);\r\n    }\r\n\r\n    if (upg.upgType === 'HM') {\r\n      const { selfMult, xpMult, coinMult, mpMult } = computeHmMultipliers(upg, lvlBn, areaKey);\r\n      acc.xpValue = safeMultiplyBigNum(acc.xpValue, xpMult);\r\n      acc.coinValue = safeMultiplyBigNum(acc.coinValue, coinMult);\r\n      acc.mpValue = safeMultiplyBigNum(acc.mpValue, mpMult);\r\n      \r\n      // Apply selfMult to baseEffect\r\n      baseEffect = safeMultiplyBigNum(baseEffect, selfMult);\r\n    }\r\n\r\n    if (upg.effectType === 'coin_spawn') {\r\n      let val = 1;\r\n      if (baseEffect instanceof BigNum) {\r\n        try { val = Number(baseEffect.toScientific()); } catch { val = 1; }\r\n      } else {\r\n        val = Number(baseEffect);\r\n      }\r\n      acc.coinSpawn *= val;\r\n    } else if (upg.effectType === 'coin_value') {\r\n      acc.coinValue = safeMultiplyBigNum(acc.coinValue, baseEffect);\r\n    } else if (upg.effectType === 'xp_value') {\r\n      acc.xpValue = safeMultiplyBigNum(acc.xpValue, baseEffect);\r\n    } else if (upg.effectType === 'mp_value') {\r\n      acc.mpValue = safeMultiplyBigNum(acc.mpValue, baseEffect);\r\n    } else if (upg.effectType === 'book_value') {\r\n      acc.bookValue = safeMultiplyBigNum(acc.bookValue, baseEffect);\r\n    } else if (upg.effectType === 'magnet_radius') {\r\n      let val = 0;\r\n      if (baseEffect instanceof BigNum) {\r\n        try { val = Number(baseEffect.toScientific()); } catch { val = 0; }\r\n      } else {\r\n        val = Number(baseEffect);\r\n      }\r\n      if (Number.isFinite(val)) {\r\n        acc.magnetRadius += val;\r\n      }\r\n    }\r\n  }\r\n\r\n  _cachedUpgradeMultipliers = acc;\r\n  return acc;\r\n\r\n}\r\nexport function computeUpgradeEffects(areaKey) {\r\n  const mults = calculateUpgradeMultipliers(areaKey);\r\n  \r\n  return {\r\n    coinsPerSecondMult: mults.coinSpawn,\r\n    coinsPerSecondAbsolute: BASE_CPS * mults.coinSpawn,\r\n    coinValueMultiplier: mults.coinValue,\r\n    xpGainMultiplier: mults.xpValue,\r\n    bookRewardMultiplier: mults.bookValue,\r\n  };\r\n}\r\nexport function registerXpUpgradeEffects() {\r\n  try { initResetSystem(); } catch {}\r\n\r\n  try {\r\n    addExternalCoinMultiplierProvider(({ baseMultiplier, xpUnlocked }) => {\r\n      if (!xpUnlocked) return baseMultiplier;\r\n      let result = baseMultiplier instanceof BigNum\r\n        ? baseMultiplier.clone?.() ?? baseMultiplier\r\n        : BigNum.fromAny(baseMultiplier ?? 0);\r\n      \r\n      const { coinValue } = calculateUpgradeMultipliers(AREA_KEYS.STARTER_COVE);\r\n      return safeMultiplyBigNum(result, coinValue);\r\n    });\r\n  } catch {}\r\n\r\n  try {\r\n    addExternalXpGainMultiplierProvider(({ baseGain, xpUnlocked }) => {\r\n      if (!xpUnlocked) return baseGain;\r\n      let gain = baseGain instanceof BigNum\r\n        ? baseGain.clone?.() ?? baseGain\r\n        : BigNum.fromAny(baseGain ?? 0);\r\n      \r\n      const { xpValue } = calculateUpgradeMultipliers(AREA_KEYS.STARTER_COVE);\r\n      return safeMultiplyBigNum(gain, xpValue);\r\n    });\r\n  } catch {}\r\n\r\n\r\n\r\n  syncBookCurrencyMultiplierFromUpgrade();\r\n  if (typeof window !== 'undefined') {\r\n    window.addEventListener('saveSlot:change', () => {\r\n      try { syncBookCurrencyMultiplierFromUpgrade(); } catch {}\r\n      try { refreshCoinMultiplierFromXpLevel(); } catch {}\r\n    });\r\n  }\r\n}\r\n\r\nlet listeners = [];\r\nexport function onUpgradesChanged(cb) {\r\n  if (typeof cb === 'function') listeners.push(cb);\r\n  return () => { listeners = listeners.filter(x => x !== cb); };\r\n}\r\nfunction notifyChanged() {\r\n  if (isBatching) {\r\n    pendingNotify = true;\r\n    _cachedUpgradeMultipliers = null;\r\n    return;\r\n  }\r\n  _cachedUpgradeMultipliers = null;\r\n  try { listeners.forEach(cb => cb()); } catch {}\r\n  try { document.dispatchEvent(new CustomEvent('ccc:upgrades:changed')); } catch {}\r\n  try { refreshCoinMultiplierFromXpLevel(); } catch {}\r\n}\r\n\r\n/* ----------------------- Area detection (DOM mapping) ---------------------- */\r\n\r\nexport function getCurrentAreaKey() {\r\n  const gameRoot = document.getElementById('game-root');\r\n  if (gameRoot?.classList?.contains('area-cove')) return AREA_KEYS.STARTER_COVE;\r\n  return AREA_KEYS.STARTER_COVE;\r\n}\r\n\r\n/* ------------------------------ UI helpers -------------------------------- */\r\n\r\nexport function upgradeUiModel(areaKey, upgId) {\r\n  const upg = getUpgrade(areaKey, upgId);\r\n  if (!upg) return null;\r\n  const lvlBn = getLevel(areaKey, upgId);\r\n  const lvl = levelBigNumToNumber(lvlBn);\r\n  const lvlFmtHtml = formatBigNumAsHtml(lvlBn);\r\n  const lvlFmtText = formatBigNumAsPlain(lvlBn);\r\n  const lvlCapBn = upg.lvlCapBn ?? toUpgradeBigNum(upg.lvlCap ?? Infinity, Infinity);\r\n  const lvlCapFmtHtml = upg.lvlCapFmtHtml ?? formatBigNumAsHtml(lvlCapBn);\r\n  const lvlCapFmtText = upg.lvlCapFmtText ?? formatBigNumAsPlain(lvlCapBn);\r\n  const nextPrice = lvl < upg.lvlCap ? peekNextPrice(areaKey, upgId) : BigNum.fromInt(0);\r\n  const nextPriceFmt = formatBigNumAsHtml(nextPrice);\r\n  const haveRaw = bank[upg.costType]?.value;\r\n  const have = haveRaw instanceof BigNum\r\n    ? haveRaw\r\n    : BigNum.fromAny(haveRaw ?? 0);\r\n  const lockState = getUpgradeLockState(areaKey, upgId);\r\n  const locked = !!lockState.locked;\r\n  const displayTitle = lockState.titleOverride ?? upg.title;\r\n  const displayDesc = lockState.descOverride ?? upg.desc;\r\n  const hmMilestones = resolveHmMilestones(upg, areaKey);\r\n  let effect = '';\r\n  if (typeof upg.effectSummary === 'function' && !(locked && lockState.hideEffect)) {\r\n    effect = upg.effectSummary(lvl);\r\n    if (typeof effect === 'string') effect = effect.trim();\r\n  }\r\n  const iconUrl = lockState.iconOverride ?? getIconUrl(upg);\r\n  return {\r\n    upg,\r\n    lvl,\r\n    lvlBn,\r\n    lvlFmtHtml,\r\n    lvlFmtText,\r\n    lvlCapBn,\r\n    lvlCapFmtHtml,\r\n    lvlCapFmtText,\r\n    nextPrice,\r\n    nextPriceFmt,\r\n    have,\r\n    haveFmt: bank[upg.costType]?.fmt(have) ?? String(have),\r\n    effect,\r\n    iconUrl,\r\n    lockState,\r\n    locked,\r\n    areaKey,\r\n    hmMilestones,\r\n    displayTitle,\r\n    displayDesc,\r\n    unlockUpgrade: !!upg.unlockUpgrade,\r\n    hmEvolutions: upg.upgType === 'HM' ? getHmEvolutions(areaKey, upgId) : 0,\r\n    hmReadyToEvolve: upg.upgType === 'HM' ? isHmReadyToEvolve(upg, lvlBn, getHmEvolutions(areaKey, upgId)) : false,\r\n    hmNextMilestone: upg.upgType === 'HM' ? hmNextMilestoneLevel(upg, lvlBn, areaKey) : null,\r\n  };\r\n}\r\n\r\nexport function getHmNextMilestoneLevel(areaKey, upgId) {\r\n  const upg = getUpgrade(areaKey, upgId);\r\n  if (!upg || upg.upgType !== 'HM') return null;\r\n  const lvlBn = getLevel(areaKey, upgId);\r\n  return hmNextMilestoneLevel(upg, lvlBn, areaKey);\r\n}\r\n\r\nexport function normalizeBigNum(value) {\r\n  return bigNumFromLog10(approxLog10BigNum(value ?? 0));\r\n}\r\n\r\nexport function performFreeAutobuy(areaKey, upgId) {\r\n  const state = ensureUpgradeState(areaKey, upgId);\r\n  const upg = state.upg;\r\n  if (!upg) return { bought: 0 };\r\n\r\n  const storageKey = keyForArea(areaKey, state.slot);\r\n  if (isStorageKeyLocked(storageKey)) return { bought: 0 };\r\n\r\n  if (isUpgradeLocked(areaKey, upg)) return { bought: 0 };\r\n\r\n  const lvlNum = state.lvl;\r\n  const lvlBn = state.lvlBn ?? ensureLevelBigNum(lvlNum);\r\n  const cap = Number.isFinite(upg.lvlCap)\r\n    ? Math.max(0, Math.floor(upg.lvlCap))\r\n    : Infinity;\r\n  if (Number.isFinite(cap) && lvlNum >= cap) return { bought: 0 };\r\n\r\n  if (upg.upgType === 'HM' && isHmReadyToEvolve(upg, lvlBn, state.hmEvolutions)) {\r\n    return { bought: 0 };\r\n  }\r\n\r\n  const walletHandle = bank[upg.costType];\r\n  const walletValue = walletHandle?.value;\r\n  const wallet = walletValue instanceof BigNum\r\n    ? walletValue.clone?.() ?? BigNum.fromAny(walletValue)\r\n    : BigNum.fromAny(walletValue ?? 0);\r\n\r\n  if (wallet.isZero?.()) return { bought: 0 };\r\n\r\n  const outcome = calculateBulkPurchase(upg, lvlBn, wallet, MAX_LEVEL_DELTA);\r\n  const countBn = outcome.count instanceof BigNum\r\n    ? outcome.count\r\n    : BigNum.fromAny(outcome.count ?? 0);\r\n  if (countBn.isZero?.()) return { bought: 0 };\r\n\r\n  // Set the new level without deducting currency\r\n  const nextLevelBn = lvlBn.add(countBn);\r\n  initDeferredFlush();\r\n  setLevel(areaKey, upgId, nextLevelBn, true, { deferSave: true });\r\n\r\n  return { bought: countBn };\r\n}\r\n\r\nregisterXpUpgradeEffects();\r\n", "// js/util/debugPanel.js\r\n// Using a debug panel is much faster and more convenient than\r\n// Editing local storage every time I want to change something.\r\n\r\nimport { BigNum } from './bigNum.js';\r\nimport { formatNumber } from './numFormat.js';\r\nimport {\r\n    bank,\r\n    CURRENCIES,\r\n    KEYS,\r\n    getActiveSlot,\r\n    markSaveSlotModified,\r\n    peekCurrency,\r\n    primeStorageWatcherSnapshot,\r\n    setCurrency,\r\n    setCurrencyMultiplierBN,\r\n} from './storage.js';\r\nimport { broadcastXpChange, computeCoinMultiplierForXpLevel, getXpGainMultiplier, getXpRequirementForXpLevel, getXpState, initXpSystem, resetXpProgress, unlockXpSystem } from '../game/xpSystem.js';\r\nimport { broadcastMutationChange, computeMutationMultiplierForLevel, computeMutationRequirementForLevel, getMutationMultiplier, getMutationState, initMutationSystem, setMutationUnlockedForDebug, unlockMutationSystem } from '../game/mutationSystem.js';\r\nimport { IS_MOBILE } from '../main.js';\r\nimport {\r\n    getUpgradeStorageKey,\r\n    AREA_KEYS,\r\n    computeDefaultUpgradeCost,\r\n    computeUpgradeEffects,\r\n    getLevel,\r\n    getMpValueMultiplierBn,\r\n    getUpgradesForArea,\r\n    markUpgradePermanentlyUnlocked,\r\n    clearPermanentUpgradeUnlock,\r\n    setLevel,\r\n    getUpgradeLockState,\r\n    batchUpgradeOperations,\r\n} from '../game/upgrades.js';\r\nimport { isMapUnlocked, isShopUnlocked, lockMap, lockShop, unlockMap, unlockShop } from '../ui/hudButtons.js';\r\nimport { DLG_CATALOG, MERCHANT_DLG_STATE_KEY_BASE, isJeffUnlocked, setJeffUnlocked } from '../ui/merchantTabs/dlgTab.js';\r\nimport { getGenerationLevelKey, getGenerationUpgradeCost } from '../ui/merchantTabs/workshopTab.js';\r\nimport { setAutobuyerToggle } from '../game/automationEffects.js';\r\nimport { AUTOBUY_WORKSHOP_LEVELS_ID, AUTOMATION_AREA_KEY, MASTER_AUTOBUY_IDS } from '../game/automationUpgrades.js';\r\n\r\nconst DEBUG_PANEL_STYLE_ID = 'debug-panel-style';\r\nconst DEBUG_PANEL_ID = 'debug-panel';\r\nconst DEBUG_PANEL_TOGGLE_ID = 'debug-panel-toggle';\r\nconst DEFAULT_MISC_RESET_SELECTION = `currency:${CURRENCIES.COINS}`;\r\nlet debugPanelOpen = false;\r\nlet debugPanelAccess = false;\r\nlet debugPanelCleanups = [];\r\nlet debugPanelExpansionState = createEmptyExpansionState();\r\nlet debugPanelScrollTop = 0;\r\nlet debugPanelMiscResetSelection = DEFAULT_MISC_RESET_SELECTION;\r\nlet sectionKeyCounter = 0;\r\nlet subsectionKeyCounter = 0;\r\nconst liveBindings = [];\r\nlet actionLogContainer = null;\r\n\r\nconst currencyOverrides = new Map();\r\nconst currencyOverrideBaselines = new Map();\r\nconst currencyOverrideApplications = new Set();\r\nconst statOverrides = new Map();\r\nconst statOverrideBaselines = new Map();\r\nconst lockedStorageKeys = new Set();\r\nif (typeof window !== 'undefined') {\r\n    window.__cccLockedStorageKeys = lockedStorageKeys;\r\n}\r\nlet storageLockPatched = false;\r\nlet originalSetItem = null;\r\nlet originalRemoveItem = null;\r\n\r\nconst STAT_MULTIPLIER_STORAGE_PREFIX = 'ccc:debug:stat-mult';\r\nconst ACTION_LOG_STORAGE_PREFIX = 'ccc:actionLog';\r\nconst MAX_ACTION_LOG_ENTRIES = 100;\r\n\r\nfunction isOnMenu() {\r\n    const menuRoot = document.querySelector('.menu-root');\r\n    if (!menuRoot) return false;\r\n\r\n    const style = window.getComputedStyle?.(menuRoot);\r\n    if (!style) return menuRoot.style.display !== 'none';\r\n\r\n    return style.display !== 'none' && style.visibility !== 'hidden' && !menuRoot.hidden;\r\n}\r\n\r\nfunction isGameVisible() {\r\n    const gameRoot = document.getElementById('game-root');\r\n    if (!gameRoot) return false;\r\n\r\n    const style = window.getComputedStyle?.(gameRoot);\r\n    if (!style) {\r\n        return gameRoot.style.display !== 'none'\r\n            && gameRoot.style.visibility !== 'hidden'\r\n            && !gameRoot.hidden;\r\n    }\r\n\r\n    return style.display !== 'none' && style.visibility !== 'hidden' && !gameRoot.hidden;\r\n}\r\n\r\nfunction addDebugPanelCleanup(fn) {\r\n    if (typeof fn === 'function') {\r\n        debugPanelCleanups.push(fn);\r\n    }\r\n}\r\n\r\nfunction createEmptyExpansionState() {\r\n    return { sections: new Set(), subsections: new Set() };\r\n}\r\n\r\nfunction captureDebugPanelExpansionState() {\r\n    const panel = document.getElementById(DEBUG_PANEL_ID);\r\n    if (!panel) return createEmptyExpansionState();\r\n\r\n    const sections = new Set();\r\n    panel.querySelectorAll('.debug-panel-section-toggle').forEach((toggle) => {\r\n        const key = toggle.dataset.sectionKey ?? toggle.textContent;\r\n        if (toggle.classList.contains('expanded')) {\r\n            sections.add(key);\r\n        }\r\n    });\r\n\r\n    const subsections = new Set();\r\n    panel.querySelectorAll('.debug-panel-subsection-toggle').forEach((toggle) => {\r\n        const key = toggle.dataset.subsectionKey ?? toggle.textContent;\r\n        if (toggle.classList.contains('expanded')) {\r\n            subsections.add(key);\r\n        }\r\n    });\r\n\r\n    return { sections, subsections };\r\n}\r\n\r\nfunction applyDebugPanelExpansionState(panel) {\r\n    const { sections, subsections } = debugPanelExpansionState ?? createEmptyExpansionState();\r\n\r\n    panel.querySelectorAll('.debug-panel-section-toggle').forEach((toggle) => {\r\n        const key = toggle.dataset.sectionKey ?? toggle.textContent;\r\n        if (!sections.has(key)) return;\r\n        const content = toggle.nextElementSibling;\r\n        toggle.classList.add('expanded');\r\n        if (content) content.classList.add('active');\r\n    });\r\n\r\n    panel.querySelectorAll('.debug-panel-subsection-toggle').forEach((toggle) => {\r\n        const key = toggle.dataset.subsectionKey ?? toggle.textContent;\r\n        if (!subsections.has(key)) return;\r\n        const content = toggle.nextElementSibling;\r\n        toggle.classList.add('expanded');\r\n        if (content) content.classList.add('active');\r\n    });\r\n}\r\n\r\nfunction cleanupDebugPanelResources() {\r\n    debugPanelCleanups.forEach((fn) => {\r\n        try { fn?.(); } catch {}\r\n    });\r\n    debugPanelCleanups = [];\r\n    liveBindings.length = 0;\r\n}\r\n\r\nfunction registerLiveBinding(binding) {\r\n    if (!binding || typeof binding.refresh !== 'function') return;\r\n    liveBindings.push(binding);\r\n}\r\n\r\nfunction refreshLiveBindings(predicate) {\r\n    liveBindings.forEach((binding) => {\r\n        if (typeof predicate === 'function' && !predicate(binding)) return;\r\n        try { binding.refresh(); } catch {}\r\n    });\r\n}\r\n\r\nfunction setupLiveBindingListeners() {\r\n    if (typeof window === 'undefined') return;\r\n\r\n    const currencyHandler = (event) => {\r\n        const { key, slot } = event?.detail ?? {};\r\n        const targetSlot = slot ?? getActiveSlot();\r\n        refreshLiveBindings((binding) => binding.type === 'currency'\r\n            && binding.key === key\r\n            && binding.slot === targetSlot);\r\n    };\r\n    window.addEventListener('currency:change', currencyHandler, { passive: true });\r\n    addDebugPanelCleanup(() => window.removeEventListener('currency:change', currencyHandler));\r\n\r\n    const currencyMultiplierHandler = (event) => {\r\n        const { key, slot } = event?.detail ?? {};\r\n        const targetSlot = slot ?? getActiveSlot();\r\n        refreshLiveBindings((binding) => binding.type === 'currency-mult'\r\n            && binding.key === key\r\n            && binding.slot === targetSlot);\r\n    };\r\n    window.addEventListener('currency:multiplier', currencyMultiplierHandler, { passive: true });\r\n    addDebugPanelCleanup(() => window.removeEventListener('currency:multiplier', currencyMultiplierHandler));\r\n\r\n    const xpHandler = (event) => {\r\n        const { slot, changeType, unlocked } = event?.detail ?? {};\r\n        const targetSlot = slot ?? getActiveSlot();\r\n        refreshLiveBindings((binding) => binding.type === 'xp'\r\n            && binding.slot === targetSlot);\r\n        refreshLiveBindings((binding) => binding.type === 'stat-mult'\r\n            && binding.key === 'xp'\r\n            && binding.slot === targetSlot);\r\n        if (changeType === 'unlock' || typeof unlocked === 'boolean') {\r\n            refreshLiveBindings((binding) => binding.type === 'unlock'\r\n                && (binding.slot == null || binding.slot === targetSlot));\r\n        }\r\n    };\r\n    window.addEventListener('xp:change', xpHandler, { passive: true });\r\n    window.addEventListener('xp:unlock', xpHandler, { passive: true });\r\n    addDebugPanelCleanup(() => {\r\n        window.removeEventListener('xp:change', xpHandler);\r\n        window.removeEventListener('xp:unlock', xpHandler);\r\n    });\r\n\r\n    const mutationHandler = (event) => {\r\n        const { changeType, slot } = event?.detail ?? {};\r\n        const targetSlot = slot ?? getActiveSlot();\r\n        refreshLiveBindings((binding) => binding.type === 'mutation'\r\n            && binding.slot === targetSlot);\r\n        refreshLiveBindings((binding) => binding.type === 'stat-mult'\r\n            && binding.key === 'mutation'\r\n            && binding.slot === targetSlot);\r\n        if (changeType === 'unlock') {\r\n            refreshLiveBindings((binding) => binding.type === 'unlock'\r\n                && (binding.slot == null || binding.slot === targetSlot));\r\n        }\r\n    };\r\n    window.addEventListener('mutation:change', mutationHandler, { passive: true });\r\n    addDebugPanelCleanup(() => window.removeEventListener('mutation:change', mutationHandler));\r\n\r\n    const upgradeHandler = () => {\r\n        const targetSlot = getActiveSlot();\r\n        refreshLiveBindings((binding) => binding.type === 'upgrade'\r\n            && binding.slot === targetSlot);\r\n        refreshLiveBindings((binding) => binding.type === 'currency-mult'\r\n            && binding.slot === targetSlot);\r\n        refreshLiveBindings((binding) => binding.type === 'stat-mult'\r\n            && binding.slot === targetSlot);\r\n    };\r\n    document.addEventListener('ccc:upgrades:changed', upgradeHandler, { passive: true });\r\n    addDebugPanelCleanup(() => document.removeEventListener('ccc:upgrades:changed', upgradeHandler));\r\n\r\n    const slotHandler = () => {\r\n        const targetSlot = getActiveSlot();\r\n        refreshLiveBindings((binding) => binding.slot === targetSlot);\r\n    };\r\n    window.addEventListener('saveSlot:change', slotHandler, { passive: true });\r\n    addDebugPanelCleanup(() => window.removeEventListener('saveSlot:change', slotHandler));\r\n\r\n    const unlockHandler = (event) => {\r\n        const { slot, key } = event?.detail ?? {};\r\n        const targetSlot = slot ?? getActiveSlot();\r\n        refreshLiveBindings((binding) => binding.type === 'unlock'\r\n            && (binding.slot == null || binding.slot === targetSlot)\r\n            && (binding.key == null || binding.key === key));\r\n    };\r\n    window.addEventListener('unlock:change', unlockHandler, { passive: true });\r\n    addDebugPanelCleanup(() => window.removeEventListener('unlock:change', unlockHandler));\r\n\r\n    const workshopHandler = (event) => {\r\n        const { slot } = event?.detail ?? {};\r\n        const targetSlot = slot ?? getActiveSlot();\r\n        refreshLiveBindings((binding) => binding.type === 'workshop-level'\r\n            && binding.slot === targetSlot);\r\n    };\r\n    window.addEventListener('workshop:change', workshopHandler, { passive: true });\r\n    addDebugPanelCleanup(() => window.removeEventListener('workshop:change', workshopHandler));\r\n}\r\n\r\nconst XP_KEY_PREFIX = 'ccc:xp';\r\nconst XP_KEYS = {\r\n    unlock: (slot) => `${XP_KEY_PREFIX}:unlocked:${slot}`,\r\n    level:  (slot) => `${XP_KEY_PREFIX}:level:${slot}`,\r\n    progress: (slot) => `${XP_KEY_PREFIX}:progress:${slot}`,\r\n};\r\n\r\nconst MUTATION_KEY_PREFIX = 'ccc:mutation';\r\nconst MUTATION_KEYS = {\r\n    unlock: (slot) => `${MUTATION_KEY_PREFIX}:unlocked:${slot}`,\r\n    level:  (slot) => `${MUTATION_KEY_PREFIX}:level:${slot}`,\r\n    progress: (slot) => `${MUTATION_KEY_PREFIX}:progress:${slot}`,\r\n};\r\n\r\nconst STAT_MULTIPLIERS = [\r\n    { key: 'spawnRate', label: 'Spawn Rate' },\r\n    { key: 'xp', label: 'XP' },\r\n    { key: 'mutation', label: 'MP' },\r\n];\r\n\r\nfunction getAreas() {\r\n    return [\r\n        {\r\n            key: AREA_KEYS.STARTER_COVE,\r\n            title: 'The Cove',\r\n            currencies: [\r\n                { key: CURRENCIES.COINS, label: 'Coins' },\r\n                { key: CURRENCIES.BOOKS, label: 'Books' },\r\n                { key: CURRENCIES.GOLD,  label: 'Gold'  },\r\n                { key: CURRENCIES.MAGIC, label: 'Magic' },\r\n                { key: CURRENCIES.GEARS, label: 'Gears' },\r\n                { key: CURRENCIES.WAVES, label: 'Waves' },\r\n            ],\r\n            stats: [\r\n                { key: 'spawnRate', label: 'Spawn Rate' },\r\n                { key: 'xp', label: 'XP' },\r\n                { key: 'mutation', label: 'MP' },\r\n            ],\r\n        },\r\n    ];\r\n}\r\n\r\n\r\nfunction ensureDebugPanelStyles() {\r\n    if (document.getElementById(DEBUG_PANEL_STYLE_ID)) return;\r\n\r\n    const existingLink = document.querySelector(`link[href$=\"css/misc/debug.css\"]`);\r\n    if (existingLink) {\r\n        existingLink.id = DEBUG_PANEL_STYLE_ID;\r\n        return;\r\n    }\r\n\r\n    const bundledStylesheet = document.querySelector('link[href$=\"styles.css\"]');\r\n    if (bundledStylesheet) {\r\n        const marker = document.createElement('meta');\r\n        marker.id = DEBUG_PANEL_STYLE_ID;\r\n        marker.setAttribute('data-debug-panel-styles', 'bundled');\r\n        document.head.appendChild(marker);\r\n        return;\r\n    }\r\n\r\n    const link = document.createElement('link');\r\n    link.rel = 'stylesheet';\r\n    link.href = 'css/misc/debug.css';\r\n    link.id = DEBUG_PANEL_STYLE_ID;\r\n    document.head.appendChild(link);\r\n}\r\n\r\nfunction removeDebugPanelToggleButton() {\r\n    const existingButton = document.getElementById(DEBUG_PANEL_TOGGLE_ID);\r\n    if (existingButton) existingButton.remove();\r\n}\r\n\r\nfunction shouldShowDebugPanelToggleButton() {\r\n    return debugPanelAccess\r\n        && IS_MOBILE\r\n        && getActiveSlot() != null\r\n        && !isOnMenu()\r\n        && isGameVisible();\r\n}\r\n\r\nfunction onMenuVisibilityChange(event) {\r\n    if (event?.detail?.visible) {\r\n        closeDebugPanel();\r\n    }\r\n    createDebugPanelToggleButton();\r\n}\r\n\r\nfunction createSection(title, contentId, contentBuilder) {\r\n    const section = document.createElement('div');\r\n    section.className = 'debug-panel-section';\r\n\r\n    const toggle = document.createElement('button');\r\n    toggle.className = 'debug-panel-section-toggle';\r\n    toggle.type = 'button';\r\n    toggle.textContent = title;\r\n    const stateKey = contentId || `${title}-${sectionKeyCounter++}`;\r\n    toggle.dataset.sectionKey = stateKey;\r\n    section.appendChild(toggle);\r\n\r\n    const content = document.createElement('div');\r\n    content.className = 'debug-panel-section-content';\r\n    content.id = contentId;\r\n    content.dataset.sectionKey = stateKey;\r\n    contentBuilder(content);\r\n    section.appendChild(content);\r\n\r\n    let lastPointerType = null;\r\n\r\n    const handleToggle = (event) => {\r\n        const expanded = toggle.classList.toggle('expanded');\r\n        content.classList.toggle('active', expanded);\r\n    };\r\n\r\n    toggle.addEventListener('click', (event) => {\r\n        if (lastPointerType && lastPointerType !== 'mouse') {\r\n            lastPointerType = null;\r\n            return;\r\n        }\r\n        lastPointerType = null;\r\n        handleToggle(event);\r\n    });\r\n\r\n    return section;\r\n}\r\n\r\nfunction createSubsection(title, contentBuilder, { defaultExpanded = false } = {}) {\r\n    const container = document.createElement('div');\r\n    container.className = 'debug-panel-subsection';\r\n\r\n    const toggle = document.createElement('button');\r\n    toggle.type = 'button';\r\n    toggle.className = 'debug-panel-subsection-toggle';\r\n    toggle.textContent = title;\r\n    const stateKey = `${title}-${subsectionKeyCounter++}`;\r\n    toggle.dataset.subsectionKey = stateKey;\r\n    container.appendChild(toggle);\r\n\r\n    const content = document.createElement('div');\r\n    content.className = 'debug-panel-subsection-content';\r\n    content.dataset.subsectionKey = stateKey;\r\n    contentBuilder(content);\r\n    container.appendChild(content);\r\n\r\n    let lastPointerType = null;\r\n\r\n    const handleToggle = (event) => {\r\n        const expanded = toggle.classList.toggle('expanded');\r\n        content.classList.toggle('active', expanded);\r\n    };\r\n\r\n    toggle.addEventListener('click', (event) => {\r\n        if (lastPointerType && lastPointerType !== 'mouse') {\r\n            lastPointerType = null;\r\n            return;\r\n        }\r\n        lastPointerType = null;\r\n        handleToggle(event);\r\n    });\r\n\r\n    if (defaultExpanded) {\r\n        toggle.classList.add('expanded');\r\n        content.classList.add('active');\r\n    }\r\n\r\n    return container;\r\n}\r\n\r\nfunction bigNumEquals(a, b) {\r\n    if (a === b) return true;\r\n    if (a == null || b == null) return a == null && b == null;\r\n    if (typeof a?.cmp === 'function') {\r\n        try { return a.cmp(b) === 0; } catch {}\r\n    }\r\n    if (typeof b?.cmp === 'function') {\r\n        try { return b.cmp(a) === 0; } catch {}\r\n    }\r\n    try { return Object.is(String(a), String(b)); }\r\n    catch { return false; }\r\n}\r\n\r\nfunction bigNumToFiniteNumber(value) {\r\n    try {\r\n        const fromScientific = value?.toScientific?.(18);\r\n        const num = Number.parseFloat(fromScientific ?? value);\r\n        return Number.isFinite(num) ? num : Number.NaN;\r\n    } catch {\r\n        return Number.NaN;\r\n    }\r\n}\r\n\r\nfunction getCurrencyStorageKey(currencyKey, slot = getActiveSlot()) {\r\n    const resolvedSlot = slot ?? getActiveSlot();\r\n    if (resolvedSlot == null) return null;\r\n    return `${KEYS.CURRENCY[currencyKey]}:${resolvedSlot}`;\r\n}\r\n\r\nfunction getCurrencyValueForSlot(currencyKey, slot = getActiveSlot()) {\r\n    const resolvedSlot = slot ?? getActiveSlot();\r\n    if (resolvedSlot == null) return BigNum.fromInt(0);\r\n\r\n    const handle = bank?.[currencyKey];\r\n    if (handle) {\r\n        try { return handle.value ?? BigNum.fromInt(0); }\r\n        catch {}\r\n    }\r\n\r\n    try { return peekCurrency(resolvedSlot, currencyKey); }\r\n    catch { return BigNum.fromInt(0); }\r\n}\r\n\r\nfunction applyCurrencyState(currencyKey, value, slot = getActiveSlot()) {\r\n    const resolvedSlot = slot ?? getActiveSlot();\r\n    const previous = getCurrencyValueForSlot(currencyKey, resolvedSlot);\r\n    if (resolvedSlot == null || resolvedSlot !== getActiveSlot()) {\r\n        return { previous, next: previous };\r\n    }\r\n\r\n    const storageKey = getCurrencyStorageKey(currencyKey, resolvedSlot);\r\n    const wasLocked = storageKey && isStorageKeyLocked(storageKey);\r\n\r\n    if (wasLocked) unlockStorageKey(storageKey);\r\n\r\n    let next = previous;\r\n    try {\r\n        markSaveSlotModified(resolvedSlot);\r\n        const effective = setCurrency(currencyKey, value, { previous });\r\n        next = effective ?? previous;\r\n        if (storageKey) primeStorageWatcherSnapshot(storageKey);\r\n    } catch {}\r\n    finally {\r\n        if (wasLocked) lockStorageKey(storageKey);\r\n    }\r\n\r\n    refreshLiveBindings((binding) => binding.type === 'currency'\r\n        && binding.key === currencyKey\r\n        && binding.slot === resolvedSlot);\r\n\r\n    return { previous, next };\r\n}\r\n\r\nfunction buildOverrideKey(slot, key) {\r\n    return `${slot ?? 'null'}::${key}`;\r\n}\r\n\r\nfunction getCurrencyOverride(slot, key) {\r\n    return currencyOverrides.get(buildOverrideKey(slot, key)) ?? null;\r\n}\r\n\r\nfunction getCurrencyMultiplierStorageKey(currencyKey, slot = getActiveSlot()) {\r\n    const resolvedSlot = slot ?? getActiveSlot();\r\n    if (!currencyKey || resolvedSlot == null) return null;\r\n    return `${KEYS.MULTIPLIER[currencyKey]}:${resolvedSlot}`;\r\n}\r\n\r\nfunction isCurrencyMultiplierLocked(currencyKey, slot = getActiveSlot()) {\r\n    return isStorageKeyLocked(getCurrencyMultiplierStorageKey(currencyKey, slot));\r\n}\r\n\r\nfunction clearCurrencyMultiplierOverride(currencyKey, slot = getActiveSlot()) {\r\n    const cacheKey = buildOverrideKey(slot, currencyKey);\r\n    currencyOverrides.delete(cacheKey);\r\n    currencyOverrideBaselines.delete(cacheKey);\r\n    refreshLiveBindings((binding) => binding.type === 'currency-mult'\r\n        && binding.key === currencyKey\r\n        && binding.slot === slot);\r\n}\r\n\r\nfunction getStatOverride(slot, key) {\r\n    const lockAwareRefresh = !isStatMultiplierLocked(key, slot);\r\n    const cacheKey = buildOverrideKey(slot, key);\r\n    const cached = statOverrides.get(cacheKey);\r\n    if (!lockAwareRefresh && cached) return cached;\r\n\r\n    const fromStorage = loadStatMultiplierOverrideFromStorage(key, slot);\r\n    if (!fromStorage) {\r\n        if (lockAwareRefresh) statOverrides.delete(cacheKey);\r\n        return null;\r\n    }\r\n\r\n    statOverrides.set(cacheKey, fromStorage);\r\n    return fromStorage;\r\n}\r\n\r\nfunction notifyStatMultiplierChange(statKey, slot) {\r\n    refreshLiveBindings((binding) => binding.type === 'stat-mult'\r\n        && binding.key === statKey\r\n        && binding.slot === slot);\r\n}\r\n\r\nfunction clearStatMultiplierOverride(statKey, slot = getActiveSlot()) {\r\n    const storageKey = getStatMultiplierStorageKey(statKey, slot);\r\n    statOverrides.delete(buildOverrideKey(slot, statKey));\r\n    statOverrideBaselines.delete(buildOverrideKey(slot, statKey));\r\n    if (!storageKey || typeof localStorage === 'undefined') return;\r\n    if (isStorageKeyLocked(storageKey)) return;\r\n    try { localStorage.removeItem(storageKey); } catch {}\r\n    notifyStatMultiplierChange(statKey, slot);\r\n}\r\n\r\nfunction isStatMultiplierLocked(statKey, slot = getActiveSlot()) {\r\n    return isStorageKeyLocked(getStatMultiplierStorageKey(statKey, slot));\r\n}\r\n\r\nfunction getLockedStatOverride(slot, statKey) {\r\n    if (!isStatMultiplierLocked(statKey, slot)) return null;\r\n    return getStatOverride(slot, statKey);\r\n}\r\n\r\nfunction getStatMultiplierDisplayValue(statKey, slot = getActiveSlot()) {\r\n    const gameValue = getGameStatMultiplier(statKey);\r\n    const effectiveOverride = getEffectiveStatMultiplierOverride(statKey, slot, gameValue);\r\n    return effectiveOverride ?? gameValue;\r\n}\r\n\r\nfunction getStatMultiplierStorageKey(statKey, slot = getActiveSlot()) {\r\n    if (!statKey) return null;\r\n    const resolvedSlot = slot ?? getActiveSlot();\r\n    if (resolvedSlot == null) return null;\r\n    return `${STAT_MULTIPLIER_STORAGE_PREFIX}:${statKey}:${resolvedSlot}`;\r\n}\r\n\r\nfunction getGameStatMultiplier(statKey) {\r\n    try {\r\n        if (statKey === 'xp') {\r\n            const mult = getXpGainMultiplier();\r\n            if (mult) return mult;\r\n        } else if (statKey === 'mutation') {\r\n            const valueMult = getMpValueMultiplierBn?.();\r\n            if (valueMult) return valueMult;\r\n\r\n            const mult = getMutationMultiplier();\r\n            if (mult) return mult;\r\n        } else if (statKey === 'spawnRate') {\r\n            const eff = computeUpgradeEffects(AREA_KEYS.STARTER_COVE);\r\n            if (eff?.coinsPerSecondMult) {\r\n                return BigNum.fromAny(eff.coinsPerSecondMult);\r\n            }\r\n        }\r\n    } catch {}\r\n\r\n    return BigNum.fromInt(1);\r\n}\r\n\r\nfunction loadStatMultiplierOverrideFromStorage(statKey, slot = getActiveSlot()) {\r\n    const storageKey = getStatMultiplierStorageKey(statKey, slot);\r\n    if (!storageKey || typeof localStorage === 'undefined') return null;\r\n    const raw = localStorage.getItem(storageKey);\r\n    if (!raw) return null;\r\n    try { return BigNum.fromAny(raw); }\r\n    catch { return null; }\r\n}\r\n\r\nfunction storeStatMultiplierOverride(statKey, slot, value) {\r\n    const storageKey = getStatMultiplierStorageKey(statKey, slot);\r\n    if (!storageKey || typeof localStorage === 'undefined') return;\r\n    try {\r\n        const bn = value instanceof BigNum ? value : BigNum.fromAny(value ?? 1);\r\n        const locked = isStorageKeyLocked(storageKey);\r\n        const setter = locked && originalSetItem ? originalSetItem : localStorage.setItem.bind(localStorage);\r\n        if (locked && !originalSetItem) unlockStorageKey(storageKey);\r\n        setter(storageKey, bn.toStorage?.() ?? String(bn));\r\n        if (locked && !originalSetItem) lockStorageKey(storageKey);\r\n    } catch {}\r\n}\r\n\r\nfunction applyCurrencyOverrideForSlot(currencyKey, slot = getActiveSlot()) {\r\n    if (slot == null) return;\r\n    const override = getCurrencyOverride(slot, currencyKey);\r\n    if (!override) return;\r\n    if (slot !== getActiveSlot()) return;\r\n\r\n    const cacheKey = buildOverrideKey(slot, currencyKey);\r\n    if (currencyOverrideApplications.has(cacheKey)) return;\r\n\r\n    currencyOverrideApplications.add(cacheKey);\r\n    try {\r\n        const current = bank?.[currencyKey]?.mult?.get?.();\r\n        if (!bigNumEquals(current, override)) {\r\n            bank?.[currencyKey]?.mult?.set?.(override);\r\n        }\r\n    } catch {} finally {\r\n        currencyOverrideApplications.delete(cacheKey);\r\n    }\r\n}\r\n\r\nlet currencyListenerAttached = false;\r\nfunction ensureCurrencyOverrideListener() {\r\n    if (currencyListenerAttached || typeof window === 'undefined') return;\r\n    currencyListenerAttached = true;\r\n    try {\r\n        window.addEventListener('currency:multiplier', (event) => {\r\n            const { key, slot, mult } = event?.detail ?? {};\r\n            const targetSlot = slot ?? getActiveSlot();\r\n            const cacheKey = buildOverrideKey(targetSlot, key);\r\n            if (!targetSlot || !currencyOverrides.has(cacheKey)) return;\r\n            if (currencyOverrideApplications.has(cacheKey)) return;\r\n\r\n            const baseline = currencyOverrideBaselines.get(cacheKey);\r\n            const override = getCurrencyOverride(targetSlot, key);\r\n\r\n            if (baseline && override && mult) {\r\n                try {\r\n                    // Fix: Use BigNum div instead of native division for ratio calculation\r\n                    // This handles numbers > 1.8e308 correctly.\r\n                    const baselineBn = BigNum.fromAny(baseline);\r\n                    const nextBn = BigNum.fromAny(mult);\r\n                    \r\n                    if (!baselineBn.isZero()) {\r\n                        const ratio = nextBn.div(baselineBn);\r\n                        // If ratio != 1 (ignoring exact equality check for simplicity, or we can check via cmp)\r\n                        // A ratio of exactly 1 means no change, so we can skip scaling.\r\n                        const ratioNum = ratio.sig === 1n && ratio.e === 0 && ratio._eOffset === 0n \r\n                                         ? 1 \r\n                                         : null; // dummy check, actually just multiply.\r\n                        \r\n                        // Just apply the ratio. If it's 1, mulDecimal(1) or mulBigNum(1) is safe.\r\n                        // Wait, mulDecimal takes number/string. mulBigNum takes BigNum.\r\n                        // Let's use mulBigNumInteger if ratio is integer? No, ratio is likely decimal.\r\n                        // BigNum doesn't have mulBigNumDecimal yet?\r\n                        // Wait, `div` returns a BigNum.\r\n                        // `override` is a BigNum.\r\n                        // We need `override * ratio`.\r\n                        // BigNum has `mulBigNumInteger`. It does NOT have `mulBigNum`.\r\n                        // But `mulBigNumInteger` logic:\r\n                        // return new BigNum(this.sig * b.sig, { base: baseSum, offset: offsetSum }, this.p);\r\n                        // This logic is generic! It multiplies two BigNums.\r\n                        // The method name says \"Integer\" but the implementation supports exponents.\r\n                        // Let's verify BigNum.js implementation of mulBigNumInteger:\r\n                        // const baseSum = this.e + b.e;\r\n                        // const offsetSum = this._eOffset + b._eOffset;\r\n                        // return new BigNum(this.sig * b.sig, { base: baseSum, offset: offsetSum }, this.p);\r\n                        // Yes, this is correct for ANY BigNum multiplication.\r\n                        \r\n                        const scaledOverride = override.mulBigNumInteger(ratio);\r\n                        currencyOverrides.set(cacheKey, scaledOverride);\r\n                    }\r\n                } catch (e) {\r\n                     // fallback or ignore\r\n                }\r\n\r\n                currencyOverrideBaselines.set(cacheKey, mult);\r\n            } else if (mult) {\r\n                currencyOverrideBaselines.set(cacheKey, mult);\r\n            }\r\n\r\n            applyCurrencyOverrideForSlot(key, targetSlot);\r\n        }, { passive: true });\r\n        window.addEventListener('saveSlot:change', () => {\r\n            applyAllCurrencyOverridesForActiveSlot();\r\n        }, { passive: true });\r\n    } catch {}\r\n}\r\n\r\nexport function applyAllCurrencyOverridesForActiveSlot() {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) return;\r\n    Object.values(CURRENCIES).forEach((key) => {\r\n        applyCurrencyOverrideForSlot(key, slot);\r\n    });\r\n}\r\n\r\nexport function setDebugCurrencyMultiplierOverride(currencyKey, value, slot = getActiveSlot()) {\r\n    if (!currencyKey || slot == null) return null;\r\n    ensureCurrencyOverrideListener();\r\n    let bn;\r\n    try { bn = value instanceof BigNum ? value.clone?.() ?? value : BigNum.fromAny(value ?? 1); }\r\n    catch { bn = BigNum.fromInt(1); }\r\n    const cacheKey = buildOverrideKey(slot, currencyKey);\r\n    currencyOverrides.set(cacheKey, bn);\r\n    \r\n    // Fix: Only set the baseline if it's not already set.\r\n    // If we overwrite the baseline with the current bank value (which might be the OLD override),\r\n    // we create a feedback loop that crushes the value when the game ticks.\r\n    if (!currencyOverrideBaselines.has(cacheKey)) {\r\n        const gameValue = bank?.[currencyKey]?.mult?.get?.();\r\n        currencyOverrideBaselines.set(cacheKey, gameValue);\r\n    }\r\n    \r\n    applyCurrencyOverrideForSlot(currencyKey, slot);\r\n    return bn;\r\n}\r\n\r\n\r\nexport function getDebugCurrencyMultiplierOverride(currencyKey, slot = getActiveSlot()) {\r\n    if (!currencyKey || slot == null) return null;\r\n    return getCurrencyOverride(slot, currencyKey);\r\n}\r\n\r\nexport function setDebugStatMultiplierOverride(statKey, value, slot = getActiveSlot()) {\r\n    if (!statKey || slot == null) return null;\r\n    let bn;\r\n    try { bn = value instanceof BigNum ? value.clone?.() ?? value : BigNum.fromAny(value ?? 1); }\r\n    catch { bn = BigNum.fromInt(1); }\r\n    statOverrides.set(buildOverrideKey(slot, statKey), bn);\r\n    statOverrideBaselines.set(buildOverrideKey(slot, statKey), getGameStatMultiplier(statKey));\r\n    storeStatMultiplierOverride(statKey, slot, bn);\r\n    notifyStatMultiplierChange(statKey, slot);\r\n    return bn;\r\n}\r\n\r\nexport function getDebugStatMultiplierOverride(statKey, slot = getActiveSlot()) {\r\n    if (!statKey || slot == null) return null;\r\n    return getStatOverride(slot, statKey);\r\n}\r\n\r\nexport function applyStatMultiplierOverride(statKey, amount, slot = getActiveSlot()) {\r\n    const gameValue = getGameStatMultiplier(statKey);\r\n    const override = getEffectiveStatMultiplierOverride(statKey, slot, gameValue);\r\n    if (!override) return amount;\r\n\r\n    let base;\r\n    try {\r\n        base = amount instanceof BigNum ? amount.clone?.() ?? amount : BigNum.fromAny(amount ?? 0);\r\n    } catch {\r\n        return amount;\r\n    }\r\n\r\n    // If the caller is passing the raw in-game multiplier itself (e.g. XP Value,\r\n    // MP Value, etc.), avoid ratio math and just return the override directly.\r\n    try {\r\n        if (bigNumEquals(base, gameValue)) {\r\n            return override;\r\n        }\r\n    } catch {\r\n        // fall through and apply ratio logic below\r\n    }\r\n\r\n    try {\r\n        if (base.isZero?.()) return base;\r\n    } catch {\r\n        return base;\r\n    }\r\n\r\n    const cacheKey = buildOverrideKey(slot, statKey);\r\n    const baseline = statOverrideBaselines.get(cacheKey);\r\n    const multiplierForRatio =\r\n        (isStatMultiplierLocked(statKey, slot) && baseline) ? baseline : gameValue;\r\n\r\n    // Fix: Use BigNum div instead of converting to finite numbers\r\n    let ratio = null;\r\n    try {\r\n         const numBn = BigNum.fromAny(override);\r\n         const denomBn = BigNum.fromAny(multiplierForRatio);\r\n         if (!denomBn.isZero()) {\r\n             ratio = numBn.div(denomBn);\r\n         }\r\n    } catch (e) {\r\n        ratio = null;\r\n    }\r\n\r\n    if (ratio) {\r\n        try { \r\n            // mulBigNumInteger supports generic BigNum multiplication\r\n            return base.mulBigNumInteger(ratio); \r\n        }\r\n        catch {}\r\n    }\r\n\r\n    return base;\r\n}\r\n\r\nfunction getEffectiveStatMultiplierOverride(statKey, slot, gameValue) {\r\n    const override = getStatOverride(slot, statKey);\r\n    const cacheKey = buildOverrideKey(slot, statKey);\r\n    if (!override) {\r\n        statOverrideBaselines.delete(cacheKey);\r\n        return null;\r\n    }\r\n\r\n    const baseline = statOverrideBaselines.get(cacheKey);\r\n    const locked = isStatMultiplierLocked(statKey, slot);\r\n\r\n    if (!baseline) {\r\n        statOverrideBaselines.set(cacheKey, gameValue);\r\n    } else if (!bigNumEquals(baseline, gameValue)) {\r\n        if (locked) {\r\n            statOverrideBaselines.set(cacheKey, gameValue);\r\n            return override;\r\n        }\r\n        clearStatMultiplierOverride(statKey, slot);\r\n        return null;\r\n    }\r\n\r\n    return override;\r\n}\r\n\r\nfunction ensureStorageLockPatch() {\r\n    if (storageLockPatched || typeof localStorage === 'undefined') return;\r\n    storageLockPatched = true;\r\n    try {\r\n        originalSetItem = localStorage.setItem.bind(localStorage);\r\n        originalRemoveItem = localStorage.removeItem.bind(localStorage);\r\n        localStorage.setItem = (key, value) => {\r\n            if (lockedStorageKeys.has(key)) return;\r\n            return originalSetItem(key, value);\r\n        };\r\n        localStorage.removeItem = (key) => {\r\n            if (lockedStorageKeys.has(key)) return;\r\n            return originalRemoveItem(key);\r\n        };\r\n    } catch {}\r\n}\r\n\r\nfunction isStorageKeyLocked(key) {\r\n    return key != null && lockedStorageKeys.has(key);\r\n}\r\n\r\nfunction lockStorageKey(key) {\r\n    if (!key) return;\r\n    ensureStorageLockPatch();\r\n    lockedStorageKeys.add(key);\r\n}\r\n\r\nfunction unlockStorageKey(key) {\r\n    if (!key) return;\r\n    lockedStorageKeys.delete(key);\r\n}\r\n\r\nfunction toggleStorageLock(key) {\r\n    if (!key) return false;\r\n    if (isStorageKeyLocked(key)) {\r\n        unlockStorageKey(key);\r\n        return false;\r\n    }\r\n    lockStorageKey(key);\r\n    return true;\r\n}\r\n\r\nfunction createLockToggle(storageKey, { onToggle } = {}) {\r\n    const button = document.createElement('button');\r\n    button.type = 'button';\r\n    button.className = 'debug-lock-button';\r\n\r\n    const refresh = () => {\r\n        const locked = isStorageKeyLocked(storageKey);\r\n        button.textContent = locked ? 'L' : 'UL';\r\n        button.classList.toggle('locked', locked);\r\n    };\r\n\r\n    button.addEventListener('click', () => {\r\n        toggleStorageLock(storageKey);\r\n        if (typeof onToggle === 'function') {\r\n            try { onToggle(isStorageKeyLocked(storageKey)); }\r\n            catch {}\r\n        }\r\n        refresh();\r\n    });\r\n\r\n    refresh();\r\n    return { button, refresh };\r\n}\r\n\r\nfunction createCompositeLockToggle(resolveKeys, { onToggle } = {}) {\r\n    const button = document.createElement('button');\r\n    button.type = 'button';\r\n    button.className = 'debug-lock-button';\r\n\r\n    const getKeys = () =>\r\n        Array.from(new Set((resolveKeys?.() ?? []).filter(Boolean)));\r\n\r\n    const isLocked = () => {\r\n        const keys = getKeys();\r\n        return keys.length > 0 && keys.every((key) => isStorageKeyLocked(key));\r\n    };\r\n\r\n    const hasAnyLocked = () => {\r\n        const keys = getKeys();\r\n        return keys.length > 0 && keys.some((key) => isStorageKeyLocked(key));\r\n    };\r\n\r\n    const refresh = () => {\r\n        const keys = getKeys();\r\n        const anyLocked = hasAnyLocked();\r\n        button.textContent = anyLocked ? 'L' : 'UL';\r\n        button.classList.toggle('locked', anyLocked);\r\n        button.disabled = keys.length === 0;\r\n    };\r\n\r\n    button.addEventListener('click', () => {\r\n        const keys = getKeys();\r\n        if (keys.length === 0) return;\r\n\r\n        const locked = isLocked();\r\n        keys.forEach((key) => {\r\n            if (locked) {\r\n                unlockStorageKey(key);\r\n            } else {\r\n                lockStorageKey(key);\r\n            }\r\n        });\r\n\r\n        if (typeof onToggle === 'function') {\r\n            try { onToggle(isLocked()); }\r\n            catch {}\r\n        }\r\n\r\n        refresh();\r\n    });\r\n\r\n    refresh();\r\n    return { button, refresh, isLocked };\r\n}\r\n\r\napplyAllCurrencyOverridesForActiveSlot();\r\nensureCurrencyOverrideListener();\r\n\r\nfunction collapseAllDebugCategories() {\r\n    const panel = document.getElementById(DEBUG_PANEL_ID);\r\n    if (!panel) return;\r\n\r\n    panel.querySelectorAll('.debug-panel-section-toggle').forEach((toggle) => {\r\n        toggle.classList.remove('expanded');\r\n        const content = toggle.nextElementSibling;\r\n        if (content) content.classList.remove('active');\r\n    });\r\n\r\n    panel.querySelectorAll('.debug-panel-subsection-toggle').forEach((toggle) => {\r\n        toggle.classList.remove('expanded');\r\n        const content = toggle.nextElementSibling;\r\n        if (content) content.classList.remove('active');\r\n    });\r\n}\r\n\r\nfunction withTemporaryUnlock(keys, fn) {\r\n    const uniqueKeys = Array.from(new Set((keys ?? []).filter(Boolean)));\r\n    const relock = [];\r\n\r\n    uniqueKeys.forEach((key) => {\r\n        if (isStorageKeyLocked(key)) {\r\n            relock.push(key);\r\n            unlockStorageKey(key);\r\n        }\r\n    });\r\n\r\n    try {\r\n        return fn?.();\r\n    } finally {\r\n        relock.forEach((key) => lockStorageKey(key));\r\n    }\r\n}\r\n\r\nfunction formatBigNumForInput(value) {\r\n    try {\r\n        const bn = value instanceof BigNum ? value : BigNum.fromAny(value ?? 0);\r\n        if (bn.isInfinite?.()) {\r\n            const precision = Number.parseInt(bn?.p, 10) || BigNum.DEFAULT_PRECISION;\r\n            return `BN:${precision}:1:${BigNum.MAX_E}`;\r\n        }\r\n        const storage = bn.toStorage?.();\r\n        const [, pStr = `${BigNum.DEFAULT_PRECISION}`, sigPart = '0', expPart = '0'] = (storage || '').split(':');\r\n        const precision = Number.parseInt(pStr, 10) || BigNum.DEFAULT_PRECISION;\r\n        if (bn.isZero?.()) {\r\n            return `BN:${precision}:${'0'.repeat(precision)}:-17`;\r\n        }\r\n        const paddedSig = sigPart.padStart(precision, '0');\r\n        return `BN:${precision}:${paddedSig}:${expPart}`;\r\n    } catch {\r\n        return String(value ?? '');\r\n    }\r\n}\r\n\r\nfunction parseBigNumInput(raw) {\r\n    const trimmed = String(raw ?? '').trim();\r\n    if (!trimmed) return BigNum.fromInt(0);\r\n    try {\r\n        if (/^inf(?:inity)?$/i.test(trimmed)) {\r\n            return BigNum.fromAny('Infinity');\r\n        }\r\n        return BigNum.fromAny(trimmed);\r\n    } catch {\r\n        return null;\r\n    }\r\n}\r\n\r\nfunction setInputValidity(input, valid) {\r\n    input.classList.toggle('debug-invalid', !valid);\r\n}\r\n\r\nfunction flagDebugUsage() {\r\n    const slot = getActiveSlot();\r\n    try { markSaveSlotModified(slot); }\r\n    catch {}\r\n    try { window.dispatchEvent(new CustomEvent('debug:change', { detail: { slot } })); }\r\n    catch {}\r\n}\r\n\r\nfunction getActionLogKey(slot = getActiveSlot()) {\r\n    if (slot == null) return null;\r\n    return `${ACTION_LOG_STORAGE_PREFIX}:${slot}`;\r\n}\r\n\r\nfunction getCurrentActionLog(slot = getActiveSlot()) {\r\n    const key = getActionLogKey(slot);\r\n    if (!key) return [];\r\n\r\n    let raw = null;\r\n    try { raw = localStorage.getItem(key); }\r\n    catch {}\r\n    if (!raw) return [];\r\n\r\n    try {\r\n        const parsed = JSON.parse(raw);\r\n        return Array.isArray(parsed) ? parsed : [];\r\n    } catch {\r\n        return [];\r\n    }\r\n}\r\n\r\nfunction persistActionLog(entries, slot = getActiveSlot()) {\r\n    const key = getActionLogKey(slot);\r\n    if (!key || typeof localStorage === 'undefined') return;\r\n\r\n    const trimmed = (Array.isArray(entries) ? entries : []).slice(0, MAX_ACTION_LOG_ENTRIES);\r\n    try { localStorage.setItem(key, JSON.stringify(trimmed)); }\r\n    catch {}\r\n}\r\n\r\nfunction appendActionLogEntry(entry, slot = getActiveSlot()) {\r\n    const log = getCurrentActionLog(slot);\r\n    log.unshift(entry);\r\n    if (log.length > MAX_ACTION_LOG_ENTRIES) {\r\n        log.length = MAX_ACTION_LOG_ENTRIES;\r\n    }\r\n    persistActionLog(log, slot);\r\n    return log;\r\n}\r\n\r\nfunction logAction(message) {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) return;\r\n\r\n    const now = new Date();\r\n    const entry = {\r\n        time: now.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit', hour12: true }),\r\n        message,\r\n        timestamp: now.getTime(),\r\n    };\r\n    appendActionLogEntry(entry, slot);\r\n    updateActionLogDisplay();\r\n}\r\n\r\nfunction updateActionLogDisplay() {\r\n    if (!actionLogContainer) return;\r\n\r\n    const actionLog = getCurrentActionLog();\r\n    if (actionLog.length === 0) {\r\n        actionLogContainer.innerHTML = '';\r\n        const msg = document.createElement('div');\r\n        msg.className = 'action-log-empty';\r\n        msg.textContent = 'Actions you perform in the Debug Panel will be logged permanently in this action log.';\r\n        actionLogContainer.appendChild(msg);\r\n        return;\r\n    }\r\n\r\n    actionLogContainer.innerHTML = actionLog.map((entry) => {\r\n        const formattedTime = String(entry.time ?? '').replace(/^0(\\d)/, '$1');\r\n        let formattedMessage = entry.message?.replace?.(/\\[GOLD\\](.*?)\\[\\/GOLD\\]/g, '<span class=\"action-log-gold\">$1</span>') ?? '';\r\n        formattedMessage = formattedMessage.replace(/\\b(?:Level|Lv)\\s?(\\d+)\\b/g, '<span class=\"action-log-level\">Lv$1</span>');\r\n        formattedMessage = formattedMessage.replace(/(\\d[\\d,.]*(?:e[+-]?\\d+)*(?:[KMBTQa-zA-Z]*))/g, (match) => /\\d/.test(match) ? `<span class=\"action-log-number\">${match}</span>` : match);\r\n        formattedMessage = formattedMessage.replace(/<span[^>]*class=\"[^\"]*infinity-symbol[^\"]*\"[^>]*>\\u221E<\\/span>/g, '<span class=\"action-log-number\">inf</span>');\r\n        formattedMessage = formattedMessage.replace(/\\u221E/g, '<span class=\"action-log-number\">inf</span>');\r\n\r\n        return `<div class=\"action-log-entry\"><span class=\"action-log-time\">${formattedTime}:</span><span class=\"action-log-message\">${formattedMessage}</span></div>`;\r\n    }).join('');\r\n}\r\n\r\nfunction dialogueStateStorageKey(slot = getActiveSlot()) {\r\n    if (slot == null) return null;\r\n    return `${MERCHANT_DLG_STATE_KEY_BASE}:${slot}`;\r\n}\r\n\r\nfunction persistDialogueState(state, slot = getActiveSlot()) {\r\n    const key = dialogueStateStorageKey(slot);\r\n    if (!key) return;\r\n    try {\r\n        const payload = JSON.stringify(state || {});\r\n        localStorage.setItem(key, payload);\r\n    } catch {}\r\n}\r\n\r\nfunction loadDialogueState(slot = getActiveSlot()) {\r\n    const key = dialogueStateStorageKey(slot);\r\n    if (!key) return {};\r\n    try {\r\n        const raw = localStorage.getItem(key);\r\n        return raw ? JSON.parse(raw) : {};\r\n    } catch {\r\n        return {};\r\n    }\r\n}\r\n\r\nfunction grantDialogueReward(reward) {\r\n    if (!reward) return;\r\n    if (reward.type === 'coins') {\r\n        try { bank.coins.add(reward.amount); }\r\n        catch (e) { console.warn('Failed to grant coin reward:', reward, e); }\r\n        return;\r\n    }\r\n    if (reward.type === 'books') {\r\n        try {\r\n            bank.books.addWithMultiplier?.(reward.amount) ?? bank.books.add(reward.amount);\r\n        } catch (e) {\r\n            console.warn('Failed to grant book reward:', reward, e);\r\n        }\r\n        return;\r\n    }\r\n    try { window.dispatchEvent(new CustomEvent('merchantReward', { detail: reward })); }\r\n    catch {}\r\n}\r\n\r\nfunction completeAllDialoguesForDebug() {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) return { completed: 0 };\r\n\r\n    const state = loadDialogueState(slot);\r\n    let completed = 0;\r\n\r\n    Object.entries(DLG_CATALOG).forEach(([id, meta]) => {\r\n        const key = String(id);\r\n        const prev = state[key] || {};\r\n        const alreadyClaimed = !!prev.claimed;\r\n        const next = Object.assign({}, prev, { status: 'unlocked', claimed: true });\r\n        state[key] = next;\r\n        if (!alreadyClaimed) {\r\n            completed += 1;\r\n            grantDialogueReward(meta.reward);\r\n        }\r\n    });\r\n\r\n    persistDialogueState(state, slot);\r\n    return { completed };\r\n}\r\n\r\nfunction restoreAllDialoguesForDebug() {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) return { restored: 0 };\r\n\r\n    const state = loadDialogueState(slot);\r\n    let restored = 0;\r\n\r\n    Object.entries(DLG_CATALOG).forEach(([id]) => {\r\n        const key = String(id);\r\n        const prev = state[key] || {};\r\n        if (prev.claimed) restored += 1;\r\n        state[key] = Object.assign({}, prev, { claimed: false });\r\n    });\r\n\r\n    persistDialogueState(state, slot);\r\n    return { restored };\r\n}\r\n\r\nfunction createInputRow(labelText, initialValue, onCommit, { idLabel, storageKey, onLockChange } = {}) {\r\n    const row = document.createElement('div');\r\n    row.className = 'debug-panel-row';\r\n\r\n    const label = document.createElement('label');\r\n    label.textContent = labelText;\r\n    if (idLabel != null) {\r\n        label.append(' ');\r\n        const idSpan = document.createElement('span');\r\n        idSpan.className = 'debug-panel-id';\r\n        idSpan.textContent = `(ID: ${idLabel})`;\r\n        label.appendChild(idSpan);\r\n    }\r\n    row.appendChild(label);\r\n\r\n    const input = document.createElement('input');\r\n    input.type = 'text';\r\n    input.className = 'debug-panel-input';\r\n    let editing = false;\r\n    let pendingValue = null;\r\n    let skipBlurCommit = false;\r\n    const lockToggle = storageKey ? createLockToggle(storageKey, { onToggle: onLockChange }) : null;\r\n\r\n    const setValue = (value) => {\r\n        if (editing) {\r\n            pendingValue = value;\r\n            return;\r\n        }\r\n        pendingValue = null;\r\n        input.value = formatBigNumForInput(value);\r\n    };\r\n\r\n    row.appendChild(input);\r\n    if (lockToggle) {\r\n        row.appendChild(lockToggle.button);\r\n    }\r\n\r\n    const commitValue = () => {\r\n        const parsed = parseBigNumInput(input.value);\r\n        if (!parsed) {\r\n            setInputValidity(input, false);\r\n            return;\r\n        }\r\n        setInputValidity(input, true);\r\n\r\n        const wasLocked = storageKey && isStorageKeyLocked(storageKey);\r\n        if (wasLocked) unlockStorageKey(storageKey);\r\n        try {\r\n            onCommit(parsed, { input, setValue });\r\n        } finally {\r\n            if (wasLocked) lockStorageKey(storageKey);\r\n            if (lockToggle) lockToggle.refresh();\r\n        }\r\n    };\r\n\r\n    input.addEventListener('focus', () => { editing = true; });\r\n    input.addEventListener('change', commitValue);\r\n    input.addEventListener('keydown', (event) => {\r\n        if (event.key === 'Enter') {\r\n            event.preventDefault();\r\n            skipBlurCommit = true;\r\n            commitValue();\r\n            input.blur();\r\n        }\r\n    });\r\n    input.addEventListener('blur', () => {\r\n        editing = false;\r\n        if (!skipBlurCommit) {\r\n            commitValue();\r\n        }\r\n        skipBlurCommit = false;\r\n        if (pendingValue != null) {\r\n            const next = pendingValue;\r\n            pendingValue = null;\r\n            setValue(next);\r\n        }\r\n    });\r\n\r\n    setValue(initialValue);\r\n    if (lockToggle) lockToggle.refresh();\r\n\r\n    return { row, input, setValue, isEditing: () => editing };\r\n}\r\n\r\nfunction createUnlockToggleRow({ labelText, description, isUnlocked, onEnable, onDisable, slot }) {\r\n    const row = document.createElement('div');\r\n    row.className = 'debug-panel-row debug-unlock-row';\r\n\r\n    const toggle = document.createElement('label');\r\n    toggle.className = 'flag-toggle';\r\n    toggle.setAttribute('aria-label', labelText);\r\n\r\n    const input = document.createElement('input');\r\n    input.type = 'checkbox';\r\n\r\n    const slider = document.createElement('span');\r\n    slider.className = 'flag-slider';\r\n\r\n    toggle.appendChild(input);\r\n    toggle.appendChild(slider);\r\n\r\n    const textContainer = document.createElement('div');\r\n    textContainer.className = 'debug-unlock-text';\r\n\r\n    const title = document.createElement('span');\r\n    title.className = 'debug-unlock-title';\r\n    title.textContent = labelText;\r\n    textContainer.appendChild(title);\r\n\r\n    if (description) {\r\n        const desc = document.createElement('span');\r\n        desc.className = 'debug-unlock-desc';\r\n        desc.textContent = `- ${description}`;\r\n        textContainer.appendChild(desc);\r\n    }\r\n\r\n    row.appendChild(toggle);\r\n    row.appendChild(textContainer);\r\n\r\n    const toggleRow = () => {\r\n        input.checked = !input.checked;\r\n        input.dispatchEvent(new Event('change', { bubbles: true }));\r\n    };\r\n\r\n    row.addEventListener('click', (event) => {\r\n        if (toggle.contains(event.target)) return;\r\n        toggleRow();\r\n    });\r\n\r\n    let lastKnown = false;\r\n\r\n    const refresh = () => {\r\n        let unlocked = false;\r\n        try { unlocked = typeof isUnlocked === 'function' ? !!isUnlocked() : false; }\r\n        catch {}\r\n        input.checked = unlocked;\r\n        lastKnown = unlocked;\r\n        return unlocked;\r\n    };\r\n\r\n    input.addEventListener('change', () => {\r\n        const previous = lastKnown;\r\n        const unlocked = input.checked;\r\n        try {\r\n            if (unlocked) {\r\n                onEnable?.();\r\n            } else {\r\n                onDisable?.();\r\n            }\r\n        } catch {}\r\n        flagDebugUsage();\r\n        const refreshed = refresh();\r\n        if (previous !== refreshed) {\r\n            logAction(`Toggled ${labelText} [GOLD]${previous ? 'True' : 'False'}[/GOLD] \u2192 [GOLD]${refreshed ? 'True' : 'False'}[/GOLD]`);\r\n        }\r\n    });\r\n\r\n    refresh();\r\n    registerLiveBinding({ type: 'unlock', slot, refresh });\r\n    return row;\r\n}\r\n\r\nfunction formatCalculatorResult(value) {\r\n    try {\r\n        if (value instanceof BigNum || typeof value?.toScientific === 'function') {\r\n            return formatNumber(value);\r\n        }\r\n        const num = Number(value);\r\n        if (Number.isFinite(num)) {\r\n            return formatNumber(num);\r\n        }\r\n        return String(value ?? '\u2014');\r\n    } catch {\r\n        return '\u2014';\r\n    }\r\n}\r\n\r\nfunction createCalculatorRow({ labelText, inputs = [], compute }) {\r\n    const row = document.createElement('div');\r\n    row.className = 'debug-panel-row debug-calculator-row';\r\n\r\n    const label = document.createElement('label');\r\n    label.textContent = labelText;\r\n    row.appendChild(label);\r\n\r\n    const controls = document.createElement('div');\r\n    controls.className = 'debug-calculator-inputs';\r\n    row.appendChild(controls);\r\n\r\n    const output = document.createElement('div');\r\n    output.className = 'debug-calculator-output';\r\n    output.textContent = '\u2014';\r\n    row.appendChild(output);\r\n\r\n    const fieldEls = [];\r\n\r\n    const recompute = () => {\r\n        const values = {};\r\n        let hasError = false;\r\n\r\n        fieldEls.forEach(({ config, el }) => {\r\n            if (config.type === 'select') {\r\n                values[config.key] = el.value;\r\n                return;\r\n            }\r\n\r\n            const parsed = parseBigNumInput(el.value);\r\n            const valid = parsed instanceof BigNum;\r\n            setInputValidity(el, valid);\r\n            if (!valid) {\r\n                hasError = true;\r\n                return;\r\n            }\r\n            values[config.key] = parsed;\r\n        });\r\n\r\n        if (hasError || typeof compute !== 'function') {\r\n            output.textContent = '\u2014';\r\n            return;\r\n        }\r\n\r\n        try {\r\n            const result = compute(values);\r\n            output.innerHTML = formatCalculatorResult(result);\r\n        } catch {\r\n            output.textContent = '\u2014';\r\n        }\r\n    };\r\n\r\n    inputs.forEach((inputConfig) => {\r\n        const config = Object.assign({ type: 'text', defaultValue: '' }, inputConfig);\r\n        if (!config.key) return;\r\n\r\n        if (config.type === 'select') {\r\n            const select = document.createElement('select');\r\n            select.className = 'debug-panel-input';\r\n            (config.options || []).forEach(({ value, label: optLabel }) => {\r\n                const option = document.createElement('option');\r\n                option.value = value;\r\n                option.textContent = optLabel ?? value;\r\n                if (config.defaultValue != null && config.defaultValue === value) {\r\n                    option.selected = true;\r\n                }\r\n                select.appendChild(option);\r\n            });\r\n            select.addEventListener('change', recompute);\r\n            controls.appendChild(select);\r\n            fieldEls.push({ config, el: select });\r\n        } else {\r\n            const input = document.createElement('input');\r\n            input.type = 'text';\r\n            input.className = 'debug-panel-input';\r\n            input.placeholder = config.label || '';\r\n            input.value = config.defaultValue ?? '';\r\n            input.addEventListener('input', recompute);\r\n            input.addEventListener('keydown', (event) => {\r\n                if (event.key === 'Enter') {\r\n                    event.preventDefault();\r\n                    recompute();\r\n                }\r\n            });\r\n            controls.appendChild(input);\r\n            fieldEls.push({ config, el: input });\r\n        }\r\n    });\r\n\r\n    recompute();\r\n\r\n    return row;\r\n}\r\n\r\nfunction applyXpState({ level, progress }) {\r\n  const slot = getActiveSlot();\r\n  if (slot == null) return;\r\n\r\n  const current = (() => {\r\n    try { return getXpState(); }\r\n    catch { return null; }\r\n  })();\r\n\r\n  const zero = (() => {\r\n    try { return BigNum.fromInt(0); }\r\n    catch { return null; }\r\n  })();\r\n\r\n  const toBnOrNull = (value) => {\r\n    if (value == null) return null;\r\n    try { return value instanceof BigNum ? value.clone?.() ?? value : BigNum.fromAny(value); }\r\n    catch { return null; }\r\n  };\r\n\r\n  let nextLevel = toBnOrNull(level) ?? current?.xpLevel ?? null;\r\n  let nextProgress = toBnOrNull(progress) ?? current?.progress ?? null;\r\n\r\n  const levelIsFinite = !(nextLevel?.isInfinite?.());\r\n  const progressIsFinite = !(nextProgress?.isInfinite?.());\r\n\r\n  // If either field is being changed back to a finite value, but its partner\r\n  // was still stuck at Infinity, zero it out so the XP system can resume\r\n  // normal accumulation.\r\n  if ((level != null || progress != null) && zero) {\r\n    if (levelIsFinite && !progressIsFinite) {\r\n      if (level != null) {\r\n        nextProgress = zero.clone?.() ?? zero;\r\n      }\r\n    } else if (progressIsFinite && !levelIsFinite) {\r\n      if (progress != null) {\r\n        nextLevel = zero.clone?.() ?? zero;\r\n      }\r\n    }\r\n  }\r\n\r\n    // If we're manually editing XP stats from the debug panel, the XP system\r\n    // should be treated as unlocked.\r\n    try { unlockXpSystem(); } catch {}\r\n\r\n    const unlockKey = XP_KEYS.unlock(slot);\r\n    try { localStorage.setItem(unlockKey, '1'); } catch {}\r\n    primeStorageWatcherSnapshot(unlockKey, '1');\r\n\r\n  if (nextLevel != null) {\r\n    try {\r\n      const raw = nextLevel.toStorage?.() ?? BigNum.fromAny(nextLevel).toStorage();\r\n      const key = XP_KEYS.level(slot);\r\n      localStorage.setItem(key, raw);\r\n      primeStorageWatcherSnapshot(key, raw);\r\n    } catch {}\r\n  }\r\n\r\n  if (nextProgress != null) {\r\n    try {\r\n      const raw = nextProgress.toStorage?.() ?? BigNum.fromAny(nextProgress).toStorage();\r\n      const key = XP_KEYS.progress(slot);\r\n      localStorage.setItem(key, raw);\r\n      primeStorageWatcherSnapshot(key, raw);\r\n    } catch {}\r\n  }\r\n\r\n    try {\r\n        initXpSystem({ forceReload: true });\r\n    } catch {}\r\n\r\n    // Let any XP listeners know we've made a manual change so dependent UI (like\r\n    // the Forge reset panel) can refresh immediately without waiting for normal\r\n    // gameplay hooks to fire.\r\n    try {\r\n        broadcastXpChange({ changeType: 'debug-panel', slot });\r\n    } catch {}\r\n\r\n    // Also keep ALL debug live bindings in sync (including the Unlocks tab\r\n    // \"Unlock XP\" flag, which reads getXpState().unlocked).\r\n    try {\r\n        refreshLiveBindings();\r\n    } catch {}\r\n}\r\n\r\nfunction applyMutationState({ level, progress }) {\r\n  const slot = getActiveSlot();\r\n  if (slot == null) return;\r\n\r\n  const current = (() => {\r\n    try { return getMutationState(); }\r\n    catch { return null; }\r\n  })();\r\n\r\n  const zero = (() => {\r\n    try { return BigNum.fromInt(0); }\r\n    catch { return null; }\r\n  })();\r\n\r\n  const toBnOrNull = (value) => {\r\n    if (value == null) return null;\r\n    try { return value instanceof BigNum ? value.clone?.() ?? value : BigNum.fromAny(value); }\r\n    catch { return null; }\r\n  };\r\n\r\n  let nextLevel = toBnOrNull(level) ?? current?.level ?? null;\r\n  let nextProgress = toBnOrNull(progress) ?? current?.progress ?? null;\r\n\r\n  const levelIsFinite = !(nextLevel?.isInfinite?.());\r\n  const progressIsFinite = !(nextProgress?.isInfinite?.());\r\n\r\n  if ((level != null || progress != null) && zero) {\r\n    if (levelIsFinite && !progressIsFinite) {\r\n      nextProgress = zero.clone?.() ?? zero;\r\n    } else if (progressIsFinite && !levelIsFinite) {\r\n      nextLevel = zero.clone?.() ?? zero;\r\n    }\r\n  }\r\n\r\n    // If the MP system isn't unlocked yet, setting its level/progress should\r\n    // auto-enable the relevant unlock flags so the UI and systems stay in\r\n    // sync.\r\n    try {\r\n        const forgeUnlocked = typeof window.resetSystem?.isForgeUnlocked === 'function' ? window.resetSystem.isForgeUnlocked() : false;\r\n        const forgeOverride = typeof window.resetSystem?.getForgeDebugOverrideState === 'function'\r\n            ? window.resetSystem.getForgeDebugOverrideState()\r\n            : null;\r\n        if (!forgeUnlocked && forgeOverride !== true) {\r\n            window.resetSystem?.setForgeDebugOverride?.(true);\r\n        }\r\n    } catch {}\r\n\r\n    try {\r\n        if (typeof window.resetSystem?.hasDoneForgeReset === 'function' && !window.resetSystem.hasDoneForgeReset()) {\r\n            window.resetSystem?.setForgeResetCompleted?.(true);\r\n        }\r\n    } catch {}\r\n\r\n    try { setMutationUnlockedForDebug(true); } catch {}\r\n\r\n    try { window.resetSystem?.updateResetPanel?.(); } catch {}\r\n\r\n    // Make sure the mutation / MP system is treated as unlocked if we're\r\n    // manually editing its stats from the debug panel.\r\n    try { initMutationSystem(); } catch {}\r\n    try { unlockMutationSystem(); } catch {}\r\n\r\n    const unlockKey = MUTATION_KEYS.unlock(slot);\r\n    try { localStorage.setItem(unlockKey, '1'); } catch {}\r\n    primeStorageWatcherSnapshot(unlockKey, '1');\r\n\r\n    if (level != null) {\r\n        try {\r\n            const raw = level.toStorage?.() ?? BigNum.fromAny(level).toStorage();\r\n            const key = MUTATION_KEYS.level(slot);\r\n            localStorage.setItem(key, raw);\r\n            primeStorageWatcherSnapshot(key, raw);\r\n        } catch {}\r\n    }\r\n\r\n    if (progress != null) {\r\n        try {\r\n            const raw = progress.toStorage?.() ?? BigNum.fromAny(progress).toStorage();\r\n            const key = MUTATION_KEYS.progress(slot);\r\n            localStorage.setItem(key, raw);\r\n            primeStorageWatcherSnapshot(key, raw);\r\n        } catch {}\r\n    }\r\n\r\n    try {\r\n        initMutationSystem({ forceReload: true });\r\n    } catch {}\r\n\r\n    try {\r\n        broadcastMutationChange({ changeType: 'debug-panel', slot });\r\n    } catch {}\r\n\r\n    try { window.resetSystem?.recomputePendingMagic?.(); } catch {}\r\n    try { window.resetSystem?.updateResetPanel?.(); } catch {}\r\n\r\n    // Keep all debug rows that depend on mutation / MP state in sync.\r\n    try {\r\n        refreshLiveBindings();\r\n    } catch {}\r\n}\r\n\r\nfunction buildAreaCurrencies(container, area) {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) {\r\n        const msg = document.createElement('div');\r\n        msg.className = 'debug-panel-empty';\r\n        msg.textContent = 'Select a save slot to edit currency values.';\r\n        container.appendChild(msg);\r\n        return;\r\n    }\r\n\r\n    const areaLabel = area?.title ?? area?.key ?? 'Unknown Area';\r\n\r\n    area.currencies.forEach((currency) => {\r\n        const storageKey = getCurrencyStorageKey(currency.key, slot);\r\n        const current = getCurrencyValueForSlot(currency.key, slot);\r\n        const currencyRow = createInputRow(currency.label, current, (value, { setValue }) => {\r\n            const latestSlot = getActiveSlot();\r\n            if (latestSlot == null) return;\r\n            const previous = getCurrencyValueForSlot(currency.key, latestSlot);\r\n            const { next } = applyCurrencyState(currency.key, value, latestSlot);\r\n            setValue(next);\r\n            if (!bigNumEquals(previous, next)) {\r\n                flagDebugUsage();\r\n                logAction(`Modified ${currency.label} (${areaLabel}) ${formatNumber(previous)} \u2192 ${formatNumber(next)}`);\r\n            }\r\n        }, {\r\n            storageKey,\r\n            onLockChange: () => currencyRow.setValue(getCurrencyValueForSlot(currency.key, getActiveSlot())),\r\n        });\r\n        registerLiveBinding({\r\n            type: 'currency',\r\n            key: currency.key,\r\n            slot,\r\n            refresh: () => {\r\n                if (slot !== getActiveSlot()) return;\r\n                const latest = getCurrencyValueForSlot(currency.key, slot);\r\n                currencyRow.setValue(latest);\r\n            },\r\n        });\r\n        container.appendChild(currencyRow.row);\r\n    });\r\n}\r\n\r\nfunction buildAreaStats(container, area) {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) {\r\n        const msg = document.createElement('div');\r\n        msg.className = 'debug-panel-empty';\r\n        msg.textContent = 'Select a save slot to edit stats.';\r\n        container.appendChild(msg);\r\n        return;\r\n    }\r\n\t\r\n\t    const spawnRateKey = 'spawnRate';\r\n    const spawnRateStorageKey = getStatMultiplierStorageKey(spawnRateKey, slot);\r\n    const spawnRateRow = createInputRow('Coin Spawn Rate', getStatMultiplierDisplayValue(spawnRateKey, slot), (value, { setValue }) => {\r\n        const latestSlot = getActiveSlot();\r\n        if (latestSlot == null) return;\r\n        const previous = getStatMultiplierDisplayValue(spawnRateKey, latestSlot);\r\n        try { setDebugStatMultiplierOverride(spawnRateKey, value, latestSlot); } catch {}\r\n        const refreshed = getStatMultiplierDisplayValue(spawnRateKey, latestSlot);\r\n        setValue(refreshed);\r\n        if (!bigNumEquals(previous, refreshed)) {\r\n            flagDebugUsage();\r\n            logAction(`Modified Spawn Rate (${areaLabel}) ${formatNumber(previous)} \u2192 ${formatNumber(refreshed)}`);\r\n        }\r\n    }, {\r\n        storageKey: spawnRateStorageKey,\r\n        onLockChange: (locked) => {\r\n            const latestSlot = getActiveSlot();\r\n            if (latestSlot == null) return;\r\n            if (locked) {\r\n                const existingOverride = getLockedStatOverride(latestSlot, spawnRateKey);\r\n                if (existingOverride) return;\r\n                try {\r\n                    setDebugStatMultiplierOverride(\r\n                        spawnRateKey,\r\n                        getGameStatMultiplier(spawnRateKey),\r\n                        latestSlot\r\n                    );\r\n                } catch {}\r\n            } else {\r\n                getEffectiveStatMultiplierOverride(\r\n                    spawnRateKey,\r\n                    latestSlot,\r\n                    getGameStatMultiplier(spawnRateKey)\r\n                );\r\n            }\r\n            spawnRateRow.setValue(getStatMultiplierDisplayValue(spawnRateKey, latestSlot));\r\n        },\r\n    });\r\n\r\n    registerLiveBinding({\r\n        type: 'stat-mult',\r\n        key: spawnRateKey,\r\n        slot,\r\n        refresh: () => {\r\n            if (slot !== getActiveSlot()) return;\r\n            const latest = getStatMultiplierDisplayValue(spawnRateKey, slot);\r\n            spawnRateRow.setValue(latest);\r\n        },\r\n    });\r\n\r\n    registerLiveBinding({\r\n        type: 'upgrade',\r\n        key: spawnRateKey,\r\n        slot,\r\n        refresh: () => {\r\n            if (slot !== getActiveSlot()) return;\r\n            const latest = getStatMultiplierDisplayValue(spawnRateKey, slot);\r\n            spawnRateRow.setValue(latest);\r\n        },\r\n    });\r\n\r\n    container.appendChild(spawnRateRow.row);\r\n\r\n    const xp = getXpState();\r\n    const mutation = getMutationState();\r\n    const areaLabel = area?.title ?? area?.key ?? 'Unknown Area';\r\n\r\n    const xpLevelKey = XP_KEYS.level(slot);\r\n    const xpLevelRow = createInputRow('XP Level', xp.xpLevel, (value, { setValue }) => {\r\n        const prev = getXpState().xpLevel;\r\n        applyXpState({ level: value });\r\n        const latest = getXpState();\r\n        setValue(latest.xpLevel);\r\n        if (!bigNumEquals(prev, latest.xpLevel)) {\r\n            flagDebugUsage();\r\n            logAction(`Modified XP Level (${areaLabel}) ${formatNumber(prev)} \u2192 ${formatNumber(latest.xpLevel)}`);\r\n        }\r\n    }, { storageKey: xpLevelKey });\r\n    registerLiveBinding({\r\n        type: 'xp',\r\n        slot,\r\n        refresh: () => {\r\n            if (slot !== getActiveSlot()) return;\r\n            xpLevelRow.setValue(getXpState().xpLevel);\r\n        },\r\n    });\r\n    container.appendChild(xpLevelRow.row);\r\n\r\n    const xpProgressKey = XP_KEYS.progress(slot);\r\n    const xpProgressRow = createInputRow('XP Progress', xp.progress, (value, { setValue }) => {\r\n        const prev = getXpState();\r\n        const prevLevel = prev?.xpLevel?.clone?.() ?? prev?.xpLevel;\r\n        const prevProgress = prev?.progress?.clone?.() ?? prev?.progress;\r\n        applyXpState({ progress: value });\r\n        const latest = getXpState();\r\n        setValue(latest.progress);\r\n        xpLevelRow.setValue(latest.xpLevel);\r\n        if (!bigNumEquals(prevProgress, latest.progress) || !bigNumEquals(prevLevel, latest.xpLevel)) {\r\n            flagDebugUsage();\r\n            logAction(`Modified XP Progress (${areaLabel}) ${formatNumber(prevProgress)} \u2192 ${formatNumber(latest.progress)}`);\r\n        }\r\n    }, { storageKey: xpProgressKey });\r\n    registerLiveBinding({\r\n        type: 'xp',\r\n        slot,\r\n        refresh: () => {\r\n            if (slot !== getActiveSlot()) return;\r\n            xpProgressRow.setValue(getXpState().progress);\r\n        },\r\n    });\r\n    container.appendChild(xpProgressRow.row);\r\n\r\n    const mpLevelKey = MUTATION_KEYS.level(slot);\r\n    const mpLevelRow = createInputRow('MP Level', mutation.level, (value, { setValue }) => {\r\n        const prev = getMutationState().level;\r\n        applyMutationState({ level: value });\r\n        const latest = getMutationState();\r\n        setValue(latest.level);\r\n        if (!bigNumEquals(prev, latest.level)) {\r\n            flagDebugUsage();\r\n            logAction(`Modified MP Level (${areaLabel}) ${formatNumber(prev)} \u2192 ${formatNumber(latest.level)}`);\r\n        }\r\n    }, { storageKey: mpLevelKey });\r\n    registerLiveBinding({\r\n        type: 'mutation',\r\n        slot,\r\n        refresh: () => {\r\n            if (slot !== getActiveSlot()) return;\r\n            mpLevelRow.setValue(getMutationState().level);\r\n        },\r\n    });\r\n    container.appendChild(mpLevelRow.row);\r\n\r\n    const mpProgressKey = MUTATION_KEYS.progress(slot);\r\n    const mpProgressRow = createInputRow('MP Progress', mutation.progress, (value, { setValue }) => {\r\n        const prev = getMutationState();\r\n        const prevLevel = prev?.level?.clone?.() ?? prev?.level;\r\n        const prevProgress = prev?.progress?.clone?.() ?? prev?.progress;\r\n        applyMutationState({ progress: value });\r\n        const latest = getMutationState();\r\n        setValue(latest.progress);\r\n        mpLevelRow.setValue(latest.level);\r\n        if (!bigNumEquals(prevProgress, latest.progress) || !bigNumEquals(prevLevel, latest.level)) {\r\n            flagDebugUsage();\r\n            logAction(`Modified MP Progress (${areaLabel}) ${formatNumber(prevProgress)} \u2192 ${formatNumber(latest.progress)}`);\r\n        }\r\n    }, { storageKey: mpProgressKey });\r\n    registerLiveBinding({\r\n        type: 'mutation',\r\n        slot,\r\n        refresh: () => {\r\n            if (slot !== getActiveSlot()) return;\r\n            mpProgressRow.setValue(getMutationState().progress);\r\n        },\r\n    });\r\n    container.appendChild(mpProgressRow.row);\r\n\t\r\n\t    // Workshop Level\r\n    const genLevelKey = getGenerationLevelKey(slot);\r\n    if (genLevelKey) {\r\n        let currentGenLevel = 0;\r\n        try {\r\n            const raw = localStorage.getItem(genLevelKey);\r\n            const bn = BigNum.fromAny(raw || '0');\r\n            if (bn.isInfinite()) {\r\n                currentGenLevel = Infinity;\r\n            } else {\r\n                try {\r\n                    currentGenLevel = Number(bn.toScientific(20));\r\n                } catch {\r\n                    currentGenLevel = 0;\r\n                }\r\n            }\r\n        } catch {}\r\n\r\n        const genLevelRow = createInputRow('Workshop Level', currentGenLevel, (value, { setValue }) => {\r\n            // Helper to get a finite number from input, which might be BigNum or string/number\r\n            let valNum = Number(value);\r\n            console.log('[DebugPanel] Workshop Level Commit. Value type:', typeof value, 'IsBigNum:', value instanceof BigNum, 'Value:', value);\r\n\r\n            if (value instanceof BigNum) {\r\n                 if (value.isInfinite()) {\r\n                     valNum = Infinity; \r\n                 } else {\r\n                     try {\r\n                        // Use a large enough precision for toScientific to preserve the exponent\r\n                        // toScientific(20) returns e.g. \"1.000...e21\"\r\n                        valNum = Number(value.toScientific(20));\r\n                     } catch {\r\n                        valNum = NaN;\r\n                     }\r\n                 }\r\n            }\r\n\r\n            if (Number.isNaN(valNum) || valNum < 0) return;\r\n            const cleanVal = (valNum === Infinity) ? 'Infinity' : String(Math.floor(valNum));\r\n            \r\n            try {\r\n                localStorage.setItem(genLevelKey, cleanVal);\r\n                flagDebugUsage();\r\n                logAction(`Modified Workshop Level (The Cove) ${formatNumber(currentGenLevel)} \u2192 ${cleanVal}`);\r\n                currentGenLevel = valNum;\r\n            } catch {}\r\n            \r\n            setValue(valNum);\r\n        }, {\r\n            storageKey: genLevelKey,\r\n            onLockChange: () => {\r\n                let newVal = 0;\r\n                try {\r\n                    const r = localStorage.getItem(genLevelKey);\r\n                    const bn = BigNum.fromAny(r || '0');\r\n                    if (bn.isInfinite()) newVal = Infinity;\r\n                    else newVal = Number(bn.toScientific(20));\r\n                } catch {}\r\n                genLevelRow.setValue(newVal);\r\n            }\r\n        });\r\n        \r\n        container.appendChild(genLevelRow.row);\r\n\r\n        registerLiveBinding({\r\n            type: 'workshop-level',\r\n            slot,\r\n            refresh: () => {\r\n                if (slot !== getActiveSlot()) return;\r\n                let newVal = 0;\r\n                try {\r\n                    const r = localStorage.getItem(genLevelKey);\r\n                    const bn = BigNum.fromAny(r || '0');\r\n                    if (bn.isInfinite()) newVal = Infinity;\r\n                    else newVal = Number(bn.toScientific(20));\r\n                } catch {}\r\n                genLevelRow.setValue(newVal);\r\n            }\r\n        });\r\n    }\r\n}\r\n\r\nfunction buildAreaUpgrades(container, area) {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) {\r\n        const msg = document.createElement('div');\r\n        msg.className = 'debug-panel-empty';\r\n        msg.textContent = 'Select a save slot to edit upgrades.';\r\n        container.appendChild(msg);\r\n        return;\r\n    }\r\n\r\n    const upgrades = getUpgradesForArea(area.key);\r\n    if (!upgrades || upgrades.length === 0) {\r\n        const msg = document.createElement('div');\r\n        msg.className = 'debug-panel-empty';\r\n        msg.textContent = 'No upgrades found for this area yet.';\r\n        container.appendChild(msg);\r\n        return;\r\n    }\r\n\r\n    const areaLabel = area?.title ?? area?.key ?? 'Unknown Area';\r\n\r\n    upgrades.forEach((upg) => {\r\n        const idLabel = upg.id ?? upg.tie ?? upg.tieKey;\r\n        const title = upg.title || `Upgrade ${idLabel ?? ''}`.trim();\r\n        const current = getLevel(area.key, upg.id ?? upg.tie);\r\n        const storageKey = getUpgradeStorageKey(area.key, upg.id ?? upg.tie, slot);\r\n        const upgradeRow = createInputRow(title, current, (value, { setValue }) => {\r\n            const latestSlot = getActiveSlot();\r\n            if (latestSlot == null) return;\r\n            const previous = getLevel(area.key, upg.id ?? upg.tie);\r\n            try { setLevel(area.key, upg.id ?? upg.tie, value, false); } catch {}\r\n            const refreshed = getLevel(area.key, upg.id ?? upg.tie);\r\n            setValue(refreshed);\r\n            if (!bigNumEquals(previous, refreshed)) {\r\n                flagDebugUsage();\r\n                logAction(`Modified ${title} (${areaLabel} - ID: ${idLabel ?? 'Unknown'}) Lv${formatNumber(previous)} \u2192 Lv${formatNumber(refreshed)}`);\r\n            }\r\n        }, { idLabel, storageKey });\r\n        registerLiveBinding({\r\n            type: 'upgrade',\r\n            slot,\r\n            refresh: () => {\r\n                if (slot !== getActiveSlot()) return;\r\n                const refreshed = getLevel(area.key, upg.id ?? upg.tie);\r\n                upgradeRow.setValue(refreshed);\r\n            },\r\n        });\r\n        container.appendChild(upgradeRow.row);\r\n    });\r\n}\r\n\r\nfunction buildAreaCurrencyMultipliers(container, area) {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) {\r\n        const msg = document.createElement('div');\r\n        msg.className = 'debug-panel-empty';\r\n        msg.textContent = 'Select a save slot to edit currency multipliers.';\r\n        container.appendChild(msg);\r\n        return;\r\n    }\r\n\r\n    const areaLabel = area?.title ?? area?.key ?? 'Unknown Area';\r\n\r\n    area.currencies.forEach((currency) => {\r\n        const handle = bank?.[currency.key]?.mult;\r\n        const currentOverride = getDebugCurrencyMultiplierOverride(currency.key, slot);\r\n        const current = currentOverride ?? handle?.get?.() ?? BigNum.fromInt(1);\r\n        const storageKey = `${KEYS.MULTIPLIER[currency.key]}:${slot}`;\r\n        const row = createInputRow(`${currency.label} Multiplier`, current, (value, { setValue }) => {\r\n            const latestSlot = getActiveSlot();\r\n            if (latestSlot == null) return;\r\n            const previous = getDebugCurrencyMultiplierOverride(currency.key, latestSlot)\r\n                ?? handle?.get?.()\r\n                ?? BigNum.fromInt(1);\r\n            try { setDebugCurrencyMultiplierOverride(currency.key, value, latestSlot); } catch {}\r\n            applyAllCurrencyOverridesForActiveSlot();\r\n            const refreshedOverride = getDebugCurrencyMultiplierOverride(currency.key, latestSlot);\r\n            const refreshed = refreshedOverride ?? handle?.get?.() ?? BigNum.fromInt(1);\r\n            setValue(refreshed);\r\n            if (!bigNumEquals(previous, refreshed)) {\r\n                flagDebugUsage();\r\n                logAction(`Modified ${currency.label} Multiplier (${areaLabel}) ${formatNumber(previous)} \u2192 ${formatNumber(refreshed)}`);\r\n            }\r\n        }, { storageKey });\r\n        registerLiveBinding({\r\n            type: 'currency-mult',\r\n            key: currency.key,\r\n            slot,\r\n            refresh: () => {\r\n                if (slot !== getActiveSlot()) return;\r\n                const latestOverride = getDebugCurrencyMultiplierOverride(currency.key, slot);\r\n                const latest = latestOverride ?? handle?.get?.() ?? BigNum.fromInt(1);\r\n                row.setValue(latest);\r\n            },\r\n        });\r\n        container.appendChild(row.row);\r\n    });\r\n}\r\n\r\nfunction setAllCurrenciesToInfinity() {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) return 0;\r\n\r\n    const inf = BigNum.fromAny('Infinity');\r\n    let updated = 0;\r\n\r\n    Object.values(CURRENCIES).forEach((key) => {\r\n        const handle = bank?.[key];\r\n        if (!handle) return;\r\n        try {\r\n            const current = handle.value ?? handle.get?.();\r\n            const isAlreadyInf =\r\n                current?.isInfinite?.() ||\r\n                bigNumEquals(current, inf);\r\n\r\n            if (isAlreadyInf) return;\r\n\r\n            handle.set(inf);\r\n            updated += 1;\r\n        } catch {}\r\n    });\r\n\r\n    return updated;\r\n}\r\n\r\nfunction setAllCurrenciesToZero() {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) return 0;\r\n\r\n    const zero = BigNum.fromInt(0);\r\n    let updated = 0;\r\n\r\n    Object.values(CURRENCIES).forEach((key) => {\r\n        const handle = bank?.[key];\r\n        if (!handle) return;\r\n        try {\r\n            handle.set?.(zero);\r\n            updated += 1;\r\n        } catch {}\r\n    });\r\n\r\n    return updated;\r\n}\r\n\r\nfunction setAllStatsToInfinity() {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) return 0;\r\n\r\n    const inf = BigNum.fromAny('Infinity');\r\n    let touched = 0;\r\n\r\n    let xpState;\r\n    let mutationState;\r\n\r\n    try { xpState = getXpState(); } catch {}\r\n    try { mutationState = getMutationState(); } catch {}\r\n\r\n    // XP: only touch if unlocked and level/progress aren\u2019t already infinite\r\n    try {\r\n        if (xpState?.unlocked) {\r\n            const levelInf =\r\n                xpState?.xpLevel?.isInfinite?.() ||\r\n                bigNumEquals(xpState?.xpLevel, inf);\r\n            const progInf =\r\n                xpState?.progress?.isInfinite?.() ||\r\n                bigNumEquals(xpState?.progress, inf);\r\n\r\n            if (!levelInf || !progInf) {\r\n                applyXpState({ level: inf, progress: inf });\r\n                touched += 1; // count \"XP\" as one stat block\r\n            }\r\n        }\r\n    } catch {}\r\n\r\n    // MP / Mutation: only if unlocked\r\n    try {\r\n        if (mutationState?.unlocked) {\r\n            const levelInf =\r\n                mutationState?.level?.isInfinite?.() ||\r\n                bigNumEquals(mutationState?.level, inf);\r\n            const progInf =\r\n                mutationState?.progress?.isInfinite?.() ||\r\n                bigNumEquals(mutationState?.progress, inf);\r\n\r\n            if (!levelInf || !progInf) {\r\n                applyMutationState({ level: inf, progress: inf });\r\n                touched += 1; // count \"MP\" as one stat block\r\n            }\r\n        }\r\n    } catch {}\r\n\r\n    // Workshop Level\r\n    try {\r\n        const genLevelKey = getGenerationLevelKey(slot);\r\n        if (genLevelKey) {\r\n            const raw = localStorage.getItem(genLevelKey);\r\n            const current = parseFloat(raw || '0');\r\n            if (current !== Infinity) {\r\n                localStorage.setItem(genLevelKey, 'Infinity');\r\n                touched += 1;\r\n            }\r\n        }\r\n    } catch {}\r\n\r\n    return touched;\r\n}\r\n\r\nfunction setAllStatsToZero() {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) return 0;\r\n\r\n    const zero = BigNum.fromInt(0);\r\n    let touched = 0;\r\n\r\n    let xpState;\r\n    let mutationState;\r\n\r\n    try { xpState = getXpState(); } catch {}\r\n    try { mutationState = getMutationState(); } catch {}\r\n\r\n    try {\r\n        if (xpState?.unlocked) {\r\n            applyXpState({ level: zero, progress: zero });\r\n            touched += 1;\r\n        }\r\n    } catch {}\r\n\r\n    try {\r\n        if (mutationState?.unlocked) {\r\n            applyMutationState({ level: zero, progress: zero });\r\n            touched += 1;\r\n        }\r\n    } catch {}\r\n\r\n    return touched;\r\n}\r\n\r\nfunction getUnlockRowDefinitions(slot) {\r\n    return [\r\n        {\r\n            labelText: 'Unlock XP',\r\n            description: 'If true, unlocks the XP system',\r\n            isUnlocked: () => {\r\n                try { return !!getXpState()?.unlocked; }\r\n                catch { return false; }\r\n            },\r\n            onEnable: () => {\r\n                try { unlockXpSystem(); }\r\n                catch {}\r\n                try { initXpSystem({ forceReload: true }); }\r\n                catch {}\r\n            },\r\n            onDisable: () => {\r\n                try { resetXpProgress({ keepUnlock: false }); }\r\n                catch {}\r\n                try { window.resetSystem?.setForgeDebugOverride?.(false); }\r\n                catch {}\r\n                try { window.resetSystem?.updateResetPanel?.(); }\r\n                catch {}\r\n            },\r\n            slot,\r\n        },\r\n\t\t{\r\n            labelText: 'Unlock Warps',\r\n            description: 'If true, unlocks the Warps tab',\r\n            isUnlocked: () => {\r\n                try { return window.resetSystem?.hasDoneSurgeReset?.() ?? false; }\r\n                catch { return false; }\r\n            },\r\n            onEnable: () => {\r\n                try { window.resetSystem?.setSurgeResetCompleted?.(true); }\r\n                catch {}\r\n                try { window.resetSystem?.updateResetPanel?.(); }\r\n                catch {}\r\n            },\r\n            onDisable: () => {\r\n                try { window.resetSystem?.setSurgeResetCompleted?.(false); }\r\n                catch {}\r\n                try { window.resetSystem?.updateResetPanel?.(); }\r\n                catch {}\r\n            },\r\n            slot,\r\n        },\r\n        {\r\n            labelText: 'Unlock Workshop',\r\n            description: 'If true, unlocks the Workshop tab',\r\n            isUnlocked: () => {\r\n                try { return window.resetSystem?.hasDoneInfuseReset?.() ?? false; }\r\n                catch { return false; }\r\n            },\r\n            onEnable: () => {\r\n                try { window.resetSystem?.setInfuseResetCompleted?.(true); }\r\n                catch {}\r\n                try { window.resetSystem?.updateResetPanel?.(); }\r\n                catch {}\r\n            },\r\n            onDisable: () => {\r\n                try { window.resetSystem?.setInfuseResetCompleted?.(false); }\r\n                catch {}\r\n                try { window.resetSystem?.updateResetPanel?.(); }\r\n                catch {}\r\n            },\r\n            slot,\r\n        },\r\n\t\t{\r\n            labelText: 'Unlock MP',\r\n            description: 'If true, unlocks the MP system',\r\n            isUnlocked: () => {\r\n                try { return window.resetSystem?.hasDoneForgeReset?.() ?? false; }\r\n                catch { return false; }\r\n            },\r\n            onEnable: () => {\r\n                try { window.resetSystem?.setForgeResetCompleted?.(true); }\r\n                catch {}\r\n                try { setMutationUnlockedForDebug(true); }\r\n                catch {}\r\n                try { window.resetSystem?.updateResetPanel?.(); }\r\n                catch {}\r\n            },\r\n            onDisable: () => {\r\n                try { window.resetSystem?.setForgeResetCompleted?.(false); }\r\n                catch {}\r\n                try { setMutationUnlockedForDebug(false); }\r\n                catch {}\r\n                try { window.resetSystem?.updateResetPanel?.(); }\r\n                catch {}\r\n            },\r\n            slot,\r\n        },\r\n        {\r\n            labelText: 'Unlock Forge',\r\n            description: 'If true, unlocks the Forge reset and Reset tab',\r\n            isUnlocked: () => {\r\n                try {\r\n                    const override = window.resetSystem?.getForgeDebugOverrideState?.();\r\n                    if (override != null) return override;\r\n                } catch {}\r\n                try { return !!window.resetSystem?.isForgeUnlocked?.(); }\r\n                catch { return false; }\r\n                return false;\r\n            },\r\n            onEnable: () => {\r\n                try { window.resetSystem?.setForgeDebugOverride?.(true); }\r\n                catch {}\r\n                try { window.resetSystem?.updateResetPanel?.(); }\r\n                catch {}\r\n            },\r\n            onDisable: () => {\r\n                try { window.resetSystem?.setForgeDebugOverride?.(false); }\r\n                catch {}\r\n                try { window.resetSystem?.updateResetPanel?.(); }\r\n                catch {}\r\n            },\r\n        },\r\n        {\r\n            labelText: 'Unlock Infuse',\r\n            description: 'If true, unlocks the Infuse reset',\r\n            isUnlocked: () => {\r\n                try {\r\n                    const override = window.resetSystem?.getInfuseDebugOverrideState?.();\r\n                    if (override != null) return override;\r\n                } catch {}\r\n                try { return !!window.resetSystem?.isInfuseUnlocked?.(); }\r\n                catch { return false; }\r\n            },\r\n            onEnable: () => {\r\n                try { window.resetSystem?.setInfuseUnlockedForDebug?.(true); }\r\n                catch {}\r\n                try { window.resetSystem?.updateResetPanel?.(); }\r\n                catch {}\r\n            },\r\n            onDisable: () => {\r\n                try { window.resetSystem?.setInfuseUnlockedForDebug?.(false); }\r\n                catch {}\r\n                try { window.resetSystem?.updateResetPanel?.(); }\r\n                catch {}\r\n            },\r\n            slot,\r\n        },\r\n\t\t{\r\n            labelText: 'Unlock Surge',\r\n            description: 'If true, unlocks the Surge reset',\r\n            isUnlocked: () => {\r\n                try {\r\n                    const override = window.resetSystem?.getSurgeDebugOverrideState?.();\r\n                    if (override != null) return override;\r\n                } catch {}\r\n                try { return !!window.resetSystem?.isSurgeUnlocked?.(); }\r\n                catch { return false; }\r\n            },\r\n            onEnable: () => {\r\n                try { window.resetSystem?.setSurgeUnlockedForDebug?.(true); }\r\n                catch {}\r\n                try { window.resetSystem?.updateResetPanel?.(); }\r\n                catch {}\r\n            },\r\n            onDisable: () => {\r\n                try { window.resetSystem?.setSurgeUnlockedForDebug?.(false); }\r\n                catch {}\r\n                try { window.resetSystem?.updateResetPanel?.(); }\r\n                catch {}\r\n            },\r\n            slot,\r\n        },\r\n        {\r\n            labelText: 'Unlock Shop',\r\n            description: 'If true, makes the Shop button visible',\r\n            isUnlocked: () => {\r\n                try { return isShopUnlocked(); }\r\n                catch { return false; }\r\n            },\r\n            onEnable: () => {\r\n                try { unlockShop(); }\r\n                catch {}\r\n            },\r\n            onDisable: () => {\r\n                try { lockShop(); }\r\n                catch {}\r\n            },\r\n            slot,\r\n        },\r\n        {\r\n            labelText: 'Unlock Map',\r\n            description: 'If true, makes the Map button visible',\r\n            isUnlocked: () => {\r\n                try { return isMapUnlocked(); }\r\n                catch { return false; }\r\n            },\r\n            onEnable: () => {\r\n                try { unlockMap(); }\r\n                catch {}\r\n            },\r\n            onDisable: () => {\r\n                try { lockMap(); }\r\n                catch {}\r\n            },\r\n            slot,\r\n        },\r\n\r\n        {\r\n            labelText: 'Unlock Jeff',\r\n            description: 'If true, changes the Merchant\\'s name to Jeff',\r\n            isUnlocked: () => {\r\n                try { return isJeffUnlocked(); }\r\n                catch { return false; }\r\n            },\r\n            onEnable: () => {\r\n                try { setJeffUnlocked(true); }\r\n                catch {}\r\n            },\r\n            onDisable: () => {\r\n                try { setJeffUnlocked(false); }\r\n                catch {}\r\n            },\r\n            slot,\r\n        },\r\n    ];\r\n}\r\n\r\nfunction setAllUnlockToggles(targetState) {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) return 0;\r\n\r\n    let toggled = 0;\r\n    getUnlockRowDefinitions(slot).forEach((rowDef) => {\r\n        let unlocked = false;\r\n        try { unlocked = typeof rowDef.isUnlocked === 'function' ? !!rowDef.isUnlocked() : false; }\r\n        catch {}\r\n\r\n        if (unlocked === targetState) return;\r\n\r\n        try {\r\n            if (targetState) {\r\n                rowDef.onEnable?.();\r\n            } else {\r\n                rowDef.onDisable?.();\r\n            }\r\n            toggled += 1;\r\n        } catch {}\r\n    });\r\n\r\n    try { refreshLiveBindings(); } catch {}\r\n\r\n    return toggled;\r\n}\r\n\r\nfunction unlockAllUnlocks() {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) return { unlocks: 0, toggles: 0 };\r\n    let unlocked = 0;\r\n    getAreas().forEach((area) => {\r\n        getUpgradesForArea(area.key).forEach((upg) => {\r\n            if (!upg?.unlockUpgrade) return;\r\n            try { markUpgradePermanentlyUnlocked(area.key, upg, slot); unlocked += 1; }\r\n            catch {}\r\n        });\r\n    });\r\n    try { unlockShop(); } catch {}\r\n    try { unlockMap(); } catch {}\r\n    const toggled = setAllUnlockToggles(true);\r\n    return { unlocks: unlocked, toggles: toggled };\r\n}\r\n\r\nfunction lockAllUnlockUpgrades() {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) return { locks: 0, toggles: 0 };\r\n    let locked = 0;\r\n    getAreas().forEach((area) => {\r\n        getUpgradesForArea(area.key).forEach((upg) => {\r\n            if (!upg?.unlockUpgrade) return;\r\n            try { clearPermanentUpgradeUnlock(area.key, upg, slot); locked += 1; }\r\n            catch {}\r\n        });\r\n    });\r\n    try { lockShop(); } catch {}\r\n    try { lockMap(); } catch {}\r\n    const toggled = setAllUnlockToggles(false);\r\n    return { locks: locked, toggles: toggled };\r\n}\r\n\r\nfunction getResetTargetLockKeys(target, slot = getActiveSlot()) {\r\n    const resolvedSlot = slot ?? getActiveSlot();\r\n    if (resolvedSlot == null) return [];\r\n\r\n    const keys = new Set();\r\n    const add = (key) => { if (key) keys.add(key); };\r\n\r\n    const addCurrencyKeys = (currencyKey) => {\r\n        add(getCurrencyStorageKey(currencyKey, resolvedSlot));\r\n        add(getCurrencyMultiplierStorageKey(currencyKey, resolvedSlot));\r\n    };\r\n\r\n    const addStatMultiplier = (statKey) => add(getStatMultiplierStorageKey(statKey, resolvedSlot));\r\n\r\n    const addStatKeys = (statKey) => {\r\n        addStatMultiplier(statKey);\r\n        if (statKey === 'xp' || statKey === 'xpLevel' || statKey === 'xpProgress') {\r\n            add(XP_KEYS.level(resolvedSlot));\r\n            add(XP_KEYS.progress(resolvedSlot));\r\n        }\r\n        if (statKey === 'mutation' || statKey === 'mp' || statKey === 'mpLevel' || statKey === 'mpProgress') {\r\n            add(MUTATION_KEYS.level(resolvedSlot));\r\n            add(MUTATION_KEYS.progress(resolvedSlot));\r\n        }\r\n    };\r\n\r\n    if (target === 'all') {\r\n        Object.values(CURRENCIES).forEach(addCurrencyKeys);\r\n        addStatKeys('xp');\r\n        addStatKeys('mutation');\r\n        STAT_MULTIPLIERS.forEach(({ key }) => addStatMultiplier(key));\r\n        return Array.from(keys);\r\n    }\r\n\r\n    if (target === 'allCurrencies') {\r\n        Object.values(CURRENCIES).forEach(addCurrencyKeys);\r\n        return Array.from(keys);\r\n    }\r\n\r\n    if (target === 'allUnlockedStats') {\r\n        if (getXpState()?.unlocked) addStatKeys('xp');\r\n        if (getMutationState()?.unlocked) addStatKeys('mutation');\r\n        return Array.from(keys);\r\n    }\r\n\r\n    if (target === 'allUnlocked') {\r\n        Object.values(CURRENCIES).forEach(addCurrencyKeys);\r\n        if (getXpState()?.unlocked) addStatKeys('xp');\r\n        if (getMutationState()?.unlocked) addStatKeys('mutation');\r\n        return Array.from(keys);\r\n    }\r\n\r\n    if (target.startsWith('currency:')) {\r\n        addCurrencyKeys(target.slice('currency:'.length));\r\n        return Array.from(keys);\r\n    }\r\n\r\n    if (target.startsWith('statmult:')) {\r\n        addStatMultiplier(target.slice('statmult:'.length));\r\n        return Array.from(keys);\r\n    }\r\n\r\n    if (target.startsWith('stat:')) {\r\n        addStatKeys(target.slice('stat:'.length));\r\n        return Array.from(keys);\r\n    }\r\n\r\n    return Array.from(keys);\r\n}\r\n\r\nfunction resetCurrencyAndMultiplier(currencyKey) {\r\n    try {\r\n        // Reset the banked amount\r\n        bank?.[currencyKey]?.set?.(BigNum.fromInt(0));\r\n    } catch {}\r\n\r\n    try {\r\n        // Clear any debug override for this currency\r\n        clearCurrencyMultiplierOverride(currencyKey);\r\n    } catch {}\r\n\r\n    try {\r\n        // Put the actual in-game multiplier back to 1x\r\n        setCurrencyMultiplierBN(currencyKey, BigNum.fromInt(1));\r\n    } catch {}\r\n}\r\n\r\nfunction resetStatsAndMultipliers(target) {\r\n    if (target === 'all') {\r\n        // All currencies + multipliers: clear overrides and put real multipliers back to 1x\r\n        Object.values(CURRENCIES).forEach((key) => resetCurrencyAndMultiplier(key));\r\n\r\n        const zero = BigNum.fromInt(0);\r\n\r\n        // XP + MP (mutation) state \u2192 0\r\n        applyXpState({ level: zero, progress: zero });\r\n        applyMutationState({ level: zero, progress: zero });\r\n\r\n        // For stats, behave like the stat multiplier debug field:\r\n        // create a temporary 1x override that will be auto-cleared on the next\r\n        // normal game multiplier update (XP Value, MP Value, etc.).\r\n        STAT_MULTIPLIERS.forEach(({ key }) => {\r\n            try { setDebugStatMultiplierOverride(key, BigNum.fromInt(1)); } catch {}\r\n        });\r\n\r\n        const totalCount = Object.values(CURRENCIES).length + STAT_MULTIPLIERS.length + 2; // XP + MP\r\n        return { label: '[GOLD]all[/GOLD] currency/stats', count: totalCount };\r\n    }\r\n\r\n    if (target === 'allCurrencies') {\r\n        let currencyCount = 0;\r\n        Object.values(CURRENCIES).forEach((key) => {\r\n            resetCurrencyAndMultiplier(key);\r\n            currencyCount += 1;\r\n        });\r\n\r\n        const label = currencyCount === 1 ? '1 currency' : `${currencyCount} currencies`;\r\n        return { label, count: currencyCount };\r\n    }\r\n\r\n    if (target === 'allUnlockedStats') {\r\n        const zero = BigNum.fromInt(0);\r\n        let resetCount = 0;\r\n\r\n        try {\r\n            if (getXpState()?.unlocked) {\r\n                applyXpState({ level: zero, progress: zero });\r\n                try { setDebugStatMultiplierOverride('xp', BigNum.fromInt(1)); } catch {}\r\n                resetCount += 1;\r\n            }\r\n        } catch {}\r\n\r\n        try {\r\n            if (getMutationState()?.unlocked) {\r\n                applyMutationState({ level: zero, progress: zero });\r\n                try { setDebugStatMultiplierOverride('mutation', BigNum.fromInt(1)); } catch {}\r\n                resetCount += 1;\r\n            }\r\n        } catch {}\r\n\r\n        const label = resetCount === 1 ? '1 unlocked stat' : `${resetCount} unlocked stats`;\r\n        return { label, count: resetCount };\r\n    }\r\n\r\n    if (target === 'allUnlocked') {\r\n        let currencyCount = 0;\r\n        Object.values(CURRENCIES).forEach((key) => {\r\n            resetCurrencyAndMultiplier(key);\r\n            currencyCount += 1;\r\n        });\r\n\r\n        const zero = BigNum.fromInt(0);\r\n        let resetCount = 0;\r\n\r\n        try {\r\n            if (getXpState()?.unlocked) {\r\n                applyXpState({ level: zero, progress: zero });\r\n                try { setDebugStatMultiplierOverride('xp', BigNum.fromInt(1)); } catch {}\r\n                resetCount += 1;\r\n            }\r\n        } catch {}\r\n\r\n        try {\r\n            if (getMutationState()?.unlocked) {\r\n                applyMutationState({ level: zero, progress: zero });\r\n                try { setDebugStatMultiplierOverride('mutation', BigNum.fromInt(1)); } catch {}\r\n                resetCount += 1;\r\n            }\r\n        } catch {}\r\n\r\n        const parts = [];\r\n\r\n        if (resetCount === 1) parts.push('1 unlocked stat');\r\n        else parts.push(`${resetCount} unlocked stats`);\r\n\r\n        parts.push(currencyCount === 1 ? '1 currency' : `${currencyCount} currencies`);\r\n\r\n        return { label: parts.join(' and '), count: resetCount + currencyCount };\r\n    }\r\n\r\n    if (target.startsWith('currency:')) {\r\n        const currencyKey = target.slice('currency:'.length);\r\n        resetCurrencyAndMultiplier(currencyKey);\r\n        return { label: `${currencyKey}`, count: 1 };\r\n    }\r\n\r\n    if (target.startsWith('statmult:')) {\r\n        const statKey = target.slice('statmult:'.length);\r\n        // \"Reset this stat multiplier\" = remove any debug override,\r\n        // let the game recalculate the multiplier normally.\r\n        try { clearStatMultiplierOverride(statKey); } catch {}\r\n        return { label: `${statKey} multiplier`, count: 1 };\r\n    }\r\n\r\n    if (!target.startsWith('stat:')) {\r\n        return { label: `unknown target ${target}`, count: 0 };\r\n    }\r\n\r\n    const statKey = target.slice('stat:'.length);\r\n    const zero = BigNum.fromInt(0);\r\n\r\n    // Treat any XP-related key as \"XP\": level + progress + multiplier.\r\n    if (statKey === 'xp' || statKey === 'xpLevel' || statKey === 'xpProgress') {\r\n        applyXpState({ level: zero, progress: zero });\r\n        // Temporarily force XP multiplier to 1x (override cleared on next real update)\r\n        try { setDebugStatMultiplierOverride('xp', BigNum.fromInt(1)); } catch {}\r\n        return { label: 'XP', count: 1 };\r\n    }\r\n\r\n    // Treat any MP / mutation key as \"MP\": level + progress + multiplier.\r\n    if (\r\n        statKey === 'mutation' ||\r\n        statKey === 'mp' ||\r\n        statKey === 'mpLevel' ||\r\n        statKey === 'mpProgress'\r\n    ) {\r\n        applyMutationState({ level: zero, progress: zero });\r\n        // Temporarily force MP multiplier to 1x, same semantics as XP\r\n        try { setDebugStatMultiplierOverride('mutation', BigNum.fromInt(1)); } catch {}\r\n        return 'MP';\r\n    }\r\n\r\n    // Fallback: generic stat multiplier reset -> same semantics as the debug stat input\r\n    try { setDebugStatMultiplierOverride(statKey, BigNum.fromInt(1)); } catch {}\r\n    return `stat ${statKey}`;\r\n}\r\n\r\nfunction buildAreaStatMultipliers(container, area) {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) {\r\n        const msg = document.createElement('div');\r\n        msg.className = 'debug-panel-empty';\r\n        msg.textContent = 'Select a save slot to edit stat multipliers.';\r\n        container.appendChild(msg);\r\n        return;\r\n    }\r\n\r\n    const areaLabel = area?.title ?? area?.key ?? 'Unknown Area';\r\n\r\n    STAT_MULTIPLIERS.forEach((stat) => {\r\n        if (stat.key === 'spawnRate') return;\r\n        const storageKey = getStatMultiplierStorageKey(stat.key, slot);\r\n        const row = createInputRow(\r\n            `${stat.label} Multiplier`,\r\n            getStatMultiplierDisplayValue(stat.key, slot),\r\n            (value, { setValue }) => {\r\n                const latestSlot = getActiveSlot();\r\n                if (latestSlot == null) return;\r\n                const previous = getStatMultiplierDisplayValue(stat.key, latestSlot);\r\n                try { setDebugStatMultiplierOverride(stat.key, value, latestSlot); } catch {}\r\n                const refreshed = getStatMultiplierDisplayValue(stat.key, latestSlot);\r\n                setValue(refreshed);\r\n                if (!bigNumEquals(previous, refreshed)) {\r\n                    flagDebugUsage();\r\n                    logAction(\r\n                        `Modified ${stat.label} Multiplier (${areaLabel}) ${formatNumber(previous)} \u2192 ${formatNumber(refreshed)}`\r\n                    );\r\n                }\r\n            },\r\n            {\r\n                storageKey,\r\n                onLockChange: (locked) => {\r\n                    const latestSlot = getActiveSlot();\r\n                    if (latestSlot == null) return;\r\n                    if (locked) {\r\n                        const existingOverride = getLockedStatOverride(latestSlot, stat.key);\r\n                        if (existingOverride) return;\r\n                        try {\r\n                            setDebugStatMultiplierOverride(\r\n                                stat.key,\r\n                                getGameStatMultiplier(stat.key),\r\n                                latestSlot\r\n                            );\r\n                        } catch {}\r\n                    } else {\r\n                        getEffectiveStatMultiplierOverride(\r\n                            stat.key,\r\n                            latestSlot,\r\n                            getGameStatMultiplier(stat.key)\r\n                        );\r\n                    }\r\n                    row.setValue(getStatMultiplierDisplayValue(stat.key, latestSlot));\r\n                },\r\n            }\r\n        );\r\n\r\n        registerLiveBinding({\r\n            type: 'stat-mult',\r\n            key: stat.key,\r\n            slot,\r\n            refresh: () => {\r\n                if (slot !== getActiveSlot()) return;\r\n                const latest = getStatMultiplierDisplayValue(stat.key, slot);\r\n                row.setValue(latest);\r\n            },\r\n        });\r\n\r\n        registerLiveBinding({\r\n            type: 'upgrade',\r\n            key: stat.key,\r\n            slot,\r\n            refresh: () => {\r\n                if (slot !== getActiveSlot()) return;\r\n                const latest = getStatMultiplierDisplayValue(stat.key, slot);\r\n                row.setValue(latest);\r\n            },\r\n        });\r\n\r\n        if (stat.key === 'mutation') {\r\n            registerLiveBinding({\r\n                type: 'mutation',\r\n                key: stat.key,\r\n                slot,\r\n                refresh: () => {\r\n                    if (slot !== getActiveSlot()) return;\r\n                    const latest = getStatMultiplierDisplayValue(stat.key, slot);\r\n                    row.setValue(latest);\r\n                },\r\n            });\r\n        }\r\n\r\n        container.appendChild(row.row);\r\n    });\r\n}\r\n\r\nfunction buildAreaCalculators(container) {\r\n    const calculators = [\r\n        {\r\n            title: 'Currencies',\r\n            rows: [\r\n                {\r\n                    label: 'Pending Gold (Forge)',\r\n                    inputs: [\r\n                        { key: 'coins', label: 'Coins' },\r\n                        { key: 'xpLevel', label: 'XP Level' },\r\n                    ],\r\n                    compute: ({ coins, xpLevel }) => window.resetSystem?.computeForgeGoldFromInputs?.(coins, xpLevel),\r\n                },\r\n                {\r\n                    label: 'Pending Magic (Infuse)',\r\n                    inputs: [\r\n                        { key: 'coins', label: 'Coins' },\r\n                        { key: 'mp', label: 'Cumulative MP' },\r\n                    ],\r\n                    compute: ({ coins, mp }) => window.resetSystem?.computeInfuseMagicFromInputs?.(coins, mp),\r\n                },\r\n                {\r\n                    label: 'Pending Waves (Surge)',\r\n                    inputs: [\r\n                        { key: 'xpLevel', label: 'XP Level' },\r\n                        { key: 'coins', label: 'Coins' },\r\n                        { key: 'gold', label: 'Gold' },\r\n                        { key: 'magic', label: 'Magic' },\r\n                        { key: 'mp', label: 'Cumulative MP' },\r\n                    ],\r\n                    compute: ({ xpLevel, coins, gold, magic, mp }) => window.resetSystem?.computeSurgeWavesFromInputs?.(xpLevel, coins, gold, magic, mp),\r\n                },\r\n            ],\r\n        },\r\n        {\r\n            title: 'Stats',\r\n            rows: [\r\n                {\r\n                    label: 'XP Requirement',\r\n                    inputs: [\r\n                        { key: 'xpLevel', label: 'XP Level' },\r\n                    ],\r\n                    compute: ({ xpLevel }) => getXpRequirementForXpLevel(xpLevel),\r\n                },\r\n                {\r\n                    label: 'XP Level Coin Multiplier',\r\n                    inputs: [\r\n                        { key: 'xpLevel', label: 'XP Level' },\r\n                    ],\r\n                    compute: ({ xpLevel }) => computeCoinMultiplierForXpLevel(xpLevel),\r\n                },\r\n                {\r\n                    label: 'MP Requirement',\r\n                    inputs: [\r\n                        { key: 'mpLevel', label: 'MP Level' },\r\n                    ],\r\n                    compute: ({ mpLevel }) => computeMutationRequirementForLevel(mpLevel),\r\n                },\r\n                {\r\n                    label: 'MP Level Coin/XP Multiplier',\r\n                    inputs: [\r\n                        { key: 'mpLevel', label: 'MP Level' },\r\n                    ],\r\n                    compute: ({ mpLevel }) => computeMutationMultiplierForLevel(mpLevel),\r\n                },\r\n                {\r\n                    label: 'Workshop Level Cost',\r\n                    inputs: [\r\n                        { key: 'level', label: 'Level' },\r\n                    ],\r\n                    compute: ({ level }) => getGenerationUpgradeCost(level),\r\n                },\r\n            ],\r\n        },\r\n        {\r\n            title: 'Other',\r\n            rows: [\r\n                {\r\n                    label: 'Default Upgrade Level Cost',\r\n                    inputs: [\r\n                        { key: 'baseCost', label: 'Base Cost' },\r\n                        { key: 'level', label: 'Current Upgrade Level' },\r\n                        {\r\n                            key: 'mode',\r\n                            type: 'select',\r\n                            defaultValue: 'NM',\r\n                            options: [\r\n                                { value: 'NM', label: 'No Milestones' },\r\n                                { value: 'HM', label: 'Has Milestones' },\r\n                            ],\r\n                        },\r\n                    ],\r\n                    compute: ({ baseCost, level, mode }) => computeDefaultUpgradeCost(baseCost, level, mode),\r\n                },\r\n            ],\r\n        },\r\n    ];\r\n\r\n    calculators.forEach((group) => {\r\n        const subsection = createSubsection(group.title, (sub) => {\r\n            if (!group.rows || group.rows.length === 0) {\r\n                const msg = document.createElement('div');\r\n                msg.className = 'debug-panel-empty';\r\n                msg.textContent = 'No calculators available yet.';\r\n                sub.appendChild(msg);\r\n                return;\r\n            }\r\n\r\n            group.rows.forEach((row) => {\r\n                const calculatorRow = createCalculatorRow({\r\n                    labelText: row.label,\r\n                    inputs: row.inputs,\r\n                    compute: row.compute,\r\n                });\r\n                sub.appendChild(calculatorRow);\r\n            });\r\n        });\r\n\r\n        container.appendChild(subsection);\r\n    });\r\n}\r\n\r\nfunction buildAreasContent(content) {\r\n    content.innerHTML = '';\r\n\r\n    const slot = getActiveSlot();\r\n    if (slot == null) {\r\n        const placeholder = document.createElement('div');\r\n        placeholder.className = 'debug-panel-empty';\r\n        placeholder.textContent = 'Areas are available once a save slot is selected.';\r\n        content.appendChild(placeholder);\r\n        return;\r\n    }\r\n\r\n    applyAllCurrencyOverridesForActiveSlot();\r\n\r\n    const areas = getAreas();\r\n\r\n    areas.forEach((area) => {\r\n        const areaContainer = createSubsection(area.title, (areaContent) => {\r\n            const currencies = createSubsection('Currencies', (sub) => {\r\n                buildAreaCurrencies(sub, area);\r\n            });\r\n            const stats = createSubsection('Stats', (sub) => {\r\n                buildAreaStats(sub, area);\r\n            });\r\n            const multipliers = createSubsection('Multipliers', (sub) => {\r\n                const currencyMultipliers = createSubsection('Currencies', (subsection) => {\r\n                    buildAreaCurrencyMultipliers(subsection, area);\r\n                });\r\n                const statMultipliers = createSubsection('Stats', (subsection) => {\r\n                    buildAreaStatMultipliers(subsection, area);\r\n                });\r\n\r\n                sub.appendChild(currencyMultipliers);\r\n                sub.appendChild(statMultipliers);\r\n            });\r\n            const upgrades = createSubsection('Upgrades', (sub) => {\r\n                buildAreaUpgrades(sub, area);\r\n            });\r\n            \r\n            let automationUpgrades = null;\r\n            if (area.key === AREA_KEYS.STARTER_COVE) {\r\n                automationUpgrades = createSubsection('Automation Upgrades', (sub) => {\r\n                    buildAreaUpgrades(sub, { key: AREA_KEYS.AUTOMATION, title: 'Automation' });\r\n                });\r\n            }\r\n\r\n            const calculators = createSubsection('Calculators', (sub) => {\r\n                buildAreaCalculators(sub);\r\n            });\r\n\t\t\t\r\n            areaContent.appendChild(currencies);\r\n            areaContent.appendChild(stats);\r\n            areaContent.appendChild(multipliers);\r\n            areaContent.appendChild(upgrades);\r\n            if (automationUpgrades) {\r\n                areaContent.appendChild(automationUpgrades);\r\n            }\r\n            areaContent.appendChild(calculators);\r\n        });\r\n        areaContainer.classList.add('debug-panel-area');\r\n\r\n        content.appendChild(areaContainer);\r\n    });\r\n}\r\n\r\nfunction setAllUpgradesMaxed(onlyUnlocked = false) {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) return 0;\r\n\r\n    let count = 0;\r\n    const areas = Object.values(AREA_KEYS);\r\n    const targets = [];\r\n\r\n    areas.forEach(areaKey => {\r\n        const upgrades = getUpgradesForArea(areaKey);\r\n        upgrades.forEach(upg => {\r\n            if (onlyUnlocked) {\r\n                const lockState = getUpgradeLockState(areaKey, upg.id);\r\n                if (lockState.locked) return;\r\n            }\r\n            targets.push({ areaKey, upg });\r\n        });\r\n    });\r\n\r\n    batchUpgradeOperations(() => {\r\n        targets.forEach(({ areaKey, upg }) => {\r\n            try {\r\n                const targetLevel = upg.lvlCap;\r\n                setLevel(areaKey, upg.id, targetLevel);\r\n                count++;\r\n            } catch (e) {\r\n                console.warn('Failed to max upgrade', upg, e);\r\n            }\r\n        });\r\n    });\r\n    return count;\r\n}\r\n\r\nfunction setAllUpgradesZero(onlyUnlocked = false) {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) return 0;\r\n\r\n    let count = 0;\r\n    const areas = Object.values(AREA_KEYS);\r\n    const targets = [];\r\n\r\n    areas.forEach(areaKey => {\r\n        const upgrades = getUpgradesForArea(areaKey);\r\n        upgrades.forEach(upg => {\r\n            if (onlyUnlocked) {\r\n                const lockState = getUpgradeLockState(areaKey, upg.id);\r\n                if (lockState.locked) return;\r\n            }\r\n            targets.push({ areaKey, upg });\r\n        });\r\n    });\r\n\r\n    batchUpgradeOperations(() => {\r\n        targets.forEach(({ areaKey, upg }) => {\r\n            try {\r\n                setLevel(areaKey, upg.id, 0);\r\n                count++;\r\n            } catch (e) {\r\n                console.warn('Failed to zero upgrade', upg, e);\r\n            }\r\n        });\r\n    });\r\n    return count;\r\n}\r\n\r\nfunction setAllAutomationToggles(targetState) {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) return 0;\r\n\r\n    const val = targetState ? '1' : '0';\r\n    let count = 0;\r\n\t\r\n\t// 1. Max (or Zero) Automation Upgrades\r\n    const automationUpgrades = getUpgradesForArea(AUTOMATION_AREA_KEY);\r\n    batchUpgradeOperations(() => {\r\n        automationUpgrades.forEach(upg => {\r\n            try {\r\n                // If targetState is true, set to max level (lvlCap).\r\n                // If false, set to 0.\r\n                const lvl = targetState ? upg.lvlCap : 0;\r\n                setLevel(AUTOMATION_AREA_KEY, upg.id, lvl);\r\n                count++;\r\n            } catch (e) {\r\n                console.warn('Failed to set automation level', upg, e);\r\n            }\r\n        });\r\n    });\r\n\r\n    // 2. Set Master Switches (UI state)\r\n    // Keys: ccc:autobuy:master:{type}:{slot}\r\n    const masterTypes = Object.values(MASTER_AUTOBUY_IDS);\r\n    const automatedCostTypes = new Set(masterTypes);\r\n    \r\n    masterTypes.forEach(type => {\r\n         const key = `ccc:autobuy:master:${type}:${slot}`;\r\n         localStorage.setItem(key, val);\r\n    });\r\n\r\n    // 3. Set Individual Toggles (Logic state)\r\n    // Iterate over ALL areas to support future upgrades\r\n    Object.values(AREA_KEYS).forEach(areaKey => {\r\n        if (areaKey === AUTOMATION_AREA_KEY) return; // Handled separately below (or via specific logic)\r\n        \r\n        const upgrades = getUpgradesForArea(areaKey);\r\n        upgrades.forEach((upg) => {\r\n            if (automatedCostTypes.has(upg.costType)) {\r\n                setAutobuyerToggle(areaKey, upg.id, val);\r\n                count++;\r\n            }\r\n        });\r\n    });\r\n\r\n    // 4. Workshop Special Case\r\n    setAutobuyerToggle(AUTOMATION_AREA_KEY, AUTOBUY_WORKSHOP_LEVELS_ID, val);\r\n    count++;\r\n\r\n    // Force UI refresh if shop is open\r\n    try { window.dispatchEvent(new CustomEvent('debug:change', { detail: { slot } })); } catch {}\r\n\r\n    return count;\r\n}\r\n\r\nfunction buildMiscContent(content) {\r\n    content.innerHTML = '';\r\n\r\n    const slot = getActiveSlot();\r\n    if (slot == null) {\r\n        const placeholder = document.createElement('div');\r\n        placeholder.className = 'debug-panel-empty';\r\n        placeholder.textContent = 'Miscellaneous tools are available once a save slot is selected.';\r\n        content.appendChild(placeholder);\r\n        return;\r\n    }\r\n\r\n    const buttons = [\r\n        {\r\n            label: 'Complete Dialogues',\r\n            onClick: () => {\r\n                const { completed } = completeAllDialoguesForDebug();\r\n                flagDebugUsage();\r\n                logAction(`Completed all dialogues (${completed} newly claimed).`);\r\n            },\r\n        },\r\n        {\r\n            label: 'Restore Dialogues',\r\n            onClick: () => {\r\n                const { restored } = restoreAllDialoguesForDebug();\r\n                flagDebugUsage();\r\n                const entryLabel = restored === 1 ? 'entry' : 'entries';\r\n                logAction(`Restored dialogues to unclaimed state (${restored} ${entryLabel} reset).`);\r\n            },\r\n        },\r\n        {\r\n            label: 'All Currencies Inf',\r\n            onClick: () => {\r\n                const touched = setAllCurrenciesToInfinity();\r\n                flagDebugUsage();\r\n                logAction(`Set all currencies to Infinity (${touched} ${touched === 1 ? 'currency' : 'currencies'} updated).`);\r\n            },\r\n        },\r\n        {\r\n            label: 'All Stats Inf',\r\n            onClick: () => {\r\n                                const touched = setAllStatsToInfinity();\r\n                flagDebugUsage();\r\n                logAction(`Set all stats to Infinity (${touched} ${touched === 1 ? 'stat' : 'stats'} updated).`);\r\n            },\r\n        },\r\n\t\t{\r\n            label: 'All Currencies 0',\r\n            onClick: () => {\r\n                const touched = setAllCurrenciesToZero();\r\n                flagDebugUsage();\r\n                logAction(`Set all currencies to 0 (${touched} ${touched === 1 ? 'currency' : 'currencies'} updated).`);\r\n            },\r\n        },\r\n        {\r\n            label: 'All Stats 0',\r\n            onClick: () => {\r\n                const touched = setAllStatsToZero();\r\n                flagDebugUsage();\r\n                logAction(`Set all unlocked stats to 0 (${touched} ${touched === 1 ? 'stat' : 'stats'} updated).`);\r\n            },\r\n        },\r\n        {\r\n            label: 'All [UL] Upgs Maxed',\r\n            onClick: () => {\r\n                const count = setAllUpgradesMaxed(true);\r\n                flagDebugUsage();\r\n                logAction(`Maxed ${count} unlocked upgrades.`);\r\n            },\r\n        },\r\n        {\r\n            label: 'All [UL] Upgs 0',\r\n            onClick: () => {\r\n                const count = setAllUpgradesZero(true);\r\n                flagDebugUsage();\r\n                logAction(`Reset ${count} unlocked upgrades to 0.`);\r\n            },\r\n        },\r\n        {\r\n            label: 'All Upgs Maxed',\r\n            onClick: () => {\r\n                const count = setAllUpgradesMaxed(false);\r\n                flagDebugUsage();\r\n                logAction(`Maxed all ${count} upgrades.`);\r\n            },\r\n        },\r\n        {\r\n            label: 'All Upgs 0',\r\n            onClick: () => {\r\n                const count = setAllUpgradesZero(false);\r\n                flagDebugUsage();\r\n                logAction(`Reset all ${count} upgrades to 0.`);\r\n            },\r\n        },\r\n        {\r\n            label: 'Enable All Auto',\r\n            onClick: () => {\r\n                const count = setAllAutomationToggles(true);\r\n                flagDebugUsage();\r\n                logAction(`Enabled automation for ${count} upgrades.`);\r\n            },\r\n        },\r\n        {\r\n            label: 'Disable All Auto',\r\n            onClick: () => {\r\n                const count = setAllAutomationToggles(false);\r\n                flagDebugUsage();\r\n                logAction(`Disabled automation for ${count} upgrades.`);\r\n            },\r\n        },\r\n        {\r\n            label: 'Unlock All Unlocks',\r\n            onClick: () => {\r\n                const { unlocks, toggles } = unlockAllUnlocks();\r\n                flagDebugUsage();\r\n                logAction(`Unlocked all unlock-type upgrades (${unlocks} entries) and unlock flags (${toggles} toggled).`);\r\n            },\r\n        },\r\n        {\r\n            label: 'Lock All Unlocks',\r\n            onClick: () => {\r\n                const { locks, toggles } = lockAllUnlockUpgrades();\r\n                flagDebugUsage();\r\n                logAction(`Locked all unlock-type upgrades (${locks} entries) and unlock flags (${toggles} toggled).`);\r\n            },\r\n        },\r\n        {\r\n            label: 'Wipe Action Log',\r\n            onClick: () => {\r\n                persistActionLog([], slot);\r\n                updateActionLogDisplay();\r\n                flagDebugUsage();\r\n                logAction('Action log wiped and reset.');\r\n            },\r\n        },\r\n    ];\r\n\r\n    const buttonGrid = document.createElement('div');\r\n    buttonGrid.className = 'debug-misc-button-list';\r\n    buttons.forEach((cfg) => {\r\n        const btn = document.createElement('button');\r\n        btn.type = 'button';\r\n        btn.className = 'debug-panel-toggle debug-misc-button';\r\n        btn.textContent = cfg.label;\r\n        btn.addEventListener('click', cfg.onClick);\r\n        buttonGrid.appendChild(btn);\r\n    });\r\n    content.appendChild(buttonGrid);\r\n\r\n    const resetRow = document.createElement('div');\r\n    resetRow.className = 'debug-panel-row';\r\n    const resetLabel = document.createElement('label');\r\n    resetLabel.textContent = 'Reset Values & Multis For:';\r\n    resetRow.appendChild(resetLabel);\r\n\r\n    const resetSelect = document.createElement('select');\r\n    resetSelect.className = 'debug-panel-input debug-reset-values-select';\r\n\r\n    getAreas().forEach((area) => {\r\n        const group = document.createElement('optgroup');\r\n        group.label = area.title || area.key;\r\n        area.currencies.forEach((currency) => {\r\n            const opt = document.createElement('option');\r\n            opt.value = `currency:${currency.key}`;\r\n            opt.textContent = `${area.title || area.key} \u2192 ${currency.label}`;\r\n            group.appendChild(opt);\r\n        });\r\n        area.stats.forEach((stat) => {\r\n            const opt = document.createElement('option');\r\n            opt.value = `stat:${stat.key}`;\r\n            opt.textContent = `${area.title || area.key} \u2192 ${stat.label}`;\r\n            group.appendChild(opt);\r\n        });\r\n        resetSelect.appendChild(group);\r\n    });\r\n\r\n    const allCurrenciesOption = document.createElement('option');\r\n    allCurrenciesOption.value = 'allCurrencies';\r\n    allCurrenciesOption.textContent = 'All Currencies';\r\n    resetSelect.appendChild(allCurrenciesOption);\r\n\r\n    const allUnlockedStatsOption = document.createElement('option');\r\n    allUnlockedStatsOption.value = 'allUnlockedStats';\r\n    allUnlockedStatsOption.textContent = 'All Unlocked Stats';\r\n    resetSelect.appendChild(allUnlockedStatsOption);\r\n\t\r\n\tconst allUnlockedOption = document.createElement('option');\r\n    allUnlockedOption.value = 'allUnlocked';\r\n    allUnlockedOption.textContent = 'All Unlocked Stats & Currs';\r\n    resetSelect.appendChild(allUnlockedOption);\r\n\r\n    const allOption = document.createElement('option');\r\n    allOption.value = 'all';\r\n    allOption.textContent = 'All';\r\n    resetSelect.appendChild(allOption);\r\n\r\n    if (!resetSelect.querySelector(`option[value=\"${debugPanelMiscResetSelection}\"]`)) {\r\n        debugPanelMiscResetSelection = DEFAULT_MISC_RESET_SELECTION;\r\n    }\r\n    resetSelect.value = debugPanelMiscResetSelection;\r\n\r\n    const resolveResetLockKeys = () => getResetTargetLockKeys(resetSelect.value || DEFAULT_MISC_RESET_SELECTION, getActiveSlot());\r\n\r\n    const resetLockToggle = createCompositeLockToggle(resolveResetLockKeys);\r\n    resetSelect.addEventListener('change', () => {\r\n        debugPanelMiscResetSelection = resetSelect.value || DEFAULT_MISC_RESET_SELECTION;\r\n        resetLockToggle.refresh();\r\n    });\r\n\r\n    resetLockToggle.refresh();\r\n\r\n    resetRow.appendChild(resetSelect);\r\n    resetRow.appendChild(resetLockToggle.button);\r\n\r\n    const resetBtn = document.createElement('button');\r\n    resetBtn.type = 'button';\r\n    resetBtn.className = 'debug-panel-toggle reset-check';\r\n    resetBtn.textContent = '\u2705';\r\n    resetBtn.addEventListener('click', () => {\r\n        const target = resetSelect.value || DEFAULT_MISC_RESET_SELECTION;\r\n        const lockKeys = resolveResetLockKeys();\r\n        const shouldRelock = resetLockToggle.isLocked();\r\n        const result = withTemporaryUnlock(lockKeys, () => resetStatsAndMultipliers(target))\r\n            ?? { label: target, count: 0 };\r\n        if (shouldRelock) {\r\n            lockKeys.forEach((key) => lockStorageKey(key));\r\n        }\r\n        resetLockToggle.refresh();\r\n        const { label, count } = result;\r\n        const nounPhrase = count === 1 ? 'value and multiplier' : 'values and multipliers';\r\n        flagDebugUsage();\r\n        logAction(`Reset ${nounPhrase} for ${label} to defaults.`);\r\n    });\r\n    resetRow.appendChild(resetBtn);\r\n    content.appendChild(resetRow);\r\n\r\n    const actionLogRow = document.createElement('div');\r\n    actionLogRow.className = 'debug-panel-row';\r\n\r\nconst wipeSlotBtn = document.createElement('button');\r\nwipeSlotBtn.type = 'button';\r\nwipeSlotBtn.className = 'debug-panel-toggle debug-danger-button';\r\nwipeSlotBtn.textContent = 'Wipe Slot & Refresh';\r\nwipeSlotBtn.addEventListener('click', () => {\r\n    const confirmWipe = window.confirm?.(\r\n        'Are you sure you want to wipe current slot data and refresh the page? This cannot be undone.'\r\n    );\r\n    if (!confirmWipe) return;\r\n\r\n    try {\r\n        localStorage.setItem('ccc:pendingSlotWipe', String(slot));\r\n    } catch {}\r\n\r\n    try {\r\n        localStorage.removeItem('ccc:saveSlot');\r\n    } catch {}\r\n\r\n    try {\r\n        const menuRoot = document.querySelector('.menu-root');\r\n        const gameRoot = document.getElementById('game-root');\r\n        if (menuRoot) {\r\n            menuRoot.hidden = false;\r\n            menuRoot.style.display = '';\r\n            menuRoot.style.visibility = '';\r\n        }\r\n        if (gameRoot) {\r\n            gameRoot.hidden = true;\r\n            gameRoot.style.display = 'none';\r\n        }\r\n    } catch {}\r\n\r\n    try {\r\n        setTimeout(() => {\r\n            try { window.location.reload(); } catch {}\r\n        }, 16);\r\n    } catch {\r\n        try { window.location.reload(); } catch {}\r\n    }\r\n});\r\nactionLogRow.appendChild(wipeSlotBtn);\r\n\r\n    content.appendChild(actionLogRow);\r\n}\r\n\r\nfunction buildUnlocksContent(content) {\r\n    content.innerHTML = '';\r\n\r\n    const slot = getActiveSlot();\r\n    if (slot == null) {\r\n        const placeholder = document.createElement('div');\r\n        placeholder.className = 'debug-panel-empty';\r\n        placeholder.textContent = 'Unlocks are available once a save slot is selected.';\r\n        content.appendChild(placeholder);\r\n        return;\r\n    }\r\n\r\n    try { initXpSystem(); }\r\n    catch {}\r\n\r\n    const rows = getUnlockRowDefinitions(slot);\r\n\r\n    rows.sort((a, b) => {\r\n        const textA = a.labelText ?? '';\r\n        const textB = b.labelText ?? '';\r\n        return textA.localeCompare(textB, undefined, { sensitivity: 'base' });\r\n    });\r\n\r\n    rows.forEach((rowDef) => {\r\n        content.appendChild(createUnlockToggleRow(rowDef));\r\n    });\r\n}\r\n\r\nfunction buildDebugPanel() {\r\n    if (!debugPanelAccess || isOnMenu()) return;\r\n    cleanupDebugPanelResources();\r\n    ensureDebugPanelStyles();\r\n    sectionKeyCounter = 0;\r\n    subsectionKeyCounter = 0;\r\n\r\n    const existingPanel = document.getElementById(DEBUG_PANEL_ID);\r\n    if (existingPanel) existingPanel.remove();\r\n\r\n    const panel = document.createElement('div');\r\n    panel.id = DEBUG_PANEL_ID;\r\n    panel.className = 'debug-panel';\r\n\r\n    const header = document.createElement('div');\r\n    header.className = 'debug-panel-header';\r\n\r\n    const titleContainer = document.createElement('div');\r\n\r\n    const title = document.createElement('div');\r\n    title.className = 'debug-panel-title';\r\n    title.textContent = 'Debug Panel';\r\n\r\n    const closeButtonContainer = document.createElement('div');\r\n    closeButtonContainer.className = 'debug-panel-close-buttons';\r\n\r\n    const closeButton = document.createElement('button');\r\n    closeButton.className = 'debug-panel-close';\r\n    closeButton.type = 'button';\r\n    closeButton.setAttribute('aria-label', 'Close Debug Panel');\r\n    closeButton.textContent = 'Close';\r\n    closeButton.addEventListener('click', () => closeDebugPanel({ preserveExpansionState: true }));\r\n\r\n    const collapseCloseButton = document.createElement('button');\r\n    collapseCloseButton.className = 'debug-panel-close debug-panel-close-collapse';\r\n    collapseCloseButton.type = 'button';\r\n    collapseCloseButton.setAttribute('aria-label', 'Close Debug Panel and Collapse Sections');\r\n    collapseCloseButton.textContent = 'Close & Collapse';\r\n    collapseCloseButton.addEventListener('click', () => closeDebugPanel());\r\n\r\n    closeButtonContainer.appendChild(closeButton);\r\n    closeButtonContainer.appendChild(collapseCloseButton);\r\n\r\n    titleContainer.appendChild(title);\r\n    const info = document.createElement('div');\r\n    info.className = 'debug-panel-info';\r\n\r\n    const infoLines = [\r\n        { text: 'C: Close and preserve panels', hideOnMobile: true },\r\n        { text: 'Shift+C: Close and collapse panels', hideOnMobile: true },\r\n        { text: 'Input fields can take a normal, scientific, or BN number as input' },\r\n        { text: 'Input value \"inf\" sets a value to infinity or an upgrade to its level cap' },\r\n        { text: 'Toggle UL/L (Unlocked/Locked) on a value to freeze it from accruing normally' },\r\n    ];\r\n\r\n    infoLines.forEach(({ text, hideOnMobile }) => {\r\n        const infoLine = document.createElement('div');\r\n        infoLine.className = 'debug-panel-info-line';\r\n        if (hideOnMobile) infoLine.classList.add('debug-panel-info-mobile-hidden');\r\n        infoLine.textContent = text;\r\n        info.appendChild(infoLine);\r\n    });\r\n\r\n    titleContainer.appendChild(info);\r\n\r\n    header.appendChild(titleContainer);\r\n    header.appendChild(closeButtonContainer);\r\n    panel.appendChild(header);\r\n\r\n    panel.appendChild(createSection('Areas: main currency/stat/upgrade management for each area', 'debug-areas', content => {\r\n        buildAreasContent(content);\r\n    }));\r\n\r\n    panel.appendChild(createSection('Unlocks: modify specific unlock flags', 'debug-unlocks', content => {\r\n        buildUnlocksContent(content);\r\n    }));\r\n\r\n    panel.appendChild(createSection('Action Log: keep track of everything you do', 'debug-action-log', content => {\r\n        const container = document.createElement('div');\r\n        container.id = 'action-log-entries';\r\n        container.className = 'debug-panel-action-log';\r\n        container.style.maxHeight = '240px';\r\n        container.style.overflowY = 'auto';\r\n        content.appendChild(container);\r\n        actionLogContainer = container;\r\n        updateActionLogDisplay();\r\n        addDebugPanelCleanup(() => { actionLogContainer = null; });\r\n    }));\r\n\t\r\n    panel.appendChild(createSection('Miscellaneous: helpful miscellaneous functions', 'debug-misc', content => {\r\n        buildMiscContent(content);\r\n    }));\r\n\r\n    applyDebugPanelExpansionState(panel);\r\n\r\n    document.body.appendChild(panel);\r\n\r\n    if (debugPanelScrollTop > 0) {\r\n        try { panel.scrollTop = debugPanelScrollTop; }\r\n        catch {}\r\n    }\r\n    setupLiveBindingListeners();\r\n    debugPanelOpen = true;\r\n}\r\n\r\nfunction openDebugPanel() {\r\n    if (!debugPanelAccess || isOnMenu()) return;\r\n    if (getActiveSlot() == null) {\r\n        closeDebugPanel();\r\n        return;\r\n    }\r\n    if (debugPanelOpen) return;\r\n    buildDebugPanel();\r\n}\r\n\r\nfunction closeDebugPanel({ preserveExpansionState = false } = {}) {\r\n    debugPanelExpansionState = preserveExpansionState\r\n        ? captureDebugPanelExpansionState()\r\n        : createEmptyExpansionState();\r\n    const panel = document.getElementById(DEBUG_PANEL_ID);\r\n    if (panel) {\r\n        try { debugPanelScrollTop = panel.scrollTop ?? 0; }\r\n        catch { debugPanelScrollTop = 0; }\r\n        panel.remove();\r\n    }\r\n    cleanupDebugPanelResources();\r\n    debugPanelOpen = false;\r\n}\r\n\r\nfunction toggleDebugPanel() {\r\n    if (!debugPanelAccess || isOnMenu() || getActiveSlot() == null) {\r\n        closeDebugPanel();\r\n        return;\r\n    }\r\n    if (debugPanelOpen) {\r\n        closeDebugPanel({ preserveExpansionState: true });\r\n    } else {\r\n        openDebugPanel();\r\n    }\r\n}\r\n\r\nfunction teardownDebugPanel() {\r\n    closeDebugPanel();\r\n    removeDebugPanelToggleButton();\r\n}\r\n\r\nfunction createDebugPanelToggleButton() {\r\n    if (!shouldShowDebugPanelToggleButton()) {\r\n        removeDebugPanelToggleButton();\r\n        closeDebugPanel();\r\n        return;\r\n    }\r\n    ensureDebugPanelStyles();\r\n\r\n    removeDebugPanelToggleButton();\r\n\r\n    const button = document.createElement('button');\r\n    button.id = DEBUG_PANEL_TOGGLE_ID;\r\n    button.className = 'debug-panel-toggle-button';\r\n    button.type = 'button';\r\n    button.textContent = 'Debug Panel';\r\n    let lastPointerType = null;\r\n\r\n    const handleToggle = (event) => {\r\n        toggleDebugPanel();\r\n    };\r\n\r\n    button.addEventListener('click', (event) => {\r\n        if (lastPointerType && lastPointerType !== 'mouse') {\r\n            lastPointerType = null;\r\n            return;\r\n        }\r\n        lastPointerType = null;\r\n        handleToggle(event);\r\n    });\r\n\r\n    document.body.appendChild(button);\r\n}\r\n\r\nfunction applyDebugPanelAccess(enabled) {\r\n    debugPanelAccess = !!enabled;\r\n    if (!debugPanelAccess) {\r\n        teardownDebugPanel();\r\n        return;\r\n    }\r\n    createDebugPanelToggleButton();\r\n}\r\n\r\napplyDebugPanelAccess(false);\r\n\r\ndocument.addEventListener('keydown', event => {\r\n    if (!debugPanelAccess || isOnMenu()) return;\r\n    if (event.key?.toLowerCase() !== 'c') return;\r\n    if (event.ctrlKey) return;\r\n\r\n    if (getActiveSlot() == null) return;\r\n\r\n    if (event.shiftKey) {\r\n        if (debugPanelOpen) {\r\n            collapseAllDebugCategories();\r\n            closeDebugPanel();\r\n        } else {\r\n            openDebugPanel();\r\n        }\r\n        event.preventDefault();\r\n        return;\r\n    }\r\n\r\n    if (!debugPanelOpen) {\r\n        openDebugPanel();\r\n    } else {\r\n        closeDebugPanel({ preserveExpansionState: true });\r\n    }\r\n\t\r\n    event.preventDefault();\r\n});\r\n\r\ndocument.addEventListener('DOMContentLoaded', () => {\r\n    createDebugPanelToggleButton();\r\n});\r\n\r\nwindow.addEventListener('menu:visibilitychange', onMenuVisibilityChange);\r\n\r\nwindow.addEventListener('saveSlot:change', () => {\r\n    createDebugPanelToggleButton();\r\n    if (debugPanelOpen) {\r\n        buildDebugPanel();\r\n    }\r\n});\r\n\r\nexport function setDebugPanelAccess(enabled) {\r\n    applyDebugPanelAccess(enabled);\r\n}\r\n", "// js/game/mutationSystem.js\r\n\r\nimport { BigNum } from '../util/bigNum.js';\r\nimport { getActiveSlot, watchStorageKey, primeStorageWatcherSnapshot } from '../util/storage.js';\r\nimport { applyStatMultiplierOverride } from '../util/debugPanel.js';\r\nimport { formatNumber } from '../util/numFormat.js';\r\nimport { approxLog10BigNum, bigNumFromLog10 } from './upgrades.js';\r\nimport { syncXpMpHudLayout } from '../ui/hudLayout.js';\r\nimport { refreshCoinMultiplierFromXpLevel } from './xpSystem.js';\r\n\r\nconst KEY_PREFIX = 'ccc:mutation';\r\nconst KEY_UNLOCK = (slot) => `${KEY_PREFIX}:unlocked:${slot}`;\r\nconst KEY_LEVEL = (slot) => `${KEY_PREFIX}:level:${slot}`;\r\nconst KEY_PROGRESS = (slot) => `${KEY_PREFIX}:progress:${slot}`;\r\n\r\nconst BN = BigNum;\r\nconst bnZero = () => BN.fromInt(0);\r\nconst bnOne = () => BN.fromInt(1);\r\n\r\nconst MP_LOG10_BASE = Math.log10(2);\r\nconst CONST_RATIO = (10 - 1) / (Math.pow(1.12, 50) - 1);\r\n\r\nfunction toStorageSafe(value) {\r\n  try { return value?.toStorage?.(); }\r\n  catch { return null; }\r\n}\r\n\r\nconst mutationState = {\r\n  unlocked: false,\r\n  level: bnZero(),\r\n  progress: bnZero(),\r\n  requirement: bnZero(),\r\n  slot: null,\r\n};\r\n\r\nconst hudRefs = {\r\n  container: null,\r\n  bar: null,\r\n  fill: null,\r\n  levelValue: null,\r\n  progress: null,\r\n};\r\n\r\nconst listeners = new Set();\r\nconst watcherCleanups = [];\r\nlet watchersBoundSlot = null;\r\nlet initialized = false;\r\nlet unregisterCoinMultiplierProvider = null;\r\nlet unregisterXpGainMultiplierProvider = null;\r\n\r\nfunction scheduleCoinMultiplierRefresh() {\r\n  try { refreshCoinMultiplierFromXpLevel(); } catch {}\r\n}\r\n\r\nfunction ensureExternalMultiplierProviders() {\r\n  if (typeof unregisterCoinMultiplierProvider === 'function') {\r\n    try { unregisterCoinMultiplierProvider(); } catch {}\r\n    unregisterCoinMultiplierProvider = null;\r\n  }\r\n  if (typeof unregisterXpGainMultiplierProvider === 'function') {\r\n    try { unregisterXpGainMultiplierProvider(); } catch {}\r\n    unregisterXpGainMultiplierProvider = null;\r\n  }\r\n}\r\n\r\nfunction cloneBigNum(value) {\r\n  if (value instanceof BN) {\r\n    try { return value.clone?.() ?? BN.fromAny(value); }\r\n    catch { return bnZero(); }\r\n  }\r\n  try { return BN.fromAny(value ?? 0); }\r\n  catch { return bnZero(); }\r\n}\r\n\r\nfunction quantizeRequirement(value) {\r\n  if (!value || typeof value !== 'object') return bnZero();\r\n  if (value.isInfinite?.()) return value.clone?.() ?? value;\r\n  const sci = typeof value.toScientific === 'function' ? value.toScientific(18) : '';\r\n  if (!sci || sci === 'Infinity') return value.clone?.() ?? value;\r\n  const match = sci.match(/^(\\d+(?:\\.\\d+)?)e([+-]?\\d+)$/i);\r\n  if (!match) return value.clone?.() ?? value;\r\n  const exp = parseInt(match[2], 10);\r\n  const digits = exp + 1;\r\n  if (digits <= 18) {\r\n    const floored = value.floorToInteger?.() ?? value.clone?.() ?? value;\r\n    const plain = floored.toPlainIntegerString?.();\r\n    if (!plain || plain === 'Infinity') return floored;\r\n    try {\r\n      const quant = (BigInt(plain) / 100n) * 100n;\r\n      if (quant <= 0n) return BN.fromInt(100);\r\n      return BN.fromAny(quant.toString());\r\n    } catch {\r\n      return floored;\r\n    }\r\n  }\r\n  return value.clone?.() ?? value;\r\n}\r\n\r\nfunction levelToNumber(level) {\r\n  if (!level || typeof level !== 'object') return 0;\r\n  if (level.isInfinite?.()) return Number.POSITIVE_INFINITY;\r\n  try {\r\n    const plain = level.toPlainIntegerString?.();\r\n    if (plain && plain !== 'Infinity' && plain.length <= 15) {\r\n      const num = Number(plain);\r\n      if (Number.isFinite(num)) return num;\r\n    }\r\n  } catch {}\r\n  const approxLog = approxLog10BigNum(level);\r\n  if (!Number.isFinite(approxLog)) return Number.POSITIVE_INFINITY;\r\n  if (approxLog > 308) return Number.POSITIVE_INFINITY;\r\n  return Math.pow(10, approxLog);\r\n}\r\n\r\nfunction computeRequirement(levelBn) {\r\n  // Original requirement curve, returning log10(requirement)\r\n  function baseRequirementLog10(baseLevel) {\r\n    const m = Math.max(0, baseLevel + 1);\r\n    const tail = Math.max(0, m - 10);\r\n\r\n    const poly = -0.0022175354763501742 * m * m\r\n      + 0.20449967884058884 * m\r\n      + 2.016778189084622\r\n      + 0.20418426693226513 * Math.pow(tail, 1.6418337930413576);\r\n    if (!Number.isFinite(poly)) {\r\n      return Number.POSITIVE_INFINITY;\r\n    }\r\n\r\n    let factor = 1;\r\n    if (m > 10) {\r\n      const powTerm = Math.pow(1.12, m - 10);\r\n      if (!Number.isFinite(powTerm)) {\r\n        return Number.POSITIVE_INFINITY;\r\n      }\r\n      factor += CONST_RATIO * (powTerm - 1);\r\n      if (!Number.isFinite(factor)) {\r\n        return Number.POSITIVE_INFINITY;\r\n      }\r\n    }\r\n\r\n    const totalLog10 = poly * factor;\r\n    if (!Number.isFinite(totalLog10)) {\r\n      return Number.POSITIVE_INFINITY;\r\n    }\r\n    return totalLog10;\r\n  }\r\n\r\n  const levelNum = levelToNumber(levelBn);\r\n  if (!Number.isFinite(levelNum)) {\r\n    // Infinite / NaN level \u2192 infinite requirement\r\n    return BN.fromAny('Infinity');\r\n  }\r\n\r\n  const baseLevel = Math.max(0, levelNum);\r\n\r\n  // Hard wall: mutation 100+ is impossible\r\n  if (baseLevel >= 100) {\r\n    return BN.fromAny('Infinity');\r\n  }\r\n\r\n  let totalLog10;\r\n\r\n  if (baseLevel <= 9) {\r\n    // 0\u20139: original scaling\r\n    totalLog10 = baseRequirementLog10(baseLevel);\r\n  } else if (baseLevel <= 49) {\r\n    // 10-49: \"Harsher\" Exponential Transition\r\n    //\r\n    // We want to smoothly (but rapidly) transition from:\r\n    //   Level 9: log10(req) \u2248 3.83 (calculated via baseRequirementLog10(9))\r\n    // To:\r\n    //   Level 49: log10(req) = 363,000 (Target set by user)\r\n    //\r\n    // Model: log10(req) = B * R^(baseLevel - 9)\r\n    //\r\n    // B = 3.83\r\n    // R^(49 - 9) = 363000 / 3.83\r\n    // R^40 \u2248 94778.06\r\n    // R = 94778.06 ^ (1/40) \u2248 1.33235...\r\n\r\n    const startVal = baseRequirementLog10(9); // ~3.83\r\n    const endVal = 500000.0000001;\r\n    const steps = 49 - 9; // 40\r\n\r\n    // Safety check for startVal\r\n    const safeStart = Math.max(1, startVal);\r\n\r\n    const ratio = Math.pow(endVal / safeStart, 1 / steps);\r\n    const exponent = baseLevel - 9;\r\n\r\n    totalLog10 = safeStart * Math.pow(ratio, exponent);\r\n  } else {\r\n    // 50\u201399: The New Insanity Zone\r\n    //\r\n    // Targets:\r\n    //   Level 50: 1,000,000 zeros (log10 = 1e6)\r\n    //     => secondExp = log10(1e6) = 6\r\n    //   Level 99: Original target (log10 = 1e303)\r\n    //     => secondExp = log10(1e303) = 303\r\n    //\r\n    // Interpolation: Quadratic on secondExp\r\n    //   x = baseLevel - 49 (ranges from 1 to 50)\r\n    //   L50 (x=1)  => y=6\r\n    //   L99 (x=50) => y=303\r\n    \r\n    const x = baseLevel - 49; // 1..50\r\n    \r\n    // y = A*x^2 + B\r\n    // 6 = A*1 + B\r\n    // 303 = A*2500 + B\r\n    //\r\n    // 303 - 6 = 2499*A\r\n    // 297 = 2499*A\r\n    // A = 297 / 2499\r\n    // B = 6 - A\r\n\r\n    const A = 297 / 2499;\r\n    const B = 6 - A;\r\n    \r\n    const secondExp = A * x * x + B;\r\n    if (!Number.isFinite(secondExp)) {\r\n      return BN.fromAny('Infinity');\r\n    }\r\n\r\n    // log10(requirement) = 10 ^ secondExp, nudged up slightly to avoid hitting exact thresholds\r\n    const baseLog10 = Math.pow(10, secondExp);\r\n    totalLog10 = baseLog10 * 1.00001;\r\n  }\r\n\r\n  if (!Number.isFinite(totalLog10) || totalLog10 <= 0) {\r\n    return BN.fromAny('Infinity');\r\n  }\r\n\r\n  const raw = bigNumFromLog10(totalLog10);\r\n  return quantizeRequirement(raw);\r\n}\r\n\r\nfunction ensureRequirement() {\r\n  const lvl = mutationState.level;\r\n\r\n  const levelIsInf = !!(\r\n    lvl &&\r\n    typeof lvl === 'object' &&\r\n    (lvl.isInfinite?.() || (typeof lvl.isInfinite === 'function' && lvl.isInfinite()))\r\n  );\r\n\r\n  if (levelIsInf) {\r\n    try {\r\n      const inf = BigNum.fromAny('Infinity');\r\n      mutationState.requirement = inf.clone?.() ?? inf;\r\n      mutationState.progress = inf.clone?.() ?? inf;\r\n    } catch {\r\n      if (!mutationState.requirement || typeof mutationState.requirement !== 'object') {\r\n        mutationState.requirement = BigNum.fromInt(0);\r\n      }\r\n      if (!mutationState.progress || typeof mutationState.progress !== 'object') {\r\n        mutationState.progress = BigNum.fromInt(0);\r\n      }\r\n    }\r\n    return;\r\n  }\r\n\r\n  const req = computeRequirement(mutationState.level);\r\n  mutationState.requirement = req;\r\n}\r\n\r\n\r\nfunction progressRatio(progressBn, requirement) {\r\n  if (!requirement || typeof requirement !== 'object') return 0;\r\n  if (!progressBn || typeof progressBn !== 'object') return 0;\r\n\r\n  const reqInf = requirement.isInfinite?.();\r\n  const progInf = progressBn.isInfinite?.();\r\n\r\n  // If both are infinite, treat the bar as \"full\".\r\n  if (reqInf) {\r\n    if (progInf) return 1;\r\n    return 0;\r\n  }\r\n\r\n  const reqZero = requirement.isZero?.();\r\n  if (reqZero) return 0;\r\n\r\n  const progZero = progressBn.isZero?.();\r\n  if (progZero) return 0;\r\n\r\n  const logProg = approxLog10BigNum(progressBn);\r\n  const logReq = approxLog10BigNum(requirement);\r\n  if (!Number.isFinite(logProg) || !Number.isFinite(logReq)) {\r\n    return logProg >= logReq ? 1 : 0;\r\n  }\r\n\r\n  const diff = logProg - logReq;\r\n  const ratio = Math.pow(10, diff);\r\n  if (!Number.isFinite(ratio)) {\r\n    return diff >= 0 ? 1 : 0;\r\n  }\r\n  if (ratio <= 0) return 0;\r\n  if (ratio >= 1) return 1;\r\n  return ratio;\r\n}\r\n\r\nfunction ensureHudRefs() {\r\n  if (hudRefs.container && hudRefs.container.isConnected) return true;\r\n  hudRefs.container = document.querySelector('[data-mp-hud].mp-counter');\r\n  if (!hudRefs.container) return false;\r\n  hudRefs.bar = hudRefs.container.querySelector('.mp-bar');\r\n  hudRefs.fill = hudRefs.container.querySelector('.mp-bar__fill');\r\n  hudRefs.levelValue = hudRefs.container.querySelector('.mp-level-value');\r\n  hudRefs.progress = hudRefs.container.querySelector('[data-mp-progress]');\r\n  return true;\r\n}\r\n\r\nfunction formatBn(bn) {\r\n  try { return formatNumber(bn); }\r\n  catch {\r\n    try { return bn.toPlainIntegerString?.() ?? String(bn); }\r\n    catch { return '0'; }\r\n  }\r\n}\r\n\r\nfunction updateHud() {\r\n  if (!ensureHudRefs()) return;\r\n  const { container, bar, fill, levelValue, progress } = hudRefs;\r\n  if (!container) return;\r\n  if (!mutationState.unlocked) {\r\n    container.setAttribute('hidden', '');\r\n    if (fill) {\r\n      fill.style.setProperty('--mp-fill', '0%');\r\n      fill.style.width = '0%';\r\n    }\r\n    if (levelValue) levelValue.textContent = '0';\r\n    if (progress) {\r\n      const reqHtml = formatBn(mutationState.requirement);\r\n      progress.innerHTML = `0<span class=\"mp-progress-separator\">/</span><span class=\"mp-progress-required\">${reqHtml}</span><span class=\"mp-progress-suffix\">MP</span>`;\r\n    }\r\n    if (bar) {\r\n      bar.setAttribute('aria-valuenow', '0');\r\n      const reqPlain = formatBn(mutationState.requirement).replace(/<[^>]*>/g, '');\r\n      bar.setAttribute('aria-valuetext', `0 / ${reqPlain || '10'} MP`);\r\n    }\r\n    syncXpMpHudLayout();\r\n    return;\r\n  }\r\n\r\n  container.removeAttribute('hidden');\r\n  const req = mutationState.requirement;\r\n  const ratio = progressRatio(mutationState.progress, req);\r\n  const pct = `${(ratio * 100).toFixed(2)}%`;\r\n  if (fill) {\r\n    fill.style.setProperty('--mp-fill', pct);\r\n    fill.style.width = pct;\r\n  }\r\n  if (levelValue) {\r\n    levelValue.innerHTML = formatBn(mutationState.level);\r\n  }\r\n  if (progress) {\r\n    const currentHtml = formatBn(mutationState.progress);\r\n    const reqHtml = formatBn(req);\r\n    progress.innerHTML = `<span class=\"mp-progress-current\">${currentHtml}</span><span class=\"mp-progress-separator\">/</span><span class=\"mp-progress-required\">${reqHtml}</span><span class=\"mp-progress-suffix\">MP</span>`;\r\n  }\r\n  if (bar) {\r\n    bar.setAttribute('aria-valuenow', (ratio * 100).toFixed(2));\r\n    const currPlain = formatBn(mutationState.progress).replace(/<[^>]*>/g, '');\r\n    const reqPlain = formatBn(req).replace(/<[^>]*>/g, '');\r\n    bar.setAttribute('aria-valuetext', `${currPlain} / ${reqPlain} MP`);\r\n  }\r\n  syncXpMpHudLayout();\r\n}\r\n\r\nfunction emitChange(reason = 'update', extraDetail = {}) {\r\n  const snapshot = getMutationState();\r\n  const detail = {\r\n    ...snapshot,\r\n    slot: mutationState.slot ?? getActiveSlot(),\r\n    changeType: reason,\r\n    ...extraDetail,\r\n  };\r\n\r\n  listeners.forEach((cb) => {\r\n    try { cb(snapshot, reason); } catch {}\r\n  });\r\n\r\n  if (typeof window !== 'undefined') {\r\n    try { window.dispatchEvent(new CustomEvent('mutation:change', { detail })); } catch {}\r\n  }\r\n\r\n  return detail;\r\n}\r\n\r\nfunction persistState() {\r\n  let slot = mutationState.slot;\r\n  if (slot == null) {\r\n    slot = getActiveSlot();\r\n    if (slot != null) {\r\n      mutationState.slot = slot;\r\n    }\r\n  }\r\n  if (slot == null) return;\r\n  try { localStorage.setItem(KEY_UNLOCK(slot), mutationState.unlocked ? '1' : '0'); }\r\n  catch {}\r\n  try { localStorage.setItem(KEY_LEVEL(slot), mutationState.level.toStorage()); }\r\n  catch {}\r\n  try { localStorage.setItem(KEY_PROGRESS(slot), mutationState.progress.toStorage()); }\r\n  catch {}\r\n  primeStorageWatcherSnapshot(KEY_UNLOCK(slot));\r\n  primeStorageWatcherSnapshot(KEY_LEVEL(slot));\r\n  primeStorageWatcherSnapshot(KEY_PROGRESS(slot));\r\n\r\n  // If storage writes are being blocked (e.g., via the Debug Panel lock toggle),\r\n  // fall back to the persisted values so in-memory state doesn't keep drifting\r\n  // away from the locked snapshot during gameplay.\r\n  const persisted = (() => {\r\n    let unlocked = mutationState.unlocked;\r\n    let level = mutationState.level;\r\n    let progress = mutationState.progress;\r\n    try { unlocked = localStorage.getItem(KEY_UNLOCK(slot)) === '1'; }\r\n    catch {}\r\n    try {\r\n      const rawLevel = localStorage.getItem(KEY_LEVEL(slot));\r\n      if (rawLevel) level = BN.fromAny(rawLevel);\r\n    } catch {}\r\n    try {\r\n      const rawProgress = localStorage.getItem(KEY_PROGRESS(slot));\r\n      if (rawProgress) progress = BN.fromAny(rawProgress);\r\n    } catch {}\r\n    return { unlocked, level, progress };\r\n  })();\r\n\r\n  const persistedLevelRaw = toStorageSafe(persisted.level);\r\n  const persistedProgressRaw = toStorageSafe(persisted.progress);\r\n  const expectedLevelRaw = toStorageSafe(mutationState.level);\r\n  const expectedProgressRaw = toStorageSafe(mutationState.progress);\r\n\r\n  const unlockMismatch = persisted.unlocked !== mutationState.unlocked;\r\n  const levelMismatch = persistedLevelRaw != null && expectedLevelRaw != null && persistedLevelRaw !== expectedLevelRaw;\r\n  const progressMismatch = persistedProgressRaw != null && expectedProgressRaw != null && persistedProgressRaw !== expectedProgressRaw;\r\n\r\n  if (unlockMismatch || levelMismatch || progressMismatch) {\r\n    applyState(persisted, { skipPersist: true });\r\n  }\r\n}\r\n\r\nfunction normalizeProgress() {\r\n  if (!mutationState.unlocked) return;\r\n\r\n  ensureRequirement();\r\n  let currentReq = mutationState.requirement;\r\n  if (!currentReq || typeof currentReq !== 'object') return;\r\n\r\n  // If the requirement is infinite, you can keep stacking MP forever,\r\n  // but you'll never spend it to gain more levels.\r\n  if (currentReq.isInfinite?.()) {\r\n    return;\r\n  }\r\n\r\n  let guard = 0;\r\n  const limit = 100000;\r\n\r\n  while (mutationState.progress.cmp?.(currentReq) >= 0 && guard < limit) {\r\n    // Spend MP to gain a level\r\n    mutationState.progress = mutationState.progress.sub(currentReq);\r\n    mutationState.level = mutationState.level.add(bnOne());\r\n\r\n    // Recompute requirement for the new level\r\n    ensureRequirement();\r\n    currentReq = mutationState.requirement;\r\n\r\n    if (!currentReq || typeof currentReq !== 'object') {\r\n      mutationState.progress = bnZero();\r\n      break;\r\n    }\r\n\r\n    // If the requirement becomes infinite while levelling up,\r\n    // stop levelling, but KEEP the leftover progress instead of nuking it.\r\n    if (currentReq.isInfinite?.()) {\r\n      break;\r\n    }\r\n\r\n    guard += 1;\r\n  }\r\n\r\n  // Safety: if we somehow loop too much, just bail and zero progress\r\n  if (guard >= limit) {\r\n    mutationState.progress = bnZero();\r\n  }\r\n}\r\n\r\nfunction applyState(newState, { skipPersist = false } = {}) {\r\n  mutationState.unlocked = !!newState.unlocked;\r\n  mutationState.level = cloneBigNum(newState.level);\r\n  mutationState.progress = cloneBigNum(newState.progress);\r\n  if (!mutationState.unlocked) {\r\n    mutationState.level = bnZero();\r\n    mutationState.progress = bnZero();\r\n  }\r\n  ensureRequirement();\r\n  if (!skipPersist) persistState();\r\n  updateHud();\r\n  emitChange('load');\r\n  scheduleCoinMultiplierRefresh();\r\n}\r\n\r\nfunction readStateFromStorage(slot) {\r\n  const targetSlot = slot ?? getActiveSlot();\r\n  if (targetSlot == null) {\r\n    applyState({ unlocked: false, level: bnZero(), progress: bnZero() }, { skipPersist: true });\r\n    mutationState.slot = null;\r\n    return;\r\n  }\r\n  let unlocked = false;\r\n  let level = bnZero();\r\n  let progress = bnZero();\r\n  try { unlocked = localStorage.getItem(KEY_UNLOCK(targetSlot)) === '1'; }\r\n  catch {}\r\n  try {\r\n    const rawLvl = localStorage.getItem(KEY_LEVEL(targetSlot));\r\n    if (rawLvl) level = BN.fromAny(rawLvl);\r\n  } catch {}\r\n  try {\r\n    const rawProg = localStorage.getItem(KEY_PROGRESS(targetSlot));\r\n    if (rawProg) progress = BN.fromAny(rawProg);\r\n  } catch {}\r\n  applyState({ unlocked, level, progress }, { skipPersist: true });\r\n  mutationState.slot = targetSlot;\r\n}\r\n\r\nfunction cleanupWatchers() {\r\n  while (watcherCleanups.length) {\r\n    const stop = watcherCleanups.pop();\r\n    try { stop?.(); } catch {}\r\n  }\r\n}\r\n\r\nfunction bindStorageWatchers(slot) {\r\n  if (watchersBoundSlot === slot) return;\r\n  cleanupWatchers();\r\n  watchersBoundSlot = slot;\r\n  if (slot == null) return;\r\n  watcherCleanups.push(watchStorageKey(KEY_UNLOCK(slot), {\r\n    onChange(value) {\r\n      const nextUnlocked = value === '1';\r\n      if (mutationState.unlocked !== nextUnlocked) {\r\n        mutationState.unlocked = nextUnlocked;\r\n        if (!nextUnlocked) {\r\n          mutationState.level = bnZero();\r\n          mutationState.progress = bnZero();\r\n        }\r\n        ensureRequirement();\r\n        updateHud();\r\n        emitChange('storage');\r\n        scheduleCoinMultiplierRefresh();\r\n      }\r\n    },\r\n  }));\r\n  watcherCleanups.push(watchStorageKey(KEY_LEVEL(slot), {\r\n    onChange(value) {\r\n      if (!value) return;\r\n      try {\r\n        const next = BN.fromAny(value);\r\n        if (mutationState.level.cmp?.(next) !== 0) {\r\n          mutationState.level = next;\r\n          ensureRequirement();\r\n          updateHud();\r\n          emitChange('storage');\r\n          scheduleCoinMultiplierRefresh();\r\n        }\r\n      } catch {}\r\n    },\r\n  }));\r\n  watcherCleanups.push(watchStorageKey(KEY_PROGRESS(slot), {\r\n    onChange(value) {\r\n      if (!value) return;\r\n      try {\r\n        const next = BN.fromAny(value);\r\n        if (mutationState.progress.cmp?.(next) !== 0) {\r\n          mutationState.progress = next;\r\n          ensureRequirement();\r\n          updateHud();\r\n          emitChange('storage');\r\n        }\r\n      } catch {}\r\n    },\r\n  }));\r\n}\r\n\r\nexport function initMutationSystem({ forceReload = false } = {}) {\r\n  ensureExternalMultiplierProviders();\r\n  if (initialized) {\r\n    const activeSlot = getActiveSlot();\r\n    const slotChanged = activeSlot !== mutationState.slot;\r\n    if (slotChanged || forceReload) {\r\n      readStateFromStorage(activeSlot);\r\n    }\r\n    bindStorageWatchers(activeSlot);\r\n    ensureHudRefs();\r\n    updateHud();\r\n    return getMutationState();\r\n  }\r\n  initialized = true;\r\n  ensureHudRefs();\r\n  const slot = getActiveSlot();\r\n  mutationState.slot = slot;\r\n  readStateFromStorage(slot);\r\n  bindStorageWatchers(slot);\r\n  updateHud();\r\n  scheduleCoinMultiplierRefresh();\r\n  if (typeof window !== 'undefined') {\r\n    window.addEventListener('saveSlot:change', () => {\r\n      const nextSlot = getActiveSlot();\r\n      mutationState.slot = nextSlot;\r\n      readStateFromStorage(nextSlot);\r\n      bindStorageWatchers(nextSlot);\r\n      updateHud();\r\n      scheduleCoinMultiplierRefresh();\r\n      emitChange('slot');\r\n    });\r\n  }\r\n  return getMutationState();\r\n}\r\n\r\nexport function getMutationState() {\r\n  return {\r\n    unlocked: mutationState.unlocked,\r\n    level: cloneBigNum(mutationState.level),\r\n    progress: cloneBigNum(mutationState.progress),\r\n    requirement: cloneBigNum(mutationState.requirement),\r\n  };\r\n}\r\n\r\nexport function isMutationUnlocked() {\r\n  return !!mutationState.unlocked;\r\n}\r\n\r\nexport function unlockMutationSystem() {\r\n  initMutationSystem();\r\n  if (mutationState.unlocked) return false;\r\n  mutationState.unlocked = true;\r\n  ensureRequirement();\r\n  persistState();\r\n  updateHud();\r\n  emitChange('unlock');\r\n  scheduleCoinMultiplierRefresh();\r\n  return true;\r\n}\r\n\r\nexport function setMutationUnlockedForDebug(unlocked) {\r\n  initMutationSystem();\r\n  const nextUnlocked = !!unlocked;\r\n  applyState({\r\n    unlocked: nextUnlocked,\r\n    level: nextUnlocked ? mutationState.level : bnZero(),\r\n    progress: nextUnlocked ? mutationState.progress : bnZero(),\r\n  });\r\n}\r\n\r\nexport function addMutationPower(amount) {\r\n  initMutationSystem();\r\n  if (!mutationState.unlocked) return getMutationState();\r\n\r\n  if (mutationState.level && mutationState.level.isInfinite?.()) {\r\n    const prevLevel = mutationState.level.clone?.() ?? mutationState.level;\r\n    const prevProgress = mutationState.progress.clone?.() ?? mutationState.progress;\r\n\r\n    if (!mutationState.progress?.isInfinite?.()) {\r\n      try { mutationState.progress = BN.fromAny('Infinity'); } catch {}\r\n    }\r\n    if (!mutationState.requirement?.isInfinite?.()) {\r\n      try { mutationState.requirement = BN.fromAny('Infinity'); } catch {}\r\n    }\r\n\r\n    let inc;\r\n    try {\r\n      inc = amount instanceof BN ? amount : BN.fromAny(amount ?? 0);\r\n    } catch {\r\n      inc = bnZero();\r\n    }\r\n\r\n    inc = applyStatMultiplierOverride('mutation', inc);\r\n\r\n    const detail = emitChange('progress', {\r\n      delta: inc.clone?.() ?? inc,\r\n      levelsGained: bnZero(),\r\n      level: mutationState.level.clone?.() ?? mutationState.level,\r\n      progress: mutationState.progress.clone?.() ?? mutationState.progress,\r\n      requirement: mutationState.requirement.clone?.() ?? mutationState.requirement,\r\n      previousLevel: prevLevel.clone?.() ?? prevLevel,\r\n      previousProgress: prevProgress.clone?.() ?? prevProgress,\r\n    });\r\n\r\n    return detail;\r\n  }\r\n\r\n  let inc;\r\n  try {\r\n    inc = amount instanceof BN ? amount : BN.fromAny(amount ?? 0);\r\n  } catch {\r\n    inc = bnZero();\r\n  }\r\n\r\n  inc = applyStatMultiplierOverride('mutation', inc);\r\n\r\n  if (inc.isZero?.()) return getMutationState();\r\n\r\n  const incClone = inc.clone?.() ?? inc;\r\n  const prevLevel = mutationState.level.clone?.() ?? mutationState.level;\r\n  const prevProgress = mutationState.progress.clone?.() ?? mutationState.progress;\r\n\r\n  // Add MP\r\n  mutationState.progress = mutationState.progress.add(incClone);\r\n\r\n  // If MP overflows to BigNum Infinity, treat that as reaching mutation Infinity.\r\n  const progInf = mutationState.progress.isInfinite?.();\r\n  if (progInf) {\r\n    try {\r\n      mutationState.level = BN.fromAny('Infinity');\r\n    } catch {}\r\n\r\n    // Keep progress locked at Infinity once we reach mutation \u221E\r\n    try {\r\n      mutationState.progress = BN.fromAny('Infinity');\r\n    } catch {\r\n      mutationState.progress = bnZero();\r\n    }\r\n\r\n    try {\r\n      mutationState.requirement = BN.fromAny('Infinity');\r\n    } catch {}\r\n  } else {\r\n    // Normal levelling logic (now friendly to \u221E requirements)\r\n    normalizeProgress();\r\n  }\r\n\r\n  persistState();\r\n  updateHud();\r\n\r\n  const levelsGained = mutationState.level.sub(prevLevel);\r\n  if (!levelsGained.isZero?.()) {\r\n    scheduleCoinMultiplierRefresh();\r\n  }\r\n\r\n  const detail = emitChange('progress', {\r\n    delta: incClone.clone?.() ?? incClone,\r\n    levelsGained: levelsGained.clone?.() ?? levelsGained,\r\n    level: mutationState.level.clone?.() ?? mutationState.level,\r\n    progress: mutationState.progress.clone?.() ?? mutationState.progress,\r\n    requirement: mutationState.requirement.clone?.() ?? mutationState.requirement,\r\n    previousLevel: prevLevel.clone?.() ?? prevLevel,\r\n    previousProgress: prevProgress.clone?.() ?? prevProgress,\r\n  });\r\n\r\n  return detail;\r\n}\r\n\r\nexport function broadcastMutationChange(detailOverrides = {}) {\r\n  initMutationSystem();\r\n  const reason = detailOverrides.changeType ?? 'manual';\r\n  return emitChange(reason, detailOverrides);\r\n}\r\n\r\nexport function computeMutationMultiplierForLevel(levelValue) {\r\n  let levelBn;\r\n  if (levelValue instanceof BN) {\r\n    try { levelBn = levelValue.clone?.() ?? levelValue; }\r\n    catch { levelBn = bnZero(); }\r\n  } else if (typeof levelValue === 'bigint') {\r\n    try { levelBn = BigNum.fromAny(levelValue.toString()); }\r\n    catch { levelBn = bnZero(); }\r\n  } else {\r\n    try { levelBn = BigNum.fromAny(levelValue ?? 0); }\r\n    catch { levelBn = bnZero(); }\r\n  }\r\n\r\n  // If the stored mutation level itself is infinite, every multiplier that\r\n  // depends on it becomes infinite as well.\r\n  if (levelBn && levelBn.isInfinite?.()) {\r\n    try { return BN.fromAny('Infinity'); }\r\n    catch { return bnOne(); }\r\n  }\r\n\r\n  const levelNum = levelToNumber(levelBn);\r\n\r\n  // If levelToNumber can't represent this cleanly (NaN / Infinity), also\r\n  // treat that as infinite multiplier.\r\n  if (!Number.isFinite(levelNum)) {\r\n    try { return BN.fromAny('Infinity'); }\r\n    catch { return bnOne(); }\r\n  }\r\n\r\n  if (levelNum <= 0) return bnOne();\r\n\r\n  const log10 = levelNum * MP_LOG10_BASE;\r\n  return bigNumFromLog10(log10);\r\n}\r\n\r\nexport function computeMutationRequirementForLevel(levelValue) {\r\n  let levelBn;\r\n  try { levelBn = levelValue instanceof BN ? levelValue : BN.fromAny(levelValue ?? 0); }\r\n  catch { levelBn = bnZero(); }\r\n  try { return computeRequirement(levelBn); }\r\n  catch { return bnZero(); }\r\n}\r\n\r\nexport function getMutationMultiplier() {\r\n  initMutationSystem();\r\n  if (!mutationState.unlocked) return bnOne();\r\n  try { return computeMutationMultiplierForLevel(mutationState.level); }\r\n  catch { return bnOne(); }\r\n}\r\n\r\nexport function getMutationCoinSprite() {\r\n  if (!mutationState.unlocked || mutationState.level.isZero?.()) {\r\n    return 'img/currencies/coin/coin.webp';\r\n  }\r\n\r\n  const levelNum = levelToNumber(mutationState.level);\r\n  if (!Number.isFinite(levelNum)) {\r\n    return 'img/mutations/m25.webp';\r\n  }\r\n  const idx = Math.max(1, Math.min(25, Math.floor(levelNum)));\r\n\r\n  return `img/mutations/m${idx}.webp`;\r\n}\r\n\r\nexport function onMutationChange(callback) {\r\n  if (typeof callback !== 'function') return () => {};\r\n  listeners.add(callback);\r\n  return () => { listeners.delete(callback); };\r\n}\r\n\r\nif (typeof window !== 'undefined') {\r\n  window.mutationSystem = window.mutationSystem || {};\r\n  Object.assign(window.mutationSystem, {\r\n    initMutationSystem,\r\n    unlockMutationSystem,\r\n    addMutationPower,\r\n    getMutationState,\r\n    getMutationMultiplier,\r\n    isMutationUnlocked,\r\n    getTotalCumulativeMp,\r\n  });\r\n}\r\n\r\nexport function getTotalCumulativeMp() {\r\n  initMutationSystem();\r\n  if (!mutationState.unlocked) return bnZero();\r\n  \r\n  if (mutationState.level.isInfinite?.() || mutationState.progress.isInfinite?.()) {\r\n    return BigNum.fromAny('Infinity');\r\n  }\r\n\r\n  const currentLvlNum = levelToNumber(mutationState.level);\r\n  \r\n  // If Mutation Level is > 100, do NOT sum previous tiers. Just use current progress.\r\n  // This is a safety cap to prevent freezing or imbalance for hacked/super-high levels.\r\n  if (Number.isFinite(currentLvlNum) && currentLvlNum > 100) {\r\n    return mutationState.progress.clone?.() ?? mutationState.progress;\r\n  }\r\n\r\n  let total = mutationState.progress.clone?.() ?? mutationState.progress;\r\n  \r\n  if (Number.isFinite(currentLvlNum)) {\r\n    // Normal summing up to the cap\r\n    const limit = currentLvlNum; \r\n    for (let i = 0; i < limit; i++) {\r\n      const req = computeRequirement(BigNum.fromInt(i));\r\n      if (req.isInfinite?.()) {\r\n        return BigNum.fromAny('Infinity');\r\n      }\r\n      total = total.add(req);\r\n    }\r\n  }\r\n\r\n  return total;\r\n}\r\n", "// js/game/spawner.js\r\n\r\nimport { takePreloadedAudio } from '../util/audioCache.js';\r\nimport { getMutationState, onMutationChange } from './mutationSystem.js';\r\nimport { IS_MOBILE } from '../main.js';\r\nimport { getLevelNumber } from './upgrades.js';\r\nimport { AUTOMATION_AREA_KEY, EFFECTIVE_AUTO_COLLECT_ID } from './automationUpgrades.js';\r\n\r\nlet mutationUnlockedSnapshot = false;\r\nlet mutationLevelSnapshot = 0n;\r\n\r\nconst MAX_ACTIVE_COINS_MOBILE = 600\r\n\r\n// Cache for coin images (src -> Image)\r\nconst imgCache = new Map();\r\n\r\nfunction updateMutationSnapshot(state) {\r\n  if (!state || typeof state !== 'object') {\r\n    mutationUnlockedSnapshot = false;\r\n    mutationLevelSnapshot = 0n;\r\n    return;\r\n  }\r\n  mutationUnlockedSnapshot = !!state.unlocked;\r\n  try {\r\n    const level = state.level;\r\n    const plain = typeof level?.toPlainIntegerString === 'function'\r\n      ? level.toPlainIntegerString()\r\n      : null;\r\n    mutationLevelSnapshot = plain && plain !== 'Infinity' ? BigInt(plain) : 0n;\r\n  } catch {\r\n    mutationLevelSnapshot = 0n;\r\n  }\r\n}\r\n\r\ntry {\r\n  updateMutationSnapshot(getMutationState());\r\n} catch {\r\n  mutationUnlockedSnapshot = false;\r\n  mutationLevelSnapshot = 0n;\r\n}\r\n\r\ntry {\r\n  onMutationChange((snapshot) => { updateMutationSnapshot(snapshot); });\r\n} catch {}\r\n\r\nfunction easeOutCubic(t) {\r\n  const f = 1 - t;\r\n  return 1 - f * f * f;\r\n}\r\n\r\nconst CUBIC_BEZIER = 'cubic-bezier(0.215, 0.61, 0.355, 1)';\r\n\r\nfunction getImage(src) {\r\n  if (!src) return null;\r\n  let img = imgCache.get(src);\r\n  if (!img) {\r\n    img = new Image();\r\n    img.src = src;\r\n    imgCache.set(src, img);\r\n  }\r\n  return img;\r\n}\r\n\r\nexport function createSpawner({\r\n    playfieldSelector = '.area-cove .playfield',\r\n    waterSelector = '.water-base',\r\n    surgesHost = '.surges',\r\n    coinsHost = '.coins-layer',\r\n    coinSrc = 'img/coin/coin.webp',\r\n    coinSize = 40,\r\n    animationDurationMs = 1500,\r\n    surgeLifetimeMs = 1400,\r\n    surgeWidthVw = 22,\r\n    coinsPerSecond = 1,\r\n    perFrameBudget = 24,\r\n    backlogCap = 600,\r\n    maxActiveCoins = IS_MOBILE ? MAX_ACTIVE_COINS_MOBILE : 5000,\r\n    initialBurst = 1,\r\n    coinTtlMs = 1e9,\r\n    waveSoundSrc = 'sounds/wave_spawn.ogg',\r\n    waveSoundDesktopVolume = 0.45,\r\n    waveSoundMobileVolume  = 0.2,\r\n    waveSoundMinIntervalMs = 160,\r\n    enableDropShadow = false,\r\n} = {}) {\r\n\r\n    let currentCoinSrc = coinSrc;\r\n    const isTouch = window.matchMedia('(hover: none) and (pointer: coarse)').matches;\r\n    const MOBILE_BACKLOG_CAP = 50;\r\n    let burstUntil = 0;\r\n\r\n    const BURST_WINDOW_MS        = 120;\r\n    const BURST_TIME_BUDGET_MS   = 10.0;\r\n    const BURST_HARD_CAP         = 60;\r\n    const ONE_SHOT_THRESHOLD     = 180;\r\n    const NORMAL_TIME_BUDGET_MS  = 5.0;\r\n\r\n    const refs = {\r\n        pf: document.querySelector(playfieldSelector),\r\n        w: document.querySelector(waterSelector),\r\n        s: document.querySelector(surgesHost),\r\n        c: document.querySelector(coinsHost),\r\n        hud: document.getElementById('hud-bottom'),\r\n    };\r\n\r\n    function validRefs() {\r\n        return !!(refs.pf && refs.w && refs.s && refs.c);\r\n    }\r\n\r\n    if (!validRefs()) {\r\n        console.warn('[Spawner] Missing required nodes. Check your selectors:', {\r\n            playfieldSelector,\r\n            waterSelector,\r\n            surgesHost,\r\n            coinsHost\r\n        });\r\n    }\r\n\r\n    let canvas = null;\r\n    let ctx = null;\r\n    let canvasDirty = false;\r\n\r\n    if (refs.c) {\r\n        canvas = document.createElement('canvas');\r\n        canvas.style.position = 'absolute';\r\n        canvas.style.inset = '0';\r\n        canvas.style.pointerEvents = 'none';\r\n        refs.c.appendChild(canvas);\r\n        ctx = canvas.getContext('2d', { alpha: true });\r\n    }\r\n\r\n    let M = {\r\n        pfRect: null,\r\n        wRect: null,\r\n        safeBottom: 0,\r\n        pfW: 0\r\n    };\r\n\r\n    function computeMetrics() {\r\n        if (!validRefs())\r\n            return false;\r\n        const pfRect = refs.pf.getBoundingClientRect();\r\n        const wRect = refs.w.getBoundingClientRect();\r\n        const hudH = refs.hud ? refs.hud.getBoundingClientRect().height : 0;\r\n\r\n        M = {\r\n            pfRect,\r\n            wRect,\r\n            safeBottom: pfRect.height - hudH,\r\n            pfW: pfRect.width\r\n        };\r\n\r\n        if (canvas) {\r\n             const dpr = window.devicePixelRatio || 1;\r\n             canvas.width = pfRect.width * dpr;\r\n             canvas.height = pfRect.height * dpr;\r\n             canvas.style.width = pfRect.width + 'px';\r\n             canvas.style.height = pfRect.height + 'px';\r\n             \r\n             if (ctx) {\r\n                 ctx.setTransform(1, 0, 0, 1, 0, 0);\r\n                 ctx.scale(dpr, dpr);\r\n                 ctx.imageSmoothingEnabled = true;\r\n                 ctx.imageSmoothingQuality = 'high';\r\n             }\r\n             canvasDirty = true;\r\n        }\r\n\r\n        return true;\r\n    }\r\n\r\n    computeMetrics();\r\n\r\n    const ro = 'ResizeObserver' in window ? new ResizeObserver(() => computeMetrics()) : null;\r\n    if (ro && refs.pf)\r\n        ro.observe(refs.pf);\r\n    document.addEventListener('visibilitychange', () => {\r\n        if (!document.hidden)\r\n            computeMetrics();\r\n    });\r\n\r\n    const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));\r\n\r\n    const COIN_POOL_MAX = Math.max(2000, maxActiveCoins * 3);\r\n    const SURGE_POOL_MAX = 800;\r\n    const COIN_MARGIN = 12;\r\n\r\n    const coinPool = [];\r\n    const surgePool = [];\r\n\r\n    const activeCoins = []; \r\n\r\n    function makeCoin() {\r\n        const el = document.createElement('div');\r\n        el.className = 'coin';\r\n        el.style.position = 'absolute';\r\n        el.style.width = `${coinSize}px`;\r\n        el.style.height = `${coinSize}px`;\r\n        el.style.background = `url(${currentCoinSrc}) center/contain no-repeat`;\r\n        el.style.borderRadius = '50%';\r\n        el.style.pointerEvents = 'auto';\r\n        el.style.willChange = 'transform';\r\n        el.style.contain = 'layout paint style size';\r\n        if (enableDropShadow)\r\n            el.style.filter = 'drop-shadow(0 2px 2px rgba(0,0,0,.35))';\r\n        return el;\r\n    }\r\n    const getCoin = () => (coinPool.length ? coinPool.pop() : makeCoin());\r\n    \r\n    function releaseCoin(el) {\r\n       el.style.transition = '';\r\n       el.style.transform = '';\r\n       el.style.opacity = '1';\r\n       \r\n       el.classList.remove('coin--collected');\r\n       el.style.removeProperty('--ccc-start');\r\n\r\n       delete el.dataset.dieAt;\r\n       delete el.dataset.mutationLevel;\r\n       delete el.dataset.collected;\r\n       \r\n       el.style.willChange = 'transform';\r\n       \r\n       if (el.parentNode) el.remove();\r\n       if (coinPool.length < COIN_POOL_MAX) coinPool.push(el);\r\n    }\r\n    \r\n    function removeCoin(coinObj, knownIndex = -1) {\r\n        if (coinObj.isRemoved) return;\r\n        coinObj.isRemoved = true;\r\n        \r\n        let idx = knownIndex;\r\n        if (idx === -1 || activeCoins[idx] !== coinObj) {\r\n            idx = activeCoins.indexOf(coinObj);\r\n        }\r\n        if (idx !== -1) {\r\n            activeCoins.splice(idx, 1);\r\n        }\r\n        \r\n        if (coinObj.el) {\r\n            releaseCoin(coinObj.el);\r\n            coinObj.el = null;\r\n        } else {\r\n            // Was on canvas, need redraw\r\n            canvasDirty = true;\r\n        }\r\n    }\r\n    \r\n    function detachCoin(coinEl) {\r\n        const coinObj = coinEl._coinObj;\r\n        if (coinObj) {\r\n            const idx = activeCoins.indexOf(coinObj);\r\n            if (idx !== -1) {\r\n                activeCoins.splice(idx, 1);\r\n            }\r\n            coinEl._coinObj = null;\r\n        }\r\n    }\r\n\r\n    function makeSurge() {\r\n        const el = document.createElement('div');\r\n        el.className = 'wave-surge';\r\n        el.style.willChange = 'transform, opacity';\r\n        return el;\r\n    }\r\n    const getSurge = () => (surgePool.length ? surgePool.pop() : makeSurge());\r\n    function releaseSurge(el) {\r\n        el.classList.remove('run', 'run-b');\r\n        if (el.parentNode)\r\n            el.remove();\r\n        if (surgePool.length < SURGE_POOL_MAX)\r\n            surgePool.push(el);\r\n    }\r\n    \r\n    const waveURL = new URL(waveSoundSrc, document.baseURI).href;\r\n    let waveHtmlEl = null; \r\n    let waveHtmlSource = null;\r\n    let waveLastAt = 0;\r\n    let wavePool = null, waveIdx = 0;\r\n\r\n    function ensureWavePool() {\r\n      if (wavePool) return wavePool;\r\n\r\n      const preloaded = takePreloadedAudio(waveSoundSrc);\r\n      const poolSize = 4;\r\n      wavePool = Array.from({ length: poolSize }, (_, idx) => {\r\n        if (idx === 0 && preloaded) {\r\n          preloaded.preload = 'auto';\r\n          try { preloaded.currentTime = 0; } catch (_) {}\r\n          preloaded.volume = 1;\r\n          return preloaded;\r\n        }\r\n        const a = new Audio(waveURL);\r\n        a.preload = 'auto';\r\n        a.load?.();\r\n        return a;\r\n      });\r\n\r\n      if (preloaded) {\r\n        for (let i = 1; i < wavePool.length; i++) {\r\n          wavePool[i].load?.();\r\n        }\r\n      }\r\n\r\n      return wavePool;\r\n    }\r\n\r\n    function playWaveHtmlVolume(vol) {\r\n      if (IS_MOBILE) {\r\n        try {\r\n          ac = ac || new (window.AudioContext || window.webkitAudioContext)();\r\n          if (ac.state === 'suspended') ac.resume();\r\n          gain = gain || ac.createGain();\r\n          gain.gain.value = waveSoundMobileVolume;\r\n          gain.connect(ac.destination);\r\n\r\n          if (!waveHtmlEl) {\r\n            waveHtmlEl = new Audio(waveURL);\r\n            waveHtmlEl.preload = 'auto';\r\n            waveHtmlEl.playsInline = true;\r\n            waveHtmlEl.crossOrigin = 'anonymous';\r\n          }\r\n          if (!waveHtmlSource) {\r\n            waveHtmlSource = ac.createMediaElementSource(waveHtmlEl);\r\n            waveHtmlSource.connect(gain);\r\n          }\r\n\r\n          waveHtmlEl.muted = false;\r\n          waveHtmlEl.volume = 1.0;\r\n          waveHtmlEl.currentTime = 0;\r\n          waveHtmlEl.play().catch(() => {});\r\n          return;\r\n        } catch (e) {\r\n          try { const a = new Audio(waveURL); a.muted = true; a.play().catch(() => {}); } catch {}\r\n          return;\r\n        }\r\n      }\r\n\r\n      const pool = ensureWavePool();\r\n      const a = pool[waveIdx++ % pool.length];\r\n      a.volume = vol;\r\n      try { a.currentTime = 0; a.play(); } catch {}\r\n    }\r\n\r\n    let ac = null, gain = null, waveBuf = null, waveLoading = false;\r\n    async function ensureWaveWA() {\r\n      if (waveBuf || waveLoading) return;\r\n      waveLoading = true;\r\n      try {\r\n        ac = ac || new (window.AudioContext || window.webkitAudioContext)();\r\n        gain = gain || ac.createGain();\r\n        gain.gain.value = waveSoundMobileVolume;\r\n        gain.connect(ac.destination);\r\n\r\n        const res = await fetch(waveURL, { cache: 'force-cache' });\r\n        const arr = await res.arrayBuffer();\r\n        waveBuf = await new Promise((ok, err) =>\r\n          ac.decodeAudioData ? ac.decodeAudioData(arr, ok, err) : ok(null)\r\n        );\r\n        if (ac.state === 'suspended') { try { await ac.resume(); } catch {} }\r\n      } catch (_) {} finally { waveLoading = false; }\r\n    }\r\n\r\n    function playWaveMobile() {\r\n      try { if (ac && ac.state === 'suspended') ac.resume(); } catch {}\r\n      if (waveBuf && ac && gain) {\r\n        try {\r\n          const src = ac.createBufferSource();\r\n          src.buffer = waveBuf;\r\n          src.connect(gain);\r\n          src.start();\r\n          return;\r\n        } catch {}\r\n      }\r\n      playWaveHtmlVolume(waveSoundMobileVolume);\r\n      ensureWaveWA();\r\n    }\r\n\r\n    const warmWave = () => { if (IS_MOBILE) ensureWaveWA(); };\r\n    ['pointerdown','touchstart'].forEach(evt =>\r\n      window.addEventListener(evt, warmWave, { once: true, passive: true, capture: true })\r\n    );\r\n\r\n    ensureWavePool();\r\n\r\n    document.addEventListener('visibilitychange', () => {\r\n      if (!document.hidden && IS_MOBILE && ac && ac.state === 'suspended') {\r\n        try { ac.resume(); } catch {}\r\n      }\r\n    });\r\n\r\n    function playWaveOncePerBurst() {\r\n      const now = performance.now();\r\n      if (now - waveLastAt < waveSoundMinIntervalMs) return;\r\n      waveLastAt = now;\r\n      if (IS_MOBILE) playWaveMobile();\r\n      else          playWaveHtmlVolume(waveSoundDesktopVolume);\r\n    }\r\n\r\n    function planCoinFromWave(wave) {\r\n        if (!wave) return null;\r\n        const { x: waveX, y: waveTop, w: waveW } = wave;\r\n\r\n        const crestCenter = waveX + waveW / 2 + (Math.random() * 60 - 30);\r\n        const startX = crestCenter - coinSize / 2;\r\n        const startY = waveTop + 10 - coinSize / 2;\r\n\r\n        const drift = Math.random() * 100 - 50;\r\n        const endX = clamp(startX + drift, COIN_MARGIN, M.pfW - coinSize - COIN_MARGIN);\r\n        const minY = Math.max(M.wRect.height + 80, 120);\r\n        const maxY = Math.max(minY + 40, M.safeBottom - coinSize - 6);\r\n        const endY = clamp(minY + Math.random() * (maxY - minY), minY, maxY);\r\n        \r\n        const jitterMs = Math.random() * 100;\r\n\r\n        return {\r\n            x0: startX,\r\n            y0: startY,\r\n            x1: endX,\r\n            y1: endY,\r\n            jitterMs,\r\n        };\r\n    }\r\n\r\n    function planSpawn() {\r\n        if (!validRefs())\r\n            return null;\r\n        if (!M.pfRect || !M.wRect)\r\n            computeMetrics();\r\n\r\n        if (maxActiveCoins !== Infinity && activeCoins.length >= maxActiveCoins) {\r\n            const oldest = activeCoins[0];\r\n            if (oldest) removeCoin(oldest, 0);\r\n        }\r\n\r\n        const pfW = M.pfW;\r\n        const waveW = clamp(pfW * (surgeWidthVw / 100), 220, 520);\r\n        const leftMax = Math.max(1, pfW - waveW - COIN_MARGIN * 2);\r\n        const waveX = Math.random() * leftMax + COIN_MARGIN;\r\n\r\n        const waterToPfTop = M.wRect.top - M.pfRect.top;\r\n        const waveTop = Math.max(0, waterToPfTop + M.wRect.height * 0.05);\r\n\r\n        const wave = {\r\n            x: waveX,\r\n            y: waveTop,\r\n            w: waveW\r\n        };\r\n\r\n        const coinPlan = planCoinFromWave(wave);\r\n        if (!coinPlan) return null;\r\n\r\n        return {\r\n            wave,\r\n            coin: coinPlan\r\n        };\r\n    }\r\n\r\n    function commitBatch(batch) {\r\n      if (!batch.length || !validRefs()) return;\r\n\r\n      const wavesFrag = document.createDocumentFragment();\r\n      const coinsFrag = document.createDocumentFragment();\r\n      \r\n      const newSurges = [];\r\n      const newCoins = [];\r\n      const now = performance.now();\r\n\r\n      for (const { wave, coin } of batch) {\r\n        if (wave) {\r\n          const surge = getSurge();\r\n          surge.style.left = `${wave.x}px`;\r\n          surge.style.top = `${wave.y}px`;\r\n          surge.style.width = `${wave.w}px`;\r\n          wavesFrag.appendChild(surge);\r\n          newSurges.push(surge);\r\n        }\r\n\r\n        const el = getCoin();\r\n        el.style.background = `url(${currentCoinSrc}) center/contain no-repeat`;\r\n        \r\n        el.style.transform = `translate3d(${coin.x0}px, ${coin.y0}px, 0) rotate(-10deg) scale(0.96)`;\r\n        el.style.opacity = '1';\r\n\r\n        if (mutationUnlockedSnapshot) {\r\n          el.dataset.mutationLevel = mutationLevelSnapshot.toString();\r\n        } else {\r\n          el.dataset.mutationLevel = '0';\r\n        }\r\n        \r\n        const coinObj = {\r\n            mutationLevel: mutationUnlockedSnapshot ? mutationLevelSnapshot.toString() : '0',\r\n            el,\r\n            src: currentCoinSrc,\r\n            x: coin.x0,\r\n            y: coin.y0,\r\n            rot: -10,\r\n            scale: 0.96,\r\n            startX: coin.x0,\r\n            startY: coin.y0,\r\n            endX: coin.x1,\r\n            endY: coin.y1,\r\n            startTime: now + coin.jitterMs,\r\n            duration: animationDurationMs,\r\n            dieAt: now + coinTtlMs,\r\n            jitterMs: coin.jitterMs,\r\n            isRemoved: false,\r\n            settled: false\r\n        };\r\n        \r\n        el._coinObj = coinObj;\r\n        activeCoins.push(coinObj);\r\n        newCoins.push(coinObj);\r\n        \r\n        coinsFrag.appendChild(el);\r\n      }\r\n\r\n      refs.s.appendChild(wavesFrag);\r\n      refs.c.appendChild(coinsFrag);\r\n\r\n      if (newCoins.length > 0) {\r\n          requestAnimationFrame(() => {\r\n            for (const c of newCoins) {\r\n                if (!c.el) continue;\r\n                c.el.style.transition = `transform ${animationDurationMs}ms ${CUBIC_BEZIER} ${c.jitterMs}ms`;\r\n                c.el.style.transform = `translate3d(${c.endX}px, ${c.endY}px, 0) rotate(0deg) scale(1)`;\r\n            }\r\n          });\r\n      }\r\n\r\n      requestAnimationFrame(() => {\r\n        if (newSurges.length) playWaveOncePerBurst();\r\n\r\n        for (const surge of newSurges) {\r\n          if (surge.classList.contains('run')) {\r\n            surge.classList.remove('run');\r\n            surge.classList.add('run-b');\r\n          } else {\r\n            surge.classList.remove('run-b');\r\n            surge.classList.add('run');\r\n          }\r\n          const onEnd = (e) => {\r\n            if (e.target === surge) releaseSurge(surge);\r\n          };\r\n          surge.addEventListener('animationend', onEnd, { once: true });\r\n        }\r\n      });\r\n    }\r\n\r\n    function spawnBurst(n = 1) {\r\n        if (!validRefs())\r\n            return;\r\n        if (!M.pfRect || !M.wRect)\r\n            computeMetrics();\r\n        const batch = [];\r\n        for (let i = 0; i < n; i++) {\r\n            const plan = planSpawn();\r\n            if (plan) {\r\n                batch.push(plan);\r\n            }\r\n        }\r\n        if (batch.length)\r\n            commitBatch(batch);\r\n    }\r\n\r\n    function drawSettledCoins() {\r\n        if (!ctx || !canvasDirty) return;\r\n        \r\n        const logicalW = canvas.width / (window.devicePixelRatio || 1);\r\n        const logicalH = canvas.height / (window.devicePixelRatio || 1);\r\n        \r\n        ctx.save();\r\n        ctx.setTransform(1, 0, 0, 1, 0, 0);\r\n        ctx.clearRect(0, 0, canvas.width, canvas.height);\r\n        ctx.restore();\r\n        \r\n        const count = activeCoins.length;\r\n        for (let i = 0; i < count; i++) {\r\n            const c = activeCoins[i];\r\n            if (c.settled && !c.isRemoved && !c.el) {\r\n                const img = getImage(c.src);\r\n                if (img && img.complete && img.naturalWidth > 0) {\r\n                     ctx.save();\r\n                     ctx.translate(c.x + coinSize/2, c.y + coinSize/2);\r\n                     ctx.rotate(c.rot * Math.PI / 180);\r\n                     ctx.scale(c.scale, c.scale);\r\n                     \r\n                     if (enableDropShadow) {\r\n                         ctx.shadowColor = 'rgba(0,0,0,0.35)';\r\n                         ctx.shadowBlur = 2;\r\n                         ctx.shadowOffsetY = 2;\r\n                     }\r\n\r\n                     ctx.drawImage(img, -coinSize/2, -coinSize/2, coinSize, coinSize);\r\n                     ctx.restore();\r\n                }\r\n            }\r\n        }\r\n        canvasDirty = false;\r\n    }\r\n\r\n    let rate = coinsPerSecond;\r\n    let rafId = null;\r\n    let last = performance.now();\r\n    let carry = 0;\r\n    let queued = 0;\r\n    \r\n    function loop(now) {\r\n      if (!M.pfRect || !M.wRect) computeMetrics();\r\n\r\n      let dt = (now - last) / 1000;\r\n      last = now;\r\n      \r\n      if (dt > 0.1) dt = 0.1;\r\n      \r\n      {\r\n          for (let i = activeCoins.length - 1; i >= 0; i--) {\r\n              const c = activeCoins[i];\r\n              \r\n              if (now >= c.dieAt) {\r\n                  removeCoin(c, i);\r\n                  continue;\r\n              }\r\n              \r\n              if (c.settled) continue;\r\n              \r\n              const elapsed = now - c.startTime;\r\n              if (elapsed < 0) continue;\r\n              \r\n              let t = elapsed / c.duration;\r\n              if (t >= 1) {\r\n                  c.settled = true;\r\n                  c.x = c.endX;\r\n                  c.y = c.endY;\r\n                  c.rot = 0;\r\n                  c.scale = 1;\r\n                  if (c.el) {\r\n                      releaseCoin(c.el);\r\n                      c.el = null;\r\n                      canvasDirty = true;\r\n                  }\r\n                  continue;\r\n              }\r\n              \r\n              const ease = easeOutCubic(t);\r\n              \r\n              const curX = c.startX + (c.endX - c.startX) * ease;\r\n              const curY = c.startY + (c.endY - c.startY) * ease;\r\n              \r\n              c.x = curX;\r\n              c.y = curY;\r\n              \r\n              const rot = -10 + (10 * ease);\r\n              const scale = 0.96 + (0.04 * ease);\r\n              \r\n              c.rot = rot;\r\n              c.scale = scale;\r\n          }\r\n      }\r\n\r\n      carry += rate * dt;\r\n      const due = carry | 0;\r\n\r\n      let cap = isTouch ? MOBILE_BACKLOG_CAP : backlogCap;\r\n      const autoCollectLevel = getLevelNumber(AUTOMATION_AREA_KEY, EFFECTIVE_AUTO_COLLECT_ID) || 0;\r\n      if (autoCollectLevel > 0) {\r\n        const activeCap = Math.min(perFrameBudget + 2, 30);\r\n        if (cap > activeCap) {\r\n          cap = activeCap;\r\n        }\r\n      }\r\n\r\n      if (queued > cap) queued = cap;\r\n\r\n      if (due > 0) {\r\n        queued = Math.min(cap, queued + due);\r\n        carry -= due;\r\n      }\r\n\r\n      let spawnTarget = Math.min(queued, perFrameBudget);\r\n      let timeBudgetMs = NORMAL_TIME_BUDGET_MS;\r\n\r\n      if (isTouch && now < burstUntil && queued > 0) {\r\n        if (queued <= ONE_SHOT_THRESHOLD) {\r\n          spawnTarget  = queued;\r\n          timeBudgetMs = BURST_TIME_BUDGET_MS;\r\n        } else {\r\n          spawnTarget  = Math.min(queued, BURST_HARD_CAP);\r\n          timeBudgetMs = BURST_TIME_BUDGET_MS;\r\n        }\r\n      }\r\n\r\n      if (spawnTarget > 0) {\r\n        const t0 = performance.now();\r\n        const batch = [];\r\n        let baseSpawned = 0;\r\n        for (let i = 0; i < spawnTarget; i++) {\r\n          if (performance.now() - t0 > timeBudgetMs) break;\r\n          const plan = planSpawn();\r\n          if (plan) {\r\n            batch.push(plan);\r\n            baseSpawned += 1;\r\n          }\r\n        }\r\n        if (batch.length) {\r\n          commitBatch(batch);\r\n          if (baseSpawned > 0) {\r\n            queued = Math.max(0, queued - baseSpawned);\r\n          }\r\n        }\r\n      }\r\n\r\n      drawSettledCoins();\r\n\r\n      rafId = requestAnimationFrame(loop);\r\n    }\r\n\r\n    function start() {\r\n      if (rafId) return;\r\n      if (!validRefs()) {\r\n        console.warn('[Spawner] start() called but required nodes are missing.');\r\n        return;\r\n      }\r\n      computeMetrics();\r\n\r\n      if (initialBurst > 0 && rafId === null) {\r\n        spawnBurst(initialBurst);\r\n      }\r\n\r\n      last = performance.now();\r\n      rafId = requestAnimationFrame(loop);\r\n    }\r\n\r\n    function stop() {\r\n        if (!rafId)\r\n            return;\r\n        cancelAnimationFrame(rafId);\r\n        rafId = null;\r\n    }\r\n\r\n    function setRate(n) {\r\n        rate = Math.max(0, Number(n) || 0);\r\n    }\r\n\r\n    function clearBacklog() {\r\n        queued = 0;\r\n        carry = 0;\r\n        last = performance.now();\r\n    }\r\n\r\n    function clearPlayfield() {\r\n        for (let i = activeCoins.length - 1; i >= 0; i--) {\r\n            removeCoin(activeCoins[i], i);\r\n        }\r\n        clearBacklog();\r\n    }\r\n\r\n    function setCoinSprite(src) {\r\n      if (!src) return;\r\n      currentCoinSrc = src;\r\n    }\r\n\r\n    function getCoinTransform(el) {\r\n        const c = el._coinObj;\r\n        if (!c) return el.style.transform || 'translate3d(0,0,0)';\r\n        return `translate3d(${c.x}px, ${c.y}px, 0) rotate(${c.rot}deg) scale(${c.scale})`;\r\n    }\r\n    \r\n    function findCoinsInRadius(centerX, centerY, radius) {\r\n        const radiusSq = radius * radius;\r\n        const candidates = [];\r\n        const count = activeCoins.length;\r\n        \r\n        const minX = centerX - radius;\r\n        const maxX = centerX + radius;\r\n        const minY = centerY - radius;\r\n        const maxY = centerY + radius;\r\n        \r\n        for (let i = 0; i < count; i++) {\r\n            const c = activeCoins[i];\r\n            const cx = c.x + (coinSize / 2);\r\n            if (cx < minX || cx > maxX) continue;\r\n            \r\n            const cy = c.y + (coinSize / 2);\r\n            if (cy < minY || cy > maxY) continue;\r\n\r\n            const dx = cx - centerX;\r\n            const dy = cy - centerY;\r\n            \r\n            if ((dx*dx + dy*dy) <= radiusSq) {\r\n                if (!c.el && !c.isRemoved) {\r\n                     const el = getCoin();\r\n                     el.style.transition = '';\r\n                     el.style.transform = `translate3d(${c.x}px, ${c.y}px, 0) rotate(0deg) scale(1)`;\r\n                     el.style.background = `url(${c.src}) center/contain no-repeat`;\r\n                     el.style.opacity = '1';\r\n                     el.dataset.mutationLevel = c.mutationLevel;\r\n                     \r\n                     el._coinObj = c;\r\n                     c.el = el;\r\n                     refs.c.appendChild(el);\r\n                     canvasDirty = true;\r\n                }\r\n                if (c.el) candidates.push(c.el);\r\n            }\r\n        }\r\n        return candidates;\r\n    }\r\n\r\n    function findCoinsInPath(x1, y1, x2, y2, radius) {\r\n        const radiusSq = radius * radius;\r\n        const candidates = [];\r\n        const count = activeCoins.length;\r\n\r\n        const minX = Math.min(x1, x2) - radius;\r\n        const maxX = Math.max(x1, x2) + radius;\r\n        const minY = Math.min(y1, y2) - radius;\r\n        const maxY = Math.max(y1, y2) + radius;\r\n\r\n        const vx = x2 - x1;\r\n        const vy = y2 - y1;\r\n        const lenSq = vx * vx + vy * vy;\r\n        const crossLimit = radiusSq * lenSq;\r\n\r\n        for (let i = 0; i < count; i++) {\r\n            const c = activeCoins[i];\r\n            const cx = c.x + (coinSize / 2);\r\n            \r\n            if (cx < minX || cx > maxX) continue;\r\n            \r\n            const cy = c.y + (coinSize / 2);\r\n            \r\n            if (cy < minY || cy > maxY) continue;\r\n\r\n            const wx = cx - x1;\r\n            const wy = cy - y1;\r\n            \r\n            const dot = wx * vx + wy * vy;\r\n            \r\n            let hit = false;\r\n            if (dot <= 0) {\r\n                if ((wx * wx + wy * wy) <= radiusSq) hit = true;\r\n            } else if (dot >= lenSq) {\r\n                const dx = cx - x2;\r\n                const dy = cy - y2;\r\n                if ((dx * dx + dy * dy) <= radiusSq) hit = true;\r\n            } else {\r\n                const cross = wx * vy - wy * vx;\r\n                if (cross * cross <= crossLimit) hit = true;\r\n            }\r\n            \r\n            if (hit) {\r\n                if (!c.el && !c.isRemoved) {\r\n                     const el = getCoin();\r\n                     el.style.transition = '';\r\n                     el.style.transform = `translate3d(${c.x}px, ${c.y}px, 0) rotate(0deg) scale(1)`;\r\n                     el.style.background = `url(${c.src}) center/contain no-repeat`;\r\n                     el.style.opacity = '1';\r\n                     el.dataset.mutationLevel = c.mutationLevel;\r\n                     \r\n                     el._coinObj = c;\r\n                     c.el = el;\r\n                     refs.c.appendChild(el);\r\n                     canvasDirty = true;\r\n                }\r\n                if (c.el) candidates.push(c.el);\r\n            }\r\n        }\r\n        return candidates;\r\n    }\r\n\r\n   document.addEventListener('visibilitychange', () => {\r\n    if (!document.hidden) {\r\n      if (isTouch) burstUntil = performance.now() + BURST_WINDOW_MS;\r\n      if (!rafId) start();\r\n    }\r\n  });\r\n\r\n    return {\r\n        start,\r\n        stop,\r\n        setRate,\r\n        clearBacklog,\r\n        clearPlayfield,\r\n        setCoinSprite,\r\n        getCoinTransform,\r\n        findCoinsInRadius,\r\n        findCoinsInPath,\r\n        detachCoin,\r\n        recycleCoin: releaseCoin,\r\n    };\r\n}\r\n", "// js/util/saveIntegrity.js\r\n// If a player modifies their save file manually (e.g., console commands, local storage editing, JSON tampering),\r\n// A one-way flag, `hasModifiedSave`, will become true and turn the shop button's color brown,\r\n// Which I like to call the poop-shop of shame.\r\n// Used to detect cheaters.\r\nimport {\r\n  STORAGE_PREFIX,\r\n  getActiveSlot,\r\n  getSlotSignature,\r\n  setSlotSignature,\r\n  markSaveSlotModified,\r\n  getSlotSignatureKey,\r\n  hasModifiedSave,\r\n} from './storage.js';\r\n\r\nconst SIGNATURE_POLL_INTERVAL_MS = 10000;\r\nconst TRUSTED_MUTATION_GRACE_MS = 750;\r\nconst TRUSTED_SWEEP_DELAY_MS = 50;\r\nlet watcherId = null;\r\nlet trustedSweepTimer = null;\r\n\r\nconst trustedSlotsUntil = new Map();\r\n\r\nfunction nowMs() {\r\n  if (typeof performance !== 'undefined' && typeof performance.now === 'function') {\r\n    return performance.now();\r\n  }\r\n  return Date.now();\r\n}\r\n\r\nfunction noteTrustedSlot(slot, ttl = TRUSTED_MUTATION_GRACE_MS) {\r\n  if (!slot || slot <= 0) return;\r\n  trustedSlotsUntil.set(slot, nowMs() + ttl);\r\n}\r\n\r\nfunction slotRecentlyTrusted(slot) {\r\n  if (!slot || slot <= 0) return false;\r\n  const expiry = trustedSlotsUntil.get(slot);\r\n  if (expiry == null) return false;\r\n  if (expiry <= nowMs()) {\r\n    trustedSlotsUntil.delete(slot);\r\n    return false;\r\n  }\r\n  return true;\r\n}\r\n\r\nfunction resetTrustedSlots() {\r\n  trustedSlotsUntil.clear();\r\n}\r\n\r\nfunction hasLocalStorage() {\r\n  try {\r\n    return typeof localStorage !== 'undefined';\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\n// In-memory snapshot of expected localStorage state per slot.\r\n// This lets us detect manual/out-of-band changes while the game is running.\r\nconst expectedStateBySlot = new Map();\r\nlet integrityInternalWriteDepth = 0;\r\n\r\nfunction parseSlotFromKey(key) {\r\n  if (!key) return null;\r\n  const match = /:(\\d+)$/.exec(String(key));\r\n  if (!match) return null;\r\n  const slot = Number.parseInt(match[1], 10);\r\n  return Number.isFinite(slot) && slot > 0 ? slot : null;\r\n}\r\n\r\nfunction rebuildExpectedStateForSlot(slot) {\r\n  const snapshot = new Map();\r\n  if (!hasLocalStorage()) {\r\n    expectedStateBySlot.set(slot, snapshot);\r\n    return snapshot;\r\n  }\r\n  try {\r\n    for (let i = 0; i < localStorage.length; i += 1) {\r\n      const key = localStorage.key(i);\r\n      if (!key || !key.startsWith(STORAGE_PREFIX)) continue;\r\n      const keySlot = parseSlotFromKey(key);\r\n      if (keySlot == null || keySlot !== slot) continue;\r\n      let value = '';\r\n      try {\r\n        value = localStorage.getItem(key) ?? '';\r\n      } catch {\r\n        value = '';\r\n      }\r\n      snapshot.set(key, value);\r\n    }\r\n  } catch {}\r\n  expectedStateBySlot.set(slot, snapshot);\r\n  return snapshot;\r\n}\r\n\r\nfunction ensureExpectedStateForSlot(slot) {\r\n  if (!Number.isFinite(slot) || slot <= 0) return null;\r\n  if (expectedStateBySlot.has(slot)) return expectedStateBySlot.get(slot);\r\n  return rebuildExpectedStateForSlot(slot);\r\n}\r\n\r\nexport function beforeSlotWrite(key) {\r\n  if (!hasLocalStorage()) return;\r\n  if (integrityInternalWriteDepth > 0) return;\r\n\r\n  const strKey = String(key);\r\n  if (!strKey.startsWith(STORAGE_PREFIX)) return;\r\n\r\n  const slot = parseSlotFromKey(strKey);\r\n\r\n  if (slot == null) return;\r\n\r\n  const snapshot = ensureExpectedStateForSlot(slot);\r\n  if (!snapshot) return;\r\n\r\n  try {\r\n    for (const [snapKey, expectedValue] of snapshot.entries()) {\r\n      let actualValue = '';\r\n      try {\r\n        actualValue = localStorage.getItem(snapKey) ?? '';\r\n      } catch {\r\n        actualValue = '';\r\n      }\r\n      if (actualValue !== expectedValue) {\r\n        if (integrityInternalWriteDepth === 0) {\r\n          integrityInternalWriteDepth += 1;\r\n          try {\r\n            markSaveSlotModified(slot);\r\n          } finally {\r\n            integrityInternalWriteDepth -= 1;\r\n          }\r\n        }\r\n        rebuildExpectedStateForSlot(slot);\r\n        return;\r\n      }\r\n    }\r\n  } catch {}\r\n}\r\n\r\nexport function afterSlotWrite(key, value) {\r\n  const strKey = String(key);\r\n  if (!strKey.startsWith(STORAGE_PREFIX)) return;\r\n  const slot = parseSlotFromKey(strKey);\r\n  if (slot == null) return;\r\n\r\n  const snapshot = ensureExpectedStateForSlot(slot) || new Map();\r\n  snapshot.set(strKey, String(value ?? ''));\r\n  expectedStateBySlot.set(slot, snapshot);\r\n}\r\n\r\nfunction computeSignature(entries = []) {\r\n  let hash = 0;\r\n  for (const entry of entries) {\r\n    for (let i = 0; i < entry.length; i += 1) {\r\n      hash = ((hash << 5) - hash + entry.charCodeAt(i)) >>> 0;\r\n    }\r\n    hash = (hash + 0x9e3779b1) >>> 0;\r\n  }\r\n  return `${entries.length}|${hash.toString(16)}`;\r\n}\r\n\r\nfunction collectEntriesBySlot() {\r\n  const map = new Map();\r\n  if (!hasLocalStorage()) return map;\r\n  try {\r\n    for (let i = 0; i < localStorage.length; i += 1) {\r\n      const key = localStorage.key(i);\r\n      if (!key || !key.startsWith(STORAGE_PREFIX)) continue;\r\n      const slotMatch = key.match(/:(\\d+)$/);\r\n      if (!slotMatch) continue;\r\n      const slot = parseInt(slotMatch[1], 10);\r\n      if (!Number.isFinite(slot) || slot <= 0) continue;\r\n      const sigKey = getSlotSignatureKey(slot);\r\n      if (key === sigKey) {\r\n        if (!map.has(slot)) map.set(slot, []);\r\n        continue;\r\n      }\r\n      let value = '';\r\n      try { value = localStorage.getItem(key) ?? ''; }\r\n      catch {}\r\n      if (!map.has(slot)) map.set(slot, []);\r\n      map.get(slot).push(`${key}=${value}`);\r\n    }\r\n  } catch {}\r\n  map.forEach((entries) => entries.sort());\r\n  return map;\r\n}\r\n\r\nfunction getCandidateSlots(entriesBySlot) {\r\n  const slots = new Set();\r\n  if (entriesBySlot) {\r\n    entriesBySlot.forEach((_, slot) => slots.add(slot));\r\n  }\r\n  const active = getActiveSlot();\r\n  if (Number.isFinite(active) && active > 0) slots.add(active);\r\n  if (typeof document !== 'undefined') {\r\n    document.querySelectorAll('.slot-card').forEach((_, idx) => slots.add(idx + 1));\r\n  }\r\n  return [...slots].filter((slot) => Number.isFinite(slot) && slot > 0);\r\n}\r\n\r\nfunction verifySlotIntegrity(slot, entries) {\r\n  if (!slot || slot <= 0) return;\r\n  const list = Array.isArray(entries) ? entries : [];\r\n  const stored = getSlotSignature(slot);\r\n  if (list.length === 0) {\r\n    if (stored) {\r\n      if (!slotRecentlyTrusted(slot)) {\r\n        markSaveSlotModified(slot);\r\n      }\r\n      setSlotSignature(slot, null);\r\n    }\r\n    return;\r\n  }\r\n  const signature = computeSignature(list);\r\n  const mismatch = signature !== stored;\r\n  if (stored && mismatch && !slotRecentlyTrusted(slot)) {\r\n    markSaveSlotModified(slot);\r\n  }\r\n  if (signature !== stored) {\r\n    setSlotSignature(slot, signature);\r\n  }\r\n}\r\n\r\nfunction runIntegrityCheck() {\r\n  if (!hasLocalStorage()) return;\r\n  const entriesBySlot = collectEntriesBySlot();\r\n  const slots = getCandidateSlots(entriesBySlot);\r\n  slots.forEach((slot) => {\r\n    const entries = entriesBySlot.get(slot) ?? [];\r\n    verifySlotIntegrity(slot, entries);\r\n  });\r\n}\r\n\r\nfunction scheduleTrustedMutationSweep() {\r\n  if (trustedSweepTimer != null) return;\r\n  const root = typeof window !== 'undefined' ? window : globalThis;\r\n  trustedSweepTimer = root.setTimeout(() => {\r\n    trustedSweepTimer = null;\r\n    runIntegrityCheck();\r\n  }, TRUSTED_SWEEP_DELAY_MS);\r\n}\r\n\r\nfunction handleStorageMutationEvent(event) {\r\n  const detail = event?.detail;\r\n  if (!detail) return;\r\n  const rawSlot = typeof detail.slot === 'number' ? detail.slot : Number.parseInt(detail.slot, 10);\r\n  const slot = Number.isFinite(rawSlot) ? rawSlot : null;\r\n  if (!Number.isFinite(slot) || slot <= 0) return;\r\n  if (detail.trusted) {\r\n    noteTrustedSlot(slot);\r\n    scheduleTrustedMutationSweep();\r\n    return;\r\n  }\r\n  trustedSlotsUntil.delete(slot);\r\n  runIntegrityCheck();\r\n}\r\n\r\nfunction ensureWatcher() {\r\n  if (typeof window === 'undefined') return;\r\n  if (watcherId != null) return;\r\n  watcherId = window.setInterval(runIntegrityCheck, SIGNATURE_POLL_INTERVAL_MS);\r\n}\r\n\r\nconst POOP_SHOP_BG  = 'linear-gradient(180deg,#a9793d,#7b5534)';\r\nconst POOP_SHOP_FLAG = '1';\r\n\r\nlet poopShopTimer = null;\r\n\r\nfunction getShopButtonElement() {\r\n  if (typeof document === 'undefined') return null;\r\n  return document.querySelector('.hud-bottom .game-btn[data-btn=\"shop\"]');\r\n}\r\n\r\nfunction enforcePoopShopStyle() {\r\n  const btn = getShopButtonElement();\r\n  if (!btn) return;\r\n\r\n  const isModded = hasModifiedSave();\r\n\r\n  if (!isModded) {\r\n    if (btn.dataset.poopShopApplied === POOP_SHOP_FLAG || btn.style.backgroundImage || btn.style.background) {\r\n      btn.style.backgroundImage = '';\r\n      btn.style.background = '';\r\n      delete btn.dataset.poopShopApplied;\r\n    }\r\n    return;\r\n  }\r\n\r\n  const current = btn.style.backgroundImage || btn.style.background;\r\n  if (current !== POOP_SHOP_BG || btn.dataset.poopShopApplied !== POOP_SHOP_FLAG) {\r\n    btn.style.backgroundImage = POOP_SHOP_BG;\r\n    btn.dataset.poopShopApplied = POOP_SHOP_FLAG;\r\n  }\r\n}\r\n\r\nfunction startPoopShopEnforcer() {\r\n  if (typeof window === 'undefined') return;\r\n  if (poopShopTimer != null) return;\r\n\r\n  enforcePoopShopStyle();\r\n  poopShopTimer = window.setInterval(enforcePoopShopStyle, 50);\r\n\r\n  window.addEventListener('saveSlot:change', enforcePoopShopStyle);\r\n  window.addEventListener('saveSlot:modified', (ev) => {\r\n    try {\r\n      const active = getActiveSlot();\r\n      if (ev?.detail?.slot === active) {\r\n        enforcePoopShopStyle();\r\n      }\r\n    } catch {\r\n      enforcePoopShopStyle();\r\n    }\r\n  });\r\n}\r\n\r\nfunction init() {\r\n  if (typeof window === 'undefined') return;\r\n  runIntegrityCheck();\r\n  ensureWatcher();\r\n  startPoopShopEnforcer();\r\n  window.addEventListener('saveSlot:change', () => runIntegrityCheck());\r\n  window.addEventListener('saveIntegrity:storageMutation', handleStorageMutationEvent, { passive: true });\r\n  if (typeof document !== 'undefined') {\r\n    document.addEventListener('visibilitychange', () => {\r\n      if (!document.hidden) {\r\n        resetTrustedSlots();\r\n        runIntegrityCheck();\r\n        enforcePoopShopStyle();\r\n      }\r\n    });\r\n  }\r\n}\r\n\r\ninit();\r\n", "// js/ui/popups.js\r\n\r\nimport { BigNum } from '../util/bigNum.js';\r\nimport { formatNumber } from '../util/numFormat.js';\r\nimport { CURRENCIES, isCurrencyLocked, isStorageKeyLocked, getActiveSlot, getCurrency } from '../util/storage.js';\r\n\r\nconst DEFAULT_DURATION = 6767;\r\n\r\nconst POPUP_ORDER = ['coins', 'xp', 'books', 'gold', 'mp', 'magic', 'gears'];\r\n\r\nconst POPUP_META = {\r\n  [CURRENCIES.COINS]: {\r\n    icon: 'img/currencies/coin/coin.webp',\r\n    iconAlt: 'Coin',\r\n  },\r\n  xp: {\r\n    icon: 'img/stats/xp/xp.webp',\r\n    iconAlt: 'XP',\r\n  },\r\n  [CURRENCIES.BOOKS]: {\r\n    icon: 'img/currencies/book/book.webp',\r\n    iconAlt: 'Book',\r\n  },\r\n  [CURRENCIES.GOLD]: {\r\n    icon: 'img/currencies/gold/gold.webp',\r\n    iconAlt: 'Gold',\r\n  },\r\n  mp: {\r\n    icon: 'img/stats/mp/mp.webp',\r\n    iconAlt: 'Mutation Power',\r\n  },\r\n  [CURRENCIES.MAGIC]: {\r\n    icon: 'img/currencies/magic/magic.webp',\r\n    iconAlt: 'Magic',\r\n  },\r\n  [CURRENCIES.GEARS]: {\r\n    icon: 'img/currencies/gear/gear.webp',\r\n    iconAlt: 'Gears',\r\n  },\r\n};\r\n\r\nlet container = null;\r\nlet initialized = false;\r\nconst lastKnownAmounts = new Map();\r\nconst activePopups = new Map();\r\n\r\nfunction ensureContainer() {\r\n  if (container) return container;\r\n  container = document.createElement('div');\r\n  container.className = 'currency-popups';\r\n  container.setAttribute('aria-live', 'polite');\r\n  container.setAttribute('aria-atomic', 'false');\r\n  document.body.appendChild(container);\r\n  return container;\r\n}\r\n\r\nfunction bnFromAny(value) {\r\n  if (value == null) return null;\r\n  if (value instanceof BigNum) return value.clone?.() ?? value;\r\n  if (typeof value.clone === 'function' && value.sig != null) {\r\n    try { return value.clone(); } catch {}\r\n  }\r\n  try { return BigNum.fromAny(value); } catch { return null; }\r\n}\r\n\r\nfunction isZero(bn) {\r\n  if (!bn) return true;\r\n  if (typeof bn.isZero === 'function') {\r\n    try { return bn.isZero(); } catch { return false; }\r\n  }\r\n  return false;\r\n}\r\n\r\nfunction updateEntry(entry) {\r\n  if (!entry) return;\r\n  const { amountEl, amount, meta } = entry;\r\n  const formatted = meta.formatAmount ? meta.formatAmount(amount) : formatNumber(amount);\r\n  if (amountEl) amountEl.innerHTML = formatted;\r\n}\r\n\r\nfunction scheduleRemoval(entry, duration = DEFAULT_DURATION) {\r\n  if (!entry) return;\r\n  if (entry.timeoutId) return; // already scheduled; do NOT reset\r\n  entry.timeoutId = window.setTimeout(() => {\r\n    activePopups.delete(entry.type);\r\n    entry.element.classList.remove('is-visible');\r\n    entry.element.classList.add('is-leaving');\r\n    const remove = () => {\r\n      entry.element.removeEventListener('transitionend', remove);\r\n      entry.element.remove();\r\n    };\r\n    entry.element.addEventListener('transitionend', remove, { once: true });\r\n    window.setTimeout(remove, 480);\r\n  }, duration);\r\n}\r\n\r\nfunction createPopupEntry(type, meta, amount) {\r\n  ensureContainer();\r\n  const element = document.createElement('div');\r\n  element.className = 'currency-popup';\r\n  element.setAttribute('role', 'status');\r\n\r\n  const plus = document.createElement('span');\r\n  plus.className = 'currency-popup__plus';\r\n  plus.textContent = '+';\r\n\r\n  const icon = document.createElement('img');\r\n  icon.className = 'currency-popup__icon';\r\n  icon.src = meta.icon;\r\n  icon.alt = meta.iconAlt || '';\r\n\r\n  const text = document.createElement('span');\r\n  text.className = 'currency-popup__text';\r\n\r\n  const amountEl = document.createElement('span');\r\n  amountEl.className = 'currency-popup__amount';\r\n\r\n  text.append(amountEl);\r\n  element.append(plus, icon, text);\r\n  element.dataset.type = type;\r\n\r\n  return {\r\n    type,\r\n    meta,\r\n    element,\r\n    amountEl,\r\n    amount: amount.clone?.() ?? amount,\r\n    timeoutId: null,\r\n  };\r\n}\r\n\r\nfunction showPopup(type, amount, overrides = {}) {\r\n  // Check locks\r\n  const slot = getActiveSlot();\r\n  if (slot != null) {\r\n      if (['xp'].includes(type)) {\r\n          if (isStorageKeyLocked(`ccc:xp:progress:${slot}`)) return;\r\n      } else if (['mp'].includes(type)) {\r\n          if (isStorageKeyLocked(`ccc:mutation:progress:${slot}`)) return;\r\n      } else if (Object.values(CURRENCIES).includes(type)) {\r\n          if (isCurrencyLocked(type, slot)) return;\r\n      }\r\n  }\r\n\r\n  const baseMeta = POPUP_META[type];\r\n  const meta = Object.assign({ duration: DEFAULT_DURATION, accumulate: true }, baseMeta || {}, overrides);\r\n  if (!meta.icon) return;\r\n\r\n  const bnAmount = bnFromAny(amount);\r\n  if (!bnAmount || isZero(bnAmount)) return;\r\n\r\n  const existing = meta.accumulate !== false ? activePopups.get(type) : null;\r\n\r\n  if (existing) {\r\n    // Update the number but DO NOT reset its lifetime or animations.\r\n    existing.amount = existing.amount.add(bnAmount);\r\n    existing.meta = meta;\r\n    updateEntry(existing);\r\n    return;\r\n  }\r\n\r\n  const entry = createPopupEntry(type, meta, bnAmount);\r\n  entry.meta = meta;\r\n  updateEntry(entry);\r\n  activePopups.set(type, entry);\r\n\r\n  const host = ensureContainer();\r\n\r\n  // Insert based on order (coins first, xp second, books last, gears very last)\r\n  const index = POPUP_ORDER.indexOf(type);\r\n  let insertBefore = null;\r\n  \r\n  if (index >= 0) {\r\n    const children = Array.from(host.children);\r\n    for (const child of children) {\r\n      const childType = child.dataset.type;\r\n      const childIndex = POPUP_ORDER.indexOf(childType);\r\n      if (childIndex > index) {\r\n        insertBefore = child;\r\n        break;\r\n      }\r\n    }\r\n  }\r\n\r\n  if (insertBefore) host.insertBefore(entry.element, insertBefore);\r\n  else host.appendChild(entry.element);\r\n\r\n  requestAnimationFrame(() => entry.element.classList.add('is-visible'));\r\n  scheduleRemoval(entry, meta.duration); // scheduled ONCE at creation\r\n}\r\n\r\nfunction getAllCurrencies() {\r\n  const all = {};\r\n  for (const key of Object.values(CURRENCIES)) {\r\n    all[key] = getCurrency(key);\r\n  }\r\n  return all;\r\n}\r\n\r\nfunction syncLastKnown() {\r\n  try {\r\n    const all = getAllCurrencies();\r\n    Object.entries(all).forEach(([key, value]) => {\r\n      const bn = bnFromAny(value) || BigNum.fromInt(0);\r\n      lastKnownAmounts.set(key, bn.clone?.() ?? bn);\r\n    });\r\n    if (!lastKnownAmounts.has('mp')) {\r\n      lastKnownAmounts.set('mp', BigNum.fromInt(0));\r\n    }\r\n  } catch {\r\n    lastKnownAmounts.clear();\r\n  }\r\n}\r\n\r\nfunction clearActivePopups() {\r\n  activePopups.forEach((entry) => {\r\n    if (entry.timeoutId) clearTimeout(entry.timeoutId);\r\n    entry.element.remove();\r\n  });\r\n  activePopups.clear();\r\n}\r\n\r\nfunction handleCurrencyChange(event) {\r\n  const detail = event?.detail;\r\n  if (!detail?.key) return;\r\n  const key = detail.key;\r\n  const current = bnFromAny(detail.value) || BigNum.fromInt(0);\r\n  const prev = lastKnownAmounts.get(key) || BigNum.fromInt(0);\r\n  const zero = BigNum.fromInt(0);\r\n  let delta = null;\r\n  const detailDelta = detail.delta != null ? bnFromAny(detail.delta) : null;\r\n  if (detailDelta && typeof detailDelta.cmp === 'function' && detailDelta.cmp(zero) > 0) {\r\n    delta = detailDelta;\r\n  } else if (typeof current.cmp === 'function' && current.cmp(prev) > 0) {\r\n    delta = current.sub(prev);\r\n  }\r\n  if (delta && !(typeof delta.isZero === 'function' && delta.isZero())) {\r\n    showPopup(key, delta);\r\n  }\r\n  lastKnownAmounts.set(key, current.clone?.() ?? current);\r\n}\r\n\r\nfunction handleXpChange(event) {\r\n  const detail = event?.detail;\r\n  if (!detail) return;\r\n  const xpAdded = bnFromAny(detail.xpAdded);\r\n  if (xpAdded && !isZero(xpAdded)) showPopup('xp', xpAdded);\r\n}\r\n\r\nfunction handleMutationChange(event) {\r\n  const detail = event?.detail;\r\n  if (!detail) return;\r\n  const delta = bnFromAny(detail.delta);\r\n  if (delta && !isZero(delta)) {\r\n    showPopup('mp', delta);\r\n  }\r\n  const nextProgress = bnFromAny(detail.progress);\r\n  if (nextProgress) {\r\n    lastKnownAmounts.set('mp', nextProgress.clone?.() ?? nextProgress);\r\n  }\r\n}\r\n\r\nfunction handleSlotChange() {\r\n  clearActivePopups();\r\n  syncLastKnown();\r\n}\r\n\r\nexport function initPopups() {\r\n  if (initialized) return;\r\n  initialized = true;\r\n  ensureContainer();\r\n  syncLastKnown();\r\n  window.addEventListener('currency:change', handleCurrencyChange);\r\n  window.addEventListener('xp:change', handleXpChange);\r\n  window.addEventListener('mutation:change', handleMutationChange);\r\n  window.addEventListener('saveSlot:change', handleSlotChange);\r\n}\r\n\r\nexport function teardownpopups() {\r\n  if (!initialized) return;\r\n  window.removeEventListener('currency:change', handleCurrencyChange);\r\n  window.removeEventListener('xp:change', handleXpChange);\r\n  window.removeEventListener('mutation:change', handleMutationChange);\r\n  window.removeEventListener('saveSlot:change', handleSlotChange);\r\n  clearActivePopups();\r\n  lastKnownAmounts.clear();\r\n  if (container) container.remove();\r\n  container = null;\r\n  initialized = false;\r\n}\r\n", "// js/util/suspendSafeguard.js\r\n// Improves local storage tracking by supplying helper functions for saveIntegrity.js,\r\n// And also supplies frequent IndexedDB snapshots to back up progress if\r\n// Local storage ever becomes corrupted (safeguard against abrupt page suspensions)\r\nimport { beforeSlotWrite, afterSlotWrite } from './saveIntegrity.js';\r\n\r\nconst STORAGE_PREFIX = 'ccc:';\r\nconst DB_NAME = 'ccc:safety';\r\nconst DB_VERSION = 1;\r\nconst STORE_NAME = 'snapshots';\r\nconst SNAPSHOT_KEY = 'latest';\r\nconst SLOT_SIGNATURE_PREFIX = `${STORAGE_PREFIX}slotSig`;\r\nconst SLOT_MOD_FLAG_PREFIX = `${STORAGE_PREFIX}slotMod`;\r\nconst FLUSH_DEBOUNCE_MS = 1000;\r\n\r\nlet dbPromise = null;\r\nlet flushTimer = null;\r\nlet dirty = false;\r\nlet lastDirtyReason = 'init';\r\nlet installAttempted = false;\r\nlet restoreAttempted = false;\r\nlet pendingImmediateFlush = false;\r\n\r\nfunction canUseIndexedDb() {\r\n  if (typeof indexedDB === 'undefined') return false;\r\n  try {\r\n    return typeof indexedDB.open === 'function';\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\nfunction canUseLocalStorage() {\r\n  if (typeof localStorage === 'undefined') return false;\r\n  try {\r\n    const testKey = `${STORAGE_PREFIX}__test__`;\r\n    localStorage.setItem(testKey, '1');\r\n    localStorage.removeItem(testKey);\r\n    return true;\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\nasync function openDatabase() {\r\n  if (!canUseIndexedDb()) throw new Error('IndexedDB unavailable');\r\n  if (dbPromise) return dbPromise;\r\n\r\n  dbPromise = new Promise((resolve, reject) => {\r\n    let resolved = false;\r\n    try {\r\n      const request = indexedDB.open(DB_NAME, DB_VERSION);\r\n      request.onupgradeneeded = () => {\r\n        try {\r\n          const db = request.result;\r\n          if (!db.objectStoreNames.contains(STORE_NAME)) {\r\n            db.createObjectStore(STORE_NAME);\r\n          }\r\n        } catch (err) {\r\n          console.warn('Failed to upgrade suspend safeguard DB', err);\r\n        }\r\n      };\r\n      request.onsuccess = () => {\r\n        resolved = true;\r\n        const db = request.result;\r\n        db.onversionchange = () => {\r\n          try { db.close(); } catch {}\r\n          dbPromise = null;\r\n        };\r\n        resolve(db);\r\n      };\r\n      request.onerror = () => {\r\n        if (!resolved) {\r\n          reject(request.error || new Error('Failed to open suspend safeguard DB'));\r\n        }\r\n      };\r\n      request.onblocked = () => {\r\n        // Nothing special, but ensure promise settles eventually\r\n      };\r\n    } catch (err) {\r\n      reject(err);\r\n    }\r\n  }).catch((err) => {\r\n    dbPromise = null;\r\n    throw err;\r\n  });\r\n\r\n  return dbPromise;\r\n}\r\n\r\nfunction captureSnapshot() {\r\n  if (!canUseLocalStorage()) return null;\r\n  const data = {};\r\n  let captured = false;\r\n  try {\r\n    for (let i = 0; i < localStorage.length; i++) {\r\n      const key = localStorage.key(i);\r\n      if (!key || !key.startsWith(STORAGE_PREFIX)) continue;\r\n      let value = null;\r\n      try {\r\n        value = localStorage.getItem(key);\r\n      } catch {\r\n        value = null;\r\n      }\r\n      if (value == null) continue;\r\n      data[key] = value;\r\n      captured = true;\r\n    }\r\n  } catch (err) {\r\n    console.warn('Failed to read localStorage for snapshot', err);\r\n    return null;\r\n  }\r\n\r\n  return {\r\n    data,\r\n    savedAt: Date.now(),\r\n    hasData: captured,\r\n  };\r\n}\r\n\r\nasync function putSnapshot(snapshot) {\r\n  try {\r\n    const db = await openDatabase();\r\n    await new Promise((resolve, reject) => {\r\n      let settled = false;\r\n      const tx = db.transaction(STORE_NAME, 'readwrite');\r\n      tx.oncomplete = () => { if (!settled) { settled = true; resolve(true); } };\r\n      tx.onabort = () => { if (!settled) { settled = true; reject(tx.error || new Error('Snapshot transaction aborted')); } };\r\n      tx.onerror = () => { if (!settled) { settled = true; reject(tx.error || new Error('Snapshot transaction error')); } };\r\n      const store = tx.objectStore(STORE_NAME);\r\n      const request = store.put(snapshot, SNAPSHOT_KEY);\r\n      request.onerror = () => {\r\n        if (!settled) {\r\n          settled = true;\r\n          reject(request.error || new Error('Snapshot write failed'));\r\n        }\r\n      };\r\n    });\r\n    return true;\r\n  } catch (err) {\r\n    console.warn('Failed to persist suspend snapshot', err);\r\n    return false;\r\n  }\r\n}\r\n\r\nasync function readSnapshot() {\r\n  try {\r\n    const db = await openDatabase();\r\n    return await new Promise((resolve, reject) => {\r\n      let settled = false;\r\n      const tx = db.transaction(STORE_NAME, 'readonly');\r\n      tx.oncomplete = () => { if (!settled) { settled = true; resolve(null); } };\r\n      tx.onabort = () => { if (!settled) { settled = true; reject(tx.error || new Error('Snapshot read aborted')); } };\r\n      tx.onerror = () => { if (!settled) { settled = true; reject(tx.error || new Error('Snapshot read error')); } };\r\n      const store = tx.objectStore(STORE_NAME);\r\n      const request = store.get(SNAPSHOT_KEY);\r\n      request.onsuccess = () => {\r\n        if (settled) return;\r\n        settled = true;\r\n        resolve(request.result || null);\r\n      };\r\n      request.onerror = () => {\r\n        if (!settled) {\r\n          settled = true;\r\n          reject(request.error || new Error('Snapshot get failed'));\r\n        }\r\n      };\r\n    });\r\n  } catch (err) {\r\n    console.warn('Failed to load suspend snapshot', err);\r\n    return null;\r\n  }\r\n}\r\n\r\nfunction requestPersistentStorage() {\r\n  try {\r\n    if (navigator?.storage?.persist) {\r\n      navigator.storage.persist().catch(() => {});\r\n    }\r\n  } catch {}\r\n}\r\n\r\nfunction captureStackTrace() {\r\n  try {\r\n    throw new Error('ccc-storage-write');\r\n  } catch (err) {\r\n    return err?.stack || '';\r\n  }\r\n}\r\n\r\nfunction parseSlotFromKey(key) {\r\n  if (!key) return null;\r\n  const match = /:(\\d+)$/.exec(String(key));\r\n  if (!match) return null;\r\n  const slot = parseInt(match[1], 10);\r\n  return Number.isFinite(slot) && slot > 0 ? slot : null;\r\n}\r\n\r\nconst DEVTOOLS_CONSOLE_FRAME_RE = /\\bat <anonymous>:\\d+:\\d+\\b/;\r\n\r\nfunction isTrustedStorageStack(stack) {\r\n  if (typeof stack !== 'string' || stack.length === 0) return false;\r\n  \r\n  if (DEVTOOLS_CONSOLE_FRAME_RE.test(stack)) return false;\r\n\r\n  return true;\r\n}\r\n\r\nfunction notifySaveIntegrityOfStorageMutation(key, stack) {\r\n  if (typeof window === 'undefined') return;\r\n  if (!key) return;\r\n  const strKey = String(key);\r\n  if (!strKey.startsWith(STORAGE_PREFIX)) return;\r\n  if (strKey.startsWith(SLOT_SIGNATURE_PREFIX) || strKey.startsWith(SLOT_MOD_FLAG_PREFIX)) return;\r\n  const slot = parseSlotFromKey(strKey);\r\n  if (slot == null) return;\r\n  try {\r\n    const detail = {\r\n      key: strKey,\r\n      slot,\r\n      trusted: isTrustedStorageStack(stack),\r\n    };\r\n    window.dispatchEvent(new CustomEvent('saveIntegrity:storageMutation', { detail }));\r\n  } catch {}\r\n}\r\n\r\nfunction installStorageHooks() {\r\n  if (typeof localStorage === 'undefined') return;\r\n  try {\r\n    const proto = Object.getPrototypeOf(localStorage);\r\n    if (!proto || proto.__cccStoragePatched) return;\r\n\r\n    const originalSet = proto.setItem;\r\n    const originalRemove = proto.removeItem;\r\n    const originalClear = proto.clear;\r\n\r\nif (typeof originalSet === 'function') {\r\n  proto.setItem = function patchedSetItem(key, value) {\r\n    const stack = captureStackTrace();\r\n    const strKey = String(key);\r\n\r\n\tconst isTrackedGameKey =\r\n      this === localStorage &&\r\n      strKey.startsWith(STORAGE_PREFIX);\r\n\r\n\r\n    // Before we write, verify nothing in this slot changed behind our back.\r\n    if (isTrackedGameKey) {\r\n      try {\r\n        beforeSlotWrite(strKey);\r\n      } catch {}\r\n    }\r\n\r\n    let result;\r\n    try {\r\n      result = originalSet.apply(this, arguments);\r\n    } finally {\r\n      try {\r\n        if (isTrackedGameKey) {\r\n          markProgressDirty('setItem');\r\n          // Keep the in-memory expected state in sync with what we just wrote.\r\n          try {\r\n            afterSlotWrite(strKey, value);\r\n          } catch {}\r\n        }\r\n\r\n        // We still want integrity events for game keys, but we've already\r\n        // excluded slotSig/slotMod inside notifySaveIntegrityOfStorageMutation.\r\n        if (this === localStorage && strKey.startsWith(STORAGE_PREFIX)) {\r\n          notifySaveIntegrityOfStorageMutation(strKey, stack);\r\n        }\r\n      } catch {}\r\n    }\r\n    return result;\r\n  };\r\n}\r\n\r\n    if (typeof originalRemove === 'function') {\r\n      proto.removeItem = function patchedRemoveItem(key) {\r\n        const stack = captureStackTrace();\r\n        let result;\r\n        try {\r\n          result = originalRemove.apply(this, arguments);\r\n        } finally {\r\n          try {\r\n            if (this === localStorage && String(key).startsWith(STORAGE_PREFIX)) {\r\n              markProgressDirty('removeItem');\r\n              notifySaveIntegrityOfStorageMutation(key, stack);\r\n            }\r\n          } catch {}\r\n        }\r\n        return result;\r\n      };\r\n    }\r\n\r\n    if (typeof originalClear === 'function') {\r\n      proto.clear = function patchedClear() {\r\n        const stack = captureStackTrace();\r\n        let result;\r\n        try {\r\n          result = originalClear.apply(this, arguments);\r\n        } finally {\r\n          try {\r\n            if (this === localStorage) {\r\n              markProgressDirty('clear');\r\n              notifySaveIntegrityOfStorageMutation(null, stack);\r\n            }\r\n          } catch {}\r\n        }\r\n        return result;\r\n      };\r\n    }\r\n\r\n    Object.defineProperty(proto, '__cccStoragePatched', {\r\n      value: true,\r\n      enumerable: false,\r\n      configurable: false,\r\n      writable: false,\r\n    });\r\n  } catch (err) {\r\n    console.warn('Failed to patch Storage prototype for suspend safeguards', err);\r\n  }\r\n}\r\n\r\nfunction scheduleFlush(reason = 'idle') {\r\n  lastDirtyReason = reason || lastDirtyReason;\r\n  dirty = true;\r\n  if (flushTimer) return;\r\n  flushTimer = setTimeout(() => {\r\n    flushTimer = null;\r\n    if (!dirty) return;\r\n    const reasonToUse = lastDirtyReason;\r\n    dirty = false;\r\n    void flushBackupSnapshot(reasonToUse);\r\n  }, FLUSH_DEBOUNCE_MS);\r\n}\r\n\r\nfunction cancelFlushTimer() {\r\n  if (!flushTimer) return;\r\n  clearTimeout(flushTimer);\r\n  flushTimer = null;\r\n}\r\n\r\nexport function markProgressDirty(reason = 'dirty') {\r\n  try {\r\n    scheduleFlush(reason);\r\n  } catch {}\r\n}\r\n\r\nasync function performFlush(reason = 'manual') {\r\n  if (!canUseLocalStorage() || !canUseIndexedDb()) return false;\r\n  const snapshot = captureSnapshot();\r\n  if (!snapshot) return false;\r\n  snapshot.reason = reason;\r\n  pendingImmediateFlush = false;\r\n  const ok = await putSnapshot(snapshot);\r\n  if (!ok) {\r\n    // Keep dirty flag so another attempt can happen later\r\n    dirty = true;\r\n    scheduleFlush('retry');\r\n  }\r\n  return ok;\r\n}\r\n\r\nexport async function flushBackupSnapshot(reason = 'manual', { immediate = false } = {}) {\r\n  if (!canUseLocalStorage() || !canUseIndexedDb()) return false;\r\n  if (immediate) {\r\n    cancelFlushTimer();\r\n    dirty = false;\r\n    pendingImmediateFlush = true;\r\n    return performFlush(reason);\r\n  }\r\n  dirty = true;\r\n  lastDirtyReason = reason || lastDirtyReason;\r\n  return performFlush(reason);\r\n}\r\n\r\nfunction flushBeforeSuspend(reason) {\r\n  if (!canUseIndexedDb() || !canUseLocalStorage()) return;\r\n  cancelFlushTimer();\r\n  dirty = false;\r\n  pendingImmediateFlush = true;\r\n  void performFlush(reason);\r\n}\r\n\r\nfunction hasAnyPrefixedKeys() {\r\n  if (!canUseLocalStorage()) return false;\r\n  try {\r\n    for (let i = 0; i < localStorage.length; i++) {\r\n      const key = localStorage.key(i);\r\n      if (key && key.startsWith(STORAGE_PREFIX)) return true;\r\n    }\r\n  } catch {}\r\n  return false;\r\n}\r\n\r\nexport async function restoreFromBackupIfNeeded() {\r\n  if (restoreAttempted) return false;\r\n  restoreAttempted = true;\r\n  if (!canUseLocalStorage() || !canUseIndexedDb()) return false;\r\n\r\n  let shouldRestore = false;\r\n  try {\r\n    if (!hasAnyPrefixedKeys()) {\r\n      shouldRestore = true;\r\n    } else {\r\n      const activeSlot = localStorage.getItem(`${STORAGE_PREFIX}saveSlot`);\r\n      if (activeSlot) {\r\n        const coinKey = `${STORAGE_PREFIX}coins:${activeSlot}`;\r\n        if (localStorage.getItem(coinKey) == null) {\r\n          shouldRestore = true;\r\n        }\r\n      }\r\n    }\r\n  } catch {\r\n    shouldRestore = false;\r\n  }\r\n\r\n  if (!shouldRestore) return false;\r\n\r\n  const snapshot = await readSnapshot();\r\n  if (!snapshot?.data) return false;\r\n\r\n  let restored = false;\r\n  try {\r\n    for (const [key, value] of Object.entries(snapshot.data)) {\r\n      if (value == null) continue;\r\n      if (localStorage.getItem(key) === null) {\r\n        localStorage.setItem(key, value);\r\n        restored = true;\r\n      }\r\n    }\r\n  } catch (err) {\r\n    console.warn('Failed to restore snapshot into localStorage', err);\r\n  }\r\n\r\n  if (restored) {\r\n    markProgressDirty('restored');\r\n  }\r\n\r\n  return restored;\r\n}\r\n\r\nexport function installSuspendSafeguards() {\r\n  if (installAttempted) return;\r\n  installAttempted = true;\r\n  if (typeof window === 'undefined') return;\r\n\r\n  requestPersistentStorage();\r\n  installStorageHooks();\r\n\r\n  const onVisibilityChange = () => {\r\n    if (document.hidden) {\r\n      flushBeforeSuspend('visibility-hidden');\r\n    } else {\r\n      markProgressDirty('visibility-visible');\r\n    }\r\n  };\r\n\r\n  try { document.addEventListener('visibilitychange', onVisibilityChange, { passive: true }); } catch {}\r\n  try { window.addEventListener('pagehide', () => flushBeforeSuspend('pagehide'), { capture: true }); } catch {}\r\n  try { window.addEventListener('beforeunload', () => flushBeforeSuspend('beforeunload')); } catch {}\r\n  try { document.addEventListener('freeze', () => flushBeforeSuspend('freeze')); } catch {}\r\n  try { window.addEventListener('pageshow', () => markProgressDirty('pageshow')); } catch {}\r\n  try { window.addEventListener('focus', () => markProgressDirty('focus')); } catch {}\r\n  try { window.addEventListener('storage', (event) => {\r\n    if (!event) return;\r\n    if (event.storageArea !== localStorage) return;\r\n    if (event.key && !String(event.key).startsWith(STORAGE_PREFIX)) return;\r\n    markProgressDirty('storage-event');\r\n  }); } catch {}\r\n\r\n  markProgressDirty('boot');\r\n}\r\n\r\nexport function getSuspendMetadata() {\r\n  return {\r\n    pendingImmediateFlush,\r\n    dirty,\r\n    lastDirtyReason,\r\n  };\r\n}\r\n", "// js/util/globalOverlayEsc.js\r\n\r\nconst PRIORITY_SELECTORS = [\r\n  { sel: '.offline-overlay', btn: '.offline-close-btn' },\r\n  { sel: '.hm-milestones-overlay', btn: '.hm-milestones-close' },\r\n  { sel: '.merchant-firstchat.is-visible', btn: null, yield: true }, // Don't close parent if chat is open; chat handles itself\r\n  { sel: '.upg-overlay.is-open', btn: '.shop-close' }, // Upgrade details modal\r\n  // Automation Shop has both .shop-overlay and .automation-shop-overlay\r\n  { sel: '.automation-shop-overlay.is-open', btn: '.shop-close' },\r\n  { sel: '.merchant-overlay.is-open', btn: '.merchant-close' },\r\n  { sel: '.shop-overlay.is-open', btn: '.shop-close' }, // Main Shop\r\n];\r\n\r\nfunction handleEsc(e) {\r\n  if (e.key !== 'Escape') return;\r\n\r\n  let yields = false;\r\n  let closedAny = false;\r\n\r\n  for (const { sel, btn, yield: shouldYield } of PRIORITY_SELECTORS) {\r\n    const candidates = document.querySelectorAll(sel);\r\n    if (candidates.length > 0) {\r\n      if (shouldYield) {\r\n        yields = true;\r\n        // Continue to find others to close\r\n        continue;\r\n      }\r\n\r\n      const topMost = candidates[candidates.length - 1];\r\n      const closeButton = topMost.querySelector(btn || '.shop-close');\r\n\r\n      if (closeButton) {\r\n        closeButton.click();\r\n        closedAny = true;\r\n      }\r\n    }\r\n  }\r\n\r\n  if (closedAny || yields) {\r\n    e.preventDefault();\r\n    // Only stop propagation if we didn't yield to another handler\r\n    if (!yields) {\r\n       e.stopPropagation();\r\n       e.stopImmediatePropagation();\r\n    }\r\n  }\r\n}\r\n\r\nexport function initGlobalOverlayEsc() {\r\n  // Use capture=true to intercept the event before other handlers (if registered later on window/document)\r\n  window.addEventListener('keydown', handleEsc, true);\r\n}\r\n", "import { getLastSaveTime, getActiveSlot, isCurrencyLocked, isStorageKeyLocked } from '../util/storage.js';\r\nimport { getGearsProductionRate } from '../ui/merchantTabs/workshopTab.js';\r\nimport { hasDoneInfuseReset } from '../ui/merchantTabs/resetTab.js';\r\nimport { pauseGameLoop, resumeGameLoop } from './gameLoop.js';\r\nimport { bank } from '../util/storage.js';\r\nimport { BigNum } from '../util/bigNum.js';\r\nimport { formatNumber } from '../util/numFormat.js';\r\nimport { ensureCustomScrollbar } from '../ui/shopOverlay.js';\r\nimport { IS_MOBILE } from '../main.js';\r\nimport { getLevelNumber } from './upgrades.js';\r\nimport { AUTOMATION_AREA_KEY, EFFECTIVE_AUTO_COLLECT_ID } from './automationUpgrades.js';\r\nimport { getPassiveCoinReward } from './coinPickup.js';\r\nimport { addXp } from './xpSystem.js';\r\nimport { addMutationPower } from './mutationSystem.js';\r\n\r\nlet initialized = false;\r\n\r\nfunction formatTimeCompact(ms) {\r\n    const s = Math.floor(ms / 1000);\r\n    if (s < 60) return `${s}s`;\r\n    const m = Math.floor(s / 60);\r\n    const rs = s % 60;\r\n    if (m < 60) return `${m}m ${rs}s`;\r\n    const h = Math.floor(m / 60);\r\n    const rm = m % 60;\r\n    if (h < 24) return `${h}h ${rm}m`;\r\n    const d = Math.floor(h / 24);\r\n    const rh = h % 24;\r\n    if (d < 365) return `${d}d ${rh}h`;\r\n    const y = Math.floor(d / 365);\r\n    const rd = d % 365;\r\n    return `${y}y ${rd}d`;\r\n}\r\n\r\n// Visual Priority Map\r\nconst PRIORITY_ORDER = [\r\n    { key: 'coins',     icon: 'img/currencies/coin/coin.webp',   singular: 'Coin',     plural: 'Coins' },\r\n    { key: 'xp',        icon: 'img/stats/xp/xp.webp',            singular: 'XP',       plural: 'XP' },\r\n    { key: 'xp_levels', icon: 'img/stats/xp/xp.webp',            singular: 'XP Level', plural: 'XP Levels' },\r\n    { key: 'books',     icon: 'img/currencies/book/book.webp',   singular: 'Book',     plural: 'Books' },\r\n    { key: 'gold',      icon: 'img/currencies/gold/gold.webp',   singular: 'Gold',     plural: 'Gold' },\r\n    { key: 'mp',        icon: 'img/stats/mp/mp.webp',            singular: 'MP',       plural: 'MP' },\r\n    { key: 'mp_levels', icon: 'img/stats/mp/mp.webp',            singular: 'Mutation Level', plural: 'Mutation Levels' },\r\n    { key: 'magic',     icon: 'img/currencies/magic/magic.webp', singular: 'Magic',    plural: 'Magic' },\r\n    { key: 'gears',     icon: 'img/currencies/gear/gear.webp',   singular: 'Gear',     plural: 'Gears' },\r\n    { key: 'waves',     icon: 'img/currencies/gear/gear.webp',   singular: 'Wave',     plural: 'Waves' },\r\n];\r\n\r\nfunction createOfflinePanel(rewards, offlineMs) {\r\n    const overlay = document.createElement('div');\r\n    overlay.className = 'offline-overlay';\r\n    \r\n    const panel = document.createElement('div');\r\n    panel.className = 'offline-panel';\r\n    \r\n    const header = document.createElement('div');\r\n    header.className = 'offline-header';\r\n    header.textContent = 'Offline Progress';\r\n    \r\n    const subHeader = document.createElement('div');\r\n    subHeader.className = 'offline-subheader';\r\n    subHeader.textContent = `You were gone for ${formatTimeCompact(offlineMs)}`;\r\n\r\n    const contentWrapper = document.createElement('div');\r\n    contentWrapper.className = 'offline-content-wrapper';\r\n\t\r\n\tconst scrollContainer = document.createElement('div');\r\n    scrollContainer.className = 'offline-scroll-container';\r\n    \r\n    const list = document.createElement('div');\r\n    list.className = 'offline-list';\r\n    \r\n    // Iterate rewards in priority order\r\n    PRIORITY_ORDER.forEach(config => {\r\n        const key = config.key;\r\n        const val = rewards[key];\r\n        if (!val || val.isZero()) return;\r\n\r\n        const row = document.createElement('div');\r\n        row.className = 'offline-row';\r\n        \r\n        // + Symbol\r\n        const plus = document.createElement('span');\r\n        plus.className = 'offline-plus';\r\n        plus.classList.add(`text-${key}`);\r\n        plus.textContent = '+';\r\n        \r\n        // Icon\r\n        const icon = document.createElement('img');\r\n        icon.className = 'offline-icon';\r\n        icon.src = config.icon;\r\n        icon.alt = key;\r\n        \r\n        // Amount\r\n        const text = document.createElement('span');\r\n        text.className = 'offline-text';\r\n        text.classList.add(`text-${key}`);\r\n        \r\n        // Grammar logic\r\n        let isOne = false;\r\n        if (val instanceof BigNum) {\r\n            isOne = !val.isInfinite() && val.cmp(BigNum.fromInt(1)) === 0;\r\n        } else {\r\n            isOne = (Number(val) === 1);\r\n        }\r\n        \r\n        const displayName = isOne ? config.singular : config.plural;\r\n\r\n        text.innerHTML = `${formatNumber(val)} ${displayName}`;\r\n        \r\n        row.appendChild(plus);\r\n        row.appendChild(icon);\r\n        row.appendChild(text);\r\n        list.appendChild(row);\r\n    });\r\n    \r\n    scrollContainer.appendChild(list);\r\n    contentWrapper.appendChild(scrollContainer);\r\n    \r\n    const actions = document.createElement('div');\r\n    actions.className = 'offline-actions';\r\n    \r\n    const closeBtn = document.createElement('button');\r\n    closeBtn.type = 'button';\r\n    closeBtn.className = 'offline-close-btn'; \r\n    closeBtn.textContent = 'Close';\r\n    \r\n    const closePanel = () => {\r\n        overlay.remove();\r\n        // No need to resumeGameLoop() here as we didn't pause it\r\n    };\r\n\r\n    closeBtn.addEventListener('click', closePanel);\r\n    overlay.addEventListener('click', (e) => {\r\n        if (e.target === overlay) closePanel();\r\n    });\r\n    \r\n    actions.appendChild(closeBtn);\r\n    \r\n    panel.appendChild(header);\r\n    panel.appendChild(subHeader);\r\n    panel.appendChild(contentWrapper);\r\n    panel.appendChild(actions);\r\n    \r\n    overlay.appendChild(panel);\r\n    document.body.appendChild(overlay);\r\n    \r\n    requestAnimationFrame(() => {\r\n        ensureCustomScrollbar(panel, contentWrapper, '.offline-scroll-container');\r\n    });\r\n    \r\n    return overlay;\r\n}\r\n\r\nexport function processOfflineProgress() {\r\n    // 1. Ensure we are actually in a save slot (prevent Main Menu triggers)\r\n    const slot = getActiveSlot();\r\n    if (slot == null) {\r\n        // If we are on the menu, we do nothing. \r\n        // We do NOT resume loop here because the loop might not even be started yet \r\n        // or handled by main menu logic.\r\n        return; \r\n    }\r\n\r\n    const lastSave = getLastSaveTime();\r\n    const now = Date.now();\r\n    \r\n    if (lastSave <= 0) return;\r\n    \r\n    const diff = now - lastSave;\r\n    if (diff < 1000) return; // Ignore gaps < 1s\r\n    \r\n    if (!hasDoneInfuseReset()) return;\r\n\r\n    const seconds = diff / 1000;\r\n    \r\n    // Calculate Rewards\r\n    // (Only Gears implemented currently)\r\n    const gearRate = getGearsProductionRate ? getGearsProductionRate() : BigNum.fromInt(0);\r\n    const gearsEarned = gearRate.mulDecimal(String(seconds)).floorToInteger();\r\n    \r\n    const rewards = {};\r\n    let hasRewards = false;\r\n    \r\n    if (!gearsEarned.isZero()) {\r\n        if (!isCurrencyLocked('gears', slot)) {\r\n            rewards.gears = gearsEarned;\r\n            hasRewards = true;\r\n            \r\n            // Award immediately\r\n            if (bank.gears) bank.gears.add(rewards.gears);\r\n        }\r\n    }\r\n\r\n    const autoLevel = getLevelNumber(AUTOMATION_AREA_KEY, EFFECTIVE_AUTO_COLLECT_ID) || 0;\r\n    if (autoLevel > 0) {\r\n        const totalPassives = Math.floor(autoLevel * seconds);\r\n        if (totalPassives > 0) {\r\n            const singleReward = getPassiveCoinReward();\r\n            const coinsEarned = singleReward.coins.mulBigNumInteger(BigNum.fromInt(totalPassives));\r\n            const xpEarned = singleReward.xp.mulBigNumInteger(BigNum.fromInt(totalPassives));\r\n            const mpEarned = singleReward.mp.mulBigNumInteger(BigNum.fromInt(totalPassives));\r\n            \r\n            if (!coinsEarned.isZero()) {\r\n                if (!isCurrencyLocked('coins', slot)) {\r\n                    rewards.coins = coinsEarned;\r\n                    hasRewards = true;\r\n                    if (bank.coins) bank.coins.add(coinsEarned);\r\n                }\r\n            }\r\n            if (!xpEarned.isZero()) {\r\n                if (!isStorageKeyLocked(`ccc:xp:progress:${slot}`)) {\r\n                    rewards.xp = xpEarned;\r\n                    hasRewards = true;\r\n                    try {\r\n                        const xpResult = addXp(xpEarned);\r\n                        if (xpResult && xpResult.xpLevelsGained && !xpResult.xpLevelsGained.isZero()) {\r\n                            rewards.xp_levels = xpResult.xpLevelsGained;\r\n                        }\r\n                    } catch {}\r\n                }\r\n            }\r\n            if (!mpEarned.isZero()) {\r\n                if (!isStorageKeyLocked(`ccc:mutation:progress:${slot}`)) {\r\n                    rewards.mp = mpEarned;\r\n                    hasRewards = true;\r\n                    try {\r\n                        const mpResult = addMutationPower(mpEarned);\r\n                        if (mpResult && mpResult.levelsGained && !mpResult.levelsGained.isZero()) {\r\n                            rewards.mp_levels = mpResult.levelsGained;\r\n                        }\r\n                    } catch {}\r\n                }\r\n            }\r\n        }\r\n    }\r\n    \r\n    if (hasRewards) {\r\n        // Remove existing panel if any\r\n        const existing = document.querySelector('.offline-overlay');\r\n        if (existing) existing.remove();\r\n\r\n        // Do NOT pause game loop here (per requirement)\r\n        createOfflinePanel(rewards, diff);\r\n    }\r\n    return hasRewards;\r\n}\r\n\r\nexport function initOfflineTracker(checkActiveState, onReward) {\r\n    if (initialized) return;\r\n    initialized = true;\r\n    \r\n    document.addEventListener('visibilitychange', () => {\r\n        const slot = getActiveSlot();\r\n        if (slot == null) return; // Ignore visibility changes on main menu\r\n\r\n        if (checkActiveState && !checkActiveState()) return;\r\n\r\n        if (document.hidden) {\r\n            pauseGameLoop();\r\n        } else {\r\n            // Resume first, then process logic\r\n            resumeGameLoop();\r\n            const rewarded = processOfflineProgress();\r\n            if (rewarded && typeof onReward === 'function') {\r\n                onReward();\r\n            }\r\n        }\r\n    });\r\n}\r\nwindow.createOfflinePanel = createOfflinePanel;\r\n", "// js/main.js\r\n\r\nexport const DEBUG_PANEL_ACCESS = true; // I will change this to false for prod so the readme makes sense\r\nexport const IS_MOBILE = (() => {\r\n  if (typeof window === 'undefined') return false;\r\n\r\n  if (typeof window.IS_MOBILE !== 'undefined') {\r\n    return !!window.IS_MOBILE;\r\n  }\r\n\r\n  const detected = window.matchMedia\r\n    ? window.matchMedia('(pointer: coarse)').matches\r\n    : 'ontouchstart' in window;\r\n  window.IS_MOBILE = detected;\r\n  return detected;\r\n})();\r\n\r\nlet initSlots;\r\nlet createSpawner;\r\nlet initCoinPickup;\r\nlet initHudButtons;\r\nlet installGhostTapGuard;\r\nlet initGlobalGhostTap;\r\nlet initGlobalOverlayEsc;\r\nlet bank;\r\nlet getHasOpenedSaveSlot;\r\nlet setHasOpenedSaveSlot;\r\nlet ensureStorageDefaults;\r\nlet getUpgAreaKey;\r\nlet computeUpgradeEffects;\r\nlet initXpSystem;\r\nlet onUpgradesChanged;\r\nlet registerPreloadedAudio;\r\nlet initPopups;\r\nlet installSuspendSafeguards;\r\nlet restoreSuspendBackup;\r\nlet markProgressDirty;\r\nlet flushBackupSnapshot;\r\nlet initResetSystemGame;\r\nlet initMutationSystem;\r\nlet getMutationCoinSprite;\r\nlet onMutationChangeGame;\r\nlet setDebugPanelAccess;\r\nlet applyStatMultiplierOverride;\r\nlet startGameLoop;\r\nlet notifyGameSessionStarted;\r\n\r\nconst pendingPreloadedAudio = [];\r\n\r\nfunction applyPendingSlotWipe() {\r\n  let slotStr;\r\n  try {\r\n    slotStr = localStorage.getItem('ccc:pendingSlotWipe');\r\n  } catch {\r\n    slotStr = null;\r\n  }\r\n  if (!slotStr) return;\r\n\r\n  const slot = Number(slotStr);\r\n  const suffix = `:${slot}`;\r\n  const toRemove = [];\r\n\r\n  try {\r\n    const storage = localStorage;\r\n    for (let i = 0; i < storage.length; i++) {\r\n      const key = storage.key(i);\r\n      if (key && key.startsWith('ccc:') && key.endsWith(suffix)) {\r\n        toRemove.push(key);\r\n      }\r\n    }\r\n\r\n    toRemove.forEach(k => {\r\n      try { localStorage.removeItem(k); } catch {}\r\n    });\r\n\r\n    // Remove the flag so it only executes once\r\n    try { localStorage.removeItem('ccc:pendingSlotWipe'); } catch {}\r\n  } catch {\r\n    try { localStorage.removeItem('ccc:pendingSlotWipe'); } catch {}\r\n  }\r\n}\r\n\r\nfunction disableMobileZoomGestures() {\r\n  if (!IS_MOBILE) return;\r\n\r\n  let lastTouchEnd = 0;\r\n  const TOUCH_DELAY_MS = 350;\r\n\r\n  document.addEventListener('touchend', (event) => {\r\n    const now = performance.now();\r\n    if (now - lastTouchEnd <= TOUCH_DELAY_MS) {\r\n      event.preventDefault();\r\n    }\r\n    lastTouchEnd = now;\r\n  }, { passive: false });\r\n\r\n  document.addEventListener('gesturestart', (event) => {\r\n    event.preventDefault();\r\n  }, { passive: false });\r\n\r\n  document.addEventListener('dblclick', (event) => {\r\n    event.preventDefault();\r\n  }, { passive: false });\r\n}\r\n\r\ndisableMobileZoomGestures();\r\n\r\nexport const AREAS = {\r\n  MENU: 0,\r\n  STARTER_COVE: 1,\r\n};\r\n\r\nlet currentArea = AREAS.MENU;\r\nlet spawner = null;\r\nlet cleanupUpgradesListener = null;\r\n\r\n/* ---------------------------\r\n   LOADER UI (immediate black + progress)\r\n----------------------------*/\r\nconst nextFrame = () => new Promise(r => requestAnimationFrame(r));\r\nconst twoFrames = async () => { await nextFrame(); await nextFrame(); };\r\nfunction showLoader(text = 'Loading assets...', onSkip) {\r\n  let root = document.getElementById('boot-loader');\r\n  if (!root) {\r\n    root = document.createElement('div');\r\n    root.id = 'boot-loader';\r\n    root.className = 'loading-screen';\r\n    document.body.appendChild(root);\r\n  }\r\n\r\n  root.innerHTML = '';\r\n  Object.assign(root.style, {\r\n    position: 'fixed',\r\n    inset: '0',\r\n    background: '#000',\r\n    color: '#fff',\r\n    display: 'grid',\r\n    placeItems: 'center',\r\n    zIndex: '2147483647',\r\n    opacity: '1', \r\n    transition: 'opacity 0.4s ease',\r\n  });\r\n\r\n  const wrap = document.createElement('div');\r\n  wrap.style.textAlign = 'center';\r\n  wrap.style.fontFamily = 'system-ui, -apple-system, Segoe UI, Roboto, sans-serif';\r\n\r\n  const label = document.createElement('div');\r\n  label.textContent = text;\r\n  Object.assign(label.style, {\r\n    fontSize: 'clamp(16px, 2.4vw, 22px)',\r\n    letterSpacing: '.04em',\r\n    opacity: '.92',\r\n  });\r\n\r\n  const bar = document.createElement('div');\r\n  Object.assign(bar.style, {\r\n    width: 'min(420px, 70vw)',\r\n    height: '10px',\r\n    background: 'rgba(255,255,255,.15)',\r\n    borderRadius: '999px',\r\n    margin: '12px auto 6px',\r\n    overflow: 'hidden',\r\n  });\r\n\r\n  const fill = document.createElement('div');\r\n  Object.assign(fill.style, {\r\n    width: '0%',\r\n    height: '100%',\r\n    background: '#fff',\r\n    transform: 'translateZ(0)',\r\n    transition: 'width .15s linear',\r\n  });\r\n\r\n  const pct = document.createElement('div');\r\n  pct.textContent = '0%';\r\n  Object.assign(pct.style, { fontSize: '12px', opacity: '.85' });\r\n\r\n  bar.appendChild(fill);\r\n  wrap.append(label, bar, pct);\r\n  root.appendChild(wrap);\r\n\r\n  const stuckMsg = document.createElement('div');\r\n  stuckMsg.textContent = 'If progress bar is stuck, try reloading the page.';\r\n  Object.assign(stuckMsg.style, {\r\n    marginTop: '16px',\r\n    fontSize: '14px',\r\n    opacity: '0',\r\n    transition: 'opacity 0.5s ease',\r\n    color: 'rgba(255,255,255,0.65)',\r\n  });\r\n  wrap.appendChild(stuckMsg);\r\n\r\n  const stuckTimeout = setTimeout(() => {\r\n    if (!root.__done) stuckMsg.style.opacity = '1';\r\n  }, 25000);\r\n\r\n  if (typeof onSkip === 'function') {\r\n    const skipBtn = document.createElement('div');\r\n    skipBtn.textContent = IS_MOBILE\r\n      ? 'Tap here to skip loading now and load assets during gameplay'\r\n      : 'Click here to skip loading now and load assets during gameplay';\r\n    Object.assign(skipBtn.style, {\r\n      marginTop: '24px',\r\n      fontSize: '14px',\r\n      color: '#888',\r\n      textDecoration: 'underline',\r\n      cursor: 'pointer',\r\n      opacity: '0.9',\r\n    });\r\n    skipBtn.addEventListener('click', (e) => {\r\n      e.preventDefault();\r\n      e.stopPropagation();\r\n      if (root.__skipped) return;\r\n      root.__skipped = true;\r\n      if (root.__pct) root.__pct.textContent = 'Loading skipped';\r\n      if (root.__label) root.__label.textContent = 'Loading skipped';\r\n      skipBtn.textContent = 'Loading skipped';\r\n      skipBtn.style.textDecoration = 'none';\r\n      skipBtn.style.cursor = 'default';\r\n      onSkip();\r\n    });\r\n    wrap.appendChild(skipBtn);\r\n  }\r\n\r\n  root.__mountedAt = performance.now();\r\n  root.__done = false;\r\n  root.__wrap = wrap;\r\n  root.__bar = bar;\r\n  root.__fill = fill;\r\n  root.__pct = pct;\r\n  root.__label = label;\r\n  root.__stuckMsg = stuckMsg;\r\n  root.__stuckTimeout = stuckTimeout;\r\n  return root;\r\n}\r\n\r\nfunction setLoaderProgress(loaderEl, fraction) {\r\n  if (!loaderEl || !loaderEl.__fill || !loaderEl.__pct) return;\r\n  if (loaderEl.__skipped) return;\r\n  const f = Math.max(0, Math.min(1, fraction || 0));\r\n  const pct = Math.round(f * 100);\r\n  loaderEl.__fill.style.width = pct + '%';\r\n  loaderEl.__pct.textContent = pct + '%';\r\n}\r\n\r\nfunction finishAndHideLoader(loaderEl) {\r\n  if (!loaderEl || loaderEl.__done) return;\r\n  loaderEl.__done = true;\r\n\r\n  const MIN_FINISHED_DWELL_MS = 500;\r\n  if (loaderEl.__label) {\r\n    loaderEl.__label.textContent = loaderEl.__skipped\r\n      ? 'Loading Skipped'\r\n      : 'Finished loading assets';\r\n  }\r\n  loaderEl.offsetHeight;\r\n\r\n  setTimeout(() => {\r\n    loaderEl.style.opacity = '0';\r\n    const onEnd = () => {\r\n      loaderEl.remove();\r\n      document.documentElement.classList.remove('booting');\r\n    };\r\n    loaderEl.addEventListener('transitionend', onEnd, { once: true });\r\n    setTimeout(onEnd, 450);\r\n  }, MIN_FINISHED_DWELL_MS);\r\n}\r\n\r\n/* ---------------------------\r\n   PRELOADERS\r\n----------------------------*/\r\nasync function warmImage(url) {\r\n  const img = new Image();\r\n  img.src = url;\r\n\r\n  try {\r\n    if (img.decode) await img.decode();\r\n  } catch (_) {\r\n  }\r\n\r\n  await new Promise((resolve) => {\r\n    const ghost = document.createElement('img');\r\n    ghost.src = url;\r\n    ghost.alt = '';\r\n    ghost.style.cssText =\r\n      'position:fixed;left:-9999px;top:-9999px;width:1px;height:1px;opacity:0;pointer-events:none;';\r\n    document.body.appendChild(ghost);\r\n    requestAnimationFrame(() => { ghost.remove(); resolve(); });\r\n  });\r\n}\r\n\r\nfunction preloadImages(sources, onEach) {\r\n  return sources.map(src => new Promise(resolve => {\r\n    const img = new Image();\r\n    const done = () => { try { onEach?.(src); } catch {} resolve(src); };\r\n    img.onload = done;\r\n    img.onerror = done;\r\n    img.src = src;\r\n  }));\r\n}\r\n\r\nfunction preloadAudio(sources, onEach) {\r\n  return sources.map(url => new Promise(resolve => {\r\n    const a = new Audio();\r\n    const done = () => { try { onEach?.(url); } catch {} resolve(url); };\r\n    a.addEventListener('canplaythrough', () => {\r\n      if (typeof registerPreloadedAudio === 'function') {\r\n        registerPreloadedAudio(url, a);\r\n      } else {\r\n        pendingPreloadedAudio.push({ url, audio: a });\r\n      }\r\n      done();\r\n    }, { once: true });\r\n    a.addEventListener('error', done, { once: true });\r\n    a.preload = 'auto';\r\n    a.src = url;\r\n    a.load?.();\r\n  }));\r\n}\r\n\r\nfunction preloadFonts(onEach) {\r\n  if (document.fonts && document.fonts.ready) {\r\n    return [document.fonts.ready.then(() => { try { onEach?.('fonts'); } catch {} })];\r\n  }\r\n  return [Promise.resolve().then(() => { try { onEach?.('fonts'); } catch {} })];\r\n}\r\n\r\nasync function preloadAssetsWithProgress({ images = [], audio = [], fonts = true }, onProgress) {\r\n  const total = images.length + audio.length + (fonts ? 1 : 0);\r\n  if (total === 0) { onProgress?.(1); return; }\r\n  let done = 0;\r\n  const bump = () => { done++; onProgress?.(done / total); };\r\n\r\n  const tasks = [\r\n    ...preloadImages(images, bump),\r\n    ...preloadAudio(audio, bump),\r\n    ...(fonts ? preloadFonts(bump) : []),\r\n  ];\r\n\r\n  await Promise.all(tasks.map(p => p.catch(() => null)));\r\n}\r\n\r\n/* ---------------------------\r\n   GAME AREA CONTROL\r\n----------------------------*/\r\nfunction enterArea(areaID) {\r\n  if (currentArea === areaID) return;\r\n  currentArea = areaID;\r\n\r\n  const menuRoot = document.querySelector('.menu-root');\r\n  switch (areaID) {\r\n    case AREAS.STARTER_COVE: {\r\n      if (menuRoot) {\r\n        menuRoot.style.display = 'none';\r\n      }\r\n      document.body.classList.remove('menu-bg');\r\n      const gameRoot = document.getElementById('game-root');\r\n      if (gameRoot) {\r\n        gameRoot.hidden = false;\r\n        initHudButtons();\r\n      }\r\n\r\n      if (typeof initResetSystemGame === 'function') {\r\n        try { initResetSystemGame(); } catch {}\r\n      }\r\n\r\n      if (typeof initMutationSystem === 'function') {\r\n        try { initMutationSystem(); } catch {}\r\n      }\r\n\r\n      if (!spawner) {\r\n        spawner = createSpawner({\r\n          coinSrc: 'img/currencies/coin/coin.webp',\r\n          coinSize: 40,\r\n          initialRate: 1,\r\n          surgeLifetimeMs: 1800,\r\n          surgeWidthVw: 22,\r\n        });\r\n        window.spawner = spawner;\r\n        const applyMutationSprite = () => {\r\n          if (!spawner || typeof spawner.setCoinSprite !== 'function') return;\r\n          try { spawner.setCoinSprite(getMutationCoinSprite?.()); } catch {}\r\n        };\r\n        applyMutationSprite();\r\n        onMutationChangeGame?.(applyMutationSprite);\r\n        initCoinPickup({ spawner });\r\n                const applyUpgradesToSpawner = () => {\r\n                try {\r\n                        const areaKey = getUpgAreaKey();\r\n                        const eff = computeUpgradeEffects(areaKey);\r\n                        if (spawner && eff?.coinsPerSecondMult) {\r\n                          let rate = 1 * eff.coinsPerSecondMult;\r\n                          if (typeof applyStatMultiplierOverride === \"function\") {\r\n                             const override = applyStatMultiplierOverride(\"spawnRate\", rate);\r\n                             try {\r\n                                 if (override && typeof override.toScientific === \"function\") {\r\n                                     rate = Number(override.toScientific(6));\r\n                                 } else {\r\n                                     rate = Number(override);\r\n                                 }\r\n                             } catch {}\r\n                          }\r\n                          if (Number.isFinite(rate)) {\r\n                              spawner.setRate(rate);\r\n                          }\r\n                        }\r\n                  } catch {}\r\n                };\r\n                applyUpgradesToSpawner();\r\n                if (typeof cleanupUpgradesListener === 'function') {\r\n                    try { cleanupUpgradesListener(); } catch {}\r\n                }\r\n                cleanupUpgradesListener = onUpgradesChanged(applyUpgradesToSpawner);\r\n                if (typeof window !== 'undefined') {\r\n                   window.addEventListener('debug:change', applyUpgradesToSpawner);\r\n                }\r\n\r\n      }\r\n      if (typeof initXpSystem === 'function') {\r\n        try { initXpSystem(); } catch {}\r\n      }\r\n      spawner.start();\r\n      if (spawner && typeof spawner.playEntranceWave === 'function') {\r\n        spawner.playEntranceWave();\r\n      }\r\n      break;\r\n    }\r\n\r\n    case AREAS.MENU: {\r\n      if (menuRoot) {\r\n        menuRoot.style.display = '';\r\n        menuRoot.removeAttribute('aria-hidden');\r\n      }\r\n      const gameRoot = document.getElementById('game-root');\r\n      if (gameRoot) gameRoot.hidden = true;\r\n\r\n      if (spawner) spawner.stop();\r\n      break;\r\n    }\r\n  }\r\n\r\n  try {\r\n    window.dispatchEvent(new CustomEvent('menu:visibilitychange', {\r\n      detail: { visible: areaID === AREAS.MENU },\r\n    }));\r\n  } catch {}\r\n}\r\n\r\n/* ---------------------------\r\n   BOOT FLOW\r\n----------------------------*/\r\ndocument.addEventListener('DOMContentLoaded', async () => {\r\n  let resolveSkip;\r\n  const skipPromise = new Promise(resolve => { resolveSkip = resolve; });\r\n\r\n  const loader = showLoader('Loading assets...', resolveSkip);\r\n\r\n  await nextFrame();\r\n\r\n  const modulePromise = Promise.all([\r\n    import('./util/slots.js'),\r\n    import('./game/spawner.js'),\r\n    import('./game/coinPickup.js'),\r\n    import('./ui/hudButtons.js'),\r\n    import('./util/storage.js'),\r\n    import('./util/saveIntegrity.js'),\r\n    import('./game/upgrades.js'),\r\n    import('./util/audioCache.js'),\r\n    import('./game/xpSystem.js'),\r\n    import('./ui/merchantTabs/resetTab.js'),\r\n    import('./game/mutationSystem.js'),\r\n    import('./ui/popups.js'),\r\n    import('./util/suspendSafeguard.js'),\r\n    import('./util/ghostTapGuard.js'),\r\n    import('./util/globalOverlayEsc.js'),\r\n    import('./util/debugPanel.js'),\r\n    import('./game/gameLoop.js'),\r\n    import('./game/offlinePanel.js'),\r\n    import('./ui/merchantTabs/workshopTab.js'),\r\n    import('./game/automationEffects.js'),\r\n  ]);\r\n\r\n  const ASSET_MANIFEST = {\r\nimages: [\r\n  // ==== img/currencies/book ====\r\n  'img/currencies/book/book.webp',\r\n  'img/currencies/book/book_base.webp',\r\n  'img/currencies/book/book_plus_base.webp',\r\n\r\n  // ==== img/currencies/coin ====\r\n  'img/currencies/coin/coin.webp',\r\n  'img/currencies/coin/coin_base.webp',\r\n  'img/currencies/coin/coin_plus_base.webp',\r\n\r\n  // ==== img/currencies/gear ====\r\n  'img/currencies/gear/gear.webp',\r\n  'img/currencies/gear/gear_base.webp',\r\n  'img/currencies/gear/gear_plus_base.webp',\r\n\r\n  // ==== img/currencies/gold ====\r\n  'img/currencies/gold/gold.webp',\r\n  'img/currencies/gold/gold_base.webp',\r\n  'img/currencies/gold/gold_plus_base.webp',\r\n\r\n  // ==== img/currencies/magic ====\r\n  'img/currencies/magic/magic.webp',\r\n  'img/currencies/magic/magic_base.webp',\r\n  'img/currencies/magic/magic_plus_base.webp',\r\n  \r\n  // ==== img/currencies/wave ====\r\n  'img/currencies/wave/wave.webp',\r\n  'img/currencies/wave/wave_base.webp',\r\n  'img/currencies/wave/wave_plus_base.webp',\r\n\r\n  // ==== img/misc ====\r\n  'img/misc/forge.webp',\r\n  'img/misc/forge_plus_base.webp',\r\n  'img/misc/infuse.webp',\r\n  'img/misc/infuse_plus_base.webp',\r\n  'img/misc/infuse_base.webp',\r\n  'img/misc/surge.webp',\r\n  'img/misc/surge_plus_base.webp',\r\n  'img/misc/green_border.webp',\r\n  'img/misc/locked.webp',\r\n  'img/misc/locked_base.webp',\r\n  'img/misc/maxed.webp',\r\n  'img/misc/merchant.webp',\r\n  'img/misc/mysterious.webp',\r\n\r\n  // ==== img/mutations ====\r\n  ...Array.from({ length: 25 }, (_, i) => `img/mutations/m${i + 1}.webp`),\r\n\r\n  // ==== img/sc_upg_icons ====\r\n  'img/sc_upg_icons/book_val1.webp',\r\n  'img/sc_upg_icons/coin_val1.webp',\r\n  'img/sc_upg_icons/coin_val2.webp',\r\n  'img/sc_upg_icons/coin_val3.webp',\r\n  'img/sc_upg_icons/faster_coins1.webp',\r\n  'img/sc_upg_icons/faster_coins2.webp',\r\n  'img/sc_upg_icons/faster_coins3.webp',\r\n  'img/sc_upg_icons/magnet.webp',\r\n  'img/sc_upg_icons/mp_val1.webp',\r\n  'img/sc_upg_icons/mp_val2.webp',\r\n  'img/sc_upg_icons/xp_val1.webp',\r\n  'img/sc_upg_icons/xp_val2.webp',\r\n  'img/sc_upg_icons/xp_val3.webp',\r\n  'img/sc_upg_icons/xp_val_hm.webp',\r\n  'img/sc_upg_icons/mp_val_hm.webp',\r\n  'img/sc_upg_icons/effective_auto_collect.webp',\r\n  'img/sc_upg_icons/coin_autobuy.webp',\r\n  'img/sc_upg_icons/book_autobuy.webp',\r\n  'img/sc_upg_icons/gold_autobuy.webp',\r\n  'img/sc_upg_icons/magic_autobuy.webp',\r\n  'img/sc_upg_icons/workshop_level_autobuy.webp',\r\n  \r\n  \r\n  // ==== img/stats/mp ====\r\n  'img/stats/mp/mp.webp',\r\n  'img/stats/mp/mp_base.webp',\r\n  'img/stats/mp/mp_plus_base.webp',\r\n\r\n  // ==== img/stats/xp ====\r\n  'img/stats/xp/xp.webp',\r\n  'img/stats/xp/xp_base.webp',\r\n  'img/stats/xp/xp_plus_base.webp',\r\n],\r\n    audio: [\r\n      'sounds/coin_pickup.ogg',\r\n      'sounds/wave_spawn.ogg',\r\n      'sounds/merchant_typing.ogg',\r\n      'sounds/purchase_upg.ogg',\r\n\t  'sounds/forge_reset.ogg',\r\n\t  'sounds/infuse_reset.ogg',\r\n\t  'sounds/surge_reset.ogg',\r\n\t  'sounds/evolve_upg.ogg',\r\n    ],\r\n    fonts: true,\r\n  };\r\n\r\n  let progress = 0;\r\n  const assetsPromise = preloadAssetsWithProgress(ASSET_MANIFEST, f => {\r\n    progress = f;\r\n    setLoaderProgress(loader, f);\r\n  });\r\n\r\n  const [\r\n    slotsModule,\r\n    spawnerModule,\r\n    coinPickupModule,\r\n    hudButtonsModule,\r\n    storageModule,\r\n    saveIntegrityModule,\r\n    upgradesModule,\r\n    audioCacheModule,\r\n    xpModule,\r\n    resetModule,\r\n    mutationModule,\r\n    popupModule,\r\n    safetyModule,\r\n    guardModule,\r\n    escModule,\r\n    debugPanelModule,\r\n    gameLoopModule,\r\n    offlinePanelModule,\r\n    workshopTabModule,\r\n    automationEffectsModule,\r\n  ] = await modulePromise;\r\n\r\n  ({ initSlots } = slotsModule);\r\n  ({ createSpawner } = spawnerModule);\r\n  ({ initCoinPickup } = coinPickupModule);\r\n  ({ initHudButtons } = hudButtonsModule);\r\n  ({ bank, getHasOpenedSaveSlot, setHasOpenedSaveSlot, ensureStorageDefaults, notifyGameSessionStarted } = storageModule);\r\n  void saveIntegrityModule;\r\n  ({ getCurrentAreaKey: getUpgAreaKey, computeUpgradeEffects, onUpgradesChanged } = upgradesModule);\r\n  ({ registerPreloadedAudio } = audioCacheModule);\r\n  ({ initXpSystem } = xpModule);\r\n  ({ initResetSystem: initResetSystemGame } = resetModule);\r\n  ({ initMutationSystem, getMutationCoinSprite, onMutationChange: onMutationChangeGame } = mutationModule);\r\n  ({ initPopups } = popupModule);\r\n  ({ installSuspendSafeguards, restoreFromBackupIfNeeded: restoreSuspendBackup, markProgressDirty, flushBackupSnapshot } = safetyModule);\r\n  ({ installGhostTapGuard, initGlobalGhostTap } = guardModule);\r\n  ({ initGlobalOverlayEsc } = escModule);\r\n  ({ setDebugPanelAccess, applyStatMultiplierOverride } = debugPanelModule);\r\n  ({ startGameLoop } = gameLoopModule);\r\n  const { initOfflineTracker, processOfflineProgress } = offlinePanelModule;\r\n  const { initWorkshopSystem } = workshopTabModule;\r\n  const { initAutomationEffects } = automationEffectsModule;\r\n\r\n  window.bank = bank;\r\n\r\n  if (typeof registerPreloadedAudio === 'function' && pendingPreloadedAudio.length) {\r\n    while (pendingPreloadedAudio.length) {\r\n      const entry = pendingPreloadedAudio.shift();\r\n      if (!entry) continue;\r\n      try { registerPreloadedAudio(entry.url, entry.audio); }\r\n      catch {}\r\n    }\r\n  }\r\n\r\n  installGhostTapGuard?.();\r\n  initGlobalGhostTap?.();\r\n  initGlobalOverlayEsc?.();\r\n  installSuspendSafeguards?.();\r\n  if (typeof setDebugPanelAccess === 'function') {\r\n    setDebugPanelAccess(DEBUG_PANEL_ACCESS);\r\n    window.setDebugPanelAccess = setDebugPanelAccess;\r\n  }\r\n\r\n  try {\r\n    await restoreSuspendBackup?.();\r\n  } catch {}\r\n\r\n  await Promise.race([assetsPromise, skipPromise]);\r\n\r\n  await twoFrames();\r\n  document.documentElement.classList.remove('booting');\r\n\r\n  await nextFrame();\r\n\r\n  finishAndHideLoader(loader);\r\n\r\n  await Promise.all([ // fixes some image preload issue on mobile\r\n    warmImage('img/currencies/coin/coin_plus_base.webp'),\r\n    warmImage('img/stats/xp/xp_plus_base.webp'),\r\n\twarmImage('img/stats/mp/mp_plus_base.webp'),\r\n  ]);\r\n  \r\n  // Ensure we start with no active slot so game loops don't run for a lingering slot ID\r\n  try {\r\n    if (typeof storageModule.clearActiveSlot === 'function') {\r\n      storageModule.clearActiveSlot();\r\n    } else if (storageModule && storageModule.KEYS && storageModule.KEYS.SAVE_SLOT) {\r\n      localStorage.removeItem(storageModule.KEYS.SAVE_SLOT);\r\n    }\r\n  } catch {}\r\n\r\n  startGameLoop();\r\n  initOfflineTracker(() => currentArea === AREAS.STARTER_COVE, () => { if (window.spawner) window.spawner.clearBacklog(); });\r\n\r\n  try { initWorkshopSystem(); } catch(e) { console.error('Workshop init failed', e); }\r\n  try { initAutomationEffects(); } catch(e) { console.error('Automation init failed', e); }\r\n  \r\n  applyPendingSlotWipe();\r\n  ensureStorageDefaults();\r\n  markProgressDirty?.('ensure-defaults');\r\n  initPopups();\r\n\r\n  const titleEl = document.getElementById('panel-title');\r\n  if (getHasOpenedSaveSlot()) {\r\n    document.body.classList.add('has-opened');\r\n    if (titleEl) titleEl.style.opacity = '0';\r\n  } else {\r\n    if (titleEl) titleEl.style.opacity = '1';\r\n  }\r\n\r\n  initSlots(() => {\r\n    setHasOpenedSaveSlot(true);\r\n    document.body.classList.add('has-opened');\r\n    if (titleEl) titleEl.style.opacity = '0';\r\n    enterArea(AREAS.STARTER_COVE);\r\n    processOfflineProgress();\r\n    notifyGameSessionStarted?.();\r\n    markProgressDirty?.('slot-entered');\r\n  });\r\n\r\n  if (typeof window !== 'undefined' && flushBackupSnapshot) {\r\n    try {\r\n      window.cccRequestBackup = () => flushBackupSnapshot('manual', { immediate: true });\r\n    } catch {}\r\n  }\r\n});\r\n", "import './js/main.js';\r\n"],
  "mappings": "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AC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,KAAK,EAAE,CAAC,IAAI,KAAK,EAAE,CAAC,IAAI,KAAK,EAAE,CAAC,IAAI,IAAI,EAC3H,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,KAAK,EAAE,CAAC,IAAI,KAAK,EAAE,CAAC,IAAI,KAAK,EAAE,CAAC,IAAI,IAAI,EAC3H,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,KAAK,EAAE,CAAC,IAAI,KAAK,EAAE,CAAC,IAAI,KAAK,EAAE,CAAC,IAAI,IAAI,EAC3H,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,KAAK,EAAE,CAAC,GAAG,KAAK,EAAE,CAAC,GAAG,KAAK,EAAE,CAAC,GAAG,IAAI,EACxH,CAAC,GAAG,MAAM,EAAE,CAAC,GAAG,MAAM,EAAE,CAAC,GAAG,MAAM,EAAE,CAAC,GAAG,MAAM,EAAE,CAAC,GAAG,MAAM,EAAE,CAAC,GAAG,MAAM,EAAE,CAAC,GAAG,KAAK,EAAE,CAAC,GAAG,KAAK,EAAE,CAAC,GAAG,KAAK,EAAE,CAAC,GAAG,IAAI,EACjH,CAAC,GAAG,MAAM,EAAE,CAAC,GAAG,MAAM,EAAE,CAAC,GAAG,MAAM,EAAE,CAAC,GAAG,MAAM,EAAE,CAAC,GAAG,MAAM,EAAE,CAAC,GAAG,MAAM,EAAE,CAAC,GAAG,KAAK,EAAE,CAAC,GAAG,KAAK,EAAE,CAAC,GAAG,KAAK,EAAE,CAAC,GAAG,IAAI,EACjH,CAAC,GAAG,IAAI,EAAE,CAAC,GAAG,IAAI,EAAE,CAAC,GAAG,IAAI,EAAE,CAAC,GAAG,IAAI,E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",
  "names": ["BigNum", "init_bigNum", "__esmMin", "_BigNum", "sig", "e", "p", "base", "off", "ee", "#normalize", "n", "str", "s", "match", "intPart", "fracPart", "expPart", "exponent", "digits", "pStr", "sigStr", "eStr", "pp", "baseStr", "offset", "caret", "offStr", "eNum", "input", "trimmed", "offsetSuffix", "b", "expCmp", "#compareExponent", "aligned", "#alignSig", "diffSig", "#expObj", "aPlain", "bPlain", "diff", "#pow10", "k", "#adjustExponent", "delta", "prev", "next", "applied", "leftover", "#totalExponentBigInt", "other", "a", "#expDiff", "absDiff", "limit", "#offsetAsNumber", "offNum", "#effectiveExponentNumber", "shift", "q", "diffNum", "out", "r", "baseSum", "offsetSum", "scale", "sigQuotient", "expDiffBase", "expDiffOffset", "pBigInt", "totalExpBase", "resultBase", "resultOffset", "thisIsZero", "otherIsZero", "x", "maxScale", "fracRaw", "frac", "mult", "numer", "exp", "intDigits", "drop", "newSig", "numerBigInt", "nb", "head", "tail", "mant", "E", "extraZeros", "localeInt", "s", "num", "NF_INT", "addOneDigitString", "str", "carry", "a", "i", "d", "formatExponentString", "rawDigits", "sign", "ds", "n", "E", "exp", "suffix", "SUFFIX_BY_EXP", "intDigits", "decimals", "totalDigits", "head", "intStr", "fracStr", "mantInt", "mantFrac", "formatExponentChain", "expRaw", "topSign", "m", "int", "frac", "sign2", "kDigits", "kGe303", "k", "four", "mant", "sign2Prefix", "mantissaFourDigits", "sci", "mantissa", "rawExp", "formatNumber", "bn", "BigNum", "SUFFIX_ENTRIES", "init_numFormat", "__esmMin", "init_bigNum", "storage_exports", "__export", "CURRENCIES", "KEYS", "STORAGE_PREFIX", "bank", "clearActiveSlot", "clearAllStorage", "ensureCurrencyDefaults", "ensureMultiplierDefaults", "ensureStorageDefaults", "getActiveSlot", "getCurrency", "getCurrencyMultiplierBN", "getHasOpenedSaveSlot", "getLastSaveTime", "getLastSaveTimeKey", "getSlotModifiedFlagKey", "getSlotSignature", "getSlotSignatureKey", "hasModifiedSave", "isCurrencyLocked", "isStorageKeyLocked", "markSaveSlotModified", "notifyGameSessionStarted", "onCurrencyChange", "peekCurrency", "primeStorageWatcherSnapshot", "setActiveSlot", "setCurrency", "setCurrencyMultiplierBN", "setHasOpenedSaveSlot", "setSlotSignature", "updateLastSaveTime", "watchStorageKey", "normalizeSlotValue", "slot", "n", "slotSignatureKey", "normalized", "SLOT_SIGNATURE_PREFIX", "slotModifiedKey", "SLOT_MODIFIED_PREFIX", "notifyCurrencySubscribers", "detail", "currencyChangeSubscribers", "entry", "handler", "key", "ensureStorageWatcherTimer", "storageWatcherTimer", "storageWatchers", "runStorageWatchers", "STORAGE_WATCH_INTERVAL_MS", "stopStorageWatcherTimerIfIdle", "parseWith", "raw", "valuesEqual", "a", "b", "entries", "parsed", "rawChanged", "valueChanged", "previousValue", "previousRaw", "parse", "equals", "onChange", "emitCurrentValue", "set", "rawValue", "bigNumEquals", "BigNum", "parseBigNumOrZero", "cleanupCurrencyWatchers", "currencyWatcherCleanup", "stop", "bindCurrencyWatchersForSlot", "currencyWatcherBoundSlot", "currencyKey", "storageKey", "value", "meta", "initCurrencyStorageWatchers", "hasEnteredGameSession", "PREFIX", "now", "val", "initHeartbeat", "lastSaveTimeTimer", "_activeSlotCache", "v", "keyFor", "base", "isDebugLocked", "signature", "k", "km", "getMultiplierScaled", "theor", "scaledFromIntBN", "setMultiplierScaled", "delta", "previous", "prev", "zero", "deltaBn", "bn", "expectedRaw", "persistedRaw", "effectiveRaw", "effective", "changed", "providedDelta", "source", "bnDelta", "intBN", "MULT_SCALE", "intFromScaled", "theorBN", "MULT_SCALE_TAG", "payload", "theoreticalBN", "existingRaw", "intBNValue", "sub", "makeCurrencyHandle", "fn", "x", "formatNumber", "amt", "next", "current", "factor", "pct", "amount", "mult", "baseAmount", "inc", "init_storage", "__esmMin", "init_bigNum", "init_numFormat", "_", "prop", "isDeleteMode", "deleteMode", "setDeleteMode", "on", "btn", "card", "removeAllKeysForSlot", "slot", "re", "toRemove", "i", "k", "initSlotsManager", "initialized", "manageBtn", "grid", "e", "onPointerDownCapture", "onClickCapture", "getActiveSlot", "KEYS", "refreshSlotsView", "init_slotsManager", "__esmMin", "init_storage", "init_slots", "slots_exports", "__export", "initSlots", "refreshSlotsView", "hasSlotData", "slot", "coinsTextFor", "bn", "peekCurrency", "formatNumber", "renderSlotCards", "btn", "idx", "titleEl", "text", "onSelect", "cards", "slotNum", "activate", "ev", "setActiveSlot", "ensureCurrencyDefaults", "ensureMultiplierDefaults", "setHasOpenedSaveSlot", "isDeleteMode", "init_slots", "__esmMin", "init_bigNum", "init_numFormat", "init_slotsManager", "init_storage", "audioCache_exports", "__export", "registerPreloadedAudio", "takePreloadedAudio", "src", "element", "key", "normalize", "cache", "el", "init_audioCache", "__esmMin", "syncXpMpHudLayout", "hud", "xpEl", "mpEl", "xpVisible", "mpVisible", "init_hudLayout", "__esmMin", "xpSystem_exports", "__export", "addExternalCoinMultiplierProvider", "addExternalXpGainMultiplierProvider", "addXp", "broadcastXpChange", "computeCoinMultiplierForXpLevel", "getXpGainMultiplier", "getXpLevelStorageKey", "getXpRequirementForXpLevel", "getXpState", "initXpSystem", "isXpSystemUnlocked", "onXpChange", "refreshCoinMultiplierFromXpLevel", "resetXpProgress", "setExternalBookRewardProvider", "setExternalCoinMultiplierProvider", "setExternalXpGainMultiplierProvider", "unlockXpSystem", "slot", "getActiveSlot", "resolvedSlot", "KEY_XP_LEVEL", "bigIntToFloatApprox", "value", "str", "len", "headDigits", "head", "exponent", "scaled", "bigNumIsInfinite", "bn", "bigNumIsZero", "bigNumToFiniteNumber", "sci", "match", "mant", "exp", "num", "logBigNumToNumber", "maxLog10Bn", "computeBonusCountBn", "levelBn", "BigNum", "divided", "TEN_DIVISOR_DECIMAL", "floored", "bnOne", "computeLevelLogTerm", "LOG_STEP_DECIMAL", "bigNumPowerOf10", "logBn", "infinityRequirementBn", "integerPart", "fractionalPart", "fractionalNumber", "mantissa", "precision", "scaleFactor", "exponentAdjustment", "sig", "integerPartString", "totalExponent", "eBigInt", "e", "offset", "approximateCoinMultiplierFromBigNum", "totalLog", "approx", "levelTerm", "combined", "enforceXpInfinityInvariant", "levelIsInf", "xpState", "progIsInf", "inf", "requirementBn", "bank", "notifyXpSubscribers", "detail", "xpChangeSubscribers", "entry", "handler", "bnZero", "cloneBigNumSafe", "bigNumEqualsSafe", "a", "b", "cleanupXpStorageWatchers", "xpStorageWatcherCleanups", "stop", "parseBigNumOrZero", "raw", "handleExternalXpStorageChange", "reason", "handlingExternalXpStorage", "xpStorageWatcherSlot", "prev", "ensureStateLoaded", "updateHud", "syncCoinMultiplierWithXpLevel", "current", "unlockedChanged", "levelChanged", "progressChanged", "xpLevelsGained", "xpAdded", "bindXpStorageWatchersForSlot", "watch", "key", "options", "watchStorageKey", "KEY_UNLOCK", "KEY_PROGRESS", "ensureXpStorageWatchers", "xpStorageWatchersInitialized", "stripHtml", "approxLog10", "expBase", "expOffset", "mantissaLog", "trimmed", "digits", "headSlice", "ensureExactRequirementCacheUpTo", "levelBigInt", "target", "EXACT_REQUIREMENT_CACHE_LEVEL", "highestCachedExactLevel", "currentLevel", "currentRequirement", "xpRequirementCache", "nextLevel", "nextRequirement", "bigNumFromLog10", "log10Value", "fractional", "exponentStr", "approximateRequirementFromLevel", "baseLevel", "baseRequirement", "baseLevelBn", "baseLog", "deltaLevel", "targetBonus", "baseBonus", "deltaBonus", "LOG_DECADE_BONUS_DECIMAL", "logNumber", "progressRatio", "progressBn", "requirement", "reqIsInf", "logProg", "logReq", "diff", "ratio", "ensureHudRefs", "hudRefs", "xpRequirementForXpLevel", "xpLevelInput", "xpLvlBn", "levelPlain", "targetLevelInfo", "targetLevel", "targetKey", "cachedExact", "approximate", "updateXpRequirement", "resetLockedXpState", "xpLevelBigIntInfo", "xpLevelValue", "plain", "force", "multApi", "levelInfo", "levelIsInfinite", "levelStorageKey", "lastSyncedCoinLevelWasInfinite", "lastSyncedCoinUsedApproximation", "lastSyncedCoinLevel", "lastSyncedCoinApproxKey", "multiplierBn", "EXACT_COIN_LEVEL_LIMIT", "working", "iterations", "i", "levelAdd", "finalMultiplier", "providers", "coinMultiplierProviders", "externalCoinMultiplierProvider", "provider", "maybe", "multIsInf", "lastSlot", "stateLoaded", "unlockedRaw", "persistState", "expected", "persisted", "unlocked", "level", "progress", "rawLevel", "rawProgress", "primeStorageWatcherSnapshot", "handleXpLevelUpRewards", "reward", "externalBookRewardProvider", "syncedLevelInfo", "container", "bar", "fill", "reqHtml", "formatNumber", "reqPlain", "syncXpMpHudLayout", "pct", "currentHtml", "currPlain", "forceReload", "keepUnlock", "wasUnlocked", "amount", "silent", "inc", "xpGainMultiplierProviders", "externalXpGainMultiplierProvider", "applyStatMultiplierOverride", "progressIsInf", "gainIsInf", "currentProgressLog", "COMBINED_LOG_FACTOR", "reqLog", "logDiff", "estimatedGain", "safeGain", "jumpBn", "bulkReward", "guard", "limit", "syncedLevelAfterAdd", "detailOverrides", "xpLevel", "mult", "levelValue", "xpLevelBn", "fn", "KEY_PREFIX", "LOG_STEP", "LOG_DECADE_BONUS", "init_xpSystem", "__esmMin", "init_bigNum", "init_storage", "init_debugPanel", "init_numFormat", "init_hudLayout", "ghostTapGuard_exports", "__export", "DEFAULT_TIMEOUT_MS", "clearGhostTapTarget", "consumeGhostTapGuard", "initGlobalGhostTap", "installGhostTapGuard", "markGhostTapTarget", "setGhostTapSelector", "shouldSkipGhostTap", "suppressNextGhostTap", "nowMs", "getDocument", "findTapTarget", "node", "ElementCtor", "selector", "el", "ELEMENT_SKIP_PROP", "timeout", "globalTimeout", "now", "delay", "lastMarkedTarget", "gDelay", "target", "until", "GLOBAL_SKIP_PROP", "targetDelay", "current", "onPointerStart", "event", "lastTouchMs", "lastTouchStartMs", "lastTouchDurationMs", "onTouchStart", "onPointerEnd", "onTouchEnd", "onClickCapture", "sinceTouchStart", "longPressMs", "options", "guardInstalled", "doc", "hasPointerEvents", "hasTouchEvents", "TARGET_SELECTOR", "handleInstantClick", "buttonLike", "extraSelector", "DEFAULT_LONG_PRESS_MS", "init_ghostTapGuard", "__esmMin", "MERCHANT_DIALOGUES", "init_merchantDialogues", "__esmMin", "gameLoop_exports", "__export", "RateAccumulator", "pauseGameLoop", "registerTick", "resumeGameLoop", "startGameLoop", "stopGameLoop", "loop", "now", "paused", "lastTime", "rafId", "dt", "accumulator", "tickListeners", "listener", "e", "callback", "init_gameLoop", "__esmMin", "currencyKey", "bankRef", "amountPerSecond", "perTick", "whole", "AUTOMATION_AREA_KEY", "EFFECTIVE_AUTO_COLLECT_ID", "AUTOBUY_COIN_UPGRADES_ID", "AUTOBUY_BOOK_UPGRADES_ID", "AUTOBUY_GOLD_UPGRADES_ID", "AUTOBUY_MAGIC_UPGRADES_ID", "AUTOBUY_WORKSHOP_LEVELS_ID", "MASTER_AUTOBUY_IDS", "UPGRADE_DEFINITIONS", "REGISTRY", "init_automationUpgrades", "__esmMin", "init_bigNum", "level", "lvl", "base", "pow", "BigNum", "u", "workshopTab_exports", "__export", "getGearsProductionRate", "getGenerationLevelKey", "getGenerationUpgradeCost", "initWorkshopSystem", "initWorkshopTab", "performFreeGenerationUpgrade", "updateWorkshopTab", "integralLogLin", "x", "k", "term", "INV_LN10", "slot", "loadGenerationLevel", "getActiveSlot", "BigNum", "raw", "saveGenerationLevel", "level", "key", "valStr", "readBack", "calculateWorkshopCostLog", "lvlNum", "str", "GENERATION_UPGRADE_BASE_COST_LOG", "L1", "BASE_MULT_LOG", "CACHE_S1_END_LOG", "u", "L2", "K_LIN", "CACHE_S2_END_LOG", "u2", "v", "u_at_L", "u_at_L2", "s2_continuation", "C3", "LOG_EXP_BASE_S3", "EXP_DIV_S3", "s3_extra", "L3", "CACHE_S3_END_LOG", "v3", "u3", "s2_cont_3", "s3_extra_3", "scalingExp", "EXPLOSION_RATE", "result", "bnLevel", "logCost", "bigNumFromLog10", "getGearsPerSecond", "baseRate", "logValue", "LOG10_2", "logVal", "logExpBn", "logExpVal", "mult", "bank", "buyGenerationUpgrade", "cost", "currentGenerationLevel", "nextLevel", "playPurchaseSfx", "onTick", "hasDoneInfuseReset", "whole", "perTickNum", "wholeNum", "frac", "accumulatorBuffer", "accWhole", "resetWorkshopState", "syncGearDecorations", "container", "entry", "animatedGears", "rect", "MAX_GEAR_DECORATIONS", "targetCount", "gears", "img", "GEAR_ICON_SRC", "size", "y", "angle", "dx", "GEAR_SPEED", "dy", "rotation", "rotationSpeed", "GEAR_ROTATION_SPEED_BASE", "GEAR_ROTATION_VARIANCE", "g", "buildWorkshopUI", "descText", "IS_MOBILE", "GEAR_HUD_ICON_SRC", "COIN_ICON_SRC", "leftCol", "rightCol", "automationBtn", "openShop", "syncLayout", "statsBtn", "workshopEl", "left", "right", "updateBounds", "col", "ro", "hud", "entries", "startRenderLoop", "stopRenderLoop", "gearsAmountEl", "gearsRateEl", "upgradeCostEl", "upgradeBtn", "rateBn", "formatNumber", "label", "canAfford", "autoLevel", "getLevelNumber", "AUTOMATION_AREA_KEY", "AUTOBUY_WORKSHOP_LEVELS_ID", "isAutomated", "slotSuffix", "currentIntStr", "lastSyncedLevel", "renderFrameId", "lastRenderTime", "loop", "timestamp", "dt", "data", "width", "height", "initialized", "registerTick", "CURRENCIES", "panelEl", "coinsInf", "costInf", "coinsLog", "approxLog10BigNum", "low", "high", "best", "mid", "targetLevelVal", "targetLevel", "LN10", "init_workshopTab", "__esmMin", "init_bigNum", "init_numFormat", "init_storage", "init_gameLoop", "init_shopOverlay", "init_resetTab", "init_upgrades", "init_main", "init_automationUpgrades", "hasMetMerchant", "sk", "MERCHANT_MET_KEY_BASE", "isJeffUnlocked", "JEFF_UNLOCK_KEY_BASE", "setJeffUnlocked", "value", "slot", "getActiveSlot", "key", "normalized", "updateMerchantNameInUI", "getMerchantName", "name", "merchantOverlayEl", "modalName", "bindRapidActivation", "target", "handler", "once", "used", "pointerTriggered", "activePointerId", "run", "event", "shouldSkipGhostTap", "e", "cleanup", "resetPointerTrigger", "onClick", "onPointerDown", "suppressNextGhostTap", "onPointerUp", "onPointerCancel", "onTouchStart", "onTouchEnd", "onTouchCancel", "HAS_POINTER_EVENTS", "HAS_TOUCH_EVENTS", "dialogueStatusRank", "status", "DIALOGUE_STATUS_ORDER", "snapshotLockDisplay", "info", "buildUnlockedDialogueInfo", "meta", "setMerchantTabUnlocked", "unlocked", "def", "MERCHANT_TABS_DEF", "t", "lockedLabel", "merchantTabUnlockState", "btn", "merchantTabs", "selectMerchantTab", "syncForgeTabUnlockState", "isForgeUnlocked", "syncWorkshopTabUnlockState", "hasDoneInfuseReset", "bigNumToSafeInteger", "plain", "parsed", "str", "numeric", "getPlayerProgress", "progress", "isXpSystemUnlocked", "state", "getXpState", "hasDoneForgeReset", "resolveDialogueLock", "rawState", "rawObj", "DEFAULT_MYSTERIOUS_BLURB", "DEFAULT_LOCKED_BLURB", "DEFAULT_LOCK_MESSAGE", "MYSTERIOUS_ICON_SRC", "HIDDEN_DIALOGUE_TITLE", "LOCKED_DIALOGUE_TITLE", "ensureProgressEvents", "progressEventsBound", "onProgressChanged", "detailSlot", "FORGE_COMPLETED_KEY_BASE", "watchStorageKey", "renderDialogueList", "completeDialogueOnce", "id", "loadDlgState", "k", "prev", "saveDlgState", "grantReward", "reward", "bank", "rewardLabel", "MERCHANT_DLG_STATE_KEY_BASE", "s", "payload", "primeStorageWatcherSnapshot", "parseDlgStateRaw", "raw", "cleanupMerchantDlgStateWatcher", "stop", "merchantDlgWatcherCleanup", "handleMerchantDlgStateChange", "_", "bindMerchantDlgStateWatcherForSlot", "merchantDlgWatcherSlot", "storageKey", "ensureMerchantDlgStateWatcher", "merchantDlgWatcherInitialized", "ensureAudioCtx", "__audioCtx", "Ctx", "__typingGain", "IS_MOBILE", "pickSupportedSrc", "TYPING_SFX_SOURCE", "loadTypingBuffer", "__typingBuffer", "__bufferLoadPromise", "url", "arr", "buf", "err", "ensureTypingAudioElement", "__typingSfx", "a", "ensureElementGraph", "__typingSource", "setTypingGainForDevice", "primeTypingSfx", "__typingSfxPrimed", "prevLoop", "prevMuted", "startTypingSfx", "__isTypingActive", "__bufferSource", "stopTypingSfx", "typeText", "el", "full", "msPerChar", "skipTargets", "resolve", "skipping", "armed", "skip", "onKey", "targets", "tick", "openDialogueLockInfo", "lockInfo", "overlay", "cardEl", "nameEl", "messageEl", "closeBtn", "closed", "close", "onEsc", "blockInteraction", "doCloseFromBtn", "openDialogueModal", "MERCHANT_ICON_SRC", "onEscToCancel", "cancelWithoutReward", "textEl", "rowEl", "choicesEl", "ended", "closeModal", "engine", "DialogueEngine", "nodeId", "opt", "claimed", "script", "MERCHANT_DIALOGUES", "ensureMerchantScrollbar", "scroller", "merchantSheetEl", "bar", "thumb", "isTouch", "FADE_SCROLL_MS", "FADE_DRAG_MS", "supportsScrollEnd", "fadeTimer", "syncScrollShadow", "hasShadow", "updateBounds", "grabber", "header", "actions", "top", "bottom", "updateThumb", "scrollHeight", "clientHeight", "scrollTop", "barH", "visibleRatio", "thumbH", "maxScroll", "range", "y", "updateAll", "showBar", "scheduleHide", "delay", "onScroll", "onScrollEnd", "ro", "dragging", "dragStartY", "startScrollTop", "startDrag", "onDragMove", "thH", "scrollMax", "scrollDelta", "endDrag", "rect", "clickY", "targetY", "ensureMerchantOverlay", "content", "tabs", "panelsWrap", "panelDialogue", "panelReset", "panelWorkshop", "stored", "initResetSystem", "initResetPanel", "updateResetPanel", "initWorkshopTab", "forgeUnlockListenerBound", "handleUnlockChange", "merchantCloseBtn", "firstChat", "initDialogueTab", "merchantEventsBound", "closeMerchant", "onKeydownForMerchant", "onMerchantDragStart", "panel", "list", "handleDialogueCardClick", "card", "ctx", "stateDirty", "seenIds", "DLG_CATALOG", "entryState", "storedStatus", "storedRank", "rank", "snapshot", "isMysterious", "locked", "showComplete", "titleEl", "blurbEl", "rewardEl", "titleText", "blurbText", "iconSrc", "REWARD_ICON_SRC", "amtEl", "amtText", "typeStr", "capText", "rewardLabelText", "text", "ariaLabel", "hint", "againEl", "child", "runFirstMeet", "fc", "MERCHANT_MET_EVENT", "resetFirstChatOverlayState", "openMerchant", "merchantOpen", "activeEl", "merchantLastFocus", "met", "last", "MERCHANT_TAB_KEY_BASE", "num", "requestedIndex", "maxUnlockedIndex", "targetIndex", "clientY", "merchantDrag", "onMerchantDragMove", "onMerchantDragEnd", "onMerchantDragCancel", "dy", "cleanupMerchantDrag", "dt", "unlockMerchantTabs", "keys", "init_dlgTab", "__esmMin", "init_storage", "init_bigNum", "init_merchantDialogues", "init_xpSystem", "init_resetTab", "init_workshopTab", "init_shopOverlay", "init_ghostTapGuard", "init_main", "base", "onEnd", "onChoice", "node", "nextNode", "options", "prepare", "unbind", "automationEffects_exports", "__export", "getAutobuyerToggle", "initAutomationEffects", "setAutobuyerToggle", "updateAutomation", "ensureCacheSlot", "slot", "cacheSlot", "autobuyerCache", "area", "id", "getActiveSlot", "slotSuffix", "key", "val", "stored", "value", "valStr", "onTick", "dt", "updateAutobuyers", "coinAutobuy", "getLevelNumber", "AUTOMATION_AREA_KEY", "AUTOBUY_COIN_UPGRADES_ID", "bookAutobuy", "AUTOBUY_BOOK_UPGRADES_ID", "goldAutobuy", "AUTOBUY_GOLD_UPGRADES_ID", "magicAutobuy", "AUTOBUY_MAGIC_UPGRADES_ID", "workshopAutobuy", "AUTOBUY_WORKSHOP_LEVELS_ID", "upgrades", "getUpgradesForArea", "AREA_KEYS", "i", "autobuyIndex", "upg", "shouldAutobuy", "performFreeAutobuy", "workshopTicker", "performFreeGenerationUpgrade", "rate", "EFFECTIVE_AUTO_COLLECT_ID", "accumulator", "interval", "count", "triggerPassiveCollect", "registerTick", "newSlot", "init_automationEffects", "__esmMin", "init_gameLoop", "init_upgrades", "init_coinPickup", "init_automationUpgrades", "init_workshopTab", "init_storage", "isUpgradeAutomated", "upgDef", "autoId", "COST_TYPE_TO_AUTO_ID", "getLevelNumber", "AUTOMATION_AREA_KEY", "getAutobuyerToggle", "resolveUpgradeId", "upgLike", "rawId", "parsed", "isForgeUnlockUpgrade", "mode", "FORGE_UNLOCK_UPGRADE_ID", "getShopUiData", "areaKey", "defs", "getUpgradesForArea", "upgrades", "def", "lvlBn", "getLevel", "lvlNum", "lockState", "getUpgradeLockState", "icon", "getIconUrl", "title", "desc", "locked", "hmReady", "upgradeUiModel", "getAdapter", "SHOP_ADAPTERS", "blockInteraction", "ms", "IS_MOBILE", "shield", "eat", "e", "ev", "stripTags", "html", "getCurrencyLabel", "type", "amountBn", "isOne", "bn", "BigNum", "createSfxPlayer", "src", "mobileVolume", "desktopVolume", "base", "ac", "gain", "buffer", "bufferPromise", "bufferPromiseHandled", "pendingPlays", "ensureBase", "el", "takePreloadedAudio", "ensureWebAudio", "ensureBuffer", "srcUrl", "resp", "buf", "resolve", "reject", "settled", "decoded", "err", "playMobileFallback", "baseAudio", "playMobileWebAudio", "playBuffer", "node", "plays", "i", "a", "playPurchaseSfx", "purchaseSfx", "playEvolveSfx", "evolveSfx", "currencyIconHTML", "CURRENCY_ICON_SRC", "ensureCustomScrollbar", "overlayEl", "sheetEl", "scrollerSelector", "scroller", "bar", "thumb", "isTouch", "FADE_SCROLL_MS", "FADE_DRAG_MS", "supportsScrollEnd", "syncScrollShadow", "hasShadow", "updateBounds", "scrollerRect", "sheetRect", "top", "bottom", "updateThumb", "scrollHeight", "clientHeight", "scrollTop", "barH", "visibleRatio", "thumbH", "maxScroll", "range", "y", "updateAll", "showBar", "scheduleHide", "delay", "onScroll", "onScrollEnd", "dragging", "dragStartY", "startScrollTop", "startDrag", "onDragMove", "scrollMax", "deltaY", "endDrag", "rect", "clickY", "thH", "targetY", "levelsRemainingToCap", "upg", "currentLevelBn", "currentLevelNumber", "capBn", "fallback", "capPlain", "lvlPlain", "delta", "capNumber", "lvlNumber", "room", "computeAffordableLevels", "currentLevelNumeric", "lvl", "cap", "walletValue", "bank", "walletBn", "isHmType", "maxed", "c0", "c1", "farProbeLevel", "cFar", "remainingBn", "lo", "hi", "mid", "midBn", "count", "evaluateBulkPurchase", "openShop", "shops", "updateShopOverlay", "force", "s", "ensureUpgradeOverlay", "upgOverlayEl", "upgSheetEl", "grab", "header", "content", "actions", "drag", "onDragStart", "upgOpen", "onDragEnd", "dy", "shouldClose", "closeUpgradeMenu", "upgOverlayCleanup", "fn", "openHmMilestoneDialog", "lines", "existing", "overlay", "dialog", "list", "line", "li", "text", "closeBtn", "close", "onKeydown", "event", "openUpgradeOverlay", "upgOpenLocal", "adapter", "initialLockState", "initialLocked", "initialMysterious", "isHM", "isEndlessXp", "UPGRADE_TIES", "ensureChild", "parent", "className", "tagName", "targetClasses", "c", "extras", "child", "cls", "spacer", "h", "makeLine", "d", "recenterUnlockOverlayIfNeeded", "model", "isHiddenUpgrade", "headerRect", "actionsRect", "contentRect", "freeSpace", "initialRender", "rerender", "isUnlockVisible", "evolveReady", "capReached", "level", "capHtml", "formatNumber", "levelHtml", "levelPlain", "autoToggleWrapper", "masterCostType", "MASTER_AUTOBUY_IDS", "isWorkshopMaster", "AUTOBUY_WORKSHOP_LEVELS_ID", "isAutomationMaster", "standardAutobuyId", "COST_TYPE_TO_AUTOBUY_ID", "autobuyLevel", "toggleBtn", "activeSlot", "getActiveSlot", "slotSuffix", "isEnabled", "key", "AREA_KEYS", "anyEnabled", "u", "childKey", "val", "setAutobuyerToggle", "baseDesc", "info", "descText", "reasonText", "note", "iconHTML", "nextPriceBn", "stopBuying", "costs", "costLabel", "lineCost", "lineMilestone", "milestoneCost", "milestoneLabel", "isAutomated", "targetLevelBn", "targetLevelNum", "costAt", "deltaBn", "deltaPlain", "deltaNum", "spent", "prefix", "haveLabel", "lineHave", "milestonesRow", "btn", "milestones", "evolutions", "evolutionOffset", "HM_EVOLUTION_INTERVAL", "b", "m", "milestoneLevelBn", "levelText", "mult", "formatMultForUi", "target", "achieved", "mr", "canAffordNext", "ensureButton", "onClick", "index", "disabled", "invoke", "siblings", "evolved", "bought", "unlockMerchantTabs", "fresh", "stale", "diffPlain", "walletRaw", "reachable", "plain", "purchase", "onUpdate", "evt", "setupDragToClose", "grabberEl", "isOpenFn", "performCloseFn", "clientY", "cleanupDrag", "dt", "suppressNextGhostTap", "onDragCancel", "BASE_ICON_SRC_BY_COST", "LOCKED_BASE_ICON_SRC", "MAXED_BASE_OVERLAY_SRC", "AUTOMATED_OVERLAY_SRC", "PURCHASE_SFX_SRC", "EVOLVE_SFX_SRC", "MOBILE_PURCHASE_VOLUME", "DESKTOP_PURCHASE_VOLUME", "TRANSPARENT_PX", "ShopInstance", "init_shopOverlay", "__esmMin", "init_storage", "init_bigNum", "init_numFormat", "init_main", "init_dlgTab", "init_audioCache", "init_upgrades", "init_ghostTapGuard", "init_automationUpgrades", "init_automationEffects", "AUTOBUY_COIN_UPGRADES_ID", "AUTOBUY_BOOK_UPGRADES_ID", "AUTOBUY_GOLD_UPGRADES_ID", "AUTOBUY_MAGIC_UPGRADES_ID", "getCurrentAreaKey", "id", "buyOne", "buyMax", "amount", "buyTowards", "evolveUpgrade", "MERCHANT_MET_EVENT", "targetSlot", "met", "hasMetMerchant", "grid", "seenIds", "tile", "baseImg", "iconImg", "shouldSkipGhostTap", "lockIcon", "hasMysteriousIcon", "isMysterious", "isPlainLocked", "canPlusBn", "plusBn", "plusHtml", "plusPlain", "hasPlus", "rawCap", "levelNumber", "isSingleLevelCap", "isUnlockUpgrade", "showUnlockableBadge", "showUnlockedBadge", "badgeHtml", "badgePlain", "needsTwoLines", "isTextBadge", "reason", "ariaLabel", "numericLevel", "plainDigits", "isInf", "over999", "tileEl", "baseImgEl", "iconImgEl", "costType", "baseSrc", "rawIcon", "iconSrc", "maxedOverlay", "showMaxed", "targetSrc", "badge", "grabber", "delveBtn", "primeTypingSfx", "openMerchant", "focusable", "forceClose", "overlayOpen", "hudButtons_exports", "__export", "applyHudLayout", "initHudButtons", "isMapUnlocked", "isShopUnlocked", "lockMap", "lockShop", "unlockMap", "unlockShop", "slotKey", "base", "slot", "getActiveSlot", "isUnlocked", "key", "slotRaw", "ensureUnlockDefaults", "BASE_KEYS", "setUnlocked", "v", "val", "sk", "setButtonVisible", "visible", "el", "updateShopButtonTamperState", "btn", "hasModifiedSave", "phonePortrait", "isCoarse", "isPortrait", "hud", "mapBtn", "isMapVisible", "isPhonePortrait", "desiredNodes", "remainingNodes", "finalOrder", "idx", "frag", "node", "cs", "gap", "cw", "per", "help", "stats", "shop", "listenersBound", "event", "active", "actionsBound", "activate", "openShop", "onClick", "e", "shouldSkipGhostTap", "init_hudButtons", "__esmMin", "init_shopOverlay", "init_storage", "init_ghostTapGuard", "createCursorTrail", "playfield", "el", "CAPACITY", "PARTICLE_LIFETIME", "INTERPOLATION_STEP", "MAX_SPAWN_PER_FRAME", "PARTICLE_RADIUS", "GLOW_RADIUS", "TEXTURE_SIZE", "CENTER", "STRIDE", "data", "i", "freeSlots", "freeCount", "maxActiveIndex", "canvas", "ctx", "texture", "tCtx", "pointerInside", "lastSpawnX", "lastSpawnY", "rect", "dpr", "destroyed", "rafId", "lastTime", "wasDirty", "lastClearRect", "pointsQueue", "updateBounds", "resize", "baseDpr", "resizeObserver", "spawn", "x", "y", "idx", "offset", "processPoint", "localX", "localY", "budgetRef", "dx", "dy", "dist", "steps", "fraction", "onPointerMove", "e", "loop", "offsetX", "offsetY", "isIn", "events", "ev", "lx", "ly", "onPointerLeave", "now", "dt", "budget", "pt", "lastPt", "activeParticles", "minX", "minY", "maxX", "maxY", "newMaxIndex", "age", "maxAge", "progress", "opacity", "scale", "size", "halfSize", "drawX", "drawY", "drawSize", "right", "bottom", "opts", "onPointerEnter", "init_cursorTrail", "__esmMin", "coinPickup_exports", "__export", "clearPendingGains", "getPassiveCoinReward", "initCoinPickup", "setCoinMultiplier", "triggerPassiveCollect", "updateMutationSnapshot", "state", "mutationUnlockedSnapshot", "mutationLevelIsInfiniteSnapshot", "mutationCurrentLevelStr", "mutationMultiplierCache", "initMutationSnapshot", "mutationUnsub", "getMutationState", "onMutationChange", "snapshot", "x", "COIN_MULTIPLIER", "bank", "refreshMpValueMultiplierCache", "next", "getMpValueMultiplierBn", "BigNum", "mpValueMultiplierBn", "ensureMpValueMultiplierSync", "mpMultiplierListenersBound", "resolveCoinBase", "el", "BASE_COIN_VALUE", "computeMagnetUnitPx", "root", "vw", "vh", "MAGNET_UNIT_RATIO", "createMagnetController", "playfield", "coinsLayer", "coinSelector", "collectFn", "collectBatchFn", "spawner", "indicator", "pointerInside", "hasPointer", "pointerClientX", "pointerClientY", "localX", "localY", "lastLocalX", "lastLocalY", "unitPx", "magnetLevel", "radiusPx", "rafId", "destroyed", "playfieldRect", "updatePlayfieldRect", "hideIndicator", "updateIndicator", "diameter", "sweepCoins", "radiusWithBuffer", "MAGNET_COLLECTION_BUFFER", "candidates", "getTransform", "items", "i", "transforms", "coins", "toCollect", "coin", "rect", "coinX", "coinY", "dx", "dy", "cs", "runSweep", "ensureSweepLoop", "updatePointerFromEvent", "e", "handlePointerLeave", "refreshMagnetLevel", "getMagnetLevel", "handleScroll", "handleResize", "destroy", "pointerOpts", "pendingCoinGain", "pendingXpGain", "pendingMutGain", "calculateCoinValue", "spawnLevelStr", "base", "inc", "applyCoinMultiplier", "xpInc", "cloneBn", "XP_PER_COIN", "mutationMultiplier", "computeMutationMultiplier", "mpGain", "isMutationUnlocked", "coinGain", "xpGain", "count", "totalCoin", "totalXp", "totalMp", "coinsLocked", "isCurrencyLocked", "CURRENCIES", "incIsZero", "coinsVal", "scheduleHudUpdate", "queueCoinGain", "xpEnabled", "isXpSystemUnlocked", "xpIsZero", "queueXpGain", "queueMutationGain", "playfieldSelector", "coinsLayerSelector", "hudAmountSelector", "soundSrc", "storageKey", "disableAnimation", "coinPickup", "pf", "cl", "amt", "magnetController", "cursorTrail", "updateHudFn", "formatted", "formatNumber", "refreshCoinMultiplierCache", "onCurrencyChange", "onCoinMultiplierChange", "event", "mult", "coinMultiplierBn", "coinMultiplierIsInfinite", "slot", "getActiveSlot", "SHOP_UNLOCK_KEY", "SHOP_PROGRESS_KEY", "legacyP", "legacyU", "p", "unlockShop", "resolvedSrc", "isCoin", "ensureInteractive", "ac", "masterGain", "buffer", "webAudioReady", "webAudioLoading", "mobileFallback", "playCoinMobileFallback", "initWebAudioOnce", "arr", "ok", "err", "playCoinWebAudio", "IS_MOBILE", "src", "t", "playSound", "playCoinHtmlAudio", "warm", "evt", "pool", "pIdx", "lastAt", "a", "now", "animateAndRemove", "opts", "recycle", "start", "complete", "done", "collectBatch", "collectedCount", "mutEnabled", "mergeGain", "collect", "createCursorTrail", "onDelegatedInteract", "target", "BRUSH_R", "cachedPfRect", "updateCachedRect", "lastBrushLocalX", "lastBrushLocalY", "brushAt", "y", "transform", "OFF", "found", "k", "px", "py", "stack", "pending", "brushScheduled", "scheduleBrush", "setMobileVolume", "v", "vol", "flushPendingGains", "BN_ONE", "BN_INF", "flushScheduled", "hudUpdateScheduled", "scheduleFlush", "init_coinPickup", "__esmMin", "init_storage", "init_bigNum", "init_numFormat", "init_hudButtons", "init_xpSystem", "init_main", "init_mutationSystem", "init_upgrades", "init_cursorTrail", "value", "current", "gain", "addXp", "mutGain", "addMutationPower", "multHandle", "key", "cached", "levelBn", "multiplier", "computeMutationMultiplierForLevel", "isIdentity", "stored", "resetTab_exports", "__export", "canPerformForgeReset", "canPerformInfuseReset", "computeForgeGoldFromInputs", "computeInfuseMagicFromInputs", "computePendingForgeGold", "getForgeDebugOverrideState", "getInfuseDebugOverrideState", "getSurgeDebugOverrideState", "hasDoneForgeReset", "hasDoneInfuseReset", "hasDoneSurgeReset", "initResetPanel", "initResetSystem", "isForgeUnlocked", "isInfuseUnlocked", "isSurgeUnlocked", "onForgeUpgradeUnlocked", "onInfuseUpgradeUnlocked", "onSurgeUpgradeUnlocked", "performForgeReset", "performInfuseReset", "performSurgeReset", "recomputePendingMagic", "setForgeDebugOverride", "setForgeResetCompleted", "setInfuseDebugOverride", "setInfuseResetCompleted", "setInfuseUnlockedForDebug", "setSurgeResetCompleted", "setSurgeUnlockedForDebug", "updateResetPanel", "shouldWipePlayfield", "resetType", "RESET_WIPE_EXCLUSIONS", "playForgeResetSound", "forgeResetAudio", "FORGE_RESET_SOUND_SRC", "playInfuseResetSound", "infuseResetAudio", "INFUSE_RESET_SOUND_SRC", "playSurgeResetSound", "surgeResetAudio", "SURGE_RESET_SOUND_SRC", "resetPendingGoldSignature", "pendingGoldInputSignature", "notifyForgeUnlockChange", "slot", "resetState", "getActiveSlot", "notifyInfuseUnlockChange", "notifySurgeUnlockChange", "getPendingGoldWithMultiplier", "multiplierOverride", "mult", "BN", "bank", "cleanupWatchers", "watchers", "stop", "ensureValueListeners", "coinChangeUnsub", "onCurrencyChange", "detail", "CURRENCIES", "updateWaveBar", "recomputePendingGold", "recomputePendingWaves", "xpChangeUnsub", "onXpChange", "levelToNumber", "levelBn", "plain", "num", "approx", "approxLog10BigNum", "getXpLevelBn", "state", "getXpState", "bnZero", "computeForgeGold", "coinsBn", "logCoins", "logScaled", "pow2", "bigNumFromLog10", "levelNum", "levelFactor", "pow14", "bnOne", "floorLog", "pow115", "total", "floored", "computeInfuseMagicBase", "cumulativeMpBn", "logCRatio", "LOG_BASE", "LOG_1_5", "LOG_1_03", "LOG_2", "logMpRatio", "logMp", "term1", "term2", "term3", "totalLog", "computeInfuseMagic", "base", "computeSurgeWaves", "xpLevelBn", "goldBn", "magicBn", "mpBn", "xpLevel", "xpTerm", "logGold", "logMagic", "logSum", "LOG1_1", "logTotal", "getXpLevelNumber", "ensureResetSlot", "value", "FORGE_COMPLETED_KEY", "INFUSE_COMPLETED_KEY", "SURGE_COMPLETED_KEY", "getForgeDebugOverride", "raw", "FORGE_DEBUG_OVERRIDE_KEY", "normalized", "primeStorageWatcherSnapshot", "getInfuseDebugOverride", "INFUSE_DEBUG_OVERRIDE_KEY", "setInfuseUnlocked", "next", "INFUSE_UNLOCK_KEY", "setForgeUnlocked", "FORGE_UNLOCK_KEY", "getSurgeDebugOverride", "SURGE_DEBUG_OVERRIDE_KEY", "setSurgeUnlocked", "SURGE_UNLOCK_KEY", "readPersistentFlags", "ensurePersistentFlagsPrimed", "bindStorageWatchers", "watchersBoundSlot", "watchStorageKey", "getPendingInputSignature", "coins", "level", "coinSig", "levelSig", "force", "signature", "meetsLevelRequirement", "cumulativeMp", "getTotalCumulativeMp", "meetsInfuseRequirement", "gold", "magic", "mp", "canAccessForgeTab", "override", "getLevelNumber", "AREA_KEYS", "UPGRADE_TIES", "MIN_FORGE_LEVEL", "mState", "getMutationState", "MIN_INFUSE_MUTATION_LEVEL", "resetUpgrades", "resetGold", "resetMagic", "upgrades", "getUpgradesForArea", "upg", "tieKey", "setLevel", "applyForgeResetEffects", "resetXpProgress", "clearPendingGains", "reward", "withMultiplier", "initMutationSystem", "unlockMutationSystem", "KEY_LEVEL", "s", "KEY_PROGRESS", "triggerSurgeWaveAnimation", "existing", "overlay", "wave", "getSurgeBarLevel", "barLevel", "SURGE_BAR_LEVEL_KEY", "getLog10BigInt", "val", "str", "isUpdatingWaveBar", "currentWaves", "req", "BigNum", "changed", "logCurrent", "logReq", "logCurrentBigInt", "targetLevel", "nextReq", "cost", "safety", "formatBn", "formatNumber", "buildPanel", "panelEl", "RESET_ICON_SRC", "INFUSE_ICON_SRC", "SURGE_ICON_SRC", "GOLD_ICON_SRC", "MAGIC_ICON_SRC", "WAVES_ICON_SRC", "key", "btn", "lastPointerType", "handleClick", "e", "shouldSkipGhostTap", "card", "scrollContainer", "updateResetButtonContent", "iconSrc", "pendingAmountBn", "disabled", "msg", "targetMode", "currentMode", "amountStr", "amountEl", "iconImg", "updateForgeCard", "goldMult", "el", "expected", "updateInfuseCard", "updateSurgeCard", "pct", "ratio", "rNum", "bindGlobalEvents", "magicMult", "initialized", "isMutationUnlocked", "mutationUnsub", "onMutationChange", "sprite", "getMutationCoinSprite", "nextSlot", "init_resetTab", "__esmMin", "init_bigNum", "init_storage", "init_numFormat", "init_xpSystem", "init_upgrades", "init_mutationSystem", "init_ghostTapGuard", "init_coinPickup", "upgrades_exports", "__export", "AREA_KEYS", "HM_EVOLUTION_INTERVAL", "MAX_LEVEL_DELTA", "REGISTRY", "UPGRADE_TIES", "approxLog10BigNum", "batchUpgradeOperations", "bigNumFromLog10", "buyMax", "buyOne", "buyTowards", "calculateUpgradeMultipliers", "clearPermanentUpgradeUnlock", "computeDefaultUpgradeCost", "computeUpgradeEffects", "costToBuyOne", "estimateFlatBulk", "estimateGeometricBulk", "evaluateBulkPurchase", "evolveUpgrade", "formatMultForUi", "getCurrentAreaKey", "getHmEvolutions", "getHmNextMilestoneLevel", "getIconUrl", "getLevel", "getLevelNumber", "getMagnetLevel", "getMpValueMultiplierBn", "getUpgrade", "getUpgradeLockState", "getUpgradeStorageKey", "getUpgradesForArea", "markUpgradePermanentlyUnlocked", "normalizeBigNum", "onUpgradesChanged", "peekNextPrice", "performFreeAutobuy", "registerXpUpgradeEffects", "setLevel", "upgradeUiModel", "flushDeferredWrites", "deferredWrites", "areaKey", "upgId", "state", "slot", "key", "payload", "primeStorageWatcherSnapshot", "e", "initDeferredFlush", "deferredFlushTimer", "fn", "isBatching", "pendingUpgradeSaves", "saveUpgradeState", "pendingAreaSaves", "stateArr", "saveAreaState", "pendingNotify", "notifyChanged", "hasScaling", "upg", "scaling", "ensureUpgradeScaling", "c0", "BigNum", "c1", "cF", "isInfinityLevelForScaled", "lvlBn", "bn", "log10", "SCALED_INFINITY_LVL_LOG10", "sanitizeStoredLevelValue", "raw", "allowEmpty", "trimmed", "MAX_LEVEL_STORAGE_LENGTH", "expPart", "caret", "expDigits", "value", "sigNum", "sigLog", "off", "storage", "parts", "sigStr", "offsetStr", "baseExp", "offset", "digits", "head", "expSum", "log10Value", "p", "intPart", "frac", "mantissa", "sig", "exp", "shopStatusRank", "status", "SHOP_REVEAL_STATUS_ORDER", "classifyUpgradeStatus", "lockState", "upgradeRevealKey", "normArea", "normalizeAreaKey", "tieKey", "normalizeUpgradeTie", "rawId", "normalizeUpgradeId", "idStr", "upgradeLegacyRevealKey", "migrateUpgradeStateKey", "fromKey", "toKey", "ensureShopRevealState", "getActiveSlot", "slotKey", "shopRevealStateCache", "parsed", "SHOP_REVEAL_STATE_KEY_BASE", "obj", "saveShopRevealState", "ensureShopPermaUnlockState", "shopPermaUnlockStateCache", "SHOP_PERMA_UNLOCK_KEY_BASE", "saveShopPermaUnlockState", "ensureShopPermaMystState", "shopPermaMystStateCache", "SHOP_PERMA_MYST_KEY_BASE", "saveShopPermaMystState", "markUpgradePermanentlyMysterious", "legacyKey", "isUpgradePermanentlyMysterious", "permaState", "revealState", "invalidateUpgradeState", "isUpgradePermanentlyUnlocked", "determineLockState", "ctx", "upgRef", "area", "SPECIAL_LOCK_STATE_TIES", "LOCKED_UPGRADE_ICON_DATA_URL", "currentLevel", "xpUnlocked", "safeIsXpUnlocked", "determineUnlockXpLockState", "safeHasMetMerchant", "revealText", "MYSTERIOUS_UPGRADE_ICON_DATA_URL", "HIDDEN_UPGRADE_TITLE", "xp31", "xpBn", "currentXpLevelBigNum", "levelBigNumToNumber", "hasDoneForgeReset", "LOCKED_UPGRADE_TITLE", "xp101", "hasDoneInfuseReset", "xp201", "INFUSE_PLACEHOLDER_TIES", "tieValue", "isXpAdjacentUpgrade", "XP_MYSTERY_UPGRADE_TIES", "normalizedId", "numericId", "idKey", "areaCandidates", "candidate", "XP_MYSTERY_LEGACY_KEYS", "isXpSystemUnlocked", "MERCHANT_MET_KEY_BASE", "getXpState", "bookValueMultiplierBn", "level", "L", "ensureLevelBigNum", "plain", "lvl", "normalizedUpgradeLevel", "levelValue", "maxSafe", "clamped", "mergeLockStates", "base", "override", "merged", "keys", "unsigned", "approxDigits", "normalized", "num", "approx", "lead", "leadNum", "leadLen", "exponent", "shift", "plainLevelDelta", "nextLevelBn", "prevLevelBn", "next", "prev", "nextDigits", "prevDigits", "nextPlain", "prevPlain", "diff", "decimalMultiplierString", "out", "normalizeHmEvolutionCount", "n", "activeEvolutionsForUpgrade", "active", "baseCost", "upgType", "baseBn", "levelNumber", "evolutions", "preset", "resolveDefaultScalingRatio", "ratio", "ratioLog10", "costAtLevelUsingScaling", "hmLevelCapForEvolutions", "cycles", "cap", "capBn", "formatBigNumAsHtml", "formatBigNumAsPlain", "hmMilestoneHits", "levelBn", "milestoneLevel", "delta", "interval", "hmMilestoneMultiplier", "multiplier", "hits", "hitCount", "multiply", "a", "b", "result", "i", "factor", "resolveHmMilestones", "DEFAULT_AREA_KEY", "normalizedArea", "HM_MILESTONES_BY_AREA", "HM_MILESTONES_STARTER_COVE", "safeMultiplyBigNum", "f", "applyHmEvolutionMeta", "capFmtHtml", "capFmtText", "computeHmMultipliers", "milestones", "selfMult", "xpMult", "coinMult", "mpMult", "m", "mult", "target", "HM_EVOLUTION_EFFECT_MULT_BN", "hmNextMilestoneLevel", "best", "nextHits", "targetBi", "increment", "tryPreset", "name", "presetName", "presetFn", "DEFAULT_SCALING_PRESETS", "res", "providedScaling", "ratioStr", "pow", "ratioLn", "ratioMinus1", "defaultPreset", "resolved", "baseLog10", "price", "anchor", "step", "logExpMinus1", "x", "negExp", "logSeriesTotal", "startLevel", "count", "LN10", "startLn", "growth", "numerLn", "denomLn", "totalCostBigNum", "targetLevel", "total", "tailCount", "headCount", "headLog", "tailStart", "totalLog", "log10OnePlusPow10", "nextDownPositive", "FLOAT64_VIEW", "INT64_VIEW", "safeDecrementCount", "dec", "countToBigNum", "floored", "str", "calculateBulkPurchase", "walletBn", "maxLevels", "options", "zero", "fastOnly", "startLevelNum", "maxLevelsNum", "capRoom", "MAX_LEVEL_DELTA_LIMIT", "room", "nextPrice", "remainingToHundred", "limit", "spent", "newSpent", "nextLevel", "reachedCap", "countBn", "nextStartLevel", "toUpgradeBigNum", "tail", "totalCount", "totalSpent", "walletLog", "firstPrice", "startPriceLog", "hardLimit", "lo", "hi", "spentLog", "doubled", "steps", "mid", "isConstantCost", "secondPrice", "farPrice", "farProbe", "roomBn", "ratioMinus1Log", "approxCount", "EPS", "tuneSteps", "MAX_TUNE_STEPS", "overshoot", "reduced", "safeTimes2", "y", "hiLog", "left", "right", "midLog", "guard", "decremented", "nextCost", "nextLog", "canUseNumericFinal", "finalLevel", "computeBulkMeta", "basePrice", "logBase", "logNext", "ratioLog", "denom", "priceBn", "wPlain", "pPlain", "q", "levelCapToNumber", "wl", "pl", "meta", "priceLog", "numerator", "hiBound", "iter", "nextPriceLog", "fallback", "formatNumber", "safeCloneBigNum", "emitUpgradeLevelChange", "prevLevelNum", "nextLevelNum", "oldBn", "newBn", "nmCostBN", "syncBookCurrencyMultiplierFromUpgrade", "levelOverride", "multHandle", "bank", "resolvedLevel", "storedLevel", "keyForArea", "resolvedId", "resolveUpgradeIdentifier", "cleanupUpgradeStorageWatchers", "upgradeStorageWatcherCleanup", "stop", "bindUpgradeStorageWatchersForSlot", "migrateLegacyStorage", "arr", "migratedCount", "rec", "loadUpgradeFromStorage", "pending", "deferred", "upgradeTieLookup", "requestedArea", "upgradeCacheKey", "ensureUpgradeState", "upgradeStateCache", "recNeedsSave", "prevLvlStorage", "prevNextCost", "prevNextCostLvl", "hmEvolutions", "clampedStorage", "normalizedLvlStorage", "costLevelStorage", "nextCostStale", "nextCostBn", "infCap", "commitUpgradeState", "inBn", "currentLvlStorage", "mpValue", "magnetRadius", "computeUpgradeLockStateFor", "xpLevelBn", "xpLevel", "baseState", "isXpAdj", "xpRevealText", "unlockXpVisible", "meetText", "targetId", "custom", "revealKey", "permaUnlocked", "permaMystState", "hyphenKey", "needsRevealSave", "needsPermaSave", "needsPermaMystSave", "hiddenState", "isForgePlaceholder", "FORGE_PLACEHOLDER_TIES", "isInfusePlaceholder", "storedStatus", "xpReached31", "xpReached101", "storedRank", "currentStatus", "currentRank", "applyStoredMysterious", "snap", "reasonText", "shouldSave", "normalizedStatus", "isForgePlaceholderForSave", "xpReached31Now", "xpReached101Now", "isUpgradeLocked", "isHmReadyToEvolve", "safeEvol", "lvlNum", "currentNum", "clampToCap", "resetHmEvolutions", "desiredBn", "nextBn", "nextNum", "u", "normalizeUpgradeIconPath", "iconPath", "path", "segments", "seg", "segment", "SHARED_ROOTS", "lower", "rawPrice", "costType", "walletEntry", "haveRaw", "nextEvol", "walletValue", "wallet", "prevLevel", "prevLevelStorage", "targetLevelBn", "purchased", "plainDelta", "nextStorage", "outcome", "remaining", "maxRoom", "_cachedUpgradeMultipliers", "upgrades", "acc", "baseEffect", "val", "mults", "BASE_CPS", "initResetSystem", "addExternalCoinMultiplierProvider", "baseMultiplier", "coinValue", "addExternalXpGainMultiplierProvider", "baseGain", "gain", "xpValue", "refreshCoinMultiplierFromXpLevel", "cb", "listeners", "lvlFmtHtml", "lvlFmtText", "lvlCapBn", "lvlCapFmtHtml", "lvlCapFmtText", "nextPriceFmt", "have", "locked", "displayTitle", "displayDesc", "hmMilestones", "effect", "iconUrl", "storageKey", "isStorageKeyLocked", "BOOK_VALUE_TIE_KEY", "BN", "toBn", "E", "FLOAT64_BUFFER", "init_upgrades", "__esmMin", "init_storage", "init_bigNum", "init_numFormat", "init_xpSystem", "init_mutationSystem", "init_resetTab", "init_automationUpgrades", "AUTOMATION_AREA_KEY", "pNum", "pStr", "logL", "logTerm", "xNum", "xStr", "baseNum", "log10b", "LOG10_INFINITY_TRIGGER", "approxLevelLog", "triggerLevelLog", "approxLvl", "evol", "evolThreshold", "evol_after_1m", "base_scaling", "r", "extra_scaling", "softcapStart", "_", "newLevel", "newLevelBn", "unlockXpSystem", "onForgeUpgradeUnlocked", "units", "unitsText", "baseMult", "onInfuseUpgradeUnlocked", "onSurgeUpgradeUnlocked", "debugPanel_exports", "__export", "applyAllCurrencyOverridesForActiveSlot", "applyStatMultiplierOverride", "getDebugCurrencyMultiplierOverride", "getDebugStatMultiplierOverride", "setDebugCurrencyMultiplierOverride", "setDebugPanelAccess", "setDebugStatMultiplierOverride", "isOnMenu", "menuRoot", "style", "isGameVisible", "gameRoot", "addDebugPanelCleanup", "fn", "debugPanelCleanups", "createEmptyExpansionState", "captureDebugPanelExpansionState", "panel", "DEBUG_PANEL_ID", "sections", "toggle", "key", "subsections", "applyDebugPanelExpansionState", "debugPanelExpansionState", "content", "cleanupDebugPanelResources", "liveBindings", "registerLiveBinding", "binding", "refreshLiveBindings", "predicate", "setupLiveBindingListeners", "currencyHandler", "event", "slot", "targetSlot", "getActiveSlot", "currencyMultiplierHandler", "xpHandler", "changeType", "unlocked", "mutationHandler", "upgradeHandler", "slotHandler", "unlockHandler", "workshopHandler", "getAreas", "AREA_KEYS", "CURRENCIES", "ensureDebugPanelStyles", "DEBUG_PANEL_STYLE_ID", "existingLink", "marker", "link", "removeDebugPanelToggleButton", "existingButton", "DEBUG_PANEL_TOGGLE_ID", "shouldShowDebugPanelToggleButton", "debugPanelAccess", "IS_MOBILE", "onMenuVisibilityChange", "closeDebugPanel", "createDebugPanelToggleButton", "createSection", "title", "contentId", "contentBuilder", "section", "stateKey", "sectionKeyCounter", "lastPointerType", "handleToggle", "expanded", "createSubsection", "defaultExpanded", "container", "subsectionKeyCounter", "bigNumEquals", "a", "b", "getCurrencyStorageKey", "currencyKey", "resolvedSlot", "KEYS", "getCurrencyValueForSlot", "BigNum", "handle", "bank", "peekCurrency", "applyCurrencyState", "value", "previous", "storageKey", "wasLocked", "isStorageKeyLocked", "unlockStorageKey", "next", "markSaveSlotModified", "setCurrency", "primeStorageWatcherSnapshot", "lockStorageKey", "buildOverrideKey", "getCurrencyOverride", "currencyOverrides", "getCurrencyMultiplierStorageKey", "clearCurrencyMultiplierOverride", "cacheKey", "currencyOverrideBaselines", "getStatOverride", "lockAwareRefresh", "isStatMultiplierLocked", "cached", "statOverrides", "fromStorage", "loadStatMultiplierOverrideFromStorage", "notifyStatMultiplierChange", "statKey", "clearStatMultiplierOverride", "getStatMultiplierStorageKey", "statOverrideBaselines", "getLockedStatOverride", "getStatMultiplierDisplayValue", "gameValue", "getGameStatMultiplier", "getEffectiveStatMultiplierOverride", "STAT_MULTIPLIER_STORAGE_PREFIX", "mult", "getXpGainMultiplier", "valueMult", "getMpValueMultiplierBn", "getMutationMultiplier", "eff", "computeUpgradeEffects", "raw", "storeStatMultiplierOverride", "bn", "locked", "setter", "originalSetItem", "applyCurrencyOverrideForSlot", "override", "currencyOverrideApplications", "current", "ensureCurrencyOverrideListener", "currencyListenerAttached", "baseline", "baselineBn", "nextBn", "ratio", "ratioNum", "scaledOverride", "amount", "base", "multiplierForRatio", "numBn", "denomBn", "ensureStorageLockPatch", "storageLockPatched", "originalRemoveItem", "lockedStorageKeys", "toggleStorageLock", "createLockToggle", "onToggle", "button", "refresh", "createCompositeLockToggle", "resolveKeys", "getKeys", "isLocked", "keys", "hasAnyLocked", "anyLocked", "collapseAllDebugCategories", "withTemporaryUnlock", "uniqueKeys", "relock", "formatBigNumForInput", "storage", "pStr", "sigPart", "expPart", "precision", "paddedSig", "parseBigNumInput", "trimmed", "setInputValidity", "input", "valid", "flagDebugUsage", "getActionLogKey", "ACTION_LOG_STORAGE_PREFIX", "getCurrentActionLog", "parsed", "persistActionLog", "entries", "MAX_ACTION_LOG_ENTRIES", "appendActionLogEntry", "entry", "log", "logAction", "message", "now", "updateActionLogDisplay", "actionLogContainer", "actionLog", "msg", "formattedTime", "formattedMessage", "match", "dialogueStateStorageKey", "MERCHANT_DLG_STATE_KEY_BASE", "persistDialogueState", "state", "payload", "loadDialogueState", "grantDialogueReward", "reward", "e", "completeAllDialoguesForDebug", "completed", "DLG_CATALOG", "id", "meta", "prev", "alreadyClaimed", "restoreAllDialoguesForDebug", "restored", "createInputRow", "labelText", "initialValue", "onCommit", "idLabel", "onLockChange", "row", "label", "idSpan", "editing", "pendingValue", "skipBlurCommit", "lockToggle", "setValue", "commitValue", "createUnlockToggleRow", "description", "isUnlocked", "onEnable", "onDisable", "slider", "textContainer", "desc", "toggleRow", "lastKnown", "refreshed", "formatCalculatorResult", "formatNumber", "num", "createCalculatorRow", "inputs", "compute", "controls", "output", "fieldEls", "recompute", "values", "hasError", "config", "el", "result", "inputConfig", "select", "optLabel", "option", "applyXpState", "level", "progress", "getXpState", "zero", "toBnOrNull", "nextLevel", "nextProgress", "levelIsFinite", "progressIsFinite", "unlockXpSystem", "unlockKey", "XP_KEYS", "initXpSystem", "broadcastXpChange", "applyMutationState", "getMutationState", "forgeUnlocked", "forgeOverride", "setMutationUnlockedForDebug", "initMutationSystem", "unlockMutationSystem", "MUTATION_KEYS", "broadcastMutationChange", "buildAreaCurrencies", "area", "areaLabel", "currency", "currencyRow", "latestSlot", "latest", "buildAreaStats", "spawnRateKey", "spawnRateStorageKey", "spawnRateRow", "xp", "mutation", "xpLevelKey", "xpLevelRow", "xpProgressKey", "xpProgressRow", "prevLevel", "prevProgress", "mpLevelKey", "mpLevelRow", "mpProgressKey", "mpProgressRow", "genLevelKey", "getGenerationLevelKey", "currentGenLevel", "genLevelRow", "valNum", "cleanVal", "newVal", "r", "buildAreaUpgrades", "upgrades", "getUpgradesForArea", "upg", "getLevel", "getUpgradeStorageKey", "upgradeRow", "setLevel", "buildAreaCurrencyMultipliers", "setAllCurrenciesToInfinity", "inf", "updated", "setAllCurrenciesToZero", "setAllStatsToInfinity", "touched", "xpState", "mutationState", "levelInf", "progInf", "setAllStatsToZero", "getUnlockRowDefinitions", "resetXpProgress", "isShopUnlocked", "unlockShop", "lockShop", "isMapUnlocked", "unlockMap", "lockMap", "isJeffUnlocked", "setJeffUnlocked", "setAllUnlockToggles", "targetState", "toggled", "rowDef", "unlockAllUnlocks", "markUpgradePermanentlyUnlocked", "lockAllUnlockUpgrades", "clearPermanentUpgradeUnlock", "getResetTargetLockKeys", "target", "add", "addCurrencyKeys", "addStatMultiplier", "addStatKeys", "STAT_MULTIPLIERS", "resetCurrencyAndMultiplier", "setCurrencyMultiplierBN", "resetStatsAndMultipliers", "currencyCount", "resetCount", "parts", "buildAreaStatMultipliers", "stat", "buildAreaCalculators", "coins", "xpLevel", "mp", "gold", "magic", "getXpRequirementForXpLevel", "computeCoinMultiplierForXpLevel", "mpLevel", "computeMutationRequirementForLevel", "computeMutationMultiplierForLevel", "getGenerationUpgradeCost", "baseCost", "mode", "computeDefaultUpgradeCost", "group", "subsection", "sub", "calculatorRow", "buildAreasContent", "placeholder", "areaContainer", "areaContent", "currencies", "stats", "multipliers", "currencyMultipliers", "statMultipliers", "automationUpgrades", "calculators", "setAllUpgradesMaxed", "onlyUnlocked", "count", "areas", "targets", "areaKey", "getUpgradeLockState", "batchUpgradeOperations", "targetLevel", "setAllUpgradesZero", "setAllAutomationToggles", "val", "AUTOMATION_AREA_KEY", "lvl", "masterTypes", "MASTER_AUTOBUY_IDS", "automatedCostTypes", "type", "setAutobuyerToggle", "AUTOBUY_WORKSHOP_LEVELS_ID", "buildMiscContent", "buttons", "unlocks", "toggles", "locks", "buttonGrid", "cfg", "btn", "resetRow", "resetLabel", "resetSelect", "opt", "allCurrenciesOption", "allUnlockedStatsOption", "allUnlockedOption", "allOption", "debugPanelMiscResetSelection", "DEFAULT_MISC_RESET_SELECTION", "resolveResetLockKeys", "resetLockToggle", "resetBtn", "lockKeys", "shouldRelock", "nounPhrase", "actionLogRow", "wipeSlotBtn", "buildUnlocksContent", "rows", "textA", "textB", "buildDebugPanel", "existingPanel", "header", "titleContainer", "closeButtonContainer", "closeButton", "collapseCloseButton", "info", "text", "hideOnMobile", "infoLine", "debugPanelScrollTop", "debugPanelOpen", "openDebugPanel", "preserveExpansionState", "toggleDebugPanel", "teardownDebugPanel", "applyDebugPanelAccess", "enabled", "XP_KEY_PREFIX", "MUTATION_KEY_PREFIX", "init_debugPanel", "__esmMin", "init_bigNum", "init_numFormat", "init_storage", "init_xpSystem", "init_mutationSystem", "init_main", "init_upgrades", "init_hudButtons", "init_dlgTab", "init_workshopTab", "init_automationEffects", "init_automationUpgrades", "mutationSystem_exports", "__export", "addMutationPower", "broadcastMutationChange", "computeMutationMultiplierForLevel", "computeMutationRequirementForLevel", "getMutationCoinSprite", "getMutationMultiplier", "getMutationState", "getTotalCumulativeMp", "initMutationSystem", "isMutationUnlocked", "onMutationChange", "setMutationUnlockedForDebug", "unlockMutationSystem", "toStorageSafe", "value", "scheduleCoinMultiplierRefresh", "refreshCoinMultiplierFromXpLevel", "ensureExternalMultiplierProviders", "unregisterCoinMultiplierProvider", "unregisterXpGainMultiplierProvider", "cloneBigNum", "BN", "bnZero", "quantizeRequirement", "sci", "match", "floored", "plain", "quant", "levelToNumber", "level", "num", "approxLog", "approxLog10BigNum", "computeRequirement", "levelBn", "baseRequirementLog10", "baseLevel", "m", "tail", "poly", "factor", "powTerm", "CONST_RATIO", "totalLog10", "levelNum", "startVal", "endVal", "steps", "safeStart", "ratio", "exponent", "x", "A", "B", "secondExp", "raw", "bigNumFromLog10", "ensureRequirement", "lvl", "mutationState", "inf", "BigNum", "req", "progressRatio", "progressBn", "requirement", "reqInf", "progInf", "logProg", "logReq", "diff", "ensureHudRefs", "hudRefs", "formatBn", "bn", "formatNumber", "updateHud", "container", "bar", "fill", "levelValue", "progress", "reqHtml", "reqPlain", "syncXpMpHudLayout", "pct", "currentHtml", "currPlain", "emitChange", "reason", "extraDetail", "snapshot", "detail", "getActiveSlot", "listeners", "cb", "persistState", "slot", "KEY_UNLOCK", "KEY_LEVEL", "KEY_PROGRESS", "primeStorageWatcherSnapshot", "persisted", "unlocked", "rawLevel", "rawProgress", "persistedLevelRaw", "persistedProgressRaw", "expectedLevelRaw", "expectedProgressRaw", "unlockMismatch", "levelMismatch", "progressMismatch", "applyState", "normalizeProgress", "currentReq", "guard", "limit", "bnOne", "newState", "skipPersist", "readStateFromStorage", "targetSlot", "rawLvl", "rawProg", "cleanupWatchers", "watcherCleanups", "stop", "bindStorageWatchers", "watchersBoundSlot", "watchStorageKey", "nextUnlocked", "next", "forceReload", "initialized", "activeSlot", "nextSlot", "amount", "prevLevel", "prevProgress", "inc", "applyStatMultiplierOverride", "incClone", "levelsGained", "detailOverrides", "log10", "MP_LOG10_BASE", "callback", "currentLvlNum", "total", "i", "KEY_PREFIX", "init_mutationSystem", "__esmMin", "init_bigNum", "init_storage", "init_debugPanel", "init_numFormat", "init_upgrades", "init_hudLayout", "init_xpSystem", "spawner_exports", "__export", "createSpawner", "updateMutationSnapshot", "state", "mutationUnlockedSnapshot", "mutationLevelSnapshot", "level", "plain", "easeOutCubic", "t", "f", "getImage", "src", "img", "imgCache", "playfieldSelector", "waterSelector", "surgesHost", "coinsHost", "coinSrc", "coinSize", "animationDurationMs", "surgeLifetimeMs", "surgeWidthVw", "coinsPerSecond", "perFrameBudget", "backlogCap", "maxActiveCoins", "IS_MOBILE", "MAX_ACTIVE_COINS_MOBILE", "initialBurst", "coinTtlMs", "waveSoundSrc", "waveSoundDesktopVolume", "waveSoundMobileVolume", "waveSoundMinIntervalMs", "enableDropShadow", "currentCoinSrc", "isTouch", "MOBILE_BACKLOG_CAP", "burstUntil", "BURST_WINDOW_MS", "BURST_TIME_BUDGET_MS", "BURST_HARD_CAP", "ONE_SHOT_THRESHOLD", "NORMAL_TIME_BUDGET_MS", "refs", "validRefs", "canvas", "ctx", "canvasDirty", "M", "computeMetrics", "pfRect", "wRect", "hudH", "dpr", "ro", "clamp", "v", "lo", "hi", "COIN_POOL_MAX", "SURGE_POOL_MAX", "COIN_MARGIN", "coinPool", "surgePool", "activeCoins", "makeCoin", "el", "getCoin", "releaseCoin", "removeCoin", "coinObj", "knownIndex", "idx", "detachCoin", "coinEl", "makeSurge", "getSurge", "releaseSurge", "waveURL", "waveHtmlEl", "waveHtmlSource", "waveLastAt", "wavePool", "waveIdx", "ensureWavePool", "preloaded", "takePreloadedAudio", "_", "a", "i", "playWaveHtmlVolume", "vol", "ac", "gain", "pool", "waveBuf", "waveLoading", "ensureWaveWA", "arr", "ok", "err", "playWaveMobile", "warmWave", "evt", "playWaveOncePerBurst", "now", "planCoinFromWave", "wave", "waveX", "waveTop", "waveW", "startX", "startY", "drift", "endX", "minY", "maxY", "endY", "jitterMs", "planSpawn", "oldest", "pfW", "leftMax", "waterToPfTop", "coinPlan", "commitBatch", "batch", "wavesFrag", "coinsFrag", "newSurges", "newCoins", "coin", "surge", "c", "CUBIC_BEZIER", "onEnd", "e", "spawnBurst", "n", "plan", "drawSettledCoins", "logicalW", "logicalH", "count", "rate", "rafId", "last", "carry", "queued", "loop", "dt", "elapsed", "ease", "curX", "curY", "rot", "scale", "due", "cap", "getLevelNumber", "AUTOMATION_AREA_KEY", "EFFECTIVE_AUTO_COLLECT_ID", "activeCap", "spawnTarget", "timeBudgetMs", "t0", "baseSpawned", "start", "stop", "setRate", "clearBacklog", "clearPlayfield", "setCoinSprite", "getCoinTransform", "findCoinsInRadius", "centerX", "centerY", "radius", "radiusSq", "candidates", "minX", "maxX", "cx", "cy", "dx", "dy", "findCoinsInPath", "x1", "y1", "x2", "y2", "vx", "vy", "lenSq", "crossLimit", "wx", "wy", "dot", "hit", "cross", "init_spawner", "__esmMin", "init_audioCache", "init_mutationSystem", "init_main", "init_upgrades", "init_automationUpgrades", "getMutationState", "onMutationChange", "snapshot", "saveIntegrity_exports", "__export", "afterSlotWrite", "beforeSlotWrite", "nowMs", "noteTrustedSlot", "slot", "ttl", "TRUSTED_MUTATION_GRACE_MS", "trustedSlotsUntil", "slotRecentlyTrusted", "expiry", "resetTrustedSlots", "hasLocalStorage", "parseSlotFromKey", "key", "match", "rebuildExpectedStateForSlot", "snapshot", "expectedStateBySlot", "i", "STORAGE_PREFIX", "keySlot", "value", "ensureExpectedStateForSlot", "integrityInternalWriteDepth", "strKey", "snapKey", "expectedValue", "actualValue", "markSaveSlotModified", "computeSignature", "entries", "hash", "entry", "collectEntriesBySlot", "map", "slotMatch", "sigKey", "getSlotSignatureKey", "getCandidateSlots", "entriesBySlot", "slots", "_", "active", "getActiveSlot", "idx", "verifySlotIntegrity", "list", "stored", "getSlotSignature", "setSlotSignature", "signature", "runIntegrityCheck", "scheduleTrustedMutationSweep", "trustedSweepTimer", "TRUSTED_SWEEP_DELAY_MS", "handleStorageMutationEvent", "event", "detail", "rawSlot", "ensureWatcher", "watcherId", "SIGNATURE_POLL_INTERVAL_MS", "getShopButtonElement", "enforcePoopShopStyle", "btn", "hasModifiedSave", "POOP_SHOP_FLAG", "POOP_SHOP_BG", "startPoopShopEnforcer", "poopShopTimer", "ev", "init", "init_saveIntegrity", "__esmMin", "init_storage", "popups_exports", "__export", "initPopups", "teardownpopups", "ensureContainer", "container", "bnFromAny", "value", "BigNum", "isZero", "bn", "updateEntry", "entry", "amountEl", "amount", "meta", "formatted", "formatNumber", "scheduleRemoval", "duration", "DEFAULT_DURATION", "activePopups", "remove", "createPopupEntry", "type", "element", "plus", "icon", "text", "showPopup", "overrides", "slot", "getActiveSlot", "isStorageKeyLocked", "CURRENCIES", "isCurrencyLocked", "baseMeta", "POPUP_META", "bnAmount", "existing", "host", "index", "POPUP_ORDER", "insertBefore", "children", "child", "childType", "getAllCurrencies", "all", "key", "getCurrency", "syncLastKnown", "lastKnownAmounts", "clearActivePopups", "handleCurrencyChange", "event", "detail", "current", "prev", "zero", "delta", "detailDelta", "handleXpChange", "xpAdded", "handleMutationChange", "nextProgress", "handleSlotChange", "initialized", "init_popups", "__esmMin", "init_bigNum", "init_numFormat", "init_storage", "suspendSafeguard_exports", "__export", "flushBackupSnapshot", "getSuspendMetadata", "installSuspendSafeguards", "markProgressDirty", "restoreFromBackupIfNeeded", "canUseIndexedDb", "canUseLocalStorage", "testKey", "STORAGE_PREFIX", "openDatabase", "dbPromise", "resolve", "reject", "resolved", "request", "DB_NAME", "DB_VERSION", "db", "STORE_NAME", "err", "captureSnapshot", "data", "captured", "i", "key", "value", "putSnapshot", "snapshot", "settled", "tx", "SNAPSHOT_KEY", "readSnapshot", "requestPersistentStorage", "captureStackTrace", "parseSlotFromKey", "match", "slot", "isTrustedStorageStack", "stack", "DEVTOOLS_CONSOLE_FRAME_RE", "notifySaveIntegrityOfStorageMutation", "strKey", "SLOT_SIGNATURE_PREFIX", "SLOT_MOD_FLAG_PREFIX", "detail", "installStorageHooks", "proto", "originalSet", "originalRemove", "originalClear", "isTrackedGameKey", "beforeSlotWrite", "result", "afterSlotWrite", "scheduleFlush", "reason", "lastDirtyReason", "dirty", "flushTimer", "reasonToUse", "FLUSH_DEBOUNCE_MS", "cancelFlushTimer", "performFlush", "pendingImmediateFlush", "ok", "immediate", "flushBeforeSuspend", "hasAnyPrefixedKeys", "restoreAttempted", "shouldRestore", "activeSlot", "coinKey", "restored", "installAttempted", "onVisibilityChange", "event", "init_suspendSafeguard", "__esmMin", "init_saveIntegrity", "globalOverlayEsc_exports", "__export", "initGlobalOverlayEsc", "handleEsc", "yields", "closedAny", "sel", "btn", "shouldYield", "PRIORITY_SELECTORS", "candidates", "closeButton", "init_globalOverlayEsc", "__esmMin", "offlinePanel_exports", "__export", "initOfflineTracker", "processOfflineProgress", "formatTimeCompact", "ms", "s", "m", "rs", "h", "rm", "d", "rh", "y", "rd", "createOfflinePanel", "rewards", "offlineMs", "overlay", "panel", "header", "subHeader", "contentWrapper", "scrollContainer", "list", "PRIORITY_ORDER", "config", "key", "val", "row", "plus", "icon", "text", "isOne", "BigNum", "displayName", "formatNumber", "actions", "closeBtn", "closePanel", "e", "ensureCustomScrollbar", "slot", "getActiveSlot", "lastSave", "getLastSaveTime", "now", "diff", "hasDoneInfuseReset", "seconds", "gearsEarned", "getGearsProductionRate", "hasRewards", "isCurrencyLocked", "bank", "autoLevel", "getLevelNumber", "AUTOMATION_AREA_KEY", "EFFECTIVE_AUTO_COLLECT_ID", "totalPassives", "singleReward", "getPassiveCoinReward", "coinsEarned", "xpEarned", "mpEarned", "isStorageKeyLocked", "xpResult", "addXp", "mpResult", "addMutationPower", "existing", "checkActiveState", "onReward", "initialized", "pauseGameLoop", "resumeGameLoop", "init_offlinePanel", "__esmMin", "init_storage", "init_workshopTab", "init_resetTab", "init_gameLoop", "init_bigNum", "init_numFormat", "init_shopOverlay", "init_main", "init_upgrades", "init_automationUpgrades", "init_coinPickup", "init_xpSystem", "init_mutationSystem", "applyPendingSlotWipe", "slotStr", "suffix", "toRemove", "storage", "key", "k", "disableMobileZoomGestures", "IS_MOBILE", "lastTouchEnd", "TOUCH_DELAY_MS", "event", "now", "showLoader", "text", "onSkip", "root", "wrap", "label", "bar", "fill", "pct", "stuckMsg", "stuckTimeout", "skipBtn", "e", "setLoaderProgress", "loaderEl", "fraction", "f", "finishAndHideLoader", "MIN_FINISHED_DWELL_MS", "onEnd", "warmImage", "url", "img", "resolve", "ghost", "preloadImages", "sources", "onEach", "src", "done", "preloadAudio", "a", "registerPreloadedAudio", "pendingPreloadedAudio", "preloadFonts", "preloadAssetsWithProgress", "images", "audio", "fonts", "onProgress", "total", "bump", "tasks", "p", "enterArea", "areaID", "currentArea", "menuRoot", "AREAS", "gameRoot", "initHudButtons", "initResetSystemGame", "initMutationSystem", "spawner", "createSpawner", "applyMutationSprite", "getMutationCoinSprite", "onMutationChangeGame", "initCoinPickup", "applyUpgradesToSpawner", "areaKey", "getUpgAreaKey", "eff", "computeUpgradeEffects", "rate", "applyStatMultiplierOverride", "override", "cleanupUpgradesListener", "onUpgradesChanged", "initXpSystem", "initSlots", "installGhostTapGuard", "initGlobalGhostTap", "initGlobalOverlayEsc", "bank", "getHasOpenedSaveSlot", "setHasOpenedSaveSlot", "ensureStorageDefaults", "initPopups", "installSuspendSafeguards", "restoreSuspendBackup", "markProgressDirty", "flushBackupSnapshot", "setDebugPanelAccess", "startGameLoop", "notifyGameSessionStarted", "nextFrame", "twoFrames", "init_main", "__esmMin", "detected", "r", "resolveSkip", "skipPromise", "loader", "modulePromise", "ASSET_MANIFEST", "_", "i", "progress", "assetsPromise", "slotsModule", "spawnerModule", "coinPickupModule", "hudButtonsModule", "storageModule", "saveIntegrityModule", "upgradesModule", "audioCacheModule", "xpModule", "resetModule", "mutationModule", "popupModule", "safetyModule", "guardModule", "escModule", "debugPanelModule", "gameLoopModule", "offlinePanelModule", "workshopTabModule", "automationEffectsModule", "initOfflineTracker", "processOfflineProgress", "initWorkshopSystem", "initAutomationEffects", "entry", "titleEl", "init_main"]
}
