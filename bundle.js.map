{
  "version": 3,
  "sources": ["../js/util/audioManager.js", "../js/util/bigNum.js", "../js/util/numFormat.js", "../js/util/storage.js", "../js/util/slotsManager.js", "../js/util/slots.js", "../js/util/audioCache.js", "../js/ui/hudLayout.js", "../js/game/xpSystem.js", "../js/util/ghostTapGuard.js", "../js/misc/merchantDialogues.js", "../js/game/gameLoop.js", "../js/game/automationUpgrades.js", "../js/game/upgradeEffects.js", "../js/ui/merchantTabs/labTab.js", "../js/game/automationEffects.js", "../js/game/labNodes.js", "../js/game/comboSystem.js", "../js/game/surgeEffects.js", "../js/ui/merchantTabs/workshopTab.js", "../js/game/offlinePanel.js", "../js/ui/merchantTabs/warpTab.js", "../js/ui/merchantTabs/dlgTab.js", "../js/game/dnaUpgrades.js", "../js/ui/shopOverlay.js", "../js/ui/hudButtons.js", "../js/game/cursorTrail.js", "../js/game/coinPickup.js", "../js/game/surgeMilestones.js", "../js/game/tsunamiVisuals.js", "../js/ui/merchantTabs/resetTab.js", "../js/game/upgrades.js", "../js/util/debugPanel.js", "../js/game/mutationSystem.js", "../js/game/webgl/waterShaders.js", "../js/game/webgl/waterSystem.js", "../js/game/spawner.js", "../js/util/saveIntegrity.js", "../js/ui/popups.js", "../js/util/suspendSafeguard.js", "../js/util/globalOverlayEsc.js", "../js/game/domInit.js", "../js/util/fpsTracker.js", "../js/ui/notifications.js", "../js/main.js", "../app.js"],
  "sourcesContent": ["// js/util/audioManager.js\r\n\r\nlet audioContext = null;\r\nlet masterGain = null;\r\nlet musicGain = null;\r\nlet musicFilter = null;\r\n\r\nconst buffers = new Map();\r\nconst loadPromises = new Map();\r\n\r\n// Helper to get or create context\r\nfunction getAudioContext() {\r\n  if (audioContext) return audioContext;\r\n  \r\n  // Check browser support\r\n  const Ctx = window.AudioContext || window.webkitAudioContext;\r\n  if (!Ctx) return null;\r\n\r\n  audioContext = new Ctx();\r\n  masterGain = audioContext.createGain();\r\n  masterGain.connect(audioContext.destination);\r\n  \r\n  // Initial gain setup\r\n  masterGain.gain.value = 1.0; \r\n\r\n  // Music Pipeline: Source -> Filter -> MusicGain -> MasterGain\r\n  musicGain = audioContext.createGain();\r\n  musicGain.gain.value = 1.0;\r\n  musicGain.connect(masterGain);\r\n\r\n  musicFilter = audioContext.createBiquadFilter();\r\n  musicFilter.type = 'lowpass';\r\n  musicFilter.frequency.value = 22050; // Open by default\r\n  musicFilter.Q.value = 1; // Slight resonance or neutral\r\n  musicFilter.connect(musicGain);\r\n  \r\n  return audioContext;\r\n}\r\n\r\nexport function initAudio() {\r\n    getAudioContext();\r\n}\r\n\r\n// \"Warm\" the context on user interaction\r\nfunction warm() {\r\n  if (audioContext && audioContext.state === 'suspended') {\r\n    audioContext.resume().catch(() => {});\r\n  }\r\n}\r\n\r\nif (typeof window !== 'undefined') {\r\n  ['pointerdown', 'touchstart', 'click', 'keydown'].forEach(evt => {\r\n    window.addEventListener(evt, warm, { capture: true, passive: true });\r\n  });\r\n}\r\n\r\n/**\r\n * Loads and decodes audio from a URL.\r\n * @param {string} src - The URL of the audio file.\r\n * @returns {Promise<AudioBuffer|null>}\r\n */\r\nexport async function loadAudio(src) {\r\n  const ctx = getAudioContext();\r\n  if (!ctx) return null; // No Web Audio support\r\n\r\n  // Normalize URL\r\n  const url = new URL(src, document.baseURI).href;\r\n\r\n  if (buffers.has(url)) return buffers.get(url);\r\n  if (loadPromises.has(url)) return loadPromises.get(url);\r\n\r\n  const promise = (async () => {\r\n    try {\r\n      const resp = await fetch(url);\r\n      if (!resp.ok) throw new Error(`Failed to fetch ${url}`);\r\n      const arrayBuffer = await resp.arrayBuffer();\r\n      const decoded = await ctx.decodeAudioData(arrayBuffer);\r\n      buffers.set(url, decoded);\r\n      return decoded;\r\n    } catch (e) {\r\n      console.warn('[audioManager] Load failed', src, e);\r\n      return null;\r\n    } finally {\r\n      loadPromises.delete(url);\r\n    }\r\n  })();\r\n\r\n  loadPromises.set(url, promise);\r\n  return promise;\r\n}\r\n\r\n/**\r\n * Plays audio.\r\n * @param {string} src - The URL of the audio file.\r\n * @param {object} options\r\n * @param {number} [options.volume=1.0] - Playback volume (0.0 to 1.0).\r\n * @param {number} [options.detune=0] - Detune in cents.\r\n * @param {number} [options.playbackRate=1.0] - Playback rate.\r\n * @param {boolean} [options.loop=false] - Whether to loop.\r\n * @param {string} [options.type='sfx'] - 'sfx' or 'music'.\r\n */\r\nexport function playAudio(src, { volume = 1.0, detune = 0, playbackRate = 1.0, loop = false, type = 'sfx' } = {}) {\r\n  const ctx = getAudioContext();\r\n  const url = new URL(src, document.baseURI).href;\r\n  \r\n  // Try Web Audio first\r\n  if (ctx) {\r\n    if (ctx.state === 'suspended' && !document.hidden) ctx.resume().catch(()=>{});\r\n    \r\n    const buffer = buffers.get(url);\r\n    if (buffer) {\r\n        const source = ctx.createBufferSource();\r\n        source.buffer = buffer;\r\n        source.detune.value = detune;\r\n        source.playbackRate.value = playbackRate;\r\n        source.loop = loop;\r\n        \r\n        const gainNode = ctx.createGain();\r\n        gainNode.gain.value = volume;\r\n        \r\n        source.connect(gainNode);\r\n        \r\n        // Routing logic\r\n        if (type === 'music') {\r\n            gainNode.connect(musicFilter);\r\n        } else {\r\n            gainNode.connect(masterGain);\r\n        }\r\n\r\n        source.start(0);\r\n        return {\r\n            stop: () => {\r\n                try { source.stop(); } catch {}\r\n            },\r\n            source,\r\n            gainNode,\r\n            element: null // No HTML5 audio element\r\n        };\r\n    } else {\r\n        // Trigger load for next time\r\n        loadAudio(src);\r\n    }\r\n  }\r\n\r\n  // Fallback: HTML5 Audio (if Web Audio unavailable or buffer not loaded yet)\r\n  // Note: This might still have latency, but it's a fallback.\r\n  // Note: Fallback does NOT support the filter effect as it bypasses Web Audio graph.\r\n  try {\r\n      const a = new Audio(url);\r\n      a.volume = volume;\r\n      if (typeof a.playbackRate !== 'undefined') {\r\n          a.playbackRate = playbackRate;\r\n      }\r\n      a.loop = loop;\r\n      a.play().catch(() => {});\r\n      return {\r\n          stop: () => {\r\n              try { a.pause(); a.currentTime = 0; } catch {}\r\n          },\r\n          element: a\r\n      };\r\n  } catch(e) {\r\n      console.warn('[audioManager] Fallback play failed', e);\r\n  }\r\n  return null;\r\n}\r\n\r\n// Support for preloading from main.js (compatible signature if needed, or just use loadAudio)\r\nexport function registerPreloadedBuffer(src, buffer) {\r\n  const url = new URL(src, document.baseURI).href;\r\n  buffers.set(url, buffer);\r\n}\r\n\r\nexport function setAudioSuspended(suspended) {\r\n  if (audioContext) {\r\n    if (suspended) {\r\n      if (audioContext.state === 'running') audioContext.suspend().catch(()=>{});\r\n    } else {\r\n      if (audioContext.state === 'suspended') audioContext.resume().catch(()=>{});\r\n    }\r\n  }\r\n}\r\n\r\nexport function setMusicUnderwater(underwater) {\r\n    if (!musicFilter) return;\r\n    \r\n    // Instant transition as requested\r\n    const frequency = underwater ? 600 : 22050;\r\n    \r\n    // We can use setTargetAtTime for a tiny micro-fade to avoid pops, or just set value.\r\n    // Given \"Instant\", setting value directly or with a tiny time constant is best.\r\n    // 0 time constant is effectively instant.\r\n    \r\n    try {\r\n        const now = audioContext.currentTime;\r\n        musicFilter.frequency.cancelScheduledValues(now);\r\n        musicFilter.frequency.setValueAtTime(frequency, now);\r\n    } catch {\r\n        musicFilter.frequency.value = frequency;\r\n    }\r\n}\r\n", "// js/util/bigNum.js\r\nexport class BigNum {\r\n  static DEFAULT_PRECISION = 18;\r\n  static MAX_E = 1.7976931348623157e+308; // Number.MAX_VALUE\r\n  static MAX_PLAIN_DIGITS = 1_000_000;    // safety cap for plain integer strings\r\n\r\n  constructor(sig, e, p = BigNum.DEFAULT_PRECISION) {\r\n    this.p = p | 0;\r\n    this.sig = BigInt(sig);\r\n    this._eOffset = 0n;\r\n\r\n    if (e && typeof e === 'object' && ('base' in e || 'offset' in e || 'inf' in e)) {\r\n      const base = Number(e.base ?? 0);\r\n      const inf = !!e.inf;\r\n      if (inf || !Number.isFinite(base) || base >= BigNum.MAX_E) {\r\n        this.e = BigNum.MAX_E;\r\n        this.inf = true;\r\n        this._eOffset = 0n;\r\n      } else {\r\n        this.e = Math.trunc(base);\r\n        this.inf = false;\r\n        const off = e.offset ?? 0;\r\n        this._eOffset = typeof off === 'bigint' ? off : BigInt(off);\r\n      }\r\n    } else {\r\n      const ee = Number(e);\r\n      if (!Number.isFinite(ee) || ee >= BigNum.MAX_E) {\r\n        this.e = BigNum.MAX_E;\r\n        this.inf = true;\r\n      } else {\r\n        this.e = Math.trunc(ee);\r\n        this.inf = false;\r\n      }\r\n    }\r\n    this.#normalize();\r\n  }\r\n\r\n  // ---------------------- FACTORIES ----------------------\r\n  static zero(p = BigNum.DEFAULT_PRECISION) { return new BigNum(0n, 0, p); }\r\n\r\n  static fromInt(n, p = BigNum.DEFAULT_PRECISION) {\r\n    return new BigNum(BigInt(n), 0, p);\r\n  }\r\n\r\n  static fromScientific(str, p = BigNum.DEFAULT_PRECISION) {\r\n    const s = String(str ?? '').trim();\r\n    if (!s) throw new TypeError('Invalid BigNum input: ' + str);\r\n\r\n    if (/^inf(?:inity)?$/i.test(s)) {\r\n      return new BigNum(1n, BigNum.MAX_E, p);\r\n    }\r\n\r\n    const match = s.match(/^([+-]?\\d+)(?:\\.(\\d+))?(?:e([+-]?\\d+))?$/i);\r\n    if (!match) {\r\n      return new BigNum(BigInt(s), 0, p);\r\n    }\r\n\r\n    let [, intPart, fracPart = '', expPart] = match;\r\n    let exponent = expPart ? parseInt(expPart, 10) : 0;\r\n    exponent -= fracPart.length;\r\n\r\n    let sign = '';\r\n    let digitsRaw = intPart + fracPart;\r\n    if (digitsRaw.startsWith('-')) {\r\n        sign = '-';\r\n        digitsRaw = digitsRaw.slice(1);\r\n    } else if (digitsRaw.startsWith('+')) {\r\n        digitsRaw = digitsRaw.slice(1);\r\n    }\r\n\r\n    const digits = digitsRaw.replace(/^0+/, '') || '0';\r\n    const sig = BigInt(sign + digits);\r\n    return new BigNum(sig, exponent, p);\r\n  }\r\n\r\n  static fromStorage(str, p = BigNum.DEFAULT_PRECISION) {\r\n    if (!str) return null;\r\n    if (typeof str !== 'string') str = String(str);\r\n    if (str.startsWith('BN:')) {\r\n      const [, pStr, sigStr, eStr] = str.split(':');\r\n      const pp = parseInt(pStr, 10) || p;\r\n      let baseStr = eStr;\r\n      let offset = 0n;\r\n      const caret = eStr.indexOf('^');\r\n      if (caret >= 0) {\r\n        baseStr = eStr.slice(0, caret);\r\n        const offStr = eStr.slice(caret + 1) || '0';\r\n        try { offset = BigInt(offStr); }\r\n        catch { offset = 0n; }\r\n      }\r\n      let eNum = Number(baseStr);\r\n      if (!Number.isFinite(eNum)) eNum = BigNum.MAX_E;\r\n      return new BigNum(BigInt(sigStr), { base: eNum, offset }, pp);\r\n    }\r\n    return BigNum.fromScientific(str, p);\r\n  }\r\n\r\n  // Accepts: BigNum | \"BN:...\" | scientific string | number | bigint\r\n  static fromAny(input, p = BigNum.DEFAULT_PRECISION) {\r\n    if (input instanceof BigNum) return input;\r\n    if (typeof input === 'string') {\r\n      const trimmed = input.trim();\r\n      if (trimmed.startsWith('BN:')) return BigNum.fromStorage(trimmed, p);\r\n      if (/^inf(?:inity)?$/i.test(trimmed)) return new BigNum(1n, BigNum.MAX_E, p);\r\n      if (/^[+-]?\\d+(?:\\.\\d+)?(?:e[+-]?\\d+)?$/i.test(trimmed)) return BigNum.fromScientific(trimmed, p);\r\n    }\r\n    if (typeof input === 'number') {\r\n      if (!Number.isFinite(input)) return new BigNum(1n, BigNum.MAX_E, p);\r\n      return BigNum.fromScientific(input.toString(), p);\r\n    }\r\n    if (typeof input === 'bigint') return BigNum.fromInt(input, p);\r\n    throw new TypeError('Unsupported BigNum input: ' + input);\r\n    }\r\n\r\n  // ---------------------- PERSISTENCE ----------------------\r\n  toStorage() {\r\n    if (this.inf) return `BN:${this.p}:${this.sig.toString()}:${BigNum.MAX_E}`;\r\n    const offsetSuffix = this._eOffset !== 0n ? `^${this._eOffset.toString()}` : '';\r\n    return `BN:${this.p}:${this.sig.toString()}:${this.e}${offsetSuffix}`;\r\n  }\r\n\r\n  clone() {\r\n    return new BigNum(this.sig, { base: this.e, offset: this._eOffset, inf: this.inf }, this.p);\r\n  }\r\n\r\n  // ---------------------- STATE QUERIES ----------------------\r\n  isZero() { return !this.inf && this.sig === 0n; }\r\n  isInfinite() { return !!this.inf; }\r\n  isNegative() { return false; }\r\n\r\n  sub(b) {\r\n    b = BigNum.fromAny(b, this.p);\r\n\r\n    if (this.inf) {\r\n      if (b.inf) return BigNum.zero(this.p);\r\n      return this.clone();\r\n    }\r\n    if (b.isZero()) return this.clone();\r\n    if (b.inf) return BigNum.zero(this.p);\r\n\r\n    if (this.cmp(b) <= 0) return BigNum.zero(this.p);\r\n\r\n    const expCmp = this.#compareExponent(b);\r\n    if (expCmp >= 0) {\r\n      const aligned = expCmp === 0 ? b.sig : this.#alignSig(b);\r\n      const diffSig = this.sig - aligned;\r\n      if (diffSig > 0n) {\r\n        return new BigNum(diffSig, this.#expObj(), this.p);\r\n      }\r\n    }\r\n\r\n    try {\r\n      const aPlain = this.toPlainIntegerString();\r\n      const bPlain = b.toPlainIntegerString();\r\n      if (aPlain === 'Infinity') return this.clone();\r\n      if (bPlain === 'Infinity') return BigNum.zero(this.p);\r\n      const diff = BigInt(aPlain) - BigInt(bPlain);\r\n      if (diff <= 0n) return BigNum.zero(this.p);\r\n      return BigNum.fromInt(diff, this.p);\r\n    } catch {\r\n      return BigNum.zero(this.p);\r\n    }\r\n  }\r\n\r\n  // ---------------------- PRIVATE HELPERS ----------------------\r\n  #pow10(k) { return k <= 0 ? 1n : 10n ** BigInt(k); }\r\n\r\n  #expObj() {\r\n    return { base: this.e, offset: this._eOffset, inf: this.inf };\r\n  }\r\n\r\n  #adjustExponent(delta) {\r\n    if (this.inf || !delta) return;\r\n    const prev = this.e;\r\n    const next = prev + delta;\r\n    this.e = Math.trunc(next);\r\n    const applied = this.e - prev;\r\n    const leftover = BigInt(delta - applied);\r\n    if (leftover) this._eOffset += leftover;\r\n  }\r\n\r\n  #totalExponentBigInt() {\r\n    if (this.inf) return this._eOffset >= 0n ? BigInt(Number.MAX_SAFE_INTEGER) : -BigInt(Number.MAX_SAFE_INTEGER);\r\n    const base = BigInt(Math.trunc(this.e));\r\n    return base + this._eOffset;\r\n  }\r\n\r\n  #compareExponent(other) {\r\n    if (this.inf || other.inf) {\r\n      if (this.inf && other.inf) return 0;\r\n      return this.inf ? 1 : -1;\r\n    }\r\n    const a = this.#totalExponentBigInt();\r\n    const b = other.#totalExponentBigInt();\r\n    if (a > b) return 1;\r\n    if (a < b) return -1;\r\n    return 0;\r\n  }\r\n\r\n  #expDiff(other) {\r\n    if (this.inf || other.inf) {\r\n      if (this.inf && other.inf) return 0n;\r\n      return this.inf ? BigInt(this.p + 3) : -BigInt(this.p + 3);\r\n    }\r\n    const diff = this.#totalExponentBigInt() - other.#totalExponentBigInt();\r\n    const absDiff = diff < 0n ? -diff : diff;\r\n    const limit = BigInt(this.p + 2);\r\n    if (absDiff > limit) {\r\n      return diff > 0n ? BigInt(this.p + 3) : -BigInt(this.p + 3);\r\n    }\r\n    return diff;\r\n  }\r\n\r\n  #offsetAsNumber() {\r\n    if (this._eOffset === 0n) return 0;\r\n    const offNum = Number(this._eOffset);\r\n    if (!Number.isFinite(offNum) || !Number.isSafeInteger(offNum)) {\r\n      return offNum > 0 ? Number.POSITIVE_INFINITY : Number.NEGATIVE_INFINITY;\r\n    }\r\n    return offNum;\r\n  }\r\n\r\n  #effectiveExponentNumber() {\r\n    if (this.inf) return Number.POSITIVE_INFINITY;\r\n    const offset = this.#offsetAsNumber();\r\n    if (!Number.isFinite(offset)) return offset;\r\n    return this.e + offset;\r\n  }\r\n\r\n  #normalize() {\r\n    if (this.inf) return;\r\n    if (this.sig === 0n) { this.e = 0; return; }\r\n\r\n    let s = this.sig;\r\n    const p = this.p;\r\n    const d = s.toString().length;\r\n    const shift = d - p;\r\n\r\n    if (shift > 0) {\r\n      const base = this.#pow10(shift);\r\n      let q = s / base;\r\n      const r = s % base;\r\n      if (r * 2n >= base) q += 1n; // round half up\r\n      s = q;\r\n      this.#adjustExponent(shift);\r\n      if (this.e >= BigNum.MAX_E) { this.e = BigNum.MAX_E; this.inf = true; return; }\r\n      if (s.toString().length > p) { // carry overflow\r\n        s = s / 10n;\r\n        this.#adjustExponent(1);\r\n        if (this.e >= BigNum.MAX_E) { this.e = BigNum.MAX_E; this.inf = true; return; }\r\n      }\r\n    } else if (shift < 0) {\r\n      const k = -shift;\r\n      s = s * this.#pow10(k);\r\n      this.#adjustExponent(-k);\r\n    }\r\n\r\n    this.sig = s;\r\n  }\r\n\r\n  #alignSig(other) {\r\n    const diff = this.#expDiff(other);\r\n    const absDiff = diff < 0n ? -diff : diff;\r\n    if (absDiff === 0n) return other.sig;\r\n    if (absDiff > BigInt(this.p + 2)) return 0n; // negligible\r\n    const diffNum = Number(absDiff);\r\n    const base = this.#pow10(diffNum);\r\n    let q = other.sig / base;\r\n    const r = other.sig % base;\r\n    if (r * 2n >= base) q += 1n;\r\n    return q;\r\n  }\r\n\r\n  // ---------------------- ARITHMETIC ----------------------\r\n   add(b) {\r\n    b = BigNum.fromAny(b, this.p);\r\n    if (this.inf || b.inf) {\r\n      const out = this.clone(); out.inf = this.inf || b.inf; out.e = BigNum.MAX_E; return out;\r\n    }\r\n    if (this.isZero()) return b.clone();\r\n    if (b.isZero()) return this.clone();\r\n    if (this.#compareExponent(b) >= 0) {\r\n      return new BigNum(this.sig + this.#alignSig(b), this.#expObj(), this.p);\r\n    }\r\n    return b.add(this);\r\n  }\r\n\r\n  iadd(b) { const r = this.add(b); this.sig = r.sig; this.e = r.e; this._eOffset = r._eOffset; this.inf = r.inf; return this; }\r\n\r\n  mulSmall(k) {\r\n    if (k < 0) throw new Error('BigNum only supports non-negative values');\r\n    if (this.inf) return this.clone();\r\n    if (k === 0) return BigNum.zero(this.p);\r\n    if (k === 1) return this.clone();\r\n    const out = new BigNum(this.sig * BigInt(k), this.#expObj(), this.p);\r\n    return out;\r\n  }\r\n\r\n  imulSmall(k) { const r = this.mulSmall(k); this.sig = r.sig; this.e = r.e; this._eOffset = r._eOffset; this.inf = r.inf; return this; }\r\n\r\n  // Multiply by another non-negative integer BigNum (exact).\r\n  mulBigNumInteger(other) {\r\n    const b = BigNum.fromAny(other, this.p);\r\n    if (this.inf || b.inf) {\r\n      const out = this.clone();\r\n      out.inf = this.inf || b.inf;\r\n      out.e = BigNum.MAX_E;\r\n      return out;\r\n    }\r\n    if (this.isZero() || b.isZero()) return BigNum.zero(this.p);\r\n    const baseSum = this.e + b.e;\r\n    const offsetSum = this._eOffset + b._eOffset;\r\n    return new BigNum(this.sig * b.sig, { base: baseSum, offset: offsetSum }, this.p);\r\n  }\r\n\r\n  imulBigNumInteger(other) {\r\n    const r = this.mulBigNumInteger(other);\r\n    this.sig = r.sig; this.e = r.e; this._eOffset = r._eOffset; this.inf = r.inf;\r\n    return this;\r\n  }\r\n\r\n  // Divide by another BigNum (returns new BigNum).\r\n  div(other) {\r\n    const b = BigNum.fromAny(other, this.p);\r\n    \r\n    // Handle infinite cases\r\n    if (this.inf) {\r\n        if (b.inf) return new BigNum(1n, 0, this.p); // inf / inf -> 1 (or undefined, but 1 is safer for ratios)\r\n        return this.clone(); // inf / finite -> inf\r\n    }\r\n    if (b.inf) {\r\n        return BigNum.zero(this.p); // finite / inf -> 0\r\n    }\r\n    \r\n    // Handle zero cases\r\n    if (b.isZero()) {\r\n        // finite / 0 -> infinity (mathematically undefined but useful here)\r\n        return new BigNum(1n, BigNum.MAX_E, this.p);\r\n    }\r\n    if (this.isZero()) {\r\n        return BigNum.zero(this.p); // 0 / finite -> 0\r\n    }\r\n\r\n    // A / B = (sigA * 10^expA) / (sigB * 10^expB)\r\n    //       = (sigA / sigB) * 10^(expA - expB)\r\n    // To maintain precision, we scale sigA by 10^precision before integer division.\r\n    // result = (sigA * 10^p / sigB) * 10^(expA - expB - p)\r\n    \r\n    const scale = this.#pow10(this.p);\r\n    const numerator = this.sig * scale;\r\n    const sigQuotient = numerator / b.sig; // Integer division\r\n    \r\n    // Exponent calculation:\r\n    // We used 'this.e' and 'b.e' for base exponents, plus offsets.\r\n    // However, BigNum normalization ensures sig is roughly 10^(p-1) to 10^p.\r\n    // So the exponent math is mostly correct if we trust .e and ._eOffset.\r\n    \r\n    // The raw exponent difference:\r\n    const expDiffBase = BigInt(this.e) - BigInt(b.e);\r\n    const expDiffOffset = this._eOffset - b._eOffset;\r\n    \r\n    // Adjust for the scaling we did (subtracting p from the exponent because we added it to sig)\r\n    const pBigInt = BigInt(this.p);\r\n    const totalExpBase = expDiffBase - pBigInt;\r\n    \r\n    // Construct new BigNum\r\n    // We pass the total exponent info. The constructor/normalization will handle if sigQuotient is small/large.\r\n    \r\n    // We need to fit totalExpBase + expDiffOffset into {base, offset}.\r\n    // base is a Number, offset is a BigInt.\r\n    \r\n    // Try to put as much as possible into 'base' (Number) to keep offset small if possible,\r\n    // though normalization handles it.\r\n    \r\n    // Safe conversion of expDiffBase to Number?\r\n    // expDiffBase can be large if inputs are large.\r\n    \r\n    // Let's just put everything into offset first, then let constructor handle it?\r\n    // Constructor expects 'base' to be Number.\r\n    \r\n    let resultBase = Number(totalExpBase);\r\n    let resultOffset = expDiffOffset;\r\n    \r\n    if (!Number.isSafeInteger(resultBase)) {\r\n         // If base is too large/small for Number, move it to offset.\r\n         resultOffset += totalExpBase;\r\n         resultBase = 0;\r\n    }\r\n    \r\n    return new BigNum(sigQuotient, { base: resultBase, offset: resultOffset }, this.p);\r\n  }\r\n\r\n  cmp(b) {\r\n    b = BigNum.fromAny(b, this.p);\r\n    if (this.inf || b.inf) return this.inf === b.inf ? 0 : this.inf ? 1 : -1;\r\n    const thisIsZero = this.isZero();\r\n    const otherIsZero = typeof b.isZero === 'function' ? b.isZero() : false;\r\n    if (thisIsZero || otherIsZero) {\r\n      if (thisIsZero && otherIsZero) return 0;\r\n      return thisIsZero ? -1 : 1;\r\n    }\r\n    const expCmp = this.#compareExponent(b);\r\n    if (expCmp !== 0) return expCmp;\r\n    if (this.sig === b.sig) return 0;\r\n    return this.sig > b.sig ? 1 : -1;\r\n  }\r\n  // ----- Decimal multiply (exact, integer-safe) & flooring -----\r\n\r\n  // Parse decimal like \"2.345\" (or number) into { numer: BigInt, scale: int } with up to maxScale frac digits.\r\n  static _parseDecimalMultiplier(x, maxScale = BigNum.DEFAULT_PRECISION) {\r\n    let s = (typeof x === 'number') ? String(x) : String(x ?? '').trim();\r\n    if (!s || s === '0') return { numer: 0n, scale: 0 };\r\n\r\n    // normalize scientific like \"1e3\" to fixed decimal string\r\n    if (/e/i.test(s)) {\r\n      const n = Number(s);\r\n      if (!Number.isFinite(n) || n < 0) throw new TypeError('Invalid multiplier: ' + s);\r\n      const digits = Math.min(maxScale, 18);\r\n      s = n.toFixed(digits).replace(/\\.?0+$/, ''); // strip trailing zeros\r\n    }\r\n\r\n    if (!/^\\d+(\\.\\d+)?$/.test(s)) throw new TypeError('Invalid multiplier: ' + s);\r\n\r\n    const [intPart, fracRaw = ''] = s.split('.');\r\n    const frac = fracRaw.slice(0, maxScale); // clamp fractional length\r\n    const scale = frac.length;\r\n    const numer = BigInt(intPart + frac);\r\n    return { numer, scale };\r\n  }\r\n\r\n  // Multiply by decimal multiplier given as number/string with up to 18 fractional digits (returns new BigNum).\r\n  mulDecimal(mult, maxScale = BigNum.DEFAULT_PRECISION) {\r\n    if (this.inf || this.isZero()) return this.clone();\r\n    const { numer, scale } = BigNum._parseDecimalMultiplier(mult, maxScale);\r\n    if (numer === 0n) return BigNum.zero(this.p);\r\n    return this.mulScaledInt(numer, scale);\r\n  }\r\n\r\n  // Floor to integer value by dropping fractional digits.\r\n  floorToInteger() {\r\n    if (this.inf) return this.clone();\r\n    if (this.isZero()) return this.clone();\r\n    const exp = this.#effectiveExponentNumber();\r\n    if (!Number.isFinite(exp)) return this.clone();\r\n    const intDigits = exp + this.p; // integer digits in the value\r\n    if (intDigits <= 0) return BigNum.zero(this.p); // < 1\r\n    if (intDigits >= this.p) return this.clone();   // already integral\r\n    const drop = this.p - intDigits;                // digits to truncate\r\n    const base = 10n ** BigInt(drop);\r\n    const newSig = (this.sig / base) * base;        // drop fractional digits\r\n    return new BigNum(newSig, this.#expObj(), this.p);\r\n  }\r\n\r\n  // Convenience: multiply by decimal and floor to integer immediately.\r\n  mulDecimalFloor(mult, maxScale = BigNum.DEFAULT_PRECISION) {\r\n    return this.mulDecimal(mult, maxScale).floorToInteger();\r\n  }\r\n\r\n  mulScaledInt(numerBigInt, scale) {\r\n    if (this.inf || this.isZero()) return this.clone();\r\n    const nb = BigInt(numerBigInt);\r\n    if (nb === 0n) return BigNum.zero(this.p);\r\n    return new BigNum(this.sig * nb, { base: this.e - (scale | 0), offset: this._eOffset }, this.p);\r\n  }\r\n\r\n  // Same as above but floors to an integer.\r\n  mulScaledIntFloor(numerBigInt, scale) {\r\n    return this.mulScaledInt(numerBigInt, scale).floorToInteger();\r\n  }\r\n\r\n  // ---------------------- FORMATTING ----------------------\r\n  get decExp() {\r\n    if (this.inf) return Number.POSITIVE_INFINITY;\r\n    const exp = this.#effectiveExponentNumber();\r\n    if (!Number.isFinite(exp)) return exp;\r\n    return exp + (this.p - 1);\r\n  }\r\n\r\n  toScientific(digits = 3) {\r\n    if (this.inf) return 'Infinity';\r\n    if (this.isZero()) return '0';\r\n    const s = this.sig.toString().padStart(this.p, '0');\r\n    const head = s[0];\r\n    const tail = s.slice(1, 1 + digits).replace(/0+$/g, '');\r\n    const mant = tail ? `${head}.${tail}` : head;\r\n    \r\n    const offsetNum = this.#offsetAsNumber();\r\n    if (Number.isFinite(offsetNum)) {\r\n        const exp = this.e + offsetNum;\r\n        const E = exp + (this.p - 1);\r\n        return `${mant}e${E}`;\r\n    } else {\r\n        const totalExp = BigInt(this.e) + this._eOffset + BigInt(this.p - 1);\r\n        return `${mant}e${totalExp.toString()}`;\r\n    }\r\n  }\r\n\r\n  toPlainIntegerString() {\r\n    if (this.inf) return 'Infinity';\r\n    if (this.isZero()) return '0';\r\n    const exp = this.#effectiveExponentNumber();\r\n    if (!Number.isFinite(exp)) return exp > 0 ? 'Infinity' : '0';\r\n    const intDigits = exp + this.p;\r\n    if (intDigits <= 0) return '0';\r\n    if (intDigits > BigNum.MAX_PLAIN_DIGITS) return 'Infinity';\r\n\r\n    const s = this.sig.toString().padStart(this.p, '0');\r\n    if (intDigits <= this.p) {\r\n      return s.slice(0, intDigits).replace(/^0+/, '') || '0';\r\n    }\r\n\r\n    const extraZeros = intDigits - this.p;\r\n    return (s + '0'.repeat(extraZeros)).replace(/^0+/, '') || '0';\r\n  }\r\n\r\n  toString() {\r\n    return this.toPlainIntegerString();\r\n  }\r\n}\r\n\r\n// --- BigNum Utilities ---\r\n\r\nexport function approxLog10BigNum(value) {\r\n  if (!(value instanceof BigNum)) {\r\n    try {\r\n      value = BigNum.fromAny(value ?? 0);\r\n    } catch {\r\n      return Number.NEGATIVE_INFINITY;\r\n    }\r\n  }\r\n  if (!value) return Number.NEGATIVE_INFINITY;\r\n  if (value.isZero?.()) return Number.NEGATIVE_INFINITY;\r\n  if (value.isInfinite?.()) return Number.POSITIVE_INFINITY;\r\n\r\n  if (typeof value.sig === 'bigint') {\r\n    const sigNum = Number(value.sig);\r\n    if (sigNum > 0) {\r\n      const sigLog = Math.log10(sigNum);\r\n      const e = value.e || 0;\r\n      const off = Number(value._eOffset || 0n);\r\n      return sigLog + e + off;\r\n    }\r\n  }\r\n\r\n  let storage;\r\n  try {\r\n    storage = value.toStorage();\r\n  } catch {\r\n    return Number.NEGATIVE_INFINITY;\r\n  }\r\n  const parts = storage.split(':');\r\n  const sigStr = parts[2] ?? '0';\r\n  let expPart = parts[3] ?? '0';\r\n  let offsetStr = '0';\r\n  const caret = expPart.indexOf('^');\r\n  if (caret >= 0) {\r\n    offsetStr = expPart.slice(caret + 1) || '0';\r\n    expPart = expPart.slice(0, caret) || '0';\r\n  }\r\n  const baseExp = Number(expPart || '0');\r\n  const offset = Number(offsetStr || '0');\r\n  const digits = sigStr.replace(/^0+/, '') || '0';\r\n  if (digits === '0') return Number.NEGATIVE_INFINITY;\r\n\r\n  let sigLog;\r\n  if (digits.length <= 15) {\r\n    const sigNum = Number(digits);\r\n    if (!Number.isFinite(sigNum) || sigNum <= 0) return Number.NEGATIVE_INFINITY;\r\n    sigLog = Math.log10(sigNum);\r\n  } else {\r\n    const head = Number(digits.slice(0, 15));\r\n    if (!Number.isFinite(head) || head <= 0) return Number.NEGATIVE_INFINITY;\r\n    sigLog = Math.log10(head) + (digits.length - 15);\r\n  }\r\n\r\n  const expSum = (Number.isFinite(baseExp) ? baseExp : 0) + (Number.isFinite(offset) ? offset : 0);\r\n  return sigLog + expSum;\r\n}\r\n\r\nexport function bigNumFromLog10(log10Value) {\r\n  if (!Number.isFinite(log10Value)) {\r\n    return log10Value > 0 ? BigNum.fromAny('Infinity') : BigNum.fromInt(0);\r\n  }\r\n  \r\n  if (log10Value <= -1e12) return BigNum.fromInt(0);\r\n  const p = BigNum.DEFAULT_PRECISION;\r\n  let intPart = Math.floor(log10Value);\r\n  let frac = log10Value - intPart;\r\n  if (frac < 0) {\r\n    frac += 1;\r\n    intPart -= 1;\r\n  }\r\n  const mantissa = Math.pow(10, frac + (p - 1));\r\n  const sig = BigInt(Math.max(1, Math.round(mantissa)));\r\n  const exp = intPart - (p - 1);\r\n  return new BigNum(sig, exp, p);\r\n}\r\n\r\nconst LN10 = Math.log(10);\r\n\r\nexport function log10OnePlusPow10(exponent) {\r\n  if (!Number.isFinite(exponent)) {\r\n    if (exponent > 0) return exponent;\r\n    if (exponent === 0) return Math.log10(2);\r\n    return 0;\r\n  }\r\n  if (exponent > 308) return exponent;\r\n  if (exponent < -20) {\r\n    const pow = Math.pow(10, exponent);\r\n    return pow / LN10;\r\n  }\r\n  const pow = Math.pow(10, exponent);\r\n  if (!Number.isFinite(pow)) return exponent > 0 ? exponent : 0;\r\n  return Math.log1p(pow) / LN10;\r\n}\r\n", "// js/util/numFormat.js\r\n// Policy:\r\n//  - < 1e6: plain integer using the user's locale (grouping)\r\n//  - 1e6 .. < 1e303: suffix table (\"M,B,T,Qd,...\") with FOUR visible digits\r\n//  - >= 1e303: scientific, but with a pretty *recursive* exponent\r\n//\r\n// Also prettifies the exponent itself (e.g., 1.000e1,000 / 1.000e1.000Qd / 1.000e1.000e308)\r\n\r\nimport { BigNum, approxLog10BigNum } from './bigNum.js';\r\n\r\n// Suffixes copied from CCC (descending exponents).\r\nconst SUFFIX_ENTRIES = [\r\n  [300,'NoNg'],[297,'OcNg'],[294,'SpNg'],[291,'SxNg'],[288,'QnNg'],[285,'QdNg'],[282,'TNg'],[279,'DNg'],[276,'UNg'],[273,'Ng'],\r\n  [270,'NoOg'],[267,'OcOg'],[264,'SpOg'],[261,'SxOg'],[258,'QnOg'],[255,'QdOg'],[252,'TOg'],[249,'DOg'],[246,'UOg'],[243,'Og'],\r\n  [240,'NoSg'],[237,'OcSg'],[234,'SpSg'],[231,'SxSg'],[228,'QnSg'],[225,'QdSg'],[222,'TSg'],[219,'DSg'],[216,'USg'],[213,'Sg'],\r\n  [210,'Nosg'],[207,'Ocsg'],[204,'Spsg'],[201,'Sxsg'],[198,'Qnsg'],[195,'Qdsg'],[192,'Tsg'],[189,'Dsg'],[186,'Usg'],[183,'sg'],\r\n  [180,'NoQg'],[177,'OcQg'],[174,'SpQg'],[171,'SxQg'],[168,'QnQg'],[165,'QdQg'],[162,'TQg'],[159,'DQg'],[156,'UQg'],[153,'Qg'],\r\n  [150,'Noqg'],[147,'Ocqg'],[144,'Spqg'],[141,'Sxqg'],[138,'Qnqg'],[135,'Qdqg'],[132,'Tqg'],[129,'Dqg'],[126,'Uqg'],[123,'qg'],\r\n  [120,'NoTg'],[117,'OcTg'],[114,'SpTg'],[111,'SxTg'],[108,'QnTg'],[105,'QdTg'],[102,'TTg'],[99,'DTg'],[96,'UTg'],[93,'Tg'],\r\n  [90,'NoVt'],[87,'OcVt'],[84,'SpVt'],[81,'SxVt'],[78,'QnVt'],[75,'QdVt'],[72,'TVt'],[69,'DVt'],[66,'UVt'],[63,'Vt'],\r\n  [60,'NoDe'],[57,'OcDe'],[54,'SpDe'],[51,'SxDe'],[48,'QnDe'],[45,'QdDe'],[42,'TDe'],[39,'DDe'],[36,'UDe'],[33,'De'],\r\n  [30,'No'],[27,'Oc'],[24,'Sp'],[21,'Sx'],[18,'Qn'],[15,'Qd'],[12,'T'],[9,'B'],[6,'M']\r\n];\r\nconst SUFFIX_BY_EXP = new Map(SUFFIX_ENTRIES);\r\n\r\nconst NF_INT = new Intl.NumberFormat(undefined, { maximumFractionDigits: 0, useGrouping: true });\r\nfunction localeInt(s) {\r\n  const num = Number(s);\r\n\r\n  // Safari throws a RangeError when formatting non-finite values via Intl.NumberFormat;\r\n  // treat them as plain strings instead so the UI doesn't silently break on mobile.\r\n  if (!Number.isFinite(num)) return String(s);\r\n\r\n  try { return NF_INT.format(num); }\r\n  catch { return String(s); }\r\n}\r\n\r\n// --- add 1 to a decimal digit-string (for rounding) ---\r\nfunction addOneDigitString(str){\r\n  let carry = 1, a = str.split('');\r\n  for (let i = a.length - 1; i >= 0 && carry; i--) {\r\n    let d = a[i].charCodeAt(0) - 48 + carry;\r\n    carry = d >= 10 ? 1 : 0;\r\n    a[i] = String.fromCharCode(48 + (d % 10));\r\n  }\r\n  if (carry) a.unshift('1');\r\n  return a.join('');\r\n}\r\n\r\nfunction formatExponentString(rawDigits, sign = '') {\r\n  let ds = (rawDigits || '').replace(/^0+/, '') || '0';\r\n\r\n  if (ds.length < 4) return sign + localeInt(ds);          // < 1,000\r\n  if (ds.length <= 7) {                                     // 1,000 .. 1,000,000\r\n    const n = Number(ds);\r\n    if (Number.isFinite(n) && n <= 1_000_000) return sign + NF_INT.format(n);\r\n  }\r\n\r\n  const E = ds.length - 1;\r\n\r\n  if (E <= 300) {\r\n    const exp = Math.floor(E / 3) * 3;\r\n    const suffix = SUFFIX_BY_EXP.get(exp) || '';\r\n    const d = E - exp;              // 0..2\r\n    const intDigits = d + 1;        // 1..3\r\n    const decimals = 4 - intDigits; // to keep FOUR visible digits\r\n    const totalDigits = intDigits + decimals;\r\n\r\n    if (ds.length < totalDigits + 1) ds += '0'.repeat(totalDigits + 1 - ds.length);\r\n    let head = ds.slice(0, totalDigits);\r\n    const nextDigit = ds.charCodeAt(totalDigits) || 48;\r\n    if (nextDigit >= 53) head = addOneDigitString(head);\r\n\r\n    let intStr, fracStr;\r\n    if (head.length > totalDigits) { intStr = head.slice(0, intDigits + 1); fracStr = '0'.repeat(decimals); }\r\n    else { intStr = head.slice(0, intDigits); fracStr = head.slice(intDigits); }\r\n\r\n    return sign + `${intStr}${decimals ? '.' + fracStr : ''}${suffix}`;\r\n  }\r\n\r\n  // Beyond our table: show scientific-within-exponent with FOUR-digit mantissa\r\n  const totalDigits = 4; // 1 integer + 3 decimals\r\n  if (ds.length < totalDigits + 1) ds += '0'.repeat(totalDigits + 1 - ds.length);\r\n  let head = ds.slice(0, totalDigits);\r\n  const nextDigit = ds.charCodeAt(totalDigits) || 48;\r\n  if (nextDigit >= 53) head = addOneDigitString(head);\r\n\r\n  const mantInt  = head.slice(0, 1);\r\n  const mantFrac = head.slice(1);\r\n  return sign + `${mantInt}.${mantFrac}e` + formatExponentString(String(E));\r\n}\r\n\r\nfunction formatPowerOf10Exponent(kDigits, sign = '') {\r\n  // Fast path to detect k \u2265 303 without bigints\r\n  let ge303 = false, k = 0;\r\n  if (kDigits.length > 3) ge303 = true;\r\n  else { k = parseInt(kDigits || '0', 10) || 0; ge303 = (k >= 303); }\r\n\r\n  if (ge303) {\r\n    // Scientific inside exponent; pretty-format k itself (locale + suffix rules)\r\n    return sign + '1.000e' + formatExponentString(kDigits);\r\n  }\r\n\r\n  // 0..302 \u2192 suffix tier plus remainder-driven mantissa\r\n  const exp = Math.floor(k / 3) * 3;          // 0,3,6,...,300\r\n  const suffix = SUFFIX_BY_EXP.get(exp) || '';\r\n\r\n  const remainder = k - exp;                   // 0,1,2\r\n  // FOUR visible digits before the suffix:\r\n  //  r=0 \u2192 \"1.000\", r=1 \u2192 \"10.00\", r=2 \u2192 \"100.0\"\r\n  const intPart   = (remainder === 0) ? '1' : (remainder === 1) ? '10' : '100';\r\n  const decimals  = 4 - (remainder + 1);      // 3,2,1\r\n  const fracPart  = decimals ? ('.' + '0'.repeat(decimals)) : '';\r\n\r\n  return sign + intPart + fracPart + suffix;\r\n}\r\n\r\nfunction formatExponentChain(expRaw) {\r\n  expRaw = String(expRaw).trim();\r\n\r\n  // Optional leading sign on the whole exponent; suppress '+'\r\n  let topSign = '';\r\n  if (expRaw[0] === '+' || expRaw[0] === '-') {\r\n    topSign = (expRaw[0] === '-') ? '-' : '';\r\n    expRaw = expRaw.slice(1);\r\n  }\r\n\r\n  // Case A: pure digits (e.g., \"...e305\") \u2192 delegate to our big-int pretty printer\r\n  if (/^\\d+$/.test(expRaw)) return topSign + formatExponentString(expRaw);\r\n\r\n  // Case B: scientific inside the exponent: \"m e \u00B1 k\"\r\n  const m = expRaw.match(/^(\\d+)(?:\\.(\\d+))?e([+-]?)(\\d+)$/i);\r\n  if (!m) return topSign + expRaw; // unknown form \u2192 keep as-is\r\n\r\n  const [, int, frac = '', sign2, kDigits] = m;\r\n\r\n  // Is k >= 303? (length check avoids unsafe parse)\r\n  let kGe303 = false, k = 0;\r\n  if (kDigits.length > 3) kGe303 = true;\r\n  else { k = parseInt(kDigits || '0', 10) || 0; kGe303 = (k >= 303); }\r\n\r\n  // First, compute a FOUR-digit mantissa from m (rounded)\r\n  // We'll shift the decimal by (k % 3) for suffix-tiers.\r\n  let ds = (int + frac).replace(/^0+/, '') || '0';\r\n  if (ds.length < 5) ds += '0'.repeat(5 - ds.length);\r\n  let four = ds.slice(0, 4);\r\n  const next = ds.charCodeAt(4) || 48;\r\n  if (next >= 53) four = addOneDigitString(four); // handle rounding carry later\r\n\r\n  if (kGe303) {\r\n    // Beyond our suffix table inside the exponent \u2192 scientific-of-exponent\r\n    // Keep the (rounded) exponent mantissa (\"3.617\") and pretty-format k itself.\r\n    const mant = four.slice(0,1) + '.' + four.slice(1);\r\n    const sign2Prefix = (sign2 === '-') ? '-' : '';\r\n    return topSign + mant + 'e' + formatExponentString(kDigits, sign2Prefix);\r\n  }\r\n\r\n  // Within our suffix table: choose suffix and place the decimal based on remainder\r\n  const exp = Math.floor(k / 3) * 3;          // 0,3,6,...,300\r\n  const suffix = SUFFIX_BY_EXP.get(exp) || '';\r\n  const remainder = k - exp;                   // 0,1,2\r\n\r\n  // Shift decimal: r=0 \u2192 \"1.234\", r=1 \u2192 \"12.34\", r=2 \u2192 \"123.4\"\r\n  const intDigits = remainder + 1;             // 1..3\r\n  const decimals  = 4 - intDigits;             // 3..1\r\n  let intStr, fracStr;\r\n  if (four.length > 4) { // carry overflow \u2192 one extra int digit, pad decimals with zeros\r\n    intStr = four.slice(0, intDigits + 1);\r\n    fracStr = '0'.repeat(decimals);\r\n  } else {\r\n    intStr = four.slice(0, intDigits);\r\n    fracStr = four.slice(intDigits);\r\n  }\r\n\r\n  const sign2Prefix = (sign2 === '-') ? '-' : '';\r\n  return topSign + sign2Prefix + intStr + (decimals ? ('.' + fracStr) : '') + suffix;\r\n}\r\n\r\n /* Ensures the mantissa is always  4 digits */\r\nfunction mantissaFourDigits(sci) {\r\n  const i = sci.toLowerCase().indexOf('e');\r\n  if (i < 0) return sci;\r\n\r\n  // --- Normalize mantissa to exactly 4 significant digits (1.xxx) with rounding ---\r\n  const rawMant = sci.slice(0, i);           // e.g., \"3.2\", \"12.34\" (should be 1.x form from toScientific)\r\n  // Build digit string (no dot)\r\n  let ds = rawMant.replace('.', '');\r\n  if (!/^\\d+$/.test(ds)) return sci;         // safety: if parsing failed, bail out\r\n\r\n  // Pad to at least 5 digits (4 kept + 1 for rounding)\r\n  if (ds.length < 5) ds += '0'.repeat(5 - ds.length);\r\n\r\n  // First 4 digits are kept (rounded by the 5th)\r\n  let head = ds.slice(0, 4);\r\n  const next = ds.charCodeAt(4) || 48;       // '0' if missing\r\n  if (next >= 53) head = addOneDigitString(head);\r\n\r\n  // If carry overflow happened (e.g., 9.999 -> 10.00), re-normalize to 1.xxx by shifting\r\n  if (head.length > 4) head = head.slice(0, 4); // head is now \"1000\" after carry; that still prints as \"1.000\" below\r\n\r\n  const mantissa = head.slice(0,1) + '.' + head.slice(1); // \"1.234\" style with trailing zeros preserved\r\n\r\n  // --- Pretty-format the exponent tail (can be \"305\" or \"1e+100\" etc.) ---\r\n  const rawExp = sci.slice(i + 1);\r\n  return mantissa + 'e' + formatExponentChain(rawExp);\r\n}\r\n\r\n// Public API\r\nexport function formatNumber(bn){\r\n  if (!(bn instanceof BigNum)) return String(bn);\r\n  if (bn.isInfinite && bn.isInfinite()) return '<span class=\"infinity-symbol\">\u221E</span>';\r\n  if (bn.isZero()) return '0';\r\n\r\n  const E = bn.decExp ?? (bn.e + (bn.p - 1)); // decimal exponent\r\n\r\n  // Scientific for >= 1e303 (but pretty-print the exponent chain)\r\n  if (E >= 303) {\r\n    return mantissaFourDigits(bn.toScientific(3));\r\n  }\r\n\r\n  // Plain integers < 1e6 \u2192 locale grouping\r\n  if (E < 6) {\r\n    return localeInt(bn.toPlainIntegerString());\r\n  }\r\n\r\n  // Suffix formatting using the legacy table\r\n  const exp = Math.floor(E / 3) * 3;\r\n  const suffix = SUFFIX_BY_EXP.get(exp);\r\n  if (!suffix) return mantissaFourDigits(bn.toScientific(3));\r\n\r\n  const d = E - exp;                 // 0..2\r\n  const intDigits = d + 1;           // 1..3\r\n  const decimals  = 4 - intDigits;   // make FOUR visible digits\r\n  const totalDigits = intDigits + decimals;\r\n\r\n  let s = bn.sig.toString().padStart(bn.p, '0');\r\n  if (s.length < totalDigits + 1) s += '0'.repeat(totalDigits + 1 - s.length);\r\n\r\n  let head = s.slice(0, totalDigits);\r\n  const nextDigit = s.charCodeAt(totalDigits) || 48;\r\n  if (nextDigit >= 53) head = addOneDigitString(head);\r\n\r\n  let intStr, fracStr;\r\n  if (head.length > totalDigits) { intStr = head.slice(0, intDigits + 1); fracStr = '0'.repeat(decimals); }\r\n  else { intStr = head.slice(0, intDigits); fracStr = head.slice(intDigits); }\r\n\r\n  return `${intStr}${decimals ? '.' + fracStr : ''}${suffix}`;\r\n}\r\n\r\nexport function formatMultForUi(value) {\r\n  try {\r\n    if (value && (value instanceof BigNum || value.toPlainIntegerString)) {\r\n      const log10 = approxLog10BigNum(value);\r\n      if (Number.isFinite(log10) && log10 < 3) {\r\n        const approx = Math.pow(10, log10);\r\n        return String(approx.toFixed(3))\r\n          .replace(/\\.0+$/, '')\r\n          .replace(/(\\.\\d*?)0+$/, '$1');\r\n      }\r\n      return formatNumber(value);\r\n    }\r\n\r\n    const n = Number(value) || 0;\r\n    if (Math.abs(n) < 1000) {\r\n      return String(n.toFixed(3))\r\n        .replace(/\\.0+$/, '')\r\n        .replace(/(\\.\\d*?)0+$/, '$1');\r\n    }\r\n    return formatNumber(BigNum.fromAny(n));\r\n  } catch {\r\n    return '1';\r\n  }\r\n}\r\n", "// js/util/storage.js\r\nimport { BigNum } from '../util/bigNum.js';\r\nimport { formatNumber } from '../util/numFormat.js';\r\n\r\nconst PREFIX = 'ccc:';\r\nexport const STORAGE_PREFIX = PREFIX;\r\n\r\nconst SLOT_SIGNATURE_PREFIX = `${PREFIX}slotSig`;\r\nconst SLOT_MODIFIED_PREFIX = `${PREFIX}slotMod`;\r\n\r\nconst MULT_SCALE = 18;\r\nconst MULT_SCALE_TAG = 'XM:';\r\n\r\nconst STORAGE_WATCH_INTERVAL_MS = 140;\r\n\r\nconst storageWatchers = new Map();\r\nlet storageWatcherTimer = null;\r\n\r\nconst currencyChangeSubscribers = new Set();\r\n\r\nfunction normalizeSlotValue(slot) {\r\n  const n = parseInt(slot, 10);\r\n  return Number.isFinite(n) && n > 0 ? n : null;\r\n}\r\n\r\nfunction slotSignatureKey(slot) {\r\n  const normalized = normalizeSlotValue(slot);\r\n  if (normalized == null) return null;\r\n  return `${SLOT_SIGNATURE_PREFIX}:${normalized}`;\r\n}\r\n\r\nfunction slotModifiedKey(slot) {\r\n  const normalized = normalizeSlotValue(slot);\r\n  if (normalized == null) return null;\r\n  return `${SLOT_MODIFIED_PREFIX}:${normalized}`;\r\n}\r\n\r\nfunction notifyCurrencySubscribers(detail = {}) {\r\n  if (currencyChangeSubscribers.size === 0) return;\r\n  currencyChangeSubscribers.forEach((entry) => {\r\n    if (!entry || typeof entry.handler !== 'function') return;\r\n    if (entry.key && detail.key && entry.key !== detail.key) return;\r\n    if (entry.slot != null && detail.slot != null && entry.slot !== detail.slot) return;\r\n    try { entry.handler(detail); }\r\n    catch {}\r\n  });\r\n}\r\n\r\nexport function onCurrencyChange(handler, { key = null, slot = null } = {}) {\r\n  if (typeof handler !== 'function') {\r\n    return () => {};\r\n  }\r\n  const entry = {\r\n    handler,\r\n    key: key ?? null,\r\n    slot: slot ?? null,\r\n  };\r\n  currencyChangeSubscribers.add(entry);\r\n  return () => {\r\n    currencyChangeSubscribers.delete(entry);\r\n  };\r\n}\r\n\r\nfunction ensureStorageWatcherTimer() {\r\n  if (storageWatcherTimer != null || storageWatchers.size === 0) return;\r\n  const root = typeof window !== 'undefined' ? window : globalThis;\r\n  storageWatcherTimer = root.setInterval(runStorageWatchers, STORAGE_WATCH_INTERVAL_MS);\r\n}\r\n\r\nfunction stopStorageWatcherTimerIfIdle() {\r\n  if (storageWatchers.size !== 0 || storageWatcherTimer == null) return;\r\n  const root = typeof window !== 'undefined' ? window : globalThis;\r\n  root.clearInterval(storageWatcherTimer);\r\n  storageWatcherTimer = null;\r\n}\r\n\r\nfunction parseWith(entry, raw) {\r\n  if (!entry || typeof entry.parse !== 'function') return raw;\r\n  try {\r\n    return entry.parse(raw);\r\n  } catch {\r\n    return raw;\r\n  }\r\n}\r\n\r\nfunction valuesEqual(entry, a, b) {\r\n  if (!entry || typeof entry.equals !== 'function') {\r\n    return Object.is(a, b);\r\n  }\r\n  try {\r\n    return entry.equals(a, b);\r\n  } catch {\r\n    return Object.is(a, b);\r\n  }\r\n}\r\n\r\nfunction runStorageWatchers() {\r\n  if (storageWatchers.size === 0) {\r\n    stopStorageWatcherTimerIfIdle();\r\n    return;\r\n  }\r\n  storageWatchers.forEach((entries, key) => {\r\n    if (!entries || entries.size === 0) return;\r\n    let raw;\r\n    try {\r\n      raw = localStorage.getItem(key);\r\n    } catch {\r\n      raw = null;\r\n    }\r\n    entries.forEach((entry) => {\r\n      if (!entry) return;\r\n      const parsed = parseWith(entry, raw);\r\n      if (!entry.initialized) {\r\n        entry.lastRaw = raw;\r\n        entry.lastValue = parsed;\r\n        entry.initialized = true;\r\n        if (entry.emitCurrentValue) {\r\n          try {\r\n            entry.onChange?.(parsed, {\r\n              key,\r\n              raw,\r\n              previous: undefined,\r\n              previousRaw: undefined,\r\n              initial: true,\r\n              rawChanged: true,\r\n              valueChanged: true,\r\n            });\r\n          } catch {}\r\n        }\r\n        return;\r\n      }\r\n      const rawChanged = raw !== entry.lastRaw;\r\n      const valueChanged = !valuesEqual(entry, entry.lastValue, parsed);\r\n      if (!rawChanged && !valueChanged) return;\r\n      const previousValue = entry.lastValue;\r\n      const previousRaw = entry.lastRaw;\r\n      entry.lastRaw = raw;\r\n      entry.lastValue = parsed;\r\n      try {\r\n        entry.onChange?.(parsed, {\r\n          key,\r\n          raw,\r\n          previous: previousValue,\r\n          previousRaw,\r\n          rawChanged,\r\n          valueChanged,\r\n        });\r\n      } catch {}\r\n    });\r\n  });\r\n}\r\n\r\nexport function watchStorageKey(key, {\r\n  parse,\r\n  equals,\r\n  onChange,\r\n  emitCurrentValue = false,\r\n} = {}) {\r\n  if (!key || typeof localStorage === 'undefined') {\r\n    return () => {};\r\n  }\r\n  const entry = {\r\n    parse,\r\n    equals,\r\n    onChange,\r\n    emitCurrentValue,\r\n    lastRaw: undefined,\r\n    lastValue: undefined,\r\n    initialized: false,\r\n  };\r\n  let set = storageWatchers.get(key);\r\n  if (!set) {\r\n    set = new Set();\r\n    storageWatchers.set(key, set);\r\n  }\r\n  set.add(entry);\r\n  ensureStorageWatcherTimer();\r\n  return () => {\r\n    const entries = storageWatchers.get(key);\r\n    if (!entries) return;\r\n    entries.delete(entry);\r\n    if (entries.size === 0) {\r\n      storageWatchers.delete(key);\r\n      stopStorageWatcherTimerIfIdle();\r\n    }\r\n  };\r\n}\r\n\r\nexport function primeStorageWatcherSnapshot(key, rawValue) {\r\n  if (!key) return;\r\n  const entries = storageWatchers.get(key);\r\n  if (!entries || entries.size === 0) return;\r\n  let raw = rawValue;\r\n  if (raw === undefined) {\r\n    try {\r\n      raw = localStorage.getItem(key);\r\n    } catch {\r\n      raw = null;\r\n    }\r\n  }\r\n  entries.forEach((entry) => {\r\n    if (!entry) return;\r\n    entry.lastRaw = raw;\r\n    entry.lastValue = parseWith(entry, raw);\r\n    entry.initialized = true;\r\n  });\r\n}\r\n\r\nfunction bigNumEquals(a, b) {\r\n  if (a === b) return true;\r\n  if (a == null || b == null) return a == null && b == null;\r\n  if (a instanceof BigNum && typeof a.cmp === 'function') {\r\n    try { return a.cmp(b) === 0; } catch {}\r\n  }\r\n  if (b instanceof BigNum && typeof b.cmp === 'function') {\r\n    try { return b.cmp(a) === 0; } catch {}\r\n  }\r\n  if (typeof a?.cmp === 'function') {\r\n    try { return a.cmp(b) === 0; } catch {}\r\n  }\r\n  if (typeof b?.cmp === 'function') {\r\n    try { return b.cmp(a) === 0; } catch {}\r\n  }\r\n  try {\r\n    return Object.is(String(a), String(b));\r\n  } catch {\r\n    return Object.is(a, b);\r\n  }\r\n}\r\n\r\nfunction parseBigNumOrZero(raw) {\r\n  if (raw == null) return BigNum.fromInt(0);\r\n  try {\r\n    return BigNum.fromAny(raw);\r\n  } catch {\r\n    return BigNum.fromInt(0);\r\n  }\r\n}\r\n\r\nconst currencyWatcherCleanup = new Map();\r\nlet currencyWatcherBoundSlot = null;\r\n\r\nfunction cleanupCurrencyWatchers() {\r\n  currencyWatcherCleanup.forEach((stop) => {\r\n    try { stop?.(); } catch {}\r\n  });\r\n  currencyWatcherCleanup.clear();\r\n}\r\n\r\nfunction bindCurrencyWatchersForSlot(slot) {\r\n  if (slot === currencyWatcherBoundSlot) return;\r\n  cleanupCurrencyWatchers();\r\n  currencyWatcherBoundSlot = slot ?? null;\r\n  if (slot == null) return;\r\n  for (const currencyKey of Object.values(CURRENCIES)) {\r\n    const storageKey = `${KEYS.CURRENCY[currencyKey]}:${slot}`;\r\n    const stop = watchStorageKey(storageKey, {\r\n      parse: parseBigNumOrZero,\r\n      equals: bigNumEquals,\r\n      onChange: (value, meta) => {\r\n        if (!meta?.valueChanged) return;\r\n        if (typeof window === 'undefined') return;\r\n        const detail = { key: currencyKey, value, slot };\r\n        notifyCurrencySubscribers(detail);\r\n        try {\r\n          window.dispatchEvent(new CustomEvent('currency:change', { detail }));\r\n        } catch {}\r\n      },\r\n    });\r\n    currencyWatcherCleanup.set(storageKey, stop);\r\n  }\r\n}\r\n\r\nfunction initCurrencyStorageWatchers() {\r\n  if (typeof window === 'undefined') return;\r\n  bindCurrencyWatchersForSlot(getActiveSlot());\r\n  window.addEventListener('saveSlot:change', () => {\r\n    bindCurrencyWatchersForSlot(getActiveSlot());\r\n  });\r\n}\r\n\r\n// -------------------- HEARTBEAT / OFFLINE TRACKING --------------------\r\nlet lastSaveTimeTimer = null;\r\nlet hasEnteredGameSession = false;\r\n\r\nexport function notifyGameSessionStarted() {\r\n  hasEnteredGameSession = true;\r\n}\r\n\r\nexport function getLastSaveTimeKey(slot = getActiveSlot()) {\r\n  if (slot == null) return null;\r\n  return `${PREFIX}lastSaveTime:${slot}`;\r\n}\r\n\r\nexport function updateLastSaveTime() {\r\n  if (!hasEnteredGameSession) return;\r\n  // If the document is hidden, we STOP updating the heartbeat.\r\n  // This causes the lastSaveTime to \"drift\" into the past,\r\n  // so when the user returns, (Date.now() - lastSaveTime) reflects\r\n  // the entire time they were away/tabbed-out.\r\n  if (document.hidden) return;\r\n  \r\n  const slot = getActiveSlot();\r\n  if (slot == null) return;\r\n  const now = Date.now();\r\n  try {\r\n    localStorage.setItem(getLastSaveTimeKey(slot), String(now));\r\n  } catch {}\r\n}\r\n\r\nexport function getLastSaveTime() {\r\n  const slot = getActiveSlot();\r\n  if (slot == null) return 0;\r\n  try {\r\n    const raw = localStorage.getItem(getLastSaveTimeKey(slot));\r\n    const val = parseInt(raw, 10);\r\n    return Number.isFinite(val) ? val : 0;\r\n  } catch {\r\n    return 0;\r\n  }\r\n}\r\n\r\nfunction initHeartbeat() {\r\n  if (typeof window === 'undefined') return;\r\n  \r\n  // Update every 1 second (was 2s), but only if visible\r\n  if (!lastSaveTimeTimer) {\r\n    lastSaveTimeTimer = setInterval(updateLastSaveTime, 1000);\r\n  }\r\n\r\n  // Ensure we save immediately before unloading\r\n  window.addEventListener('beforeunload', () => {\r\n      // Force update regardless of visibility state on unload\r\n      if (!hasEnteredGameSession) return;\r\n      const slot = getActiveSlot();\r\n      if (slot != null) {\r\n          try { localStorage.setItem(getLastSaveTimeKey(slot), String(Date.now())); } catch {}\r\n      }\r\n  });\r\n  \r\n  // When coming back to visibility, we do NOT update immediately here.\r\n  // We let the game loop or offline tracker handle the time diff first.\r\n}\r\n\r\ninitHeartbeat();\r\n\r\n// -------------------- KEYS --------------------\r\nexport const KEYS = {\r\n  HAS_OPENED_SAVE_SLOT: `${PREFIX}hasOpenedSaveSlot`,\r\n  SAVE_SLOT:            `${PREFIX}saveSlot`,\r\n  CURRENCY:   {},\r\n  MULTIPLIER: {},\r\n};\r\n\r\n// -------------------- CURRENCIES --------------------\r\nexport const CURRENCIES = {\r\n  COINS: 'coins',\r\n  BOOKS: 'books',\r\n  GOLD: 'gold',\r\n  MAGIC: 'magic',\r\n  GEARS: 'gears',\r\n  WAVES: 'waves',\r\n  DNA: 'dna',\r\n};\r\n\r\nlet _activeSlotCache = undefined;\r\n\r\nexport function getActiveSlot() {\r\n  if (_activeSlotCache !== undefined) return _activeSlotCache;\r\n  const raw = localStorage.getItem(KEYS.SAVE_SLOT);\r\n  const n = parseInt(raw, 10);\r\n  const val = Number.isFinite(n) && n > 0 ? n : null;\r\n  _activeSlotCache = val;\r\n  return val;\r\n}\r\n\r\nexport function setActiveSlot(n) {\r\n  const v = Math.max(1, parseInt(n, 10) || 1);\r\n  _activeSlotCache = v;\r\n  localStorage.setItem(KEYS.SAVE_SLOT, String(v));\r\n  try {\r\n    window.dispatchEvent(new CustomEvent('saveSlot:change', { detail: { slot: v } }));\r\n  } catch {}\r\n}\r\n\r\nexport function clearActiveSlot() {\r\n  _activeSlotCache = null;\r\n  localStorage.removeItem(KEYS.SAVE_SLOT);\r\n}\r\n\r\nif (typeof window !== 'undefined') {\r\n  window.addEventListener('storage', (e) => {\r\n    if (e.key === KEYS.SAVE_SLOT) {\r\n      if (e.newValue === null) {\r\n        _activeSlotCache = null;\r\n      } else {\r\n        const n = parseInt(e.newValue, 10);\r\n        _activeSlotCache = Number.isFinite(n) && n > 0 ? n : null;\r\n      }\r\n      try {\r\n         window.dispatchEvent(new CustomEvent('saveSlot:change', { detail: { slot: _activeSlotCache } }));\r\n      } catch {}\r\n    }\r\n  });\r\n}\r\n\r\nfunction keyFor(base, slot = getActiveSlot()) {\r\n  if (slot == null) return null;\r\n  return `${base}:${slot}`;\r\n}\r\n\r\nfunction isDebugLocked(key) {\r\n  try {\r\n    const lockedKeys = globalThis?.__cccLockedStorageKeys;\r\n    return lockedKeys?.has?.(key) ?? false;\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\nexport function isStorageKeyLocked(key) {\r\n  return isDebugLocked(key);\r\n}\r\n\r\nexport function getSlotSignatureKey(slot = getActiveSlot()) {\r\n  return slotSignatureKey(slot);\r\n}\r\n\r\nexport function getSlotModifiedFlagKey(slot = getActiveSlot()) {\r\n  return slotModifiedKey(slot);\r\n}\r\n\r\nexport function getSlotSignature(slot = getActiveSlot()) {\r\n  if (typeof localStorage === 'undefined') return null;\r\n  const key = slotSignatureKey(slot);\r\n  if (!key) return null;\r\n  try { return localStorage.getItem(key); }\r\n  catch { return null; }\r\n}\r\n\r\nexport function setSlotSignature(slot, signature) {\r\n  if (typeof localStorage === 'undefined') return;\r\n  const key = slotSignatureKey(slot);\r\n  if (!key) return;\r\n  try {\r\n    if (signature == null) {\r\n      localStorage.removeItem(key);\r\n    } else {\r\n      localStorage.setItem(key, String(signature));\r\n    }\r\n  } catch {}\r\n}\r\n\r\nexport function hasModifiedSave(slot = getActiveSlot()) {\r\n  if (typeof localStorage === 'undefined') return false;\r\n  const key = slotModifiedKey(slot);\r\n  if (!key) return false;\r\n  try { return localStorage.getItem(key) === '1'; }\r\n  catch { return false; }\r\n}\r\n\r\nexport function markSaveSlotModified(slot = getActiveSlot()) {\r\n  if (typeof localStorage === 'undefined') return;\r\n  const normalized = normalizeSlotValue(slot);\r\n  if (normalized == null) return;\r\n  if (hasModifiedSave(normalized)) return;\r\n  const key = slotModifiedKey(normalized);\r\n  if (!key) return;\r\n  try {\r\n    localStorage.setItem(key, '1');\r\n  } catch { return; }\r\n  try {\r\n    window.dispatchEvent(new CustomEvent('saveSlot:modified', { detail: { slot: normalized } }));\r\n  } catch {}\r\n}\r\n\r\n\r\nfor (const key of Object.values(CURRENCIES)) {\r\n  KEYS.CURRENCY[key]   = `${PREFIX}${key}`;\r\n  KEYS.MULTIPLIER[key] = `${PREFIX}mult:${key}`; // one key only\r\n}\r\n\r\ninitCurrencyStorageWatchers();\r\n\r\n// -------------------- SAVE-SLOT HELPERS --------------------\r\nexport function getHasOpenedSaveSlot() {\r\n  return localStorage.getItem(KEYS.HAS_OPENED_SAVE_SLOT) === 'true';\r\n}\r\nexport function setHasOpenedSaveSlot(value) {\r\n  localStorage.setItem(KEYS.HAS_OPENED_SAVE_SLOT, value ? 'true' : 'false');\r\n}\r\n\r\n// -------------------- DEFAULTS --------------------\r\nexport function ensureStorageDefaults() {\r\n  if (localStorage.getItem(KEYS.HAS_OPENED_SAVE_SLOT) === null) {\r\n    setHasOpenedSaveSlot(false);\r\n  }\r\n}\r\n\r\nexport function ensureCurrencyDefaults() {\r\n  const slot = getActiveSlot();\r\n  if (slot == null) return; // only seed AFTER a slot is chosen\r\n  for (const key of Object.values(CURRENCIES)) {\r\n    const k = `${KEYS.CURRENCY[key]}:${slot}`;\r\n    if (!localStorage.getItem(k)) localStorage.setItem(k, '0');\r\n  }\r\n}\r\n\r\nexport function ensureMultiplierDefaults() {\r\n  const slot = getActiveSlot();\r\n  if (slot == null) return; // only seed AFTER a slot is chosen\r\n  for (const key of Object.values(CURRENCIES)) {\r\n    const km = `${KEYS.MULTIPLIER[key]}:${slot}`;\r\n    if (!localStorage.getItem(km)) {\r\n      const theor = scaledFromIntBN(BigNum.fromInt(1));\r\n      setMultiplierScaled(key, theor);\r\n    } else {\r\n      getMultiplierScaled(key);\r\n    }\r\n  }\r\n}\r\n\r\n// -------------------- AMOUNTS (BN) --------------------\r\nexport function getCurrency(key) {\r\n  const k = keyFor(KEYS.CURRENCY[key]);\r\n  if (!k) return BigNum.fromInt(0);\r\n  const raw = localStorage.getItem(k);\r\n  if (!raw) return BigNum.fromInt(0);\r\n  try { return BigNum.fromAny(raw); } catch { return BigNum.fromInt(0); }\r\n}\r\n\r\nexport function setCurrency(key, value, { delta = null, previous = null } = {}) {\r\n  const slot = getActiveSlot();\r\n  const k = keyFor(KEYS.CURRENCY[key], slot);\r\n  const prev = previous ?? getCurrency(key);\r\n  const zero = BigNum.fromInt(0);\r\n  if (!k) return prev;\r\n  if (isCurrencyLocked(key, slot)) {\r\n    // \u26A1 Bolt: Return early to prevent event spam and GC pressure when value is locked.\r\n    return prev;\r\n  } // Respect debug-panel storage locks\r\n\r\n  let bn;\r\n  try { bn = BigNum.fromAny(value); }\r\n  catch { bn = BigNum.fromInt(0); }\r\n  if (bn.isNegative?.()) bn = BigNum.fromInt(0);\r\n\r\n  const expectedRaw = bn.toStorage();\r\n\r\n  try { localStorage.setItem(k, expectedRaw); }\r\n  catch {}\r\n\r\n  let persistedRaw = null;\r\n  try { persistedRaw = localStorage.getItem(k); }\r\n  catch {}\r\n\r\n  const effectiveRaw = persistedRaw ?? expectedRaw;\r\n  let effective = bn;\r\n  try {\r\n    if (persistedRaw != null) {\r\n      effective = BigNum.fromAny(persistedRaw);\r\n      if (effective.isNegative?.()) effective = BigNum.fromInt(0);\r\n    }\r\n  } catch {}\r\n  \r\n  primeStorageWatcherSnapshot(k, effectiveRaw);\r\n\r\n  const changed = !bigNumEquals(prev, effective);\r\n\r\n  const parseDelta = (source) => {\r\n    if (source == null) return null;\r\n    try {\r\n      const bnDelta = source instanceof BigNum ? source.clone?.() ?? source : BigNum.fromAny(source);\r\n      if (typeof bnDelta.cmp === 'function') {\r\n        return bnDelta.cmp(zero) > 0 ? bnDelta : null;\r\n      }\r\n      if (!bnDelta.isZero?.()) return bnDelta;\r\n    } catch {}\r\n    return null;\r\n  };\r\n\r\n  const providedDelta = parseDelta(delta);\r\n  let deltaBn = null;\r\n  if (changed) {\r\n    try { deltaBn = effective.sub?.(prev); }\r\n    catch {}\r\n  }\r\n  if (!deltaBn || deltaBn.isZero?.() || (typeof deltaBn.cmp === 'function' && deltaBn.cmp(zero) <= 0)) {\r\n    deltaBn = providedDelta;\r\n  }\r\n\r\n  if (changed || deltaBn) {\r\n    const detail = { key, value: effective, slot, delta: deltaBn ?? undefined };\r\n    notifyCurrencySubscribers(detail);\r\n    try { window.dispatchEvent(new CustomEvent('currency:change', { detail })); } catch {}\r\n  }\r\n\r\n  return effective;\r\n}\r\n\r\nfunction scaledFromIntBN(intBN) {\r\n  return intBN.mulScaledIntFloor(1n, -MULT_SCALE);\r\n}\r\n\r\n// theoretical (\u00D710^MULT_SCALE) \u2192 integer BN multiplier (floor), min 1\r\nfunction intFromScaled(theorBN) {\r\n  const bn = BigNum.fromAny(theorBN);\r\n  if (bn.isInfinite()) return bn.clone();\r\n  const scaled = bn.mulScaledIntFloor(1n, MULT_SCALE);\r\n  return scaled;\r\n}\r\n\r\nfunction getMultiplierScaled(key) {\r\n  const k = keyFor(KEYS.MULTIPLIER[key]);\r\n  if (!k) return scaledFromIntBN(BigNum.fromInt(1));\r\n  const raw = localStorage.getItem(k);\r\n  if (!raw || !raw.startsWith(MULT_SCALE_TAG)) {\r\n    const theor = scaledFromIntBN(BigNum.fromInt(1));\r\n    setMultiplierScaled(key, theor);\r\n    return theor;\r\n  }\r\n  const payload = raw.slice(MULT_SCALE_TAG.length);\r\n  try { return BigNum.fromAny(payload); } catch {\r\n    const theor = scaledFromIntBN(BigNum.fromInt(1));\r\n    setMultiplierScaled(key, theor);\r\n    return theor;\r\n  }\r\n}\r\n\r\nfunction setMultiplierScaled(key, theoreticalBN, slot = getActiveSlot()) {\r\n  const k = keyFor(KEYS.MULTIPLIER[key], slot);\r\n  if (!k) return;\r\n  if (isCurrencyLocked(key, slot)) return; // Respect debug-panel storage locks\r\n  let prev = scaledFromIntBN(BigNum.fromInt(1));\r\n  const existingRaw = localStorage.getItem(k);\r\n  if (existingRaw?.startsWith?.(MULT_SCALE_TAG)) {\r\n    try {\r\n      prev = BigNum.fromAny(existingRaw.slice(MULT_SCALE_TAG.length));\r\n    } catch {}\r\n  }\r\n  const bn = BigNum.fromAny(theoreticalBN);\r\n  const raw = MULT_SCALE_TAG + bn.toStorage();\r\n  try { localStorage.setItem(k, raw); }\r\n  catch {}\r\n\r\n  let persistedRaw = null;\r\n  try { persistedRaw = localStorage.getItem(k); }\r\n  catch {}\r\n\r\n  const effectiveRaw = persistedRaw ?? raw;\r\n  let effective = bn;\r\n  try {\r\n    const payload = effectiveRaw?.startsWith?.(MULT_SCALE_TAG)\r\n      ? effectiveRaw.slice(MULT_SCALE_TAG.length)\r\n      : null;\r\n    if (payload != null) effective = BigNum.fromAny(payload);\r\n  } catch {}\r\n  // Keep any live storage watchers (and save-integrity snapshots) aligned with the\r\n  // freshly-written multiplier so follow-up writes don't look like manual tampering.\r\n  try { primeStorageWatcherSnapshot(k, effectiveRaw); } catch {}\r\n  if (!bigNumEquals(prev, effective)) {\r\n    try {\r\n      window.dispatchEvent(new CustomEvent('currency:multiplier', {\r\n        detail: { key, mult: intFromScaled(effective), slot }\r\n      }));\r\n    } catch {}\r\n  }\r\n}\r\n\r\nexport function getCurrencyMultiplierBN(key) {\r\n  return intFromScaled(getMultiplierScaled(key));\r\n}\r\n\r\nexport function isCurrencyLocked(key, slot = getActiveSlot()) {\r\n  const k = keyFor(KEYS.CURRENCY[key], slot);\r\n  return isDebugLocked(k);\r\n}\r\n\r\n// public set integer BN multiplier (stored as scaled theoretical)\r\nexport function setCurrencyMultiplierBN(key, intBNValue) {\r\n  const v = BigNum.fromAny(intBNValue);\r\n  const theor = scaledFromIntBN(v);\r\n  setMultiplierScaled(key, theor, getActiveSlot());\r\n  return v;\r\n}\r\n\r\nexport function peekCurrency(slot, key) {\r\n  const raw = localStorage.getItem(`${KEYS.CURRENCY[key]}:${slot}`);\r\n  if (!raw) return BigNum.fromInt(0);\r\n  try { return BigNum.fromAny(raw); } catch { return BigNum.fromInt(0); }\r\n}\r\n\r\n// -------------------- UTILITIES --------------------\r\nexport function clearAllStorage() {\r\n  Object.values(KEYS).forEach((v) => {\r\n    if (typeof v === 'string') {\r\n      localStorage.removeItem(v);\r\n    } else if (typeof v === 'object') {\r\n      Object.values(v).forEach((sub) => localStorage.removeItem(sub));\r\n    }\r\n  });\r\n}\r\n\r\n// -------------------- BANK FACADE --------------------\r\nfunction makeCurrencyHandle(key) {\r\n  // callable preview: bank.coins(\"1e3\")\r\n  const fn = (x) => {\r\n    try {\r\n      const bn = BigNum.fromAny(x);\r\n      return typeof formatNumber === 'function' ? formatNumber(bn) : bn.toString();\r\n    } catch {\r\n      return 'NaN';\r\n    }\r\n  };\r\n\r\n  Object.defineProperty(fn, 'value', {\r\n    get() { return getCurrency(key); }\r\n  });\r\n\r\n  fn.toString = function toString() {\r\n    return this.value.toString();\r\n  };\r\n\r\n  // amount mutations\r\n  fn.add = function add(x) {\r\n    const amt  = BigNum.fromAny(x);\r\n    const next = this.value.add(amt);\r\n    const effective = setCurrency(key, next, { delta: amt, previous: this.value });\r\n    return effective;\r\n  };\r\n\r\nfn.sub = function sub(x) {\r\n  const amt = BigNum.fromAny(x);\r\n  const cur = this.value;\r\n\r\n  let next = cur.sub(amt);\r\n  if (next.isNegative?.()) next = BigNum.fromInt(0);\r\n\r\n  setCurrency(key, next);\r\n  return next;\r\n};\r\n\r\n  fn.set = function set(x) {\r\n    const val = BigNum.fromAny(x);\r\n    let delta = null;\r\n    let current;\r\n    try {\r\n      current = this.value;\r\n      if (current && typeof current.sub === 'function') {\r\n        delta = val.sub(current);\r\n      }\r\n    } catch {}\r\n    const effective = setCurrency(key, val, { delta, previous: current });\r\n    return effective;\r\n  };\r\n\r\n  fn.fmt = function fmt(x) {\r\n    const bn = BigNum.fromAny(x);\r\n    return typeof formatNumber === 'function' ? formatNumber(bn) : bn.toString();\r\n  };\r\n\r\n  // multiplier API (single-key theoretical + floor)\r\n  fn.mult = {\r\n    get() {\r\n      return getCurrencyMultiplierBN(key);\r\n    },\r\n    set(x) {\r\n      return setCurrencyMultiplierBN(key, x);\r\n    },\r\n    multiplyByInt(x) {\r\n      const factor = BigNum.fromAny(x).floorToInteger();\r\n      let theor = getMultiplierScaled(key).mulBigNumInteger(factor);\r\n      if (theor.isZero()) theor = scaledFromIntBN(BigNum.fromInt(1));\r\n      setMultiplierScaled(key, theor);\r\n      return intFromScaled(theor);\r\n    },\r\n    multiplyByDecimal(x) {\r\n      // parse \"1.2\" \u2192 { numer, scale }\r\n      let parsed;\r\n      try { parsed = BigNum._parseDecimalMultiplier(String(x), MULT_SCALE); }\r\n      catch { parsed = { numer: 1n, scale: 0 }; }\r\n      let theor = getMultiplierScaled(key).mulScaledIntFloor(parsed.numer, parsed.scale);\r\n      if (theor.isZero()) theor = scaledFromIntBN(BigNum.fromInt(1));\r\n      setMultiplierScaled(key, theor);\r\n      const next = intFromScaled(theor);\r\n      return next.isZero() ? BigNum.fromInt(1) : next;\r\n    },\r\n    multiplyByPercent(pct) {\r\n      const factor = (Number(pct) / 100) + 1;\r\n      return this.multiplyByDecimal(String(factor));\r\n    },\r\n    applyTo(amount) {\r\n      const mult = this.get();\r\n      if (mult.isInfinite()) {\r\n        return BigNum.fromAny('Infinity');\r\n      }\r\n      const amt = BigNum.fromAny(amount, mult.p);\r\n      if (amt.isZero() || mult.isZero()) return amt.clone();\r\n      return amt.mulBigNumInteger(mult);\r\n    }\r\n  };\r\n\r\n  fn.addWithMultiplier = function addWithMultiplier(baseAmount) {\r\n    const inc = fn.mult.applyTo(baseAmount);\r\n    return fn.add(inc);\r\n  };\r\n\r\n  return fn;\r\n}\r\n\r\nexport const bank = new Proxy({}, {\r\n  get(_, prop) {\r\n    if (Object.values(CURRENCIES).includes(prop)) return makeCurrencyHandle(prop);\r\n    if (typeof prop === 'string' && CURRENCIES[prop.toUpperCase?.()]) {\r\n      return makeCurrencyHandle(CURRENCIES[prop.toUpperCase()]);\r\n    }\r\n    return undefined;\r\n  }\r\n});\r\n\r\nif (typeof window !== 'undefined') {\r\n  window.bank = bank;\r\n  for (const currency of Object.values(CURRENCIES)) {\r\n    window[currency] = bank[currency];\r\n  }\r\n}\r\n", "// js/util/slotsManager.js\r\nimport { KEYS, getActiveSlot } from './storage.js';\r\nimport { refreshSlotsView } from './slots.js';\r\n\r\nlet deleteMode = false;\r\nlet initialized = false;\r\n\r\nexport function isDeleteMode() { return deleteMode; }\r\n\r\nfunction setDeleteMode(on) {\r\n  deleteMode = !!on;\r\n  document.body.classList.toggle('slots-delete-mode', deleteMode);\r\n\r\n  const btn = document.getElementById('manage-saves');\r\n  if (btn) btn.textContent = deleteMode ? 'Done' : 'Manage save slots';\r\n\r\n  document.querySelectorAll('.slot-card').forEach((card) => {\r\n    card.classList.toggle('is-deleting', deleteMode);\r\n    card.setAttribute('aria-pressed', deleteMode ? 'true' : 'false');\r\n  });\r\n}\r\n\r\nfunction removeAllKeysForSlot(slot) {\r\n  const re = new RegExp(`^ccc:.*:${slot}$`);\r\n  const toRemove = [];\r\n  for (let i = 0; i < localStorage.length; i++) {\r\n    const k = localStorage.key(i);\r\n    if (re.test(k)) toRemove.push(k);\r\n  }\r\n  toRemove.forEach((k) => localStorage.removeItem(k));\r\n}\r\n\r\nexport function initSlotsManager() {\r\n  if (initialized) return;\r\n  initialized = true;\r\n\r\n  const manageBtn = document.getElementById('manage-saves');\r\n  const grid = document.querySelector('.slots-grid');\r\n  if (!manageBtn || !grid) return;\r\n\r\n  manageBtn.addEventListener('click', (e) => {\r\n    e.preventDefault();\r\n    setDeleteMode(!deleteMode);\r\n  });\r\n\r\n  window.addEventListener('keydown', (e) => {\r\n    if (deleteMode && e.key === 'Escape') setDeleteMode(false);\r\n  });\r\n\r\n  // Capture early to block the regular slot click handler\r\n  const onPointerDownCapture = (e) => {\r\n    if (!deleteMode) return;\r\n    const card = e.target.closest('.slot-card');\r\n    if (!card) return;\r\n    e.preventDefault();\r\n    e.stopPropagation();\r\n  };\r\n\r\n  const onClickCapture = (e) => {\r\n    if (!deleteMode) return;\r\n    const card = e.target.closest('.slot-card');\r\n    if (!card) return;\r\n\r\n    e.preventDefault();\r\n    e.stopPropagation();\r\n\r\n    // Figure out slot number\r\n    let slot = parseInt(card.dataset.slot, 10);\r\n    if (!Number.isFinite(slot) || slot <= 0) {\r\n      const cards = Array.from(document.querySelectorAll('.slot-card'));\r\n      slot = cards.indexOf(card) + 1;\r\n    }\r\n\r\n    // Only delete if slot has data\r\n    const hasData = localStorage.getItem(`ccc:coins:${slot}`) !== null;\r\n    if (!hasData) {\r\n      alert(`Slot ${slot} has no save data.`);\r\n      return;\r\n    }\r\n\r\n    if (!confirm(`Delete save data in Slot ${slot}? This cannot be undone.`)) return;\r\n\r\n    removeAllKeysForSlot(slot);\r\n\r\n    if (getActiveSlot() === slot) {\r\n      try { localStorage.removeItem(KEYS.SAVE_SLOT); } catch {}\r\n    }\r\n\r\n    refreshSlotsView();\r\n    setDeleteMode(false);\r\n  };\r\n\r\n  grid.addEventListener('pointerdown', onPointerDownCapture, true); // capture\r\n  grid.addEventListener('click', onClickCapture, true);             // capture\r\n\r\n  setDeleteMode(false);\r\n}\r\n\r\n// Auto-init in case nothing imports us explicitly\r\ndocument.addEventListener('DOMContentLoaded', () => {\r\n  try { initSlotsManager(); } catch {}\r\n});\r\n", "import { BigNum } from './bigNum.js';\r\nimport { formatNumber } from './numFormat.js';\r\nimport { isDeleteMode } from './slotsManager.js';\r\nimport {\r\n  setHasOpenedSaveSlot,\r\n  ensureCurrencyDefaults,\r\n  ensureMultiplierDefaults,\r\n  setActiveSlot,\r\n  peekCurrency,\r\n} from './storage.js';\r\n\r\n// A slot is considered \"used\" once it has a coins key at all (even if 0)\r\nfunction hasSlotData(slot) {\r\n  return localStorage.getItem(`ccc:coins:${slot}`) !== null;\r\n}\r\n\r\nfunction coinsTextFor(slot) {\r\n  if (!hasSlotData(slot)) return 'No Save Data';\r\n  try {\r\n    const bn = peekCurrency(slot, 'coins'); // BigNum\r\n    return formatNumber(bn);\r\n  } catch {\r\n    return '0';\r\n  }\r\n}\r\n\r\nfunction renderSlotCards() {\r\n  const cards = document.querySelectorAll('.slot-card');\r\n  cards.forEach((btn, idx) => {\r\n    const slot = idx + 1;\r\n    const titleEl = btn.querySelector('.slot-title');\r\n\r\n    if (titleEl) {\r\n      const text = coinsTextFor(slot);\r\n      titleEl.innerHTML = `<img src=\"img/currencies/coin/coin.webp\" class=\"coin-slot-icon-img\" alt=\"\"> ${text}`;\r\n    }\r\n\r\n    btn.dataset.slot = String(slot);\r\n  });\r\n}\r\n\r\nexport function initSlots(onSelect) {\r\n  const cards = document.querySelectorAll('.slot-card');\r\n\r\n  // Initial paint\r\n  renderSlotCards();\r\n\r\n  cards.forEach((btn, idx) => {\r\n    const slotNum = idx + 1;\r\n\r\n    const activate = (ev) => {\r\n      // Switch to this slot and seed its defaults the first time it\u2019s opened\r\n      setActiveSlot(slotNum);\r\n      ensureCurrencyDefaults();\r\n      ensureMultiplierDefaults();\r\n\r\n      setHasOpenedSaveSlot(true);\r\n      if (typeof onSelect === 'function') onSelect(slotNum, ev);\r\n\r\n      // Repaint card titles after seeding\r\n      renderSlotCards();\r\n    };\r\n\r\n    btn.addEventListener('click', (ev) => {\r\n      if (isDeleteMode()) return;\r\n      ev.preventDefault();\r\n      activate(ev);\r\n    });\r\n  });\r\n}\r\n\r\nexport function refreshSlotsView() { renderSlotCards(); }\r\n", "// js/util/audioCache.js\r\n\r\nconst cache = new Map();\r\n\r\nconst normalize = (src) => {\r\n  try {\r\n    return new URL(src, document.baseURI).href;\r\n  } catch (_) {\r\n    return src;\r\n  }\r\n};\r\n\r\nexport function registerPreloadedAudio(src, element) {\r\n  const key = normalize(src);\r\n  if (!key || !element) return;\r\n  element.pause?.();\r\n  try { element.currentTime = 0; } catch (_) {}\r\n  cache.set(key, element);\r\n}\r\n\r\nexport function takePreloadedAudio(src) {\r\n  const key = normalize(src);\r\n  if (!cache.has(key)) return null;\r\n  const el = cache.get(key);\r\n  cache.delete(key);\r\n  return el;\r\n}", "// js/ui/hudLayout.js\r\n\r\nexport function syncXpMpHudLayout() {\r\n  if (typeof document === 'undefined') return;\r\n  const hud = document.querySelector('.hud-top');\r\n  if (!hud) return;\r\n\r\n  const xpEl = document.querySelector('[data-xp-hud]');\r\n  const mpEl = document.querySelector('[data-mp-hud]');\r\n  const xpVisible = !!(xpEl && !xpEl.hasAttribute('hidden'));\r\n  const mpVisible = !!(mpEl && !mpEl.hasAttribute('hidden'));\r\n\r\n  hud.classList.toggle('hud-top--xp-only', xpVisible && !mpVisible);\r\n  hud.classList.toggle('hud-top--xp-mp', xpVisible && mpVisible);\r\n\r\n  if (!xpVisible && !mpVisible) {\r\n    hud.classList.remove('hud-top--xp-only', 'hud-top--xp-mp');\r\n  }\r\n}", "// js/game/xpSystem.js\r\n\r\nimport { BigNum, approxLog10BigNum as approxLog10, bigNumFromLog10 } from '../util/bigNum.js';\r\nimport { bank, getActiveSlot, watchStorageKey, primeStorageWatcherSnapshot } from '../util/storage.js';\r\nimport { applyStatMultiplierOverride } from '../util/debugPanel.js';\r\nimport { formatNumber } from '../util/numFormat.js';\r\nimport { syncXpMpHudLayout } from '../ui/hudLayout.js';\r\n\r\nconst KEY_PREFIX = 'ccc:xp';\r\nconst KEY_UNLOCK = (slot) => `${KEY_PREFIX}:unlocked:${slot}`;\r\nconst KEY_XP_LEVEL = (slot) => `${KEY_PREFIX}:level:${slot}`;\r\nconst KEY_PROGRESS = (slot) => `${KEY_PREFIX}:progress:${slot}`;\r\n\r\nexport function getXpLevelStorageKey(slot = getActiveSlot()) {\r\n  const resolvedSlot = slot ?? getActiveSlot();\r\n  return resolvedSlot == null ? null : KEY_XP_LEVEL(resolvedSlot);\r\n}\r\n\r\nlet lastSlot = null;\r\nlet stateLoaded = false;\r\nlet requirementBn = BigNum.fromInt(10);\r\nconst xpRequirementCache = new Map();\r\nxpRequirementCache.set('0', requirementBn);\r\nlet highestCachedExactLevel = 0n;\r\nconst infinityRequirementBn = BigNum.fromAny('Infinity');\r\n\r\nlet lastSyncedCoinLevel = null;\r\nlet lastSyncedCoinLevelWasInfinite = false;\r\nlet lastSyncedCoinUsedApproximation = false;\r\nlet lastSyncedCoinApproxKey = null;\r\nlet externalCoinMultiplierProvider = null;\r\nlet externalXpGainMultiplierProvider = null;\r\nconst coinMultiplierProviders = new Set();\r\nconst xpGainMultiplierProviders = new Set();\r\nlet externalBookRewardProvider = null;\r\n\r\nconst EXACT_REQUIREMENT_CACHE_LEVEL = 5000n;\r\nconst LOG_STEP = Math.log10(11 / 10);\r\nconst LOG_DECADE_BONUS = Math.log10(5 / 2);\r\nconst EXACT_COIN_LEVEL_LIMIT = 200n;\r\nconst LOG_STEP_DECIMAL = '0.04139268515822507';\r\nconst LOG_DECADE_BONUS_DECIMAL = '0.3979400086720376';\r\nconst TEN_DIVISOR_DECIMAL = '0.1';\r\nconst maxLog10Bn = BigNum.fromScientific(String(BigNum.MAX_E));\r\n\r\nfunction bigIntToFloatApprox(value) {\r\n  if (value === 0n) return 0;\r\n  const str = value.toString();\r\n  const len = str.length;\r\n  const headDigits = Math.min(len, 15);\r\n  const head = Number(str.slice(0, headDigits));\r\n  const exponent = len - headDigits;\r\n  if (!Number.isFinite(head)) return Number.POSITIVE_INFINITY;\r\n  const scaled = head * Math.pow(10, exponent);\r\n  return Number.isFinite(scaled) ? scaled : Number.POSITIVE_INFINITY;\r\n}\r\n\r\nfunction bigNumIsInfinite(bn) {\r\n  return !!(bn && typeof bn === 'object' && (bn.isInfinite?.() || (typeof bn.isInfinite === 'function' && bn.isInfinite())));\r\n}\r\n\r\nfunction bigNumIsZero(bn) {\r\n  return !bn || typeof bn !== 'object' || (bn.isZero?.() || (typeof bn.isZero === 'function' && bn.isZero()));\r\n}\r\n\r\nfunction bigNumToFiniteNumber(bn) {\r\n  if (!bn || typeof bn !== 'object') return 0;\r\n  if (bigNumIsInfinite(bn)) return Number.POSITIVE_INFINITY;\r\n  const sci = typeof bn.toScientific === 'function' ? bn.toScientific(18) : String(bn);\r\n  if (!sci || sci === 'Infinity') return Number.POSITIVE_INFINITY;\r\n  const match = sci.match(/^([0-9]+(?:\\.[0-9]+)?)e([+-]?\\d+)$/i);\r\n  if (match) {\r\n    const mant = parseFloat(match[1]);\r\n    const exp = parseInt(match[2], 10);\r\n    if (!Number.isFinite(mant) || !Number.isFinite(exp)) return Number.POSITIVE_INFINITY;\r\n    if (exp >= 309) return Number.POSITIVE_INFINITY;\r\n    return mant * Math.pow(10, exp);\r\n  }\r\n  const num = Number(sci);\r\n  return Number.isFinite(num) ? num : Number.POSITIVE_INFINITY;\r\n}\r\n\r\nfunction logBigNumToNumber(bn) {\r\n  if (!bn || typeof bn !== 'object') return 0;\r\n  if (bigNumIsInfinite(bn)) return Number.POSITIVE_INFINITY;\r\n  if (typeof bn.cmp === 'function' && bn.cmp(maxLog10Bn) >= 0) {\r\n    return Number.POSITIVE_INFINITY;\r\n  }\r\n  return bigNumToFiniteNumber(bn);\r\n}\r\n\r\nfunction computeBonusCountBn(levelBn) {\r\n  if (!levelBn || typeof levelBn !== 'object') return BigNum.fromInt(0);\r\n  const divided = levelBn.mulDecimal(TEN_DIVISOR_DECIMAL, 1);\r\n  const floored = divided.floorToInteger();\r\n  if (typeof divided.cmp === 'function' && divided.cmp(floored) === 0) {\r\n    if (floored.isZero?.() || (typeof floored.isZero === 'function' && floored.isZero())) {\r\n      return floored;\r\n    }\r\n    return floored.sub?.(bnOne()) ?? BigNum.fromInt(0);\r\n  }\r\n  return floored;\r\n}\r\n\r\nfunction computeLevelLogTerm(levelBn) {\r\n  if (!levelBn || typeof levelBn !== 'object') return BigNum.fromInt(0);\r\n  return levelBn.mulDecimal(LOG_STEP_DECIMAL, 18);\r\n}\r\n\r\nfunction computeBonusLogTerm(levelBn) {\r\n  const bonusCount = computeBonusCountBn(levelBn);\r\n  if (bigNumIsZero(bonusCount)) return null;\r\n  return bonusCount.mulDecimal(LOG_DECADE_BONUS_DECIMAL, 18);\r\n}\r\n\r\nfunction bigNumPowerOf10(logBn) {\r\n  if (bigNumIsInfinite(logBn) || (typeof logBn.cmp === 'function' && logBn.cmp(maxLog10Bn) >= 0)) {\r\n      return infinityRequirementBn.clone?.() ?? infinityRequirementBn;\r\n  }\r\n\r\n  const integerPart = logBn.floorToInteger();\r\n  const fractionalPart = logBn.sub(integerPart);\r\n  const fractionalNumber = bigNumToFiniteNumber(fractionalPart);\r\n\r\n  if (!Number.isFinite(fractionalNumber)) {\r\n      return infinityRequirementBn.clone?.() ?? infinityRequirementBn;\r\n  }\r\n\r\n  let mantissa = Math.pow(10, fractionalNumber);\r\n\r\n  const precision = 18;\r\n  const scaleFactor = 10n ** BigInt(precision);\r\n\r\n  let exponentAdjustment = 0n;\r\n  if (mantissa >= 10) {\r\n      mantissa /= 10;\r\n      exponentAdjustment = 1n;\r\n  }\r\n\r\n  const sig = BigInt(Math.round(mantissa * Number(scaleFactor)));\r\n\r\n  const integerPartString = integerPart.toPlainIntegerString();\r\n  if (integerPartString === 'Infinity') {\r\n      return infinityRequirementBn.clone?.() ?? infinityRequirementBn;\r\n  }\r\n  const integerPartBigInt = BigInt(integerPartString);\r\n\r\n  const totalExponent = integerPartBigInt + exponentAdjustment - BigInt(precision);\r\n\r\n  const E_LIMIT = 250;\r\n  const eBigInt = totalExponent % BigInt(E_LIMIT);\r\n  const e = Number(eBigInt);\r\n  const offset = totalExponent - eBigInt;\r\n\r\n  return new BigNum(sig, { base: e, offset: offset });\r\n}\r\n\r\nfunction approximateCoinMultiplierFromBigNum(levelBn) {\r\n  if (!levelBn || typeof levelBn !== 'object') {\r\n    return infinityRequirementBn.clone?.() ?? infinityRequirementBn;\r\n  }\r\n  const levelLog = computeLevelLogTerm(levelBn);\r\n  let totalLog = levelLog;\r\n  const approx = bigNumPowerOf10(totalLog);\r\n  const approxIsInf = approx.isInfinite?.() || (typeof approx.isInfinite === 'function' && approx.isInfinite());\r\n  if (approxIsInf) {\r\n    return infinityRequirementBn.clone?.() ?? infinityRequirementBn;\r\n  }\r\n  const levelTerm = levelBn.clone?.() ?? (() => {\r\n    try { return BigNum.fromAny(levelBn ?? 0); }\r\n    catch { return BigNum.fromInt(0); }\r\n  })();\r\n  let combined = approx.clone?.() ?? approx;\r\n  if (typeof combined.add === 'function') {\r\n    combined = combined.add(levelTerm);\r\n  } else if (typeof levelTerm.add === 'function') {\r\n    combined = levelTerm.add(combined);\r\n  }\r\n  return combined;\r\n}\r\n\r\nconst xpState = {\r\n  unlocked: false,\r\n  xpLevel: BigNum.fromInt(0),\r\n  progress: BigNum.fromInt(0),\r\n};\r\n\r\nfunction enforceXpInfinityInvariant() {\r\n  const levelIsInf = bigNumIsInfinite(xpState.xpLevel);\r\n  const progIsInf = bigNumIsInfinite(xpState.progress);\r\n  if (!levelIsInf && !progIsInf) return false;\r\n\r\n  const inf = infinityRequirementBn.clone?.() ?? infinityRequirementBn;\r\n  xpState.xpLevel = inf.clone?.() ?? inf;\r\n  xpState.progress = inf.clone?.() ?? inf;\r\n  requirementBn = inf.clone?.() ?? inf;\r\n\r\n  if (bank?.books) {\r\n    try {\r\n      if (typeof bank.books.set === 'function') {\r\n        bank.books.set(inf.clone?.() ?? inf);\r\n      } else if (typeof bank.books.add === 'function') {\r\n        bank.books.add(inf.clone?.() ?? inf);\r\n      }\r\n    } catch {\r\n    }\r\n  }\r\n  \r\n  return true;\r\n}\r\n\r\n\r\nconst xpChangeSubscribers = new Set();\r\n\r\nfunction notifyXpSubscribers(detail = {}) {\r\n  if (xpChangeSubscribers.size === 0) return;\r\n  xpChangeSubscribers.forEach((entry) => {\r\n    if (!entry || typeof entry.handler !== 'function') return;\r\n    if (entry.slot != null && detail.slot != null && entry.slot !== detail.slot) return;\r\n    try { entry.handler(detail); }\r\n    catch {}\r\n  });\r\n}\r\n\r\nexport function onXpChange(handler, { slot = null } = {}) {\r\n  if (typeof handler !== 'function') {\r\n    return () => {};\r\n  }\r\n  const entry = { handler, slot: slot ?? null };\r\n  xpChangeSubscribers.add(entry);\r\n  return () => {\r\n    xpChangeSubscribers.delete(entry);\r\n  };\r\n}\r\n\r\nconst hudRefs = {\r\n  container: null,\r\n  bar: null,\r\n  fill: null,\r\n  xpLevelValue: null,\r\n  progress: null,\r\n};\r\n\r\nfunction bnZero() {\r\n  return BigNum.fromInt(0);\r\n}\r\n\r\nfunction bnOne() {\r\n  return BigNum.fromInt(1);\r\n}\r\n\r\nconst xpStorageWatcherCleanups = [];\r\nlet xpStorageWatchersInitialized = false;\r\nlet xpStorageWatcherSlot = null;\r\nlet handlingExternalXpStorage = false;\r\n\r\nfunction cloneBigNumSafe(value) {\r\n  if (!value) return bnZero();\r\n  if (typeof value.clone === 'function') {\r\n    try { return value.clone(); } catch {}\r\n  }\r\n  try { return BigNum.fromAny(value); } catch { return bnZero(); }\r\n}\r\n\r\nfunction bigNumEqualsSafe(a, b) {\r\n  if (a === b) return true;\r\n  if (a == null || b == null) return a == null && b == null;\r\n  if (typeof a?.cmp === 'function') {\r\n    try { return a.cmp(b) === 0; } catch {}\r\n  }\r\n  if (typeof b?.cmp === 'function') {\r\n    try { return b.cmp(a) === 0; } catch {}\r\n  }\r\n  try { return Object.is(String(a), String(b)); }\r\n  catch { return false; }\r\n}\r\n\r\nfunction cleanupXpStorageWatchers() {\r\n  while (xpStorageWatcherCleanups.length > 0) {\r\n    const stop = xpStorageWatcherCleanups.pop();\r\n    try { stop?.(); } catch {}\r\n  }\r\n}\r\n\r\nfunction parseBigNumOrZero(raw) {\r\n  if (raw == null) return bnZero();\r\n  try { return BigNum.fromAny(raw); }\r\n  catch { return bnZero(); }\r\n}\r\n\r\nfunction handleExternalXpStorageChange(reason) {\r\n  if (handlingExternalXpStorage) return;\r\n  handlingExternalXpStorage = true;\r\n  try {\r\n    const slot = xpStorageWatcherSlot ?? getActiveSlot();\r\n    const prev = {\r\n      unlocked: xpState.unlocked,\r\n      xpLevel: cloneBigNumSafe(xpState.xpLevel),\r\n      progress: cloneBigNumSafe(xpState.progress),\r\n      requirement: cloneBigNumSafe(requirementBn),\r\n    };\r\n    ensureStateLoaded(true);\r\n    updateHud();\r\n    syncCoinMultiplierWithXpLevel(true);\r\n    const current = {\r\n      unlocked: xpState.unlocked,\r\n      xpLevel: cloneBigNumSafe(xpState.xpLevel),\r\n      progress: cloneBigNumSafe(xpState.progress),\r\n      requirement: cloneBigNumSafe(requirementBn),\r\n    };\r\n    const unlockedChanged = prev.unlocked !== current.unlocked;\r\n    const levelChanged = !bigNumEqualsSafe(prev.xpLevel, current.xpLevel);\r\n    const progressChanged = !bigNumEqualsSafe(prev.progress, current.progress);\r\n    if (!unlockedChanged && !levelChanged && !progressChanged) {\r\n      return;\r\n    }\r\n    let xpLevelsGained = bnZero();\r\n    if (levelChanged) {\r\n      try { xpLevelsGained = current.xpLevel.sub?.(prev.xpLevel) ?? bnZero(); }\r\n      catch { xpLevelsGained = bnZero(); }\r\n    }\r\n    let xpAdded = null;\r\n    if (!levelChanged && progressChanged) {\r\n      try { xpAdded = current.progress.sub?.(prev.progress) ?? null; }\r\n      catch { xpAdded = null; }\r\n    }\r\n    if (typeof window !== 'undefined' || xpChangeSubscribers.size > 0) {\r\n      const detail = {\r\n        unlocked: current.unlocked,\r\n        xpLevelsGained: xpLevelsGained?.clone?.() ?? xpLevelsGained,\r\n        xpAdded: xpAdded?.clone?.() ?? xpAdded,\r\n        xpLevel: current.xpLevel?.clone?.() ?? current.xpLevel,\r\n        progress: current.progress?.clone?.() ?? current.progress,\r\n        requirement: current.requirement?.clone?.() ?? current.requirement,\r\n        source: 'storage',\r\n        changeType: reason,\r\n        slot,\r\n      };\r\n      notifyXpSubscribers(detail);\r\n      if (typeof window !== 'undefined') {\r\n        try { window.dispatchEvent(new CustomEvent('xp:change', { detail })); } catch {}\r\n      }\r\n    }\r\n  } finally {\r\n    handlingExternalXpStorage = false;\r\n  }\r\n}\r\n\r\nfunction bindXpStorageWatchersForSlot(slot) {\r\n  if (slot === xpStorageWatcherSlot) return;\r\n  cleanupXpStorageWatchers();\r\n  xpStorageWatcherSlot = slot ?? null;\r\n  if (slot == null) return;\r\n  const watch = (key, options) => {\r\n    const stop = watchStorageKey(key, options);\r\n    if (typeof stop === 'function') {\r\n      xpStorageWatcherCleanups.push(stop);\r\n    }\r\n  };\r\n  watch(KEY_UNLOCK(slot), {\r\n    parse: (raw) => raw === '1',\r\n    equals: (a, b) => a === b,\r\n    onChange: () => handleExternalXpStorageChange('unlock'),\r\n  });\r\n  watch(KEY_XP_LEVEL(slot), {\r\n    parse: parseBigNumOrZero,\r\n    equals: bigNumEqualsSafe,\r\n    onChange: () => handleExternalXpStorageChange('xpLevel'),\r\n  });\r\n  watch(KEY_PROGRESS(slot), {\r\n    parse: parseBigNumOrZero,\r\n    equals: bigNumEqualsSafe,\r\n    onChange: () => handleExternalXpStorageChange('progress'),\r\n  });\r\n}\r\n\r\nfunction ensureXpStorageWatchers() {\r\n  if (xpStorageWatchersInitialized) {\r\n    bindXpStorageWatchersForSlot(getActiveSlot());\r\n    return;\r\n  }\r\n  xpStorageWatchersInitialized = true;\r\n  bindXpStorageWatchersForSlot(getActiveSlot());\r\n  if (typeof window !== 'undefined') {\r\n    window.addEventListener('saveSlot:change', () => {\r\n      bindXpStorageWatchersForSlot(getActiveSlot());\r\n      ensureStateLoaded(true);\r\n      updateHud();\r\n      syncCoinMultiplierWithXpLevel(true);\r\n    });\r\n  }\r\n}\r\n\r\nfunction stripHtml(value) {\r\n  if (typeof value !== 'string') return '';\r\n  return value.replace(/<[^>]*>/g, '');\r\n}\r\n\r\n\r\nfunction bonusMultipliersCount(levelBigInt) {\r\n  if (levelBigInt <= 1n) return 0n;\r\n  return (levelBigInt - 1n) / 10n;\r\n}\r\n\r\nfunction ensureExactRequirementCacheUpTo(levelBigInt) {\r\n  const target = levelBigInt < EXACT_REQUIREMENT_CACHE_LEVEL ? levelBigInt : EXACT_REQUIREMENT_CACHE_LEVEL;\r\n  if (target <= highestCachedExactLevel) return;\r\n\r\n  let currentLevel = highestCachedExactLevel;\r\n  let currentRequirement = xpRequirementCache.get(currentLevel.toString());\r\n  if (!currentRequirement) {\r\n    currentRequirement = BigNum.fromInt(10);\r\n    xpRequirementCache.set(currentLevel.toString(), currentRequirement);\r\n  }\r\n\r\n  while (currentLevel < target) {\r\n    const nextLevel = currentLevel + 1n;\r\n    let nextRequirement = currentRequirement.mulScaledIntFloor(11n, 1);\r\n    if (nextLevel > 1n && ((nextLevel - 1n) % 10n === 0n)) {\r\n      nextRequirement = nextRequirement.mulScaledIntFloor(25n, 1);\r\n    }\r\n    xpRequirementCache.set(nextLevel.toString(), nextRequirement);\r\n    currentRequirement = nextRequirement;\r\n    currentLevel = nextLevel;\r\n    const isInfinite = currentRequirement.isInfinite?.() || (typeof currentRequirement.isInfinite === 'function' && currentRequirement.isInfinite());\r\n    if (isInfinite) {\r\n      highestCachedExactLevel = currentLevel;\r\n      return;\r\n    }\r\n  }\r\n\r\n  highestCachedExactLevel = currentLevel;\r\n}\r\n\r\n\r\nfunction approximateRequirementFromLevel(levelBn) {\r\n  const baseLevel = highestCachedExactLevel > 0n ? highestCachedExactLevel : 0n;\r\n  const baseRequirement = xpRequirementCache.get(baseLevel.toString());\r\n  if (!baseRequirement || bigNumIsInfinite(baseRequirement)) {\r\n    return infinityRequirementBn.clone?.() ?? infinityRequirementBn;\r\n  }\r\n\r\n  const baseLevelBn = BigNum.fromAny(baseLevel.toString());\r\n  const baseLog = approxLog10(baseRequirement);\r\n  let totalLog = BigNum.fromInt(0);\r\n  if (Number.isFinite(baseLog) && baseLog > 0) {\r\n    try {\r\n      totalLog = BigNum.fromScientific(baseLog.toString());\r\n    } catch {\r\n      totalLog = BigNum.fromInt(0);\r\n    }\r\n  }\r\n\r\n  const deltaLevel = levelBn.sub?.(baseLevelBn) ?? BigNum.fromInt(0);\r\n  if (!bigNumIsZero(deltaLevel)) {\r\n    totalLog = totalLog.add?.(deltaLevel.mulDecimal(LOG_STEP_DECIMAL, 18)) ?? totalLog;\r\n  }\r\n\r\n  const targetBonus = computeBonusCountBn(levelBn);\r\n  const baseBonus = computeBonusCountBn(baseLevelBn);\r\n  const deltaBonus = targetBonus.sub?.(baseBonus) ?? BigNum.fromInt(0);\r\n  if (!bigNumIsZero(deltaBonus)) {\r\n    totalLog = totalLog.add?.(deltaBonus.mulDecimal(LOG_DECADE_BONUS_DECIMAL, 18)) ?? totalLog;\r\n  }\r\n\r\n  const logNumber = logBigNumToNumber(totalLog);\r\n  if (!Number.isFinite(logNumber)) {\r\n    return infinityRequirementBn.clone?.() ?? infinityRequirementBn;\r\n  }\r\n\r\n  return bigNumFromLog10(logNumber);\r\n}\r\n\r\nfunction progressRatio(progressBn, requirement) {\r\n  if (!requirement || typeof requirement !== 'object') return 0;\r\n  if (!progressBn || typeof progressBn !== 'object') return 0;\r\n\r\n  const reqIsInf = bigNumIsInfinite(requirement);\r\n  const progIsInf = bigNumIsInfinite(progressBn);\r\n\r\n  // If both are infinite, treat as a full bar.\r\n  if (reqIsInf) {\r\n    return progIsInf ? 1 : 0;\r\n  }\r\n\r\n  const reqIsZero = bigNumIsZero(requirement);\r\n  if (reqIsZero) return 0;\r\n\r\n  const progIsZero = bigNumIsZero(progressBn);\r\n  if (progIsZero) return 0;\r\n\r\n  const logProg = approxLog10(progressBn);\r\n  const logReq  = approxLog10(requirement);\r\n  if (!Number.isFinite(logProg) || !Number.isFinite(logReq)) {\r\n    return logProg >= logReq ? 1 : 0;\r\n  }\r\n  const diff = logProg - logReq;\r\n  const ratio = Math.pow(10, diff);\r\n  if (!Number.isFinite(ratio)) {\r\n    return diff >= 0 ? 1 : 0;\r\n  }\r\n  if (ratio <= 0) return 0;\r\n  if (ratio >= 1) return 1;\r\n  return ratio;\r\n}\r\n\r\nfunction ensureHudRefs() {\r\n  if (hudRefs.container && hudRefs.container.isConnected) return true;\r\n  hudRefs.container = document.querySelector('.xp-counter[data-xp-hud]');\r\n  if (!hudRefs.container) return false;\r\n  hudRefs.bar = hudRefs.container.querySelector('.xp-bar');\r\n  hudRefs.fill = hudRefs.container.querySelector('.xp-bar__fill');\r\n  hudRefs.xpLevelValue = hudRefs.container.querySelector('.xp-level-value');\r\n  hudRefs.progress = hudRefs.container.querySelector('[data-xp-progress]');\r\n  return true;\r\n}\r\n\r\nfunction xpRequirementForXpLevel(xpLevelInput) {\r\n  let xpLvlBn;\r\n  try {\r\n    xpLvlBn = xpLevelInput instanceof BigNum\r\n      ? (xpLevelInput.clone?.() ?? xpLevelInput)\r\n      : BigNum.fromAny(xpLevelInput ?? 0);\r\n  } catch {\r\n    xpLvlBn = BigNum.fromInt(0);\r\n  }\r\n\r\n  const lvlIsInf = xpLvlBn.isInfinite?.() || (typeof xpLvlBn.isInfinite === 'function' && xpLvlBn.isInfinite());\r\n  if (lvlIsInf) {\r\n    return BigNum.fromAny('Infinity');\r\n  }\r\n\r\n  let levelPlain = '0';\r\n  try {\r\n    levelPlain = xpLvlBn.toPlainIntegerString?.() ?? xpLvlBn.toString?.() ?? '0';\r\n  } catch {\r\n    levelPlain = '0';\r\n  }\r\n\r\n  let targetLevelInfo = { bigInt: null, finite: true };\r\n  if (levelPlain && levelPlain !== 'Infinity') {\r\n    try {\r\n      targetLevelInfo = { bigInt: BigInt(levelPlain), finite: true };\r\n    } catch {\r\n      targetLevelInfo = { bigInt: null, finite: true };\r\n    }\r\n  } else {\r\n    targetLevelInfo = { bigInt: null, finite: true };\r\n  }\r\n\r\n  const targetLevel = targetLevelInfo.bigInt ?? 0n;\r\n\r\n  if (targetLevelInfo.bigInt != null && targetLevel <= 0n) {\r\n    const baseRequirement = xpRequirementCache.get('0');\r\n    return baseRequirement.clone?.() ?? baseRequirement;\r\n  }\r\n\r\n  if (targetLevelInfo.bigInt != null) {\r\n    ensureExactRequirementCacheUpTo(targetLevel);\r\n    const targetKey = targetLevel.toString();\r\n    const cachedExact = xpRequirementCache.get(targetKey);\r\n    if (cachedExact) {\r\n      return cachedExact.clone?.() ?? cachedExact;\r\n    }\r\n  }\r\n\r\n  const approximate = approximateRequirementFromLevel(xpLvlBn);\r\n  const approxIsInf = approximate.isInfinite?.() || (typeof approximate.isInfinite === 'function' && approximate.isInfinite());\r\n  if (approxIsInf) {\r\n    return infinityRequirementBn.clone?.() ?? infinityRequirementBn;\r\n  }\r\n\r\n  if (targetLevelInfo.bigInt != null) {\r\n    xpRequirementCache.set(targetLevelInfo.bigInt.toString(), approximate);\r\n  }\r\n  return approximate.clone?.() ?? approximate;\r\n}\r\n\r\nfunction updateXpRequirement() {\r\n  requirementBn = xpRequirementForXpLevel(xpState.xpLevel);\r\n}\r\n\r\nfunction resetLockedXpState() {\r\n  xpState.xpLevel = bnZero();\r\n  xpState.progress = bnZero();\r\n  updateXpRequirement();\r\n  syncCoinMultiplierWithXpLevel(true);\r\n}\r\n\r\nfunction isKeyLocked(key) {\r\n  if (typeof window !== 'undefined' && window.__cccLockedStorageKeys) {\r\n    return window.__cccLockedStorageKeys.has(key);\r\n  }\r\n  return false;\r\n}\r\n\r\nfunction normalizeProgress(applyRewards = false) {\r\n  // If either level or progress is already \u221E, enforce the invariant and bail.\r\n  if (enforceXpInfinityInvariant()) {\r\n    return;\r\n  }\r\n\r\n  const slot = getActiveSlot();\r\n  if (slot != null && isKeyLocked(KEY_XP_LEVEL(slot))) {\r\n    // If level is locked, we can't level up. Just update requirement and return.\r\n    updateXpRequirement();\r\n    return;\r\n  }\r\n\r\n  updateXpRequirement();\r\n\r\n  // If the requirement is infinite, there is nothing meaningful to normalize.\r\n  if (bigNumIsInfinite(requirementBn)) {\r\n    return;\r\n  }\r\n\r\n  let guard = 0;\r\n  const limit = 10000;\r\n  while (xpState.progress.cmp?.(requirementBn) >= 0 && guard < limit) {\r\n    try { xpState.progress = xpState.progress.sub(requirementBn); }\r\n    catch { xpState.progress = bnZero(); }\r\n\r\n    try { xpState.xpLevel = xpState.xpLevel.add(bnOne()); }\r\n    catch { xpState.xpLevel = bnZero(); }\r\n\r\n    if (applyRewards) handleXpLevelUpRewards();\r\n    updateXpRequirement();\r\n\r\n    if (bigNumIsInfinite(requirementBn)) {\r\n      break;\r\n    }\r\n    guard += 1;\r\n  }\r\n\r\n  if (guard >= limit) {\r\n    xpState.progress = bnZero();\r\n  }\r\n}\r\n\r\nfunction xpLevelBigIntInfo(xpLevelValue) {\r\n  if (!xpLevelValue || typeof xpLevelValue !== 'object') {\r\n    return { bigInt: 0n, finite: false };\r\n  }\r\n  const levelIsInfinite = xpLevelValue.isInfinite?.() || (typeof xpLevelValue.isInfinite === 'function' && xpLevelValue.isInfinite());\r\n  if (levelIsInfinite) {\r\n    return { bigInt: null, finite: false };\r\n  }\r\n  let plain = '0';\r\n  try {\r\n    plain = xpLevelValue.toPlainIntegerString?.() ?? xpLevelValue.toString?.() ?? '0';\r\n  } catch {\r\n    plain = '0';\r\n  }\r\n  if (plain === 'Infinity') {\r\n    return { bigInt: null, finite: false };\r\n  }\r\n  if (!plain) {\r\n    return { bigInt: null, finite: true };\r\n  }\r\n  try {\r\n    return { bigInt: BigInt(plain), finite: true };\r\n  } catch {\r\n    return { bigInt: null, finite: true };\r\n  }\r\n}\r\n\r\nfunction syncCoinMultiplierWithXpLevel(force = false) {\r\n  const multApi = bank?.coins?.mult;\r\n  if (!multApi || typeof multApi.set !== 'function' || typeof multApi.multiplyByDecimal !== 'function') {\r\n    return;\r\n  }\r\n\r\n  const levelInfo = xpLevelBigIntInfo(xpState.xpLevel);\r\n  const levelBigInt = levelInfo.bigInt;\r\n  const levelIsInfinite = !levelInfo.finite;\r\n  const levelStorageKey = typeof xpState.xpLevel?.toStorage === 'function' ? xpState.xpLevel.toStorage() : null;\r\n\r\n  if (!force) {\r\n    if (levelIsInfinite && lastSyncedCoinLevelWasInfinite) {\r\n      return;\r\n    }\r\n    if (!levelIsInfinite && levelBigInt != null && !lastSyncedCoinLevelWasInfinite && !lastSyncedCoinUsedApproximation && lastSyncedCoinLevel != null && levelBigInt === lastSyncedCoinLevel) {\r\n      return;\r\n    }\r\n    if (!levelIsInfinite && levelBigInt == null && lastSyncedCoinUsedApproximation && levelStorageKey && lastSyncedCoinApproxKey && levelStorageKey === lastSyncedCoinApproxKey) {\r\n      return;\r\n    }\r\n  }\r\n\r\n  if (levelIsInfinite) {\r\n    try { multApi.set(infinityRequirementBn); } catch {}\r\n    lastSyncedCoinLevel = null;\r\n    lastSyncedCoinLevelWasInfinite = true;\r\n    lastSyncedCoinUsedApproximation = false;\r\n    lastSyncedCoinApproxKey = null;\r\n    return;\r\n  }\r\n\r\n  let multiplierBn;\r\n  if (levelBigInt != null && levelBigInt <= EXACT_COIN_LEVEL_LIMIT) {\r\n    let working = BigNum.fromInt(1);\r\n    const iterations = Number(levelBigInt);\r\n    for (let i = 0; i < iterations; i += 1) {\r\n      working = working.mulDecimal('1.1', 18);\r\n    }\r\n    let levelAdd;\r\n    try { levelAdd = BigNum.fromAny(levelBigInt.toString()); }\r\n    catch { levelAdd = BigNum.fromInt(iterations); }\r\n    if (typeof working.add === 'function') {\r\n      working = working.add(levelAdd);\r\n    } else if (typeof levelAdd.add === 'function') {\r\n      working = levelAdd.add(working);\r\n    }\r\n    multiplierBn = working.clone?.() ?? working;\r\n  } else {\r\n    multiplierBn = approximateCoinMultiplierFromBigNum(xpState.xpLevel);\r\n  }\r\n\r\n  let finalMultiplier = multiplierBn.clone?.() ?? multiplierBn;\r\n  const providers = coinMultiplierProviders.size > 0\r\n    ? Array.from(coinMultiplierProviders)\r\n    : (typeof externalCoinMultiplierProvider === 'function' ? [externalCoinMultiplierProvider] : []);\r\n  for (const provider of providers) {\r\n    if (typeof provider !== 'function') continue;\r\n    try {\r\n      const maybe = provider({\r\n        baseMultiplier: finalMultiplier.clone?.() ?? finalMultiplier,\r\n        xpLevel: xpState.xpLevel.clone?.() ?? xpState.xpLevel,\r\n        xpUnlocked: xpState.unlocked,\r\n      });\r\n      if (maybe instanceof BigNum) {\r\n        finalMultiplier = maybe.clone?.() ?? maybe;\r\n      } else if (maybe != null) {\r\n        finalMultiplier = BigNum.fromAny(maybe);\r\n      }\r\n    } catch {}\r\n  }\r\n\r\n  const multIsInf = finalMultiplier.isInfinite?.() || (typeof finalMultiplier.isInfinite === 'function' && finalMultiplier.isInfinite());\r\n  try { multApi.set(finalMultiplier.clone?.() ?? finalMultiplier); } catch {}\r\n  if (multIsInf) {\r\n    lastSyncedCoinLevel = null;\r\n    lastSyncedCoinLevelWasInfinite = true;\r\n    lastSyncedCoinUsedApproximation = false;\r\n    lastSyncedCoinApproxKey = null;\r\n  } else if (levelBigInt != null && levelBigInt <= EXACT_COIN_LEVEL_LIMIT) {\r\n    lastSyncedCoinLevel = levelBigInt;\r\n    lastSyncedCoinLevelWasInfinite = false;\r\n    lastSyncedCoinUsedApproximation = false;\r\n    lastSyncedCoinApproxKey = null;\r\n  } else {\r\n    lastSyncedCoinLevel = null;\r\n    lastSyncedCoinLevelWasInfinite = false;\r\n    lastSyncedCoinUsedApproximation = true;\r\n    lastSyncedCoinApproxKey = levelStorageKey;\r\n  }\r\n}\r\n\r\nfunction ensureStateLoaded(force = false) {\r\n  const slot = getActiveSlot();\r\n  if (slot == null) {\r\n    lastSlot = null;\r\n    stateLoaded = false;\r\n    xpState.unlocked = false;\r\n    resetLockedXpState();\r\n    return xpState;\r\n  }\r\n  if (!force && stateLoaded && slot === lastSlot) return xpState;\r\n  lastSlot = slot;\r\n  stateLoaded = true;\r\n  try {\r\n    const unlockedRaw = localStorage.getItem(KEY_UNLOCK(slot));\r\n    xpState.unlocked = unlockedRaw === '1';\r\n  } catch {\r\n    xpState.unlocked = false;\r\n  }\r\n  try {\r\n    xpState.xpLevel = BigNum.fromAny(localStorage.getItem(KEY_XP_LEVEL(slot)) ?? '0');\r\n  } catch {\r\n    xpState.xpLevel = bnZero();\r\n  }\r\n  try {\r\n    xpState.progress = BigNum.fromAny(localStorage.getItem(KEY_PROGRESS(slot)) ?? '0');\r\n  } catch {\r\n    xpState.progress = bnZero();\r\n  }\r\n\r\n  // If we loaded an infinite value (e.g. from debug/cheat), force unlock\r\n  // so we don't immediately reset it to zero in the locked check below.\r\n  if (bigNumIsInfinite(xpState.xpLevel) || bigNumIsInfinite(xpState.progress)) {\r\n    xpState.unlocked = true;\r\n  }\r\n\r\n  if (!xpState.unlocked) {\r\n    resetLockedXpState();\r\n    return xpState;\r\n  }\r\n\r\n  enforceXpInfinityInvariant();\r\n\r\n  updateXpRequirement();\r\n  syncCoinMultiplierWithXpLevel(true);\r\n  ensureXpStorageWatchers();\r\n  return xpState;\r\n}\r\n\r\nfunction persistState() {\r\n  const slot = getActiveSlot();\r\n  if (slot == null) return;\r\n\r\n  const expected = {\r\n    unlocked: xpState.unlocked ? '1' : '0',\r\n    level: xpState.xpLevel.toStorage(),\r\n    progress: xpState.progress.toStorage(),\r\n  };\r\n\r\n  try { localStorage.setItem(KEY_UNLOCK(slot), expected.unlocked); }\r\n  catch {}\r\n  try { localStorage.setItem(KEY_XP_LEVEL(slot), expected.level); }\r\n  catch {}\r\n  try { localStorage.setItem(KEY_PROGRESS(slot), expected.progress); }\r\n  catch {}\r\n\r\n  const persisted = (() => {\r\n    let unlocked = xpState.unlocked;\r\n    let level = xpState.xpLevel;\r\n    let progress = xpState.progress;\r\n    try { unlocked = localStorage.getItem(KEY_UNLOCK(slot)) === '1'; }\r\n    catch {}\r\n    try {\r\n      const rawLevel = localStorage.getItem(KEY_XP_LEVEL(slot));\r\n      if (rawLevel) level = BigNum.fromAny(rawLevel);\r\n    } catch {}\r\n    try {\r\n      const rawProgress = localStorage.getItem(KEY_PROGRESS(slot));\r\n      if (rawProgress) progress = BigNum.fromAny(rawProgress);\r\n    } catch {}\r\n    return { unlocked, level, progress };\r\n  })();\r\n\r\n  primeStorageWatcherSnapshot(KEY_UNLOCK(slot), persisted.unlocked ? '1' : '0');\r\n  primeStorageWatcherSnapshot(KEY_XP_LEVEL(slot), persisted.level?.toStorage?.() ?? expected.level);\r\n  primeStorageWatcherSnapshot(KEY_PROGRESS(slot), persisted.progress?.toStorage?.() ?? expected.progress);\r\n\r\n  const mismatch =\r\n    persisted.unlocked !== xpState.unlocked ||\r\n    (persisted.level?.toStorage?.() ?? null) !== expected.level ||\r\n    (persisted.progress?.toStorage?.() ?? null) !== expected.progress;\r\n\r\n  if (mismatch) {\r\n    xpState.unlocked = persisted.unlocked;\r\n    xpState.xpLevel = persisted.level;\r\n    xpState.progress = persisted.progress;\r\n    updateXpRequirement();\r\n    syncCoinMultiplierWithXpLevel(true);\r\n    updateHud();\r\n  }\r\n}\r\n\r\nfunction handleXpLevelUpRewards() {\r\n  syncCoinMultiplierWithXpLevel(true);\r\n\r\n  let reward = bnOne();\r\n  if (typeof externalBookRewardProvider === 'function') {\r\n    try {\r\n      const maybe = externalBookRewardProvider({\r\n        baseReward: reward.clone?.() ?? reward,\r\n        xpLevel: xpState.xpLevel.clone?.() ?? xpState.xpLevel,\r\n        xpUnlocked: xpState.unlocked,\r\n      });\r\n      if (maybe instanceof BigNum) {\r\n        reward = maybe.clone?.() ?? maybe;\r\n      } else if (maybe != null) {\r\n        reward = BigNum.fromAny(maybe);\r\n      }\r\n    } catch {}\r\n  }\r\n\r\n  try {\r\n    if (bank?.books?.addWithMultiplier) {\r\n      bank.books.addWithMultiplier(reward);\r\n    } else if (bank?.books?.add) {\r\n      bank.books.add(reward);\r\n    }\r\n  } catch {}\r\n  const syncedLevelInfo = xpLevelBigIntInfo(xpState.xpLevel);\r\n  if (!syncedLevelInfo.finite) {\r\n    lastSyncedCoinLevel = null;\r\n    lastSyncedCoinLevelWasInfinite = true;\r\n    lastSyncedCoinUsedApproximation = false;\r\n    lastSyncedCoinApproxKey = null;\r\n  } else if (syncedLevelInfo.bigInt != null) {\r\n    lastSyncedCoinLevel = syncedLevelInfo.bigInt;\r\n    lastSyncedCoinLevelWasInfinite = false;\r\n    lastSyncedCoinUsedApproximation = false;\r\n    lastSyncedCoinApproxKey = null;\r\n  } else {\r\n    lastSyncedCoinLevel = null;\r\n    lastSyncedCoinLevelWasInfinite = false;\r\n    lastSyncedCoinUsedApproximation = true;\r\n    lastSyncedCoinApproxKey = typeof xpState.xpLevel?.toStorage === 'function' ? xpState.xpLevel.toStorage() : null;\r\n  }\r\n}\r\n\r\nfunction updateHud() {\r\n  if (!ensureHudRefs()) return;\r\n  const { container, bar, fill, xpLevelValue, progress } = hudRefs;\r\n  if (!container) return;\r\n  if (!xpState.unlocked) {\r\n    container.setAttribute('hidden', '');\r\n    if (fill) {\r\n      fill.style.setProperty('--xp-fill', '0%');\r\n      fill.style.width = '0%';\r\n    }\r\n    if (xpLevelValue) xpLevelValue.textContent = '0';\r\n    if (progress) {\r\n      const reqHtml = formatNumber(requirementBn);\r\n      progress.innerHTML = `<span class=\"xp-progress-current\">0</span><span class=\"xp-progress-separator\">/</span><span class=\"xp-progress-required\">${reqHtml}</span><span class=\"xp-progress-suffix\">XP</span>`;\r\n    }\r\n    if (bar) {\r\n      bar.setAttribute('aria-valuenow', '0');\r\n      const reqPlain = stripHtml(formatNumber(requirementBn));\r\n      bar.setAttribute('aria-valuetext', `0 / ${reqPlain || '10'} XP`);\r\n    }\r\n    syncXpMpHudLayout();\r\n    return;\r\n  }\r\n\r\n  container.removeAttribute('hidden');\r\n  const requirement = requirementBn;\r\n  const ratio = progressRatio(xpState.progress, requirement);\r\n  const pct = `${(ratio * 100).toFixed(2)}%`;\r\n  if (fill) {\r\n    fill.style.setProperty('--xp-fill', pct);\r\n    fill.style.width = pct;\r\n  }\r\n  if (xpLevelValue) {\r\n    xpLevelValue.innerHTML = formatNumber(xpState.xpLevel);\r\n  }\r\n  if (progress) {\r\n    const currentHtml = formatNumber(xpState.progress);\r\n    const reqHtml = formatNumber(requirement);\r\n    progress.innerHTML = `<span class=\"xp-progress-current\">${currentHtml}</span><span class=\"xp-progress-separator\">/</span><span class=\"xp-progress-required\">${reqHtml}</span><span class=\"xp-progress-suffix\">XP</span>`;\r\n  }\r\n  if (bar) {\r\n    bar.setAttribute('aria-valuenow', (ratio * 100).toFixed(2));\r\n    const currPlain = stripHtml(formatNumber(xpState.progress));\r\n    const reqPlain = stripHtml(formatNumber(requirement));\r\n    bar.setAttribute('aria-valuetext', `${currPlain} / ${reqPlain} XP`);\r\n  }\r\n  syncXpMpHudLayout();\r\n}\r\n\r\nexport function initXpSystem({ forceReload = false } = {}) {\r\n  ensureHudRefs();\r\n  ensureStateLoaded(forceReload);\r\n  updateXpRequirement();\r\n  updateHud();\r\n  ensureXpStorageWatchers();\r\n  return getXpState();\r\n}\r\n\r\nexport function unlockXpSystem() {\r\n  ensureStateLoaded();\r\n  if (xpState.unlocked) {\r\n    updateHud();\r\n    return false;\r\n  }\r\n  resetLockedXpState();\r\n  xpState.unlocked = true;\r\n  persistState();\r\n  updateHud();\r\n  syncCoinMultiplierWithXpLevel(true);\r\n  try {\r\n    window.dispatchEvent(new CustomEvent('xp:unlock', { detail: getXpState() }));\r\n  } catch {}\r\n  return true;\r\n}\r\n\r\nexport function resetXpProgress({ keepUnlock = true } = {}) {\r\n  ensureStateLoaded();\r\n  const wasUnlocked = xpState.unlocked;\r\n  resetLockedXpState();\r\n  xpState.unlocked = keepUnlock ? (wasUnlocked || xpState.unlocked) : false;\r\n  persistState();\r\n  updateHud();\r\n  syncCoinMultiplierWithXpLevel(true);\r\n  return getXpState();\r\n}\r\n\r\nexport function addXp(amount, { silent = false } = {}) {\r\n  ensureStateLoaded();\r\n  const slot = lastSlot ?? getActiveSlot();\r\n\r\n  // If Progress is locked, we cannot accumulate XP without causing lag/reverts.\r\n  if (slot != null && isKeyLocked(KEY_PROGRESS(slot))) {\r\n    return {\r\n      unlocked: xpState.unlocked,\r\n      xpLevelsGained: bnZero(),\r\n      xpAdded: bnZero(),\r\n      xpLevel: xpState.xpLevel,\r\n      progress: xpState.progress,\r\n      requirement: requirementBn,\r\n      slot\r\n    };\r\n  }\r\n  \r\n  // 1. Basic Unlock Check\r\n  if (!xpState.unlocked) {\r\n    return {\r\n      unlocked: false,\r\n      xpLevelsGained: bnZero(),\r\n      xpAdded: bnZero(),\r\n      xpLevel: xpState.xpLevel,\r\n      requirement: requirementBn\r\n    };\r\n  }\r\n\r\n  // 2. Parse Input Amount\r\n  let inc;\r\n  try {\r\n    if (amount instanceof BigNum) {\r\n      inc = amount.clone?.() ?? BigNum.fromAny(amount ?? 0);\r\n    } else {\r\n      inc = BigNum.fromAny(amount ?? 0);\r\n    }\r\n  } catch {\r\n    inc = bnZero();\r\n  }\r\n\r\n  // 3. Apply Multipliers\r\n  if (!inc.isZero?.()) {\r\n    const providers = xpGainMultiplierProviders.size > 0\r\n      ? Array.from(xpGainMultiplierProviders)\r\n      : (typeof externalXpGainMultiplierProvider === 'function' ? [externalXpGainMultiplierProvider] : []);\r\n    for (const provider of providers) {\r\n      if (typeof provider !== 'function') continue;\r\n      try {\r\n        const maybe = provider({\r\n          baseGain: inc.clone?.() ?? inc,\r\n          xpLevel: xpState.xpLevel.clone?.() ?? xpState.xpLevel,\r\n          xpUnlocked: xpState.unlocked,\r\n        });\r\n        if (maybe instanceof BigNum) {\r\n          inc = maybe.clone?.() ?? maybe;\r\n        } else if (maybe != null) {\r\n          inc = BigNum.fromAny(maybe);\r\n        }\r\n      } catch {}\r\n    }\r\n  }\r\n\r\n  inc = applyStatMultiplierOverride('xp', inc);\r\n\r\n  // 4. Handle Zero Gain\r\n  if (inc.isZero?.() || (typeof inc.isZero === 'function' && inc.isZero())) {\r\n    updateHud();\r\n    return {\r\n      unlocked: true,\r\n      xpLevelsGained: bnZero(),\r\n      xpAdded: inc,\r\n      xpLevel: xpState.xpLevel,\r\n      requirement: requirementBn\r\n    };\r\n  }\r\n\r\n  // 5. Add to Progress\r\n  xpState.progress = xpState.progress.add(inc);\r\n  updateXpRequirement();\r\n\r\n  // Check if Level is locked before attempting to level up\r\n  const levelLocked = slot != null && isKeyLocked(KEY_XP_LEVEL(slot));\r\n\r\n  // 6. Handle Infinity (Early Exit)\r\n  const progressIsInf = bigNumIsInfinite(xpState.progress);\r\n  const levelIsInf = bigNumIsInfinite(xpState.xpLevel);\r\n  const gainIsInf = bigNumIsInfinite(inc);\r\n\r\n  if (progressIsInf || levelIsInf || gainIsInf) {\r\n    const inf = infinityRequirementBn.clone?.() ?? infinityRequirementBn;\r\n    \r\n    // Only set XP Level to infinity if it's not locked.\r\n    // If it is locked, it stays at its current value (unless it was already infinite).\r\n    if (!levelLocked) {\r\n        xpState.xpLevel = inf.clone?.() ?? inf;\r\n    }\r\n    \r\n    xpState.progress = inf.clone?.() ?? inf;\r\n    \r\n    // Requirement becomes infinity if level is infinity, OR if we force it.\r\n    // If level is finite but locked, requirement is finite.\r\n    // But we just set progress to infinity.\r\n    // If progress is infinite and requirement is finite, that's fine.\r\n    // We should recompute requirement based on actual level.\r\n    updateXpRequirement();\r\n\r\n    enforceXpInfinityInvariant();\r\n    persistState();\r\n    updateHud();\r\n    syncCoinMultiplierWithXpLevel(true);\r\n\r\n    const detail = {\r\n      unlocked: true,\r\n      xpLevelsGained: bnZero(),\r\n      xpAdded: inc.clone?.() ?? inc,\r\n      xpLevel: xpState.xpLevel.clone?.() ?? xpState.xpLevel,\r\n      progress: xpState.progress.clone?.() ?? xpState.progress,\r\n      requirement: requirementBn.clone?.() ?? requirementBn,\r\n      slot,\r\n    };\r\n    notifyXpSubscribers(detail);\r\n    if (!silent && typeof window !== 'undefined') {\r\n      try { window.dispatchEvent(new CustomEvent('xp:change', { detail })); } catch {}\r\n    }\r\n    return detail;\r\n  }\r\n\r\n  // 7. Bulk Level Calculation Logic\r\n  let xpLevelsGained = bnZero();\r\n\r\n  // Safety check: if progress < requirement, we are done immediately.\r\n  if (xpState.progress.cmp(requirementBn) < 0) {\r\n    persistState();\r\n    updateHud();\r\n    const detail = {\r\n      unlocked: true,\r\n      xpLevelsGained: bnZero(),\r\n      xpAdded: inc,\r\n      xpLevel: xpState.xpLevel,\r\n      progress: xpState.progress,\r\n      requirement: requirementBn,\r\n      slot,\r\n    };\r\n    notifyXpSubscribers(detail);\r\n    if (!silent && typeof window !== 'undefined') {\r\n      try { window.dispatchEvent(new CustomEvent('xp:change', { detail })); } catch {}\r\n    }\r\n    return detail;\r\n  }\r\n\r\n  if (!levelLocked) {\r\n      /* Optimization: \r\n         Instead of iterating one by one, we estimate the target level based on the log10 of current progress.\r\n         ...\r\n      */\r\n      \r\n      const currentProgressLog = approxLog10(xpState.progress);\r\n      // Constants derived from: Math.log10(1.1) + 0.1 * Math.log10(2.5)\r\n      // 0.04139... + 0.03979... \u2248 0.081186686\r\n      const COMBINED_LOG_FACTOR = 0.08118668602542883;\r\n\r\n      // We only switch to approximation if the gap is likely massive\r\n      const reqLog = approxLog10(requirementBn);\r\n      \r\n      if (currentProgressLog - reqLog > 2) {\r\n        const baseLevelBn = xpState.xpLevel;\r\n        \r\n        const logDiff = currentProgressLog - reqLog;\r\n        const estimatedGain = Math.floor(logDiff / COMBINED_LOG_FACTOR);\r\n        \r\n        if (estimatedGain > 10) {\r\n          const safeGain = BigInt(Math.max(0, estimatedGain - 5));\r\n          \r\n          if (safeGain > 0n) {\r\n            const jumpBn = BigNum.fromAny(safeGain.toString());\r\n            xpState.xpLevel = xpState.xpLevel.add(jumpBn);\r\n            xpLevelsGained = xpLevelsGained.add(jumpBn);\r\n            \r\n            updateXpRequirement();\r\n            \r\n             if (bank?.books?.add) {\r\n                try {\r\n                  let bulkReward = jumpBn.clone();\r\n                  bank.books.add(bulkReward);\r\n                } catch {}\r\n             }\r\n          }\r\n        }\r\n      }\r\n\r\n      // 8. Finalize with standard loop (Cleanup)\r\n      let guard = 0;\r\n      const limit = 500; // Hard limit to prevent freezes if approximation fails\r\n      \r\n      while (xpState.progress.cmp?.(requirementBn) >= 0 && guard < limit) {\r\n        xpState.progress = xpState.progress.sub(requirementBn);\r\n        xpState.xpLevel = xpState.xpLevel.add(bnOne());\r\n        xpLevelsGained = xpLevelsGained.add(bnOne());\r\n        \r\n        handleXpLevelUpRewards();\r\n        updateXpRequirement();\r\n        \r\n        const reqIsInf = bigNumIsInfinite(requirementBn);\r\n        if (reqIsInf) break;\r\n        guard += 1;\r\n      }\r\n      \r\n      if (guard >= limit && xpState.progress.cmp(requirementBn) >= 0) {\r\n          updateXpRequirement(); \r\n      }\r\n  }\r\n\r\n  // 9. Persist and Notify\r\n  persistState();\r\n  updateHud();\r\n\r\n  // Maintain sync flags logic from original\r\n  const syncedLevelAfterAdd = xpLevelBigIntInfo(xpState.xpLevel);\r\n  if (!syncedLevelAfterAdd.finite) {\r\n    lastSyncedCoinLevel = null;\r\n    lastSyncedCoinLevelWasInfinite = true;\r\n    lastSyncedCoinUsedApproximation = false;\r\n    lastSyncedCoinApproxKey = null;\r\n  } else if (syncedLevelAfterAdd.bigInt != null) {\r\n    lastSyncedCoinLevel = syncedLevelAfterAdd.bigInt;\r\n    lastSyncedCoinLevelWasInfinite = false;\r\n    lastSyncedCoinUsedApproximation = false;\r\n    lastSyncedCoinApproxKey = null;\r\n  } else {\r\n    lastSyncedCoinLevel = null;\r\n    lastSyncedCoinLevelWasInfinite = false;\r\n    lastSyncedCoinUsedApproximation = true;\r\n    lastSyncedCoinApproxKey = typeof xpState.xpLevel?.toStorage === 'function'\r\n      ? xpState.xpLevel.toStorage()\r\n      : null;\r\n  }\r\n\r\n  const detail = {\r\n    unlocked: true,\r\n    xpLevelsGained: xpLevelsGained.clone?.() ?? xpLevelsGained,\r\n    xpAdded: inc.clone?.() ?? inc,\r\n    xpLevel: xpState.xpLevel.clone?.() ?? xpState.xpLevel,\r\n    progress: xpState.progress.clone?.() ?? xpState.progress,\r\n    requirement: requirementBn.clone?.() ?? requirementBn,\r\n    slot,\r\n  };\r\n  \r\n  notifyXpSubscribers(detail);\r\n  if (!silent && typeof window !== 'undefined') {\r\n    try { window.dispatchEvent(new CustomEvent('xp:change', { detail })); } catch {}\r\n  }\r\n  return detail;\r\n}\r\n\r\nexport function getXpState() {\r\n  ensureStateLoaded();\r\n  return {\r\n    unlocked: xpState.unlocked,\r\n    xpLevel: xpState.xpLevel.clone?.() ?? xpState.xpLevel,\r\n    progress: xpState.progress.clone?.() ?? xpState.progress,\r\n    requirement: requirementBn.clone?.() ?? requirementBn,\r\n  };\r\n}\r\n\r\nexport function broadcastXpChange(detailOverrides = {}) {\r\n  ensureStateLoaded();\r\n  const slot = lastSlot ?? getActiveSlot();\r\n  const detail = {\r\n    ...getXpState(),\r\n    slot,\r\n    ...detailOverrides,\r\n  };\r\n\r\n  notifyXpSubscribers(detail);\r\n  if (typeof window !== 'undefined') {\r\n    try { window.dispatchEvent(new CustomEvent('xp:change', { detail })); } catch {}\r\n  }\r\n\r\n  return detail;\r\n}\r\n\r\nexport function isXpSystemUnlocked() {\r\n  ensureStateLoaded();\r\n  return !!xpState.unlocked;\r\n}\r\n\r\nexport function getXpRequirementForXpLevel(xpLevel) {\r\n  return xpRequirementForXpLevel(xpLevel);\r\n}\r\n\r\nexport function getXpGainMultiplier() {\r\n  ensureStateLoaded();\r\n  let mult = bnOne();\r\n  const providers = xpGainMultiplierProviders.size > 0\r\n    ? Array.from(xpGainMultiplierProviders)\r\n    : (typeof externalXpGainMultiplierProvider === 'function' ? [externalXpGainMultiplierProvider] : []);\r\n  for (const provider of providers) {\r\n    if (typeof provider !== 'function') continue;\r\n    try {\r\n      const maybe = provider({\r\n        baseGain: mult.clone?.() ?? mult,\r\n        xpLevel: xpState.xpLevel.clone?.() ?? xpState.xpLevel,\r\n        xpUnlocked: xpState.unlocked,\r\n      });\r\n      if (maybe instanceof BigNum) {\r\n        mult = maybe.clone?.() ?? maybe;\r\n      } else if (maybe != null) {\r\n        mult = BigNum.fromAny(maybe);\r\n      }\r\n    } catch {}\r\n  }\r\n  return mult;\r\n}\r\n\r\nexport function computeCoinMultiplierForXpLevel(levelValue) {\r\n  let xpLevelBn;\r\n  try {\r\n    xpLevelBn = levelValue instanceof BigNum ? levelValue : BigNum.fromAny(levelValue ?? 0);\r\n  } catch {\r\n    xpLevelBn = BigNum.fromInt(0);\r\n  }\r\n\r\n  const levelInfo = xpLevelBigIntInfo(xpLevelBn);\r\n  const levelBigInt = levelInfo.bigInt;\r\n  const levelIsInfinite = !levelInfo.finite;\r\n\r\n  if (levelIsInfinite) {\r\n    return infinityRequirementBn.clone?.() ?? infinityRequirementBn;\r\n  }\r\n\r\n  let multiplierBn;\r\n  if (levelBigInt != null && levelBigInt <= EXACT_COIN_LEVEL_LIMIT) {\r\n    let working = BigNum.fromInt(1);\r\n    const iterations = Number(levelBigInt);\r\n    for (let i = 0; i < iterations; i += 1) {\r\n      working = working.mulDecimal('1.1', 18);\r\n    }\r\n    let levelAdd;\r\n    try { levelAdd = BigNum.fromAny(levelBigInt.toString()); }\r\n    catch { levelAdd = BigNum.fromInt(iterations); }\r\n    if (typeof working.add === 'function') {\r\n      working = working.add(levelAdd);\r\n    } else if (typeof levelAdd.add === 'function') {\r\n      working = levelAdd.add(working);\r\n    }\r\n    multiplierBn = working.clone?.() ?? working;\r\n  } else {\r\n    multiplierBn = approximateCoinMultiplierFromBigNum(xpLevelBn);\r\n  }\r\n\r\n  let finalMultiplier = multiplierBn.clone?.() ?? multiplierBn;\r\n  const providers = coinMultiplierProviders.size > 0\r\n    ? Array.from(coinMultiplierProviders)\r\n    : (typeof externalCoinMultiplierProvider === 'function' ? [externalCoinMultiplierProvider] : []);\r\n  for (const provider of providers) {\r\n    if (typeof provider !== 'function') continue;\r\n    try {\r\n      const maybe = provider({\r\n        baseMultiplier: finalMultiplier.clone?.() ?? finalMultiplier,\r\n        xpLevel: xpLevelBn.clone?.() ?? xpLevelBn,\r\n        xpUnlocked: !!xpState.unlocked,\r\n      });\r\n      if (maybe instanceof BigNum) {\r\n        finalMultiplier = maybe.clone?.() ?? maybe;\r\n      } else if (maybe != null) {\r\n        finalMultiplier = BigNum.fromAny(maybe);\r\n      }\r\n    } catch {}\r\n  }\r\n\r\n  return finalMultiplier.clone?.() ?? finalMultiplier;\r\n}\r\n\r\nexport function setExternalCoinMultiplierProvider(fn) {\r\n  externalCoinMultiplierProvider = typeof fn === 'function' ? fn : null;\r\n  coinMultiplierProviders.clear();\r\n  if (externalCoinMultiplierProvider) {\r\n    coinMultiplierProviders.add(externalCoinMultiplierProvider);\r\n  }\r\n  ensureStateLoaded();\r\n  syncCoinMultiplierWithXpLevel(true);\r\n}\r\n\r\nexport function refreshCoinMultiplierFromXpLevel() {\r\n  ensureStateLoaded();\r\n  syncCoinMultiplierWithXpLevel(true);\r\n}\r\n\r\nexport function setExternalXpGainMultiplierProvider(fn) {\r\n  externalXpGainMultiplierProvider = typeof fn === 'function' ? fn : null;\r\n  xpGainMultiplierProviders.clear();\r\n  if (externalXpGainMultiplierProvider) {\r\n    xpGainMultiplierProviders.add(externalXpGainMultiplierProvider);\r\n  }\r\n}\r\n\r\nexport function addExternalCoinMultiplierProvider(fn) {\r\n  if (typeof fn !== 'function') return () => {};\r\n  coinMultiplierProviders.add(fn);\r\n  ensureStateLoaded();\r\n  syncCoinMultiplierWithXpLevel(true);\r\n  return () => {\r\n    coinMultiplierProviders.delete(fn);\r\n    ensureStateLoaded();\r\n    syncCoinMultiplierWithXpLevel(true);\r\n  };\r\n}\r\n\r\nexport function addExternalXpGainMultiplierProvider(fn) {\r\n  if (typeof fn !== 'function') return () => {};\r\n  xpGainMultiplierProviders.add(fn);\r\n  ensureStateLoaded();\r\n  return () => {\r\n    xpGainMultiplierProviders.delete(fn);\r\n  };\r\n}\r\n\r\nexport function setExternalBookRewardProvider(fn) {\r\n  externalBookRewardProvider = typeof fn === 'function' ? fn : null;\r\n}\r\n\r\nif (typeof window !== 'undefined') {\r\n  window.xpSystem = window.xpSystem || {};\r\n  Object.assign(window.xpSystem, {\r\n    initXpSystem,\r\n    unlockXpSystem,\r\n    addXp,\r\n    getXpState,\r\n    broadcastXpChange,\r\n    isXpSystemUnlocked,\r\n    getXpRequirementForXpLevel,\r\n    getXpGainMultiplier,\r\n    setExternalCoinMultiplierProvider,\r\n    addExternalCoinMultiplierProvider,\r\n    refreshCoinMultiplierFromXpLevel,\r\n    setExternalXpGainMultiplierProvider,\r\n    addExternalXpGainMultiplierProvider,\r\n    setExternalBookRewardProvider,\r\n    resetXpProgress,\r\n  });\r\n}\r\n", "// js/util/ghostTapGuard.js\r\n// Fixes issue with buttons on mobile that prevents them from being spam clicked\r\n// It's important that this is applied to every clickable button in the game\r\n\r\nconst DEFAULT_TIMEOUT_MS = 0;\r\nconst ELEMENT_SKIP_PROP = Symbol('ccc:ghostTap:skipUntil');\r\nconst GLOBAL_SKIP_PROP = '__cccGhostTapSkipUntil';\r\nconst TARGET_SELECTOR = '[data-ghost-tap-target], button, [role=\"button\"], [data-btn], .game-btn, .btn, .slot-card, a[href], input, select, textarea, summary';\r\nconst DEFAULT_LONG_PRESS_MS = 80;\r\n\r\nlet guardInstalled = false;\r\nlet selector = TARGET_SELECTOR;\r\nlet hasPointerEvents = false;\r\nlet hasTouchEvents = false;\r\nlet lastMarkedTarget = null;\r\nlet lastTouchMs = 0;\r\nlet lastTouchStartMs = 0;\r\nlet lastTouchDurationMs = 0;\r\nlet longPressMs = DEFAULT_LONG_PRESS_MS;\r\n\r\nfunction nowMs() {\r\n  if (typeof performance !== 'undefined' && typeof performance.now === 'function') {\r\n    return performance.now();\r\n  }\r\n  return Date.now();\r\n}\r\n\r\nfunction getDocument() {\r\n  if (typeof document === 'undefined') return null;\r\n  return document;\r\n}\r\n\r\nfunction findTapTarget(node) {\r\n  const doc = getDocument();\r\n  if (!doc) return null;\r\n  const ElementCtor = typeof Element !== 'undefined' ? Element : null;\r\n  if (!node || !ElementCtor) return null;\r\n  if (!(node instanceof ElementCtor)) {\r\n    node = node.parentElement;\r\n  }\r\n  if (!node || !node.closest) return null;\r\n  return node.closest(selector);\r\n}\r\n\r\nfunction clearGhostTapTarget(el) {\r\n  if (!el) return;\r\n  el[ELEMENT_SKIP_PROP] = 0;\r\n}\r\n\r\nfunction markGhostTapTarget(el, timeout = DEFAULT_TIMEOUT_MS, globalTimeout = null) {\r\n  if (!el) return;\r\n  const now = nowMs();\r\n  const delay = Number.isFinite(timeout) ? Math.max(0, Number(timeout)) : DEFAULT_TIMEOUT_MS;\r\n  if (delay > 0) {\r\n    el[ELEMENT_SKIP_PROP] = now + delay;\r\n  } else {\r\n    el[ELEMENT_SKIP_PROP] = 0;\r\n  }\r\n  lastMarkedTarget = el;\r\n\r\n  const gDelay = globalTimeout !== null\r\n    ? (Number.isFinite(globalTimeout) ? Math.max(0, Number(globalTimeout)) : DEFAULT_TIMEOUT_MS)\r\n    : delay;\r\n\r\n  if (gDelay > 0) suppressNextGhostTap(gDelay);\r\n}\r\n\r\nfunction consumeGhostTapGuard(target) {\r\n  if (typeof window === 'undefined') return false;\r\n  const until = window[GLOBAL_SKIP_PROP];\r\n  if (typeof until !== 'number') return false;\r\n\r\n  const now = nowMs();\r\n  if (now <= until) {\r\n    // We intentionally removed the \"return false if target matches\" logic\r\n    // because we now rely on !event.isTrusted to let the synthetic click pass.\r\n    // So if the guard is active, we BLOCK (return true).\r\n    return true;\r\n  }\r\n\r\n  // If expired, clear it\r\n  window[GLOBAL_SKIP_PROP] = null;\r\n  return false;\r\n}\r\n\r\nfunction shouldSkipGhostTap(el) {\r\n  if (!el) return false;\r\n  const until = Number(el[ELEMENT_SKIP_PROP] || 0);\r\n  if (!Number.isFinite(until) || until <= 0) return false;\r\n  const now = nowMs();\r\n  if (now <= until) {\r\n    // Always block if the element is marked and time hasn't passed.\r\n    // We removed the \"allow first match\" logic here too.\r\n    clearGhostTapTarget(el);\r\n    return true;\r\n  }\r\n  clearGhostTapTarget(el);\r\n  return false;\r\n}\r\n\r\nfunction suppressNextGhostTap(timeout = DEFAULT_TIMEOUT_MS) {\r\n  if (typeof window === 'undefined') return;\r\n  const now = nowMs();\r\n  const targetDelay = Math.max(0, Number.isFinite(timeout) ? timeout : DEFAULT_TIMEOUT_MS);\r\n  if (targetDelay <= 0) {\r\n    window[GLOBAL_SKIP_PROP] = null;\r\n    return;\r\n  }\r\n  const target = now + targetDelay;\r\n  const current = typeof window[GLOBAL_SKIP_PROP] === 'number'\r\n    ? window[GLOBAL_SKIP_PROP]\r\n    : 0;\r\n  window[GLOBAL_SKIP_PROP] = Math.max(current, target);\r\n}\r\n\r\nfunction onPointerStart(event) {\r\n  if (event.pointerType === 'mouse') return;\r\n  if (typeof event.button === 'number' && event.button !== 0) return;\r\n  lastTouchMs = lastTouchStartMs = nowMs();\r\n  lastTouchDurationMs = 0;\r\n  // Note: We removed consumeGhostTapGuard here to allow rapid \"spam\" taps.\r\n  // We only block the resulting *clicks* in onClickCapture.\r\n}\r\n\r\nfunction onTouchStart(event) {\r\n  lastTouchMs = lastTouchStartMs = nowMs();\r\n  lastTouchDurationMs = 0;\r\n  // Note: We removed consumeGhostTapGuard here to allow rapid \"spam\" taps.\r\n}\r\n\r\nfunction onPointerEnd(event) {\r\n  if (event.pointerType === 'mouse') return;\r\n  if (typeof event.button === 'number' && event.button !== 0) return;\r\n  const now = nowMs();\r\n  if (lastTouchStartMs > 0) {\r\n    lastTouchDurationMs = now - lastTouchStartMs;\r\n  }\r\n  lastTouchMs = now;\r\n}\r\n\r\nfunction onTouchEnd() {\r\n  const now = nowMs();\r\n  if (lastTouchStartMs > 0) {\r\n    lastTouchDurationMs = now - lastTouchStartMs;\r\n  }\r\n  lastTouchMs = now;\r\n}\r\n\r\nfunction onClickCapture(event) {\r\n  // Always allow synthetic/programmatic clicks (e.g. from handleInstantClick)\r\n  if (!event.isTrusted) return;\r\n\r\n  const now = nowMs();\r\n  const sinceTouchStart = lastTouchStartMs > 0 ? now - lastTouchStartMs : -1;\r\n  \r\n  // If we have a running guard (Element or Global), check it.\r\n  const target = findTapTarget(event.target);\r\n\r\n  // Check element-specific guard first (fixes hold-release double tap)\r\n  if (shouldSkipGhostTap(target)) {\r\n    lastTouchDurationMs = 0;\r\n    event.preventDefault();\r\n    event.stopImmediatePropagation();\r\n    return;\r\n  }\r\n\r\n  // Check global guard (fixes ghost taps on other elements)\r\n  if (consumeGhostTapGuard(target)) {\r\n    if (target) clearGhostTapTarget(target);\r\n    lastTouchDurationMs = 0;\r\n    event.preventDefault();\r\n    event.stopImmediatePropagation();\r\n    return;\r\n  }\r\n\r\n  if (sinceTouchStart < 0) return;\r\n  if (!target) return;\r\n\r\n  const effectiveDuration = lastTouchDurationMs || sinceTouchStart;\r\n\r\n  if (effectiveDuration >= longPressMs) {\r\n    clearGhostTapTarget(target);\r\n    lastTouchDurationMs = 0;\r\n    event.preventDefault();\r\n    event.stopImmediatePropagation();\r\n    return;\r\n  }\r\n  \r\n  lastTouchDurationMs = 0;\r\n}\r\n\r\n\r\nexport function installGhostTapGuard(options = {}) {\r\n  if (guardInstalled) return;\r\n  const doc = getDocument();\r\n  if (!doc || typeof window === 'undefined') return;\r\n\r\n  guardInstalled = true;\r\n  hasPointerEvents = 'PointerEvent' in window;\r\n  hasTouchEvents = !hasPointerEvents && 'ontouchstart' in window;\r\n  if (options.selector) {\r\n    selector = `${options.selector}, ${TARGET_SELECTOR}`;\r\n  }\r\n\r\n  if (Number.isFinite(options.longPressMs) && options.longPressMs >= 0) {\r\n    longPressMs = options.longPressMs;\r\n  }\r\n\r\n  doc.addEventListener('click', onClickCapture, true);\r\n\r\n  if (hasPointerEvents) {\r\n    doc.addEventListener('pointerdown', onPointerStart, { capture: true, passive: false });\r\n    doc.addEventListener('pointerup', onPointerEnd, { capture: true, passive: true });\r\n  } else if (hasTouchEvents) {\r\n    doc.addEventListener('touchstart', onTouchStart, { capture: true, passive: false });\r\n    doc.addEventListener('touchend', onTouchEnd, { capture: true, passive: true });\r\n  }\r\n}\r\n\r\nfunction handleInstantClick(event) {\r\n  if (event.pointerType === 'mouse') return;\r\n  if (typeof event.button === 'number' && event.button !== 0) return;\r\n  if (!event.isTrusted) return;\r\n\r\n  const target = event.target;\r\n  if (!target) return;\r\n\r\n  // We only want to auto-trigger elements that look like buttons\r\n  const buttonLike = target.closest(TARGET_SELECTOR);\r\n  if (!buttonLike) return;\r\n\r\n  // EXCLUSIONS:\r\n  // Scrollable areas where we don't want accidental taps during scroll starts\r\n  // (Shop lists, Merchant dialogue lists)\r\n  // NOTE: .debug-panel and .debug-panel-action-log are intentionally NOT excluded\r\n  // to allow ghost tapping on debug buttons as per user request.\r\n  \r\n  // Exclude Shop list\r\n  if (buttonLike.closest('.shop-scroller')) return;\r\n\r\n  // Exclude Automation Shop list\r\n  if (buttonLike.closest('.automation-shop-scroller')) return;\r\n  \r\n  // Exclude Dialogue list\r\n  if (buttonLike.closest('.merchant-dialogue-list') && !buttonLike.closest('.merchant-firstchat')) return;\r\n\r\n  // If a specific element asked to avoid this logic, bail\r\n  if (buttonLike.dataset.noGhost === 'true') return;\r\n\r\n  // Manually \"click\" it immediately to bypass the 300ms delay or touch-drag threshold\r\n  // Mark it so we don't double-fire if the browser also sends a click later.\r\n  // We use a long timeout (2000ms) for the element to prevent \"hold\" double-taps,\r\n  // but a short global timeout (300ms) to avoid blocking other elements if the user taps rapidly.\r\n  markGhostTapTarget(buttonLike, 2000, 300);\r\n\r\n  // We don't preventDefault() here because that might kill scrolling or other behaviors,\r\n  // but since we excluded scrollable areas, we assume these are static HUD buttons.\r\n  // Actually, for instant response we usually DO prevent default to stop the emulation...\r\n  // but let's try just triggering the click.\r\n\r\n  // Actually, standard ghost tap pattern: prevent default to stop the emulation,\r\n  // then dispatch our own click.\r\n  if (event.cancelable) event.preventDefault();\r\n  buttonLike.click();\r\n}\r\n\r\nexport function initGlobalGhostTap() {\r\n  const doc = getDocument();\r\n  if (!doc || typeof window === 'undefined') return;\r\n\r\n  const hasPointer = 'PointerEvent' in window;\r\n  if (hasPointer) {\r\n    // capturing phase to intercept before internal UI logic\r\n    doc.addEventListener('pointerdown', handleInstantClick, { capture: false, passive: false });\r\n  } else if ('ontouchstart' in window) {\r\n    doc.addEventListener('touchstart', handleInstantClick, { capture: false, passive: false });\r\n  }\r\n}\r\n\r\nexport {\r\n  clearGhostTapTarget,\r\n  markGhostTapTarget,\r\n  shouldSkipGhostTap,\r\n  suppressNextGhostTap,\r\n  consumeGhostTapGuard,\r\n  DEFAULT_TIMEOUT_MS as GHOST_TAP_TIMEOUT_MS,\r\n};\r\n\r\nexport function setGhostTapSelector(extraSelector) {\r\n  if (!extraSelector) return;\r\n  selector = `${extraSelector}, ${TARGET_SELECTOR}`;\r\n}\r\n", "export const MERCHANT_DIALOGUES = {\r\n  0: {\r\n    start: 'n0',\r\n    nodes: {\r\n      n0: { type: 'line', say: 'So you want to delve deeper within my Shop, do you?', next: 'c1' },\r\n\r\n      r_who: { type: 'line', say: 'I am the Merchant.', next: 'c2' },\r\n      r_where: { type: 'line', say: 'The Cove.',          next: 'c2' },\r\n      r_confused: { type: 'line', say: 'Okay.',                next: 'c3' },\r\n\r\n      c1: { type: 'choice', options: [\r\n        { label: 'Who are you?', to: 'r_who' },\r\n        { label: 'Where am I?', to: 'r_where' },\r\n        { label: 'I just clicked on this green button and now I\u2019m confused.', to: 'r_confused' },\r\n      ]},\r\n\r\n      c2: { type: 'choice', options: [\r\n        { label: 'What?', to: 'r2_what' }, \r\n        { label: 'That\u2019s not helpful.', to: 'r2_okay' }, \r\n        { label: 'Okay.', to: 'r2_okay' }, \r\n      ]},\r\n\r\n      r2_what: { type: 'line', say: 'What?', next: 'c3' },\r\n      r2_okay:   { type: 'line', say: 'Okay.',   next: 'c3' },\r\n\r\n      c3: { type: 'choice', options: [\r\n        { label: 'What?', to: 'r2_what' },\r\n        { label: 'That\u2019s not helpful.', to: 'r2_okay' },\r\n        { label: 'Goodbye.', to: 'end' },\r\n      ]},\r\n    }\r\n  },\r\n  1: {\r\n    start: 'n0',\r\n    nodes: {\r\n      n0: { type: 'line', say: 'Hello again.', next: 'c0' },\r\n\r\n      c0: { type: 'choice', options: [\r\n        { label: 'You never answered my questions.', to: 'm1a' },\r\n        { label: 'Hello.', to: 'm1b' },\r\n        { label: 'I am still very confused.', to: 'm1c' },\r\n      ]},\r\n\r\n      m1a: { type: 'line', say: 'Yes I did.', next: 'c1a' },\r\n      m1b: { type: 'line', say: 'Hello.',    next: 'c1b' },\r\n      m1c: { type: 'line', say: 'Okay.',       next: 'c1e' },\r\n\t  m1d: { type: 'line', say: 'Fine.',       next: 'c1d' },\r\n\r\n      c1a: { type: 'choice', options: [\r\n        { label: 'No you didn\u2019t.', to: 'm1a' },\r\n        { label: 'Incorrect.',          to: 'm2a' },\r\n        { label: 'Okay I guess you\u2019re right.', to: 'm2b' },\r\n      ]},\r\n\r\n      c1b: { type: 'choice', options: [\r\n        { label: 'You never answered my questions.', to: 'm1a' },\r\n        { label: 'How are you?',              to: 'm1d' },\r\n        { label: 'Okay.',                              to: 'm2b' },\r\n      ]},\r\n\r\n      c1c: { type: 'choice', options: [\r\n        { label: 'Yes.',  to: 'm2a' },\r\n        { label: 'Hmm\u2026',  to: 'm1c' },\r\n        { label: 'Okay.',   to: 'm2b' },\r\n      ]},\r\n\t  \r\n\t  c1d: { type: 'choice', options: [\r\n        { label: 'That\\'s nice.',  to: 'm2b' },\r\n        { label: 'Good.',  to: 'm2b' },\r\n        { label: 'Okay.',   to: 'm2b' },\r\n      ]},\r\n\t  c1e: { type: 'choice', options: [\r\n        { label: '...',  to: 'm2b' },\r\n        { label: '...',  to: 'm2b' },\r\n        { label: '...',   to: 'm2b' },\r\n      ]},\r\n\r\n      m2a: { type: 'line', say: 'No.', next: 'c1c' },\r\n      m2b: { type: 'line', say: 'Would you like some Coins? Free of charge. You look like you could use some right now.', next: 'c2a' },\r\n\r\n      c2a: { type: 'choice', options: [\r\n        { label: 'What?',                to: 'm3a' },\r\n        { label: 'No.',        to: 'm3b' },\r\n        { label: 'Give me the coins now.', to: 'end' },\r\n      ]},\r\n\r\n      m3a: { type: 'line', say: 'What?', next: 'c2a' },\r\n      m3b: { type: 'line', say: 'Okay, no Coins for you then.', next: 'c2b' },\r\n\r\n      c2b: { type: 'choice', options: [\r\n        { label: 'No wait, actually I want the coins. Give them to me now.', to: 'end' },\r\n        { label: 'On second thought, maybe I do want the coins. Give them to me now.', to: 'end' },\r\n        { label: 'Okay, bye, I don\u2019t need your filthy coins anyway.', to: 'end_nr' },\r\n      ]},\r\n    }\r\n  },\r\n  2: {\r\n    start: 'n0',\r\n    nodes: {\r\n      n0: { type: 'line', say: 'I see you\u2019ve unlocked the XP system.', next: 'c0' },\r\n\r\n      c0: { type: 'choice', options: [\r\n        { label: 'What does it do?',      to: 'm1a' },\r\n        { label: 'What does that mean?',  to: 'm1b' },\r\n        { label: 'Yes I did that.',       to: 'm1c' },\r\n      ]},\r\n\r\n      m1a: { type: 'line', say: 'Good things.', next: 'c1a' },\r\n      m1b: { type: 'line', say: 'It means something.', next: 'c1b' },\r\n      m1c: { type: 'line', say: 'And do you know how the XP system works?', next: 'c1c' },\r\n\t  m1d: { type: 'line', say: 'You\\'ll be fine, you don\\'t really need to know how it works anyway.', next: 'c1d' },\r\n\t  m1e: { type: 'line', say: 'No.', next: 'c1d' },\r\n\r\n      c1a: { type: 'choice', options: [\r\n        { label: 'Why does this thing even exist?', to: 'm2b' },\r\n        { label: 'What does that mean?',                               to: 'm1b' },\r\n        { label: 'Okay.',                                              to: 'm3a' },\r\n      ]},\r\n      c1b: { type: 'choice', options: [\r\n        { label: 'Can you explain in more detail?', to: 'm1e' },\r\n        { label: 'What?',                           to: 'm2g' },\r\n        { label: 'Okay.',                          to: 'm3a' },\r\n      ]},\r\n      c1c: { type: 'choice', options: [\r\n        { label: 'I have no idea.',              to: 'm1d' },\r\n        { label: 'I don\u2019t know the full details.', to: 'm1d' },\r\n        { label: 'Yes.',                         to: 'm3a' },\r\n      ]},\r\n\t   c1d: { type: 'choice', options: [\r\n        { label: '...',              to: 'm3a' },\r\n        { label: '...', to: 'm3a' },\r\n        { label: '...',                         to: 'm3a' },\r\n      ]},\r\n\t  \r\n      m2b: { type: 'line', say: 'I dunno.', next: 'c2b' },\r\n      m2c: { type: 'line', say: 'Because I dunno.', next: 'c2c' },\r\n      m2d: { type: 'line', say: 'What?',    next: 'c2c' },\r\n      m2e: { type: 'line', say: 'I\u2019ve already told you, so you can increase your Coin output.', next: 'c2d' },\r\n      m2f: { type: 'line', say: 'Are you sure you don\u2019t want free Books?', next: 'c3a' },\r\n\t  m2g: { type: 'line', say: 'What?', next: 'c2c' },\r\n\r\n      c2a: { type: 'choice', options: [\r\n\t    { label: 'No.',                               to: 'm2f' },\r\n\t\t{ label: 'Why are you giving me all this free stuff?', to: 'm2e' },\r\n\t\t{ label: 'Yeah, sure.',                       to: 'end' },\r\n      ]},\r\n      c2b: { type: 'choice', options: [\r\n        { label: 'What?', to: 'm2d' },\r\n        { label: 'Why not?',  to: 'm2c' },\r\n        { label: '\u2026',     to: 'm3a' },\r\n      ]},\r\n      c2c: { type: 'choice', options: [\r\n        { label: '\u2026', to: 'm3a' },\r\n        { label: '\u2026', to: 'm3a' },\r\n        { label: '\u2026', to: 'm3a' },\r\n      ]},\r\n\t  c2d: { type: 'choice', options: [\r\n        { label: '\u2026', to: 'm3b' },\r\n        { label: '\u2026', to: 'm3b' },\r\n        { label: '\u2026', to: 'm3b' },\r\n      ]},\r\n\r\n      m3a: { type: 'line', say: 'Would you like some Books? Free of charge. They will help you accelerate your Coin output.', next: 'c2a' },\r\n      m3b: { type: 'line', say: 'Let me ask again, do you want free Books?', next: 'c3b' },\r\n\r\n      c3a: { type: 'choice', options: [\r\n        { label: 'Okay, actually give me the free stuff.',        to: 'end' },\r\n        { label: 'Okay fine, I\u2019ll take those books off your hands.', to: 'end' },\r\n        { label: 'I don\u2019t need your charity.',                    to: 'end_nr' },\r\n      ]},\r\n\t  c3b: { type: 'choice', options: [\r\n        { label: 'Yes please.',        to: 'end' },\r\n        { label: 'Sure.',                 to: 'end' },\r\n        { label: 'No.',                    to: 'end_nr' },\r\n      ]},\r\n    }\r\n  },\r\n  3: {\r\n    start: 'n0',\r\n    nodes: {\r\n      n0:  { type: 'line', say: 'What do you want now?', next: 'c0' },\r\n\r\n      c0:  { type: 'choice', options: [\r\n        { label: 'I\u2019d like to ask some questions about how the forge works.',     to: 'm1a' },\r\n        { label: 'I\u2019d like to ask some questions about how mutations work.',      to: 'm1b' },\r\n        { label: 'Oh, um, I forgot.',                                             to: 'm1c' },\r\n      ]},\r\n\r\n      m1a: { type: 'line', say: 'Sure, ask me anything about the Forge and I will answer.',     next: 'c1a' },\r\n      m1b: { type: 'line', say: 'Sure, ask me anything about Mutations and I will answer.',     next: 'c1b' },\r\n      m1c: { type: 'line', say: 'What do you mean you forgot??',                                                            next: 'c3b' },\r\n\r\n      c1a: { type: 'choice', options: [\r\n        { label: 'Where did it come from?',                       to: 'm2a' },\r\n        { label: 'How do I get more gold from it?',              to: 'm2b' },\r\n        { label: 'What is the benefit of forging my coins?',     to: 'm2c' },\r\n      ]},\r\n\r\n      c1b: { type: 'choice', options: [\r\n        { label: 'Why do they exist?',              to: 'm2d' },\r\n        { label: 'What do mutations do for me?',    to: 'm2e' },\r\n        { label: 'Why are they important at all?',  to: 'm2f' },\r\n      ]},\r\n\r\n      m2a: { type: 'line', say: 'I made it.', next: 'c2a' },\r\n      m2b: { type: 'line', say: 'Increase your Coins and XP Level to boost the output of the Forge.', next: 'c2b' },\r\n      m2c: { type: 'line', say: 'Trust me, it\u2019ll pay off in the future.', next: 'c2c' },\r\n      m2d: { type: 'line', say: 'They just do.', next: 'c3a' },\r\n      m2e: { type: 'line', say: 'Something.', next: 'c2d' },\r\n      m2f: { type: 'line', say: 'They just are.', next: 'c3a' },\r\n\r\n      c2a: { type: 'choice', options: [\r\n        { label: 'Really?', to: 'm3a' },\r\n        { label: 'Wow.',    to: 'm4a' },\r\n        { label: 'Okay.',   to: 'm4a' },\r\n      ]},\r\n\r\n      c2b: { type: 'choice', options: [\r\n        { label: 'What does \u201Cincrease\u201D mean?', to: 'm3b' },\r\n        { label: 'Why does it work like that?', to: 'm3c' },\r\n        { label: 'Okay.',                       to: 'm4a' },\r\n      ]},\r\n\r\n      c2c: { type: 'choice', options: [\r\n        { label: 'That didn\u2019t really answer my question.', to: 'm3d' },\r\n        { label: 'But how can you prove that?',            to: 'm3e' },\r\n        { label: 'Okay.',                                  to: 'm4a' },\r\n      ]},\r\n\r\n      c2d: { type: 'choice', options: [\r\n        { label: 'How will I know if a coin is mutated?', to: 'm3f' },\r\n        { label: 'Not helpful but alright.',                     to: 'm4a' },\r\n        { label: 'Okay.',                                 to: 'm4a' },\r\n      ]},\r\n\r\n      m3a: { type: 'line', say: 'Nope. I lied.', next: 'c3a' },\r\n      m3b: { type: 'line', say: 'Number goes up. You know how this works.', next: 'c3a' },\r\n      m3c: { type: 'line', say: 'It just does.', next: 'c3a' },\r\n      m3d: { type: 'line', say: 'Yes it did.', next: 'c3a' },\r\n      m3e: { type: 'line', say: 'Trust in the process.', next: 'c3a' },\r\n      m3f: { type: 'line', say: 'Just look at it.', next: 'c3a' },\r\n\r\n      c3a: { type: 'choice', options: [\r\n        { label: '\u2026', to: 'm4a' },\r\n        { label: '\u2026', to: 'm4a' },\r\n        { label: '\u2026', to: 'm4a' },\r\n      ]},\r\n\t  \r\n\t  c3b: { type: 'choice', options: [\r\n        { label: '\u2026', to: 'm4b' },\r\n        { label: '\u2026', to: 'm4b' },\r\n        { label: '\u2026', to: 'm4b' },\r\n      ]},\r\n\r\n      m4a: { type: 'line', say: 'Any more questions?', next: 'c4a' },\r\n      m4b: { type: 'line', say: 'Well you have to ask me something while you\\'re here.', next: 'c4a' },\r\n\r\n      c4a: { type: 'choice', options: [\r\n        { label: 'I\u2019d like to learn more about the forge.',     to: 'm1a' },\r\n        { label: 'I\u2019d like to learn more about mutations.',     to: 'm1b' },\r\n        { label: 'I think I\u2019m good.',                           to: 'm5a' },\r\n      ]},\r\n\r\n      m5a: { type: 'line', say: 'Here, have some Gold. I\u2019m not even going to let you decline my gift.', next: 'c5a' },\r\n\r\n      c5a: { type: 'choice', options: [\r\n        { label: 'Oh, cool, thanks for the free stuff.',      to: 'end' },\r\n        { label: 'Okay, I\u2019ll put this gold to good use.',     to: 'end' },\r\n        { label: '\u2026',                                         to: 'end' },\r\n      ]},\r\n    }\r\n  },\r\n  4: {\r\n  start: 'n0',\r\n  nodes: {\r\n    n0: { type: 'line', say: 'I\u2019m sure you came to me to learn a few things about how my Magic works, is that correct?', next: 'c0' },\r\n\r\n    c0: { type: 'choice', options: [\r\n      { label: 'Yes, I\u2019d like to know more about your magic.', to: 'm1a' },\r\n      { label: 'Actually, I\u2019m more interested in how automation works.', to: 'm1b' },\r\n      { label: 'Nah just give me free stuff.', to: 'm1c' },\r\n    ]},\r\n\r\n    m1a: { type: 'line', say: 'What would you like to know?', next: 'c1a' },\r\n    m1b: { type: 'line', say: 'What would you like to know?', next: 'c1b' },\r\n    m1c: { type: 'line', say: 'Wow. Just wow.', next: 'c1c' },\r\n\r\n    c1a: { type: 'choice', options: [\r\n      { label: 'Why do you have magic powers?', to: 'm2a' },\r\n      { label: 'Where did you get magic powers from?', to: 'm2b' },\r\n      { label: 'If you have magic powers, why can\u2019t you just summon all the coins in the world?', to: 'm2c' },\r\n    ]},\r\n\r\n    c1b: { type: 'choice', options: [\r\n      { label: 'Why does it exist?',                    to: 'm2d' },\r\n      { label: 'What kinds of things can be automated?', to: 'm2e' },\r\n      { label: 'How is automation different from doing things manually?', to: 'm2f' },\r\n    ]},\r\n\r\n    c1c: { type: 'choice', options: [\r\n      { label: 'What?', to: 'm2g' },\r\n      { label: 'Come on, where\u2019s the reward at?', to: 'm2g' },\r\n      { label: 'Was it something I said?', to: 'm2h' },\r\n    ]},\r\n\r\n    m2a: { type: 'line', say: 'I just do.', next: 'c2a' },\r\n    m2b: { type: 'line', say: 'I\\'ve always had them.', next: 'c2b' },\r\n    m2c: { type: 'line', say: 'Because Coins are just built different like that.', next: 'c2c' },\r\n    m2d: { type: 'line', say: 'Because it\u2019s necessary to speed up Coin collection.', next: 'c2d' },\r\n    m2e: { type: 'line', say: 'Everything.', next: 'c2e' },\r\n    m2f: { type: 'line', say: 'It\u2019s just better. I don\u2019t have to explain why.', next: 'c2f' },\r\n    m2g: { type: 'line', say: 'Don\u2019t you want to chat with me for a bit? Don\u2019t you have some questions you want to ask me?', next: 'c2g' },\r\n    m2h: { type: 'line', say: 'Yes.', next: 'c2h' },\r\n\r\n    c2a: { type: 'choice', options: [\r\n      { label: 'What?', to: 'm3a' },\r\n      { label: 'Can you actually answer my question?', to: 'm3b' },\r\n      { label: '\u2026', to: 'm6a' },\r\n    ]},\r\n\r\n    c2b: { type: 'choice', options: [\r\n      { label: 'How long have you had them?', to: 'm3c' },\r\n      { label: 'What can your magic powers do?', to: 'm3d' },\r\n      { label: 'Okay.', to: 'm6a' },\r\n    ]},\r\n\r\n    c2c: { type: 'choice', options: [\r\n      { label: 'How so?', to: 'm3e' },\r\n      { label: 'Your powers must be super weak then.', to: 'm5a' },\r\n      { label: 'Understandable.', to: 'm6a' },\r\n    ]},\r\n\r\n    c2d: { type: 'choice', options: [\r\n      { label: 'What if I just don\u2019t buy any automation?', to: 'm3f' },\r\n      { label: 'How?',                                     to: 'm3g' },\r\n      { label: 'Okay.',                                    to: 'm6a' },\r\n    ]},\r\n\r\n    c2e: { type: 'choice', options: [\r\n      { label: 'Could I even automate talking to you?', to: 'm3h' },\r\n      { label: 'So like, eventually everything would be progressing on its own?', to: 'm3i' },\r\n      { label: 'Okay.', to: 'm6a' },\r\n    ]},\r\n\r\n    c2f: { type: 'choice', options: [\r\n      { label: 'Why should I buy automation if you can\u2019t even explain why it\u2019s better than doing things manually?', to: 'm3j' },\r\n      { label: 'But I wanted an explanation.', to: 'm5a' },\r\n      { label: 'Okay.', to: 'm6a' },\r\n    ]},\r\n\r\n    c2g: { type: 'choice', options: [\r\n      { label: 'No.', to: 'm7b' },\r\n      { label: 'Not really.', to: 'm7b' },\r\n      { label: 'My bad.', to: 'm5a' },\r\n    ]},\r\n\r\n    c2h: { type: 'choice', options: [\r\n      { label: '\u2026', to: 'm6a' },\r\n      { label: '\u2026', to: 'm6a' },\r\n      { label: 'Sorry, I just was in a hurry to get free stuff so I could get back to collecting coins.', to: 'm7a' },\r\n    ]},\r\n\r\n    m3a: { type: 'line', say: 'What?', next: 'c2a' },\r\n    m3b: { type: 'line', say: 'I just did answer your question.', next: 'c3a' },\r\n    m3c: { type: 'line', say: 'At least 3.', next: 'c3b' },\r\n    m3d: { type: 'line', say: 'My Magic can do a few things.', next: 'c3c' },\r\n    m3e: { type: 'line', say: 'They\u2019re just built different.', next: 'c5a' },\r\n    m3f: { type: 'line', say: 'Don\u2019t.', next: 'c5a' },\r\n    m3g: { type: 'line', say: 'Common sense.', next: 'c5a' },\r\n    m3h: { type: 'line', say: 'Wow, that\u2019s kind of hurtful. Also no.', next: 'c5a' },\r\n    m3i: { type: 'line', say: 'Yes.', next: 'c3d' },\r\n    m3j: { type: 'line', say: 'Because I said so, and I am always right.', next: 'c5a' },\r\n\r\n    c3a: { type: 'choice', options: [\r\n      { label: 'No you didn\u2019t.', to: 'm4a' },\r\n      { label: 'Why are you like this?', to: 'm4b' },\r\n      { label: '\u2026', to: 'm6a' },\r\n    ]},\r\n\r\n    c3b: { type: 'choice', options: [\r\n      { label: '3\u2026 what?', to: 'm4c' },\r\n      { label: 'Ah, I completely understand.', to: 'm6a' },\r\n      { label: 'Okay.', to: 'm6a' },\r\n    ]},\r\n\r\n    c3c: { type: 'choice', options: [\r\n      { label: 'Like\u2026?', to: 'm4d' },\r\n      { label: 'Understandable.', to: 'm6a' },\r\n      { label: '\u2026', to: 'm6a' },\r\n    ]},\r\n\r\n    c3d: { type: 'choice', options: [\r\n      { label: 'Wouldn\u2019t that get boring?', to: 'm4e' },\r\n      { label: 'That sounds nice.', to: 'm6a' },\r\n      { label: 'Okay.', to: 'm6a' },\r\n    ]},\r\n\r\n    m4a: { type: 'line', say: 'Yes I did.', next: 'c3a' },\r\n    m4b: { type: 'line', say: 'Like what?', next: 'c4a' },\r\n    m4c: { type: 'line', say: '3.', next: 'c5a' },\r\n    m4d: { type: 'line', say: 'Okay you caught me, I\\\u2019m actually a fraud, my Magic is fake, nothing is real, the Coins are made of plastic, the sky\\'s a dome, my name\\\u2019s not even Merchant it\u2019s Jeff.', next: 'c4b' },\r\n    m4e: { type: 'line', say: 'No.', next: 'c5a' },\r\n\r\n    c4a: { type: 'choice', options: [\r\n      { label: 'Are you trying to be annoying on purpose?', to: 'm5b' },\r\n      { label: 'You\u2019re not being helpful.', to: 'm5a' },\r\n      { label: 'Nothing, nevermind\u2026', to: 'm6a' },\r\n    ]},\r\n\r\n    c4b: { type: 'choice', options: [\r\n      { label: '???', to: 'm6a' },\r\n      { label: '???', to: 'm6a' },\r\n      { label: '???', to: 'm6a' },\r\n    ]},\r\n\r\n    m5a: { type: 'line', say: 'Okay.', next: 'c5a' },\r\n\tm5b: { type: 'line', say: 'No.', next: 'c5a' },\r\n\r\n    c5a: { type: 'choice', options: [\r\n      { label: '\u2026', to: 'm6a' },\r\n      { label: '\u2026', to: 'm6a' },\r\n      { label: '\u2026', to: 'm6a' },\r\n    ]},\r\n\r\n    m6a: { type: 'line', say: 'Anything else you\u2019d like to know?', next: 'c6a' },\r\n\r\n    c6a: { type: 'choice', options: [\r\n      { label: 'Tell me some more stuff about how your magic works.', to: 'm1a' },\r\n      { label: 'Tell me some more stuff about how automation works.', to: 'm1b' },\r\n      { label: 'Do you have any goodies for me?', to: 'm7a' },\r\n    ]},\r\n\r\n    m7a: { type: 'line', say: '10 Magic, take it or leave it.', next: 'c7a' },\r\n    m7b: { type: 'line', say: 'Okay, now you\u2019re just being rude. Don\u2019t expect to get anything for free if you\u2019re rude.', next: 'c7b' },\r\n\r\n    c7a: { type: 'choice', options: [\r\n      { label: 'Hmm, a bit too low for my taste.', to: 'm7b' },\r\n      { label: 'I would\u2019ve liked more, but I\u2019ll take it.', to: 'end' },\r\n      { label: 'I\u2019ll take it.', to: 'end' },\r\n    ]},\r\n\r\n    c7b: { type: 'choice', options: [\r\n      { label: '\u2026', to: 'end_nr' },\r\n      { label: '\u2026', to: 'end_nr' },\r\n      { label: '\u2026', to: 'end_nr' },\r\n    ]},\r\n    }\r\n  },\r\n  5: {\r\n    start: 'n0',\r\n    nodes: {\r\n      n0: { type: 'line', say: 'You have felt the Surge, haven\\'t you?', next: 'c0' },\r\n\r\n      c0: { type: 'choice', options: [\r\n        { label: 'Yes.', to: 'm1a' },\r\n        { label: 'It was... intense.', to: 'm1b' },\r\n        { label: 'What was that?', to: 'm1c' },\r\n      ]},\r\n\r\n      m1a: { type: 'line', say: 'Good.', next: 'c1' },\r\n      m1b: { type: 'line', say: 'Indeed.', next: 'c1' },\r\n      m1c: { type: 'line', say: 'Progress.', next: 'c1' },\r\n\r\n      c1: { type: 'choice', options: [\r\n        { label: '...', to: 'end' },\r\n        { label: '...', to: 'end' },\r\n        { label: '...', to: 'end' },\r\n      ]},\r\n    }\r\n  },\r\n  6: {\r\n    start: 'n0',\r\n    nodes: {\r\n      n0: { type: 'line', say: 'Ah, you found the Lab.', next: 'c0' },\r\n\r\n      c0: { type: 'choice', options: [\r\n        { label: 'It looks empty.', to: 'm1a' },\r\n        { label: 'What is this place?', to: 'm1b' },\r\n        { label: '...', to: 'm1c' },\r\n      ]},\r\n\r\n      m1a: { type: 'line', say: 'For now.', next: 'c1' },\r\n      m1b: { type: 'line', say: 'A place for experiments.', next: 'c1' },\r\n      m1c: { type: 'line', say: 'Take a look around.', next: 'c1' },\r\n\r\n      c1: { type: 'choice', options: [\r\n        { label: 'Okay.', to: 'end' },\r\n        { label: 'Sure.', to: 'end' },\r\n        { label: '...', to: 'end' },\r\n      ]},\r\n    }\r\n  },\r\n  7: {\r\n    start: 'n0',\r\n    nodes: {\r\n      n0: { type: 'line', say: 'What are you doing?? Come to the Lab, quickly.', next: 'c0' },\r\n\r\n      c0: { type: 'choice', options: [\r\n        { label: '...', to: 'end_nr' },\r\n        { label: '...', to: 'end_nr' },\r\n        { label: '...', to: 'end_nr' },\r\n      ]},\r\n    }\r\n  },\r\n};\r\n", "import { markSaveSlotModified } from '../util/storage.js';\r\n\r\nconst TICK_RATE = 20;\r\nconst FIXED_STEP = 1 / TICK_RATE; // 0.05s\r\n\r\nconst tickListeners = new Set();\r\nconst frameListeners = new Set();\r\nlet rafId = null;\r\nlet paused = false;\r\nlet lastTime = 0;\r\nlet accumulator = 0;\r\n\r\n// Anti-Cheat: Runtime Time Travel Detection\r\nlet lastRuntimeCheckReal = 0;\r\nlet lastRuntimeCheckPerf = 0;\r\nconst RUNTIME_CHECK_INTERVAL_MS = 2000;\r\n\r\nfunction loop(timestamp) {\r\n  if (!timestamp) timestamp = performance.now();\r\n  const now = timestamp;\r\n  if (paused) {\r\n      lastTime = now;\r\n      rafId = requestAnimationFrame(loop);\r\n      return;\r\n  }\r\n  \r\n  if (!lastTime) lastTime = now;\r\n  let dt = (now - lastTime) / 1000;\r\n  lastTime = now;\r\n\r\n  // Clamp dt to avoid spiral of death if tab was backgrounded for a long time\r\n  // (Offline progress handles >1s usually, but we clamp here to be safe\r\n  // to prevent permanent desync of game state vs cursor position.\r\n  if (dt > 60.0) dt = 60.0; \r\n  if (dt < 0) dt = 0;\r\n  \r\n  accumulator += dt;\r\n\r\n  // Process fixed steps\r\n  // Limit ticks per frame to fast-forward instead of freezing the browser.\r\n  let ticksProcessed = 0;\r\n  const MAX_TICKS_PER_FRAME = 250; // ~12.5s of simulation per frame\r\n\r\n  while (accumulator >= FIXED_STEP) {\r\n    if (ticksProcessed >= MAX_TICKS_PER_FRAME) {\r\n      // Break early; remaining accumulator will be processed next frame (fast-forward)\r\n      // If we hit the limit, discard excess accumulator to prevent death spiral.\r\n      accumulator = accumulator % FIXED_STEP;\r\n      break;\r\n    }\r\n\r\n    tickListeners.forEach(listener => {\r\n      try {\r\n        listener(FIXED_STEP);\r\n      } catch (e) {\r\n        console.error('Error in game tick listener:', e);\r\n      }\r\n    });\r\n    accumulator -= FIXED_STEP;\r\n    ticksProcessed++;\r\n  }\r\n  \r\n  // Process frame listeners (rendering, interpolation)\r\n  frameListeners.forEach(listener => {\r\n    try {\r\n      listener(now / 1000, dt); // Pass time in seconds\r\n    } catch (e) {\r\n      console.error('Error in game frame listener:', e);\r\n    }\r\n  });\r\n\r\n  // Anti-Cheat Check\r\n  // We check periodically to compare Wall Clock Time (Date.now) vs Monotonic Time (performance.now)\r\n  // If Wall Clock moves significantly faster than Monotonic, it's a speed hack or time skip while running.\r\n  // If Wall Clock moves BACKWARDS, it's a reverse time skip.\r\n  if (lastRuntimeCheckReal === 0 || lastRuntimeCheckPerf === 0) {\r\n      lastRuntimeCheckReal = Date.now();\r\n      lastRuntimeCheckPerf = now;\r\n  } else {\r\n      const perfDelta = now - lastRuntimeCheckPerf;\r\n      // perform check every 2 seconds\r\n      if (perfDelta > RUNTIME_CHECK_INTERVAL_MS) {\r\n          const realNow = Date.now();\r\n          const realDelta = realNow - lastRuntimeCheckReal;\r\n          \r\n          // Check 1: Backward Jump\r\n          // If real time went backwards by more than 1 second (buffer), catch it.\r\n          if (realDelta < -1000) {\r\n               markSaveSlotModified();\r\n          }\r\n          // Check 2: Forward Speed Hack / Skip\r\n          // If real time advanced significantly more than monotonic time.\r\n          // e.g. Monotonic says 2s passed, but Real says 60s passed.\r\n          // Buffer: allow up to 2x variance or +5s to be safe against drift/lag, but skipping minutes is obvious.\r\n          // Let's be lenient: if realDelta is > perfDelta + 10000ms (10s)\r\n          else if (realDelta > perfDelta + 10000) {\r\n              markSaveSlotModified();\r\n          }\r\n          \r\n          lastRuntimeCheckReal = realNow;\r\n          lastRuntimeCheckPerf = now;\r\n      }\r\n  }\r\n\r\n  rafId = requestAnimationFrame(loop);\r\n}\r\n\r\nexport function pauseGameLoop() {\r\n  paused = true;\r\n}\r\n\r\nexport function resumeGameLoop() {\r\n  paused = false;\r\n  lastTime = performance.now();\r\n  accumulator = 0; // Reset accumulator on resume to avoid burst\r\n  \r\n  // Reset cheat detection anchors to prevent flagging legitimate sleep/suspend time\r\n  // as a speed hack (since Date.now advances during sleep, but performance.now behavior varies or loop stops).\r\n  lastRuntimeCheckReal = 0; \r\n  lastRuntimeCheckPerf = 0;\r\n}\r\n\r\nexport function startGameLoop() {\r\n  if (rafId) return;\r\n  lastTime = performance.now();\r\n  accumulator = 0;\r\n  lastRuntimeCheckReal = 0;\r\n  lastRuntimeCheckPerf = 0;\r\n  rafId = requestAnimationFrame(loop);\r\n}\r\n\r\nexport function stopGameLoop() {\r\n  if (rafId) {\r\n    cancelAnimationFrame(rafId);\r\n    rafId = null;\r\n  }\r\n}\r\n\r\nexport function registerTick(callback) {\r\n  if (typeof callback !== 'function') return () => {};\r\n  tickListeners.add(callback);\r\n  return () => {\r\n    tickListeners.delete(callback);\r\n  };\r\n}\r\n\r\nexport function registerFrame(callback) {\r\n  if (typeof callback !== 'function') return () => {};\r\n  frameListeners.add(callback);\r\n  return () => {\r\n    frameListeners.delete(callback);\r\n  };\r\n}\r\n\r\nexport class RateAccumulator {\r\n  constructor(currencyKey, bankRef) {\r\n    this.currencyKey = currencyKey;\r\n    this.bank = bankRef || window.bank;\r\n    this.buffer = 0;\r\n  }\r\n\r\n  addRate(amountPerSecond) {\r\n    // This logic assumes 20 ticks per second (FIXED_STEP)\r\n    const perTick = amountPerSecond * FIXED_STEP;\r\n    this.buffer += perTick;\r\n\r\n    if (this.buffer >= 1) {\r\n      const whole = Math.floor(this.buffer);\r\n      this.buffer -= whole;\r\n      if (this.bank && this.bank[this.currencyKey]) {\r\n        this.bank[this.currencyKey].add(whole);\r\n      }\r\n    }\r\n  }\r\n}\r\n", "import { BigNum } from '../util/bigNum.js';\r\n\r\nexport const AUTOMATION_AREA_KEY = 'automation';\r\nexport const EFFECTIVE_AUTO_COLLECT_ID = 1;\r\nexport const AUTOBUY_COIN_UPGRADES_ID = 2;\r\nexport const AUTOBUY_BOOK_UPGRADES_ID = 3;\r\nexport const AUTOBUY_GOLD_UPGRADES_ID = 4;\r\nexport const AUTOBUY_MAGIC_UPGRADES_ID = 5;\r\nexport const AUTOBUY_WORKSHOP_LEVELS_ID = 6;\r\nexport const AUTOBUY_DNA_UPGRADES_ID = 7;\r\n\r\n// Maps an Automation Upgrade ID to the cost type it controls (Master Switch logic).\r\nexport const MASTER_AUTOBUY_IDS = {\r\n  [AUTOBUY_COIN_UPGRADES_ID]: 'coins',\r\n  [AUTOBUY_BOOK_UPGRADES_ID]: 'books',\r\n  [AUTOBUY_GOLD_UPGRADES_ID]: 'gold',\r\n  [AUTOBUY_MAGIC_UPGRADES_ID]: 'magic',\r\n  [AUTOBUY_DNA_UPGRADES_ID]: 'dna'\r\n};\r\n\r\nconst MYSTERIOUS_ICON = 'img/misc/mysterious.webp';\r\nconst LOCKED_ICON = 'img/misc/locked.webp';\r\nconst HIDDEN_TITLE = 'Hidden Upgrade';\r\nconst LOCKED_TITLE = 'Locked Upgrade';\r\n\r\nconst UPGRADE_DEFINITIONS = [\r\n  {\r\n    area: AUTOMATION_AREA_KEY,\r\n    id: EFFECTIVE_AUTO_COLLECT_ID,\r\n    title: 'Effective Auto-Collect',\r\n    desc: 'Generates the equivalent of picking up a Coin on an interval\\nEach level of this upgrade will reduce the generation interval\\nAs a bonus, anything passively generated accumulates offline',\r\n    icon: 'sc_upg_icons/effective_auto_collect.webp',\r\n    lvlCap: 20,\r\n    baseCost: 100,\r\n    costType: 'gears',\r\n    upgType: 'NM',\r\n    scaling: { ratio: 2 },\r\n    costAtLevel(level) {\r\n      const lvl = Math.max(0, Math.floor(Number(level) || 0));\r\n      const base = BigInt(100);\r\n      const pow = 2n ** BigInt(lvl);\r\n      return BigNum.fromAny((base * pow).toString());\r\n    },\r\n    effectSummary(level) {\r\n      const lvl = Math.max(0, Math.floor(Number(level) || 0));\r\n      if (lvl === 0) return 'Coin generation interval: None';\r\n      const intervalMs = Math.round(1000 / lvl);\r\n      return `Coin generation interval: ${intervalMs}ms`;\r\n    }\r\n  },\r\n  {\r\n    area: AUTOMATION_AREA_KEY,\r\n    id: AUTOBUY_COIN_UPGRADES_ID,\r\n    title: 'Autobuy Coin Upgrades',\r\n    desc: 'Automatically buys Coin upgrades, but with a twist:\\nAutobuys upgrades for free, as long as you can afford the cost\\nThis is how all future autobuyers will work',\r\n    icon: 'sc_upg_icons/autobuy_coin.webp',\r\n    lvlCap: 1,\r\n    baseCost: 1e6,\r\n    costType: 'gears',\r\n    upgType: 'NM',\r\n    costAtLevel() {\r\n      return BigNum.fromInt(1e6);\r\n    },\r\n    effectSummary() {\r\n      return null;\r\n    }\r\n  },\r\n  {\r\n    area: AUTOMATION_AREA_KEY,\r\n    id: AUTOBUY_BOOK_UPGRADES_ID,\r\n    title: 'Autobuy Book Upgrades',\r\n    desc: 'Automatically buys Book upgrades',\r\n    icon: 'sc_upg_icons/autobuy_book.webp',\r\n    lvlCap: 1,\r\n    baseCost: 1e9,\r\n    costType: 'gears',\r\n    upgType: 'NM',\r\n    costAtLevel() {\r\n      return BigNum.fromInt(1e9);\r\n    },\r\n    effectSummary() {\r\n      return null;\r\n    }\r\n  },\r\n  {\r\n    area: AUTOMATION_AREA_KEY,\r\n    id: AUTOBUY_GOLD_UPGRADES_ID,\r\n    title: 'Autobuy Gold Upgrades',\r\n    desc: 'Automatically buys Gold upgrades',\r\n    icon: 'sc_upg_icons/autobuy_gold.webp',\r\n    lvlCap: 1,\r\n    baseCost: 1e12,\r\n    costType: 'gears',\r\n    upgType: 'NM',\r\n    costAtLevel() {\r\n      return BigNum.fromAny('1e12');\r\n    },\r\n    effectSummary() {\r\n      return null;\r\n    }\r\n  },\r\n  {\r\n    area: AUTOMATION_AREA_KEY,\r\n    id: AUTOBUY_MAGIC_UPGRADES_ID,\r\n    title: 'Autobuy Magic Upgrades',\r\n    desc: 'Automatically buys Magic upgrades',\r\n    icon: 'sc_upg_icons/autobuy_magic.webp',\r\n    lvlCap: 1,\r\n    baseCost: 1e15,\r\n    costType: 'gears',\r\n    upgType: 'NM',\r\n    costAtLevel() {\r\n      return BigNum.fromAny('1e15');\r\n    },\r\n    effectSummary() {\r\n      return null;\r\n    }\r\n  },\r\n  {\r\n    area: AUTOMATION_AREA_KEY,\r\n    id: AUTOBUY_WORKSHOP_LEVELS_ID,\r\n    title: 'Autobuy Workshop Levels',\r\n    desc: 'Automatically buys Workshop Levels',\r\n    icon: 'sc_upg_icons/autobuy_workshop_level.webp',\r\n    lvlCap: 1,\r\n    baseCost: 1e18,\r\n    costType: 'gears',\r\n    upgType: 'NM',\r\n    costAtLevel() {\r\n      return BigNum.fromAny('1e18');\r\n    },\r\n    effectSummary() {\r\n      return null;\r\n    }\r\n  },\r\n  {\r\n    area: AUTOMATION_AREA_KEY,\r\n    id: AUTOBUY_DNA_UPGRADES_ID,\r\n    title: 'Autobuy DNA Upgrades',\r\n    desc: 'Automatically buys DNA upgrades',\r\n    icon: 'sc_upg_icons/autobuy_dna.webp',\r\n    lvlCap: 1,\r\n    baseCost: 1e27,\r\n    costType: 'gears',\r\n    upgType: 'NM',\r\n    costAtLevel() {\r\n      return BigNum.fromAny('1e27');\r\n    },\r\n    effectSummary() {\r\n      return null;\r\n    },\r\n    computeLockState(ctx) {\r\n        const sl = ctx.surgeLevel;\r\n        let isUnlocked = false;\r\n        \r\n        if (typeof sl === 'number') {\r\n            if (sl >= 11 || sl === Infinity) isUnlocked = true;\r\n        } else if (typeof sl === 'bigint') {\r\n            if (sl >= 11n) isUnlocked = true;\r\n        } else if (typeof sl === 'string') {\r\n             if (sl === 'Infinity' || parseFloat(sl) === Infinity) isUnlocked = true;\r\n             else if (!isNaN(parseFloat(sl)) && parseFloat(sl) >= 11) isUnlocked = true;\r\n        } else if (sl && typeof sl.isInfinite === 'function' && sl.isInfinite()) {\r\n             isUnlocked = true;\r\n        }\r\n        \r\n        if (isUnlocked) return { locked: false };\r\n\r\n        if (!ctx.surgeUnlocked) {\r\n            return {\r\n                locked: true,\r\n                iconOverride: LOCKED_ICON,\r\n                titleOverride: LOCKED_TITLE,\r\n                descOverride: 'Locked',\r\n                reason: 'Locked',\r\n                hidden: false,\r\n                hideCost: true,\r\n                hideEffect: true,\r\n                useLockedBase: true\r\n            };\r\n        }\r\n        \r\n        const revealText = \"Reach Surge 11 to reveal this upgrade\";\r\n        return {\r\n            locked: true,\r\n            iconOverride: MYSTERIOUS_ICON,\r\n            titleOverride: HIDDEN_TITLE,\r\n            descOverride: revealText,\r\n            reason: revealText,\r\n            hidden: true,\r\n            hideCost: true,\r\n            hideEffect: true,\r\n            useLockedBase: true\r\n        };\r\n    }\r\n  }\r\n];\r\n\r\nexport const REGISTRY = UPGRADE_DEFINITIONS.map(u => ({\r\n  ...u,\r\n  icon: `img/${(u.icon || '').replace(/^img\\//, '')}`\r\n}));\r\n", "import { BigNum } from '../util/bigNum.js';\r\nimport { bank } from '../util/storage.js';\r\nimport { initResetSystem } from '../ui/merchantTabs/resetTab.js';\r\nimport {\r\n  addExternalCoinMultiplierProvider,\r\n  addExternalXpGainMultiplierProvider,\r\n  refreshCoinMultiplierFromXpLevel,\r\n  isXpSystemUnlocked,\r\n} from './xpSystem.js';\r\nimport { addExternalMutationGainMultiplierProvider } from './mutationSystem.js';\r\nimport {\r\n  REGISTRY,\r\n  AREA_KEYS,\r\n  getUpgradesForArea,\r\n  getLevel,\r\n  getLevelNumber,\r\n  computeHmMultipliers,\r\n  safeMultiplyBigNum,\r\n  ensureLevelBigNum,\r\n  levelBigNumToNumber,\r\n  normalizedUpgradeLevel,\r\n  bigNumFromLog10,\r\n  UPGRADE_TIES\r\n} from './upgrades.js';\r\nimport { getSurgeMagicMultiplier } from './surgeEffects.js';\r\n\r\nconst BASE_CPS = 1;\r\n\r\nlet _cachedUpgradeMultipliers = null;\r\nlet listeners = [];\r\n\r\nconst externalSpawnRateProviders = [];\r\n\r\nexport function addExternalSpawnRateMultiplierProvider(provider) {\r\n  if (typeof provider === 'function') {\r\n    externalSpawnRateProviders.push(provider);\r\n  }\r\n}\r\n\r\nexport function invalidateEffectsCache() {\r\n  _cachedUpgradeMultipliers = null;\r\n}\r\n\r\nexport function triggerUpgradesChanged() {\r\n  _cachedUpgradeMultipliers = null;\r\n  try { listeners.forEach(cb => cb()); } catch {}\r\n  try { document.dispatchEvent(new CustomEvent('ccc:upgrades:changed')); } catch {}\r\n  try { refreshCoinMultiplierFromXpLevel(); } catch {}\r\n}\r\n\r\nexport function onUpgradesChanged(cb) {\r\n  if (typeof cb === 'function') listeners.push(cb);\r\n  return () => { listeners = listeners.filter(x => x !== cb); };\r\n}\r\n\r\nexport function bookValueMultiplierBn(level) {\r\n  const L = ensureLevelBigNum(level);\r\n  try {\r\n    const plain = L.toPlainIntegerString?.();\r\n    if (plain && plain !== 'Infinity' && plain.length <= 15) {\r\n      const lvl = Math.max(0, Number(plain));\r\n      return bigNumFromLog10(lvl * Math.log10(2)).floorToInteger();\r\n    }\r\n  } catch {}\r\n\r\n  return BigNum.fromAny('Infinity');\r\n}\r\n\r\nfunction safeIsXpUnlocked() {\r\n  try {\r\n    return !!isXpSystemUnlocked();\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\nexport function syncBookCurrencyMultiplierFromUpgrade(levelOverride) {\r\n  const multHandle = bank?.books?.mult;\r\n  if (!multHandle || typeof multHandle.set !== 'function') return;\r\n\r\n  let resolvedLevel = 0;\r\n  const xpUnlocked = safeIsXpUnlocked();\r\n  if (xpUnlocked) {\r\n    if (Number.isFinite(levelOverride)) {\r\n      resolvedLevel = Math.max(0, Math.floor(levelOverride));\r\n    } else {\r\n      const storedLevel = getLevelNumber(AREA_KEYS.STARTER_COVE, UPGRADE_TIES.BOOK_VALUE_I);\r\n      resolvedLevel = Math.max(0, Number.isFinite(storedLevel) ? storedLevel : 0);\r\n    }\r\n  }\r\n\r\n  let multiplier;\r\n  try {\r\n    multiplier = bookValueMultiplierBn(resolvedLevel);\r\n  } catch {\r\n    multiplier = BigNum.fromInt(1);\r\n  }\r\n\r\n  try {\r\n    multHandle.set(multiplier.clone?.() ?? multiplier);\r\n  } catch {}\r\n}\r\n\r\nexport function calculateUpgradeMultipliers(areaKey = AREA_KEYS.STARTER_COVE) {\r\n  if (_cachedUpgradeMultipliers) return _cachedUpgradeMultipliers;\r\n\r\n  const upgrades = getUpgradesForArea(areaKey);\r\n  const additionalUpgrades = [];\r\n  if (areaKey === AREA_KEYS.STARTER_COVE && AREA_KEYS.DNA) {\r\n    const dnaUpgrades = getUpgradesForArea(AREA_KEYS.DNA);\r\n    additionalUpgrades.push(...dnaUpgrades);\r\n  }\r\n  const allUpgrades = [...upgrades, ...additionalUpgrades];\r\n\r\n  const acc = {\r\n    coinValue: BigNum.fromInt(1),\r\n    xpValue: BigNum.fromInt(1),\r\n    mpValue: BigNum.fromInt(1),\r\n    goldValue: BigNum.fromInt(1),\r\n    magicValue: BigNum.fromInt(1),\r\n    waveValue: BigNum.fromInt(1),\r\n    bookValue: BigNum.fromInt(1),\r\n    coinSpawn: 1.0,\r\n    magnetRadius: 0,\r\n  };\r\n\r\n  for (const upg of allUpgrades) {\r\n    if (!upg.effectType) continue;\r\n\r\n    const effectiveArea = upg.area || areaKey;\r\n    const lvlBn = getLevel(effectiveArea, upg.id);\r\n    const lvlNum = levelBigNumToNumber(lvlBn);\r\n\r\n    let baseEffect = null;\r\n    if (typeof upg.effectMultiplier === 'function') {\r\n      baseEffect = upg.effectMultiplier(lvlNum);\r\n      if (!(baseEffect instanceof BigNum) && typeof baseEffect !== 'number') {\r\n        baseEffect = BigNum.fromAny(baseEffect ?? 1);\r\n      }\r\n    } else {\r\n      baseEffect = BigNum.fromInt(1);\r\n    }\r\n\r\n    if (upg.upgType === 'HM') {\r\n      const { selfMult, xpMult, coinMult, mpMult } = computeHmMultipliers(upg, lvlBn, effectiveArea);\r\n      acc.xpValue = safeMultiplyBigNum(acc.xpValue, xpMult);\r\n      acc.coinValue = safeMultiplyBigNum(acc.coinValue, coinMult);\r\n      acc.mpValue = safeMultiplyBigNum(acc.mpValue, mpMult);\r\n      \r\n      baseEffect = safeMultiplyBigNum(baseEffect, selfMult);\r\n    }\r\n\r\n    if (upg.effectType === 'coin_spawn') {\r\n      let val = 1;\r\n      if (baseEffect instanceof BigNum) {\r\n        try { val = Number(baseEffect.toScientific()); } catch { val = 1; }\r\n      } else {\r\n        val = Number(baseEffect);\r\n      }\r\n      acc.coinSpawn *= val;\r\n    } else if (upg.effectType === 'coin_value') {\r\n      acc.coinValue = safeMultiplyBigNum(acc.coinValue, baseEffect);\r\n    } else if (upg.effectType === 'xp_value') {\r\n      acc.xpValue = safeMultiplyBigNum(acc.xpValue, baseEffect);\r\n    } else if (upg.effectType === 'mp_value') {\r\n      acc.mpValue = safeMultiplyBigNum(acc.mpValue, baseEffect);\r\n    } else if (upg.effectType === 'gold_value') {\r\n      acc.goldValue = safeMultiplyBigNum(acc.goldValue, baseEffect);\r\n    } else if (upg.effectType === 'magic_value') {\r\n      acc.magicValue = safeMultiplyBigNum(acc.magicValue, baseEffect);\r\n    } else if (upg.effectType === 'wave_value') {\r\n      acc.waveValue = safeMultiplyBigNum(acc.waveValue, baseEffect);\r\n    } else if (upg.effectType === 'book_value') {\r\n      acc.bookValue = safeMultiplyBigNum(acc.bookValue, baseEffect);\r\n    } else if (upg.effectType === 'magnet_radius') {\r\n      let val = 0;\r\n      if (baseEffect instanceof BigNum) {\r\n        try { val = Number(baseEffect.toScientific()); } catch { val = 0; }\r\n      } else {\r\n        val = Number(baseEffect);\r\n      }\r\n      if (Number.isFinite(val)) {\r\n        acc.magnetRadius += val;\r\n      }\r\n    }\r\n  }\r\n\r\n  for (const provider of externalSpawnRateProviders) {\r\n    try {\r\n      const val = provider();\r\n      if (Number.isFinite(val)) {\r\n        acc.coinSpawn *= val;\r\n      }\r\n    } catch {}\r\n  }\r\n\r\n  _cachedUpgradeMultipliers = acc;\r\n  return acc;\r\n}\r\n\r\nexport function computeUpgradeEffects(areaKey) {\r\n  const mults = calculateUpgradeMultipliers(areaKey);\r\n  \r\n  return {\r\n    coinsPerSecondMult: mults.coinSpawn,\r\n    coinsPerSecondAbsolute: BASE_CPS * mults.coinSpawn,\r\n    coinValueMultiplier: mults.coinValue,\r\n    xpGainMultiplier: mults.xpValue,\r\n    bookRewardMultiplier: mults.bookValue,\r\n    goldValueMultiplier: mults.goldValue,\r\n    magicValueMultiplier: mults.magicValue,\r\n  };\r\n}\r\n\r\nexport function syncCurrencyMultipliersFromUpgrades() {\r\n  const { goldValue, magicValue, waveValue } = calculateUpgradeMultipliers(AREA_KEYS.STARTER_COVE);\r\n  \r\n  try {\r\n    if (bank.gold?.mult?.set) {\r\n      bank.gold.mult.set(goldValue);\r\n    }\r\n  } catch {}\r\n\r\n  try {\r\n    if (bank.magic?.mult?.set) {\r\n      const surgeMult = getSurgeMagicMultiplier();\r\n      const finalMagicValue = safeMultiplyBigNum(magicValue, surgeMult);\r\n      bank.magic.mult.set(finalMagicValue);\r\n    }\r\n  } catch {}\r\n\r\n  try {\r\n    if (bank.waves?.mult?.set) {\r\n      bank.waves.mult.set(waveValue);\r\n    }\r\n  } catch {}\r\n}\r\n\r\nexport function getMpValueMultiplierBn() {\r\n  try {\r\n    const { mpValue } = calculateUpgradeMultipliers(AREA_KEYS.STARTER_COVE);\r\n    return mpValue;\r\n  } catch {\r\n    return BigNum.fromInt(1);\r\n  }\r\n}\r\n\r\nexport function getMagnetLevel() {\r\n  try {\r\n    const { magnetRadius } = calculateUpgradeMultipliers(AREA_KEYS.STARTER_COVE);\r\n    return magnetRadius || 0;\r\n  } catch {\r\n    return 0;\r\n  }\r\n}\r\n\r\nexport function registerXpUpgradeEffects() {\r\n  try { initResetSystem(); } catch {}\r\n\r\n  syncCurrencyMultipliersFromUpgrades();\r\n  onUpgradesChanged(syncCurrencyMultipliersFromUpgrades);\r\n\r\n  try {\r\n    addExternalCoinMultiplierProvider(({ baseMultiplier, xpUnlocked }) => {\r\n      if (!xpUnlocked) return baseMultiplier;\r\n      let result = baseMultiplier instanceof BigNum\r\n        ? baseMultiplier.clone?.() ?? baseMultiplier\r\n        : BigNum.fromAny(baseMultiplier ?? 0);\r\n      \r\n      const { coinValue } = calculateUpgradeMultipliers(AREA_KEYS.STARTER_COVE);\r\n      return safeMultiplyBigNum(result, coinValue);\r\n    });\r\n  } catch {}\r\n\r\n  try {\r\n    addExternalXpGainMultiplierProvider(({ baseGain, xpUnlocked }) => {\r\n      if (!xpUnlocked) return baseGain;\r\n      let gain = baseGain instanceof BigNum\r\n        ? baseGain.clone?.() ?? baseGain\r\n        : BigNum.fromAny(baseGain ?? 0);\r\n      \r\n      const { xpValue } = calculateUpgradeMultipliers(AREA_KEYS.STARTER_COVE);\r\n      return safeMultiplyBigNum(gain, xpValue);\r\n    });\r\n  } catch {}\r\n\r\n  try {\r\n    addExternalMutationGainMultiplierProvider(({ baseGain, mutationUnlocked }) => {\r\n      if (!mutationUnlocked) return baseGain;\r\n      let gain = baseGain instanceof BigNum\r\n        ? baseGain.clone?.() ?? baseGain\r\n        : BigNum.fromAny(baseGain ?? 0);\r\n      \r\n      const { mpValue } = calculateUpgradeMultipliers(AREA_KEYS.STARTER_COVE);\r\n      return safeMultiplyBigNum(gain, mpValue);\r\n    });\r\n  } catch {}\r\n\r\n  syncBookCurrencyMultiplierFromUpgrade();\r\n  if (typeof window !== 'undefined') {\r\n    window.addEventListener('saveSlot:change', () => {\r\n      try { syncBookCurrencyMultiplierFromUpgrade(); } catch {}\r\n      try { refreshCoinMultiplierFromXpLevel(); } catch {}\r\n      try { syncCurrencyMultipliersFromUpgrades(); } catch {}\r\n    });\r\n    \r\n    window.addEventListener('surge:level:change', () => {\r\n        try { syncCurrencyMultipliersFromUpgrades(); } catch {}\r\n    });\r\n    window.addEventListener('surge:nerf:change', () => {\r\n        try { syncCurrencyMultipliersFromUpgrades(); } catch {}\r\n    });\r\n  }\r\n}\r\n", "import { getActiveSlot, bank } from '../../util/storage.js';\r\nimport { IS_MOBILE } from '../../main.js';\r\nimport { BigNum } from '../../util/bigNum.js';\r\nimport { formatNumber } from '../../util/numFormat.js';\r\nimport { getTsunamiNerf, isSurgeActive, getEffectiveTsunamiNerf } from '../../game/surgeEffects.js';\r\nimport { registerTick } from '../../game/gameLoop.js';\r\nimport { applyStatMultiplierOverride } from '../../util/debugPanel.js';\r\nimport { \r\n    RESEARCH_NODES, \r\n    tickResearch,\r\n    getResearchNodeLevel,\r\n    getResearchNodeRp,\r\n    isResearchNodeActive,\r\n    setResearchNodeActive,\r\n    getResearchNodeRequirement,\r\n    getTsunamiResearchBonus,\r\n    initLabMultipliers,\r\n    isResearchNodeVisible,\r\n    getLabCoinMultiplier,\r\n    getLabXpMultiplier\r\n} from '../../game/labNodes.js';\r\nimport { setupDragToClose } from '../shopOverlay.js';\r\nimport { formatMultForUi } from '../../game/upgrades.js';\r\n\r\nconst CAM_MAX_COORD = 1e308;\r\nconst CAM_MAX_ZOOM = 1e300;\r\nconst CAM_MIN_ZOOM = 1e-300;\r\n\r\nconst LAB_VISITED_KEY = (slot) => `ccc:lab:visited:${slot}`;\r\nconst LAB_LEVEL_KEY = (slot) => `ccc:lab:level:${slot}`;\r\n\r\n// --- Caching ---\r\nlet _cachedLabLevel = null;\r\nlet _cachedLabVisited = null;\r\nlet _cachedSlot = null;\r\n\r\nfunction reloadLabCache() {\r\n    const slot = getActiveSlot();\r\n    _cachedSlot = slot;\r\n    \r\n    if (slot == null) {\r\n        _cachedLabLevel = BigNum.fromInt(0);\r\n        _cachedLabVisited = false;\r\n        return;\r\n    }\r\n\r\n    // Load Level\r\n    try {\r\n        const raw = localStorage.getItem(LAB_LEVEL_KEY(slot));\r\n        if (!raw) _cachedLabLevel = BigNum.fromInt(0);\r\n        else _cachedLabLevel = BigNum.fromAny(raw);\r\n    } catch {\r\n        _cachedLabLevel = BigNum.fromInt(0);\r\n    }\r\n\r\n    // Load Visited\r\n    try {\r\n        _cachedLabVisited = localStorage.getItem(LAB_VISITED_KEY(slot)) === '1';\r\n    } catch {\r\n        _cachedLabVisited = false;\r\n    }\r\n}\r\n\r\n// --- Exported Getters/Setters ---\r\n\r\nexport function hasVisitedLab() {\r\n  const slot = getActiveSlot();\r\n  if (slot == null) return false;\r\n  if (_cachedSlot !== slot || _cachedLabVisited === null) {\r\n      reloadLabCache();\r\n  }\r\n  return _cachedLabVisited;\r\n}\r\n\r\nexport function setLabVisited(value) {\r\n  const slot = getActiveSlot();\r\n  if (slot == null) return;\r\n  const normalized = !!value;\r\n  \r\n  if (_cachedLabVisited === normalized && _cachedSlot === slot) return;\r\n  _cachedLabVisited = normalized;\r\n\r\n  try {\r\n    localStorage.setItem(LAB_VISITED_KEY(slot), normalized ? '1' : '0');\r\n  } catch {}\r\n}\r\n\r\nexport const getLabLevelKey = (slot) => LAB_LEVEL_KEY(slot);\r\n\r\nexport function getLabLevel() {\r\n  const slot = getActiveSlot();\r\n  if (slot == null) return BigNum.fromInt(0);\r\n  \r\n  if (bank.coins.value.isInfinite()) {\r\n      return BigNum.fromAny('Infinity');\r\n  }\r\n  \r\n  if (_cachedSlot !== slot || _cachedLabLevel === null) {\r\n      reloadLabCache();\r\n  }\r\n  return _cachedLabLevel;\r\n}\r\n\r\nexport function setLabLevel(value) {\r\n  const slot = getActiveSlot();\r\n  if (slot == null) return;\r\n  try {\r\n    const valBn = BigNum.fromAny(value);\r\n    \r\n    // Ensure cache is loaded so we can compare\r\n    if (_cachedSlot !== slot || _cachedLabLevel === null) {\r\n        reloadLabCache();\r\n    }\r\n    \r\n    if (valBn.cmp(_cachedLabLevel) === 0) return;\r\n\r\n    _cachedLabLevel = valBn;\r\n    localStorage.setItem(LAB_LEVEL_KEY(slot), valBn.toStorage());\r\n    window.dispatchEvent(new CustomEvent('lab:level:change', { detail: { slot, level: valBn } }));\r\n  } catch {}\r\n}\r\n\r\nexport function getLabCost(level) {\r\n    const lvl = BigNum.fromAny(level);\r\n    if (lvl.isInfinite()) return BigNum.fromAny('Infinity');\r\n    \r\n    try {\r\n        if (lvl.cmp(1e15) < 0) {\r\n             const lvlNum = Number(lvl.toPlainIntegerString());\r\n             const exponent = 20 + lvlNum;\r\n             return new BigNum(1n, { base: exponent, offset: 0n });\r\n        }\r\n        \r\n        if (lvl.cmp(BigNum.fromScientific(\"1e1000000\")) > 0) {\r\n             return BigNum.fromAny('Infinity');\r\n        }\r\n        \r\n        const lvlStr = lvl.toPlainIntegerString();\r\n        if (lvlStr === 'Infinity') return BigNum.fromAny('Infinity');\r\n        \r\n        const lvlBigInt = BigInt(lvlStr);\r\n        const totalExponent = 20n + lvlBigInt;\r\n        \r\n        return new BigNum(1n, { base: 0, offset: totalExponent });\r\n\r\n    } catch (e) {\r\n        console.error(\"Error calculating lab cost\", e);\r\n        return BigNum.fromAny('Infinity');\r\n    }\r\n}\r\n\r\nexport function getLabLevelFromCoins(coins) {\r\n    if (!coins || coins.isZero() || coins.isNegative()) return BigNum.fromInt(0);\r\n    if (coins.isInfinite()) return BigNum.fromAny('Infinity');\r\n\r\n    let exponentBn;\r\n    if (coins._eOffset !== 0n) {\r\n        const eVal = BigInt(coins.e) + coins._eOffset;\r\n        const sigNum = Number(coins.sig);\r\n        const logSig = Math.log10(sigNum);\r\n        const logSigInt = Math.floor(logSig); \r\n        \r\n        const levelBase = eVal - 20n + BigInt(logSigInt);\r\n        \r\n        if (levelBase < 0n) return BigNum.fromInt(0);\r\n        \r\n        return BigNum.fromInt(levelBase); \r\n    }\r\n    \r\n    const e = coins.e;\r\n    const sigNum = Number(coins.sig);\r\n    const logSig = Math.log10(sigNum);\r\n    const val = e + logSig - 20;\r\n    \r\n    if (val < 0) return BigNum.fromInt(0);\r\n    return BigNum.fromInt(Math.floor(val));\r\n}\r\n\r\nexport function updateLabLevel() {\r\n    const slot = getActiveSlot();\r\n    if (slot != null && typeof window !== 'undefined' && window.__cccLockedStorageKeys?.has(LAB_LEVEL_KEY(slot))) {\r\n        return;\r\n    }\r\n\r\n    const coins = bank.coins.value;\r\n    const currentLevel = getLabLevel();\r\n    \r\n    if (coins.isInfinite()) {\r\n        if (!currentLevel.isInfinite()) {\r\n            setLabLevel(BigNum.fromAny('Infinity'));\r\n        }\r\n        return;\r\n    }\r\n    \r\n    const targetLevel = getLabLevelFromCoins(coins);\r\n    \r\n    if (targetLevel.cmp(currentLevel) > 0) {\r\n        setLabLevel(targetLevel);\r\n    }\r\n}\r\n\r\nexport function initLabLogic() {\r\n    reloadLabCache();\r\n    if (typeof window !== 'undefined') {\r\n        window.addEventListener('saveSlot:change', reloadLabCache);\r\n    }\r\n    registerTick(updateLabLevel);\r\n    // Also register research tick\r\n    registerTick(tickResearch);\r\n    initLabMultipliers();\r\n}\r\n\r\n// --- RP Logic Helper for Node ---\r\n\r\n// Used by labNodes.js\r\nfunction bigNumIsInfinite(bn) {\r\n  return !!(bn && typeof bn === 'object' && (bn.isInfinite?.() || (typeof bn.isInfinite === 'function' && bn.isInfinite())));\r\n}\r\n\r\nfunction bigNumToFiniteNumber(bn) {\r\n  if (!bn || typeof bn !== 'object') return 0;\r\n  if (bigNumIsInfinite(bn)) return Number.POSITIVE_INFINITY;\r\n  const sci = typeof bn.toScientific === 'function' ? bn.toScientific(18) : String(bn);\r\n  if (!sci || sci === 'Infinity') return Number.POSITIVE_INFINITY;\r\n  const match = sci.match(/^([0-9]+(?:\\.[0-9]+)?)e([+-]?\\d+)$/i);\r\n  if (match) {\r\n    const mant = parseFloat(match[1]);\r\n    const exp = parseInt(match[2], 10);\r\n    if (!Number.isFinite(mant) || !Number.isFinite(exp)) return Number.POSITIVE_INFINITY;\r\n    if (exp >= 309) return Number.POSITIVE_INFINITY;\r\n    return mant * Math.pow(10, exp);\r\n  }\r\n  const num = Number(sci);\r\n  return Number.isFinite(num) ? num : Number.POSITIVE_INFINITY;\r\n}\r\n\r\nconst infinityRequirementBn = BigNum.fromAny('Infinity');\r\nconst maxLog10Bn = BigNum.fromScientific(String(BigNum.MAX_E));\r\n\r\nfunction bigNumPowerOf10(logBn) {\r\n  if (bigNumIsInfinite(logBn) || (typeof logBn.cmp === 'function' && logBn.cmp(maxLog10Bn) >= 0)) {\r\n      return infinityRequirementBn.clone?.() ?? infinityRequirementBn;\r\n  }\r\n\r\n  const integerPart = logBn.floorToInteger();\r\n  const fractionalPart = logBn.sub(integerPart);\r\n  const fractionalNumber = bigNumToFiniteNumber(fractionalPart);\r\n\r\n  if (!Number.isFinite(fractionalNumber)) {\r\n      return infinityRequirementBn.clone?.() ?? infinityRequirementBn;\r\n  }\r\n\r\n  let mantissa = Math.pow(10, fractionalNumber);\r\n  mantissa = Number(mantissa.toPrecision(15));\r\n\r\n  const precision = 18;\r\n  const scaleFactor = 10n ** BigInt(precision);\r\n\r\n  let exponentAdjustment = 0n;\r\n  if (mantissa >= 10) {\r\n      mantissa /= 10;\r\n      exponentAdjustment = 1n;\r\n  }\r\n\r\n  const sig = BigInt(Math.round(mantissa * Number(scaleFactor)));\r\n\r\n  const integerPartString = integerPart.toPlainIntegerString();\r\n  if (integerPartString === 'Infinity') {\r\n      return infinityRequirementBn.clone?.() ?? infinityRequirementBn;\r\n  }\r\n  const integerPartBigInt = BigInt(integerPartString);\r\n\r\n  const totalExponent = integerPartBigInt + exponentAdjustment - BigInt(precision);\r\n\r\n  const E_LIMIT = 250;\r\n  const eBigInt = totalExponent % BigInt(E_LIMIT);\r\n  const e = Number(eBigInt);\r\n  const offset = totalExponent - eBigInt;\r\n\r\n  return new BigNum(sig, { base: e, offset: offset });\r\n}\r\n\r\nexport function getRpMultBase() {\r\n    const level = getLabLevel();\r\n    if (bigNumIsInfinite(level)) return BigNum.fromAny('Infinity');\r\n\r\n    if (isSurgeActive(12)) {\r\n        const effectiveNerf = getEffectiveTsunamiNerf();\r\n        \r\n        // Multiplier: 10^(5 * nerf) -> Log10 contribution: 5 * nerf\r\n        const multLog10 = 5 * effectiveNerf;\r\n        \r\n        // Base: (2 + nerf/2)^level -> Log10 contribution: level * log10(2 + nerf/2)\r\n        const base = 2 + (effectiveNerf / 2);\r\n        const log10Base = Math.log10(base).toFixed(18);\r\n        \r\n        const exponentFromBase = level.mulDecimal(log10Base, 18);\r\n        const exponent = exponentFromBase.add(BigNum.fromAny(String(multLog10)));\r\n        \r\n        return bigNumPowerOf10(exponent);\r\n    }\r\n    \r\n    // 2^level = 10^(level * log10(2))\r\n    const log10Of2 = \"0.3010299956639812\"; \r\n    \r\n    const exponent = level.mulDecimal(log10Of2, 18);\r\n    \r\n    return bigNumPowerOf10(exponent);\r\n}\r\n\r\nexport function getRpMult() {\r\n    const base = getRpMultBase();\r\n    if (typeof applyStatMultiplierOverride === 'function') {\r\n        return applyStatMultiplierOverride('rp', base);\r\n    }\r\n    return base;\r\n}\r\n\r\n// --- UI Logic ---\r\n\r\nlet labSystem = null;\r\n\r\nexport function initLabTab(panel) {\r\n  if (!panel) return;\r\n  panel.innerHTML = '';\r\n  panel.style.position = 'relative';\r\n  panel.style.overflow = 'hidden';\r\n  panel.style.height = '100%';\r\n  panel.style.width = '100%';\r\n  \r\n  if (labSystem) {\r\n      labSystem.destroy();\r\n  }\r\n  labSystem = new LabSystem(panel);\r\n}\r\n\r\nexport function updateLabTab() {\r\n  setLabVisited(true);\r\n  if (labSystem) {\r\n      labSystem.resize();\r\n  }\r\n}\r\n\r\nconst NODE_IMG_SIZE = 512 * 0.95;\r\n\r\nclass LabSystem {\r\n    constructor(container) {\r\n        this.container = container;\r\n        this.canvas = document.createElement('canvas');\r\n        this.canvas.classList.add('lab-bg-canvas');\r\n        this.canvas.style.display = 'block';\r\n        this.canvas.style.width = '100%';\r\n        this.canvas.style.height = '100%';\r\n        this.container.appendChild(this.canvas);\r\n        this.ctx = this.canvas.getContext('2d', { alpha: false });\r\n        \r\n        // Stats UI Container\r\n        this.statsContainer = document.createElement('div');\r\n        this.statsContainer.style.position = 'absolute';\r\n        this.statsContainer.style.top = '0px';\r\n        this.statsContainer.style.left = '50%';\r\n        this.statsContainer.style.transform = 'translateX(-50%)';\r\n        this.statsContainer.style.zIndex = '10';\r\n        this.statsContainer.style.display = 'flex';\r\n        this.statsContainer.style.flexDirection = 'column';\r\n        this.statsContainer.style.alignItems = 'center';\r\n        this.statsContainer.style.gap = '0px';\r\n        this.statsContainer.style.pointerEvents = 'none';\r\n        this.statsContainer.style.width = '100%'; \r\n        this.statsContainer.style.overflow = 'hidden';\r\n        this.statsContainer.classList.add('lab-stats-container');\r\n\r\n        const applyTextStyle = (el, fontSize, strokeWidth = '1px') => {\r\n            el.style.fontFamily = 'var(--font-ui), system-ui, sans-serif';\r\n            el.style.fontWeight = '900';\r\n            el.style.color = '#fff';\r\n            el.style.fontSize = fontSize;\r\n            el.style.webkitTextStroke = `${strokeWidth} #000`;\r\n            el.style.textShadow = '0 1px 0 rgba(0,0,0,0.35)';\r\n            el.style.letterSpacing = '0.5px';\r\n            el.style.lineHeight = '1';\r\n            el.style.textAlign = 'center';\r\n            el.style.whiteSpace = 'nowrap';\r\n            el.style.overflow = 'hidden';\r\n            el.style.textOverflow = 'ellipsis';\r\n        };\r\n\r\n        const applyBarStyle = (el) => {\r\n            el.style.backgroundColor = '#151b2b'; \r\n            el.style.background = 'linear-gradient(180deg, #253650, #151b2b)';\r\n            el.style.border = '3px solid #000';\r\n            el.style.borderRadius = '0';\r\n            el.style.boxShadow = '0 2px 4px rgba(0,0,0,0.5)';\r\n            el.style.display = 'flex';\r\n            el.style.alignItems = 'center';\r\n            el.style.justifyContent = 'center';\r\n            el.style.boxSizing = 'border-box';\r\n            el.style.margin = '0 auto'; \r\n        };\r\n\r\n        // Lab Level Bar\r\n        this.levelBar = document.createElement('div');\r\n        this.levelBar.innerHTML = `Lab Level: ${formatNumber(getLabLevel())}`;\r\n        applyBarStyle(this.levelBar);\r\n        applyTextStyle(this.levelBar, '26px', '1px');\r\n        this.levelBar.style.padding = '8px 12px';\r\n        this.levelBar.style.height = '42px';\r\n        this.levelBar.style.width = 'var(--coin-bar-w)'; \r\n        this.statsContainer.appendChild(this.levelBar);\r\n\r\n        // Coins Needed Bar\r\n        this.coinsBar = document.createElement('div');\r\n        this.coinsBar.innerHTML = 'Coins needed to increment Lab Level: 0';\r\n        applyBarStyle(this.coinsBar);\r\n        applyTextStyle(this.coinsBar, '16px', '0.9px');\r\n        this.coinsBar.style.padding = '6px 12px';\r\n        this.coinsBar.style.height = '32px';\r\n        this.coinsBar.style.width = 'calc(var(--coin-bar-w) * 0.9)'; \r\n        this.coinsBar.style.pointerEvents = 'auto'; \r\n        this.coinsBar.style.cursor = 'pointer';\r\n        \r\n        this.coinsBar.addEventListener('click', (e) => {\r\n            e.preventDefault();\r\n            e.stopPropagation();\r\n            updateLabLevel();\r\n        });\r\n        \r\n        this.statsContainer.appendChild(this.coinsBar);\r\n\r\n        // Nerf Exponent Bar\r\n        this.nerfBar = document.createElement('div');\r\n        this.nerfBar.textContent = 'Tsunami Exponent: ^0.00';\r\n        applyBarStyle(this.nerfBar);\r\n        applyTextStyle(this.nerfBar, '14px', '0.8px');\r\n        this.nerfBar.style.padding = '4px 12px';\r\n        this.nerfBar.style.height = '26px';\r\n        this.nerfBar.style.width = 'calc(var(--coin-bar-w) * 0.8)';\r\n        this.statsContainer.appendChild(this.nerfBar);\r\n\r\n        this.container.appendChild(this.statsContainer);\r\n        \r\n        // Return Button\r\n        this.returnBtn = document.createElement('button');\r\n        this.returnBtn.textContent = 'Return to (0,0)';\r\n        this.returnBtn.style.position = 'absolute';\r\n        this.returnBtn.style.top = '50%';\r\n        this.returnBtn.style.left = '50%';\r\n        this.returnBtn.style.transform = 'translate(-50%, -50%)';\r\n        this.returnBtn.style.zIndex = '10';\r\n        this.returnBtn.style.display = 'none';\r\n        this.returnBtn.style.padding = '10px 20px';\r\n        this.returnBtn.style.fontSize = '16px';\r\n        this.returnBtn.style.cursor = 'pointer';\r\n        this.returnBtn.style.backgroundColor = '#151b2b';\r\n        this.returnBtn.style.background = 'linear-gradient(180deg, #253650, #151b2b)';\r\n        this.returnBtn.style.color = '#fff';\r\n        this.returnBtn.style.border = '2px solid #000';\r\n        this.returnBtn.style.borderRadius = '4px';\r\n        \r\n        this.returnBtn.addEventListener('click', () => {\r\n            this.camX = 0;\r\n            this.camY = 0;\r\n            this.zoom = 0.15;\r\n            this.returnBtn.style.display = 'none';\r\n        });\r\n        \r\n        this.container.appendChild(this.returnBtn);\r\n        \r\n        // Help Text\r\n        this.helpText = document.createElement('div');\r\n        this.helpText.style.position = 'absolute';\r\n        this.helpText.style.bottom = '8px';\r\n        this.helpText.style.left = '12px';\r\n        this.helpText.style.pointerEvents = 'none';\r\n        this.helpText.style.zIndex = '10';\r\n        this.helpText.style.fontFamily = 'var(--font-ui), system-ui, sans-serif';\r\n        this.helpText.style.fontSize = '14px';\r\n        this.helpText.style.lineHeight = '1.5';\r\n        this.helpText.style.textShadow = '0 1px 2px rgba(0,0,0,0.8)';\r\n        \r\n        const lines = IS_MOBILE ? [\r\n            ['Node Details:', 'Tap'],\r\n            ['Move Camera:', 'Tap and hold'],\r\n            ['Zoom In/Out:', 'Pinch screen']\r\n        ] : [\r\n            ['Node Details:', 'Left click'],\r\n            ['Toggle Node:', 'Right click'],\r\n            ['Move Camera:', 'Left click and drag or WASD'],\r\n            ['Zoom In/Out:', 'Scroll']\r\n        ];\r\n        \r\n        let helpHtml = '';\r\n        for (const [label, val] of lines) {\r\n            helpHtml += `<div><span style=\"color: #fff; font-weight: 400;\">${label}</span><span style=\"color: #ccc; margin-left: 6px;\">${val}</span></div>`;\r\n        }\r\n        this.helpText.innerHTML = helpHtml;\r\n        this.container.appendChild(this.helpText);\r\n        \r\n        this.camX = 0;\r\n        this.camY = 0;\r\n        this.zoom = 0.15;\r\n        this.bursts = [];\r\n\r\n        this.baseImage = new Image();\r\n        this.baseImage.src = 'img/stats/rp/rp_base.webp';\r\n\r\n        this.activeBorderImage = new Image();\r\n        this.activeBorderImage.src = 'img/misc/green_border.webp';\r\n\r\n        this.maxedBorderImage = new Image();\r\n        this.maxedBorderImage.src = 'img/misc/maxed.webp';\r\n\r\n        this.nodeImages = {};\r\n        \r\n        this.isDragging = false;\r\n        this.dragStart = { x: 0, y: 0 };\r\n        this.lastMouse = { x: 0, y: 0 };\r\n        this.dragDistance = 0;\r\n        \r\n        this.keys = { KeyW: false, KeyA: false, KeyS: false, KeyD: false };\r\n        this.lastTime = 0;\r\n        this.frameId = null;\r\n        \r\n        this.pinchDist = null;\r\n        this.lastTouch = null; \r\n\r\n        this.binds = [];\r\n        this.setupInput();\r\n        \r\n        this.observer = new IntersectionObserver((entries) => {\r\n            if (entries[0].isIntersecting) {\r\n                this.start();\r\n            } else {\r\n                this.stop();\r\n            }\r\n        }, { threshold: 0 });\r\n        this.observer.observe(container);\r\n        \r\n        requestAnimationFrame(() => this.resize());\r\n        this.lastRenderedLevel = null;\r\n    }\r\n    \r\n    addBind(target, type, handler, opts) {\r\n        target.addEventListener(type, handler, opts);\r\n        this.binds.push({ target, type, handler });\r\n    }\r\n    \r\n    setupInput() {\r\n        this.addBind(this.canvas, 'contextmenu', (e) => e.preventDefault());\r\n        this.addBind(this.canvas, 'mousedown', this.onMouseDown.bind(this));\r\n        this.addBind(window, 'mousemove', this.onMouseMove.bind(this));\r\n        this.addBind(window, 'mouseup', this.onMouseUp.bind(this));\r\n        this.addBind(this.canvas, 'wheel', this.onWheel.bind(this), { passive: false });\r\n        \r\n        this.addBind(this.canvas, 'touchstart', this.onTouchStart.bind(this), { passive: false });\r\n        this.addBind(this.canvas, 'touchmove', this.onTouchMove.bind(this), { passive: false });\r\n        this.addBind(this.canvas, 'touchend', this.onTouchEnd.bind(this));\r\n        \r\n        this.addBind(window, 'keydown', (e) => { if(this.keys.hasOwnProperty(e.code)) this.keys[e.code] = true; });\r\n        this.addBind(window, 'keyup', (e) => { if(this.keys.hasOwnProperty(e.code)) this.keys[e.code] = false; });\r\n        \r\n        this.addBind(window, 'resize', this.resize.bind(this));\r\n    }\r\n    \r\n    destroy() {\r\n        this.stop();\r\n        this.observer.disconnect();\r\n        for (const b of this.binds) {\r\n            b.target.removeEventListener(b.type, b.handler);\r\n        }\r\n        this.canvas.remove();\r\n        this.returnBtn.remove();\r\n        this.helpText.remove();\r\n        this.statsContainer.remove();\r\n        if (this.overlay) {\r\n            this.overlay.remove();\r\n        }\r\n    }\r\n    \r\n    resize() {\r\n        if (!this.container.isConnected) return;\r\n        const rect = this.container.getBoundingClientRect();\r\n        const dpr = window.devicePixelRatio || 1;\r\n        this.width = rect.width;\r\n        this.height = rect.height;\r\n        this.canvas.width = Math.floor(this.width * dpr);\r\n        this.canvas.height = Math.floor(this.height * dpr);\r\n        this.ctx.scale(dpr, dpr);\r\n        this.render(); \r\n    }\r\n    \r\n    start() {\r\n        if (!this.frameId) {\r\n            this.lastTime = performance.now();\r\n            this.loop();\r\n        }\r\n    }\r\n    \r\n    stop() {\r\n        if (this.frameId) {\r\n            cancelAnimationFrame(this.frameId);\r\n            this.frameId = null;\r\n        }\r\n    }\r\n    \r\n    loop() {\r\n        const now = performance.now();\r\n        const dt = Math.min((now - this.lastTime) / 1000, 0.1); \r\n        this.lastTime = now;\r\n        \r\n        this.update(dt);\r\n        this.render();\r\n        \r\n        this.frameId = requestAnimationFrame(() => this.loop());\r\n    }\r\n    \r\n    checkBounds() {\r\n        const tooFar = Math.abs(this.camX) > 1e10 || Math.abs(this.camY) > 1e10;\r\n        const badZoom = this.zoom > 1e10 || this.zoom < 1e-10;\r\n        \r\n        if (tooFar || badZoom) {\r\n            this.returnBtn.style.display = 'block';\r\n        } else {\r\n            this.returnBtn.style.display = 'none';\r\n        }\r\n\r\n        // Hard limits to prevent crashes (although loop protection should handle rendering)\r\n        if (this.camX > CAM_MAX_COORD) this.camX = CAM_MAX_COORD;\r\n        if (this.camX < -CAM_MAX_COORD) this.camX = -CAM_MAX_COORD;\r\n        if (this.camY > CAM_MAX_COORD) this.camY = CAM_MAX_COORD;\r\n        if (this.camY < -CAM_MAX_COORD) this.camY = -CAM_MAX_COORD;\r\n        \r\n        if (this.zoom > CAM_MAX_ZOOM) this.zoom = CAM_MAX_ZOOM;\r\n        if (this.zoom < CAM_MIN_ZOOM) this.zoom = CAM_MIN_ZOOM;\r\n    }\r\n    \r\n    update(dt) {\r\n        this.checkBounds();\r\n\r\n        const currentLevel = getLabLevel();\r\n        const cost = getLabCost(currentLevel.add(1));\r\n        \r\n        const baseNerf = getTsunamiNerf();\r\n        const bonus = getTsunamiResearchBonus();\r\n        let effectiveNerf = baseNerf + bonus;\r\n        if (effectiveNerf > 1) effectiveNerf = 1;\r\n        \r\n        if (!this.lastRenderedLevel || currentLevel.cmp(this.lastRenderedLevel) !== 0 || !this.lastCost || cost.cmp(this.lastCost) !== 0) {\r\n            this.levelBar.innerHTML = `Lab Level: ${formatNumber(currentLevel)}`;\r\n            this.coinsBar.innerHTML = `Coins needed to increment Lab Level: ${formatNumber(cost)}`; \r\n            this.lastRenderedLevel = currentLevel;\r\n            this.lastCost = cost;\r\n        }\r\n\r\n        if (effectiveNerf !== this.lastRenderedNerf) {\r\n            this.nerfBar.textContent = `Tsunami Exponent: ^${effectiveNerf.toFixed(2)}`;\r\n            this.lastRenderedNerf = effectiveNerf;\r\n        }\r\n        \r\n        // Update Bursts\r\n        for (let i = this.bursts.length - 1; i >= 0; i--) {\r\n            const b = this.bursts[i];\r\n            b.time += dt;\r\n\r\n            for(const p of b.particles) {\r\n                p.x += p.vx * dt;\r\n                p.y += p.vy * dt;\r\n                p.vx *= 0.95; \r\n                p.vy *= 0.95;\r\n            }\r\n\r\n            if (b.time >= b.life) {\r\n                this.bursts.splice(i, 1);\r\n            }\r\n        }\r\n        \r\n        // WASD Movement\r\n        const baseSpeed = 500;\r\n        const speed = baseSpeed / this.zoom; \r\n        let dx = 0;\r\n        let dy = 0;\r\n        if (this.keys.KeyW) dy -= 1;\r\n        if (this.keys.KeyS) dy += 1;\r\n        if (this.keys.KeyA) dx -= 1;\r\n        if (this.keys.KeyD) dx += 1;\r\n        \r\n        if (dx !== 0 || dy !== 0) {\r\n            const len = Math.sqrt(dx*dx + dy*dy);\r\n            dx /= len;\r\n            dy /= len;\r\n            this.camX += dx * speed * dt;\r\n            this.camY += dy * speed * dt;\r\n        }\r\n\r\n        // Update active overlay if open\r\n        if (this.activeOverlayId != null) {\r\n            this.updateNodeOverlay();\r\n        }\r\n    }\r\n    \r\n    getNodePosition(node) {\r\n        // Absolute coordinates\r\n        return { x: node.x, y: node.y };\r\n    }\r\n\r\n    render() {\r\n        const ctx = this.ctx;\r\n        const w = this.width;\r\n        const h = this.height;\r\n        const z = this.zoom;\r\n        \r\n        ctx.fillStyle = '#080d18';\r\n        ctx.fillRect(0, 0, w, h);\r\n        \r\n        // --- Grid ---\r\n        const baseGridSize = 100;\r\n        const logZoom = Math.log10(z);\r\n        const k = Math.floor(-logZoom + 0.3);\r\n        const targetScreenSize = 100;\r\n        const idealWorldUnit = targetScreenSize / z;\r\n        const power = Math.floor(Math.log10(idealWorldUnit));\r\n        const unit = Math.pow(10, power);\r\n        \r\n        const drawGrid = (gridUnit, opacity) => {\r\n            if (opacity <= 0) return;\r\n            ctx.strokeStyle = `rgba(60, 100, 160, ${0.15 * opacity})`;\r\n            ctx.lineWidth = 1;\r\n            ctx.beginPath();\r\n            \r\n            const startX = Math.floor((this.camX - (w/2)/z) / gridUnit) * gridUnit;\r\n            const endX = Math.ceil((this.camX + (w/2)/z) / gridUnit) * gridUnit;\r\n            if ((endX - startX) / gridUnit > 1000) return; \r\n\r\n            for (let x = startX; x <= endX; x += gridUnit) {\r\n                // Safeguard against infinite loops due to precision loss\r\n                if (x + gridUnit <= x) break;\r\n                \r\n                const sx = (x - this.camX) * z + w/2;\r\n                ctx.moveTo(sx, 0);\r\n                ctx.lineTo(sx, h);\r\n            }\r\n            const startY = Math.floor((this.camY - (h/2)/z) / gridUnit) * gridUnit;\r\n            const endY = Math.ceil((this.camY + (h/2)/z) / gridUnit) * gridUnit;\r\n            for (let y = startY; y <= endY; y += gridUnit) {\r\n                // Safeguard against infinite loops due to precision loss\r\n                if (y + gridUnit <= y) break;\r\n\r\n                const sy = (y - this.camY) * z + h/2;\r\n                ctx.moveTo(0, sy);\r\n                ctx.lineTo(w, sy);\r\n            }\r\n            ctx.stroke();\r\n        };\r\n\r\n        const screenUnit = unit * z;\r\n        const alpha = Math.max(0, Math.min(1, (screenUnit - 15) / 25));\r\n        \r\n        drawGrid(unit, alpha);\r\n        drawGrid(unit * 10, 1.0);\r\n        \r\n        ctx.strokeStyle = 'rgba(60, 100, 160, 0.5)';\r\n        ctx.lineWidth = 2;\r\n        ctx.beginPath();\r\n        const axisY = (0 - this.camY) * z + h/2;\r\n        if (axisY >= -10 && axisY <= h+10) {\r\n             ctx.moveTo(0, axisY);\r\n             ctx.lineTo(w, axisY);\r\n        }\r\n        const axisX = (0 - this.camX) * z + w/2;\r\n        if (axisX >= -10 && axisX <= w+10) {\r\n            ctx.moveTo(axisX, 0);\r\n            ctx.lineTo(axisX, h);\r\n        }\r\n        ctx.stroke();\r\n        \r\n        // --- Calculate Visibility & Positions ---\r\n        const visibleNodes = [];\r\n        const nodePositions = new Map();\r\n        \r\n        for (const node of RESEARCH_NODES) {\r\n             if (isResearchNodeVisible(node.id)) {\r\n                 visibleNodes.push(node);\r\n                 nodePositions.set(node.id, this.getNodePosition(node));\r\n             }\r\n        }\r\n\r\n        // --- Draw Connections ---\r\n        ctx.strokeStyle = '#2a5298'; // Dark blue\r\n        ctx.lineWidth = 20 * z;\r\n        ctx.lineCap = 'round';\r\n        ctx.beginPath();\r\n        \r\n        for (const node of visibleNodes) {\r\n             // Draw lines to ALL visible parents\r\n             if (node.parentIds && node.parentIds.length > 0) {\r\n                 for (const parentId of node.parentIds) {\r\n                     const parent = RESEARCH_NODES.find(n => n.id === parentId);\r\n                     if (parent && nodePositions.has(parent.id)) {\r\n                         const start = nodePositions.get(parent.id);\r\n                         const end = nodePositions.get(node.id);\r\n                         \r\n                         const sx = (start.x - this.camX) * z + w/2;\r\n                         const sy = (start.y - this.camY) * z + h/2;\r\n                         const ex = (end.x - this.camX) * z + w/2;\r\n                         const ey = (end.y - this.camY) * z + h/2;\r\n                         \r\n                         ctx.moveTo(sx, sy);\r\n                         ctx.lineTo(ex, ey);\r\n                     }\r\n                 }\r\n             }\r\n        }\r\n        ctx.stroke();\r\n\r\n        // --- Draw Nodes ---\r\n        const imgSize = NODE_IMG_SIZE;\r\n        const imgScreenSize = imgSize * z;\r\n        const baseSize = imgSize * 1.6;\r\n        const baseScreenSize = baseSize * z;\r\n        \r\n        for (const node of visibleNodes) {\r\n             const pos = nodePositions.get(node.id);\r\n             const cx = (pos.x - this.camX) * z + w/2;\r\n             const cy = (pos.y - this.camY) * z + h/2;\r\n             \r\n             // Check visibility\r\n             const nodeLevel = getResearchNodeLevel(node.id);\r\n             const isMaxed = nodeLevel >= node.maxLevel;\r\n             const hasBar = true;\r\n             \r\n             const bottomBound = 0.8;\r\n             \r\n             if (cx + baseScreenSize/2 < 0 || cx - baseScreenSize/2 > w ||\r\n                 cy + baseScreenSize * bottomBound < 0 || cy - baseScreenSize/2 > h) {\r\n                 continue;\r\n             }\r\n             \r\n             // Draw Base\r\n             if (this.baseImage.complete && this.baseImage.naturalWidth !== 0) {\r\n                 ctx.drawImage(this.baseImage, cx - baseScreenSize/2, cy - baseScreenSize/2, baseScreenSize, baseScreenSize);\r\n             }\r\n             \r\n             // Draw Active/Maxed Border\r\n             if (isMaxed) {\r\n                 if (this.maxedBorderImage.complete && this.maxedBorderImage.naturalWidth !== 0) {\r\n                     ctx.drawImage(this.maxedBorderImage, cx - baseScreenSize/2, cy - baseScreenSize/2, baseScreenSize, baseScreenSize);\r\n                 }\r\n             } else if (isResearchNodeActive(node.id)) {\r\n                 if (this.activeBorderImage.complete && this.activeBorderImage.naturalWidth !== 0) {\r\n                     ctx.drawImage(this.activeBorderImage, cx - baseScreenSize/2, cy - baseScreenSize/2, baseScreenSize, baseScreenSize);\r\n                 }\r\n             }\r\n\r\n             // Draw Icon\r\n             let img = this.nodeImages[node.id];\r\n             if (!img) {\r\n                 img = new Image();\r\n                 img.src = 'img/' + node.icon;\r\n                 this.nodeImages[node.id] = img;\r\n             }\r\n             \r\n             if (img.complete && img.naturalWidth !== 0) {\r\n                 ctx.drawImage(img, cx - imgScreenSize/2, cy - imgScreenSize/2, imgScreenSize, imgScreenSize);\r\n             }\r\n\r\n             // Draw Active Progress Bar\r\n             if (hasBar) {\r\n                 const req = getResearchNodeRequirement(node.id);\r\n                 let progress = 0;\r\n                 \r\n                 if (isMaxed) {\r\n                     progress = 1;\r\n                 } else {\r\n                     // Handle progress calculation safely\r\n                     if (req.isInfinite?.() || (typeof req.cmp === 'function' && req.cmp(BigNum.fromAny('Infinity')) === 0)) {\r\n                         progress = 0;\r\n                     } else {\r\n                         const rp = getResearchNodeRp(node.id);\r\n                         if (rp.isZero?.()) {\r\n                             progress = 0;\r\n                         } else {\r\n                             try {\r\n                                if (req.isZero?.()) {\r\n                                    progress = 1;\r\n                                } else {\r\n                                    const ratio = rp.div(req);\r\n                                    const ratioSci = ratio.toScientific(5);\r\n                                    progress = Number(ratioSci);\r\n                                }\r\n                             } catch (e) {\r\n                                progress = 0;\r\n                             }\r\n                         }\r\n                     }\r\n                 }\r\n                 \r\n                 progress = Math.max(0, Math.min(1, progress));\r\n                 \r\n                 const barWidth = baseScreenSize * 0.96;\r\n                 const barHeight = baseScreenSize * 0.18;\r\n                 const barX = cx - barWidth / 2;\r\n                 const barY = cy + baseScreenSize / 2 + (baseScreenSize * 0.05); \r\n                 \r\n                 // Background\r\n                 ctx.fillStyle = '#111';\r\n                 ctx.fillRect(barX, barY, barWidth, barHeight);\r\n                 \r\n                 // Progress Fill (Darkish Blue Gradient)\r\n                 const grad = ctx.createLinearGradient(barX, barY, barX, barY + barHeight);\r\n                 grad.addColorStop(0, '#2a5298');\r\n                 grad.addColorStop(1, '#1e3c72');\r\n                 \r\n                 ctx.fillStyle = grad;\r\n                 ctx.fillRect(barX, barY, barWidth * progress, barHeight);\r\n                 \r\n                 // Border\r\n                 ctx.strokeStyle = '#fff';\r\n                 ctx.lineWidth = Math.max(1, 2 * z); \r\n                 ctx.strokeRect(barX, barY, barWidth, barHeight);\r\n                 \r\n                 // Text\r\n                 ctx.fillStyle = '#fff';\r\n                 ctx.font = `bold ${barHeight * 0.7}px system-ui`;\r\n                 ctx.textAlign = 'center';\r\n                 ctx.textBaseline = 'alphabetic';\r\n                 ctx.strokeStyle = '#000';\r\n                 ctx.lineWidth = Math.max(0.5, barHeight * 0.08); \r\n                 \r\n                 let text = '';\r\n                 {\r\n                     let lvlStr = formatNumber(BigNum.fromAny(nodeLevel));\r\n                     if (lvlStr.indexOf('<') >= 0) lvlStr = '\u221E';\r\n                     text = `Level ${lvlStr}`;\r\n                 }\r\n                 if (isMaxed) {\r\n                     text = node.maxLevel === 1 ? 'UNLOCKED' : 'MAXED';\r\n                 }\r\n\r\n                 const metrics = ctx.measureText(text);\r\n                 const textY = barY + barHeight / 2 + (metrics.actualBoundingBoxAscent - metrics.actualBoundingBoxDescent) / 2;\r\n\r\n                 ctx.strokeText(text, barX + barWidth / 2, textY);\r\n                 ctx.fillText(text, barX + barWidth / 2, textY);\r\n             }\r\n        }\r\n\r\n        // Draw Bursts\r\n        const MAX_RADIUS = 35;\r\n        const ringConfigs = [\r\n            { delay: 0.00, dur: 0.50 },\r\n            { delay: 0.05, dur: 0.55 },\r\n            { delay: 0.10, dur: 0.60 }\r\n        ];\r\n        \r\n        for (const b of this.bursts) {\r\n            const cx = (b.x - this.camX) * this.zoom + w/2;\r\n            const cy = (b.y - this.camY) * this.zoom + h/2;\r\n            \r\n            for (let i = 0; i < ringConfigs.length; i++) {\r\n                const r = ringConfigs[i];\r\n                const rt = b.time - r.delay;\r\n                if (rt > 0 && rt < r.dur) {\r\n                    const prog = rt / r.dur;\r\n                    const ease = 1 - Math.pow(1 - prog, 3);\r\n                    const rad = MAX_RADIUS * ease;\r\n                    const alpha = Math.max(0, 1 - Math.pow(prog, 2));\r\n\r\n                    const visibilityBoost = 1.0 + (i * 0.5); \r\n                    const grad = ctx.createRadialGradient(cx, cy, rad * 0.6, cx, cy, rad);\r\n                    \r\n                    grad.addColorStop(0, `rgba(255, 200, 50, 0)`);\r\n                    grad.addColorStop(0.7, `rgba(255, 170, 20, ${Math.min(1, alpha * 0.15 * visibilityBoost)})`);\r\n                    grad.addColorStop(0.9, `rgba(255, 240, 80, ${Math.min(1, alpha * 0.2 * visibilityBoost)})`);\r\n                    grad.addColorStop(1, `rgba(255, 200, 50, 0)`);\r\n                    \r\n                    ctx.fillStyle = grad;\r\n                    ctx.beginPath();\r\n                    ctx.arc(cx, cy, rad, 0, Math.PI * 2);\r\n                    ctx.fill();\r\n                }\r\n            }\r\n            \r\n            ctx.shadowBlur = 8;\r\n            ctx.shadowColor = '#ffff00';\r\n            for(const p of b.particles) {\r\n                if (b.time < p.life) {\r\n                    const pAlpha = 1 - (b.time / p.life);\r\n                    const px = cx + p.x;\r\n                    const py = cy + p.y;\r\n                    \r\n                    ctx.fillStyle = `rgba(255, 255, 150, ${pAlpha})`;\r\n                    ctx.beginPath();\r\n                    ctx.arc(px, py, 2, 0, Math.PI * 2);\r\n                    ctx.fill();\r\n                }\r\n            }\r\n            ctx.shadowBlur = 0;\r\n        }\r\n    }\r\n    \r\n    addBurst(x, y) {\r\n        const particles = [];\r\n        const count = 10;\r\n        for(let i=0; i<count; i++) {\r\n            const angle = Math.random() * Math.PI * 2;\r\n            const speed = 30 + Math.random() * 40;\r\n            particles.push({\r\n                x: 0, \r\n                y: 0,\r\n                vx: Math.cos(angle) * speed,\r\n                vy: Math.sin(angle) * speed,\r\n                life: 0.4 + Math.random() * 0.3\r\n            });\r\n        }\r\n        this.bursts.push({ x, y, time: 0, life: 0.7, particles });\r\n    }\r\n\r\n    addBurstFromScreen(mx, my) {\r\n        const rect = this.canvas.getBoundingClientRect();\r\n        const x = mx - rect.left;\r\n        const y = my - rect.top;\r\n        const wx = this.camX + (x - this.width/2) / this.zoom;\r\n        const wy = this.camY + (y - this.height/2) / this.zoom;\r\n        this.addBurst(wx, wy);\r\n    }\r\n\r\n    handleClick(x, y) {\r\n        // x,y in screen coords\r\n        const rect = this.canvas.getBoundingClientRect();\r\n        const mx = x - rect.left;\r\n        const my = y - rect.top;\r\n        const wx = this.camX + (mx - this.width/2) / this.zoom;\r\n        const wy = this.camY + (my - this.height/2) / this.zoom;\r\n        \r\n        // Check for node click\r\n        const clickRadius = (NODE_IMG_SIZE / 2) * 1.6; // Base size radius in world units\r\n        \r\n        for (const node of RESEARCH_NODES) {\r\n            if (!isResearchNodeVisible(node.id)) continue;\r\n            \r\n            const pos = this.getNodePosition(node);\r\n            const dx = wx - pos.x;\r\n            const dy = wy - pos.y;\r\n            const dist = Math.sqrt(dx*dx + dy*dy);\r\n            \r\n            if (dist <= clickRadius) {\r\n                this.openNodeOverlay(node.id);\r\n                return;\r\n            }\r\n        }\r\n    }\r\n\r\n    // -- Overlay UI --\r\n    openNodeOverlay(id) {\r\n        const node = RESEARCH_NODES.find(n => n.id === id);\r\n        if (!node) return;\r\n        \r\n        this.activeOverlayId = id;\r\n        \r\n        if (this.overlay) {\r\n            this.overlay.remove();\r\n        }\r\n        \r\n        this.overlay = document.createElement('div');\r\n        this.overlay.className = 'upg-overlay'; \r\n        this.overlay.style.zIndex = '4005';\r\n        \r\n        const sheet = document.createElement('div');\r\n        sheet.className = 'upg-sheet';\r\n        sheet.style.gridTemplateRows = 'auto auto 1fr auto';\r\n        \r\n        const grabber = document.createElement('div');\r\n        grabber.className = 'upg-grabber';\r\n        grabber.innerHTML = `<div class=\"grab-handle\"></div>`;\r\n        \r\n        const header = document.createElement('div');\r\n        header.className = 'upg-header';\r\n        \r\n        const title = document.createElement('div');\r\n        title.className = 'upg-title';\r\n        title.textContent = node.title;\r\n        \r\n        this.overlayLevel = document.createElement('div');\r\n        this.overlayLevel.className = 'upg-level'; \r\n        \r\n        header.append(title, this.overlayLevel);\r\n        \r\n        const content = document.createElement('div');\r\n        content.className = 'upg-content';\r\n        \r\n        // Description\r\n        const desc = document.createElement('div');\r\n        desc.className = 'upg-desc centered';\r\n        desc.innerHTML = node.desc;\r\n        \r\n        const info = document.createElement('div');\r\n        info.className = 'upg-info';\r\n        \r\n        // Bonus (Effect)\r\n        this.overlayBonus = document.createElement('div');\r\n        this.overlayBonus.className = 'upg-line';\r\n        \r\n        // Active Status\r\n        this.overlayActiveStatus = document.createElement('div');\r\n        this.overlayActiveStatus.className = 'upg-line';\r\n        \r\n        // Progress\r\n        this.overlayProgress = document.createElement('div');\r\n        this.overlayProgress.className = 'upg-line';\r\n        this.overlayProgress.style.color = '#aaa';\r\n        \r\n        info.append(this.overlayBonus, this.overlayActiveStatus, this.overlayProgress);\r\n        content.append(desc, info);\r\n        \r\n        // Actions\r\n        const actions = document.createElement('div');\r\n        actions.className = 'upg-actions';\r\n        \r\n        this.overlayToggleBtn = document.createElement('button');\r\n        this.overlayToggleBtn.className = 'shop-delve';\r\n        this.overlayToggleBtn.textContent = 'Toggle';\r\n        this.overlayToggleBtn.onclick = () => {\r\n             const active = isResearchNodeActive(id);\r\n             setResearchNodeActive(id, !active);\r\n             this.updateNodeOverlay();\r\n        };\r\n        \r\n        const closeBtn = document.createElement('button');\r\n        closeBtn.className = 'shop-close';\r\n        closeBtn.textContent = 'Close';\r\n        closeBtn.onclick = () => {\r\n            this.activeOverlayId = null;\r\n            if (this.overlay) {\r\n                this.overlay.classList.remove('is-open');\r\n                setTimeout(() => {\r\n                    if (this.overlay) {\r\n                        this.overlay.remove();\r\n                        this.overlay = null;\r\n                    }\r\n                }, 300);\r\n            }\r\n        };\r\n        \r\n        actions.append(closeBtn, this.overlayToggleBtn);\r\n        \r\n        sheet.append(grabber, header, content, actions);\r\n        this.overlay.appendChild(sheet);\r\n        document.body.appendChild(this.overlay);\r\n        \r\n        setupDragToClose(grabber, sheet, () => !!this.overlay, () => closeBtn.click());\r\n        \r\n        requestAnimationFrame(() => {\r\n            if (this.overlay) {\r\n                this.overlay.classList.add('is-open');\r\n            }\r\n        });\r\n        \r\n        this.updateNodeOverlay();\r\n    }\r\n    \r\n    updateNodeOverlay() {\r\n        if (this.activeOverlayId == null || !this.overlay) return;\r\n        const node = RESEARCH_NODES.find(n => n.id === this.activeOverlayId);\r\n        if (!node || !isResearchNodeVisible(node.id)) {\r\n            if (this.overlay) this.overlay.remove();\r\n            this.activeOverlayId = null;\r\n            this.overlay = null;\r\n            return;\r\n        }\r\n        \r\n        const level = getResearchNodeLevel(node.id);\r\n        const rp = getResearchNodeRp(node.id);\r\n        const req = getResearchNodeRequirement(node.id);\r\n        const active = isResearchNodeActive(node.id);\r\n        \r\n        const isMaxed = level >= node.maxLevel;\r\n        \r\n        if (isMaxed) {\r\n             const statusText = '(MAXED)';\r\n             this.overlayLevel.innerHTML = `Level ${formatNumber(BigNum.fromAny(level))} / ${formatNumber(BigNum.fromAny(node.maxLevel))} ${statusText}`;\r\n             this.overlayActiveStatus.style.display = 'none';\r\n             this.overlayProgress.style.display = 'none';\r\n             if (this.overlayToggleBtn) this.overlayToggleBtn.style.display = 'none';\r\n        } else {\r\n             this.overlayLevel.innerHTML = `Level ${formatNumber(BigNum.fromAny(level))} / ${formatNumber(BigNum.fromAny(node.maxLevel))}`;\r\n             this.overlayActiveStatus.style.display = '';\r\n             this.overlayProgress.style.display = '';\r\n             if (this.overlayToggleBtn) this.overlayToggleBtn.style.display = '';\r\n        }\r\n        \r\n        if (typeof node.bonusLine === 'function') {\r\n            const line = node.bonusLine(level);\r\n            if (line) {\r\n                this.overlayBonus.style.display = '';\r\n                this.overlayBonus.innerHTML = line;\r\n            } else {\r\n                this.overlayBonus.style.display = 'none';\r\n            }\r\n        } else {\r\n            this.overlayBonus.style.display = 'none';\r\n        }\r\n        \r\n        if (!isMaxed) {\r\n            this.overlayActiveStatus.textContent = `Currently active: ${active ? 'Yes' : 'No'}`;\r\n            this.overlayActiveStatus.style.color = active ? '#4f4' : '#f44';\r\n            this.overlayActiveStatus.style.webkitTextFillColor = active ? '#4f4' : '#f44';\r\n            \r\n            const rpFmt = rp.cmp(1e9) > 0 ? formatNumber(rp) : rp.toString();\r\n            const reqFmt = req.isInfinite?.() ? 'Infinity' : (req.cmp(1e9) > 0 ? formatNumber(req) : req.toString());\r\n            \r\n            this.overlayProgress.innerHTML = `RP to next level: ${formatNumber(rp)} / ${formatNumber(req)}`;\r\n        }\r\n    }\r\n\r\n    // -- Input Handlers --\r\n    \r\n    handleRightClick(x, y) {\r\n        const rect = this.canvas.getBoundingClientRect();\r\n        const mx = x - rect.left;\r\n        const my = y - rect.top;\r\n        const wx = this.camX + (mx - this.width/2) / this.zoom;\r\n        const wy = this.camY + (my - this.height/2) / this.zoom;\r\n        \r\n        const clickRadius = (NODE_IMG_SIZE / 2) * 1.6;\r\n        \r\n        for (const node of RESEARCH_NODES) {\r\n            if (!isResearchNodeVisible(node.id)) continue;\r\n            \r\n            const pos = this.getNodePosition(node);\r\n            const dx = wx - pos.x;\r\n            const dy = wy - pos.y;\r\n            const dist = Math.sqrt(dx*dx + dy*dy);\r\n            \r\n            if (dist <= clickRadius) {\r\n                 const level = getResearchNodeLevel(node.id);\r\n                 if (level >= node.maxLevel) return;\r\n\r\n                 const active = isResearchNodeActive(node.id);\r\n                 setResearchNodeActive(node.id, !active);\r\n\r\n                 if (this.activeOverlayId === node.id) {\r\n                     this.updateNodeOverlay();\r\n                 }\r\n                 return;\r\n            }\r\n        }\r\n    }\r\n\r\n    onMouseDown(e) {\r\n        if (e.button === 2) {\r\n            this.handleRightClick(e.clientX, e.clientY);\r\n            return;\r\n        }\r\n        if (e.button !== 0) return;\r\n        this.isDragging = true;\r\n        this.dragStart = { x: e.clientX, y: e.clientY };\r\n        this.lastMouse = { x: e.clientX, y: e.clientY };\r\n        this.addBurstFromScreen(e.clientX, e.clientY);\r\n    }\r\n    \r\n    onMouseMove(e) {\r\n        if (this.isDragging) {\r\n            const dx = e.clientX - this.lastMouse.x;\r\n            const dy = e.clientY - this.lastMouse.y;\r\n            this.lastMouse = { x: e.clientX, y: e.clientY };\r\n            \r\n            this.camX -= dx / this.zoom;\r\n            this.camY -= dy / this.zoom;\r\n            this.canvas.style.cursor = 'grabbing';\r\n            return;\r\n        }\r\n\r\n        // Hover logic\r\n        this.lastMouse = { x: e.clientX, y: e.clientY };\r\n        const rect = this.canvas.getBoundingClientRect();\r\n        const mx = e.clientX - rect.left;\r\n        const my = e.clientY - rect.top;\r\n        const wx = this.camX + (mx - this.width/2) / this.zoom;\r\n        const wy = this.camY + (my - this.height/2) / this.zoom;\r\n\r\n        let hovering = false;\r\n        const clickRadius = (NODE_IMG_SIZE / 2) * 1.6;\r\n        for (const node of RESEARCH_NODES) {\r\n            if (!isResearchNodeVisible(node.id)) continue;\r\n            \r\n            const pos = this.getNodePosition(node);\r\n            const dx = wx - pos.x;\r\n            const dy = wy - pos.y;\r\n            const dist = Math.sqrt(dx*dx + dy*dy);\r\n            if (dist <= clickRadius) {\r\n                hovering = true;\r\n                break;\r\n            }\r\n        }\r\n        this.canvas.style.cursor = hovering ? 'pointer' : 'default';\r\n    }\r\n    \r\n    onMouseUp(e) {\r\n        if (!this.isDragging) return;\r\n        this.isDragging = false;\r\n        this.canvas.style.cursor = 'default';\r\n        \r\n        const dist = Math.sqrt(Math.pow(e.clientX - this.dragStart.x, 2) + Math.pow(e.clientY - this.dragStart.y, 2));\r\n        if (dist < 10) { // Threshold for click\r\n             this.handleClick(e.clientX, e.clientY);\r\n        }\r\n        \r\n        // Trigger a move update to set correct hover cursor immediately\r\n        this.onMouseMove(e);\r\n    }\r\n    \r\n    onWheel(e) {\r\n        e.preventDefault();\r\n        const sensitivity = 0.001;\r\n        const delta = -e.deltaY * sensitivity;\r\n        const oldZoom = this.zoom;\r\n        let newZoom = oldZoom * (1 + delta);\r\n        \r\n        // Clamp newZoom immediately to prevent camera drift at limits\r\n        if (newZoom < CAM_MIN_ZOOM) newZoom = CAM_MIN_ZOOM;\r\n        if (newZoom > CAM_MAX_ZOOM) newZoom = CAM_MAX_ZOOM;\r\n        \r\n        const rect = this.canvas.getBoundingClientRect();\r\n        const mx = e.clientX - rect.left;\r\n        const my = e.clientY - rect.top;\r\n        \r\n        const mouseWorldX = this.camX + (mx - this.width/2) / oldZoom;\r\n        const mouseWorldY = this.camY + (my - this.height/2) / oldZoom;\r\n        \r\n        this.zoom = newZoom;\r\n        \r\n        this.camX = mouseWorldX - (mx - this.width/2) / newZoom;\r\n        this.camY = mouseWorldY - (my - this.height/2) / newZoom;\r\n    }\r\n    \r\n    // Touch\r\n    getTouchDist(touches) {\r\n        const dx = touches[0].clientX - touches[1].clientX;\r\n        const dy = touches[0].clientY - touches[1].clientY;\r\n        return Math.sqrt(dx*dx + dy*dy);\r\n    }\r\n    \r\n    getTouchCenter(touches) {\r\n        return {\r\n            x: (touches[0].clientX + touches[1].clientX) / 2,\r\n            y: (touches[0].clientY + touches[1].clientY) / 2\r\n        };\r\n    }\r\n    \r\n    onTouchStart(e) {\r\n        e.preventDefault(); \r\n        if (e.touches.length === 1) {\r\n            this.isDragging = true;\r\n            this.lastTouch = { x: e.touches[0].clientX, y: e.touches[0].clientY };\r\n            this.dragStart = { x: e.touches[0].clientX, y: e.touches[0].clientY };\r\n            this.addBurstFromScreen(e.touches[0].clientX, e.touches[0].clientY);\r\n        } else if (e.touches.length === 2) {\r\n            this.isDragging = false; \r\n            this.pinchDist = this.getTouchDist(e.touches);\r\n        }\r\n    }\r\n    \r\n    onTouchMove(e) {\r\n        e.preventDefault();\r\n        if (e.touches.length === 1 && this.isDragging) {\r\n            const dx = e.touches[0].clientX - this.lastTouch.x;\r\n            const dy = e.touches[0].clientY - this.lastTouch.y;\r\n            this.lastTouch = { x: e.touches[0].clientX, y: e.touches[0].clientY };\r\n            \r\n            this.camX -= dx / this.zoom;\r\n            this.camY -= dy / this.zoom;\r\n        } else if (e.touches.length === 2) {\r\n            const dist = this.getTouchDist(e.touches);\r\n            if (this.pinchDist > 0) {\r\n                const scale = dist / this.pinchDist;\r\n                \r\n                const oldZoom = this.zoom;\r\n                let newZoom = oldZoom * scale;\r\n                // Clamp newZoom immediately to prevent camera drift at limits\r\n                if (newZoom < CAM_MIN_ZOOM) newZoom = CAM_MIN_ZOOM;\r\n                if (newZoom > CAM_MAX_ZOOM) newZoom = CAM_MAX_ZOOM;\r\n                \r\n                const center = this.getTouchCenter(e.touches);\r\n                const rect = this.canvas.getBoundingClientRect();\r\n                const mx = center.x - rect.left;\r\n                const my = center.y - rect.top;\r\n                \r\n                const worldX = this.camX + (mx - this.width/2) / oldZoom;\r\n                const worldY = this.camY + (my - this.height/2) / oldZoom;\r\n                \r\n                this.zoom = newZoom;\r\n                this.camX = worldX - (mx - this.width/2) / newZoom;\r\n                this.camY = worldY - (my - this.height/2) / newZoom;\r\n                \r\n                this.pinchDist = dist;\r\n            }\r\n        }\r\n    }\r\n    \r\n    onTouchEnd(e) {\r\n        if (e.touches.length === 0) {\r\n            if (this.isDragging) {\r\n                 const dist = Math.sqrt(Math.pow(this.lastTouch.x - this.dragStart.x, 2) + Math.pow(this.lastTouch.y - this.dragStart.y, 2));\r\n                 if (dist < 10) {\r\n                     this.handleClick(this.lastTouch.x, this.lastTouch.y);\r\n                 }\r\n            }\r\n            this.isDragging = false;\r\n        } else if (e.touches.length === 1) {\r\n            this.isDragging = true;\r\n            this.lastTouch = { x: e.touches[0].clientX, y: e.touches[0].clientY };\r\n        }\r\n    }\r\n}\r\n", "import { registerTick } from './gameLoop.js';\r\nimport { getLevelNumber, performFreeAutobuy, getUpgradesForArea, AREA_KEYS } from './upgrades.js';\r\nimport { triggerPassiveCollect } from './coinPickup.js';\r\nimport { \r\n  AUTOMATION_AREA_KEY, \r\n  EFFECTIVE_AUTO_COLLECT_ID, \r\n  MASTER_AUTOBUY_IDS,\r\n  AUTOBUY_WORKSHOP_LEVELS_ID\r\n} from './automationUpgrades.js';\r\nimport { performFreeGenerationUpgrade } from '../ui/merchantTabs/workshopTab.js';\r\nimport { getActiveSlot } from '../util/storage.js';\r\nimport { isSurgeActive, getTsunamiNerf } from './surgeEffects.js';\r\n\r\nlet accumulator = 0;\r\nlet workshopTicker = 0;\r\n\r\nlet tsunamiBonusProvider = () => 0;\r\n\r\nexport function setTsunamiBonusProvider(fn) {\r\n  tsunamiBonusProvider = fn;\r\n}\r\n\r\nconst externalEacProviders = [];\r\n\r\nexport function addExternalEacMultiplierProvider(provider) {\r\n  if (typeof provider === 'function') {\r\n    externalEacProviders.push(provider);\r\n  }\r\n}\r\n\r\nconst externalEacAmountProviders = [];\r\n\r\nexport function addExternalEacAmountMultiplierProvider(provider) {\r\n  if (typeof provider === 'function') {\r\n    externalEacAmountProviders.push(provider);\r\n  }\r\n}\r\n\r\nexport function getEacAmountMultiplier() {\r\n  let mult = 1;\r\n  if (isSurgeActive(2)) {\r\n    if (isSurgeActive(8)) {\r\n        const nerf = getTsunamiNerf();\r\n        const bonus = tsunamiBonusProvider();\r\n        let effective = nerf + bonus;\r\n        if (effective > 1) effective = 1;\r\n        mult *= Math.pow(10, effective);\r\n    } else {\r\n        mult *= 10;\r\n    }\r\n  }\r\n  for (const provider of externalEacAmountProviders) {\r\n    try {\r\n      const val = provider();\r\n      if (Number.isFinite(val)) mult *= val;\r\n    } catch {}\r\n  }\r\n  return mult;\r\n}\r\n\r\n// Autobuyer Toggle Cache\r\n// Structure: Map<string, string> where key is the localStorage key and value is the setting ('0' or '1')\r\nconst autobuyerCache = new Map();\r\nlet cacheSlot = null;\r\n\r\nfunction ensureCacheSlot(slot) {\r\n  if (cacheSlot !== slot) {\r\n    autobuyerCache.clear();\r\n    cacheSlot = slot;\r\n  }\r\n}\r\n\r\n/**\r\n * Gets the autobuyer toggle state for a specific upgrade.\r\n * Caches the result to minimize localStorage reads.\r\n * Default is '1' (Active) if not set.\r\n */\r\nexport function getAutobuyerToggle(area, id) {\r\n  const slot = getActiveSlot();\r\n  ensureCacheSlot(slot);\r\n\r\n  const slotSuffix = slot != null ? `:${slot}` : '';\r\n  const key = `ccc:autobuy:${area}:${id}${slotSuffix}`;\r\n\r\n  if (autobuyerCache.has(key)) {\r\n    return autobuyerCache.get(key);\r\n  }\r\n\r\n  let val = '1'; // Default active\r\n  try {\r\n    const stored = localStorage.getItem(key);\r\n    if (stored !== null) val = stored;\r\n  } catch {}\r\n\r\n  autobuyerCache.set(key, val);\r\n  return val;\r\n}\r\n\r\n/**\r\n * Sets the autobuyer toggle state for a specific upgrade.\r\n * Updates both the cache and localStorage.\r\n */\r\nexport function setAutobuyerToggle(area, id, value) {\r\n  const slot = getActiveSlot();\r\n  ensureCacheSlot(slot);\r\n\r\n  const slotSuffix = slot != null ? `:${slot}` : '';\r\n  const key = `ccc:autobuy:${area}:${id}${slotSuffix}`;\r\n\r\n  const valStr = String(value);\r\n  autobuyerCache.set(key, valStr);\r\n  try {\r\n    localStorage.setItem(key, valStr);\r\n  } catch {}\r\n}\r\n\r\nfunction onTick(dt) {\r\n  updateAutomation(dt);\r\n  updateAutobuyers(dt);\r\n}\r\n\r\nlet _groupedUpgradesCache = null;\r\n\r\n/**\r\n * \u26A1 Bolt Optimization:\r\n * Cache upgrades grouped by cost type to avoid filtering the registry\r\n * and allocating a new array every tick.\r\n */\r\nfunction getGroupedUpgrades() {\r\n  if (_groupedUpgradesCache) return _groupedUpgradesCache;\r\n\r\n  const upgrades = [\r\n    ...getUpgradesForArea(AREA_KEYS.STARTER_COVE),\r\n    ...getUpgradesForArea(AREA_KEYS.DNA)\r\n  ];\r\n  const groups = {};\r\n\r\n  for (const upg of upgrades) {\r\n    const type = upg.costType;\r\n    if (!groups[type]) {\r\n      groups[type] = [];\r\n    }\r\n    groups[type].push(upg);\r\n  }\r\n\r\n  _groupedUpgradesCache = groups;\r\n  return _groupedUpgradesCache;\r\n}\r\n\r\nfunction processAutobuyGroup(upgrades) {\r\n  if (!upgrades || upgrades.length === 0) return;\r\n  for (const upg of upgrades) {\r\n    const area = upg.area || AREA_KEYS.STARTER_COVE;\r\n    const setting = getAutobuyerToggle(area, upg.id);\r\n    if (setting !== '0') {\r\n      const currentLevel = getLevelNumber(area, upg.id);\r\n      const cap = upg.lvlCap ?? Infinity;\r\n      if (currentLevel < cap) {\r\n        performFreeAutobuy(area, upg.id);\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nfunction updateAutobuyers(dt) {\r\n  const slot = getActiveSlot();\r\n  ensureCacheSlot(slot);\r\n\r\n  // Tick-sliced processing for standard upgrades\r\n  // Iterate over MASTER_AUTOBUY_IDS to dynamically handle cost types\r\n  const groups = getGroupedUpgrades();\r\n  for (const [idStr, currencyKey] of Object.entries(MASTER_AUTOBUY_IDS)) {\r\n    const id = Number(idStr);\r\n    // Check if this specific autobuyer is purchased/active\r\n    if (getLevelNumber(AUTOMATION_AREA_KEY, id) > 0) {\r\n      if (groups[currencyKey]) {\r\n        processAutobuyGroup(groups[currencyKey]);\r\n      }\r\n    }\r\n  }\r\n\r\n  // Process workshop levels (throttled to ~4Hz)\r\n  const workshopAutobuy = getLevelNumber(AUTOMATION_AREA_KEY, AUTOBUY_WORKSHOP_LEVELS_ID) > 0;\r\n  if (workshopAutobuy) {\r\n    workshopTicker++;\r\n    if (workshopTicker >= 5) {\r\n      workshopTicker = 0;\r\n      const setting = getAutobuyerToggle(AUTOMATION_AREA_KEY, AUTOBUY_WORKSHOP_LEVELS_ID);\r\n      if (setting !== '0') {\r\n        performFreeGenerationUpgrade();\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nexport function updateAutomation(dt) {\r\n  const level = getLevelNumber(AUTOMATION_AREA_KEY, EFFECTIVE_AUTO_COLLECT_ID);\r\n  let rate = level; // Rate = level (coins/sec)\r\n\r\n  for (const provider of externalEacProviders) {\r\n    try {\r\n      const val = provider();\r\n      if (Number.isFinite(val)) rate *= val;\r\n    } catch {}\r\n  }\r\n\r\n  if (rate <= 0) {\r\n    accumulator = 0;\r\n    return;\r\n  }\r\n\r\n  accumulator += dt;\r\n  const interval = 1 / rate;\r\n\r\n  if (accumulator >= interval) {\r\n    const ticks = Math.floor(accumulator / interval);\r\n    if (ticks > 0) {\r\n      let collectCount = ticks;\r\n      collectCount *= getEacAmountMultiplier();\r\n      triggerPassiveCollect(collectCount);\r\n      accumulator -= ticks * interval;\r\n    }\r\n  }\r\n}\r\n\r\nexport function initAutomationEffects() {\r\n  registerTick(onTick);\r\n  \r\n  // Listen for save slot changes to clear cache\r\n  if (typeof window !== 'undefined') {\r\n    window.addEventListener('saveSlot:change', (e) => {\r\n        const newSlot = e.detail?.slot;\r\n        if (newSlot && newSlot !== cacheSlot) {\r\n            autobuyerCache.clear();\r\n            cacheSlot = newSlot;\r\n        }\r\n    });\r\n  }\r\n}\r\n", "import { BigNum, approxLog10BigNum, bigNumFromLog10 } from '../util/bigNum.js';\r\nimport { getActiveSlot, isStorageKeyLocked } from '../util/storage.js';\r\nimport { getLabLevel, setLabLevel, getRpMult } from '../ui/merchantTabs/labTab.js';\r\nimport { formatMultForUi } from '../util/numFormat.js';\r\nimport { \r\n    addExternalCoinMultiplierProvider, \r\n    addExternalXpGainMultiplierProvider,\r\n    refreshCoinMultiplierFromXpLevel\r\n} from './xpSystem.js';\r\nimport { addExternalSpawnRateMultiplierProvider, triggerUpgradesChanged } from './upgradeEffects.js';\r\nimport { addExternalEacMultiplierProvider, addExternalEacAmountMultiplierProvider, setTsunamiBonusProvider } from './automationEffects.js';\r\n\r\n// --- Storage Keys ---\r\nexport const NODE_LEVEL_KEY = (slot, id) => `ccc:lab:node:level:${id}:${slot}`;\r\nexport const NODE_RP_KEY = (slot, id) => `ccc:lab:node:rp:${id}:${slot}`;\r\nconst NODE_ACTIVE_KEY = (slot, id) => `ccc:lab:node:active:${id}:${slot}`;\r\nconst NODE_DISCOVERED_KEY = (slot, id) => `ccc:lab:node:discovered:${id}:${slot}`;\r\nconst EXPERIMENT_COMPLETED_KEY = (slot) => `ccc:reset:experiment:completed:${slot}`;\r\n\r\n// --- Constants ---\r\nexport const RESEARCH_NODES = [\r\n    {\r\n        id: 1,\r\n        title: \"Node 1: Tsunami Exponent Buff\",\r\n        desc: \"Increases the Tsunami Exponent by +0.01 per level\",\r\n        baseRpReq: 10,\r\n        scale: 2.0,\r\n        maxLevel: 10,\r\n        x: 0,\r\n        y: 0,\r\n        icon: 'lab_icons/tsunami_exponent_buff.webp',\r\n        parentIds: [],\r\n        bonusLine: (level) => `Tsunami Exponent bonus: +${(level * 0.01).toFixed(2)}`\r\n    },\r\n    {\r\n        id: 2,\r\n        title: \"Node 2: Experimental Coin Value\",\r\n        desc: \"Multiplies Coin value by 2x per level\",\r\n        baseRpReq: 1000,\r\n        scale: 2.0,\r\n        maxLevel: 10,\r\n        parentIds: [1],\r\n        x: -1000,\r\n        y: 1000,\r\n        icon: 'lab_icons/coin_val0.webp',\r\n        bonusLine: (level) => `Coin value bonus: ${formatMultForUi(getLabCoinMultiplier())}x`\r\n    },\r\n    {\r\n        id: 3,\r\n        title: \"Node 3: Experimental XP Value\",\r\n        desc: \"Multiplies XP value by 2x per level\",\r\n        baseRpReq: 1000,\r\n        scale: 2.0,\r\n        maxLevel: 10,\r\n        parentIds: [1],\r\n        x: 1000,\r\n        y: 1000,\r\n        icon: 'sc_upg_icons/xp_val1.webp',\r\n        bonusLine: (level) => `XP value bonus: ${formatMultForUi(getLabXpMultiplier())}x`\r\n    },\r\n    {\r\n        id: 4,\r\n        title: \"Node 4: Unlock Experiment\",\r\n        desc: \"Unlocks the Experiment reset\",\r\n        baseRpReq: 1e6,\r\n        scale: 1.0,\r\n        maxLevel: 1,\r\n        x: 0,\r\n        y: -1000,\r\n        icon: 'misc/experiment.webp',\r\n        parentIds: [2, 3],\r\n        bonusLine: () => ''\r\n    },\r\n    {\r\n        id: 5,\r\n        title: \"Node 5: Experimental Gold Value\",\r\n        desc: \"Multiplies Gold value by 3x per level\",\r\n        baseRpReq: 1e6,\r\n        scale: 2.0,\r\n        maxLevel: 10,\r\n        x: -1000,\r\n        y: -1000,\r\n        icon: 'lab_icons/gold_val0.webp',\r\n        parentIds: [4],\r\n        bonusLine: (level) => `Gold value bonus: ${formatMultForUi(getLabGoldMultiplier())}x`\r\n    },\r\n    {\r\n        id: 6,\r\n        title: \"Node 6: Experimental Magic Value\",\r\n        desc: \"Multiplies Magic value by 3x per level\",\r\n        baseRpReq: 1e6,\r\n        scale: 2.0,\r\n        maxLevel: 10,\r\n        x: 1000,\r\n        y: -1000,\r\n        icon: 'lab_icons/magic_val0.webp',\r\n        parentIds: [4],\r\n        bonusLine: (level) => `Magic value bonus: ${formatMultForUi(getLabMagicMultiplier())}x`\r\n    },\r\n    {\r\n        id: 7,\r\n        title: \"Node 7: Experimental Wave Value\",\r\n        desc: \"Multiplies Wave value by 1.1x per level\",\r\n        baseRpReq: 1e8,\r\n        scale: 2.0,\r\n        maxLevel: 10,\r\n        x: 0,\r\n        y: 1000,\r\n        icon: 'lab_icons/wave_val0.webp',\r\n        parentIds: [5, 6],\r\n        bonusLine: (level) => `Wave value bonus: ${formatMultForUi(getLabWaveMultiplier())}x`\r\n    },\r\n    {\r\n        id: 8,\r\n        title: \"Node 8: Experimental Spawn Rate\",\r\n        desc: \"Increases Coin Spawn Rate by +10% per level\",\r\n        baseRpReq: 1e10,\r\n        scale: 2.0,\r\n        maxLevel: 10,\r\n        x: -1000,\r\n        y: 0,\r\n        icon: 'sc_upg_icons/faster_coins1.webp',\r\n        parentIds: [7],\r\n        bonusLine: (level) => `Coin Spawn Rate bonus: ${formatMultForUi(getLabSpawnRateBonus())}x`\r\n    },\r\n    {\r\n        id: 9,\r\n        title: \"Node 9: Experimental EAC Value\",\r\n        desc: \"Increases Effective Auto-Collect value by +10% per level\",\r\n        baseRpReq: 1e10,\r\n        scale: 2.0,\r\n        maxLevel: 10,\r\n        x: 1000,\r\n        y: 0,\r\n        icon: 'sc_upg_icons/effective_auto_collect.webp',\r\n        parentIds: [7],\r\n        bonusLine: (level) => `EAC value bonus: ${formatMultForUi(getLabEacBonus())}x`\r\n    },\r\n    {\r\n        id: 10,\r\n        title: \"Node 10: Tsunami Exponent Buff II\",\r\n        desc: \"Increases the Tsunami Exponent by +0.01 per level\\nThis node scales <strong>10x</strong> RP each level\",\r\n        baseRpReq: 1e13,\r\n        scale: 10.0,\r\n        maxLevel: 10,\r\n        x: 0,\r\n        y: -2000,\r\n        icon: 'lab_icons/tsunami_exponent_buff.webp',\r\n        parentIds: [8, 9],\r\n        bonusLine: (level) => `Tsunami Exponent bonus: +${(level * 0.01).toFixed(2)}`\r\n    }\r\n];\r\n\r\nexport const NODE_MAP = new Map(RESEARCH_NODES.map(n => [n.id, n]));\r\n\r\n// --- State Cache ---\r\nlet _cachedExperimentCompleted = null;\r\nlet _cachedSlot = null;\r\nconst labState = {\r\n    nodes: {}\r\n};\r\nlet activeNodeId = null;\r\n\r\nfunction reloadExperimentCache() {\r\n    const slot = getActiveSlot();\r\n    _cachedSlot = slot;\r\n    if (slot == null) {\r\n        _cachedExperimentCompleted = false;\r\n        return;\r\n    }\r\n    try {\r\n        _cachedExperimentCompleted = localStorage.getItem(EXPERIMENT_COMPLETED_KEY(slot)) === '1';\r\n    } catch {\r\n        _cachedExperimentCompleted = false;\r\n    }\r\n}\r\n\r\nfunction ensureNodeState(id) {\r\n    if (!labState.nodes[id]) {\r\n        labState.nodes[id] = {\r\n            rp: BigNum.fromInt(0),\r\n            level: 0,\r\n            active: false,\r\n            discovered: false\r\n        };\r\n    }\r\n    return labState.nodes[id];\r\n}\r\n\r\nfunction loadNodeState(slot, id) {\r\n    const s = ensureNodeState(id);\r\n    try {\r\n        const lvl = localStorage.getItem(NODE_LEVEL_KEY(slot, id));\r\n        s.level = lvl ? parseInt(lvl, 10) : 0;\r\n        \r\n        const rp = localStorage.getItem(NODE_RP_KEY(slot, id));\r\n        s.rp = rp ? BigNum.fromAny(rp) : BigNum.fromInt(0);\r\n        \r\n        const act = localStorage.getItem(NODE_ACTIVE_KEY(slot, id));\r\n        s.active = act === '1';\r\n\r\n        const disc = localStorage.getItem(NODE_DISCOVERED_KEY(slot, id));\r\n        s.discovered = disc === '1';\r\n    } catch {\r\n        s.level = 0;\r\n        s.rp = BigNum.fromInt(0);\r\n        s.active = false;\r\n        s.discovered = false;\r\n    }\r\n}\r\n\r\nexport function reloadLabNodes() {\r\n    reloadExperimentCache(); // Reload experiment status\r\n    const slot = getActiveSlot();\r\n    labState.nodes = {}; // Clear cache\r\n    activeNodeId = null;\r\n    if (slot != null) {\r\n        RESEARCH_NODES.forEach(n => {\r\n            loadNodeState(slot, n.id);\r\n            if (labState.nodes[n.id].active) {\r\n                activeNodeId = n.id;\r\n            }\r\n        });\r\n    }\r\n}\r\n\r\nfunction saveLabNodes() {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) return;\r\n    \r\n    RESEARCH_NODES.forEach(n => {\r\n        const s = labState.nodes[n.id];\r\n        if (s) {\r\n            try {\r\n                // Save RP (High Frequency)\r\n                localStorage.setItem(NODE_RP_KEY(slot, n.id), s.rp.toStorage());\r\n                // Level and Active are saved immediately on change, so no need to save here\r\n                // unless we want double safety.\r\n            } catch {}\r\n        }\r\n    });\r\n}\r\n\r\n// Initialize\r\nif (typeof window !== 'undefined') {\r\n    window.addEventListener('saveSlot:change', reloadLabNodes);\r\n    // Auto-save every second\r\n    setInterval(saveLabNodes, 1000);\r\n    // Save on unload\r\n    window.addEventListener('beforeunload', saveLabNodes);\r\n\r\n    // Listen for experiment unlock\r\n    window.addEventListener('unlock:change', ({ detail }) => {\r\n        if (detail && detail.key === 'experiment_completed') {\r\n            reloadExperimentCache();\r\n        }\r\n    });\r\n    \r\n    // Initial load\r\n    reloadLabNodes();\r\n}\r\n\r\n// --- Getters / Setters ---\r\n\r\nexport function getResearchNodeLevel(id) {\r\n    const s = ensureNodeState(id);\r\n    return s.level;\r\n}\r\n\r\nexport function setResearchNodeLevel(id, level) {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) return false;\r\n    \r\n    if (isStorageKeyLocked(NODE_LEVEL_KEY(slot, id))) return false;\r\n\r\n    const s = ensureNodeState(id);\r\n    if (s.level === level) return true;\r\n    s.level = level;\r\n    \r\n    try {\r\n        localStorage.setItem(NODE_LEVEL_KEY(slot, id), level.toString());\r\n        window.dispatchEvent(new CustomEvent('lab:node:change', { detail: { id, level } }));\r\n    } catch {}\r\n    return true;\r\n}\r\n\r\nexport function getResearchNodeRp(id) {\r\n    const s = ensureNodeState(id);\r\n    return s.rp;\r\n}\r\n\r\nexport function setResearchNodeRp(id, rp) {\r\n    const slot = getActiveSlot();\r\n    if (slot != null && isStorageKeyLocked(NODE_RP_KEY(slot, id))) return;\r\n\r\n    // In-memory update only. Persisted via saveLabNodes.\r\n    const s = ensureNodeState(id);\r\n    s.rp = BigNum.fromAny(rp);\r\n    \r\n    try {\r\n        window.dispatchEvent(new CustomEvent('lab:node:rp', { detail: { id, rp: s.rp } }));\r\n    } catch {}\r\n}\r\n\r\nexport function isResearchNodeActive(id) {\r\n    const s = ensureNodeState(id);\r\n    return s.active;\r\n}\r\n\r\nexport function setResearchNodeActive(id, active) {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) return;\r\n    \r\n    const shouldBeActive = !!active;\r\n\r\n    if (shouldBeActive) {\r\n        // Deactivate currently active node if it's different\r\n        if (activeNodeId !== null && activeNodeId !== id) {\r\n             setResearchNodeActive(activeNodeId, false);\r\n        }\r\n        activeNodeId = id;\r\n    } else {\r\n        if (activeNodeId === id) {\r\n            activeNodeId = null;\r\n        }\r\n    }\r\n\r\n    const s = ensureNodeState(id);\r\n    // Only update if state actually changes to avoid redundant events/storage writes\r\n    if (s.active !== shouldBeActive) {\r\n        s.active = shouldBeActive;\r\n        try {\r\n            localStorage.setItem(NODE_ACTIVE_KEY(slot, id), s.active ? '1' : '0');\r\n            window.dispatchEvent(new CustomEvent('lab:node:active', { detail: { id, active: s.active } }));\r\n        } catch {}\r\n    }\r\n}\r\n\r\nexport function setResearchNodeDiscovered(id, discovered) {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) return;\r\n    \r\n    const s = ensureNodeState(id);\r\n    if (s.discovered === !!discovered) return;\r\n    \r\n    s.discovered = !!discovered;\r\n    try {\r\n        localStorage.setItem(NODE_DISCOVERED_KEY(slot, id), s.discovered ? '1' : '0');\r\n    } catch {}\r\n}\r\n\r\n// --- Logic ---\r\n\r\nexport function isResearchNodeVisible(id) {\r\n    const node = NODE_MAP.get(id);\r\n    if (!node) return false;\r\n    \r\n    // Check persistent discovery state\r\n    const s = ensureNodeState(id);\r\n    if (s.discovered) return true;\r\n    \r\n    // Root nodes always visible\r\n    if (!node.parentIds || node.parentIds.length === 0) {\r\n        setResearchNodeDiscovered(id, true);\r\n        return true;\r\n    }\r\n\r\n    // Node 5 & 6 require Experiment Reset to be completed\r\n    if (id === 5 || id === 6) {\r\n        // Use cached value\r\n        if (_cachedSlot !== getActiveSlot() || _cachedExperimentCompleted === null) {\r\n             reloadExperimentCache();\r\n        }\r\n        if (!_cachedExperimentCompleted) return false;\r\n    }\r\n    \r\n    // Visible if ALL parents are maxed\r\n    for (const parentId of node.parentIds) {\r\n        const parent = NODE_MAP.get(parentId);\r\n        if (!parent) continue; \r\n        \r\n        const parentLevel = getResearchNodeLevel(parentId);\r\n        if (parentLevel < parent.maxLevel) {\r\n            return false;\r\n        }\r\n    }\r\n    \r\n    setResearchNodeDiscovered(id, true);\r\n    return true;\r\n}\r\n\r\nexport function getResearchNodeRequirement(id) {\r\n    const node = NODE_MAP.get(id);\r\n    if (!node) return BigNum.fromAny('Infinity');\r\n    \r\n    const level = getResearchNodeLevel(id);\r\n    if (level >= node.maxLevel) return BigNum.fromAny('Infinity');\r\n    \r\n    // Cost = Base * (Scale ^ Level)\r\n    const scaleBn = BigNum.fromAny(node.scale);\r\n    const log10Scale = approxLog10BigNum(scaleBn); \r\n    \r\n    const baseBn = BigNum.fromAny(node.baseRpReq);\r\n    const log10Base = approxLog10BigNum(baseBn);\r\n    \r\n    const totalLog10 = log10Base + (level * log10Scale);\r\n    \r\n    return bigNumFromLog10(totalLog10);\r\n}\r\n\r\nexport function getTsunamiResearchBonus() {\r\n    let bonus = 0;\r\n    const level1 = getResearchNodeLevel(1);\r\n    if (level1 > 0) bonus += level1 * 0.01;\r\n    \r\n    const level10 = getResearchNodeLevel(10);\r\n    if (level10 > 0) bonus += level10 * 0.01;\r\n    \r\n    return bonus;\r\n}\r\n\r\nexport function isExperimentUnlocked() {\r\n    return getResearchNodeLevel(4) >= 1;\r\n}\r\n\r\nexport function resetLab(exceptions = []) {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) return;\r\n    \r\n    // Reset Lab Level\r\n    try {\r\n        setLabLevel(0);\r\n    } catch {}\r\n\r\n    // Deactivate current active node\r\n    if (activeNodeId !== null) {\r\n        setResearchNodeActive(activeNodeId, false);\r\n    }\r\n\r\n    // Reset Nodes\r\n    RESEARCH_NODES.forEach(node => {\r\n        if (exceptions.includes(node.id)) return;\r\n        \r\n        setResearchNodeLevel(node.id, 0);\r\n        setResearchNodeRp(node.id, BigNum.fromInt(0));\r\n    });\r\n}\r\n\r\nexport function tickResearch(dt) {\r\n    const mult = getRpMult();\r\n    if (mult.isZero?.()) return;\r\n\r\n    if (activeNodeId === null) return;\r\n\r\n    const node = NODE_MAP.get(activeNodeId);\r\n    if (!node) return;\r\n    \r\n    if (!isResearchNodeVisible(node.id)) return;\r\n\r\n    // RP per second = 1 * Multiplier\r\n    const rpPerSec = mult; \r\n    const rpPerTick = rpPerSec.mulDecimal(dt.toString(), 18);\r\n    \r\n    const currentRp = getResearchNodeRp(node.id);\r\n    \r\n    if (getResearchNodeLevel(node.id) >= node.maxLevel) return;\r\n    \r\n    let nextRp = currentRp.add(rpPerTick);\r\n\r\n    // Optimized bulk leveling for large jumps\r\n    const currentLevel = getResearchNodeLevel(node.id);\r\n    if (currentLevel < node.maxLevel || !Number.isFinite(node.maxLevel)) {\r\n        const currentReq = getResearchNodeRequirement(node.id);\r\n        const logRp = approxLog10BigNum(nextRp);\r\n        const logReq = approxLog10BigNum(currentReq);\r\n\r\n        if (logRp - logReq > 2) {\r\n            let jump = 0n;\r\n            let cost = BigNum.zero();\r\n            \r\n            const scaleBn = BigNum.fromAny(node.scale);\r\n            const scaleMinus1 = scaleBn.sub(1);\r\n            let isLinear = false;\r\n            \r\n            // Check if scale is effectively 1\r\n            if (scaleMinus1.isZero()) isLinear = true;\r\n            else {\r\n                // Check if close to 1 (handling potential floating point weirdness if scale is Number)\r\n                const absDiff = Math.abs(Number(scaleBn.toScientific()) - 1.0);\r\n                if (absDiff < 1e-9) isLinear = true;\r\n            }\r\n\r\n            if (isLinear) {\r\n                // Linear scaling (Scale \u2248 1)\r\n                const jumpBn = nextRp.div(currentReq).floorToInteger();\r\n                let jumpStr = jumpBn.toPlainIntegerString();\r\n                // Safety clamp to max safe integer\r\n                if (jumpStr === 'Infinity' || jumpStr.length > 15) {\r\n                    jumpStr = \"9007199254740991\"; \r\n                }\r\n                try {\r\n                    jump = BigInt(jumpStr);\r\n                } catch {\r\n                    jump = 0n;\r\n                }\r\n                \r\n                if (Number.isFinite(node.maxLevel)) {\r\n                    const rem = BigInt(node.maxLevel) - BigInt(currentLevel);\r\n                    if (jump > rem) jump = rem;\r\n                }\r\n                \r\n                if (jump > 0n) {\r\n                    cost = currentReq.mulScaledInt(jump, 0);\r\n                }\r\n            } else if (scaleMinus1.isZero() === false && (scaleMinus1.sig > 0n || scaleMinus1.isInfinite())) {\r\n                 // Geometric scaling (Scale > 1)\r\n                 const logS = approxLog10BigNum(scaleBn);\r\n                 const logSMinus1 = approxLog10BigNum(scaleMinus1);\r\n                 \r\n                 // (logRp - logReq + log(S-1)) / log(S)\r\n                 const numerator = (logRp - logReq) + logSMinus1;\r\n                 const approxLevels = Math.floor(numerator / logS);\r\n\r\n                 if (approxLevels > 5) {\r\n                     let safeJump = BigInt(Math.max(0, approxLevels - 5));\r\n                     if (Number.isFinite(node.maxLevel)) {\r\n                         const rem = BigInt(node.maxLevel) - BigInt(currentLevel);\r\n                         if (safeJump > rem) safeJump = rem;\r\n                     }\r\n                     \r\n                     if (safeJump > 0n) {\r\n                         jump = safeJump;\r\n                         \r\n                         // Cost = currentReq * ((S^jump - 1) / (S-1))\r\n                         const totalLog = Number(jump) * logS;\r\n                         const sPowJump = bigNumFromLog10(totalLog);\r\n                         \r\n                         const costFactor = sPowJump.sub(1).div(scaleMinus1);\r\n                         cost = currentReq.mulBigNumInteger(costFactor);\r\n                     }\r\n                 }\r\n            }\r\n\r\n            if (jump > 0n) {\r\n                nextRp = nextRp.sub(cost);\r\n                const newLevel = currentLevel + Number(jump);\r\n                setResearchNodeLevel(node.id, newLevel);\r\n            }\r\n        }\r\n    }\r\n    \r\n    while (true) {\r\n        const currentReq = getResearchNodeRequirement(node.id);\r\n        if (nextRp.cmp(currentReq) < 0) break;\r\n        \r\n        if (getResearchNodeLevel(node.id) >= node.maxLevel) break;\r\n\r\n        nextRp = nextRp.sub(currentReq);\r\n        const oldLevel = getResearchNodeLevel(node.id);\r\n        const nextLevel = oldLevel + 1;\r\n        \r\n        // Safety check for precision loss at extremely high levels (> 9e15)\r\n        if (nextLevel <= oldLevel) break;\r\n\r\n        if (!setResearchNodeLevel(node.id, nextLevel)) break;\r\n    }\r\n    \r\n    setResearchNodeRp(node.id, nextRp);\r\n}\r\n\r\n// --- Multipliers ---\r\n\r\nconst LOG10_2 = Math.log10(2);\r\nconst LOG10_3 = Math.log10(3);\r\nconst LOG10_1_1 = Math.log10(1.1);\r\n\r\nexport function getLabCoinMultiplier() {\r\n    const node = NODE_MAP.get(2);\r\n    if (!node) return BigNum.fromInt(1);\r\n    const level = getResearchNodeLevel(node.id);\r\n    if (level <= 0) return BigNum.fromInt(1);\r\n    \r\n    return bigNumFromLog10(level * LOG10_2);\r\n}\r\n\r\nexport function getLabXpMultiplier() {\r\n    const node = NODE_MAP.get(3);\r\n    if (!node) return BigNum.fromInt(1);\r\n    const level = getResearchNodeLevel(node.id);\r\n    if (level <= 0) return BigNum.fromInt(1);\r\n    \r\n    return bigNumFromLog10(level * LOG10_2);\r\n}\r\n\r\nexport function getLabGoldMultiplier() {\r\n    const node = NODE_MAP.get(5);\r\n    if (!node) return BigNum.fromInt(1);\r\n    const level = getResearchNodeLevel(node.id);\r\n    if (level <= 0) return BigNum.fromInt(1);\r\n    \r\n    return bigNumFromLog10(level * LOG10_3);\r\n}\r\n\r\nexport function getLabMagicMultiplier() {\r\n    const node = NODE_MAP.get(6);\r\n    if (!node) return BigNum.fromInt(1);\r\n    const level = getResearchNodeLevel(node.id);\r\n    if (level <= 0) return BigNum.fromInt(1);\r\n    \r\n    return bigNumFromLog10(level * LOG10_3);\r\n}\r\n\r\nexport function getLabWaveMultiplier() {\r\n    const node = NODE_MAP.get(7);\r\n    if (!node) return BigNum.fromInt(1);\r\n    const level = getResearchNodeLevel(node.id);\r\n    if (level <= 0) return BigNum.fromInt(1);\r\n    \r\n    return bigNumFromLog10(level * LOG10_1_1);\r\n}\r\n\r\nexport function getLabSpawnRateBonus() {\r\n    const node = NODE_MAP.get(8);\r\n    if (!node) return 1;\r\n    const level = getResearchNodeLevel(node.id);\r\n    return 1 + (level * 0.1);\r\n}\r\n\r\nexport function getLabEacBonus() {\r\n    const node = NODE_MAP.get(9);\r\n    if (!node) return 1;\r\n    const level = getResearchNodeLevel(node.id);\r\n    return 1 + (level * 0.1);\r\n}\r\n\r\nexport function initLabMultipliers() {\r\n    addExternalCoinMultiplierProvider(({ baseMultiplier }) => {\r\n        const labMult = getLabCoinMultiplier();\r\n        return baseMultiplier.mulDecimal(labMult.toScientific());\r\n    });\r\n    \r\n    addExternalXpGainMultiplierProvider(({ baseGain }) => {\r\n        const labMult = getLabXpMultiplier();\r\n        return baseGain.mulDecimal(labMult.toScientific());\r\n    });\r\n\r\n    addExternalSpawnRateMultiplierProvider(() => getLabSpawnRateBonus());\r\n    addExternalEacAmountMultiplierProvider(() => getLabEacBonus());\r\n    \r\n    setTsunamiBonusProvider(() => getTsunamiResearchBonus());\r\n\r\n    if (typeof window !== 'undefined') {\r\n        window.addEventListener('lab:node:change', ({ detail }) => {\r\n            if (detail && detail.id === 2) {\r\n                refreshCoinMultiplierFromXpLevel();\r\n            }\r\n            if (detail && detail.id === 8) {\r\n                triggerUpgradesChanged();\r\n            }\r\n        });\r\n    }\r\n}\r\nwindow.RESEARCH_NODES = RESEARCH_NODES; window.isResearchNodeVisible = isResearchNodeVisible;\r\n", "import { getActiveSlot } from '../util/storage.js';\r\n\r\n// Configuration\r\nconst DECAY_WINDOW_SEC = 60;\r\n\r\n// State\r\nconst COMBO_INCREMENT_AMOUNT = 0.001;\r\nlet activeComboValue = 0; // The accumulated combo value\r\nlet decayCounter = 0; // Integer seconds since last coin collection\r\nlet decayAccumulator = 0; // Float accumulator for partial seconds\r\nlet isSurge14ActiveFn = () => false;\r\nlet getMaxComboFn = () => 1.0; // Default max combo if not provided\r\n\r\n// New: Rate limiting for growth\r\nlet lastGrowthTime = 0;\r\n\r\nfunction resetState() {\r\n    activeComboValue = 0;\r\n    decayCounter = 0;\r\n    decayAccumulator = 0;\r\n    lastGrowthTime = 0;\r\n}\r\n\r\nexport function onCoinCollected() {\r\n    if (!isSurge14ActiveFn()) return;\r\n    \r\n    const now = performance.now();\r\n    \r\n    // Reset decay timer on collection\r\n    decayCounter = 0;\r\n    decayAccumulator = 0;\r\n    \r\n    // Enforce 1 second rate limit for growth\r\n    if (now - lastGrowthTime >= 1000) {\r\n        const maxVal = getMaxComboFn();\r\n        \r\n        // Ensure we are within bounds before adding\r\n        if (activeComboValue < maxVal) {\r\n            activeComboValue += COMBO_INCREMENT_AMOUNT;\r\n            // Clamp\r\n            if (activeComboValue > maxVal) {\r\n                activeComboValue = maxVal;\r\n            }\r\n        } else if (activeComboValue > maxVal) {\r\n            // If cap dropped below current value\r\n            activeComboValue = maxVal;\r\n        }\r\n\r\n        lastGrowthTime = now;\r\n    }\r\n}\r\n\r\nexport function updateCombo(dt) {\r\n    if (!isSurge14ActiveFn()) return;\r\n\r\n    // Continuous cap check\r\n    const maxVal = getMaxComboFn();\r\n    if (activeComboValue > maxVal) {\r\n        activeComboValue = maxVal;\r\n    }\r\n    \r\n    // 1. Process Decay\r\n    // \"change the decay to happen every second, not every game tick\"\r\n    if (decayCounter < DECAY_WINDOW_SEC) {\r\n        decayAccumulator += dt;\r\n        while (decayAccumulator >= 1.0) {\r\n            decayAccumulator -= 1.0;\r\n            // Only increment if we haven't hit the cap\r\n            if (decayCounter < DECAY_WINDOW_SEC) {\r\n                decayCounter += 1;\r\n                // If we hit the cap (fully decayed), reset value\r\n                if (decayCounter >= DECAY_WINDOW_SEC) {\r\n                    activeComboValue = 0;\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n// Returns the absolute value to add to the nerf exponent\r\nexport function getComboRestorationFactor() {\r\n    if (!isSurge14ActiveFn()) return 0;\r\n    \r\n    // 1. Get Base Value\r\n    let val = activeComboValue;\r\n    \r\n    // 2. Apply Decay Penalty (Linear over 60s)\r\n    let decayFactor = 0;\r\n    if (decayCounter < DECAY_WINDOW_SEC) {\r\n        decayFactor = Math.max(0, 1 - (decayCounter / DECAY_WINDOW_SEC));\r\n    }\r\n    \r\n    return val * decayFactor;\r\n}\r\n\r\nexport function initComboSystem(checkFn, maxComboFn) {\r\n    if (typeof checkFn === 'function') {\r\n        isSurge14ActiveFn = checkFn;\r\n    }\r\n    if (typeof maxComboFn === 'function') {\r\n        getMaxComboFn = maxComboFn;\r\n    }\r\n\r\n    if (typeof window !== 'undefined') {\r\n        window.addEventListener('saveSlot:change', resetState);\r\n        \r\n        resetState();\r\n    }\r\n}\r\n", "import { BigNum } from '../util/bigNum.js';\r\nimport { bank, getActiveSlot, isStorageKeyLocked } from '../util/storage.js';\r\nimport { \r\n  addExternalCoinMultiplierProvider, \r\n  addExternalXpGainMultiplierProvider,\r\n  getXpState,\r\n  setExternalBookRewardProvider,\r\n  refreshCoinMultiplierFromXpLevel\r\n} from './xpSystem.js';\r\nimport { syncCurrencyMultipliersFromUpgrades } from './upgradeEffects.js';\r\nimport { addExternalMutationGainMultiplierProvider, getTotalCumulativeMp } from './mutationSystem.js';\r\nimport { getCurrentSurgeLevel, computeForgeGoldFromInputs, computeInfuseMagicFromInputs } from '../ui/merchantTabs/resetTab.js';\r\nimport { registerTick, RateAccumulator } from './gameLoop.js';\r\nimport { bigNumFromLog10, approxLog10BigNum } from '../util/bigNum.js';\r\nimport { getTsunamiResearchBonus, getLabGoldMultiplier } from './labNodes.js';\r\nimport { getComboRestorationFactor, updateCombo, initComboSystem } from './comboSystem.js';\r\nimport { formatMultForUi } from '../util/numFormat.js';\r\n\r\nconst BN = BigNum;\r\nconst MULTIPLIER = 10;\r\nconst LOG10_EXP_0_2 = 0.08685889638; // log10(e^0.2)\r\nconst TSUNAMI_NERF_KEY = (slot) => `ccc:surge:tsunamiNerf:${slot}`;\r\nconst TSUNAMI_SEEN_KEY = (slot) => `ccc:unlock:tsunami:${slot}`;\r\n\r\nexport function getTsunamiNerfKey(slot) {\r\n  return TSUNAMI_NERF_KEY(slot);\r\n}\r\n\r\nexport function getTsunamiSequenceSeen() {\r\n  const slot = getActiveSlot();\r\n  if (slot == null) return false;\r\n  try {\r\n    return localStorage.getItem(TSUNAMI_SEEN_KEY(slot)) === '1';\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\nexport function setTsunamiSequenceSeen(value) {\r\n  const slot = getActiveSlot();\r\n  if (slot == null) return;\r\n  const normalized = !!value;\r\n  try {\r\n    localStorage.setItem(TSUNAMI_SEEN_KEY(slot), normalized ? '1' : '0');\r\n    if (typeof window !== 'undefined') {\r\n        window.dispatchEvent(new CustomEvent('unlock:change', { detail: { key: 'tsunami', slot } }));\r\n    }\r\n  } catch {}\r\n}\r\n\r\nlet currentMultiplier = BigNum.fromInt(1);\r\nlet cachedSurgeLevel = 0n;\r\nlet bookRateAccumulator = null;\r\nlet tsunamiNerfExponent = 0.00;\r\n\r\nexport function getTsunamiNerf() {\r\n  return tsunamiNerfExponent;\r\n}\r\n\r\nexport function getEffectiveTsunamiNerf() {\r\n  const nerf = getTsunamiNerf();\r\n  let effective = nerf + getTsunamiResearchBonus();\r\n  if (effective > 1) effective = 1;\r\n\r\n  return effective;\r\n}\r\n\r\nexport function getEffectiveTsunamiNerfWithCombo() {\r\n  let effective = getEffectiveTsunamiNerf();\r\n\r\n  if (isSurgeActive(14)) {\r\n      const added = getComboRestorationFactor();\r\n      effective += added;\r\n      if (effective > 1) effective = 1;\r\n  }\r\n  \r\n  return effective;\r\n}\r\n\r\nexport function getComboUiString() {\r\n    if (!isSurgeActive(14)) return '';\r\n    \r\n    const added = getComboRestorationFactor();\r\n    \r\n    // Show if combo is active (non-zero factor), even if added value is very small\r\n    if (added <= 0) return '';\r\n    \r\n    let str = formatMultForUi(added);\r\n    if (str === '0') str = '0.000';\r\n    \r\n    let finalStr = ` (+^${str})`;\r\n    \r\n    const nerf = getTsunamiNerf();\r\n    let baseEffective = nerf + getTsunamiResearchBonus();\r\n    if (baseEffective > 1) baseEffective = 1;\r\n    const gap = 1.0 - baseEffective;\r\n    \r\n    if (added >= gap - 0.000001 && gap > 0) {\r\n        finalStr = `<span style=\"color: #02e815\">${finalStr}</span>`;\r\n    }\r\n    \r\n    return finalStr;\r\n}\r\n\r\nexport function setTsunamiNerf(value) {\r\n  let val = Number(value);\r\n  if (Number.isNaN(val)) val = 0;\r\n  \r\n  // Treat Infinity or > 1 as 1.00 (nerf restored)\r\n  if (!Number.isFinite(val) || val > 1) {\r\n    val = 1;\r\n  }\r\n  if (val < 0) val = 0;\r\n  \r\n  const slot = getActiveSlot();\r\n  if (slot != null) {\r\n      const key = TSUNAMI_NERF_KEY(slot);\r\n      if (isStorageKeyLocked(key)) return;\r\n      \r\n      try {\r\n        localStorage.setItem(key, val.toFixed(2));\r\n      } catch {}\r\n  }\r\n  \r\n  tsunamiNerfExponent = val;\r\n  \r\n  updateMultiplier();\r\n  try { window.dispatchEvent(new CustomEvent('surge:nerf:change', { detail: { value: val } })); } catch {}\r\n}\r\n\r\nexport function isSurgeActive(n) {\r\n  if (cachedSurgeLevel === Infinity || (typeof cachedSurgeLevel === 'string' && cachedSurgeLevel === 'Infinity')) return true;\r\n  if (cachedSurgeLevel === Number.POSITIVE_INFINITY) return true;\r\n\r\n  if (typeof cachedSurgeLevel === 'bigint') {\r\n    return cachedSurgeLevel >= BigInt(n);\r\n  }\r\n  if (typeof cachedSurgeLevel === 'number') {\r\n    return cachedSurgeLevel >= n;\r\n  }\r\n  return false;\r\n}\r\n\r\nfunction applyTsunamiNerf(bn) {\r\n  if (!isSurgeActive(8)) return bn;\r\n  const log10 = approxLog10BigNum(bn);\r\n  if (!Number.isFinite(log10)) return bn;\r\n  \r\n  const effective = getEffectiveTsunamiNerf();\r\n\r\n  return bigNumFromLog10(log10 * effective);\r\n}\r\n\r\nfunction updateMultiplier() {\r\n  const level = getCurrentSurgeLevel();\r\n  cachedSurgeLevel = level;\r\n  let isReached = false;\r\n  \r\n  if (level === Infinity) {\r\n    isReached = true;\r\n  } else if (typeof level === 'bigint') {\r\n    isReached = level >= 1n;\r\n  }\r\n\r\n  if (isReached) {\r\n    if (isSurgeActive(8)) {\r\n      const effective = getEffectiveTsunamiNerf();\r\n\r\n      const log10 = Math.log10(MULTIPLIER);\r\n      currentMultiplier = bigNumFromLog10(log10 * effective);\r\n    } else {\r\n      currentMultiplier = BigNum.fromInt(MULTIPLIER);\r\n    }\r\n  } else {\r\n    currentMultiplier = BigNum.fromInt(1);\r\n  }\r\n}\r\n\r\nexport function getSurge15Multiplier(preview = false) {\r\n  if (!preview && !isSurgeActive(15)) return BigNum.fromInt(1);\r\n  \r\n  const dna = bank.dna?.value;\r\n  if (!dna) return BigNum.fromInt(1);\r\n\r\n  const calc = (amount) => {\r\n    if (!amount) return BigNum.fromInt(1);\r\n    if (amount.isInfinite?.()) return BigNum.fromAny('Infinity');\r\n    \r\n    const log10Bn = approxLog10BigNum(amount);\r\n    if (!Number.isFinite(log10Bn) || log10Bn <= 0) return BigNum.fromInt(1);\r\n\r\n    // Formula: 2 ^ (log10(amount))\r\n    const power = log10Bn;\r\n    if (power <= 0) return BigNum.fromInt(1);\r\n\r\n    const log10Result = power * Math.log10(2);\r\n    return bigNumFromLog10(log10Result);\r\n  };\r\n\r\n  const mult = calc(dna);\r\n\r\n  if (isSurgeActive(8)) {\r\n     return applyTsunamiNerf(mult);\r\n  }\r\n\r\n  return mult;\r\n}\r\n\r\nexport function getSurge15Divisor(preview = false) {\r\n  if (!preview && !isSurgeActive(15)) return BigNum.fromInt(1);\r\n  \r\n  const dna = bank.dna?.value;\r\n  if (!dna) return BigNum.fromInt(1);\r\n\r\n  const calc = (amount) => {\r\n    if (!amount) return BigNum.fromInt(1);\r\n    if (amount.isInfinite?.()) return BigNum.fromAny('Infinity');\r\n    \r\n    const log10Bn = approxLog10BigNum(amount);\r\n    if (!Number.isFinite(log10Bn) || log10Bn <= 0) return BigNum.fromInt(1);\r\n\r\n    // Formula: 2 ^ (log10(amount) / 2)\r\n    const power = log10Bn / 2;\r\n    if (power <= 0) return BigNum.fromInt(1);\r\n\r\n    const log10Result = power * Math.log10(2);\r\n    return bigNumFromLog10(log10Result);\r\n  };\r\n\r\n  const div = calc(dna);\r\n\r\n  if (isSurgeActive(8)) {\r\n     return applyTsunamiNerf(div);\r\n  }\r\n\r\n  return div;\r\n}\r\n\r\nexport function getSurge6WealthMultipliers() {\r\n  if (!isSurgeActive(6)) {\r\n      return {\r\n          coins: BigNum.fromInt(1),\r\n          books: BigNum.fromInt(1),\r\n          gold: BigNum.fromInt(1),\r\n          magic: BigNum.fromInt(1),\r\n          total: BigNum.fromInt(1)\r\n      };\r\n  }\r\n\r\n  const calc = (amount, residue = 0) => {\r\n      if (!amount) {\r\n        if (residue <= 0) return BigNum.fromInt(1);\r\n        const log10 = Math.log10(residue);\r\n        const power = log10 / 3;\r\n        if (power <= 0) return BigNum.fromInt(1);\r\n        const log10Result = power * Math.log10(2);\r\n        return bigNumFromLog10(log10Result);\r\n      }\r\n\r\n      if (amount.isInfinite?.()) return BigNum.fromAny('Infinity');\r\n\r\n      const log10Bn = approxLog10BigNum(amount);\r\n      let finalLog10 = log10Bn;\r\n\r\n      if (!Number.isFinite(log10Bn)) {\r\n         if (residue > 0) {\r\n            finalLog10 = Math.log10(residue);\r\n         } else {\r\n            return BigNum.fromInt(1);\r\n         }\r\n      } else if (log10Bn < 15 && residue > 0) {\r\n         try {\r\n             const val = Number(amount.toPlainIntegerString());\r\n             if (Number.isFinite(val)) {\r\n                 const total = val + residue;\r\n                 if (total > 0) {\r\n                     finalLog10 = Math.log10(total);\r\n                 }\r\n             }\r\n         } catch {}\r\n      }\r\n      \r\n      // Formula: 2 ^ (log10(amount) / 6)\r\n      const power = finalLog10 / 6;\r\n      if (power <= 0) return BigNum.fromInt(1);\r\n      \r\n      // 2^power = 10^(power * log10(2))\r\n      const log10Result = power * Math.log10(2);\r\n      return bigNumFromLog10(log10Result);\r\n  };\r\n\r\n  const c = calc(bank.coins?.value);\r\n  \r\n  let bookVal = bank.books?.value;\r\n  let bookResidue = 0;\r\n  if (typeof window !== 'undefined' && typeof window.__bookResidue === 'number') {\r\n      bookResidue = window.__bookResidue;\r\n  }\r\n  const b = calc(bookVal, bookResidue);\r\n  \r\n  const g = calc(bank.gold?.value);\r\n  const m = calc(bank.magic?.value);\r\n  \r\n  let cOut = c, bOut = b, gOut = g, mOut = m;\r\n\r\n  if (isSurgeActive(8)) {\r\n    cOut = applyTsunamiNerf(c);\r\n    bOut = applyTsunamiNerf(b);\r\n    gOut = applyTsunamiNerf(g);\r\n    mOut = applyTsunamiNerf(m);\r\n  }\r\n\r\n  let total = cOut.mulBigNumInteger ? cOut.mulBigNumInteger(bOut) : cOut; \r\n  total = total.mulBigNumInteger ? total.mulBigNumInteger(gOut) : total;\r\n  total = total.mulBigNumInteger ? total.mulBigNumInteger(mOut) : total;\r\n  \r\n  return {\r\n      coins: cOut,\r\n      books: bOut,\r\n      gold: gOut,\r\n      magic: mOut,\r\n      total\r\n  };\r\n}\r\n\r\nexport function getBookProductionRate() {\r\n  if (!isSurgeActive(3)) return BigNum.fromInt(0);\r\n  \r\n  // Formula: max(1, floor(1 * exp(0.20 * xp_level)))\r\n  const xpState = getXpState();\r\n  const xpLevelBn = xpState.xpLevel;\r\n  \r\n  let baseRate;\r\n  if (xpLevelBn.isInfinite?.()) {\r\n     baseRate = BigNum.fromAny('Infinity');\r\n  } else {\r\n     // BigNum-safe logic for 10^(0.086... * xpLevel)\r\n     if (xpLevelBn.cmp(1e16) > 0) {\r\n         // Exponent E = floor(xpLevel * 0.086858...)\r\n         // We can calculate this using BigNum math.\r\n         const logValBn = xpLevelBn.mulDecimal(String(LOG10_EXP_0_2), 18);\r\n         \r\n         // Extract E from logValBn\r\n         // logValBn is roughly the exponent of 10. \r\n         if (logValBn.cmp(Number.MAX_VALUE) >= 0) {\r\n             baseRate = BigNum.fromAny('Infinity');\r\n         } else {\r\n             try {\r\n                // If logValBn is finite and within Number range, use it for bigNumFromLog10\r\n                const logValNum = Number(logValBn.toScientific());\r\n                if (logValNum === Infinity || !Number.isFinite(logValNum)) {\r\n                    baseRate = BigNum.fromAny('Infinity');\r\n                } else {\r\n                    baseRate = bigNumFromLog10(logValNum);\r\n                }\r\n             } catch {\r\n                 baseRate = BigNum.fromAny('Infinity');\r\n             }\r\n         }\r\n     } else {\r\n         const lvlNum = Number(xpLevelBn.toPlainIntegerString());\r\n         const logVal = lvlNum * LOG10_EXP_0_2;\r\n         baseRate = bigNumFromLog10(logVal);\r\n     }\r\n  }\r\n\r\n  // Ensure min 1\r\n  if (baseRate.cmp(1) < 0) baseRate = BigNum.fromInt(1);\r\n\r\n  // Apply multipliers\r\n  if (bank.books?.mult) {\r\n    const mult = bank.books.mult.get();\r\n    baseRate = baseRate.mulBigNumInteger(mult);\r\n  }\r\n\r\n  if (isSurgeActive(8)) {\r\n    baseRate = applyTsunamiNerf(baseRate);\r\n  }\r\n\r\n  return baseRate;\r\n}\r\n\r\nfunction onTick(dt) {\r\n  if (isSurgeActive(14)) {\r\n      updateCombo(dt);\r\n  }\r\n\r\n  if (isSurgeActive(3)) {\r\n      if (!bookRateAccumulator) {\r\n        bookRateAccumulator = new RateAccumulator('books', bank);\r\n      }\r\n\r\n      const baseRate = getBookProductionRate();\r\n\r\n      // Accumulate\r\n      if (baseRate.cmp(1e9) > 0 || baseRate.isInfinite?.()) {\r\n          // Direct add per tick for large numbers, using dt\r\n          // dt might be > 0.05 if lag occurs, but usually 0.05\r\n          const perTick = baseRate.mulDecimal(String(dt), 18);\r\n          if (bank.books) bank.books.add(perTick);\r\n      } else {\r\n          // Use accumulator for small numbers to handle fractional accumulation\r\n          const rateNum = Number(baseRate.toScientific());\r\n          // RateAccumulator expects amount per second\r\n          // We manually update it with variable dt support by bypassing addRate \r\n          // if RateAccumulator isn't dt-aware, but here we can just do manual accumulation for consistency\r\n          // or assume addRate is fixed step.\r\n          // Ideally we should modify RateAccumulator to take dt, or manually implement it here.\r\n          // Let's implement manual accumulation here for safety and precision.\r\n          \r\n          if (!window.__bookResidue) window.__bookResidue = 0;\r\n          window.__bookResidue += rateNum * dt;\r\n\r\n          if (window.__bookResidue > 0) {\r\n            try { window.dispatchEvent(new CustomEvent('surge:bookResidue')); } catch {}\r\n          }\r\n\r\n          if (window.__bookResidue >= 1) {\r\n              const whole = Math.floor(window.__bookResidue);\r\n              window.__bookResidue -= whole;\r\n              if (bank.books) bank.books.add(BigNum.fromInt(whole));\r\n          }\r\n      }\r\n  }\r\n\r\n  if (isSurgeActive(13)) {\r\n      const effectiveNerf = getEffectiveTsunamiNerf();\r\n      const mapped = effectiveNerf * 1.5 - 0.5;\r\n      \r\n      const log10Rate = 2 * mapped - 2;\r\n      const rateMultiplier = bigNumFromLog10(log10Rate);\r\n      \r\n      const coins = bank.coins?.value;\r\n      const xpState = getXpState();\r\n      \r\n      // Calculate pending Gold (base)\r\n      const basePending = computeForgeGoldFromInputs(coins, xpState.xpLevel);\r\n      \r\n      // Apply multipliers\r\n      // 1. Bank Gold multiplier\r\n      let pending = bank.gold?.mult?.applyTo?.(basePending) ?? basePending;\r\n      \r\n      // 2. Lab Gold multiplier\r\n      const labMult = getLabGoldMultiplier();\r\n      pending = pending.mulDecimal(labMult.toScientific());\r\n      \r\n      // Multiply by rate and dt\r\n      const perSec = pending.mulDecimal(rateMultiplier.toScientific());\r\n      const amountToAdd = perSec.mulDecimal(String(dt), 18);\r\n      \r\n      if (bank.gold) bank.gold.add(amountToAdd);\r\n  }\r\n\r\n  if (isSurgeActive(16)) {\r\n      const effectiveNerf = getEffectiveTsunamiNerf();\r\n      const mapped = effectiveNerf * 1.5 - 0.5;\r\n      \r\n      const log10Rate = 2 * mapped - 2;\r\n      const rateMultiplier = bigNumFromLog10(log10Rate);\r\n      \r\n      const coins = bank.coins?.value;\r\n      const cumulativeMp = getTotalCumulativeMp();\r\n      \r\n      const pending = computeInfuseMagicFromInputs(coins, cumulativeMp);\r\n      \r\n      // Multiply by rate and dt\r\n      const perSec = pending.mulDecimal(rateMultiplier.toScientific());\r\n      const amountToAdd = perSec.mulDecimal(String(dt), 18);\r\n      \r\n      if (bank.magic) bank.magic.add(amountToAdd);\r\n  }\r\n}\r\n\r\nfunction loadTsunamiNerf(slot) {\r\n  if (slot == null) return;\r\n  const stored = localStorage.getItem(TSUNAMI_NERF_KEY(slot));\r\n  if (stored !== null) {\r\n      tsunamiNerfExponent = Number(stored);\r\n      // Ensure validity on load\r\n      if (Number.isNaN(tsunamiNerfExponent) || !Number.isFinite(tsunamiNerfExponent)) {\r\n          tsunamiNerfExponent = isSurgeActive(8) ? 0.00 : 1.00;\r\n      }\r\n  } else {\r\n      // Default behavior if not stored\r\n      if (isSurgeActive(8)) {\r\n          tsunamiNerfExponent = 0.00;\r\n      } else {\r\n          tsunamiNerfExponent = 1.00;\r\n      }\r\n  }\r\n}\r\n\r\nfunction compareSurgeLevels(prev, curr) {\r\n  const isInfPrev = prev === Infinity || (typeof prev === 'string' && prev === 'Infinity') || prev === Number.POSITIVE_INFINITY;\r\n  const isInfCurr = curr === Infinity || (typeof curr === 'string' && curr === 'Infinity') || curr === Number.POSITIVE_INFINITY;\r\n  \r\n  if (isInfPrev && isInfCurr) return 0;\r\n  if (isInfCurr) return 1;\r\n  if (isInfPrev) return -1;\r\n  \r\n  let p = BigInt(0);\r\n  let c = BigInt(0);\r\n  try { p = typeof prev === 'bigint' ? prev : BigInt(prev); } catch {}\r\n  try { c = typeof curr === 'bigint' ? curr : BigInt(curr); } catch {}\r\n  \r\n  if (c > p) return 1;\r\n  if (c < p) return -1;\r\n  return 0;\r\n}\r\n\r\nexport function initSurgeEffects() {\r\n  initComboSystem(\r\n      () => isSurgeActive(14) && (getTsunamiNerf() + getTsunamiResearchBonus() < 1.0),\r\n      () => 1.0 - getEffectiveTsunamiNerf()\r\n  );\r\n\r\n  const slot = getActiveSlot();\r\n  // Update multiplier first to ensure cachedSurgeLevel is set,\r\n  // allowing isSurgeActive(8) to return the correct state for loadTsunamiNerf default logic.\r\n  updateMultiplier();\r\n  loadTsunamiNerf(slot);\r\n  // Update multiplier again to apply the loaded nerf value.\r\n  updateMultiplier();\r\n\r\n  if (typeof window !== 'undefined') {\r\n    window.addEventListener('surge:level:change', () => {\r\n      const prevLevel = cachedSurgeLevel;\r\n      const wasActive = isSurgeActive(8);\r\n      \r\n      updateMultiplier();\r\n      \r\n      const currLevel = cachedSurgeLevel;\r\n      const isActive = isSurgeActive(8);\r\n\r\n      if (!wasActive && isActive) {\r\n          setTsunamiNerf(0.00);\r\n          if (!getTsunamiSequenceSeen()) {\r\n              setTsunamiSequenceSeen(true);\r\n          }\r\n      } else if (isActive) {\r\n          // If already active, check if level increased\r\n          if (compareSurgeLevels(prevLevel, currLevel) > 0) {\r\n              setTsunamiNerf(0.00);\r\n              if (!getTsunamiSequenceSeen()) {\r\n                  setTsunamiSequenceSeen(true);\r\n              }\r\n          }\r\n      } else if (wasActive && !isActive) {\r\n          setTsunamiNerf(1.00);\r\n      }\r\n    });\r\n\r\n    window.addEventListener('lab:node:change', () => {\r\n        updateMultiplier();\r\n    });\r\n\r\n    window.addEventListener('saveSlot:change', () => {\r\n      loadTsunamiNerf(getActiveSlot());\r\n      updateMultiplier();\r\n    });\r\n    \r\n    // Listen for DNA changes to update dynamic multipliers\r\n    window.addEventListener('currency:change', (e) => {\r\n        if (e.detail?.key === 'dna') {\r\n            try { refreshCoinMultiplierFromXpLevel(); } catch {}\r\n            try { syncCurrencyMultipliersFromUpgrades(); } catch {}\r\n        }\r\n    });\r\n  }\r\n\r\n  addExternalCoinMultiplierProvider(({ baseMultiplier }) => {\r\n    if (currentMultiplier.cmp(BigNum.fromInt(1)) === 0) return baseMultiplier;\r\n    return baseMultiplier.mulBigNumInteger(currentMultiplier);\r\n  });\r\n\r\n  addExternalXpGainMultiplierProvider(({ baseGain }) => {\r\n    if (currentMultiplier.cmp(BigNum.fromInt(1)) === 0) return baseGain;\r\n    return baseGain.mulBigNumInteger(currentMultiplier);\r\n  });\r\n\r\n  addExternalXpGainMultiplierProvider(({ baseGain }) => {\r\n    if (!isSurgeActive(19)) return baseGain;\r\n    return baseGain.mulSmall(2);\r\n  });\r\n\r\n  addExternalMutationGainMultiplierProvider(({ baseGain }) => {\r\n    if (currentMultiplier.cmp(BigNum.fromInt(1)) === 0) return baseGain;\r\n    return baseGain.mulBigNumInteger(currentMultiplier);\r\n  });\r\n\r\n  addExternalMutationGainMultiplierProvider(({ baseGain }) => {\r\n    if (!isSurgeActive(4)) return baseGain;\r\n    let mult = BigNum.fromInt(4.444e12);\r\n    if (isSurgeActive(8)) {\r\n        const effective = getEffectiveTsunamiNerf();\r\n\r\n        const logVal = Math.log10(4.444e12);\r\n        mult = bigNumFromLog10(logVal * effective);\r\n    }\r\n    return baseGain.mulBigNumInteger(mult);\r\n  });\r\n\r\n  addExternalCoinMultiplierProvider(({ baseMultiplier }) => {\r\n    if (!isSurgeActive(6)) return baseMultiplier;\r\n    const wealth = getSurge6WealthMultipliers();\r\n    if (wealth.total.cmp(1) <= 0) return baseMultiplier;\r\n    return baseMultiplier.mulBigNumInteger(wealth.total);\r\n  });\r\n\r\n  addExternalCoinMultiplierProvider(({ baseMultiplier }) => {\r\n    if (!isSurgeActive(15)) return baseMultiplier;\r\n    \r\n    let result = baseMultiplier;\r\n    \r\n    const mult = getSurge15Multiplier();\r\n    if (mult.cmp(1) > 0) {\r\n        result = result.mulBigNumInteger(mult);\r\n    }\r\n    \r\n    const div = getSurge15Divisor();\r\n    if (div.cmp(1) > 0) {\r\n        result = result.div(div);\r\n    }\r\n    \r\n    return result;\r\n  });\r\n  \r\n  // Surge 17 (Div 1e5) and Surge 18 (Mul 1e15) for Coins\r\n  addExternalCoinMultiplierProvider(({ baseMultiplier }) => {\r\n    let log10Total = 0;\r\n    \r\n    // Surge 17: Divide by 1e5 -> -5\r\n    if (isSurgeActive(17)) {\r\n        log10Total -= 5;\r\n    }\r\n    \r\n    // Surge 18: Multiply by 1e15 -> +15\r\n    if (isSurgeActive(18)) {\r\n        log10Total += 15;\r\n    }\r\n    \r\n    if (log10Total === 0) return baseMultiplier;\r\n    \r\n    if (isSurgeActive(8)) {\r\n        const effective = getEffectiveTsunamiNerf();\r\n        log10Total *= effective;\r\n    }\r\n    \r\n    const mult = bigNumFromLog10(log10Total);\r\n    return baseMultiplier.mulBigNumInteger(mult);\r\n  });\r\n  \r\n  // Surge 3: Disable flat Book reward\r\n  setExternalBookRewardProvider(({ baseReward }) => {\r\n     if (isSurgeActive(3)) {\r\n         return BigNum.fromInt(0);\r\n     }\r\n     return baseReward;\r\n  });\r\n\r\n  registerTick(onTick);\r\n}\r\n\r\nexport function getSurgeMagicMultiplier() {\r\n    let log10Total = 0;\r\n    \r\n    if (isSurgeActive(17)) {\r\n        log10Total += 15;\r\n    }\r\n    \r\n    if (isSurgeActive(18)) {\r\n        log10Total -= 5;\r\n    }\r\n    \r\n    if (isSurgeActive(8)) {\r\n        const effective = getEffectiveTsunamiNerf();\r\n        log10Total *= effective;\r\n    }\r\n    \r\n    let result = BigNum.fromInt(1);\r\n    if (log10Total !== 0) {\r\n        result = bigNumFromLog10(log10Total);\r\n    }\r\n\r\n    if (isSurgeActive(15)) {\r\n        const div = getSurge15Divisor();\r\n        if (div.cmp(1) > 0) {\r\n            result = result.div(div);\r\n        }\r\n    }\r\n    \r\n    return result;\r\n}\r\n", "// js/ui/merchantTabs/workshopTab.js\r\nimport { BigNum } from '../../util/bigNum.js';\r\nimport { formatNumber } from '../../util/numFormat.js';\r\nimport { bank, CURRENCIES, getActiveSlot } from '../../util/storage.js';\r\nimport { registerTick } from '../../game/gameLoop.js';\r\nimport { openShop, playPurchaseSfx, isAnyMenuScrolling } from '../shopOverlay.js';\r\nimport { hasDoneInfuseReset } from './resetTab.js';\r\nimport { bigNumFromLog10, getLevelNumber, approxLog10BigNum } from '../../game/upgrades.js';\r\nimport { IS_MOBILE } from '../../main.js';\r\nimport { AUTOMATION_AREA_KEY, AUTOBUY_WORKSHOP_LEVELS_ID } from '../../game/automationUpgrades.js';\r\nimport { isSurgeActive } from \"../../game/surgeEffects.js\";\r\n\r\nconst GEAR_ICON_SRC = 'img/currencies/gear/gear.webp';\r\nconst GEAR_HUD_ICON_SRC = 'img/currencies/gear/gear_plus_base.webp';\r\nconst gearImage = new Image();\r\ngearImage.src = GEAR_ICON_SRC;\r\nconst COIN_ICON_SRC = 'img/currencies/coin/coin.webp';\r\n\r\nconst MAX_GEAR_DECORATIONS = 100;\r\n\r\nlet workshopEl = null;\r\nlet initialized = false;\r\nlet accumulatorBuffer = 0; \r\nlet currentGenerationLevel = BigNum.zero();\r\nlet lastSyncedLevel = -1;\r\nlet renderFrameId = null;\r\n\r\n// Upgrade Constants\r\nconst GENERATION_UPGRADE_BASE_COST_LOG = 12; // 1T = 1e12\r\nconst LOG10_2 = 0.3010299956639812; \r\nconst LOG10_3 = 0.47712125471966244;\r\nconst LOG10_4 = 0.6020599913279624;\r\n\r\n// Scaling Thresholds & Constants\r\nconst L1 = 1e6;\r\nconst L2 = 1e9;\r\nconst L3 = 1e12;\r\n\r\nconst BASE_MULT_LOG = 1; // log10(10)\r\nconst K_LIN = 0.001;\r\n\r\n// S3 Constants\r\nconst EXP_DIV_S3 = 1000;\r\nconst LOG_EXP_BASE_S3 = Math.log10(1.00001);\r\n\r\n// S4 Constants (Explosion)\r\nconst EXPLOSION_RATE = 2.3e-10;\r\n\r\n// Precomputed Constants\r\nconst LN10 = Math.log(10);\r\nconst INV_LN10 = 1 / LN10;\r\n\r\n// Helper Integrals\r\nfunction integralLogLin(x, k) {\r\n    if (x <= 0) return 0;\r\n    const term = 1 + k * x;\r\n    const val = (term * Math.log(term) - k * x) / k;\r\n    return val * INV_LN10;\r\n}\r\n\r\n// Lazy Caches\r\nlet CACHE_S1_END_LOG = null;\r\nlet CACHE_S2_END_LOG = null;\r\nlet CACHE_S3_END_LOG = null;\r\n\r\nexport function getGenerationLevelKey(slot) {\r\n  return `ccc:workshop:genLevel:${slot}`;\r\n}\r\n\r\nconst animatedGears = new Map(); \r\n\r\n// Config\r\nconst GEAR_SPEED = 67; \r\nconst GEAR_ROTATION_SPEED_BASE = 67; \r\nconst GEAR_ROTATION_VARIANCE = 67; \r\n\r\nfunction loadGenerationLevel() {\r\n  const slot = getActiveSlot();\r\n  if (!slot) return BigNum.zero();\r\n  const raw = localStorage.getItem(getGenerationLevelKey(slot));\r\n  if (!raw) return BigNum.zero();\r\n  \r\n  try {\r\n      // Handle both legacy \"123\" and new \"BN:...\" formats\r\n      if (raw.startsWith('BN:') || /infinity/i.test(raw)) {\r\n          return BigNum.fromStorage(raw);\r\n      }\r\n      return BigNum.fromAny(raw);\r\n  } catch {\r\n      return BigNum.zero();\r\n  }\r\n}\r\n\r\nfunction saveGenerationLevel(level) {\r\n  const slot = getActiveSlot();\r\n  if (!slot) return false;\r\n  const key = getGenerationLevelKey(slot);\r\n  \r\n  let valStr;\r\n  if (level instanceof BigNum) {\r\n      valStr = level.toStorage();\r\n  } else {\r\n      valStr = String(level);\r\n  }\r\n  \r\n  try {\r\n    localStorage.setItem(key, valStr);\r\n    if (typeof window !== 'undefined') {\r\n        window.dispatchEvent(new CustomEvent('workshop:change', { detail: { slot, level } }));\r\n    }\r\n  } catch {}\r\n  \r\n  let readBack = null;\r\n  try {\r\n    readBack = localStorage.getItem(key);\r\n  } catch {}\r\n  return readBack === valStr;\r\n}\r\n\r\nfunction calculateWorkshopCostLog(level) {\r\n    // Level is BigNum here, but for calculation we need primitive\r\n    if (level.isInfinite()) return Infinity;\r\n    \r\n    // Check if level is too large for JS numbers\r\n    // 9e15 is safe integer limit approx.\r\n    // If level > 9e15, cost is definitely infinity given the super-exponential scaling\r\n    if (level.cmp(9e15) > 0) return Infinity;\r\n    \r\n    // Convert to number for internal calc\r\n    let lvlNum = 0;\r\n    try {\r\n        const str = level.toPlainIntegerString();\r\n        lvlNum = parseFloat(str);\r\n    } catch {\r\n        return Infinity;\r\n    }\r\n    \r\n    if (lvlNum <= 0) return GENERATION_UPGRADE_BASE_COST_LOG;\r\n\r\n    // S1\r\n    if (lvlNum <= L1) {\r\n        return GENERATION_UPGRADE_BASE_COST_LOG + lvlNum * BASE_MULT_LOG;\r\n    }\r\n    \r\n    if (CACHE_S1_END_LOG === null) {\r\n        CACHE_S1_END_LOG = GENERATION_UPGRADE_BASE_COST_LOG + L1 * BASE_MULT_LOG;\r\n    }\r\n\r\n    // S2\r\n    const u = lvlNum - L1;\r\n    if (lvlNum <= L2) {\r\n        return CACHE_S1_END_LOG + u + integralLogLin(u, K_LIN);\r\n    }\r\n\r\n    if (CACHE_S2_END_LOG === null) {\r\n        const u2 = L2 - L1;\r\n        CACHE_S2_END_LOG = CACHE_S1_END_LOG + u2 + integralLogLin(u2, K_LIN);\r\n    }\r\n\r\n    // S3\r\n    const v = lvlNum - L2;\r\n    const u_at_L = lvlNum - L1;\r\n    const u_at_L2 = L2 - L1;\r\n    \r\n    // Delta S2 integral + S3 quadratic term\r\n    const s2_continuation = v + (integralLogLin(u_at_L, K_LIN) - integralLogLin(u_at_L2, K_LIN));\r\n    const C3 = LOG_EXP_BASE_S3 / EXP_DIV_S3;\r\n    const s3_extra = 0.5 * C3 * v * v;\r\n    \r\n    if (lvlNum <= L3) {\r\n        return CACHE_S2_END_LOG + s2_continuation + s3_extra;\r\n    }\r\n\r\n    if (CACHE_S3_END_LOG === null) {\r\n        const v3 = L3 - L2;\r\n        const u3 = L3 - L1;\r\n        const s2_cont_3 = v3 + (integralLogLin(u3, K_LIN) - integralLogLin(u_at_L2, K_LIN));\r\n        const s3_extra_3 = 0.5 * C3 * v3 * v3;\r\n        CACHE_S3_END_LOG = CACHE_S2_END_LOG + s2_cont_3 + s3_extra_3;\r\n    }\r\n    \r\n    // S4: Exponential Explosion\r\n    // logCost grows exponentially with level delta\r\n    const scalingExp = EXPLOSION_RATE * (lvlNum - L3);\r\n    // If scalingExp > 709, Math.exp overflows to Infinity.\r\n    if (scalingExp > 709) return Infinity; \r\n    \r\n    const result = CACHE_S3_END_LOG * Math.exp(scalingExp);\r\n    \r\n    // Hard Cap at BigNum limit (approx 1.8e308)\r\n    if (!Number.isFinite(result) || result > 1.79e308) return Infinity;\r\n    \r\n    return result;\r\n}\r\n\r\nexport function getGenerationUpgradeCost(level) {\r\n  let bnLevel = level;\r\n  if (!(level instanceof BigNum)) {\r\n      bnLevel = BigNum.fromAny(level);\r\n  }\r\n  \r\n  if (bnLevel.isInfinite()) return BigNum.fromAny('Infinity');\r\n  \r\n  const logCost = calculateWorkshopCostLog(bnLevel);\r\n  return bigNumFromLog10(logCost);\r\n}\r\n\r\nfunction getGearsPerSecond(level) {\r\n  let baseRate;\r\n  let bnLevel = level;\r\n  if (!(level instanceof BigNum)) {\r\n      bnLevel = BigNum.fromAny(level);\r\n  }\r\n  const logBase = isSurgeActive(11) ? LOG10_4 : (isSurgeActive(7) ? LOG10_3 : LOG10_2);\r\n\r\n  if (bnLevel.isZero()) {\r\n    baseRate = BigNum.fromInt(1);\r\n  } else if (bnLevel.isInfinite()) {\r\n    baseRate = BigNum.fromAny('Infinity');\r\n  } else {\r\n    // If level is huge, we can use mulDecimal(logBase)\r\n    // level * 0.301... => log10(rate)\r\n    const logValue = bnLevel.mulDecimal(logBase);\r\n    // bigNumFromLog10 expects a number if possible, or handles large numbers?\r\n    // bigNumFromLog10 impl in upgrades.js:\r\n    // export function bigNumFromLog10(logVal) {\r\n    //   if (logVal === Infinity) return BigNum.fromAny('Infinity');\r\n    //   if (logVal instanceof BigNum) { ... }\r\n    // We can pass BigNum to bigNumFromLog10 if the helper supports it.\r\n    // Assuming bigNumFromLog10 only takes numbers or BigNum:\r\n    \r\n    // Actually, bigNumFromLog10(logVal) implementation usually assumes number.\r\n    // If logValue is BigNum (because level was BigNum), we need to handle it.\r\n    // If level is < 1e15, we can use numbers.\r\n    // If level is massive, rate is massive.\r\n    \r\n    if (bnLevel.cmp(9e15) <= 0) {\r\n        // Safe to use standard number math\r\n        const lvlNum = Number(bnLevel.toString());\r\n        const logVal = lvlNum * logBase;\r\n        baseRate = bigNumFromLog10(logVal);\r\n    } else {\r\n        // Level is huge. \r\n        // rate = 2^level = 10^(level * log10(2))\r\n        // exponent is level * 0.30103...\r\n        // e = level * 0.30103...\r\n        // Construct BigNum directly: 10^e\r\n        // BigNum constructor takes { base: e }\r\n        \r\n        // mulDecimal returns BigNum\r\n        const logExpBn = bnLevel.mulDecimal(logBase);\r\n        \r\n        // If logExpBn is massive, it becomes the exponent 'e' of the new BigNum\r\n        // We need to extract the value from BigNum logExpBn to use as exponent.\r\n        \r\n        // BigNum structure: sig * 10^e\r\n        // We want 10^(logExpBn)\r\n        // This is effectively BigNum with e = logExpBn\r\n        \r\n        // We can use BigNum internal structure or fromStorage logic\r\n        // But BigNum 'e' is limited to ~1.8e308. \r\n        // If 'level' is ~1e308, then 'e' is ~3e307. This fits in 'e'.\r\n        // If 'level' is larger than 1.8e308 (BigNum max), then the result is infinite.\r\n        \r\n        if (logExpBn.cmp(Number.MAX_VALUE) >= 0) {\r\n            baseRate = BigNum.fromAny('Infinity');\r\n        } else {\r\n            // logExpBn is finite number (though represented as BigNum)\r\n            // Extract it.\r\n            // Since it's < Number.MAX_VALUE, we can convert to number safely?\r\n            // Wait, MAX_VALUE is 1.79e308.\r\n            // Number(bn) works if it fits.\r\n            // We can try conversion.\r\n            \r\n            try {\r\n                // Approximate for very large numbers\r\n                 const logExpVal = Number(logExpBn.toScientific(10));\r\n                 if (logExpVal === Infinity) {\r\n                     baseRate = BigNum.fromAny('Infinity');\r\n                 } else {\r\n                     baseRate = bigNumFromLog10(logExpVal);\r\n                 }\r\n            } catch {\r\n                baseRate = BigNum.fromAny('Infinity');\r\n            }\r\n        }\r\n    }\r\n  }\r\n  \r\n  const mult = bank?.gears?.mult?.get?.() ?? BigNum.fromInt(1);\r\n  return baseRate.mulBigNumInteger(mult);\r\n}\r\n\r\nfunction buyGenerationUpgrade() {\r\n  const cost = getGenerationUpgradeCost(currentGenerationLevel);\r\n  if (bank.coins.value.cmp(cost) < 0) return;\r\n  // currentGenerationLevel is BigNum\r\n  const nextLevel = currentGenerationLevel.add(1);\r\n  if (saveGenerationLevel(nextLevel)) {\r\n    currentGenerationLevel = nextLevel;\r\n    bank.coins.sub(cost);\r\n    updateWorkshopTab();\r\n    playPurchaseSfx();\r\n  }\r\n}\r\n\r\nfunction onTick() {\r\n  if (!hasDoneInfuseReset()) return;\r\n  const rateBn = getGearsPerSecond(currentGenerationLevel);\r\n  const perTick = rateBn.mulDecimal('0.05');\r\n  const whole = perTick.floorToInteger();\r\n  const hasWhole = !whole.isZero();\r\n  if (hasWhole) {\r\n      if (bank.gears) bank.gears.add(whole);\r\n  }\r\n  \r\n  // Accumulator logic only for small levels < 20\r\n  if (currentGenerationLevel.cmp(20) < 0) {\r\n      // Safe to convert to number\r\n      const lvlNum = Number(currentGenerationLevel.toPlainIntegerString());\r\n      const rateNum = Math.pow(isSurgeActive(11) ? 4 : (isSurgeActive(7) ? 3 : 2), lvlNum);\r\n      const perTickNum = rateNum / 20;\r\n      const wholeNum = Math.floor(perTickNum);\r\n      const frac = perTickNum - wholeNum;\r\n      accumulatorBuffer += frac;\r\n      if (accumulatorBuffer >= 1) {\r\n          const accWhole = Math.floor(accumulatorBuffer);\r\n          accumulatorBuffer -= accWhole;\r\n          if (bank.gears) bank.gears.add(accWhole);\r\n      }\r\n  } else {\r\n      accumulatorBuffer = 0;\r\n  }\r\n}\r\n\r\nfunction resetWorkshopState() {\r\n    if (bank.gears) bank.gears.set(0);\r\n    if (saveGenerationLevel(BigNum.zero())) {\r\n        currentGenerationLevel = BigNum.zero();\r\n    }\r\n    accumulatorBuffer = 0;\r\n    updateWorkshopTab();\r\n}\r\n\r\nfunction syncGearDecorations(container) {\r\n  if (!container) return;\r\n  let entry = animatedGears.get(container);\r\n  \r\n  // Ensure canvas exists\r\n  let canvas = container.querySelector('canvas.workshop-gear-canvas');\r\n  if (!canvas) {\r\n      canvas = document.createElement('canvas');\r\n      canvas.classList.add('workshop-gear-canvas');\r\n      canvas.style.position = 'absolute';\r\n      canvas.style.top = '0';\r\n      canvas.style.left = '0';\r\n      canvas.style.width = '100%';\r\n      canvas.style.height = '100%';\r\n      canvas.style.pointerEvents = 'none';\r\n      canvas.style.userSelect = 'none';\r\n      canvas.style.zIndex = '0';\r\n      container.appendChild(canvas);\r\n  }\r\n\r\n  const rect = container.getBoundingClientRect();\r\n  const dpr = window.devicePixelRatio || 1;\r\n\r\n  if (!entry) {\r\n    entry = { \r\n        gears: [], \r\n        width: rect.width, \r\n        height: rect.height, \r\n        needsDistribution: !rect.width || !rect.height,\r\n        canvas: canvas,\r\n        ctx: canvas.getContext('2d', { alpha: true }) \r\n    };\r\n    // Initialize canvas resolution\r\n    canvas.width = Math.round(rect.width * dpr);\r\n    canvas.height = Math.round(rect.height * dpr);\r\n    entry.ctx.scale(dpr, dpr);\r\n    animatedGears.set(container, entry);\r\n  } else {\r\n    // Update canvas reference if for some reason it changed (unlikely but safe)\r\n    if (!entry.canvas) {\r\n        entry.canvas = canvas;\r\n        entry.ctx = canvas.getContext('2d', { alpha: true });\r\n        entry.ctx.scale(dpr, dpr);\r\n    }\r\n  }\r\n\r\n  if (rect.width > 0 && rect.height > 0) {\r\n    entry.width = rect.width;\r\n    entry.height = rect.height;\r\n    const targetWidth = Math.round(rect.width * dpr);\r\n    const targetHeight = Math.round(rect.height * dpr);\r\n\r\n    if (entry.canvas.width !== targetWidth || entry.canvas.height !== targetHeight) {\r\n        entry.canvas.width = targetWidth;\r\n        entry.canvas.height = targetHeight;\r\n        entry.ctx.scale(dpr, dpr);\r\n    }\r\n  }\r\n  \r\n  // Cap at 100 gears, but handle BigNum level safely\r\n  let lvlNum = 0;\r\n  if (currentGenerationLevel.cmp(MAX_GEAR_DECORATIONS) > 0) {\r\n      lvlNum = MAX_GEAR_DECORATIONS;\r\n  } else {\r\n      lvlNum = Number(currentGenerationLevel.toPlainIntegerString());\r\n  }\r\n\r\n  const targetCount = Math.min(Math.floor(lvlNum), MAX_GEAR_DECORATIONS);\r\n  const gears = entry.gears;\r\n  \r\n  // Create new gears (state only)\r\n  while (gears.length < targetCount) {\r\n    const size = 32 + Math.random() * 48;\r\n    let x = 0;\r\n    let y = 0;\r\n    if (entry.width > 0 && entry.height > 0) {\r\n      x = Math.random() * (entry.width - size);\r\n      y = Math.random() * (entry.height - size);\r\n      if (x < 0) x = 0;\r\n      if (y < 0) y = 0;\r\n    } else {\r\n      entry.needsDistribution = true;\r\n    }\r\n    const angle = Math.random() * Math.PI * 2;\r\n    const dx = Math.cos(angle) * GEAR_SPEED;\r\n    const dy = Math.sin(angle) * GEAR_SPEED;\r\n    const rotation = Math.random() * 360;\r\n    const rotationSpeed = (Math.random() < 0.5 ? -1 : 1) * (GEAR_ROTATION_SPEED_BASE + Math.random() * GEAR_ROTATION_VARIANCE);\r\n    \r\n    gears.push({ x, y, dx, dy, rotation, rotationSpeed, size });\r\n  }\r\n  \r\n  // Remove excess gears\r\n  while (gears.length > targetCount) {\r\n    gears.pop();\r\n  }\r\n}\r\n\r\nfunction buildWorkshopUI(container) {\r\n  let descText = 'Click the big red button below to open the Automation Shop';\r\n  if (IS_MOBILE) {\r\n    const isLargeScreen = Math.max(window.innerWidth, window.innerHeight) >= 900;\r\n    descText = isLargeScreen \r\n      ? 'Tap the big red button below to open the Automation Shop'\r\n      : 'Tap the big red button below (scroll if needed) to open the Automation Shop';\r\n  }\r\n  container.innerHTML = `<div class=\"merchant-workshop\"><div class=\"workshop-side-col workshop-side-left\"></div><div class=\"workshop-center-col\"><div class=\"workshop-info-panel\"><div class=\"workshop-gear-hud\"><img src=\"${GEAR_HUD_ICON_SRC}\" class=\"workshop-gear-plus\" alt=\"Gears\"><div class=\"workshop-gear-bar\"><span data-workshop=\"gears-amount\" class=\"workshop-gear-amount\">0</span></div></div><div class=\"workshop-rate-display\"> (+<img src=\"${GEAR_ICON_SRC}\" class=\"workshop-rate-icon\" alt=\"\"><span><span data-workshop=\"gears-rate\">0</span>/sec)</span></div><div class=\"workshop-description\"> Spend Coins to increase your Workshop Level<br> Each increase of your Workshop Level will <span data-workshop=\"production-verb\">double</span> the rate of Gear production<br> ${descText}<br> Spend Gears in the Automation Shop to unlock powerful automation upgrades<br> Automation upgrades will never be reset by any reset layer </div></div><div class=\"workshop-doubler-panel\"><button class=\"workshop-upgrade-btn\" data-workshop=\"upgrade-gen\"><span class=\"workshop-upgrade-title\">Increase Workshop Level</span><span class=\"workshop-upgrade-cost\"> Cost: <img src=\"${COIN_ICON_SRC}\" class=\"workshop-upgrade-cost-icon\" alt=\"Coins\"><span data-workshop=\"upgrade-cost\">1T</span></span></button></div><button class=\"btn-automation-shop\">Automation</button></div><div class=\"workshop-side-col workshop-side-right\"></div></div>`;\r\n  const leftCol = container.querySelector('.workshop-side-left');\r\n  const rightCol = container.querySelector('.workshop-side-right');\r\n  const upgradeBtn = container.querySelector('[data-workshop=\"upgrade-gen\"]');\r\n  upgradeBtn.addEventListener('click', () => { buyGenerationUpgrade(); });\r\n  upgradeBtn.addEventListener('contextmenu', (e) => {\r\n      e.preventDefault();\r\n      buyMaxGenerationUpgrade();\r\n  });\r\n  const automationBtn = container.querySelector('.btn-automation-shop');\r\n  automationBtn.addEventListener('click', () => { openShop('automation'); });\r\n  const syncLayout = () => {\r\n      const statsBtn = document.querySelector('.hud-bottom [data-btn=\"stats\"]');\r\n      if (statsBtn && automationBtn) {\r\n          const rect = statsBtn.getBoundingClientRect();\r\n          automationBtn.style.width = `${rect.width}px`;\r\n          automationBtn.style.height = `${rect.height}px`;\r\n          automationBtn.style.minWidth = '0';\r\n          automationBtn.style.maxWidth = 'none';\r\n      }\r\n      if (workshopEl && workshopEl.isConnected) {\r\n        const left = workshopEl.querySelector('.workshop-side-left');\r\n        const right = workshopEl.querySelector('.workshop-side-right');\r\n        const updateBounds = (col) => {\r\n           if (!col) return;\r\n           const entry = animatedGears.get(col);\r\n           if (entry) {\r\n             const rect = col.getBoundingClientRect();\r\n             const dpr = window.devicePixelRatio || 1;\r\n             entry.width = rect.width;\r\n             entry.height = rect.height;\r\n             const targetWidth = Math.round(rect.width * dpr);\r\n             const targetHeight = Math.round(rect.height * dpr);\r\n\r\n             if (entry.canvas && (entry.canvas.width !== targetWidth || entry.canvas.height !== targetHeight)) {\r\n                 entry.canvas.width = targetWidth;\r\n                 entry.canvas.height = targetHeight;\r\n                 entry.ctx.scale(dpr, dpr);\r\n             }\r\n             if (entry.needsDistribution && entry.width > 0 && entry.height > 0) {\r\n                 entry.needsDistribution = false;\r\n                 for (const g of entry.gears) {\r\n                     g.x = Math.random() * (entry.width - g.size);\r\n                     if (g.x < 0) g.x = 0;\r\n                     g.y = Math.random() * (entry.height - g.size);\r\n                     if (g.y < 0) g.y = 0;\r\n                 }\r\n             }\r\n           }\r\n        };\r\n        updateBounds(left);\r\n        updateBounds(right);\r\n      }\r\n  };\r\n  if (typeof ResizeObserver !== 'undefined') {\r\n      const ro = new ResizeObserver(syncLayout);\r\n      const hud = document.querySelector('.hud-bottom');\r\n      if (hud) ro.observe(hud);\r\n      if (leftCol) ro.observe(leftCol);\r\n      if (rightCol) ro.observe(rightCol);\r\n      window.addEventListener('resize', syncLayout);\r\n      requestAnimationFrame(syncLayout);\r\n  } else {\r\n      window.addEventListener('resize', syncLayout);\r\n      requestAnimationFrame(syncLayout);\r\n  }\r\n  if (typeof IntersectionObserver !== 'undefined') {\r\n      const visibilityObserver = new IntersectionObserver((entries) => {\r\n          for (const entry of entries) {\r\n              if (entry.isIntersecting) { startRenderLoop(); } else { stopRenderLoop(); }\r\n          }\r\n      }, { root: null, threshold: 0 });\r\n      visibilityObserver.observe(container);\r\n  }\r\n  workshopEl = container;\r\n}\r\n\r\nexport function updateWorkshopTab() {\r\n  if (!workshopEl) return;\r\n  const verbEl = workshopEl.querySelector(\"[data-workshop=\\\"production-verb\\\"]\");\r\n  if (verbEl) {\r\n      const verb = isSurgeActive(11) ? \"quadruple\" : (isSurgeActive(7) ? \"triple\" : \"double\");\r\n      if (verbEl.textContent !== verb) verbEl.textContent = verb;\r\n  }\r\n  const gearsAmountEl = workshopEl.querySelector('[data-workshop=\"gears-amount\"]');\r\n  const gearsRateEl = workshopEl.querySelector('[data-workshop=\"gears-rate\"]');\r\n  const upgradeCostEl = workshopEl.querySelector('[data-workshop=\"upgrade-cost\"]');\r\n  const upgradeBtn = workshopEl.querySelector('[data-workshop=\"upgrade-gen\"]');\r\n  const rateBn = getGearsPerSecond(currentGenerationLevel);\r\n  const cost = getGenerationUpgradeCost(currentGenerationLevel);\r\n  if (gearsAmountEl) gearsAmountEl.innerHTML = bank.gears.fmt(bank.gears.value);\r\n  if (gearsRateEl) gearsRateEl.innerHTML = formatNumber(rateBn);\r\n  if (upgradeCostEl) {\r\n      let label = 'Coins';\r\n      try {\r\n          const isOne = !cost.isInfinite() && cost.cmp(1) === 0;\r\n          label = isOne ? 'Coin' : 'Coins';\r\n      } catch {}\r\n      upgradeCostEl.innerHTML = `${formatNumber(cost)} ${label}`;\r\n  }\r\n  if (upgradeBtn) {\r\n    const canAfford = bank.coins.value.cmp(cost) >= 0;\r\n    upgradeBtn.disabled = !canAfford;\r\n    const autoLevel = getLevelNumber(AUTOMATION_AREA_KEY, AUTOBUY_WORKSHOP_LEVELS_ID);\r\n    let isAutomated = false;\r\n    if (autoLevel > 0) {\r\n        const slot = getActiveSlot();\r\n        const slotSuffix = slot != null ? `:${slot}` : '';\r\n        const key = `ccc:autobuy:${AUTOMATION_AREA_KEY}:${AUTOBUY_WORKSHOP_LEVELS_ID}${slotSuffix}`;\r\n        isAutomated = localStorage.getItem(key) !== '0';\r\n    }\r\n    if (isAutomated) upgradeBtn.classList.add('is-automated');\r\n    else upgradeBtn.classList.remove('is-automated');\r\n  }\r\n  \r\n  // Use toScientific for large level comparisons? or just check if it changed significantly\r\n  // For animations, we just need to know if it grew.\r\n  // Using toPlainIntegerString is risky if it's huge, but fine for checking floor change if we cache properly.\r\n  // Actually, we can just use the BigNum instance itself as a key if it's immutable, but it's not.\r\n  // We can format it to a string.\r\n  \r\n  let currentIntStr = '';\r\n  if (currentGenerationLevel.isInfinite()) currentIntStr = 'Infinity';\r\n  else currentIntStr = currentGenerationLevel.floorToInteger().toStorage(); // BN:18:sig:exp\r\n\r\n  if (currentIntStr !== lastSyncedLevel) {\r\n    lastSyncedLevel = currentIntStr;\r\n    const leftCol = workshopEl.querySelector('.workshop-side-left');\r\n    const rightCol = workshopEl.querySelector('.workshop-side-right');\r\n    if (leftCol) syncGearDecorations(leftCol);\r\n    if (rightCol) syncGearDecorations(rightCol);\r\n  }\r\n}\r\n\r\nfunction stopRenderLoop() {\r\n  if (renderFrameId) {\r\n    cancelAnimationFrame(renderFrameId);\r\n    renderFrameId = null;\r\n  }\r\n}\r\n\r\nlet lastRenderTime = 0;\r\nfunction startRenderLoop() {\r\n  if (renderFrameId) return;\r\n  lastRenderTime = 0;\r\n  const loop = (timestamp) => {\r\n    if (workshopEl && workshopEl.isConnected) {\r\n        const gearsAmountEl = workshopEl.querySelector('[data-workshop=\"gears-amount\"]');\r\n        if (gearsAmountEl && !isAnyMenuScrolling()) {\r\n             gearsAmountEl.innerHTML = bank.gears.fmt(bank.gears.value);\r\n        }\r\n        if (!lastRenderTime) lastRenderTime = timestamp;\r\n        let dt = (timestamp - lastRenderTime) / 1000;\r\n        lastRenderTime = timestamp;\r\n        if (dt > 0.1) dt = 0.1; \r\n        for (const [container, data] of animatedGears) {\r\n            if (!container.isConnected) continue;\r\n            const { gears, width, height, ctx } = data;\r\n            if (!width || !height || !ctx) continue;\r\n            \r\n            ctx.clearRect(0, 0, width, height);\r\n\r\n            // If image not loaded, skip drawing\r\n            if (!gearImage.complete || gearImage.naturalWidth === 0) continue;\r\n\r\n            for (const g of gears) {\r\n                g.x += g.dx * dt;\r\n                g.y += g.dy * dt;\r\n                if (g.x < 0) { g.x = 0; g.dx = -g.dx; }\r\n                else if (g.x + g.size > width) { g.x = width - g.size; g.dx = -g.dx; }\r\n                if (g.y < 0) { g.y = 0; g.dy = -g.dy; }\r\n                else if (g.y + g.size > height) { g.y = height - g.size; g.dy = -g.dy; }\r\n                g.rotation += g.rotationSpeed * dt;\r\n                \r\n                // Draw to canvas\r\n                // Translate to center of gear\r\n                const cx = g.x + g.size / 2;\r\n                const cy = g.y + g.size / 2;\r\n                \r\n                ctx.save();\r\n                ctx.translate(cx, cy);\r\n                ctx.rotate(g.rotation * Math.PI / 180);\r\n                ctx.drawImage(gearImage, -g.size / 2, -g.size / 2, g.size, g.size);\r\n                ctx.restore();\r\n            }\r\n        }\r\n    }\r\n    renderFrameId = requestAnimationFrame(loop);\r\n  };\r\n  renderFrameId = requestAnimationFrame(loop);\r\n}\r\n\r\nexport function initWorkshopSystem() {\r\n  if (initialized) return;\r\n  initialized = true;\r\n  currentGenerationLevel = loadGenerationLevel();\r\n  registerTick(onTick);\r\n  if (typeof window !== 'undefined') {\r\n      window.addEventListener('saveSlot:change', () => {\r\n          currentGenerationLevel = loadGenerationLevel();\r\n          accumulatorBuffer = 0;\r\n          if (!hasDoneInfuseReset()) { resetWorkshopState(); }\r\n          updateWorkshopTab();\r\n      });\r\n      window.addEventListener('currency:change', (e) => {\r\n          if (e.detail.key === CURRENCIES.COINS) { updateWorkshopTab(); }\r\n      });\r\n      window.addEventListener('currency:multiplier', (e) => {\r\n          if (e.detail.key === CURRENCIES.GEARS) { updateWorkshopTab(); }\r\n      });\r\n      window.addEventListener('debug:change', () => {\r\n          currentGenerationLevel = loadGenerationLevel();\r\n          updateWorkshopTab();\r\n      });\r\n      window.addEventListener('unlock:change', (e) => {\r\n         const detail = e.detail || {};\r\n         if (detail.key === 'infuse') { if (!hasDoneInfuseReset()) { resetWorkshopState(); } }\r\n      });\r\n  }\r\n}\r\n\r\nexport function initWorkshopTab(panelEl) {\r\n  initWorkshopSystem();\r\n  if (panelEl.__workshopInit) return;\r\n  panelEl.__workshopInit = true;\r\n  currentGenerationLevel = loadGenerationLevel();\r\n  animatedGears.clear();\r\n  lastSyncedLevel = -1;\r\n  buildWorkshopUI(panelEl);\r\n  if (typeof IntersectionObserver === 'undefined') { startRenderLoop(); }\r\n  if (!hasDoneInfuseReset()) { resetWorkshopState(); }\r\n  updateWorkshopTab();\r\n}\r\n\r\nexport function getGearsProductionRate() {\r\n  const level = loadGenerationLevel();\r\n  return getGearsPerSecond(level);\r\n}\r\n\r\nexport function performFreeGenerationUpgrade() {\r\n  // If user has infinite coins and cost is infinite, or coins are simply infinite, snap to infinity immediately if cost is also seemingly infinite\r\n  const coinsInf = bank.coins.value.isInfinite();\r\n  const currentCost = getGenerationUpgradeCost(currentGenerationLevel);\r\n  const costInf = currentCost.isInfinite();\r\n\r\n  if (coinsInf && costInf && !currentGenerationLevel.isInfinite()) {\r\n      currentGenerationLevel = BigNum.fromAny('Infinity');\r\n      saveGenerationLevel(currentGenerationLevel);\r\n      updateWorkshopTab();\r\n      return true;\r\n  }\r\n    \r\n  if (bank.coins.value.isZero()) return false;\r\n  let coinsLog = approxLog10BigNum(bank.coins.value);\r\n  if (!Number.isFinite(coinsLog)) {\r\n     if (bank.coins.value.inf) coinsLog = Infinity;\r\n     else return false;\r\n  }\r\n  \r\n  // calculateWorkshopCostLog now expects BigNum\r\n  if (calculateWorkshopCostLog(currentGenerationLevel) > coinsLog) return false;\r\n  \r\n  // We need to find the max affordable level.\r\n  // Since level is BigNum, we have to handle potentially huge ranges.\r\n  // But calculateWorkshopCostLog crashes if level > 1e15 or so.\r\n  // If coinsLog is Finite, then level MUST be < 1e15 roughly.\r\n  // So we can convert currentGenerationLevel to number for the search if it's small.\r\n  \r\n  if (currentGenerationLevel.cmp(9e15) > 0) return false; // Too big for normal logic, handled by Infinity check above\r\n  \r\n  let low = Number(currentGenerationLevel.toPlainIntegerString());\r\n  let high = 9e15; \r\n  if (coinsLog === Infinity) high = 9e15; \r\n\r\n  let best = low;\r\n  while (low <= high) {\r\n      const mid = Math.floor((low + high) / 2);\r\n      // mid is number, need to pass BigNum to calculator\r\n      if (calculateWorkshopCostLog(BigNum.fromInt(mid)) <= coinsLog) {\r\n          best = mid;\r\n          low = mid + 1;\r\n      } else {\r\n          high = mid - 1;\r\n      }\r\n  }\r\n  \r\n  let targetLevelVal = best + 1;\r\n  let targetLevel = BigNum.fromInt(targetLevelVal);\r\n\r\n  if (targetLevel.cmp(currentGenerationLevel) > 0) {\r\n    if (saveGenerationLevel(targetLevel)) {\r\n      currentGenerationLevel = targetLevel;\r\n      updateWorkshopTab();\r\n      return true;\r\n    }\r\n  }\r\n  return false;\r\n}\r\n\r\nfunction buyMaxGenerationUpgrade() {\r\n  if (bank.coins.value.isInfinite()) {\r\n      if (performFreeGenerationUpgrade()) {\r\n          playPurchaseSfx();\r\n      }\r\n      return;\r\n  }\r\n  \r\n  const coinsLog = approxLog10BigNum(bank.coins.value);\r\n  if (!Number.isFinite(coinsLog)) {\r\n     if (bank.coins.value.isZero()) return;\r\n  }\r\n  \r\n  if (calculateWorkshopCostLog(currentGenerationLevel) > coinsLog) return;\r\n  \r\n  if (currentGenerationLevel.cmp(9e15) > 0) return; \r\n\r\n  let low = Number(currentGenerationLevel.toPlainIntegerString());\r\n  let high = 9e15; \r\n  if (coinsLog === Infinity) high = 9e15; \r\n\r\n  let best = low;\r\n  while (low <= high) {\r\n      const mid = Math.floor((low + high) / 2);\r\n      if (calculateWorkshopCostLog(BigNum.fromInt(mid)) <= coinsLog) {\r\n          best = mid;\r\n          low = mid + 1;\r\n      } else {\r\n          high = mid - 1;\r\n      }\r\n  }\r\n  \r\n  let targetLevelVal = best + 1;\r\n  let currentVal = Number(currentGenerationLevel.toPlainIntegerString());\r\n  \r\n  let startL = Math.max(currentVal, targetLevelVal - 100);\r\n  \r\n  let totalCost = BigNum.zero();\r\n  for (let l = startL; l < targetLevelVal; l++) {\r\n      totalCost = totalCost.add(getGenerationUpgradeCost(BigNum.fromInt(l)));\r\n  }\r\n  \r\n  if (totalCost.cmp(bank.coins.value) > 0) {\r\n      let topCost = getGenerationUpgradeCost(BigNum.fromInt(targetLevelVal - 1));\r\n      totalCost = totalCost.sub(topCost);\r\n      targetLevelVal--;\r\n  }\r\n  \r\n  let targetLevel = BigNum.fromInt(targetLevelVal);\r\n  if (targetLevel.cmp(currentGenerationLevel) > 0) {\r\n      if (saveGenerationLevel(targetLevel)) {\r\n          currentGenerationLevel = targetLevel;\r\n          bank.coins.sub(totalCost);\r\n          updateWorkshopTab();\r\n          playPurchaseSfx();\r\n      }\r\n  }\r\n}\r\n", "import { getLastSaveTime, getActiveSlot, isCurrencyLocked, isStorageKeyLocked, markSaveSlotModified } from '../util/storage.js';\r\nimport { getGearsProductionRate } from '../ui/merchantTabs/workshopTab.js';\r\nimport { hasDoneInfuseReset } from '../ui/merchantTabs/resetTab.js';\r\nimport { pauseGameLoop, resumeGameLoop } from './gameLoop.js';\r\nimport { bank } from '../util/storage.js';\r\nimport { BigNum } from '../util/bigNum.js';\r\nimport { formatNumber } from '../util/numFormat.js';\r\nimport { ensureCustomScrollbar } from '../ui/shopOverlay.js';\r\nimport { IS_MOBILE } from '../main.js';\r\nimport { getLevelNumber, computeUpgradeEffects, getCurrentAreaKey as getUpgAreaKey } from './upgrades.js';\r\nimport { getRpMult } from '../ui/merchantTabs/labTab.js';\r\nimport { \r\n    RESEARCH_NODES, \r\n    getResearchNodeLevel, \r\n    getResearchNodeRp, \r\n    isResearchNodeActive, \r\n    setResearchNodeLevel, \r\n    setResearchNodeRp\r\n} from './labNodes.js';\r\nimport { AUTOMATION_AREA_KEY, EFFECTIVE_AUTO_COLLECT_ID } from './automationUpgrades.js';\r\nimport { getPassiveCoinReward } from './coinPickup.js';\r\nimport { addXp } from './xpSystem.js';\r\nimport { addMutationPower } from './mutationSystem.js';\r\nimport { getBookProductionRate, isSurgeActive, getEffectiveTsunamiNerf } from './surgeEffects.js';\r\nimport { applyStatMultiplierOverride } from '../util/debugPanel.js';\r\nimport { getXpState } from './xpSystem.js';\r\nimport { getTotalCumulativeMp } from './mutationSystem.js';\r\nimport { computeForgeGoldFromInputs, computeInfuseMagicFromInputs } from '../ui/merchantTabs/resetTab.js';\r\nimport { getLabGoldMultiplier } from './labNodes.js';\r\nimport { bigNumFromLog10 } from '../util/bigNum.js';\r\n\r\nlet initialized = false;\r\n\r\nexport function formatTimeCompact(ms) {\r\n    const msBn = BigNum.fromAny(ms);\r\n    // Constants for time units\r\n    const ONE_SECOND = 1000;\r\n    const ONE_MINUTE = 60 * ONE_SECOND;\r\n    const ONE_HOUR = 60 * ONE_MINUTE;\r\n    const ONE_DAY = 24 * ONE_HOUR;\r\n    const ONE_YEAR = 365 * ONE_DAY;\r\n\r\n    const bnYear = BigNum.fromInt(ONE_YEAR);\r\n    \r\n    // Logic:\r\n    // If < 1 year, keep using standard logic (it cycles through d/h/m/s).\r\n    // If >= 1 year, format years using BigNum formatNumber, and append remaining days.\r\n    \r\n    // Check if ms >= ONE_YEAR\r\n    if (msBn.cmp(bnYear) >= 0) {\r\n        const years = msBn.div(bnYear).floorToInteger();\r\n        // Calculate remaining days: (ms % ONE_YEAR) / ONE_DAY\r\n        // Since BigNum doesn't have modulo, we do: ms - (years * ONE_YEAR)\r\n        const yearsInMs = years.mulBigNumInteger(bnYear);\r\n        const remainingMs = msBn.sub(yearsInMs);\r\n        \r\n        // Days can be calculated safely as a Number since remainingMs < ONE_YEAR (approx 3e10)\r\n        // BigNum -> String -> Number\r\n        let days = 0;\r\n        try {\r\n            const daysBn = remainingMs.div(BigNum.fromInt(ONE_DAY)).floorToInteger();\r\n            days = Number(daysBn.toPlainIntegerString());\r\n        } catch {\r\n            days = 0;\r\n        }\r\n\r\n        return days === 0 ? `${formatNumber(years)}y` : `${formatNumber(years)}y ${days}d`;\r\n    }\r\n\r\n    // Fallback to standard logic for < 1 year (or if ms input is standard number)\r\n    // Convert BigNum to number if safe, otherwise it would have been caught above (unless negative/zero)\r\n    let s_val = 0;\r\n    try {\r\n        if (ms instanceof BigNum) s_val = Number(ms.toPlainIntegerString()) / 1000;\r\n        else s_val = Number(ms) / 1000;\r\n    } catch {\r\n        s_val = 0;\r\n    }\r\n\r\n    const s = Math.floor(s_val);\r\n    if (s < 60) return `${s}s`;\r\n    const m = Math.floor(s / 60);\r\n    const rs = s % 60;\r\n    if (m < 60) return rs === 0 ? `${m}m` : `${m}m ${rs}s`;\r\n    const h = Math.floor(m / 60);\r\n    const rm = m % 60;\r\n    if (h < 24) return rm === 0 ? `${h}h` : `${h}h ${rm}m`;\r\n    const d = Math.floor(h / 24);\r\n    const rh = h % 24;\r\n    return rh === 0 ? `${d}d` : `${d}d ${rh}h`;\r\n}\r\n\r\n// Visual Priority Map\r\nconst PRIORITY_ORDER = [\r\n    { key: 'coins',     icon: 'img/currencies/coin/coin.webp',   singular: 'Coin',     plural: 'Coins' },\r\n    { key: 'xp',        icon: 'img/stats/xp/xp.webp',            singular: 'XP',       plural: 'XP' },\r\n    { key: 'xp_levels', icon: 'img/stats/xp/xp.webp',            singular: 'XP Level', plural: 'XP Levels' },\r\n    { key: 'books',     icon: 'img/currencies/book/book.webp',   singular: 'Book',     plural: 'Books' },\r\n    { key: 'gold',      icon: 'img/currencies/gold/gold.webp',   singular: 'Gold',     plural: 'Gold' },\r\n    { key: 'mp',        icon: 'img/stats/mp/mp.webp',            singular: 'MP',       plural: 'MP' },\r\n    { key: 'mp_levels', icon: 'img/stats/mp/mp.webp',            singular: 'Mutation Level', plural: 'Mutation Levels' },\r\n    { key: 'magic',     icon: 'img/currencies/magic/magic.webp', singular: 'Magic',    plural: 'Magic' },\r\n    { key: 'gears',     icon: 'img/currencies/gear/gear.webp',   singular: 'Gear',     plural: 'Gears' },\r\n    { key: 'waves',     icon: 'img/currencies/gear/gear.webp',   singular: 'Wave',     plural: 'Waves' },\r\n    { key: 'DNA',       icon: 'img/currencies/dna/dna.webp',     singular: 'DNA',      plural: 'DNA' },\r\n    { key: 'research_levels', icon: 'img/stats/rp/rp.webp',      singular: 'Level',    plural: 'Levels' },\r\n];\r\n\r\nexport function showOfflinePanel(rewards, offlineMs, isPreAutomation = false) {\r\n    if (window.__tsunamiActive) return;\r\n\r\n    // Remove existing panel if any\r\n    const existing = document.querySelector('.offline-overlay');\r\n    if (existing) existing.remove();\r\n\r\n    const overlay = document.createElement('div');\r\n    overlay.className = 'offline-overlay';\r\n    \r\n    const panel = document.createElement('div');\r\n    panel.className = 'offline-panel';\r\n    \r\n    const header = document.createElement('div');\r\n    header.className = 'offline-header';\r\n    header.textContent = isPreAutomation ? 'Pre-Automation Offline Gift' : 'Offline Progress';\r\n    \r\n    const subHeader = document.createElement('div');\r\n    subHeader.className = 'offline-subheader';\r\n    subHeader.textContent = `You were gone for ${formatTimeCompact(offlineMs)}`;\r\n\r\n    const contentWrapper = document.createElement('div');\r\n    contentWrapper.className = 'offline-content-wrapper';\r\n\r\n    if (isPreAutomation) {\r\n        const note = document.createElement('div');\r\n        note.className = 'offline-pre-auto-note';\r\n        note.textContent = \"Until you unlock proper automation, Coins have to be collected manually. As a gift to not discourage idle play before unlocking automation, provided below are the rewards from Coins that would have spawned if you were active in the game.\";\r\n        contentWrapper.appendChild(note);\r\n    }\r\n\t\r\n\tconst scrollContainer = document.createElement('div');\r\n    scrollContainer.className = 'offline-scroll-container';\r\n    \r\n    const list = document.createElement('div');\r\n    list.className = 'offline-list';\r\n    \r\n    // Iterate rewards in priority order\r\n    PRIORITY_ORDER.forEach(config => {\r\n        const key = config.key;\r\n        const val = rewards[key];\r\n        if (!val) return;\r\n        if (typeof val.isZero === 'function' && val.isZero()) return;\r\n\r\n        if (key === 'research_levels') {\r\n            if (Array.isArray(val)) {\r\n                val.forEach(item => {\r\n                    const row = document.createElement('div');\r\n                    row.className = 'offline-row';\r\n                    \r\n                    const plus = document.createElement('span');\r\n                    plus.className = 'offline-plus';\r\n                    plus.style.color = '#004F96'; \r\n                    plus.textContent = '+';\r\n                    \r\n                    const icon = document.createElement('img');\r\n                    icon.className = 'offline-icon';\r\n                    icon.src = config.icon;\r\n                    icon.alt = 'RP';\r\n                    \r\n                    const text = document.createElement('span');\r\n                    text.className = 'offline-text';\r\n                    text.style.color = '#004F96';\r\n                    \r\n                    const levelCount = BigNum.fromInt(item.levels);\r\n                    const label = (levelCount.cmp(BigNum.fromInt(1)) === 0) ? 'Level' : 'Levels';\r\n                    text.textContent = `${formatNumber(levelCount)} ${label} of ${item.name}`;\r\n                    \r\n                    row.appendChild(plus);\r\n                    row.appendChild(icon);\r\n                    row.appendChild(text);\r\n                    list.appendChild(row);\r\n                });\r\n            }\r\n            return;\r\n        }\r\n\r\n        const row = document.createElement('div');\r\n        row.className = 'offline-row';\r\n        \r\n        // + Symbol\r\n        const plus = document.createElement('span');\r\n        plus.className = 'offline-plus';\r\n        plus.classList.add(`text-${key}`);\r\n        plus.textContent = '+';\r\n        \r\n        // Icon\r\n        const icon = document.createElement('img');\r\n        icon.className = 'offline-icon';\r\n        icon.src = config.icon;\r\n        icon.alt = key;\r\n        \r\n        // Amount\r\n        const text = document.createElement('span');\r\n        text.className = 'offline-text';\r\n        text.classList.add(`text-${key}`);\r\n        \r\n        // Grammar logic\r\n        let isOne = false;\r\n        if (val instanceof BigNum) {\r\n            isOne = !val.isInfinite() && val.cmp(BigNum.fromInt(1)) === 0;\r\n        } else {\r\n            isOne = (Number(val) === 1);\r\n        }\r\n        \r\n        const displayName = isOne ? config.singular : config.plural;\r\n\r\n        text.innerHTML = `${formatNumber(val)} ${displayName}`;\r\n        \r\n        row.appendChild(plus);\r\n        row.appendChild(icon);\r\n        row.appendChild(text);\r\n        list.appendChild(row);\r\n    });\r\n    \r\n    scrollContainer.appendChild(list);\r\n    contentWrapper.appendChild(scrollContainer);\r\n    \r\n    const actions = document.createElement('div');\r\n    actions.className = 'offline-actions';\r\n    \r\n    const closeBtn = document.createElement('button');\r\n    closeBtn.type = 'button';\r\n    closeBtn.className = 'offline-close-btn'; \r\n    closeBtn.textContent = 'Close';\r\n    \r\n    const closePanel = () => {\r\n        overlay.remove();\r\n        // No need to resumeGameLoop() here as we didn't pause it\r\n    };\r\n\r\n    closeBtn.addEventListener('click', closePanel);\r\n    overlay.addEventListener('click', (e) => {\r\n        if (e.target === overlay) closePanel();\r\n    });\r\n    \r\n    actions.appendChild(closeBtn);\r\n    \r\n    panel.appendChild(header);\r\n    panel.appendChild(subHeader);\r\n    panel.appendChild(contentWrapper);\r\n    panel.appendChild(actions);\r\n    \r\n    overlay.appendChild(panel);\r\n    document.body.appendChild(overlay);\r\n    \r\n    requestAnimationFrame(() => {\r\n        ensureCustomScrollbar(panel, contentWrapper, '.offline-scroll-container');\r\n    });\r\n    \r\n    return overlay;\r\n}\r\n\r\n// Helper to calculate research cost locally to avoid state dependency issues during simulation\r\nfunction getSimulatedReq(node, level) {\r\n    if (level >= node.maxLevel) return BigNum.fromAny('Infinity');\r\n    const log10Scale = Math.log10(node.scale); \r\n    const log10Base = Math.log10(node.baseRpReq);\r\n    const totalLog10 = log10Base + (level * log10Scale);\r\n    const intPart = Math.floor(totalLog10);\r\n    const fracPart = totalLog10 - intPart;\r\n    const mantissa = Math.pow(10, fracPart);\r\n    return new BigNum(BigInt(Math.round(mantissa * 1e14)), { base: intPart, offset: -14n });\r\n}\r\n\r\nexport function calculateOfflineRewards(seconds) {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) return {};\r\n\r\n    // Convert seconds to BigNum to handle both normal offline progress and massive OP Time Warps\r\n    const secondsBn = BigNum.fromAny(seconds);\r\n    const rewards = {};\r\n\r\n    // --- Research Lab Progress ---\r\n    const rpMult = getRpMult ? getRpMult() : BigNum.fromInt(0);\r\n    if (rpMult && !rpMult.isZero()) {\r\n        const totalRp = rpMult.mulBigNumInteger(secondsBn);\r\n        \r\n        const activeNodes = RESEARCH_NODES.filter(n => isResearchNodeActive(n.id));\r\n        const researchLevels = [];\r\n        const researchProgress = {};\r\n\r\n        for (const node of activeNodes) {\r\n             let tempLevel = getResearchNodeLevel(node.id);\r\n             let tempRp = getResearchNodeRp(node.id).add(totalRp);\r\n             let levelsGained = 0;\r\n             const maxLevel = node.maxLevel;\r\n\r\n             while (tempLevel < maxLevel) {\r\n                 const req = getSimulatedReq(node, tempLevel);\r\n                 if (req.isInfinite && req.isInfinite()) break;\r\n                 if (tempRp.cmp(req) < 0) break;\r\n                 \r\n                 tempRp = tempRp.sub(req);\r\n                 tempLevel++;\r\n                 levelsGained++;\r\n             }\r\n             \r\n             if (levelsGained > 0) {\r\n                 researchLevels.push({ name: node.title, levels: levelsGained });\r\n             }\r\n             // Always store progress (RP update) even if no levels gained\r\n             researchProgress[node.id] = { level: tempLevel, rp: tempRp };\r\n        }\r\n        \r\n        if (researchLevels.length > 0) rewards.research_levels = researchLevels;\r\n        if (Object.keys(researchProgress).length > 0) rewards.research_progress = researchProgress;\r\n    }\r\n    // -----------------------------\r\n\r\n    const gearRate = getGearsProductionRate ? getGearsProductionRate() : BigNum.fromInt(0);\r\n    \r\n    // Update: use BigNum multiplication for accuracy with large inputs\r\n    // mulBigNumInteger is correct because we are effectively multiplying rate * time\r\n    const gearsEarned = gearRate.mulBigNumInteger(secondsBn).floorToInteger();\r\n    \r\n    if (!gearsEarned.isZero()) {\r\n        if (!isCurrencyLocked('gears', slot)) {\r\n            rewards.gears = gearsEarned;\r\n        }\r\n    }\r\n\r\n    // Books (Surge 3)\r\n    const bookRate = getBookProductionRate ? getBookProductionRate() : BigNum.fromInt(0);\r\n    if (!bookRate.isZero()) {\r\n        const booksEarned = bookRate.mulBigNumInteger(secondsBn).floorToInteger();\r\n        if (!booksEarned.isZero()) {\r\n            if (!isCurrencyLocked('books', slot)) {\r\n                rewards.books = booksEarned;\r\n            }\r\n        }\r\n    }\r\n\r\n    // Surge 13 (Gold) and Surge 16 (Magic)\r\n    if (isSurgeActive(13) || isSurgeActive(16)) {\r\n        const effectiveNerf = getEffectiveTsunamiNerf();\r\n        const mapped = effectiveNerf * 1.5 - 0.5;\r\n        const log10Rate = 2 * mapped - 2;\r\n        const rateMultiplier = bigNumFromLog10(log10Rate);\r\n        const totalMultiplier = rateMultiplier.mulDecimal(String(seconds));\r\n\r\n        if (isSurgeActive(13)) {\r\n             const coins = bank.coins?.value;\r\n             const xpState = getXpState();\r\n             const basePending = computeForgeGoldFromInputs(coins, xpState.xpLevel);\r\n             let pending = bank.gold?.mult?.applyTo?.(basePending) ?? basePending;\r\n             const labMult = getLabGoldMultiplier();\r\n             pending = pending.mulDecimal(labMult.toScientific());\r\n             \r\n             const goldEarned = pending.mulDecimal(totalMultiplier.toScientific());\r\n             if (goldEarned.cmp(0) > 0 && !isCurrencyLocked('gold', slot)) {\r\n                 rewards.gold = goldEarned;\r\n             }\r\n        }\r\n\r\n        if (isSurgeActive(16)) {\r\n             const coins = bank.coins?.value;\r\n             const cumulativeMp = getTotalCumulativeMp();\r\n             const pending = computeInfuseMagicFromInputs(coins, cumulativeMp);\r\n             \r\n             const magicEarned = pending.mulDecimal(totalMultiplier.toScientific());\r\n             if (magicEarned.cmp(0) > 0 && !isCurrencyLocked('magic', slot)) {\r\n                 rewards.magic = magicEarned;\r\n             }\r\n        }\r\n    }\r\n\r\n    const autoLevel = getLevelNumber(AUTOMATION_AREA_KEY, EFFECTIVE_AUTO_COLLECT_ID) || 0;\r\n    if (autoLevel > 0) {\r\n        // Update: use BigNum to calculate totalPassives safely\r\n        let multiplier = 1;\r\n        if (isSurgeActive(2)) {\r\n             multiplier = 10;\r\n        }\r\n\r\n        const totalPassives = BigNum.fromInt(autoLevel)\r\n            .mulBigNumInteger(secondsBn)\r\n            .mulBigNumInteger(BigNum.fromInt(multiplier))\r\n            .floorToInteger();\r\n        \r\n        if (!totalPassives.isZero()) {\r\n            const singleReward = getPassiveCoinReward();\r\n            const coinsEarned = singleReward.coins.mulBigNumInteger(totalPassives);\r\n            const xpEarned = singleReward.xp.mulBigNumInteger(totalPassives);\r\n            const mpEarned = singleReward.mp.mulBigNumInteger(totalPassives);\r\n            \r\n            if (!coinsEarned.isZero()) {\r\n                if (!isCurrencyLocked('coins', slot)) {\r\n                    rewards.coins = coinsEarned;\r\n                }\r\n            }\r\n            if (!xpEarned.isZero()) {\r\n                if (!isStorageKeyLocked(`ccc:xp:progress:${slot}`)) {\r\n                    rewards.xp = xpEarned;\r\n                }\r\n            }\r\n            if (!mpEarned.isZero()) {\r\n                if (!isStorageKeyLocked(`ccc:mutation:progress:${slot}`)) {\r\n                    rewards.mp = mpEarned;\r\n                }\r\n            }\r\n        }\r\n    }\r\n    return rewards;\r\n}\r\n\r\nexport function grantOfflineRewards(rewards) {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) return;\r\n    \r\n    // Handle special systems (XP, MP)\r\n    if (rewards.xp) {\r\n         try {\r\n            const xpResult = addXp(rewards.xp);\r\n            if (xpResult) {\r\n                if (xpResult.xpLevelsGained && !xpResult.xpLevelsGained.isZero()) {\r\n                    rewards.xp_levels = xpResult.xpLevelsGained;\r\n                }\r\n                if (xpResult.xpAdded) {\r\n                    rewards.xp = xpResult.xpAdded;\r\n                }\r\n            }\r\n        } catch {}\r\n    }\r\n    if (rewards.mp) {\r\n        try {\r\n            const mpResult = addMutationPower(rewards.mp);\r\n            if (mpResult) {\r\n                if (mpResult.levelsGained && !mpResult.levelsGained.isZero()) {\r\n                    rewards.mp_levels = mpResult.levelsGained;\r\n                }\r\n                if (mpResult.delta) {\r\n                    rewards.mp = mpResult.delta;\r\n                }\r\n            }\r\n        } catch {}\r\n    }\r\n\r\n    // Handle Research\r\n    if (rewards.research_progress) {\r\n        for (const [idStr, data] of Object.entries(rewards.research_progress)) {\r\n             const nodeId = parseInt(idStr, 10);\r\n             if (!isNaN(nodeId)) {\r\n                 setResearchNodeLevel(nodeId, data.level);\r\n                 setResearchNodeRp(nodeId, data.rp);\r\n             }\r\n        }\r\n    }\r\n\r\n    // Handle standard currencies automatically\r\n    for (const key of Object.keys(rewards)) {\r\n        // Skip special keys handled above or created during handling\r\n        if (key === 'xp' || key === 'mp' || key === 'xp_levels' || key === 'mp_levels') continue;\r\n        if (key === 'research_levels' || key === 'research_progress') continue;\r\n        \r\n        if (bank[key] && typeof bank[key].add === 'function') {\r\n            bank[key].add(rewards[key]);\r\n        }\r\n    }\r\n}\r\n\r\nexport function calculatePreAutomationRewards(seconds) {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) return {};\r\n\r\n    const secondsBn = BigNum.fromAny(seconds);\r\n    const rewards = {};\r\n    const areaKey = getUpgAreaKey();\r\n    let spawnRate = BigNum.fromInt(1);\r\n\r\n    try {\r\n        const eff = computeUpgradeEffects(areaKey);\r\n        if (eff && eff.coinsPerSecondMult) {\r\n            spawnRate = BigNum.fromAny(eff.coinsPerSecondMult);\r\n        }\r\n    } catch (e) {\r\n        console.error('Offline rewards calc error:', e);\r\n        spawnRate = BigNum.fromInt(1);\r\n    }\r\n\r\n    if (typeof applyStatMultiplierOverride === 'function') {\r\n        const override = applyStatMultiplierOverride('spawnRate', spawnRate);\r\n        try {\r\n             spawnRate = BigNum.fromAny(override);\r\n        } catch {}\r\n    }\r\n\r\n    // Update: use BigNum multiplication\r\n    const totalCoins = spawnRate.mulBigNumInteger(secondsBn).floorToInteger();\r\n\r\n    if (!totalCoins.isZero()) {\r\n        const singleReward = getPassiveCoinReward();\r\n        const coinsEarned = singleReward.coins.mulBigNumInteger(totalCoins);\r\n        const xpEarned = singleReward.xp.mulBigNumInteger(totalCoins);\r\n        const mpEarned = singleReward.mp.mulBigNumInteger(totalCoins);\r\n\r\n        if (!coinsEarned.isZero()) {\r\n             rewards.coins = coinsEarned;\r\n        }\r\n        if (!xpEarned.isZero()) {\r\n            if (!isStorageKeyLocked(`ccc:xp:progress:${slot}`)) {\r\n                rewards.xp = xpEarned;\r\n            }\r\n        }\r\n        if (!mpEarned.isZero()) {\r\n            if (!isStorageKeyLocked(`ccc:mutation:progress:${slot}`)) {\r\n                rewards.mp = mpEarned;\r\n            }\r\n        }\r\n    }\r\n    return rewards;\r\n}\r\n\r\nexport function processOfflineProgress() {\r\n    // 1. Ensure we are actually in a save slot (prevent Main Menu triggers)\r\n    const slot = getActiveSlot();\r\n    if (slot == null) {\r\n        return; \r\n    }\r\n\r\n    const lastSave = getLastSaveTime();\r\n    const now = Date.now();\r\n    \r\n    if (lastSave <= 0) return;\r\n\r\n    // Detect reverse time travel (user changed clock back after saving in future)\r\n    // Tolerance of 10 seconds to avoid drift issues\r\n    if (now < lastSave - 10000) {\r\n        markSaveSlotModified(slot);\r\n        return;\r\n    }\r\n    \r\n    const diff = now - lastSave;\r\n    if (diff < 1000) return; // Ignore gaps < 1s\r\n    \r\n    const seconds = diff / 1000;\r\n\r\n    if (!hasDoneInfuseReset()) {\r\n        const rewards = calculatePreAutomationRewards(seconds);\r\n        const hasRewards = Object.keys(rewards).length > 0;\r\n        \r\n        if (hasRewards) {\r\n            grantOfflineRewards(rewards);\r\n            showOfflinePanel(rewards, diff, true);\r\n        }\r\n        return hasRewards;\r\n    }\r\n\r\n    const rewards = calculateOfflineRewards(seconds);\r\n    const hasRewards = Object.keys(rewards).length > 0;\r\n    \r\n    if (hasRewards) {\r\n        grantOfflineRewards(rewards);\r\n        showOfflinePanel(rewards, diff);\r\n    }\r\n    return hasRewards;\r\n}\r\n\r\nexport function initOfflineTracker(checkActiveState, onReward) {\r\n    if (initialized) return;\r\n    initialized = true;\r\n    \r\n    document.addEventListener('visibilitychange', () => {\r\n        const slot = getActiveSlot();\r\n        if (slot == null) return; // Ignore visibility changes on main menu\r\n\r\n        if (checkActiveState && !checkActiveState()) return;\r\n\r\n        if (document.hidden) {\r\n            pauseGameLoop();\r\n        } else {\r\n            // Resume first, then process logic\r\n            resumeGameLoop();\r\n            const rewarded = processOfflineProgress();\r\n            if (rewarded && typeof onReward === 'function') {\r\n                onReward();\r\n            }\r\n        }\r\n    });\r\n}\r\nwindow.createOfflinePanel = showOfflinePanel;\r\n", "import { getActiveSlot } from '../../util/storage.js';\r\nimport { formatTimeCompact, calculateOfflineRewards, grantOfflineRewards, showOfflinePanel } from '../../game/offlinePanel.js';\r\nimport { playAudio } from '../../util/audioManager.js';\r\n\r\nconst WARP_CHARGES_KEY = (slot) => `ccc:warp:charges:${slot}`;\r\nconst WARP_LAST_CHARGE_KEY = (slot) => `ccc:warp:lastCharge:${slot}`;\r\n\r\nconst MAX_WARPS = 24;\r\nconst CHARGE_TIME_MS = 60 * 60 * 1000; // 1 hour\r\nconst WARP_DURATION_SEC = 150; // 2 minutes 30 seconds\r\n\r\n// const warpSfx = createSfxPlayer({ src: 'sounds/warp.ogg', mobileVolume: 0.5, desktopVolume: 0.5 });\r\nconst WARP_SFX_SRC = 'sounds/warp.ogg';\r\n\r\nlet warpTabPanel = null;\r\nlet updateTimer = null;\r\n\r\nfunction getWarpState(slot) {\r\n    let charges = 24;\r\n    let lastCharge = Date.now();\r\n    \r\n    try {\r\n        const c = localStorage.getItem(WARP_CHARGES_KEY(slot));\r\n        if (c !== null) charges = parseInt(c, 10);\r\n        \r\n        const l = localStorage.getItem(WARP_LAST_CHARGE_KEY(slot));\r\n        if (l !== null) lastCharge = parseInt(l, 10);\r\n        else if (c === null) {\r\n             // First time init: 24 charges.\r\n             try {\r\n                localStorage.setItem(WARP_CHARGES_KEY(slot), '24');\r\n                localStorage.setItem(WARP_LAST_CHARGE_KEY(slot), String(lastCharge));\r\n            } catch {}\r\n        }\r\n    } catch {}\r\n    \r\n    return { charges, lastCharge };\r\n}\r\n\r\nfunction saveWarpState(slot, charges, lastCharge) {\r\n    try {\r\n        localStorage.setItem(WARP_CHARGES_KEY(slot), String(charges));\r\n        localStorage.setItem(WARP_LAST_CHARGE_KEY(slot), String(lastCharge));\r\n    } catch {}\r\n}\r\n\r\nexport function checkWarpRecharge() {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) return;\r\n    \r\n    let { charges, lastCharge } = getWarpState(slot);\r\n    \r\n    if (charges >= MAX_WARPS) return; // Full\r\n    \r\n    const now = Date.now();\r\n    const elapsed = now - lastCharge;\r\n    \r\n    if (elapsed >= CHARGE_TIME_MS) {\r\n        const gained = Math.floor(elapsed / CHARGE_TIME_MS);\r\n        charges += gained;\r\n        if (charges >= MAX_WARPS) {\r\n            charges = MAX_WARPS;\r\n            lastCharge = now; // Reset timer if full\r\n        } else {\r\n            lastCharge += gained * CHARGE_TIME_MS; // Advance timer by consumed intervals\r\n        }\r\n        saveWarpState(slot, charges, lastCharge);\r\n        // Force update UI if visible\r\n        if (warpTabPanel && warpTabPanel.classList.contains('is-active')) {\r\n             updateWarpTab(true); // pass flag to avoid infinite recursion if I called check inside update\r\n        }\r\n    }\r\n}\r\n\r\nfunction triggerWarpVisuals() {\r\n    const overlay = document.createElement('div');\r\n    overlay.className = 'warp-overlay';\r\n    document.body.appendChild(overlay);\r\n\r\n    // Stage 2: Harsh distortion (3s)\r\n    setTimeout(() => {\r\n        overlay.classList.add('stage-2');\r\n    }, 3000);\r\n\r\n    // End (7.25s)\r\n    setTimeout(() => {\r\n        overlay.remove();\r\n    }, 7250);\r\n}\r\n\r\nfunction performWarp() {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) return;\r\n    \r\n    checkWarpRecharge(); // Ensure state is up to date first\r\n\r\n    let { charges, lastCharge } = getWarpState(slot);\r\n    \r\n    if (charges <= 0) return;\r\n    \r\n    // If we are at MAX, we start the timer now\r\n    if (charges >= MAX_WARPS) {\r\n        // Offset by 50ms so the timer starts at 59m 59s instead of 1h\r\n        lastCharge = Date.now() - 50;\r\n    }\r\n    \r\n    charges--;\r\n    saveWarpState(slot, charges, lastCharge);\r\n    \r\n    updateWarpTab(true);\r\n    \r\n    // Reset timer loop to synchronize tick with click\r\n    if (updateTimer) clearInterval(updateTimer);\r\n    updateTimer = setInterval(() => {\r\n        updateWarpTab();\r\n    }, 1000);\r\n    \r\n    // warpSfx.play();\r\n    playAudio(WARP_SFX_SRC, { volume: 0.5 });\r\n    \r\n    triggerWarpVisuals();\r\n    \r\n    setTimeout(() => {\r\n        const rewards = calculateOfflineRewards(WARP_DURATION_SEC);\r\n        grantOfflineRewards(rewards);\r\n        showOfflinePanel(rewards, WARP_DURATION_SEC * 1000);\r\n    }, 7250);\r\n}\r\n\r\nexport function updateWarpTab(skipRechargeCheck = false) {\r\n    if (!warpTabPanel) return;\r\n    // We update even if not active? No, waste of resources.\r\n    // But timer needs to update if active.\r\n    if (!warpTabPanel.classList.contains('is-active')) return;\r\n    \r\n    const slot = getActiveSlot();\r\n    if (slot == null) return;\r\n    \r\n    if (!skipRechargeCheck) checkWarpRecharge();\r\n    \r\n    const { charges, lastCharge } = getWarpState(slot);\r\n    \r\n    const counterEl = warpTabPanel.querySelector('.warp-counter');\r\n    if (counterEl) {\r\n        counterEl.innerHTML = `Warps remaining: <span class=\"text-cyan\">${charges} / ${MAX_WARPS}</span>`;\r\n    }\r\n    \r\n    const timerEl = warpTabPanel.querySelector('.warp-timer');\r\n    if (timerEl) {\r\n        if (charges >= MAX_WARPS) {\r\n            timerEl.style.visibility = 'hidden';\r\n        } else {\r\n            timerEl.style.visibility = 'visible';\r\n            const now = Date.now();\r\n            const nextCharge = lastCharge + CHARGE_TIME_MS;\r\n            const diff = Math.max(0, nextCharge - now);\r\n            timerEl.textContent = `Next warp in ${formatTimeCompact(diff)}`;\r\n        }\r\n    }\r\n    \r\n    const btn = warpTabPanel.querySelector('.warp-btn');\r\n    if (btn) {\r\n        btn.disabled = charges <= 0;\r\n    }\r\n}\r\n\r\nexport function initWarpTab(panel) {\r\n    if (!panel || panel.__warpInit) return;\r\n    panel.__warpInit = true;\r\n    warpTabPanel = panel;\r\n    \r\n    panel.innerHTML = `<div class=\"warp-tab\"><h3 class=\"warp-title\">Warp</h3><div class=\"warp-desc\"><p>Click the Warp button below to instantly gain <span class=\"text-cyan\">2m 30s</span> of offline progress when you want to speed something up</p><p>Warp length will never be increased because it's intended to be a small boost</p><p>Use your Warps wisely as they only recharge once every hour</p></div><div class=\"warp-status\"><div class=\"warp-timer\">Next warp in: 60m</div><div class=\"warp-counter\">Warps remaining: <span class=\"text-cyan\">24 / 24</span></div></div><button type=\"button\" class=\"warp-btn\">Warp</button></div>`;\r\n    \r\n    const btn = panel.querySelector('.warp-btn');\r\n    btn.addEventListener('click', performWarp);\r\n    \r\n    // Start update loop\r\n    if (!updateTimer) {\r\n        updateTimer = setInterval(() => {\r\n            updateWarpTab();\r\n        }, 1000);\r\n    }\r\n    \r\n    updateWarpTab();\r\n}\r\n", "// js/ui/merchantTabs/dlgTab.js\r\nimport {\r\n  bank,\r\n  getActiveSlot,\r\n  watchStorageKey,\r\n  primeStorageWatcherSnapshot,\r\n} from '../../util/storage.js';\r\nimport { BigNum } from '../../util/bigNum.js';\r\nimport { MERCHANT_DIALOGUES } from '../../misc/merchantDialogues.js';\r\nimport { getXpState, isXpSystemUnlocked } from '../../game/xpSystem.js';\r\nimport { initResetPanel, initResetSystem, updateResetPanel, isForgeUnlocked, hasDoneForgeReset, hasDoneInfuseReset, hasDoneSurgeReset, isSurgeUnlocked, getCurrentSurgeLevel } from './resetTab.js';\r\nimport { initWorkshopTab, updateWorkshopTab } from './workshopTab.js';\r\nimport { initWarpTab, updateWarpTab } from './warpTab.js';\r\nimport { initLabTab, updateLabTab, hasVisitedLab } from './labTab.js';\r\nimport { getTsunamiSequenceSeen } from '../../game/surgeEffects.js';\r\nimport { blockInteraction, updateShopOverlay, closeDelveSpecificOverlays } from '../shopOverlay.js';\r\nimport {\r\n  shouldSkipGhostTap,\r\n  suppressNextGhostTap,\r\n} from '../../util/ghostTapGuard.js';\r\nimport { IS_MOBILE } from '../../main.js';\r\nimport { playAudio, setMusicUnderwater } from '../../util/audioManager.js';\r\n\r\nfunction nowMs() {\r\n  if (typeof performance !== 'undefined' && typeof performance.now === 'function') {\r\n    return performance.now();\r\n  }\r\n  return Date.now();\r\n}\r\n\r\nconst MERCHANT_ICON_SRC = 'img/misc/merchant.webp';\r\nconst MERCHANT_MET_KEY_BASE  = 'ccc:merchantMet';\r\nconst MERCHANT_TAB_KEY_BASE  = 'ccc:merchantTab';\r\nexport const MERCHANT_DLG_STATE_KEY_BASE = 'ccc:merchant:dlgState';\r\nexport const MERCHANT_MET_EVENT = 'ccc:merchant:met';\r\nconst sk = (base) => `${base}:${getActiveSlot()}`;\r\n\r\nexport function hasMetMerchant() {\r\n  try {\r\n    return localStorage.getItem(sk(MERCHANT_MET_KEY_BASE)) === '1';\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\n\r\nconst JEFF_UNLOCK_KEY_BASE = 'ccc:unlock:jeff';\r\n\r\nexport function isJeffUnlocked() {\r\n  try {\r\n    return localStorage.getItem(sk(JEFF_UNLOCK_KEY_BASE)) === '1';\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\nexport function setJeffUnlocked(value) {\r\n  const slot = getActiveSlot();\r\n  if (slot == null) return;\r\n  const key = `${JEFF_UNLOCK_KEY_BASE}:${slot}`;\r\n  const normalized = !!value;\r\n  try {\r\n    localStorage.setItem(key, normalized ? '1' : '0');\r\n    updateMerchantNameInUI();\r\n  } catch {}\r\n}\r\n\r\nfunction getMerchantName() {\r\n  return isJeffUnlocked() ? 'Jeff' : 'Merchant';\r\n}\r\n\r\nfunction updateMerchantNameInUI() {\r\n  const name = getMerchantName();\r\n  \r\n  if (merchantOverlayEl) {\r\n    const modalNames = merchantOverlayEl.querySelectorAll('.merchant-firstchat:not(.merchant-firstchat--initial) .merchant-firstchat__header .name');\r\n    modalNames.forEach((modalName) => {\r\n      if (modalName && (modalName.textContent === 'Merchant' || modalName.textContent === 'Jeff')) {\r\n        modalName.textContent = name;\r\n      }\r\n    });\r\n  }\r\n}\r\n\r\n\r\nconst MERCHANT_TABS_DEF = [\r\n  { key: 'dialogue',  label: 'Dialogue', unlocked: true },\r\n  { key: 'reset',     label: 'Reset',    unlocked: false, lockedLabel: '???' },\r\n  { key: 'workshop',  label: 'Workshop', unlocked: false, lockedLabel: '???' },\r\n  { key: 'warp',     label: 'Warp',    unlocked: false, lockedLabel: '???' },\r\n  { key: 'lab',      label: 'Lab',     unlocked: false, lockedLabel: '???' },\r\n];\r\n\r\nconst merchantTabUnlockState = new Map([\r\n  ['dialogue', true],\r\n  ['reset', false],\r\n  ['workshop', false],\r\n  ['warp', false],\r\n  ['lab', false],\r\n]);\r\n\r\nconst REWARD_ICON_SRC = {\r\n  coins: 'img/currencies/coin/coin.webp',\r\n  books: 'img/currencies/book/book.webp',\r\n  gold: 'img/currencies/gold/gold.webp',\r\n  magic: 'img/currencies/magic/magic.webp',\r\n};\r\n\r\nconst MYSTERIOUS_ICON_SRC = 'img/misc/mysterious.webp';\r\nconst HIDDEN_DIALOGUE_TITLE = 'Hidden Dialogue';\r\nconst LOCKED_DIALOGUE_TITLE = 'Locked Dialogue';\r\nconst DEFAULT_MYSTERIOUS_BLURB = 'Hidden Dialogue';\r\nconst DEFAULT_LOCKED_BLURB = 'Locked';\r\nconst DEFAULT_LOCK_MESSAGE = 'Locked Dialogue';\r\nconst DIALOGUE_STATUS_ORDER = { locked: 0, mysterious: 1, unlocked: 2 };\r\nconst FORGE_COMPLETED_KEY_BASE = 'ccc:reset:forge:completed';\r\n\r\nconst HAS_POINTER_EVENTS = typeof window !== 'undefined' && 'PointerEvent' in window;\r\nconst HAS_TOUCH_EVENTS = !HAS_POINTER_EVENTS && typeof window !== 'undefined' && 'ontouchstart' in window;\r\n\r\nfunction bindRapidActivation(target, handler, { once = false } = {}) {\r\n  if (!target || typeof handler !== 'function') return () => {};\r\n  let used = false;\r\n  let pointerTriggered = false;\r\n  let activePointerId = null;\r\n\r\n  const run = (event) => {\r\n    if (once && used) return;\r\n    if (event?.type === 'click' && event.isTrusted && shouldSkipGhostTap(target)) {\r\n      event.preventDefault?.();\r\n      return;\r\n    }\r\n    // markGhostTapTarget removed - global handler manages clicks\r\n    used = once ? true : used;\r\n    Promise.resolve(handler(event)).catch((e) => console.error(e));\r\n    if (once) cleanup();\r\n  };\r\n\r\n  const resetPointerTrigger = () => {\r\n    pointerTriggered = false;\r\n    activePointerId = null;\r\n  };\r\n\r\n  const onClick = (event) => {\r\n    // Simplified logic: Allow synthetic events (from ghostTapGuard) to pass through.\r\n    // The previous check blocked them because pointerTriggered was true during the synthetic click\r\n    // (which happens inside the pointerdown event dispatch on touch devices).\r\n    if (pointerTriggered) {\r\n      resetPointerTrigger();\r\n    }\r\n    run(event);\r\n  };\r\n\r\nconst onPointerDown = (event) => {\r\n  if (event.pointerType === 'mouse') return;\r\n  if (typeof event.button === 'number' && event.button !== 0) return;\r\n  pointerTriggered = true;\r\n  activePointerId = typeof event.pointerId === 'number' ? event.pointerId : null;\r\n  suppressNextGhostTap(160);\r\n};\r\n\r\n  const onPointerUp = (event) => {\r\n    if (!pointerTriggered) return;\r\n    if (activePointerId != null && typeof event.pointerId === 'number' && event.pointerId !== activePointerId) {\r\n      return;\r\n    }\r\n    resetPointerTrigger();\r\n    // run(event) removed here to prevent double-firing if global handler also triggers click\r\n    // or if standard click follows. Let 'click' event handle execution.\r\n  };\r\n\r\n  const onPointerCancel = () => {\r\n    if (!pointerTriggered) return;\r\n    resetPointerTrigger();\r\n  };\r\n\r\nconst onTouchStart = (event) => {\r\n  pointerTriggered = true;\r\n  suppressNextGhostTap(160);\r\n};\r\n\r\n  const onTouchEnd = (event) => {\r\n    if (!pointerTriggered) return;\r\n    resetPointerTrigger();\r\n    // run(event) removed here as well\r\n  };\r\n\r\n  const onTouchCancel = () => {\r\n    if (!pointerTriggered) return;\r\n    resetPointerTrigger();\r\n  };\r\n\r\n  const cleanup = () => {\r\n    target.removeEventListener('click', onClick);\r\n    if (HAS_POINTER_EVENTS) {\r\n      target.removeEventListener('pointerdown', onPointerDown);\r\n      window.removeEventListener('pointerup', onPointerUp);\r\n      window.removeEventListener('pointercancel', onPointerCancel);\r\n    } else if (HAS_TOUCH_EVENTS) {\r\n      target.removeEventListener('touchstart', onTouchStart);\r\n      window.removeEventListener('touchend', onTouchEnd);\r\n      window.removeEventListener('touchcancel', onTouchCancel);\r\n    }\r\n  };\r\n\r\n  target.addEventListener('click', onClick);\r\n  \r\n  return () => { target.removeEventListener('click', onClick); };\r\n}\r\n\r\nfunction dialogueStatusRank(status) {\r\n  return DIALOGUE_STATUS_ORDER[status] ?? 0;\r\n}\r\n\r\nfunction snapshotLockDisplay(info) {\r\n  if (!info || typeof info !== 'object') return null;\r\n  return {\r\n    title: info.title ?? null,\r\n    blurb: info.blurb ?? null,\r\n    tooltip: info.tooltip ?? null,\r\n    message: info.message ?? null,\r\n    icon: info.icon ?? null,\r\n    headerTitle: info.headerTitle ?? null,\r\n    ariaLabel: info.ariaLabel ?? null,\r\n  };\r\n}\r\n\r\nfunction buildUnlockedDialogueInfo(meta) {\r\n  return {\r\n    status: 'unlocked',\r\n    unlocked: true,\r\n    title: meta.title,\r\n    blurb: meta.blurb,\r\n    tooltip: '',\r\n    message: '',\r\n    icon: null,\r\n    headerTitle: null,\r\n    ariaLabel: meta.title || 'Merchant dialogue',\r\n  };\r\n}\r\n\r\nlet progressEventsBound = false;\r\nlet merchantDlgWatcherInitialized = false;\r\nlet forgeUnlockListenerBound = false;\r\n\r\nfunction setMerchantTabUnlocked(key, unlocked) {\r\n  const def = MERCHANT_TABS_DEF.find(t => t.key === key);\r\n  if (!def) return;\r\n\r\n  const lockedLabel = def.lockedLabel || '???';\r\n  const normalized = !!unlocked;\r\n  merchantTabUnlockState.set(key, normalized);\r\n  def.unlocked = normalized;\r\n\r\n  const btn = merchantTabs.buttons[key];\r\n  if (btn) {\r\n    btn.disabled = !normalized;\r\n    btn.classList.toggle('is-locked', !normalized);\r\n    btn.textContent = normalized ? def.label : lockedLabel;\r\n    btn.title = normalized ? (def.label || 'Tab') : '???';\r\n  }\r\n\r\n  if (!normalized && merchantTabs.buttons[key]?.classList.contains('is-active')) {\r\n    selectMerchantTab('dialogue');\r\n  }\r\n}\r\n\r\nfunction syncForgeTabUnlockState() {\r\n  let unlocked = false;\r\n  try { unlocked = !!isForgeUnlocked?.(); }\r\n  catch {}\r\n  setMerchantTabUnlocked('reset', unlocked);\r\n}\r\n\r\nfunction syncWorkshopTabUnlockState() {\r\n  let unlocked = false;\r\n  try { unlocked = !!hasDoneInfuseReset?.(); }\r\n  catch {}\r\n  setMerchantTabUnlocked('workshop', unlocked);\r\n}\r\n\r\nfunction syncWarpTabUnlockState() {\r\n  let unlocked = false;\r\n  try {\r\n    if (typeof hasDoneSurgeReset === 'function') {\r\n      unlocked = hasDoneSurgeReset();\r\n    }\r\n  } catch {}\r\n  setMerchantTabUnlocked('warp', unlocked);\r\n}\r\n\r\nconst LAB_UNLOCK_KEY = (slot) => `ccc:unlock:lab:${slot}`;\r\n\r\nfunction isLabUnlocked() {\r\n  const slot = getActiveSlot();\r\n  if (slot == null) return false;\r\n  try {\r\n    if (typeof getTsunamiSequenceSeen === 'function' && getTsunamiSequenceSeen()) return true;\r\n    return localStorage.getItem(LAB_UNLOCK_KEY(slot)) === '1';\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\nfunction syncLabTabUnlockState() {\r\n  setMerchantTabUnlocked('lab', isLabUnlocked());\r\n}\r\n\r\nlet merchantDlgWatcherSlot = null;\r\nlet merchantDlgWatcherCleanup = null;\r\n\r\nfunction bigNumToSafeInteger(value) {\r\n  if (value && typeof value === 'object') {\r\n    if (typeof value.toPlainIntegerString === 'function') {\r\n      try {\r\n        const plain = value.toPlainIntegerString();\r\n        if (plain != null) {\r\n          const parsed = Number.parseInt(plain, 10);\r\n          if (Number.isFinite(parsed)) return parsed;\r\n        }\r\n      } catch {}\r\n    }\r\n    if (typeof value.toString === 'function') {\r\n      try {\r\n        const str = value.toString();\r\n        if (str != null) {\r\n          const parsed = Number.parseInt(str, 10);\r\n          if (Number.isFinite(parsed)) return parsed;\r\n        }\r\n      } catch {}\r\n    }\r\n  }\r\n\r\n  const numeric = Number(value);\r\n  if (!Number.isFinite(numeric)) return 0;\r\n  if (numeric <= 0) return 0;\r\n  return Math.floor(numeric);\r\n}\r\n\r\nfunction getPlayerProgress() {\r\n  const progress = {\r\n    xpUnlocked: false,\r\n    xpLevel: 0,\r\n    hasForgeReset: false,\r\n  };\r\n\r\n  try {\r\n    progress.xpUnlocked = typeof isXpSystemUnlocked === 'function' && isXpSystemUnlocked();\r\n  } catch {\r\n    progress.xpUnlocked = false;\r\n  }\r\n\r\n  if (progress.xpUnlocked) {\r\n    try {\r\n      const state = typeof getXpState === 'function' ? getXpState() : null;\r\n      if (state && typeof state === 'object') {\r\n        progress.xpLevel = bigNumToSafeInteger(state.xpLevel);\r\n      }\r\n    } catch {\r\n      progress.xpLevel = 0;\r\n    }\r\n  }\r\n  \r\n  try {\r\n    progress.hasForgeReset = typeof hasDoneForgeReset === 'function' && hasDoneForgeReset();\r\n  } catch {\r\n    progress.hasForgeReset = false;\r\n  }\r\n\r\n  try {\r\n    progress.hasInfuseReset = typeof hasDoneInfuseReset === 'function' && hasDoneInfuseReset();\r\n  } catch {\r\n    progress.hasInfuseReset = false;\r\n  }\r\n  \r\n  return progress;\r\n}\r\n\r\nfunction resolveDialogueLock(meta, progress) {\r\n  let rawState;\r\n  try {\r\n    rawState = typeof meta.unlock === 'function' ? meta.unlock(progress) : true;\r\n  } catch {\r\n    rawState = false;\r\n  }\r\n\r\n  const rawObj = (rawState && typeof rawState === 'object') ? rawState : null;\r\n  let status = 'locked';\r\n\r\n  if (rawState === true) {\r\n    status = 'unlocked';\r\n  } else if (rawObj) {\r\n    const normalized = String(rawObj.status ?? '').toLowerCase();\r\n    if (normalized === 'unlocked' || rawObj.unlocked === true) {\r\n      status = 'unlocked';\r\n    } else if (normalized === 'mysterious') {\r\n      status = 'mysterious';\r\n    } else {\r\n      status = 'locked';\r\n    }\r\n  } else if (rawState === false || rawState == null) {\r\n    status = 'locked';\r\n  }\r\n\r\n  const info = {\r\n    status,\r\n    unlocked: status === 'unlocked',\r\n    title: status === 'unlocked' ? meta.title : '???',\r\n    blurb: status === 'unlocked'\r\n      ? meta.blurb\r\n      : (status === 'mysterious' ? DEFAULT_MYSTERIOUS_BLURB : DEFAULT_LOCKED_BLURB),\r\n    tooltip: '',\r\n    message: '',\r\n    icon: null,\r\n    headerTitle: null,\r\n    ariaLabel: '',\r\n  };\r\n\r\n  if (status === 'unlocked') {\r\n    info.ariaLabel = meta.title || 'Merchant dialogue';\r\n    return info;\r\n  }\r\n\r\ninfo.title = rawObj?.title ?? '???'\r\ninfo.blurb = rawObj?.requirement\r\n  ?? rawObj?.message\r\n  ?? rawObj?.tooltip\r\n  ?? (status === 'mysterious' ? DEFAULT_MYSTERIOUS_BLURB : DEFAULT_LOCKED_BLURB)\r\ninfo.tooltip = rawObj?.tooltip\r\n  ?? (status === 'locked' ? 'Locked Dialogue' : 'Hidden Dialogue');\r\n\r\ninfo.message = rawObj?.message ?? (status === 'mysterious' ? DEFAULT_LOCK_MESSAGE : '');\r\ninfo.icon = rawObj?.icon ?? (status === 'mysterious' ? MYSTERIOUS_ICON_SRC : null);\r\ninfo.headerTitle = rawObj?.headerTitle ?? (status === 'mysterious' ? HIDDEN_DIALOGUE_TITLE : LOCKED_DIALOGUE_TITLE);\r\ninfo.ariaLabel = rawObj?.ariaLabel ?? (status === 'mysterious'\r\n  ? 'Hidden merchant dialogue'\r\n  : 'Locked merchant dialogue');\r\n\r\n\r\n  return info;\r\n}\r\n\r\nfunction ensureProgressEvents() {\r\n  if (progressEventsBound) return;\r\n  progressEventsBound = true;\r\n\r\n  const handler = onProgressChanged;\r\n\r\n  if (typeof window !== 'undefined') {\r\n    window.addEventListener('xp:change', handler);\r\n    window.addEventListener('xp:unlock', handler);\r\n    window.addEventListener('forge:completed', (event) => {\r\n      const detailSlot = event?.detail?.slot;\r\n      if (detailSlot != null && detailSlot !== getActiveSlot()) return;\r\n      handler();\r\n    });\r\n    window.addEventListener('unlock:change', handler);\r\n    window.addEventListener('debug:change', handler);\r\n    window.addEventListener('surge:level:change', handler);\r\n  }\r\n\r\n  document.addEventListener('ccc:upgrades:changed', handler);\r\n\r\n  const slot = getActiveSlot();\r\n  if (slot != null) {\r\n    const key = `${FORGE_COMPLETED_KEY_BASE}:${slot}`;\r\n    watchStorageKey(key, { onChange: handler });\r\n  }\r\n}\r\n\r\nfunction onProgressChanged() {\r\n  renderDialogueList();\r\n}\r\n\r\nfunction completeDialogueOnce(id, meta) {\r\n  const state = loadDlgState();\r\n  const k = String(id);\r\n  const prev = state[k] || {};\r\n\r\n  if (meta.once && prev.claimed) return false;\r\n\r\n  prev.claimed = true;\r\n  state[k] = prev;\r\n  saveDlgState(state);\r\n\r\n  grantReward(meta.reward);\r\n  return true;\r\n}\r\n\r\n\r\nfunction grantReward(reward) {\r\n  if (!reward) return;\r\n\r\n  if (reward.type === 'coins') {\r\n    try {\r\n      bank.coins.add(reward.amount);\r\n    } catch (e) {\r\n      console.warn('Failed to grant coin reward:', reward, e);\r\n    }\r\n    return;\r\n  }\r\n\r\n  if (reward.type === 'books') {\r\n    try {\r\n      bank.books.addWithMultiplier?.(reward.amount) ?? bank.books.add(reward.amount);\r\n    } catch (e) {\r\n      console.warn('Failed to grant book reward:', reward, e);\r\n    }\r\n    return;\r\n  }\r\n\r\n  if (reward.type === 'gold') {\r\n    try {\r\n      bank.gold.add(reward.amount);\r\n    } catch (e) {\r\n      console.warn('Failed to grant gold reward:', reward, e);\r\n    }\r\n    return;\r\n  }\r\n\r\n  if (reward.type === 'magic') {\r\n    try {\r\n      bank.magic.add(reward.amount);\r\n    } catch (e) {\r\n      console.warn('Failed to grant magic reward:', reward, e);\r\n    }\r\n    return;\r\n  }\r\n\r\n  try {\r\n    window.dispatchEvent(new CustomEvent('merchantReward', { detail: reward }));\r\n  } catch {}\r\n}\r\n\r\nfunction rewardLabel(reward) {\r\n  if (!reward) return '';\r\n  if (reward.type === 'coins') return `Reward: ${reward.amount} coins`;\r\n  if (reward.type === 'books') return `Reward: ${reward.amount} Books`;\r\n  if (reward.type === 'gold')  return `Reward: ${reward.amount} Gold`;\r\n  return 'Reward available';\r\n}\r\n\r\nexport const DLG_CATALOG = {\r\n  1: {\r\n    title: 'A Generous Gift',\r\n    blurb: 'The Merchant is feeling extra nice today',\r\n    scriptId: 1,\r\n    reward: { type: 'coins', amount: 100 },\r\n    unlock: (progress) => true,\r\n    once: true,\r\n  },\r\n  2: {\r\n    title: 'A New Experience',\r\n    blurb: 'Discuss the XP system with the Merchant',\r\n    scriptId: 2,\r\n    reward: { type: 'books', amount: 5 },\r\n    once: true,\r\n    unlock: (progress) => {\r\n      if (!progress?.xpUnlocked) {\r\n        return {\r\n          status: 'mysterious',\r\n          requirement: 'Unlock the XP system to reveal this dialogue',\r\n          message: 'Unlock the XP system to reveal this dialogue',\r\n          icon: MYSTERIOUS_ICON_SRC,\r\n          headerTitle: HIDDEN_DIALOGUE_TITLE,\r\n          ariaLabel: 'Hidden merchant dialogue, unlock the XP system to reveal this dialogue',\r\n        };\r\n      }\r\n      return true;\r\n    },\r\n  },\r\n  3: {\r\n    title: 'A Golden Opportunity',\r\n    blurb: 'Ask the Merchant a few questions about the Forge',\r\n    scriptId: 3,\r\n    reward: { type: 'gold', amount: 10 },\r\n    once: true,\r\n    unlock: (progress) => {\r\n      if (progress?.hasForgeReset) {\r\n        return true;\r\n      }\r\n\r\n      if (!progress?.xpUnlocked || (progress?.xpLevel ?? 0) < 31) {\r\n        return {\r\n          status: 'locked',\r\n          title: '???',\r\n          blurb: DEFAULT_LOCKED_BLURB,\r\n          tooltip: 'Locked Dialogue',\r\n          ariaLabel: 'Locked Dialogue',\r\n        };\r\n      }\r\n\r\n      return {\r\n        status: 'mysterious',\r\n        requirement: 'Do a Forge reset to reveal this dialogue',\r\n        message: 'Do a Forge reset to reveal this dialogue',\r\n        icon: MYSTERIOUS_ICON_SRC,\r\n        headerTitle: HIDDEN_DIALOGUE_TITLE,\r\n        ariaLabel: 'Hidden merchant dialogue, do a Forge reset to reveal this dialogue',\r\n      };\r\n    },\r\n  },\r\n  5: {\r\n    title: 'A Strange Surge',\r\n    blurb: 'Discuss the Surge with the Merchant',\r\n    scriptId: 5,\r\n    reward: { type: 'coins', amount: 2 },\r\n    once: true,\r\n    unlock: (progress) => {\r\n      if (typeof hasDoneSurgeReset === 'function' && hasDoneSurgeReset()) {\r\n        return true;\r\n      }\r\n      if (!progress?.xpUnlocked || (progress?.xpLevel ?? 0) < 201) {\r\n        return {\r\n          status: 'locked',\r\n          title: '???',\r\n          blurb: 'Locked',\r\n          tooltip: 'Locked Dialogue',\r\n          ariaLabel: 'Locked Dialogue',\r\n        };\r\n      }\r\n      return {\r\n        status: 'mysterious',\r\n        requirement: 'Do a Surge reset to reveal this dialogue',\r\n        message: 'Do a Surge reset to reveal this dialogue',\r\n        icon: MYSTERIOUS_ICON_SRC,\r\n        headerTitle: HIDDEN_DIALOGUE_TITLE,\r\n        ariaLabel: 'Hidden merchant dialogue, do a Surge reset to reveal this dialogue',\r\n      };\r\n    },\r\n  },\r\n  6: {\r\n    title: 'The Empty Lab',\r\n    blurb: 'Ask about the Lab',\r\n    scriptId: 6,\r\n    reward: { type: 'coins', amount: 2 },\r\n    once: true,\r\n    unlock: (progress) => {\r\n      if (typeof getTsunamiSequenceSeen === 'function' && getTsunamiSequenceSeen()) {\r\n        return true;\r\n      }\r\n\r\n      const surgeLevel = typeof getCurrentSurgeLevel === 'function' ? getCurrentSurgeLevel() : 0n;\r\n      let isSurge8 = false;\r\n      if (surgeLevel === Infinity) isSurge8 = true;\r\n      else if (typeof surgeLevel === 'bigint') isSurge8 = surgeLevel >= 8n;\r\n      else if (typeof surgeLevel === 'number') isSurge8 = surgeLevel >= 8;\r\n\r\n      if (isSurge8) {\r\n        return true;\r\n      }\r\n\r\n      if (typeof hasDoneSurgeReset === 'function' && hasDoneSurgeReset()) {\r\n        return {\r\n          status: 'mysterious',\r\n          requirement: 'Reach Surge 8 to reveal this dialogue',\r\n          message: 'Reach Surge 8 to reveal this dialogue',\r\n          icon: MYSTERIOUS_ICON_SRC,\r\n          headerTitle: HIDDEN_DIALOGUE_TITLE,\r\n          ariaLabel: 'Hidden merchant dialogue, reach Surge 8 to reveal this dialogue',\r\n        };\r\n      }\r\n      \r\n      return {\r\n        status: 'locked',\r\n        title: '???',\r\n        blurb: 'Locked',\r\n        tooltip: 'Locked Dialogue',\r\n        ariaLabel: 'Locked Dialogue',\r\n      };\r\n    },\r\n  },\r\n  4: {\r\n    title: 'A Magic Touch',\r\n    blurb: 'Learn about the Merchant\u2019s magical powers',\r\n    scriptId: 4,\r\n    reward: { type: 'magic', amount: 10 },\r\n    once: true,\r\n    unlock: (progress) => {\r\n      if (progress?.hasInfuseReset) return true;\r\n      if (!progress?.xpUnlocked || (progress?.xpLevel ?? 0) < 101) {\r\n        return {\r\n          status: 'locked',\r\n          title: '???',\r\n          blurb: 'Locked',\r\n          tooltip: 'Locked Dialogue',\r\n          ariaLabel: 'Locked Dialogue',\r\n        };\r\n      }\r\n      return {\r\n        status: 'mysterious',\r\n        requirement: 'Do an Infuse reset to reveal this dialogue',\r\n        message: 'Do an Infuse reset to reveal this dialogue',\r\n        icon: MYSTERIOUS_ICON_SRC,\r\n        headerTitle: HIDDEN_DIALOGUE_TITLE,\r\n        ariaLabel: 'Hidden merchant dialogue, do an Infuse reset to reveal this dialogue',\r\n      };\r\n    },\r\n  },\r\n};\r\n\r\nexport function loadDlgState() {\r\n  try { return JSON.parse(localStorage.getItem(sk(MERCHANT_DLG_STATE_KEY_BASE)) || '{}'); } catch { return {}; }\r\n}\r\n\r\nexport function saveDlgState(s) {\r\n  const key = sk(MERCHANT_DLG_STATE_KEY_BASE);\r\n  try {\r\n    const payload = JSON.stringify(s);\r\n    localStorage.setItem(key, payload);\r\n    try { primeStorageWatcherSnapshot(key, payload); } catch {}\r\n  } catch {}\r\n}\r\n\r\nfunction parseDlgStateRaw(raw) {\r\n  if (!raw) return {};\r\n  try { return JSON.parse(raw); } catch { return {}; }\r\n}\r\n\r\nfunction cleanupMerchantDlgStateWatcher() {\r\n  const stop = merchantDlgWatcherCleanup;\r\n  merchantDlgWatcherCleanup = null;\r\n  if (typeof stop === 'function') {\r\n    try { stop(); } catch {}\r\n  }\r\n}\r\n\r\nfunction handleMerchantDlgStateChange(_, meta = {}) {\r\n  if (!meta?.rawChanged) return;\r\n  renderDialogueList();\r\n}\r\n\r\nfunction bindMerchantDlgStateWatcherForSlot(slot) {\r\n  if (slot === merchantDlgWatcherSlot) return;\r\n  cleanupMerchantDlgStateWatcher();\r\n  merchantDlgWatcherSlot = slot ?? null;\r\n  if (slot == null) {\r\n    renderDialogueList();\r\n    return;\r\n  }\r\n  const storageKey = `${MERCHANT_DLG_STATE_KEY_BASE}:${slot}`;\r\n  merchantDlgWatcherCleanup = watchStorageKey(storageKey, {\r\n    parse: parseDlgStateRaw,\r\n    onChange: handleMerchantDlgStateChange,\r\n  });\r\n  try { primeStorageWatcherSnapshot(storageKey); } catch {}\r\n  renderDialogueList();\r\n}\r\n\r\nfunction ensureMerchantDlgStateWatcher() {\r\n  if (merchantDlgWatcherInitialized) {\r\n    bindMerchantDlgStateWatcherForSlot(getActiveSlot());\r\n    return;\r\n  }\r\n  merchantDlgWatcherInitialized = true;\r\n  bindMerchantDlgStateWatcherForSlot(getActiveSlot());\r\n  if (typeof window !== 'undefined') {\r\n    window.addEventListener('saveSlot:change', () => {\r\n      bindMerchantDlgStateWatcherForSlot(getActiveSlot());\r\n    });\r\n  }\r\n}\r\n\r\nensureMerchantDlgStateWatcher();\r\n\r\n// ----- Module state -----\r\nlet merchantOverlayEl = null;\r\nlet merchantSheetEl   = null;\r\nlet merchantCloseBtn  = null;\r\nlet merchantOpen      = false;\r\nlet merchantDrag      = null;\r\nlet merchantLastFocus = null;\r\nlet merchantEventsBound = false;\r\nlet merchantTabs = { buttons: {}, panels: {}, tablist: null };\r\n\r\n// ========================= Typing SFX =========================\r\nconst TYPING_SFX_SRC = 'sounds/merchant_typing.ogg';\r\nlet activeTypingAudio = null;\r\nlet __isTypingActive = false;\r\n\r\n// Kept for signature compatibility\r\nexport function setTypingGainForDevice() {} \r\n\r\nexport function primeTypingSfx() {\r\n    import('../../util/audioManager.js').then(({ loadAudio }) => {\r\n        loadAudio(TYPING_SFX_SRC);\r\n    });\r\n}\r\n\r\nfunction startTypingSfx() {\r\n    if (activeTypingAudio) return;\r\n    \r\n    const vol = IS_MOBILE ? 0.15 : 0.3;\r\n    activeTypingAudio = playAudio(TYPING_SFX_SRC, { \r\n        volume: vol,\r\n        loop: true \r\n    });\r\n}\r\n\r\nfunction stopTypingSfx() {\r\n    if (activeTypingAudio) {\r\n        if (activeTypingAudio.stop) activeTypingAudio.stop();\r\n        activeTypingAudio = null;\r\n    }\r\n}\r\n\r\n// ========================= Typewriter =========================\r\nfunction typeText(el, full, msPerChar = 22, skipTargets = []) {\r\n  return new Promise((resolve) => {\r\n    // Basic HTML parser for typewriter\r\n    const segments = [];\r\n    let currentText = '';\r\n    let inTag = false;\r\n    \r\n    for (let i = 0; i < full.length; i++) {\r\n        const char = full[i];\r\n        if (char === '<') {\r\n            if (currentText) {\r\n                segments.push({ type: 'text', content: currentText });\r\n                currentText = '';\r\n            }\r\n            inTag = true;\r\n            currentText += char;\r\n        } else if (char === '>' && inTag) {\r\n            currentText += char;\r\n            segments.push({ type: 'tag', content: currentText });\r\n            currentText = '';\r\n            inTag = false;\r\n        } else {\r\n            currentText += char;\r\n        }\r\n    }\r\n    if (currentText) {\r\n        segments.push({ type: inTag ? 'tag' : 'text', content: currentText });\r\n    }\r\n\r\n    let segIndex = 0;\r\n    let charIndex = 0;\r\n    let skipping = false;\r\n    let armed = false;\r\n    let buffer = '';\r\n\r\n    __isTypingActive = true;\r\n    startTypingSfx();\r\n\r\n    const skip = (e) => { if (!armed) return; e.preventDefault(); skipping = true; };\r\n    const onKey = (e) => { if (!armed) return; if (e.key === 'Enter' || e.key === ' ') skipping = true; };\r\n\r\n    const targets = skipTargets.length ? skipTargets : [el];\r\n\r\n    requestAnimationFrame(() => {\r\n      armed = true;\r\n      targets.forEach(t => t.addEventListener('click', skip, { once: true }));\r\n      document.addEventListener('keydown', onKey, { once: true });\r\n      });\r\n\r\n      el.classList.add('is-typing');\r\n      el.innerHTML = '';\r\n\r\n      const cleanup = () => {\r\n      targets.forEach(t => t.removeEventListener('click', skip));\r\n      document.removeEventListener('keydown', onKey);\r\n      el.classList.remove('is-typing');\r\n      stopTypingSfx();\r\n      __isTypingActive = false;\r\n      };\r\n\r\n      const tick = () => {\r\n      if (skipping) {\r\n          el.innerHTML = full;\r\n          cleanup();\r\n          resolve();\r\n          return;\r\n      }\r\n      \r\n      if (segIndex >= segments.length) {\r\n          cleanup();\r\n          resolve();\r\n          return;\r\n      }\r\n\r\n      const seg = segments[segIndex];\r\n      \r\n      if (seg.type === 'tag') {\r\n          buffer += seg.content;\r\n          el.innerHTML = buffer;\r\n          segIndex++;\r\n          tick();\r\n      } else {\r\n          // Type text char by char\r\n          buffer += seg.content[charIndex];\r\n          el.innerHTML = buffer;\r\n          charIndex++;\r\n          \r\n          if (charIndex >= seg.content.length) {\r\n              segIndex++;\r\n              charIndex = 0;\r\n          }\r\n          setTimeout(tick, msPerChar);\r\n      }\r\n      };\r\n      tick();\r\n  });\r\n}\r\n\r\n// ========================= DialogueEngine =========================\r\nclass DialogueEngine {\r\n  constructor({ textEl, choicesEl, skipTargets, onEnd, onChoice }) {\r\n      this.textEl = textEl;\r\n      this.choicesEl = choicesEl;\r\n      this.skipTargets = skipTargets;\r\n      this.onEnd = onEnd || (() => {});\r\n      this.onChoice = onChoice;\r\n      this.nodes = {};\r\n      this.current = null;\r\n\r\n      this.deferNextChoices = false;\r\n      this._reservedH = 0;\r\n  }\r\n\r\n  load(script) {\r\n      this.nodes = script.nodes || {};\r\n      this.startId = script.start;\r\n  }\r\n\r\n  async start() {\r\n      if (!this.startId) return;\r\n      await this.goto(this.startId);\r\n  }\r\n\r\n  async goto(id) {\r\n      const node = this.nodes[id];\r\n      if (!node) return;\r\n      this.current = id;\r\n\r\n      if (node.type === 'line') {\r\n      const nextNode = this.nodes[node.next];\r\n\r\n      // Pre-render next choices invisibly to reserve height (unless deferring)\r\n      if (!this.deferNextChoices && nextNode && nextNode.type === 'choice') {\r\n        this._renderChoices(nextNode.options || [], true);\r\n      } else {\r\n        this._hideChoices();\r\n      }\r\n\r\n      await typeText(this.textEl, node.say, node.msPerChar ?? 22, this.skipTargets);\r\n\r\n      if (nextNode && nextNode.type === 'choice') {\r\n        this.current = node.next;\r\n\r\n        if (this.deferNextChoices) {\r\n          this.deferNextChoices = false;\r\n          this._renderChoices(nextNode.options || [], false); // build & reveal now\r\n          this.choicesEl.style.minHeight = '';\r\n          return;\r\n        }\r\n\r\n        this._revealPreparedChoices();\r\n        return;\r\n      }\r\n\r\n      this.choicesEl.style.minHeight = '';\r\n      if (node.next === 'end' || node.end === true) return this.onEnd();\r\n      if (node.next) return this.goto(node.next);\r\n      return;\r\n      }\r\n\r\n      if (node.type === 'choice') {\r\n      this._renderChoices(node.options || [], false);\r\n      }\r\n  }\r\n\r\n  _hideChoices() {\r\n      this.choicesEl.classList.remove('is-visible');\r\n      this._applyInlineChoiceHide();\r\n  }\r\n\r\n  _renderChoices(options, prepare = false) {\r\n      this.choicesEl.innerHTML = '';\r\n      for (const opt of options) {\r\n      const btn = document.createElement('button');\r\n      btn.type = 'button';\r\n      btn.className = 'choice';\r\n      btn.textContent = opt.label;\r\n      const unbind = bindRapidActivation(btn, async (event) => {\r\n        event?.stopPropagation?.();\r\n        this.onChoice?.(this.current, opt);\r\n        this._reservedH = this.choicesEl.offsetHeight | 0;\r\n        this.choicesEl.style.minHeight = this._reservedH + 'px';\r\n        this._hideChoices();\r\n        this.choicesEl.innerHTML = '';\r\n\r\n        this.deferNextChoices = true;\r\n\r\n        if (opt.to === 'end') {\r\n          return this.onEnd({ noReward: false });\r\n        }\r\n        if (opt.to === 'end_nr') {\r\n          return this.onEnd({ noReward: true });\r\n        }\r\n\r\n        await this.goto(opt.to);\r\n      }, { once: true });\r\n      this.choicesEl.appendChild(btn);\r\n      }\r\n\r\n      if (prepare) {\r\n      this.choicesEl.classList.remove('is-visible');\r\n      this._applyInlineChoiceHide();\r\n      return;\r\n      }\r\n      this._clearInlineChoiceHide();\r\n      requestAnimationFrame(() => this.choicesEl.classList.add('is-visible'));\r\n  }\r\n\r\n  _revealPreparedChoices() {\r\n      this._clearInlineChoiceHide();\r\n      requestAnimationFrame(() => this.choicesEl.classList.add('is-visible'));\r\n  }\r\n\r\n  _applyInlineChoiceHide() {\r\n      this.choicesEl.style.opacity = '0';\r\n      this.choicesEl.style.transform = 'translateY(6px)';\r\n      this.choicesEl.style.pointerEvents = 'none';\r\n  }\r\n\r\n  _clearInlineChoiceHide() {\r\n      this.choicesEl.style.opacity = '';\r\n      this.choicesEl.style.transform = '';\r\n      this.choicesEl.style.pointerEvents = '';\r\n  }\r\n}\r\n\r\nfunction openDialogueLockInfo(lockInfo = {}) {\r\n  if (!merchantOverlayEl) return;\r\n\r\n  primeTypingSfx();\r\n\r\n  const overlay = document.createElement('div');\r\n  overlay.className = 'merchant-firstchat merchant-lockinfo';\r\n  overlay.setAttribute('data-dismissible', '1');\r\n  overlay.innerHTML = `<div class=\"merchant-firstchat__card\" role=\"dialog\" aria-label=\"${lockInfo.ariaLabel || HIDDEN_DIALOGUE_TITLE}\"><div class=\"merchant-firstchat__header\"><div class=\"name\"></div><div class=\"rule\" aria-hidden=\"true\"></div></div><div class=\"merchant-firstchat__row merchant-lockinfo__row\"><img class=\"merchant-firstchat__icon\" src=\"${lockInfo.icon || MYSTERIOUS_ICON_SRC}\" alt=\"\"><div class=\"merchant-firstchat__text merchant-lockinfo__message\"></div></div><div class=\"merchant-firstchat__actions merchant-lockinfo__actions\"><button type=\"button\" class=\"merchant-firstchat__continue merchant-lockinfo__close\">Close</button></div></div>`;\r\n\r\n  merchantOverlayEl.appendChild(overlay);\r\n\r\n  const cardEl = overlay.querySelector('.merchant-firstchat__card');\r\n  const nameEl = overlay.querySelector('.merchant-firstchat__header .name');\r\n  const messageEl = overlay.querySelector('.merchant-lockinfo__message');\r\n  const closeBtn = overlay.querySelector('.merchant-lockinfo__close');\r\n\r\n  nameEl.textContent = lockInfo.headerTitle || HIDDEN_DIALOGUE_TITLE;\r\n  messageEl.textContent = lockInfo.message || DEFAULT_LOCK_MESSAGE;\r\n\r\n  requestAnimationFrame(() => overlay.classList.add('is-visible'));\r\n  merchantOverlayEl.classList.add('firstchat-active');\r\n\r\n  let closed = false;\r\n\r\n  const close = () => {\r\n      if (closed) return;\r\n      closed = true;\r\n      overlay.classList.remove('is-visible');\r\n      merchantOverlayEl.classList.remove('firstchat-active');\r\n      stopTypingSfx();\r\n      __isTypingActive = false;\r\n      document.removeEventListener('keydown', onEsc, true);\r\n      setTimeout(() => overlay.remove(), 160);\r\n  };\r\n\r\n  const onEsc = (e) => {\r\n      if (e.key !== 'Escape') return;\r\n      e.preventDefault();\r\n      close();\r\n  };\r\n\r\n  document.addEventListener('keydown', onEsc, true);\r\n\r\noverlay.addEventListener('pointerdown', (e) => {\r\n  if (!cardEl.contains(e.target)) {\r\n      // Don\u2019t arm global ghost guard for background taps \u2014 just shield briefly\r\n      e.preventDefault();\r\n      blockInteraction(160);\r\n      close();\r\n  }\r\n});\r\n\r\nconst doCloseFromBtn = (e) => {\r\n  if (!e || e.pointerType !== 'mouse') blockInteraction(160);\r\n  close();\r\n};\r\n\r\n  bindRapidActivation(closeBtn, () => { doCloseFromBtn(); }, { once: true });\r\n\r\n  closeBtn.focus?.();\r\n}\r\n\r\nfunction openDialogueModal(id, meta) {\r\n  primeTypingSfx();\r\n\r\n  let scriptId = meta.scriptId;\r\n  if (String(id) === '6' && typeof hasVisitedLab === 'function' && !hasVisitedLab()) {\r\n      scriptId = 7;\r\n  }\r\n  setMusicUnderwater(true);\r\n\r\n  const overlay = document.createElement('div');\r\n  overlay.className = 'merchant-firstchat';\r\n  overlay.setAttribute('data-dismissible', '1');\r\n  overlay.innerHTML = `<div class=\"merchant-firstchat__card\" role=\"dialog\" aria-label=\"${meta.title}\"><div class=\"merchant-firstchat__header\"><div class=\"name\">${getMerchantName()}</div><div class=\"rule\" aria-hidden=\"true\"></div></div><div class=\"merchant-firstchat__row\"><img class=\"merchant-firstchat__icon\" src=\"${MERCHANT_ICON_SRC}\" alt=\"\"><div class=\"merchant-firstchat__text\">\u2026</div></div><div class=\"merchant-firstchat__choices\"></div></div>`;\r\n  merchantOverlayEl.appendChild(overlay);\r\nconst onEscToCancel = (e) => {\r\n  if (e.key !== 'Escape') return;\r\n  if (!overlay.isConnected) return;\r\n  cancelWithoutReward();\r\n};\r\n\r\ndocument.addEventListener('keydown', onEscToCancel, { capture: true });\r\n\r\n\r\n  // fade/blur in (same behavior as first meet)\r\n  requestAnimationFrame(() => overlay.classList.add('is-visible'));\r\n  merchantOverlayEl.classList.add('firstchat-active');\r\n\r\n  // local refs\r\n  const textEl    = overlay.querySelector('.merchant-firstchat__text');\r\n  const rowEl     = overlay.querySelector('.merchant-firstchat__row');\r\n  const cardEl    = overlay.querySelector('.merchant-firstchat__card');\r\n  const choicesEl = overlay.querySelector('.merchant-firstchat__choices');\r\n\r\n  let ended = false;\r\n\r\n  // Close helpers \u2014 end (with reward) vs cancel (no reward)\r\n  const closeModal = () => {\r\n      setMusicUnderwater(false);\r\n\tdocument.removeEventListener('keydown', onEscToCancel, { capture: true });\r\n      overlay.classList.remove('is-visible');\r\n      merchantOverlayEl.classList.remove('firstchat-active');\r\n      stopTypingSfx();\r\n      __isTypingActive = false;\r\n      overlay.remove();\r\n  };\r\n\r\n  const cancelWithoutReward = () => {\r\n      if (ended) return;\r\n      ended = true;\r\n      closeModal();               // no reward\r\n      renderDialogueList();       // refresh UI state\r\n  };\r\n\r\noverlay.addEventListener('pointerdown', (e) => {\r\n  if (!cardEl.contains(e.target)) {\r\n      e.preventDefault();\r\n      if (e.pointerType !== 'mouse') blockInteraction(160);\r\n      cancelWithoutReward();\r\n  }\r\n});\r\n\r\nconst engine = new DialogueEngine({\r\n  textEl,\r\n  choicesEl,\r\n  skipTargets: [textEl, rowEl, cardEl],\r\n      onChoice: (nodeId, opt) => {\r\n      if (meta.scriptId === 4 && nodeId === 'c4b') {\r\n        setJeffUnlocked(true);\r\n      }\r\n      },\r\n  onEnd: (info) => {\r\n      if (ended) return;\r\n      ended = true;\r\n\r\n      if (info && info.noReward) {\r\n      renderDialogueList();\r\n      closeModal();\r\n      return;\r\n      }\r\n\r\n      completeDialogueOnce(id, meta);\r\n      renderDialogueList();\r\n      closeModal();\r\n  }\r\n});\r\n\r\n  const state = loadDlgState();\r\n  const claimed = !!state[id]?.claimed;\r\n\r\n  const script = structuredClone(MERCHANT_DIALOGUES[scriptId]);\r\n\r\n  if (claimed && script.nodes.m2b && script.nodes.c2a && meta.scriptId === 1) {\r\n      script.nodes.m2b.say = 'I\\'ve already given you Coins, goodbye.';\r\n      script.nodes.c2a.options = [\r\n      { label: 'Goodbye.', to: 'end_nr' },\r\n      { label: 'Goodbye.', to: 'end_nr' },\r\n      { label: 'Goodbye.', to: 'end_nr' },\r\n      ];\r\n  }\r\n\r\n  if (claimed && meta.scriptId === 2 && script.nodes.m3a) {\r\n      script.nodes.m3a.say = 'I\\'ve already given you Books, goodbye.';\r\n\tif (script.nodes.c2a) {\r\n      script.nodes.c2a.options = [\r\n        { label: 'Goodbye.', to: 'end_nr' },\r\n        { label: 'Goodbye.', to: 'end_nr' },\r\n        { label: 'Goodbye.', to: 'end_nr' },\r\n      ];\r\n      }\r\n  }\r\n  \r\n  if (claimed && meta.scriptId === 3 && script.nodes.m5a) {\r\n      script.nodes.m5a.say = 'I\\'ve already given you Gold, goodbye.';\r\n      if (script.nodes.c5a) {\r\n      script.nodes.c5a.options = [\r\n        { label: 'Goodbye.', to: 'end_nr' },\r\n        { label: 'Goodbye.', to: 'end_nr' },\r\n        { label: 'Goodbye.', to: 'end_nr' },\r\n      ];\r\n      }\r\n  }\r\n\r\n  if (claimed && meta.scriptId === 4 && script.nodes.m7a) {\r\n      script.nodes.m7a.say = 'I\\'ve already given you Magic, goodbye.';\r\n      if (script.nodes.c7a) {\r\n      script.nodes.c7a.options = [\r\n        { label: 'Goodbye.', to: 'end_nr' },\r\n        { label: 'Goodbye.', to: 'end_nr' },\r\n        { label: 'Goodbye.', to: 'end_nr' },\r\n      ];\r\n      }\r\n  }\r\n\r\n  engine.load(script);\r\n  engine.start();\r\n}\r\n\r\n// ========================= Delve Menu =========================\r\nconst SCROLL_TIMELINE_STYLES_ID = 'ccc-scroll-timeline-styles';\r\nfunction injectScrollTimelineStyles() {\r\n  if (document.getElementById(SCROLL_TIMELINE_STYLES_ID)) return;\r\n  const style = document.createElement('style');\r\n  style.id = SCROLL_TIMELINE_STYLES_ID;\r\n  style.textContent = `\r\n      @keyframes scroll-thumb-move {\r\n      0% { transform: translate(0, 0); }\r\n      100% { transform: translate(var(--thumb-x, 0), var(--thumb-y, 0)); }\r\n      }\r\n  `;\r\n  document.head.appendChild(style);\r\n}\r\n\r\nfunction ensureMerchantScrollbar() {\r\n  const scroller = merchantOverlayEl?.querySelector('.merchant-content');\r\n  if (!scroller || scroller.__customScroll) return;\r\n  if (!merchantSheetEl) return;\r\n\r\n  const bar = document.createElement('div');\r\n  bar.className = 'merchant-scrollbar';\r\n  const thumb = document.createElement('div');\r\n  thumb.className = 'merchant-scrollbar__thumb';\r\n  bar.appendChild(thumb);\r\n  merchantSheetEl.appendChild(bar);\r\n\r\n  const isTouch = window.matchMedia?.('(hover: none) and (pointer: coarse)')?.matches;\r\n  const FADE_SCROLL_MS = 150;\r\n  const FADE_DRAG_MS = 120;\r\n  const supportsScrollEnd = 'onscrollend' in window;\r\n  let fadeTimer = null;\r\n\r\n  // --- Scroll-Driven Animation Support Check ---\r\n  const supportsTimelineScope = CSS.supports('timeline-scope', 'none');\r\n  const useCssTimeline = supportsTimelineScope && CSS.supports('animation-timeline', 'scroll()');\r\n\r\n  if (useCssTimeline) {\r\n      injectScrollTimelineStyles();\r\n      const uniqueId = Math.random().toString(36).slice(2, 8);\r\n      const timelineName = `--merchant-scroll-${uniqueId}`;\r\n    \r\n      merchantSheetEl.style.timelineScope = timelineName;\r\n      scroller.style.scrollTimelineName = timelineName;\r\n      scroller.style.scrollTimelineAxis = 'block'; // Merchant only has vertical\r\n    \r\n      thumb.style.animationName = 'scroll-thumb-move';\r\n      thumb.style.animationTimeline = timelineName;\r\n      thumb.style.animationDuration = '1ms';\r\n      thumb.style.animationTimingFunction = 'linear';\r\n      thumb.style.animationFillMode = 'both';\r\n  }\r\n\r\n  let lastShadow = null;\r\n  const syncScrollShadow = () => {\r\n      const hasShadow = (scroller.scrollTop || 0) > 0;\r\n      if (lastShadow === hasShadow) return;\r\n      lastShadow = hasShadow;\r\n      merchantSheetEl?.classList.toggle('has-scroll-shadow', hasShadow);\r\n  };\r\n\r\n  const updateBounds = () => {\r\n      const grabber = merchantOverlayEl.querySelector('.merchant-grabber');\r\n      const header  = merchantOverlayEl.querySelector('.merchant-header');\r\n      const actions = merchantOverlayEl.querySelector('.merchant-actions');\r\n\r\n      const top = ((grabber?.offsetHeight || 0) + (header?.offsetHeight || 0)) | 0;\r\n      const bottom = (actions?.offsetHeight || 0) | 0;\r\n\r\n      bar.style.top = top + 'px';\r\n      bar.style.bottom = bottom + 'px';\r\n  };\r\n\r\n  let lastState = {};\r\n  const updateThumb = () => {\r\n      const { scrollHeight, clientHeight, scrollTop } = scroller;\r\n      const barH = bar.clientHeight || scroller.clientHeight || 1;\r\n\r\n      if (\r\n        lastState.scrollHeight === scrollHeight &&\r\n        lastState.clientHeight === clientHeight &&\r\n        lastState.barH === barH &&\r\n        (useCssTimeline || lastState.scrollTop === scrollTop)\r\n      ) {\r\n        return;\r\n      }\r\n      lastState = { scrollHeight, clientHeight, scrollTop, barH };\r\n\r\n      const visibleRatio = clientHeight / Math.max(1, scrollHeight);\r\n      const thumbH = Math.max(28, Math.round(barH * visibleRatio));\r\n\r\n      const maxScroll = Math.max(1, scrollHeight - clientHeight);\r\n      const range = Math.max(0, barH - thumbH);\r\n    \r\n      thumb.style.height = thumbH + 'px';\r\n    \r\n      if (useCssTimeline) {\r\n        thumb.style.setProperty('--thumb-y', `${range}px`);\r\n        thumb.style.setProperty('--thumb-x', '0px');\r\n      } else {\r\n        const y = Math.round((scrollTop / maxScroll) * range);\r\n        thumb.style.transform = `translateY(${y}px)`;\r\n      }\r\n\r\n      bar.style.display = (scrollHeight <= clientHeight + 1) ? 'none' : '';\r\n  };\r\n\r\n  const updateAll = () => {\r\n      updateBounds();\r\n      updateThumb();\r\n      syncScrollShadow();\r\n  };\r\n\r\n  const showBar = () => {\r\n      if (!isTouch) return;\r\n      merchantSheetEl.classList.add('is-scrolling');\r\n      if (fadeTimer) clearTimeout(fadeTimer);\r\n  };\r\n\r\n  const scheduleHide = (delay) => {\r\n      if (!isTouch) return;\r\n      if (fadeTimer) clearTimeout(fadeTimer);\r\n      fadeTimer = setTimeout(() => {\r\n      merchantSheetEl.classList.remove('is-scrolling');\r\n      }, delay);\r\n  };\r\n\r\n  const onScroll = () => {\r\n      updateThumb();\r\n      syncScrollShadow();\r\n      if (isTouch) showBar();\r\n      if (!supportsScrollEnd) scheduleHide(FADE_SCROLL_MS);\r\n  };\r\n\r\n  const onScrollEnd = () => scheduleHide(FADE_SCROLL_MS);\r\n\r\n  // Always listen to scroll for shadows and visibility\r\n  scroller.addEventListener('scroll', onScroll, { passive: true });\r\n  if (supportsScrollEnd) {\r\n      scroller.addEventListener('scrollend', onScrollEnd, { passive: true });\r\n  }\r\n\r\n  const ro = new ResizeObserver(updateAll);\r\n  ro.observe(scroller);\r\n  window.addEventListener('resize', updateAll);\r\n  requestAnimationFrame(updateAll); // Initial kick\r\n\r\n  // ----- Drag thumb to scroll -----\r\n  let dragging = false;\r\n  let dragStartY = 0;\r\n  let startScrollTop = 0;\r\n\r\n  const startDrag = (e) => {\r\n      dragging = true;\r\n      dragStartY = e.clientY;\r\n      startScrollTop = scroller.scrollTop;\r\n      thumb.classList.add('dragging');\r\n      showBar();\r\n      try { thumb.setPointerCapture(e.pointerId); } catch {}\r\n      e.preventDefault();\r\n  };\r\n\r\n  const onDragMove = (e) => {\r\n      if (!dragging) return;\r\n      const barH = bar.clientHeight || 1;\r\n      const thH = thumb.clientHeight || 1;\r\n      const range = Math.max(1, barH - thH);\r\n      const scrollMax = Math.max(1, scroller.scrollHeight - scroller.clientHeight);\r\n      const deltaY = e.clientY - dragStartY;\r\n      const scrollDelta = (deltaY / range) * scrollMax;\r\n      scroller.scrollTop = startScrollTop + scrollDelta;\r\n  };\r\n\r\n  const endDrag = (e) => {\r\n      if (!dragging) return;\r\n      dragging = false;\r\n      thumb.classList.remove('dragging');\r\n      scheduleHide(FADE_DRAG_MS);\r\n      try { thumb.releasePointerCapture(e.pointerId); } catch {}\r\n  };\r\n\r\n  thumb.addEventListener('pointerdown', startDrag);\r\n  window.addEventListener('pointermove', onDragMove, { passive: true });\r\n  window.addEventListener('pointerup', endDrag);\r\n  window.addEventListener('pointercancel', endDrag);\r\n\r\n  // Click track to jump\r\n  bar.addEventListener('pointerdown', (e) => {\r\n      if (e.target === thumb) return;\r\n      const rect = bar.getBoundingClientRect();\r\n      const clickY = e.clientY - rect.top;\r\n\r\n      const barH = bar.clientHeight || 1;\r\n      const thH = thumb.clientHeight || 1;\r\n      const range = Math.max(0, barH - thH);\r\n      const targetY = Math.max(0, Math.min(clickY - thH / 2, range));\r\n\r\n      const scrollMax = Math.max(1, scroller.scrollHeight - scroller.clientHeight);\r\n      scroller.scrollTop = (targetY / Math.max(1, range)) * scrollMax;\r\n\r\n      showBar();\r\n      scheduleHide(FADE_SCROLL_MS);\r\n  });\r\n\r\n  // mark so we don't double-init\r\n  scroller.__customScroll = { bar, thumb, ro, updateAll };\r\n  updateAll();\r\n}\r\n\r\nfunction ensureMerchantOverlay() {\r\n  if (merchantOverlayEl) return;\r\n\r\n  merchantOverlayEl = document.createElement('div');\r\n  merchantOverlayEl.className = 'merchant-overlay';\r\n  merchantOverlayEl.id = 'merchant-overlay';\r\n  merchantOverlayEl.setAttribute('inert', '');\r\n\r\n  merchantSheetEl = document.createElement('div');\r\n  merchantSheetEl.className = 'merchant-sheet';\r\n  merchantSheetEl.setAttribute('role', 'dialog');\r\n  merchantSheetEl.setAttribute('aria-modal', 'false');\r\n  merchantSheetEl.setAttribute('aria-label', 'Merchant');\r\n\r\n  const grabber = document.createElement('div');\r\n  grabber.className = 'merchant-grabber';\r\n  grabber.innerHTML = `<div class=\"grab-handle\" aria-hidden=\"true\"></div>`;\r\n\r\n  const header = document.createElement('header');\r\n  header.className = 'merchant-header';\r\n  header.innerHTML = `<div class=\"merchant-title\">Merchant</div><div class=\"merchant-line\" aria-hidden=\"true\"></div>`;\r\n\r\n  const content = document.createElement('div');\r\n  content.className = 'merchant-content';\r\n\r\n  const tabs = document.createElement('div');\r\n  tabs.className = 'merchant-tabs';\r\n  tabs.setAttribute('role', 'tablist');\r\n\r\n  const panelsWrap = document.createElement('div');\r\n  panelsWrap.className = 'merchant-panels';\r\n\r\n  const panelDialogue = document.createElement('section');\r\n  panelDialogue.className = 'merchant-panel is-active';\r\n  panelDialogue.id = 'merchant-panel-dialogue';\r\n\r\n  const panelReset = document.createElement('section');\r\n  panelReset.className = 'merchant-panel';\r\n  panelReset.id = 'merchant-panel-reset';\r\n\r\n  const panelWorkshop = document.createElement('section');\r\n  panelWorkshop.className = 'merchant-panel';\r\n  panelWorkshop.id = 'merchant-panel-workshop';\r\n\r\n  const panelWarp = document.createElement('section');\r\n  panelWarp.className = 'merchant-panel';\r\n  panelWarp.id = 'merchant-panel-warp';\r\n\r\n  const panelLab = document.createElement('section');\r\n  panelLab.className = 'merchant-panel';\r\n  panelLab.id = 'merchant-panel-lab';\r\n\r\n  syncForgeTabUnlockState();\r\n  syncWorkshopTabUnlockState();\r\n  syncWarpTabUnlockState();\r\n  syncLabTabUnlockState();\r\n\r\n  MERCHANT_TABS_DEF.forEach(def => {\r\n      if (def.key === 'dialogue') merchantTabUnlockState.set('dialogue', true);\r\n      const stored = merchantTabUnlockState.get(def.key);\r\n      const unlocked = stored != null ? stored : !!def.unlocked;\r\n      const btn = document.createElement('button');\r\n      btn.type = 'button';\r\n      btn.className = 'merchant-tab';\r\n      btn.dataset.tab = def.key;\r\n      const lockedLabel = def.lockedLabel || '???';\r\n      btn.textContent = unlocked ? def.label : lockedLabel;\r\n      if (!unlocked) {\r\n        btn.classList.add('is-locked');\r\n        btn.disabled = true;\r\n        btn.title = '???';\r\n      } else {\r\n      btn.title = def.label || 'Tab';\r\n      }\r\n      def.unlocked = unlocked;\r\n      merchantTabUnlockState.set(def.key, unlocked);\r\n      bindRapidActivation(btn, (event) => {\r\n      if (btn.disabled) {\r\n        event?.preventDefault?.();\r\n        return;\r\n      }\r\n      selectMerchantTab(def.key);\r\n      });\r\n\r\n      tabs.appendChild(btn);\r\n      merchantTabs.buttons[def.key] = btn;\r\n  });\r\n\r\n  merchantTabs.panels['dialogue']  = panelDialogue;\r\n  merchantTabs.panels['reset']     = panelReset;\r\n  merchantTabs.panels['workshop']  = panelWorkshop;\r\n  merchantTabs.panels['warp']      = panelWarp;\r\n  merchantTabs.panels['lab']       = panelLab;\r\n  merchantTabs.tablist = tabs;\r\n\r\n  panelsWrap.append(panelDialogue, panelReset, panelWorkshop, panelWarp, panelLab);\r\n  content.append(tabs, panelsWrap);\r\n\r\n  syncForgeTabUnlockState();\r\n  syncWorkshopTabUnlockState();\r\n\r\n  try { initResetSystem(); } catch {}\r\n  try { initResetPanel(panelReset); } catch {}\r\n  try { updateResetPanel(); } catch {}\r\n  \r\n  try { initWorkshopTab(panelWorkshop); } catch {}\r\n  try { initWarpTab(panelWarp); } catch {}\r\n  try { initLabTab(panelLab); } catch {}\r\n\r\n  if (!forgeUnlockListenerBound && typeof window !== 'undefined') {\r\n      const handleUnlockChange = (event) => {\r\n      const { key, slot } = event?.detail ?? {};\r\n      if (slot != null && slot !== getActiveSlot()) return;\r\n      \r\n      if (key === 'forge' || !key) syncForgeTabUnlockState();\r\n      if (key === 'infuse' || !key) syncWorkshopTabUnlockState();\r\n      if (key === 'surge_completed' || !key) syncWarpTabUnlockState();\r\n      if (key === 'lab' || key === 'tsunami' || !key) syncLabTabUnlockState();\r\n      };\r\n      window.addEventListener('unlock:change', handleUnlockChange, { passive: true });\r\n      window.addEventListener('saveSlot:change', handleUnlockChange, { passive: true });\r\n      forgeUnlockListenerBound = true;\r\n  }\r\n\r\n      const actions = document.createElement('div');\r\n      actions.className = 'merchant-actions';\r\n      const closeBtn = document.createElement('button');\r\n      closeBtn.type = 'button';\r\n      closeBtn.className = 'merchant-close';\r\n      closeBtn.textContent = 'Close';\r\n      merchantCloseBtn = closeBtn;\r\n      actions.appendChild(closeBtn);\r\n\r\n  // First-time chat overlay\r\n  const firstChat = document.createElement('div');\r\n  firstChat.className = 'merchant-firstchat merchant-firstchat--initial';\r\n  firstChat.innerHTML = `<div class=\"merchant-firstchat__card\" role=\"dialog\" aria-label=\"First chat\"><div class=\"merchant-firstchat__header\"><div class=\"name\">Merchant</div><div class=\"rule\" aria-hidden=\"true\"></div></div><div class=\"merchant-firstchat__row\"><img class=\"merchant-firstchat__icon\" src=\"${MERCHANT_ICON_SRC}\" alt=\"\"><div class=\"merchant-firstchat__text\" id=\"merchant-first-line\">\u2026</div></div><div class=\"merchant-firstchat__choices\" id=\"merchant-first-choices\"></div></div>`;\r\n\r\n  merchantSheetEl.append(grabber, header, content, actions, firstChat);\r\n  merchantOverlayEl.appendChild(merchantSheetEl);\r\n  document.body.appendChild(merchantOverlayEl);\r\n  initDialogueTab();\r\n  ensureMerchantScrollbar();\r\n\r\n  if (!merchantEventsBound) {\r\n      merchantEventsBound = true;\r\n\r\n      const onCloseClick = () => { closeMerchant(); };\r\n\r\n      bindRapidActivation(closeBtn, onCloseClick, { once: false });\r\n      document.addEventListener('keydown', onKeydownForMerchant);\r\n      grabber.addEventListener('pointerdown', onMerchantDragStart);\r\n      grabber.addEventListener('touchstart', (e) => e.preventDefault(), { passive: false });\r\n\r\n      // Allow priming via any pointer in the overlay (mobile-safe)\r\n      merchantOverlayEl.addEventListener('pointerdown', primeTypingSfx, { once: true });\r\n  }\r\n}\r\n\r\n// Called once when Merchant overlay is created\r\nfunction initDialogueTab() {\r\n  const panel = document.getElementById('merchant-panel-dialogue');\r\n  if (!panel || panel.__dlgInit) return;\r\n  panel.__dlgInit = true;\r\n\r\n  const list = document.createElement('div');\r\n  list.className = 'merchant-dialogue-list';\r\n  panel.appendChild(list);\r\n\r\n  panel.__dlgList = list;\r\n  ensureProgressEvents();\r\n  renderDialogueList();\r\n}\r\n\r\nfunction handleDialogueCardClick(event) {\r\n  const card = event.currentTarget;\r\n  if (!card) return;\r\n  const ctx = card._dlgCtx;\r\n  if (!ctx) return;\r\n\r\n  if (card.classList.contains('is-locked') && !ctx.isMysterious) {\r\n      event?.preventDefault?.();\r\n      return;\r\n  }\r\n  if (ctx.unlocked) {\r\n      openDialogueModal(ctx.id, ctx.meta);\r\n  } else if (ctx.isMysterious) {\r\n      openDialogueLockInfo(ctx.lockInfo);\r\n  }\r\n}\r\n\r\nfunction renderDialogueList() {\r\n  const panel = document.getElementById('merchant-panel-dialogue');\r\n  if (!panel) return;\r\n\r\n  const list = panel.__dlgList;\r\n  if (!list) return;\r\n\r\n  const progress = getPlayerProgress();\r\n  const state = loadDlgState();\r\n  let stateDirty = false;\r\n\r\n  const seenIds = new Set();\r\n\r\n  Object.entries(DLG_CATALOG).forEach(([id, meta]) => {\r\n      seenIds.add(String(id));\r\n      const entryState = state[id] || {};\r\n      const storedStatus = entryState.status || 'locked';\r\n      const storedRank = dialogueStatusRank(storedStatus);\r\n\r\n      let lockInfo = resolveDialogueLock(meta, progress);\r\n      let status = lockInfo.status;\r\n      let rank = dialogueStatusRank(status);\r\n\r\n      if (rank > storedRank) {\r\n      entryState.status = status;\r\n      if (status === 'mysterious') {\r\n        entryState.lockSnapshot = snapshotLockDisplay(lockInfo);\r\n      } else if (status === 'unlocked') {\r\n        delete entryState.lockSnapshot;\r\n      }\r\n      state[id] = entryState;\r\n      stateDirty = true;\r\n      } else if (rank < storedRank) {\r\n      if (storedStatus === 'unlocked') {\r\n        lockInfo = buildUnlockedDialogueInfo(meta);\r\n        status = 'unlocked';\r\n        rank = dialogueStatusRank(status);\r\n      } else if (storedStatus === 'mysterious') {\r\n        const snapshot = entryState.lockSnapshot || snapshotLockDisplay(lockInfo) || {};\r\n        lockInfo = {\r\n          status: 'mysterious',\r\n          unlocked: false,\r\n          title: snapshot.title ?? lockInfo.title ?? '???',\r\n          blurb: snapshot.blurb ?? lockInfo.blurb ?? DEFAULT_MYSTERIOUS_BLURB,\r\n          tooltip: snapshot.tooltip ?? lockInfo.tooltip ?? 'Hidden Dialogue',\r\n          message: snapshot.message ?? lockInfo.message ?? DEFAULT_LOCK_MESSAGE,\r\n          icon: snapshot.icon ?? lockInfo.icon ?? MYSTERIOUS_ICON_SRC,\r\n          headerTitle: snapshot.headerTitle ?? lockInfo.headerTitle ?? HIDDEN_DIALOGUE_TITLE,\r\n          ariaLabel: snapshot.ariaLabel ?? lockInfo.ariaLabel ?? 'Hidden merchant dialogue',\r\n        };\r\n        status = 'mysterious';\r\n        rank = dialogueStatusRank(status);\r\n      }\r\n      }\r\n\r\n      const unlocked = status === 'unlocked';\r\n      const isMysterious = status === 'mysterious';\r\n      const locked = status === 'locked';\r\n      const claimed = !!entryState.claimed;\r\n      const showComplete = unlocked && !!(meta.once && claimed);\r\n\r\n      let card = list.querySelector(`.dlg-card[data-dlg-id=\"${id}\"]`);\r\n      if (!card) {\r\n      card = document.createElement('button');\r\n      card.type = 'button';\r\n      card.className = 'dlg-card';\r\n      card.dataset.dlgId = String(id);\r\n      \r\n      const titleEl = document.createElement('div');\r\n      titleEl.className = 'dlg-title';\r\n      \r\n      const blurbEl = document.createElement('div');\r\n      blurbEl.className = 'dlg-blurb';\r\n      \r\n      const rewardEl = document.createElement('div');\r\n      rewardEl.className = 'dlg-reward';\r\n      \r\n      card.append(titleEl, blurbEl, rewardEl);\r\n      list.appendChild(card);\r\n      \r\n      // Bind once; handler uses element context\r\n      bindRapidActivation(card, handleDialogueCardClick);\r\n      }\r\n\r\n      // Update Context\r\n      card._dlgCtx = { id, meta, lockInfo, unlocked, isMysterious };\r\n\r\n      // Update Classes\r\n      card.dataset.dlgStatus = status;\r\n      if (card.disabled !== !!locked) card.disabled = !!locked;\r\n      card.classList.toggle('is-locked', locked);\r\n      card.classList.toggle('is-mysterious', isMysterious);\r\n      card.classList.toggle('is-complete', !!showComplete);\r\n      card.classList.toggle('has-again', !!showComplete);\r\n\r\n      if (locked) {\r\n      if (card.getAttribute('aria-disabled') !== 'true') card.setAttribute('aria-disabled', 'true');\r\n      if (card.getAttribute('tabindex') !== '-1') card.setAttribute('tabindex', '-1');\r\n      } else {\r\n      if (card.hasAttribute('aria-disabled')) card.removeAttribute('aria-disabled');\r\n      if (card.hasAttribute('tabindex')) card.removeAttribute('tabindex');\r\n      }\r\n\r\n      // Update Content\r\n      const titleEl = card.querySelector('.dlg-title');\r\n      const titleText = unlocked ? meta.title : (lockInfo.title ?? '???');\r\n      if (titleEl.textContent !== titleText) titleEl.textContent = titleText;\r\n\r\n      const blurbEl = card.querySelector('.dlg-blurb');\r\n      const blurbText = unlocked ? meta.blurb : (lockInfo.blurb ?? '');\r\n      if (blurbEl.textContent !== blurbText) blurbEl.textContent = blurbText;\r\n\r\n      const rewardEl = card.querySelector('.dlg-reward');\r\n      if (unlocked && meta.reward) {\r\n      const iconSrc = REWARD_ICON_SRC[meta.reward.type];\r\n      if (iconSrc) {\r\n        // Reuse inner structure if it matches, to avoid flicker\r\n        if (!rewardEl.classList.contains('has-reward')) {\r\n           rewardEl.classList.add('has-reward');\r\n           rewardEl.innerHTML = `<span class=\"reward-label\">Reward:</span><span class=\"reward-chunk\"><span class=\"reward-icon\" aria-hidden=\"true\"></span><span class=\"amt\"></span><span class=\"currency-name\"></span></span>`;\r\n        }\r\n        \r\n        // Update reward visual data\r\n        if (rewardEl.style.getPropertyValue('--reward-icon') !== `url('${iconSrc}')`) {\r\n            rewardEl.style.setProperty('--reward-icon', `url('${iconSrc}')`);\r\n        }\r\n        const amtEl = rewardEl.querySelector('.amt');\r\n        const amtText = String(meta.reward.amount);\r\n        if (amtEl && amtEl.textContent !== amtText) amtEl.textContent = amtText;\r\n\r\n        const nameEl = rewardEl.querySelector('.currency-name');\r\n        if (nameEl) {\r\n          const typeStr = String(meta.reward.type || '');\r\n          const capText = typeStr.charAt(0).toUpperCase() + typeStr.slice(1);\r\n          if (nameEl.textContent !== capText) nameEl.textContent = capText;\r\n        }\r\n        \r\n        const rewardLabelText = `Reward: ${meta.reward.amount} ${meta.reward.type}`;\r\n        if (rewardEl.getAttribute('aria-label') !== rewardLabelText) {\r\n            rewardEl.setAttribute('aria-label', rewardLabelText);\r\n        }\r\n      } else {\r\n        rewardEl.classList.remove('has-reward');\r\n        const text = rewardLabel(meta.reward);\r\n        if (rewardEl.textContent !== text) rewardEl.textContent = text;\r\n        if (rewardEl.style.display !== '') rewardEl.style.display = '';\r\n        rewardEl.removeAttribute('aria-label');\r\n      }\r\n      if (rewardEl.style.display === 'none') rewardEl.style.display = '';\r\n      } else {\r\n      if (rewardEl.textContent !== '') rewardEl.textContent = '';\r\n      if (rewardEl.style.display !== 'none') rewardEl.style.display = 'none';\r\n      }\r\n\r\n      const ariaLabel = unlocked\r\n      ? `${meta.title}${showComplete ? ' (completed)' : ''}`\r\n      : (lockInfo.ariaLabel || (isMysterious ? 'Hidden merchant dialogue' : 'Locked merchant dialogue'));\r\n      if (card.getAttribute('aria-label') !== ariaLabel) card.setAttribute('aria-label', ariaLabel);\r\n\r\n      if (lockInfo.tooltip) {\r\n      if (card.title !== lockInfo.tooltip) card.title = lockInfo.tooltip;\r\n      } else if (unlocked) {\r\n      const hint = 'Left-click: Start Dialogue';\r\n      if (card.title !== hint) card.title = hint;\r\n      } else {\r\n      if (card.hasAttribute('title')) card.removeAttribute('title');\r\n      }\r\n\r\n      // \"Ask Again\" footer\r\n      let againEl = card.querySelector('.dlg-again');\r\n      if (showComplete) {\r\n      if (!againEl) {\r\n        againEl = document.createElement('div');\r\n        againEl.className = 'dlg-again';\r\n        againEl.textContent = 'Ask Again?';\r\n        card.appendChild(againEl);\r\n      }\r\n      } else if (againEl) {\r\n      againEl.remove();\r\n      }\r\n  });\r\n  \r\n  // Cleanup stale\r\n  Array.from(list.children).forEach(child => {\r\n      if (child.dataset.dlgId && !seenIds.has(child.dataset.dlgId)) {\r\n          child.remove();\r\n      }\r\n  });\r\n\r\n  if (stateDirty) {\r\n      saveDlgState(state);\r\n  }\r\n}\r\n\r\n// Runs a conversation inside the Dialogue tab (not the first-time overlay)\r\nfunction startConversation(id, meta) {\r\n  const panel = document.getElementById('merchant-panel-dialogue');\r\n  if (!panel) return;\r\n\r\n  const textEl = panel.querySelector('.merchant-text');     // from your bubble\r\n  const bubble = panel.querySelector('.merchant-bubble');\r\n  const row = panel;                                        // big tap target\r\n  let choicesEl = panel.querySelector('.merchant-choices');\r\n\r\n  setMusicUnderwater(true);\r\n\r\n  // Ensure blank + hide choices before typing\r\n  choicesEl.classList.remove('is-visible');\r\n  choicesEl.innerHTML = '';\r\n\r\n  const engine = new DialogueEngine({\r\n      textEl,\r\n      choicesEl,\r\n      skipTargets: [textEl, row, bubble],\r\n      onEnd: (info) => {\r\n      setMusicUnderwater(false);\r\n\t  if (info && info.noReward) {\r\n        textEl.textContent = '\u2026';\r\n        renderDialogueList();\r\n        return;\r\n      }\r\n      completeDialogueOnce(id, meta);\r\n\ttextEl.textContent = '\u2026';\r\n\trenderDialogueList();\r\n\t}\r\n  });\r\n\r\n  const script = MERCHANT_DIALOGUES[meta.scriptId];\r\n  engine.load(script);\r\n  engine.start();\r\n}\r\n\r\nfunction runFirstMeet() {\r\n  const fc = merchantOverlayEl.querySelector('.merchant-firstchat');\r\n  const textEl = fc.querySelector('#merchant-first-line');\r\n  const rowEl  = fc.querySelector('.merchant-firstchat__row');\r\n  const cardEl = fc.querySelector('.merchant-firstchat__card');\r\n  const choicesEl = fc.querySelector('#merchant-first-choices');\r\n\r\n  setMusicUnderwater(true);\r\n\r\n  const engine = new DialogueEngine({\r\n      textEl,\r\n      choicesEl,\r\n      skipTargets: [textEl, rowEl, cardEl],\r\n      onEnd: () => {\r\n      setMusicUnderwater(false);\r\n      try { localStorage.setItem(sk(MERCHANT_MET_KEY_BASE), '1'); } catch {}\r\n      try { window.dispatchEvent(new Event(MERCHANT_MET_EVENT)); } catch {}\r\n      fc.classList.remove('is-visible');\r\n      merchantOverlayEl.classList.remove('firstchat-active');\r\n      }\r\n  });\r\n\r\n  engine.load(MERCHANT_DIALOGUES[0]);\r\n  engine.start();\r\n}\r\n\r\nfunction resetFirstChatOverlayState() {\r\n  if (!merchantOverlayEl) return;\r\n  const fc = merchantOverlayEl.querySelector('.merchant-firstchat--initial');\r\n  if (!fc) return;\r\n\r\n  fc.classList.remove('is-visible');\r\n\r\n  const textEl = fc.querySelector('#merchant-first-line');\r\n  if (textEl) {\r\n      textEl.classList.remove('is-typing');\r\n      textEl.textContent = '\u2026';\r\n  }\r\n\r\n  const choicesEl = fc.querySelector('#merchant-first-choices');\r\n  if (choicesEl) {\r\n      choicesEl.classList.remove('is-visible');\r\n      choicesEl.style.opacity = '0';\r\n      choicesEl.style.transform = 'translateY(6px)';\r\n      choicesEl.style.pointerEvents = 'none';\r\n      choicesEl.style.minHeight = '';\r\n      choicesEl.innerHTML = '';\r\n  }\r\n\r\n  merchantOverlayEl.classList.remove('firstchat-active');\r\n}\r\n\r\nexport function openMerchant() {\r\n  ensureMerchantOverlay();\r\n  if (merchantOpen) return;\r\n\r\n  const activeEl = document.activeElement;\r\n  if (activeEl instanceof HTMLElement && !merchantOverlayEl.contains(activeEl)) {\r\n      merchantLastFocus = activeEl;\r\n  } else {\r\n      merchantLastFocus = null;\r\n  }\r\n  merchantOpen = true;\r\n\r\n  // Check for pending Lab unlock\r\n  const slot = getActiveSlot();\r\n  let forcedDialogueTab = false;\r\n\r\n  if (slot != null) {\r\n      const pendingKey = `ccc:tsunami:labPending:${slot}`;\r\n      if (localStorage.getItem(pendingKey) === '1') {\r\n          try { localStorage.removeItem(pendingKey); } catch {}\r\n          try { localStorage.setItem(LAB_UNLOCK_KEY(slot), '1'); } catch {}\r\n          syncLabTabUnlockState();\r\n          try { window.dispatchEvent(new CustomEvent('unlock:change', { detail: { key: 'lab', slot } })); } catch {}\r\n          forcedDialogueTab = true;\r\n      }\r\n  }\r\n\r\n  // Check whether this is the very first time we\u2019re meeting the Merchant\r\n  let met = false;\r\n  try {\r\n      met = localStorage.getItem(sk(MERCHANT_MET_KEY_BASE)) === '1';\r\n  } catch {\r\n      met = false;\r\n  }\r\n\r\n  // For the very first chat, pin the sheet in place (no slide-up animation)\r\n  if (!met) {\r\n      merchantOverlayEl.classList.add('firstchat-instant');\r\n  }\r\n\r\n  // Reset transform and transition\r\n  merchantSheetEl.style.transition = 'none';\r\n  merchantSheetEl.style.transform = '';\r\n  merchantOverlayEl.removeAttribute('inert');\r\n\r\n  // Animate in next frame\r\n  void merchantSheetEl.offsetHeight;\r\n  requestAnimationFrame(() => {\r\n    requestAnimationFrame(() => {\r\n      // Only restore the sheet transition for normal opens\r\n      if (!merchantOverlayEl.classList.contains('firstchat-instant')) {\r\n      merchantSheetEl.style.transition = '';\r\n      }\r\n\r\n      merchantOverlayEl.classList.add('is-open');\r\n      blockInteraction(140);\r\n\r\n      if (merchantCloseBtn && typeof merchantCloseBtn.focus === 'function') {\r\n      try { merchantCloseBtn.focus({ preventScroll: true }); } catch {}\r\n      }\r\n\r\n      // Restore last tab\r\n      let last = 'dialogue';\r\n      try { last = localStorage.getItem(sk(MERCHANT_TAB_KEY_BASE)) || 'dialogue'; } catch {}\r\n    \r\n      if (forcedDialogueTab) {\r\n        last = 'dialogue';\r\n      }\r\n    \r\n      selectMerchantTab(last);\r\n\r\n      // Ensure no orphaned audio\r\n      stopTypingSfx();\r\n\r\n      // First-time chat\r\n      if (!met) {\r\n      const fc = merchantOverlayEl.querySelector('.merchant-firstchat');\r\n      fc?.classList.add('is-visible');\r\n      merchantOverlayEl.classList.add('firstchat-active');\r\n      runFirstMeet();\r\n      }\r\n    });\r\n  });\r\n}\r\n\r\nexport function closeMerchant() {\r\n  if (!merchantOpen) return;\r\n  \r\n  setMusicUnderwater(false);\r\n\r\n  if (IS_MOBILE) {\r\n    try { suppressNextGhostTap(100); } catch {}\r\n    try { blockInteraction(80); } catch {}\r\n  }\r\n\r\n  merchantOpen = false;\r\n  merchantSheetEl.style.transition = '';\r\n  merchantSheetEl.style.transform = '';\r\n  merchantOverlayEl.classList.remove('is-open');\r\n  merchantOverlayEl.classList.remove('firstchat-instant');\r\n  resetFirstChatOverlayState();\r\n\r\n  const activeEl = document.activeElement;\r\n  if (activeEl && merchantOverlayEl.contains(activeEl)) {\r\n    let target = merchantLastFocus;\r\n    if (!target || !target.isConnected) {\r\n      target = document.querySelector('[data-btn=\"shop\"], .btn-shop');\r\n    }\r\n    if (target && typeof target.focus === 'function') {\r\n      try { target.focus({ preventScroll: true }); } catch {}\r\n    }\r\n  }\r\n\r\n  merchantOverlayEl.setAttribute('inert', '');\r\n  merchantLastFocus = null;\r\n  stopTypingSfx();\r\n  __isTypingActive = false;\r\n}\r\n\r\nfunction onKeydownForMerchant(e) {\r\n  if (!merchantOpen) return;\r\n\r\n  if (['INPUT', 'TEXTAREA', 'SELECT'].includes(document.activeElement?.tagName)) return;\r\n\r\n  if (/^[0-9]$/.test(e.key)) {\r\n    const num = parseInt(e.key, 10);\r\n    const requestedIndex = (num === 0 ? 9 : num - 1);\r\n\r\n    let maxUnlockedIndex = -1;\r\n    for (let i = 0; i < MERCHANT_TABS_DEF.length; i++) {\r\n      if (merchantTabUnlockState.get(MERCHANT_TABS_DEF[i].key)) {\r\n        maxUnlockedIndex = i;\r\n      }\r\n    }\r\n\r\n    if (maxUnlockedIndex === -1) maxUnlockedIndex = 0;\r\n\r\n    let targetIndex = requestedIndex;\r\n    if (targetIndex > maxUnlockedIndex) {\r\n      targetIndex = maxUnlockedIndex;\r\n    }\r\n\r\n    if (targetIndex >= 0 && targetIndex < MERCHANT_TABS_DEF.length) {\r\n      e.preventDefault();\r\n      closeDelveSpecificOverlays();\r\n      selectMerchantTab(MERCHANT_TABS_DEF[targetIndex].key);\r\n    }\r\n  }\r\n}\r\n\r\n// Drag to dismiss\r\nfunction onMerchantDragStart(e) {\r\n  if (!merchantOpen) return;\r\n\r\n  const clientY = typeof e.clientY === 'number'\r\n    ? e.clientY\r\n    : (e.touches && e.touches[0] ? e.touches[0].clientY : 0);\r\n\r\n  merchantDrag = {\r\n    startY: clientY,\r\n    lastY: clientY,\r\n    startT: performance.now(),\r\n    moved: 0,\r\n    canceled: false,\r\n  };\r\n\r\n  merchantSheetEl.style.transition = 'none';\r\n\r\n  window.addEventListener('pointermove', onMerchantDragMove, { passive: true });\r\n  window.addEventListener('pointerup', onMerchantDragEnd);\r\n  window.addEventListener('pointercancel', onMerchantDragCancel);\r\n}\r\n\r\nfunction onMerchantDragMove(e) {\r\n  if (!merchantDrag || merchantDrag.canceled) return;\r\n  const y = e.clientY;\r\n  if (typeof y !== 'number') return;\r\n  const dy = Math.max(0, y - merchantDrag.startY);\r\n  merchantDrag.lastY = y;\r\n  merchantDrag.moved = dy;\r\n  merchantSheetEl.style.transform = `translateY(${dy}px)`;\r\n}\r\n\r\nfunction onMerchantDragEnd() {\r\n  if (!merchantDrag || merchantDrag.canceled) { cleanupMerchantDrag(); return; }\r\n  const dt = Math.max(1, performance.now() - merchantDrag.startT);\r\n  const dy = merchantDrag.moved;\r\n  const velocity = dy / dt;\r\n  const shouldClose = (velocity > 0.55 && dy > 40) || dy > 140;\r\n\r\n  if (shouldClose) {\r\n    suppressNextGhostTap(160);\r\n    merchantSheetEl.style.transition = 'transform 140ms ease-out';\r\n    merchantSheetEl.style.transform = 'translateY(100%)';\r\n    setTimeout(() => { closeMerchant(); }, 150);\r\n  } else {\r\n    merchantSheetEl.style.transition = 'transform 180ms ease';\r\n    merchantSheetEl.style.transform = 'translateY(0)';\r\n  }\r\n  cleanupMerchantDrag();\r\n}\r\n\r\nfunction onMerchantDragCancel() {\r\n  if (!merchantDrag) return;\r\n  merchantDrag.canceled = true;\r\n  merchantSheetEl.style.transition = 'transform 180ms ease';\r\n  merchantSheetEl.style.transform = 'translateY(0)';\r\n  cleanupMerchantDrag();\r\n}\r\n\r\nfunction cleanupMerchantDrag() {\r\n  window.removeEventListener('pointermove', onMerchantDragMove);\r\n  window.removeEventListener('pointerup', onMerchantDragEnd);\r\n  window.removeEventListener('pointercancel', onMerchantDragCancel);\r\n  merchantDrag = null;\r\n}\r\n\r\nfunction selectMerchantTab(key) {\r\n  const def = MERCHANT_TABS_DEF.find(t => t.key === key);\r\n  const unlocked = merchantTabUnlockState.get(key);\r\n  if (!def || !unlocked) key = 'dialogue';\r\n\r\n  for (const k in merchantTabs.buttons) {\r\n    merchantTabs.buttons[k].classList.toggle('is-active', k === key);\r\n  }\r\n  for (const k in merchantTabs.panels) {\r\n    merchantTabs.panels[k].classList.toggle('is-active', k === key);\r\n  }\r\n\r\n  if (key === 'dialogue') {\r\n    try { renderDialogueList(); } catch {}\r\n  }\r\n  if (key === 'warp') {\r\n    try { updateWarpTab(); } catch {}\r\n  }\r\n  if (key === 'lab') {\r\n    if (typeof hasVisitedLab === 'function' && !hasVisitedLab()) {\r\n        runLabIntroDialogue();\r\n    }\r\n    try { updateLabTab(); } catch {}\r\n  }\r\n\r\n  try { localStorage.setItem(sk(MERCHANT_TAB_KEY_BASE), key); } catch {}\r\n\r\n  requestAnimationFrame(() => {\r\n    requestAnimationFrame(() => {\r\n      const scroller = merchantOverlayEl?.querySelector(\".merchant-content\");\r\n      if (scroller && scroller.__customScroll && typeof scroller.__customScroll.updateAll === \"function\") {\r\n        scroller.__customScroll.updateAll();\r\n      } else {\r\n      }\r\n    });\r\n  });\r\n}\r\n\r\nexport function isViewingLabTab() {\r\n  if (!merchantOpen) return false;\r\n  const btn = merchantTabs.buttons['lab'];\r\n  return btn && btn.classList.contains('is-active');\r\n}\r\n\r\nexport function unlockMerchantTabs(keys = []) {\r\n  keys.forEach(key => setMerchantTabUnlocked(key, true));\r\n}\r\n\r\nexport function runTsunamiDialogue(container, onComplete, tsunamiControls) {\r\n  const scriptPart1 = {\r\n    start: 'n1',\r\n    nodes: {\r\n      'n1': { type: 'line', say: 'O Great Tsunami\u2026', next: 'c1' },\r\n      'c1': { type: 'choice', options: [{ label: '...', to: 'n2' }] },\r\n      'n2': { type: 'line', say: 'Cover this Cove in your wet embrace\u2026', next: 'c2' },\r\n      'c2': { type: 'choice', options: [{ label: '...', to: 'n3' }] },\r\n      'n3': { type: 'line', say: 'We have thirsted for far too long\u2026', next: 'c3' },\r\n      'c3': { type: 'choice', options: [{ label: '...', to: 'n4' }] },\r\n      'n4': { type: 'line', say: 'Awaken what once was lost\u2026', next: 'c4' },\r\n      'c4': { type: 'choice', options: [{ label: '...', to: 'n5' }] },\r\n      'n5': { type: 'line', say: 'You will have my deepest gratitude\u2026', next: 'c5' },\r\n      'c5': { type: 'choice', options: [{ label: '...', to: 'end' }] },\r\n    }\r\n  };\r\n\r\n  const overlay = document.createElement('div');\r\n  overlay.className = 'merchant-firstchat is-visible';\r\n  overlay.style.zIndex = '2147483647'; \r\n  overlay.style.userSelect = 'none';\r\n  overlay.style.webkitUserSelect = 'none';\r\n  \r\n  overlay.innerHTML = `<div class=\"merchant-firstchat__card\" role=\"dialog\" aria-label=\"Tsunami Dialogue\"><div class=\"merchant-firstchat__header\"><div class=\"name\">Merchant</div><div class=\"rule\" aria-hidden=\"true\"></div></div><div class=\"merchant-firstchat__row\"><img class=\"merchant-firstchat__icon\" src=\"${MERCHANT_ICON_SRC}\" alt=\"\"><div class=\"merchant-firstchat__text\" id=\"tsunami-dlg-line\" style=\"user-select: none; -webkit-user-select: none;\">\u2026</div></div><div class=\"merchant-firstchat__choices\" id=\"tsunami-dlg-choices\"></div></div>`;\r\n  \r\n  container.appendChild(overlay);\r\n  \r\n  const textEl = overlay.querySelector('#tsunami-dlg-line');\r\n  const choicesEl = overlay.querySelector('#tsunami-dlg-choices');\r\n  const rowEl = overlay.querySelector('.merchant-firstchat__row');\r\n  const cardEl = overlay.querySelector('.merchant-firstchat__card');\r\n\r\n  primeTypingSfx();\r\n\r\n  const blockEsc = (e) => {\r\n    if (e.key === 'Escape') {\r\n      e.stopImmediatePropagation();\r\n      e.preventDefault();\r\n    }\r\n  };\r\n  document.addEventListener('keydown', blockEsc, { capture: true });\r\n\r\n  const runPart2 = () => {\r\n\r\n    // 15 seconds visual effect then fade\r\n    setTimeout(() => {\r\n        // Trigger Beacon Effect\r\n        if (tsunamiControls && tsunamiControls.triggerBeacons) {\r\n            tsunamiControls.triggerBeacons();\r\n        }\r\n        \r\n        // Wait 15 seconds for effect\r\n        setTimeout(() => {\r\n            // Trigger Fade\r\n            if (tsunamiControls && tsunamiControls.triggerFinalFade) {\r\n                tsunamiControls.triggerFinalFade();\r\n            }\r\n            \r\n            // Wait 5 seconds for fade\r\n            setTimeout(() => {\r\n                // Final Dialogue\r\n                runFinalLine();\r\n            }, 5000);\r\n            \r\n        }, 15000);\r\n        \r\n    }, 1000); // 1s delay start\r\n  };\r\n\r\n  const runFinalLine = () => {\r\n      if (tsunamiControls && tsunamiControls.showCursor) tsunamiControls.showCursor();\r\n\r\n      // Re-show overlay content for final line\r\n      overlay.innerHTML = `<div class=\"merchant-firstchat__card\" role=\"dialog\" aria-label=\"Tsunami Dialogue\"><div class=\"merchant-firstchat__header\"><div class=\"name\">Merchant</div><div class=\"rule\" aria-hidden=\"true\"></div></div><div class=\"merchant-firstchat__row\"><img class=\"merchant-firstchat__icon\" src=\"${MERCHANT_ICON_SRC}\" alt=\"\"><div class=\"merchant-firstchat__text\" id=\"tsunami-dlg-line-2\" style=\"user-select: none; -webkit-user-select: none;\">\u2026</div></div><div class=\"merchant-firstchat__choices\" id=\"tsunami-dlg-choices-2\"></div></div>`;\r\n      \r\n      const textEl2 = overlay.querySelector('#tsunami-dlg-line-2');\r\n      const choicesEl2 = overlay.querySelector('#tsunami-dlg-choices-2');\r\n      const rowEl2 = overlay.querySelector('.merchant-firstchat__row');\r\n      const cardEl2 = overlay.querySelector('.merchant-firstchat__card');\r\n      \r\n      const finalScript = {\r\n          start: 'final',\r\n          nodes: {\r\n              'final': { \r\n                  type: 'line', \r\n                  say: 'I am sure the <span style=\"color:#00e5ff\">Player</span> will have some questions when they wake up, but I will deal with that when I must.', \r\n                  next: 'end' \r\n              },\r\n              'end': { type: 'choice', options: [{ label: '...', to: 'end' }] }\r\n          }\r\n      };\r\n      \r\n      const engine2 = new DialogueEngine({\r\n          textEl: textEl2,\r\n          choicesEl: choicesEl2,\r\n          skipTargets: [textEl2, rowEl2, cardEl2],\r\n          onEnd: () => {\r\n              // Hide Dialogue\r\n              overlay.innerHTML = ''; // Hide UI\r\n              if (tsunamiControls && tsunamiControls.hideCursor) tsunamiControls.hideCursor();\r\n              \r\n              // 5 seconds darkness\r\n              setTimeout(() => {\r\n                  document.removeEventListener('keydown', blockEsc, { capture: true });\r\n                  stopTypingSfx();\r\n                  __isTypingActive = false;\r\n                  overlay.remove();\r\n                  if (onComplete) onComplete();\r\n              }, 5000);\r\n          }\r\n      });\r\n      \r\n      engine2.load(finalScript);\r\n      engine2.start();\r\n  };\r\n\r\n  const engine = new DialogueEngine({\r\n    textEl,\r\n    choicesEl,\r\n    skipTargets: [textEl, rowEl, cardEl],\r\n    onEnd: () => {\r\n        // Hide Dialogue UI temporarily\r\n        overlay.innerHTML = '';\r\n        stopTypingSfx();\r\n        __isTypingActive = false;\r\n        \r\n        if (tsunamiControls && tsunamiControls.hideCursor) tsunamiControls.hideCursor();\r\n        \r\n        runPart2();\r\n    }\r\n  });\r\n\r\n  engine.load(scriptPart1);\r\n  engine.start();\r\n}\r\n\r\nexport function runLabIntroDialogue() {\r\n    const overlay = document.createElement('div');\r\n    overlay.className = 'merchant-firstchat is-visible';\r\n    overlay.style.zIndex = '2147483647';\r\n    overlay.style.position = 'fixed';\r\n    overlay.style.inset = '0';\r\n    overlay.style.userSelect = 'none';\r\n    overlay.style.webkitUserSelect = 'none';\r\n    \r\n    overlay.innerHTML = `<div class=\"merchant-firstchat__card\" role=\"dialog\" aria-label=\"Lab Introduction\"><div class=\"merchant-firstchat__header\"><div class=\"name\">${getMerchantName()}</div><div class=\"rule\" aria-hidden=\"true\"></div></div><div class=\"merchant-firstchat__row\"><img class=\"merchant-firstchat__icon\" src=\"${MERCHANT_ICON_SRC}\" alt=\"\"><div class=\"merchant-firstchat__text\" id=\"lab-intro-line\" style=\"user-select: none; -webkit-user-select: none;\">\u2026</div></div><div class=\"merchant-firstchat__choices\" id=\"lab-intro-choices\"></div></div>`;\r\n    \r\n    document.body.appendChild(overlay);\r\n    \r\n    const textEl = overlay.querySelector('#lab-intro-line');\r\n    const choicesEl = overlay.querySelector('#lab-intro-choices');\r\n    const rowEl = overlay.querySelector('.merchant-firstchat__row');\r\n    const cardEl = overlay.querySelector('.merchant-firstchat__card');\r\n\r\n    primeTypingSfx();\r\n\r\n    const script = {\r\n        start: 'n1',\r\n        nodes: {\r\n            'n1': { \r\n                type: 'line', \r\n                say: 'Hey, <span style=\"color:#00e5ff\">Player</span>, welcome to the Lab. I\\'ll keep it brief: Research nodes, increase your Lab Level to research nodes faster, and you\\'ll be making tons of Coins. Your Surge milestones were sacrificed temporarily to the Tsunami but that\\'s not important, get to researching!', \r\n                next: 'c1' \r\n            },\r\n            'c1': { \r\n                type: 'choice', \r\n                options: [\r\n                    { label: 'I don\\'t understand.', to: 'end_nr' },\r\n                    { label: 'Tsunami sacrifice?', to: 'end_nr' },\r\n                    { label: '???', to: 'end_nr' }\r\n                ] \r\n            }\r\n        }\r\n    };\r\n\r\n    const engine = new DialogueEngine({\r\n        textEl,\r\n        choicesEl,\r\n        skipTargets: [textEl, rowEl, cardEl],\r\n        onEnd: () => {\r\n            stopTypingSfx();\r\n            __isTypingActive = false;\r\n            overlay.remove();\r\n        }\r\n    });\r\n\r\n    engine.load(script);\r\n    engine.start();\r\n}\r\n\r\nexport function runPostTsunamiShopDialogue(onComplete) {\r\n    const overlay = document.createElement('div');\r\n    overlay.className = 'merchant-firstchat is-visible';\r\n    overlay.style.zIndex = '2147483647';\r\n    overlay.style.position = 'fixed';\r\n    overlay.style.inset = '0';\r\n    overlay.style.userSelect = 'none';\r\n    overlay.style.webkitUserSelect = 'none';\r\n    \r\n    overlay.innerHTML = `<div class=\"merchant-firstchat__card\" role=\"dialog\" aria-label=\"Urgent Message\"><div class=\"merchant-firstchat__header\"><div class=\"name\">${getMerchantName()}</div><div class=\"rule\" aria-hidden=\"true\"></div></div><div class=\"merchant-firstchat__row\"><img class=\"merchant-firstchat__icon\" src=\"${MERCHANT_ICON_SRC}\" alt=\"\"><div class=\"merchant-firstchat__text\" id=\"post-tsunami-line\" style=\"user-select: none; -webkit-user-select: none;\">\u2026</div></div><div class=\"merchant-firstchat__choices\" id=\"post-tsunami-choices\"></div></div>`;\r\n    \r\n    document.body.appendChild(overlay);\r\n    \r\n    const textEl = overlay.querySelector('#post-tsunami-line');\r\n    const choicesEl = overlay.querySelector('#post-tsunami-choices');\r\n    const rowEl = overlay.querySelector('.merchant-firstchat__row');\r\n    const cardEl = overlay.querySelector('.merchant-firstchat__card');\r\n\r\n    primeTypingSfx();\r\n\r\n    const script = {\r\n        start: 'n1',\r\n        nodes: {\r\n            'n1': { \r\n                type: 'line', \r\n                say: '<span style=\"color:#00e5ff\">Player</span>, quickly, come to the Lab.', \r\n                next: 'c1' \r\n            },\r\n            'c1': { \r\n                type: 'choice', \r\n                options: [\r\n                    { label: 'What?', to: 'end' },\r\n                    { label: 'The Lab?', to: 'end' },\r\n                    { label: '???', to: 'end' }\r\n                ] \r\n            }\r\n        }\r\n    };\r\n\r\n    const engine = new DialogueEngine({\r\n        textEl,\r\n        choicesEl,\r\n        skipTargets: [textEl, rowEl, cardEl],\r\n        onEnd: () => {\r\n            stopTypingSfx();\r\n            __isTypingActive = false;\r\n            overlay.remove();\r\n            if (onComplete) onComplete();\r\n        }\r\n    });\r\n\r\n    engine.load(script);\r\n    engine.start();\r\n}\r\n\r\n// Expose for other modules that may build UI later\r\nexport { ensureMerchantOverlay };\r\n", "import { formatMultForUi } from '../util/numFormat.js';\r\n\r\nexport const DNA_AREA_KEY = 'dna';\r\n\r\nconst MYSTERIOUS_ICON = 'img/misc/mysterious.webp';\r\nconst HIDDEN_TITLE = 'Hidden Upgrade';\r\n\r\nexport const REGISTRY = [\r\n  {\r\n    area: DNA_AREA_KEY,\r\n    id: 1,\r\n    title: \"DNA Coin Value\",\r\n    desc: \"Multiplies Coin value by 1.1x per level\",\r\n    lvlCap: 1000,\r\n    baseCost: 1000,\r\n    costType: \"dna\",\r\n    upgType: \"HM\",\r\n    scalingPreset: 'HM',\r\n    icon: \"sc_upg_icons/coin_val_dna.webp\",\r\n    baseIconOverride: \"currencies/dna/dna_base.webp\",\r\n    effectType: \"coin_value\",\r\n    _dnaEffectVal: 1.1,\r\n    _costScaling: 'HM',\r\n    bonusLine: (level, total) => `Coin value bonus: ${formatMultForUi(total)}x`\r\n  },\r\n  {\r\n    area: DNA_AREA_KEY,\r\n    id: 2,\r\n    title: \"DNA XP Value\",\r\n    desc: \"Multiplies XP value by 1.1x per level\",\r\n    lvlCap: 1000,\r\n    baseCost: 1000,\r\n    costType: \"dna\",\r\n    upgType: \"HM\",\r\n    scalingPreset: 'HM',\r\n    icon: \"sc_upg_icons/xp_val_dna.webp\",\r\n    baseIconOverride: \"currencies/dna/dna_base.webp\",\r\n    effectType: \"xp_value\",\r\n    _dnaEffectVal: 1.1,\r\n    _costScaling: 'HM',\r\n    bonusLine: (level, total) => `XP value bonus: ${formatMultForUi(total)}x`\r\n  },\r\n  {\r\n    area: DNA_AREA_KEY,\r\n    id: 3,\r\n    title: \"DNA Gold Value\",\r\n    desc: \"Multiplies Gold value by 1.1x per level\",\r\n    lvlCap: 1000,\r\n    baseCost: 1e12,\r\n    costType: \"dna\",\r\n    upgType: \"HM\",\r\n    scalingPreset: 'HM',\r\n    icon: \"sc_upg_icons/gold_val_dna.webp\",\r\n    baseIconOverride: \"currencies/dna/dna_base.webp\",\r\n    effectType: \"gold_value\",\r\n    _dnaEffectVal: 1.1,\r\n    _costScaling: 'HM',\r\n    bonusLine: (level, total) => `Gold value bonus: ${formatMultForUi(total)}x`,\r\n    computeLockState(ctx) {\r\n        const sl = ctx.surgeLevel;\r\n        let isUnlocked = false;\r\n        \r\n        if (typeof sl === 'number') {\r\n            if (sl >= 10 || sl === Infinity) isUnlocked = true;\r\n        } else if (typeof sl === 'bigint') {\r\n            if (sl >= 10n) isUnlocked = true;\r\n        } else if (typeof sl === 'string') {\r\n             if (sl === 'Infinity' || parseFloat(sl) === Infinity) isUnlocked = true;\r\n             else if (!isNaN(parseFloat(sl)) && parseFloat(sl) >= 10) isUnlocked = true;\r\n        } else if (sl && typeof sl.isInfinite === 'function' && sl.isInfinite()) {\r\n             isUnlocked = true;\r\n        }\r\n        \r\n        if (isUnlocked) return { locked: false };\r\n        \r\n        const revealText = \"Reach Surge 10 to reveal this upgrade\";\r\n        return {\r\n            locked: true,\r\n            iconOverride: MYSTERIOUS_ICON,\r\n            titleOverride: HIDDEN_TITLE,\r\n            descOverride: revealText,\r\n            reason: revealText,\r\n            hidden: true,\r\n            hideCost: true,\r\n            hideEffect: true,\r\n            useLockedBase: true\r\n        };\r\n    }\r\n  },\r\n  {\r\n    area: DNA_AREA_KEY,\r\n    id: 4,\r\n    title: \"DNA Magic Value\",\r\n    desc: \"Multiplies Magic value by 1.1x per level\",\r\n    lvlCap: 1000,\r\n    baseCost: 1e12,\r\n    costType: \"dna\",\r\n    upgType: \"HM\",\r\n    scalingPreset: 'HM',\r\n    icon: \"sc_upg_icons/magic_val_dna.webp\",\r\n    baseIconOverride: \"currencies/dna/dna_base.webp\",\r\n    effectType: \"magic_value\",\r\n    _dnaEffectVal: 1.1,\r\n    _costScaling: 'HM',\r\n    bonusLine: (level, total) => `Magic value bonus: ${formatMultForUi(total)}x`,\r\n    computeLockState(ctx) {\r\n        const sl = ctx.surgeLevel;\r\n        let isUnlocked = false;\r\n        \r\n        if (typeof sl === 'number') {\r\n            if (sl >= 10 || sl === Infinity) isUnlocked = true;\r\n        } else if (typeof sl === 'bigint') {\r\n            if (sl >= 10n) isUnlocked = true;\r\n        } else if (typeof sl === 'string') {\r\n             if (sl === 'Infinity' || parseFloat(sl) === Infinity) isUnlocked = true;\r\n             else if (!isNaN(parseFloat(sl)) && parseFloat(sl) >= 10) isUnlocked = true;\r\n        } else if (sl && typeof sl.isInfinite === 'function' && sl.isInfinite()) {\r\n             isUnlocked = true;\r\n        }\r\n        \r\n        if (isUnlocked) return { locked: false };\r\n        \r\n        const revealText = \"Reach Surge 10 to reveal this upgrade\";\r\n        return {\r\n            locked: true,\r\n            iconOverride: MYSTERIOUS_ICON,\r\n            titleOverride: HIDDEN_TITLE,\r\n            descOverride: revealText,\r\n            reason: revealText,\r\n            hidden: true,\r\n            hideCost: true,\r\n            hideEffect: true,\r\n            useLockedBase: true\r\n        };\r\n    }\r\n  },\r\n  {\r\n    area: DNA_AREA_KEY,\r\n    id: 5,\r\n    title: \"DNA Wave Value\",\r\n    desc: \"Multiplies Wave value by 1.1x per level\",\r\n    lvlCap: 1000,\r\n    baseCost: 1e39,\r\n    costType: \"dna\",\r\n    upgType: \"HM\",\r\n    scalingPreset: 'HM',\r\n    icon: \"sc_upg_icons/wave_val_dna.webp\",\r\n    baseIconOverride: \"currencies/dna/dna_base.webp\",\r\n    effectType: \"wave_value\",\r\n    _dnaEffectVal: 1.1,\r\n    _costScaling: 'HM',\r\n    bonusLine: (level, total) => `Wave value bonus: ${formatMultForUi(total)}x`,\r\n    computeLockState(ctx) {\r\n        const sl = ctx.surgeLevel;\r\n        let isUnlocked = false;\r\n        \r\n        if (typeof sl === 'number') {\r\n            if (sl >= 19 || sl === Infinity) isUnlocked = true;\r\n        } else if (typeof sl === 'bigint') {\r\n            if (sl >= 19n) isUnlocked = true;\r\n        } else if (typeof sl === 'string') {\r\n             if (sl === 'Infinity' || parseFloat(sl) === Infinity) isUnlocked = true;\r\n             else if (!isNaN(parseFloat(sl)) && parseFloat(sl) >= 19) isUnlocked = true;\r\n        } else if (sl && typeof sl.isInfinite === 'function' && sl.isInfinite()) {\r\n             isUnlocked = true;\r\n        }\r\n        \r\n        if (isUnlocked) return { locked: false };\r\n        \r\n        const revealText = \"Reach Surge 19 to reveal this upgrade\";\r\n        return {\r\n            locked: true,\r\n            iconOverride: MYSTERIOUS_ICON,\r\n            titleOverride: HIDDEN_TITLE,\r\n            descOverride: revealText,\r\n            reason: revealText,\r\n            hidden: true,\r\n            hideCost: true,\r\n            hideEffect: true,\r\n            useLockedBase: true\r\n        };\r\n    }\r\n  }\r\n];\r\n", "// js/ui/shopOverlay.js\r\n\r\nimport { bank, getActiveSlot } from '../util/storage.js';\r\nimport { BigNum } from '../util/bigNum.js';\r\nimport { formatNumber } from '../util/numFormat.js';\r\nimport { IS_MOBILE } from '../main.js';\r\nimport { openMerchant,\r\n    ensureMerchantOverlay,\r\n    primeTypingSfx,\r\n    unlockMerchantTabs,\r\n    hasMetMerchant,\r\n    MERCHANT_MET_EVENT,\r\n    runPostTsunamiShopDialogue\r\n} from './merchantTabs/dlgTab.js';\r\nimport { takePreloadedAudio } from '../util/audioCache.js';\r\nimport { playAudio } from '../util/audioManager.js';\r\nimport {\r\n  AREA_KEYS,\r\n  UPGRADE_TIES,\r\n  getCurrentAreaKey,\r\n  getUpgradesForArea,\r\n  getLevel,\r\n  getLevelNumber,\r\n  getIconUrl,\r\n  normalizeUpgradeIconPath,\r\n  formatMultForUi,\r\n  upgradeUiModel,\r\n  buyOne,\r\n  buyMax,\r\n  buyCheap,\r\n  buyTowards,\r\n  evaluateBulkPurchase,\r\n  getUpgradeLockState,\r\n  evolveUpgrade,\r\n  HM_EVOLUTION_INTERVAL,\r\n} from '../game/upgrades.js';\r\nimport {\r\n  shouldSkipGhostTap,\r\n  suppressNextGhostTap,\r\n} from '../util/ghostTapGuard.js';\r\nimport { \r\n  AUTOMATION_AREA_KEY, \r\n  AUTOBUY_COIN_UPGRADES_ID,\r\n  AUTOBUY_BOOK_UPGRADES_ID,\r\n  AUTOBUY_GOLD_UPGRADES_ID,\r\n  AUTOBUY_MAGIC_UPGRADES_ID,\r\n  AUTOBUY_WORKSHOP_LEVELS_ID,\r\n  AUTOBUY_DNA_UPGRADES_ID,\r\n  MASTER_AUTOBUY_IDS\r\n} from '../game/automationUpgrades.js';\r\nimport { getAutobuyerToggle, setAutobuyerToggle } from '../game/automationEffects.js';\r\nimport { DNA_AREA_KEY } from '../game/dnaUpgrades.js';\r\n\r\n// --- Shared State ---\r\nconst scrollingElements = new Set();\r\nexport function isAnyMenuScrolling() { return scrollingElements.size > 0; }\r\n\r\nconst ICON_DIR = 'img/';\r\nconst BASE_ICON_SRC_BY_COST = {\r\n  coins: 'img/currencies/coin/coin_base.webp',\r\n  books: 'img/currencies/book/book_base.webp',\r\n  gold: 'img/currencies/gold/gold_base.webp',\r\n  magic: 'img/currencies/magic/magic_base.webp',\r\n  gears: 'img/currencies/gear/gear_base.webp',\r\n  dna: 'img/currencies/dna/dna_base.webp',\r\n};\r\nconst LOCKED_BASE_ICON_SRC = 'img/misc/locked_base.webp';\r\nconst MAXED_BASE_OVERLAY_SRC = 'img/misc/maxed.webp';\r\nconst AUTOMATED_OVERLAY_SRC = 'img/misc/green_border.webp';\r\nconst CURRENCY_ICON_SRC = {\r\n  coins: 'img/currencies/coin/coin.webp',\r\n  books: 'img/currencies/book/book.webp',\r\n  gold: 'img/currencies/gold/gold.webp',\r\n  magic: 'img/currencies/magic/magic.webp',\r\n  gears: 'img/currencies/gear/gear.webp',\r\n  dna: 'img/currencies/dna/dna.webp',\r\n};\r\n\r\nconst FORGE_UNLOCK_UPGRADE_ID = 7;\r\n\r\nconst COST_TYPE_TO_AUTO_ID = {\r\n  coins: AUTOBUY_COIN_UPGRADES_ID,\r\n  books: AUTOBUY_BOOK_UPGRADES_ID,\r\n  gold: AUTOBUY_GOLD_UPGRADES_ID,\r\n  magic: AUTOBUY_MAGIC_UPGRADES_ID,\r\n  dna: AUTOBUY_DNA_UPGRADES_ID\r\n};\r\n\r\nfunction isUpgradeAutomated(upgDef) {\r\n    if (!upgDef || !upgDef.costType) return false;\r\n    const autoId = COST_TYPE_TO_AUTO_ID[upgDef.costType];\r\n    if (!autoId) return false;\r\n    \r\n    // Check if player has the automation upgrade\r\n    const autoLevel = getLevelNumber(AUTOMATION_AREA_KEY, autoId);\r\n    if (autoLevel <= 0) return false;\r\n    \r\n    // Check toggle\r\n    const val = getAutobuyerToggle(upgDef.area, upgDef.id);\r\n    \r\n    // Default is ON (if not '0')\r\n    return val !== '0';\r\n}\r\n\r\n// --- Automation Mappings ---\r\n// Maps standard cost types to the ID of the automation upgrade that unlocks autobuy for them.\r\nconst COST_TYPE_TO_AUTOBUY_ID = {\r\n  coins: AUTOBUY_COIN_UPGRADES_ID,\r\n  books: AUTOBUY_BOOK_UPGRADES_ID,\r\n  gold: AUTOBUY_GOLD_UPGRADES_ID,\r\n  magic: AUTOBUY_MAGIC_UPGRADES_ID,\r\n  dna: AUTOBUY_DNA_UPGRADES_ID\r\n};\r\n\r\n\r\n\r\nfunction resolveUpgradeId(upgLike) {\r\n  if (!upgLike) return null;\r\n  const rawId = typeof upgLike.id !== 'undefined' ? upgLike.id : upgLike;\r\n  if (typeof rawId === 'number') {\r\n    return Number.isFinite(rawId) ? Math.trunc(rawId) : null;\r\n  }\r\n  if (typeof rawId === 'string') {\r\n    const parsed = Number.parseInt(rawId.trim(), 10);\r\n    return Number.isFinite(parsed) ? parsed : null;\r\n  }\r\n  return null;\r\n}\r\n\r\nfunction isForgeUnlockUpgrade(upgLike, mode) {\r\n  return mode === 'standard' && resolveUpgradeId(upgLike) === FORGE_UNLOCK_UPGRADE_ID;\r\n}\r\n\r\nfunction getShopUiData(areaKey) {\r\n    const defs = getUpgradesForArea(areaKey);\r\n    const upgrades = {};\r\n    for (const def of defs) {\r\n        const lvlBn = getLevel(areaKey, def.id);\r\n        const lvlNum = getLevelNumber(areaKey, def.id);\r\n        const lockState = getUpgradeLockState(areaKey, def.id);\r\n        const icon = lockState.iconOverride ?? getIconUrl(def);\r\n        const title = lockState.titleOverride ?? def.title;\r\n        const desc = lockState.descOverride ?? def.desc;\r\n        const locked = !!lockState.locked;\r\n        const hmReady = (def.upgType === 'HM')\r\n            ? !!upgradeUiModel(areaKey, def.id)?.hmReadyToEvolve\r\n            : false;\r\n        upgrades[def.id] = {\r\n            id: def.id,\r\n            icon,\r\n            title,\r\n            desc,\r\n            level: lvlBn,\r\n            levelNumeric: lvlNum,\r\n            area: def.area,\r\n            meta: def,\r\n            locked,\r\n            lockState,\r\n            useLockedBase: !!lockState.useLockedBase || locked,\r\n            baseIconOverride: normalizeUpgradeIconPath(def.baseIconOverride || lockState.baseIconOverride),\r\n            hmReady,\r\n        };\r\n    }\r\n    return upgrades;\r\n}\r\n\r\nconst SHOP_ADAPTERS = {\r\n    standard: {\r\n        title: 'Shop',\r\n        delveButtonVisible: true,\r\n        getUiData: () => getShopUiData(getCurrentAreaKey()),\r\n        getUiModel: (id) => upgradeUiModel(getCurrentAreaKey(), id),\r\n        buyOne: (id) => buyOne(getCurrentAreaKey(), id),\r\n        buyMax: (id) => buyMax(getCurrentAreaKey(), id),\r\n        buyCheap: (id) => buyCheap(getCurrentAreaKey(), id),\r\n        buyNext: (id, amount) => buyTowards(getCurrentAreaKey(), id, amount),\r\n        getLockState: (id) => getUpgradeLockState(getCurrentAreaKey(), id),\r\n        evolve: (id) => evolveUpgrade(getCurrentAreaKey(), id),\r\n        events: ['ccc:upgrades:changed', 'currency:change', 'xp:change', 'xp:unlock', MERCHANT_MET_EVENT, 'forge:completed', 'unlock:change']\r\n    },\r\n    automation: {\r\n        title: 'Automation Shop',\r\n        delveButtonVisible: false,\r\n        getUiData: () => getShopUiData(AUTOMATION_AREA_KEY),\r\n        getUiModel: (id) => upgradeUiModel(AUTOMATION_AREA_KEY, id),\r\n        buyOne: (id) => buyOne(AUTOMATION_AREA_KEY, id),\r\n        buyMax: (id) => buyMax(AUTOMATION_AREA_KEY, id),\r\n        buyCheap: (id) => buyCheap(AUTOMATION_AREA_KEY, id),\r\n        buyNext: (id, amount) => buyTowards(AUTOMATION_AREA_KEY, id, amount),\r\n        getLockState: (id) => getUpgradeLockState(AUTOMATION_AREA_KEY, id),\r\n        evolve: () => ({ evolved: false }),\r\n        events: ['ccc:upgrades:changed', 'currency:change']\r\n    },\r\n    dna: {\r\n        title: 'DNA Upgrades',\r\n        delveButtonVisible: false,\r\n        getUiData: () => getShopUiData(DNA_AREA_KEY),\r\n        getUiModel: (id) => upgradeUiModel(DNA_AREA_KEY, id),\r\n        buyOne: (id) => buyOne(DNA_AREA_KEY, id),\r\n        buyMax: (id) => buyMax(DNA_AREA_KEY, id),\r\n        buyCheap: (id) => buyCheap(DNA_AREA_KEY, id),\r\n        buyNext: (id, amount) => buyTowards(DNA_AREA_KEY, id, amount),\r\n        getLockState: (id) => getUpgradeLockState(DNA_AREA_KEY, id),\r\n        evolve: (id) => evolveUpgrade(DNA_AREA_KEY, id),\r\n        events: ['ccc:upgrades:changed', 'currency:change']\r\n    }\r\n};\r\n\r\nfunction getAdapter(mode) {\r\n    return SHOP_ADAPTERS[mode] || SHOP_ADAPTERS.standard;\r\n}\r\n\r\nif (typeof window !== 'undefined') {\r\n  window.addEventListener('debug:change', (e) => {\r\n    const activeSlot = typeof getActiveSlot === 'function' ? getActiveSlot() : null;\r\n    const targetSlot = e?.detail?.slot ?? activeSlot;\r\n    if (activeSlot != null && targetSlot != null && activeSlot !== targetSlot) return;\r\n    updateShopOverlay(true);\r\n  });\r\n}\r\n\r\n// --- Utils ---\r\nexport function blockInteraction(ms = 140) {\r\n  if (!IS_MOBILE) return;\r\n\r\n  let shield = document.getElementById('ccc-tap-shield');\r\n  if (!shield) {\r\n    shield = document.createElement('div');\r\n    shield.id = 'ccc-tap-shield';\r\n    Object.assign(shield.style, {\r\n      position: 'fixed', inset: '0', zIndex: '2147483647',\r\n      pointerEvents: 'auto', background: 'transparent'\r\n    });\r\n    const eat = (e) => { e.stopPropagation(); e.preventDefault(); };\r\n    ['pointerdown','pointerup','click','touchstart','touchend','mousedown','mouseup']\r\n      .forEach(ev => shield.addEventListener(ev, eat, { capture: true, passive: false }));\r\n  }\r\n  document.body.appendChild(shield);\r\n  clearTimeout(shield.__t);\r\n  shield.__t = setTimeout(() => shield.remove(), ms);\r\n}\r\n\r\nfunction stripTags(html) {\r\n  return String(html ?? '').replace(/<[^>]*>/g, '');\r\n}\r\n\r\nexport function getCurrencyLabel(type, amountBn) {\r\n  if (type === 'gold') return 'Gold';\r\n  if (type === 'magic') return 'Magic';\r\n  if (type === 'dna') return 'DNA';\r\n  \r\n  let isOne = false;\r\n  if (amountBn && typeof amountBn.cmp === 'function') {\r\n      isOne = !amountBn.isInfinite() && amountBn.cmp(1) === 0;\r\n  } else {\r\n      try {\r\n          const bn = BigNum.fromAny(amountBn);\r\n          isOne = !bn.isInfinite() && bn.cmp(1) === 0;\r\n      } catch {\r\n          isOne = (amountBn == 1 || amountBn === '1');\r\n      }\r\n  }\r\n\r\n  if (type === 'coins') return isOne ? 'Coin' : 'Coins';\r\n  if (type === 'books') return isOne ? 'Book' : 'Books';\r\n  if (type === 'gears') return isOne ? 'Gear' : 'Gears';\r\n  \r\n  return type ? (type.charAt(0).toUpperCase() + type.slice(1)) : '';\r\n}\r\n\r\n// --- Audio ---\r\nconst PURCHASE_SFX_SRC = 'sounds/purchase_upg.ogg';\r\nconst EVOLVE_SFX_SRC = 'sounds/evolve_upg.ogg';\r\nconst MOBILE_PURCHASE_VOLUME = 0.12;\r\nconst DESKTOP_PURCHASE_VOLUME = 0.3;\r\n\r\nexport function playPurchaseSfx() { \r\n    const vol = IS_MOBILE ? MOBILE_PURCHASE_VOLUME : DESKTOP_PURCHASE_VOLUME;\r\n    playAudio(PURCHASE_SFX_SRC, { volume: vol });\r\n}\r\n\r\nfunction playEvolveSfx() { \r\n    const vol = IS_MOBILE ? (MOBILE_PURCHASE_VOLUME * 2) : (DESKTOP_PURCHASE_VOLUME * 2);\r\n    playAudio(EVOLVE_SFX_SRC, { volume: vol });\r\n}\r\n\r\n// Deprecated: createSfxPlayer is no longer used, but kept as a no-op if other modules import it (none currently).\r\nexport function createSfxPlayer() { return { play() {} }; }\r\n\r\nfunction currencyIconHTML(type) {\r\n  const src = CURRENCY_ICON_SRC[type] || CURRENCY_ICON_SRC.coins;\r\n  return `<img alt=\"\" src=\"${src}\" class=\"currency-ico\">`;\r\n}\r\n\r\n// 1\u00D71 transparent WebP\r\nconst TRANSPARENT_PX = \"data:image/webp;base64,UklGRhIAAABXRUJQVlA4IBgAAAAwAQCdASoIAAIAAAAcJaQAA3AA\";\r\n\r\n// --- Custom Scrollbar ---\r\nconst SCROLL_TIMELINE_STYLES_ID = 'ccc-scroll-timeline-styles';\r\nfunction injectScrollTimelineStyles() {\r\n  if (document.getElementById(SCROLL_TIMELINE_STYLES_ID)) return;\r\n  const style = document.createElement('style');\r\n  style.id = SCROLL_TIMELINE_STYLES_ID;\r\n  style.textContent = `\r\n    @keyframes scroll-thumb-move {\r\n      0% { transform: translate(0, 0); }\r\n      100% { transform: translate(var(--thumb-x, 0), var(--thumb-y, 0)); }\r\n    }\r\n  `;\r\n  document.head.appendChild(style);\r\n}\r\n\r\nexport function ensureCustomScrollbar(overlayEl, sheetEl, scrollerSelector = '.shop-scroller', options = {}) {\r\n  const { orientation = 'vertical' } = options;\r\n  const isVertical = orientation === 'vertical';\r\n\r\n  const scroller = overlayEl?.querySelector(scrollerSelector);\r\n  if (!scroller || scroller.__customScroll) return;\r\n\r\n  const bar = document.createElement('div');\r\n  bar.className = `shop-scrollbar${isVertical ? '' : ' is-horizontal'}`;\r\n  const thumb = document.createElement('div');\r\n  thumb.className = 'shop-scrollbar__thumb';\r\n  bar.appendChild(thumb);\r\n  sheetEl.appendChild(bar);\r\n\r\n  scroller.__customScroll = { bar, thumb };\r\n\r\n  const isTouch = window.matchMedia('(hover: none) and (pointer: coarse)').matches;\r\n  const FADE_SCROLL_MS = 150;\r\n  const FADE_DRAG_MS = 120;\r\n  const supportsScrollEnd = 'onscrollend' in window;\r\n\r\n  // --- Scroll-Driven Animation Support Check ---\r\n  const supportsTimelineScope = CSS.supports('timeline-scope', 'none');\r\n  const useCssTimeline = supportsTimelineScope && CSS.supports('animation-timeline', 'scroll()');\r\n\r\n  if (useCssTimeline) {\r\n    injectScrollTimelineStyles();\r\n    const uniqueId = Math.random().toString(36).slice(2, 8);\r\n    const timelineName = `--custom-scroll-${uniqueId}`;\r\n    \r\n    sheetEl.style.timelineScope = timelineName;\r\n    scroller.style.scrollTimelineName = timelineName;\r\n    scroller.style.scrollTimelineAxis = isVertical ? 'block' : 'inline';\r\n    \r\n    thumb.style.animationName = 'scroll-thumb-move';\r\n    thumb.style.animationTimeline = timelineName;\r\n    thumb.style.animationDuration = '1ms'; // Required syntax, though driven by timeline\r\n    thumb.style.animationTimingFunction = 'linear';\r\n    thumb.style.animationFillMode = 'both';\r\n  }\r\n\r\n  // --- Cached Metrics to Avoid Layout Thrashing ---\r\n  let cachedMetrics = {\r\n    scrollSize: 0,\r\n    clientSize: 0,\r\n    barSize: 0,\r\n    thumbSize: 0,\r\n    maxScroll: 1,\r\n    range: 0,\r\n    visibleRatio: 1\r\n  };\r\n\r\n  let lastShadow = null;\r\n  \r\n  // rAF loop state\r\n  let isScrollTickPending = false;\r\n  let scrollTimeout = null;\r\n\r\n  const updateBounds = () => {\r\n    if (!scroller.isConnected || !sheetEl.isConnected) return;\r\n    const scrollerRect = scroller.getBoundingClientRect();\r\n    const sheetRect = sheetEl.getBoundingClientRect();\r\n    \r\n    if (isVertical) {\r\n      const top = Math.max(0, scrollerRect.top - sheetRect.top);\r\n      const bottom = Math.max(0, sheetRect.bottom - scrollerRect.bottom);\r\n      bar.style.top = top + 'px';\r\n      bar.style.bottom = bottom + 'px';\r\n      bar.style.left = ''; bar.style.right = ''; \r\n    } else {\r\n      const left = Math.max(0, scrollerRect.left - sheetRect.left);\r\n      const right = Math.max(0, sheetRect.right - scrollerRect.right);\r\n      bar.style.left = left + 'px';\r\n      bar.style.right = right + 'px';\r\n      bar.style.top = ''; bar.style.bottom = '';\r\n      bar.style.height = '';\r\n    }\r\n  };\r\n\r\n  const updateMetrics = () => {\r\n    const scrollSize = isVertical ? scroller.scrollHeight : scroller.scrollWidth;\r\n    const clientSize = isVertical ? scroller.clientHeight : scroller.clientWidth;\r\n    // Use clientSize as barSize fallback, assuming bar matches scroller dim\r\n    const barSize = isVertical ? (bar.clientHeight || clientSize) : (bar.clientWidth || clientSize);\r\n    \r\n    const visibleRatio = clientSize / Math.max(1, scrollSize);\r\n    const thumbSize = Math.max(28, Math.round(barSize * visibleRatio));\r\n    const maxScroll = Math.max(1, scrollSize - clientSize);\r\n    const range = Math.max(0, barSize - thumbSize);\r\n\r\n    cachedMetrics = { scrollSize, clientSize, barSize, thumbSize, maxScroll, range, visibleRatio };\r\n    \r\n    if (isVertical) {\r\n      thumb.style.height = thumbSize + 'px';\r\n      thumb.style.width = '100%';\r\n    } else {\r\n      thumb.style.width = thumbSize + 'px';\r\n      thumb.style.height = '100%';\r\n    }\r\n\r\n    if (useCssTimeline) {\r\n      if (isVertical) {\r\n        thumb.style.setProperty('--thumb-y', `${range}px`);\r\n        thumb.style.setProperty('--thumb-x', '0px');\r\n      } else {\r\n        thumb.style.setProperty('--thumb-x', `${range}px`);\r\n        thumb.style.setProperty('--thumb-y', '0px');\r\n      }\r\n    }\r\n\r\n    const hasOverflow = (scrollSize > clientSize + 1);\r\n    bar.style.display = hasOverflow ? '' : 'none';\r\n    sheetEl?.classList.toggle('has-active-scrollbar', hasOverflow);\r\n    \r\n    // Force immediate visual update on metric change\r\n    performScrollUpdate(); \r\n  };\r\n\r\n  const performScrollUpdate = () => {\r\n    isScrollTickPending = false;\r\n    \r\n    const scrollPos = isVertical ? scroller.scrollTop : scroller.scrollLeft;\r\n    \r\n    // 1. Shadow\r\n    const hasShadow = (scrollPos || 0) > 0;\r\n    if (lastShadow !== hasShadow) {\r\n      lastShadow = hasShadow;\r\n      sheetEl?.classList.toggle('has-scroll-shadow', hasShadow);\r\n    }\r\n\r\n    // 2. Thumb Position (if not using CSS Timeline)\r\n    if (!useCssTimeline) {\r\n        const { maxScroll, range } = cachedMetrics;\r\n        const pos = Math.round((scrollPos / maxScroll) * range);\r\n        if (isVertical) {\r\n          thumb.style.transform = `translateY(${pos}px)`;\r\n        } else {\r\n          thumb.style.transform = `translateX(${pos}px)`;\r\n        }\r\n    }\r\n    \r\n    if (isTouch) showBar();\r\n  };\r\n\r\n  const updateAll = () => { updateBounds(); updateMetrics(); };\r\n  if (scroller.__customScroll) scroller.__customScroll.update = updateAll;\r\n\r\n  // Debounce for mutation observer to prevent layout thrashing on frequent updates\r\n  let debounceTimer;\r\n  const debouncedUpdateAll = () => {\r\n      clearTimeout(debounceTimer);\r\n      debounceTimer = setTimeout(updateAll, 100);\r\n  };\r\n\r\n  if (typeof MutationObserver !== 'undefined') {\r\n      const obs = new MutationObserver(() => debouncedUpdateAll());\r\n      obs.observe(scroller, { childList: true, subtree: true, characterData: true });\r\n  }\r\n\r\n  const showBar = () => { if (!isTouch) return; sheetEl.classList.add('is-scrolling'); clearTimeout(scroller.__fadeTimer); };\r\n  const scheduleHide = (delay) => { if (!isTouch) return; clearTimeout(scroller.__fadeTimer); scroller.__fadeTimer = setTimeout(() => { sheetEl.classList.remove('is-scrolling'); }, delay); };\r\n  \r\n  const onScroll = () => { \r\n      if (!scrollingElements.has(scroller)) {\r\n          scrollingElements.add(scroller);\r\n      }\r\n      clearTimeout(scrollTimeout);\r\n      scrollTimeout = setTimeout(() => {\r\n          if (scrollingElements.has(scroller)) {\r\n              scrollingElements.delete(scroller);\r\n              window.dispatchEvent(new CustomEvent('menu:scrollStop'));\r\n          }\r\n      }, 150);\r\n\r\n      if (!isScrollTickPending) {\r\n          isScrollTickPending = true;\r\n          window.requestAnimationFrame(performScrollUpdate);\r\n      }\r\n      if (!supportsScrollEnd) scheduleHide(FADE_SCROLL_MS); \r\n  };\r\n  const onScrollEnd = () => scheduleHide(FADE_SCROLL_MS);\r\n\r\n  scroller.addEventListener('scroll', onScroll, { passive: true });\r\n  if (supportsScrollEnd) scroller.addEventListener('scrollend', onScrollEnd, { passive: true });\r\n\r\n  const ro = new ResizeObserver(() => {\r\n     updateAll(); \r\n  });\r\n  ro.observe(scroller);\r\n  window.addEventListener('resize', updateAll);\r\n  requestAnimationFrame(updateAll); // Initial kick\r\n\r\n  // Drag logic\r\n  let dragging = false;\r\n  let dragStartPos = 0;\r\n  let startScrollPos = 0;\r\n  \r\n  const startDrag = (e) => { \r\n    dragging = true; \r\n    dragStartPos = isVertical ? e.clientY : e.clientX; \r\n    startScrollPos = isVertical ? scroller.scrollTop : scroller.scrollLeft; \r\n    thumb.classList.add('dragging'); \r\n    showBar(); \r\n    try { thumb.setPointerCapture(e.pointerId); } catch {} \r\n    e.preventDefault(); \r\n  };\r\n  \r\n  const onDragMove = (e) => { \r\n    if (!dragging) return; \r\n    const { range, maxScroll } = cachedMetrics;\r\n    if (range <= 0) return;\r\n    \r\n    const currentPos = isVertical ? e.clientY : e.clientX;\r\n    const delta = currentPos - dragStartPos; \r\n    \r\n    const newPos = startScrollPos + (delta / range) * maxScroll;\r\n    if (isVertical) scroller.scrollTop = newPos;\r\n    else scroller.scrollLeft = newPos;\r\n  };\r\n  \r\n  const endDrag = (e) => { \r\n    if (!dragging) return; \r\n    dragging = false; \r\n    thumb.classList.remove('dragging'); \r\n    scheduleHide(FADE_DRAG_MS); \r\n    try { thumb.releasePointerCapture(e.pointerId); } catch {} \r\n  };\r\n  \r\n  thumb.addEventListener('pointerdown', startDrag);\r\n  window.addEventListener('pointermove', onDragMove, { passive: true });\r\n  window.addEventListener('pointerup', endDrag);\r\n  window.addEventListener('pointercancel', endDrag);\r\n  \r\n  bar.addEventListener('pointerdown', (e) => { \r\n    if (e.target === thumb) return; \r\n    const rect = bar.getBoundingClientRect(); \r\n    const clickPos = isVertical ? (e.clientY - rect.top) : (e.clientX - rect.left); \r\n    const { thumbSize, range, maxScroll } = cachedMetrics;\r\n    \r\n    const targetPos = Math.max(0, Math.min(clickPos - thumbSize / 2, range)); \r\n    \r\n    const newScroll = (targetPos / Math.max(1, range)) * maxScroll;\r\n    if (isVertical) scroller.scrollTop = newScroll;\r\n    else scroller.scrollLeft = newScroll;\r\n    \r\n    showBar(); \r\n    scheduleHide(FADE_SCROLL_MS); \r\n  });\r\n\r\n  updateAll();\r\n}\r\n\r\n// --- Logic Helpers ---\r\nfunction levelsRemainingToCap(upg, currentLevelBn, currentLevelNumber) {\r\n  if (!upg) return BigNum.fromInt(0);\r\n  const capBn = upg.lvlCapBn?.clone?.() ?? (Number.isFinite(upg.lvlCap) ? BigNum.fromAny(upg.lvlCap) : null);\r\n  if (!capBn) return BigNum.fromInt(0);\r\n  if (capBn.isInfinite?.()) return BigNum.fromAny('Infinity');\r\n\r\n  let lvlBn;\r\n  try { lvlBn = currentLevelBn instanceof BigNum ? currentLevelBn : BigNum.fromAny(currentLevelBn ?? currentLevelNumber ?? 0); } \r\n  catch { const fallback = Math.max(0, Math.floor(Number(currentLevelNumber) || 0)); lvlBn = BigNum.fromInt(fallback); }\r\n  \r\n  if (lvlBn.isInfinite?.()) return BigNum.fromInt(0);\r\n  try {\r\n    const capPlain = capBn.toPlainIntegerString?.();\r\n    const lvlPlain = lvlBn.toPlainIntegerString?.();\r\n    if (capPlain === 'Infinity') return BigNum.fromAny('Infinity');\r\n    if (capPlain && lvlPlain && capPlain !== 'Infinity' && lvlPlain !== 'Infinity') {\r\n      const delta = BigInt(capPlain) - BigInt(lvlPlain);\r\n      if (delta > 0n) return BigNum.fromAny(delta.toString());\r\n      return BigNum.fromInt(0);\r\n    }\r\n  } catch {}\r\n  \r\n  const capNumber = Number.isFinite(upg.lvlCap) ? Math.max(0, Math.floor(upg.lvlCap)) : Infinity;\r\n  if (!Number.isFinite(capNumber)) return BigNum.fromAny('Infinity');\r\n  const lvlNumber = Math.max(0, Math.floor(Number(currentLevelNumber) || 0));\r\n  const room = Math.max(0, capNumber - lvlNumber);\r\n  return BigNum.fromInt(room);\r\n}\r\n\r\nfunction computeAffordableLevels(upg, currentLevelNumeric, currentLevelBn) {\r\n  let lvlBn;\r\n  try { lvlBn = currentLevelBn instanceof BigNum ? currentLevelBn : BigNum.fromAny(currentLevelBn ?? currentLevelNumeric ?? 0); }\r\n  catch { const fallback = Math.max(0, Math.floor(Number(currentLevelNumeric) || 0)); lvlBn = BigNum.fromInt(fallback); }\r\n  if (lvlBn.isInfinite?.()) return BigNum.fromInt(0);\r\n\r\n  const lvl = Math.max(0, Math.floor(Number(currentLevelNumeric) || 0));\r\n  const cap = Number.isFinite(upg.lvlCap) ? Math.max(0, Math.floor(upg.lvlCap)) : Infinity;\r\n\r\n  const walletEntry = bank[upg.costType];\r\n  const walletValue = walletEntry?.value;\r\n  const walletBn = walletValue instanceof BigNum ? walletValue : BigNum.fromAny(walletValue ?? 0);\r\n  if (walletBn.isZero?.()) return BigNum.fromInt(0);\r\n\r\n  if (walletBn.isInfinite?.()) {\r\n    const isHmType = upg?.upgType === 'HM';\r\n    const maxed = Number.isFinite(cap) && lvl >= cap;\r\n    if ((isHmType && !maxed) || !Number.isFinite(cap)) return BigNum.fromAny('Infinity');\r\n    return levelsRemainingToCap(upg, lvlBn, currentLevelNumeric);\r\n  }\r\n  if (Number.isFinite(cap) && lvl >= cap) return BigNum.fromInt(0);\r\n\r\n  try {\r\n    if (typeof upg.costAtLevel === 'function') {\r\n        const c0 = BigNum.fromAny(upg.costAtLevel(lvl));\r\n        const c1 = BigNum.fromAny(upg.costAtLevel(lvl + 1)); \r\n        const farProbeLevel = Math.min(Number.isFinite(cap) ? cap : lvl + 32, lvl + 32);\r\n        const cFar = BigNum.fromAny(upg.costAtLevel(farProbeLevel));\r\n        const isTrulyFlat = c0.cmp(c1) === 0 && c0.cmp(cFar) === 0;\r\n\r\n        if (isTrulyFlat) {\r\n          const remainingBn = levelsRemainingToCap(upg, lvlBn, lvl);\r\n          const room = Number.isFinite(upg.lvlCap) ? Math.min(Math.max(0, Math.floor(Number(remainingBn.toString()))), Number.MAX_SAFE_INTEGER - 2) : Number.MAX_SAFE_INTEGER;\r\n          let lo = 0, hi = Math.max(0, room);\r\n          while (lo < hi) {\r\n            const mid = Math.floor((lo + hi + 1) / 2);\r\n            const midBn = BigNum.fromInt(mid);\r\n            const total = typeof c0.mulBigNumInteger === 'function' ? c0.mulBigNumInteger(midBn) : BigNum.fromAny(c0 ?? 0).mulBigNumInteger(midBn);\r\n            if (total.cmp(walletBn) <= 0) lo = mid; else hi = mid - 1;\r\n          }\r\n          return BigNum.fromInt(lo);\r\n        }\r\n    }\r\n  } catch {}\r\n  \r\n  const room = Number.isFinite(cap) ? Math.max(0, cap - lvl) : undefined;\r\n  const { count } = evaluateBulkPurchase(upg, lvlBn, walletBn, room, { fastOnly: true });\r\n  return count ?? BigNum.fromInt(0);\r\n}\r\n\r\n// --- Shop Instance Class ---\r\n\r\nclass ShopInstance {\r\n    constructor(mode) {\r\n        this.mode = mode;\r\n        this.overlayEl = null;\r\n        this.sheetEl = null;\r\n        this.isOpen = false;\r\n        this.eventsBound = false;\r\n        this.closeTimer = null;\r\n        this.postOpenPointer = false;\r\n        this.upgrades = {};\r\n        this.delveBtnEl = null;\r\n        this.updateHandler = this.update.bind(this);\r\n    }\r\n    \r\n    get adapter() {\r\n        return getAdapter(this.mode);\r\n    }\r\n    \r\n    get delveButtonVisible() {\r\n        return this.adapter.delveButtonVisible;\r\n    }\r\n    \r\n    updateDelveGlow() {\r\n        if (!this.delveBtnEl || this.mode !== 'standard') return;\r\n        const met = hasMetMerchant();\r\n        let shouldGlow = !met;\r\n        \r\n        const slot = getActiveSlot();\r\n        if (slot != null && localStorage.getItem(`ccc:tsunami:labPending:${slot}`) === '1') {\r\n            shouldGlow = true;\r\n        }\r\n        \r\n        this.delveBtnEl.classList.toggle('is-new', shouldGlow);\r\n    }\r\n\r\n    buildUpgradesData() {\r\n        this.upgrades = this.adapter.getUiData();\r\n    }\r\n    \r\n    render() {\r\n        const grid = this.overlayEl?.querySelector('.shop-grid');\r\n        if (!grid) return;\r\n        \r\n        const seenIds = new Set();\r\n        \r\n        for (const key in this.upgrades) {\r\n            const upg = this.upgrades[key];\r\n            seenIds.add(String(upg.id));\r\n            \r\n            let btn = grid.querySelector(`.shop-upgrade[data-upg-id=\"${upg.id}\"]`);\r\n            if (!btn) {\r\n                btn = document.createElement('button');\r\n                btn.className = 'shop-upgrade';\r\n                btn.setAttribute('data-upgid', upg.id);\r\n                btn.type = 'button';\r\n                btn.setAttribute('role', 'gridcell');\r\n                btn.dataset.upgId = String(upg.id);\r\n                \r\n                const tile = document.createElement('div');\r\n                tile.className = 'shop-tile';\r\n                const baseImg = document.createElement('img');\r\n                baseImg.className = 'base';\r\n                baseImg.alt = '';\r\n                const iconImg = document.createElement('img');\r\n                iconImg.className = 'icon';\r\n                iconImg.alt = '';\r\n                iconImg.addEventListener('error', () => { iconImg.src = TRANSPARENT_PX; });\r\n                \r\n                tile.appendChild(baseImg);\r\n                tile.appendChild(iconImg);\r\n                btn.appendChild(tile);\r\n                grid.appendChild(btn);\r\n                \r\n                // Listeners\r\n                btn.addEventListener('click', (event) => {\r\n                    const el = event.currentTarget;\r\n                    if (el.disabled || el.dataset.lockedPlain === '1') {\r\n                        event.preventDefault();\r\n                        event.stopImmediatePropagation();\r\n                        return;\r\n                    }\r\n                    if (shouldSkipGhostTap(el)) {\r\n                        event.preventDefault();\r\n                        event.stopImmediatePropagation();\r\n                        return;\r\n                    }\r\n\r\n                    if (event.shiftKey || event.ctrlKey) {\r\n                        event.preventDefault();\r\n                        event.stopImmediatePropagation();\r\n                        if (!el.upgMeta) return;\r\n\r\n                        const id = el.upgMeta.id;\r\n                        const isHM = el.upgMeta.upgType === 'HM';\r\n                        const isExcludedCheap = [1, 3, 4, 5, 6].includes(resolveUpgradeId(el.upgMeta));\r\n\r\n                        // Shift + Click -> Buy Cheap\r\n                        if (event.shiftKey) {\r\n                            if (isHM || !isExcludedCheap) {\r\n                                if (this.adapter.buyCheap) {\r\n                                    const { bought } = this.adapter.buyCheap(id);\r\n                                    const boughtBn = bought instanceof BigNum ? bought : BigNum.fromAny(bought ?? 0);\r\n                                    if (!boughtBn.isZero?.()) {\r\n                                        playPurchaseSfx();\r\n                                        this.update();\r\n                                    }\r\n                                    return;\r\n                                }\r\n                            }\r\n                            // Fallback to Buy Max\r\n                            const { bought } = this.adapter.buyMax(id);\r\n                            const boughtBn = bought instanceof BigNum ? bought : BigNum.fromAny(bought ?? 0);\r\n                            if (!boughtBn.isZero?.()) {\r\n                                playPurchaseSfx();\r\n                                if (isForgeUnlockUpgrade(el.upgMeta, this.mode)) {\r\n                                    try { unlockMerchantTabs(['reset']); } catch {}\r\n                                }\r\n                                this.update();\r\n                            }\r\n                            return;\r\n                        }\r\n\r\n                        // Ctrl + Click -> Buy Next (HM only)\r\n                        if (event.ctrlKey) {\r\n                            if (isHM) {\r\n                                const model = this.adapter.getUiModel(id);\r\n                                if (model) {\r\n                                    if (!model.hmReadyToEvolve) {\r\n                                        const target = model.hmNextMilestone;\r\n                                        if (target && model.lvlBn && target.cmp(model.lvlBn) > 0) {\r\n                                            let deltaNum = 0;\r\n                                            try {\r\n                                                const diffPlain = target.sub(model.lvlBn).toPlainIntegerString?.();\r\n                                                deltaNum = Math.max(0, Math.floor(Number((diffPlain && diffPlain !== 'Infinity') ? diffPlain : target.sub(model.lvlBn).toString())));\r\n                                            } catch {}\r\n\r\n                                            const walletRaw = bank[model.upg.costType]?.value;\r\n                                            const walletBn = walletRaw instanceof BigNum ? walletRaw : BigNum.fromAny(walletRaw ?? 0);\r\n                                            const evalResult = evaluateBulkPurchase(model.upg, model.lvlBn, walletBn, deltaNum);\r\n                                            const count = evalResult.count;\r\n\r\n                                            let reachable = false;\r\n                                            try { const plain = count?.toPlainIntegerString?.(); reachable = (plain && plain !== 'Infinity') ? Number(plain) >= deltaNum : Number(count ?? 0) >= deltaNum; } catch {}\r\n\r\n                                            if (reachable) {\r\n                                                const purchase = this.adapter.buyNext(id, deltaNum);\r\n                                                const boughtBn = purchase.bought instanceof BigNum ? purchase.bought : BigNum.fromAny(purchase.bought ?? 0);\r\n                                                if (!boughtBn.isZero?.()) {\r\n                                                    playPurchaseSfx();\r\n                                                    this.update();\r\n                                                }\r\n                                                return;\r\n                                            }\r\n                                        }\r\n                                    }\r\n                                }\r\n                            }\r\n\r\n                            // Fallback to Buy Max\r\n                            const { bought } = this.adapter.buyMax(id);\r\n                            const boughtBn = bought instanceof BigNum ? bought : BigNum.fromAny(bought ?? 0);\r\n                            if (!boughtBn.isZero?.()) {\r\n                                playPurchaseSfx();\r\n                                if (isForgeUnlockUpgrade(el.upgMeta, this.mode)) {\r\n                                    try { unlockMerchantTabs(['reset']); } catch {}\r\n                                }\r\n                                this.update();\r\n                            }\r\n                            return;\r\n                        }\r\n                    }\r\n\r\n                    if (el.upgMeta) openUpgradeOverlay(el.upgMeta, this.mode);\r\n                });\r\n                \r\n                btn.addEventListener('contextmenu', (e) => {\r\n                    if (IS_MOBILE) return;\r\n                    const el = e.currentTarget;\r\n                    if (el.dataset.locked === '1') return;\r\n                    e.preventDefault();\r\n                    e.stopPropagation();\r\n                    \r\n                    if (!el.upgMeta) return;\r\n\t\t\t\t\t\r\n                    const model = this.adapter.getUiModel(el.upgMeta.id);\r\n                    if (model?.hmReadyToEvolve) {\r\n                        const { evolved } = this.adapter.evolve(el.upgMeta.id);\r\n                        if (evolved) {\r\n                            playEvolveSfx();\r\n                            this.update();\r\n                        }\r\n                        return;\r\n                    }\r\n\t\t\t\t\t\r\n                    const { bought } = this.adapter.buyMax(el.upgMeta.id);\r\n                    const boughtBn = bought instanceof BigNum ? bought : BigNum.fromAny(bought ?? 0);\r\n                    \r\n                    if (!boughtBn.isZero?.()) {\r\n                        playPurchaseSfx();\r\n                        if (isForgeUnlockUpgrade(el.upgMeta, this.mode)) {\r\n                            try { unlockMerchantTabs(['reset']); } catch {}\r\n                        }\r\n                        this.update();\r\n                    }\r\n                });\r\n            }\r\n            \r\n            // Update Meta\r\n            btn.upgMeta = upg.meta;\r\n            \r\n            // Logic derived from original renderShopGrid...\r\n            const locked = !!upg.locked;\r\n            const lockIcon = upg.lockState?.iconOverride;\r\n            const hasMysteriousIcon = typeof lockIcon === 'string' && lockIcon.includes('mysterious');\r\n            const isMysterious = locked && (upg.lockState?.hidden || hasMysteriousIcon);\r\n            const isPlainLocked = locked && !isMysterious;\r\n\r\n            btn.classList.toggle('is-locked', locked);\r\n            btn.classList.toggle('is-locked-plain', isPlainLocked);\r\n            btn.disabled = isPlainLocked;\r\n            if (isPlainLocked) {\r\n              btn.setAttribute('aria-disabled', 'true');\r\n              btn.setAttribute('tabindex', '-1');\r\n            } else {\r\n              btn.removeAttribute('aria-disabled');\r\n              btn.removeAttribute('tabindex');\r\n            }\r\n            btn.dataset.locked = locked ? '1' : '0';\r\n            btn.dataset.lockedPlain = isPlainLocked ? '1' : '0';\r\n            btn.dataset.mysterious = isMysterious ? '1' : '0';\r\n\r\n            const isHM = upg.meta?.upgType === 'HM';\r\n            const evolveReady = isHM && upg.hmReady;\r\n            btn.classList.toggle('hm-evolve-ready', evolveReady);\r\n            \r\n            const canPlusBn = locked ? BigNum.fromInt(0) : computeAffordableLevels(upg.meta, upg.levelNumeric, upg.level);\r\n            const plusBn = canPlusBn instanceof BigNum ? canPlusBn : BigNum.fromAny(canPlusBn);\r\n            const levelHtml = formatNumber(upg.level);\r\n            const levelPlain = stripTags(levelHtml);\r\n            const plusHtml = formatNumber(plusBn);\r\n            const plusPlain = stripTags(plusHtml);\r\n            const hasPlus = !plusBn.isZero?.();\r\n            \r\n            const rawCap = Number.isFinite(upg.lvlCap) ? upg.lvlCap : (Number.isFinite(upg.meta?.lvlCap) ? upg.meta.lvlCap : Infinity);\r\n            const capNumber = Number.isFinite(rawCap) ? Math.max(0, Math.floor(rawCap)) : Infinity;\r\n            const levelNumber = Number.isFinite(upg.levelNumeric) ? upg.levelNumeric : NaN;\r\n            const capReached = evolveReady ? false : (upg.level?.isInfinite?.() ? true : (Number.isFinite(capNumber) && Number.isFinite(levelNumber) ? levelNumber >= capNumber : false));\r\n            \r\n            const isSingleLevelCap = Number.isFinite(capNumber) && capNumber === 1;\r\n            const isUnlockUpgrade = !!upg.meta?.unlockUpgrade;\r\n            const showUnlockableBadge = !locked && isUnlockUpgrade && !capReached;\r\n            const showUnlockedBadge = !locked && isUnlockUpgrade && !showUnlockableBadge && capReached;\r\n\r\n            let badgeHtml, badgePlain, needsTwoLines = false, isTextBadge = false;\r\n\r\n            if (locked) {\r\n                badgeHtml = ''; badgePlain = '';\r\n                const reason = isMysterious ? (upg.lockState?.reason || '').trim() : '';\r\n                const ariaLabel = reason ? `${upg.title} (Locked, ${reason})` : `${upg.title} (Locked)`;\r\n                btn.setAttribute('aria-label', ariaLabel);\r\n            } else {\r\n                if (showUnlockableBadge || showUnlockedBadge) {\r\n                    badgeHtml = showUnlockableBadge ? 'Unlockable' : 'Unlocked';\r\n                    badgePlain = badgeHtml;\r\n                    isTextBadge = true;\r\n                } else if (!locked && isSingleLevelCap && !isUnlockUpgrade) {\r\n                    if (capReached) { badgeHtml = 'Owned'; badgePlain = 'Owned'; }\r\n                    else if (hasPlus) { badgeHtml = 'Purchasable'; badgePlain = 'Purchasable'; }\r\n                    else { badgeHtml = 'Not Owned'; badgePlain = 'Not Owned'; }\r\n                    isTextBadge = true;\r\n                } else {\r\n                    const numericLevel = Number.isFinite(upg.levelNumeric) ? upg.levelNumeric : NaN;\r\n                    const plainDigits = String(levelPlain || '').replace(/,/g, '');\r\n                    const isInf = /\u221E|Infinity/i.test(plainDigits);\r\n                    const over999 = Number.isFinite(numericLevel) ? numericLevel >= 1000 : (isInf || /^\\d{4,}$/.test(plainDigits));\r\n                    needsTwoLines = hasPlus && over999;\r\n                    if (needsTwoLines) {\r\n                        badgeHtml = `<span class=\"badge-lvl\">${levelHtml}</span><span class=\"badge-plus\">(+${plusHtml})</span>`;\r\n                        badgePlain = `${levelPlain} (+${plusPlain})`;\r\n                    } else {\r\n                        badgeHtml = hasPlus ? `${levelHtml} (+${plusHtml})` : levelHtml;\r\n                        badgePlain = hasPlus ? `${levelPlain} (+${plusPlain})` : levelPlain;\r\n                    }\r\n                }\r\n                btn.setAttribute('aria-label', `${upg.title}, ${badgePlain}`);\r\n            }\r\n            \r\n            if (locked) btn.title = isMysterious ? 'Hidden Upgrade' : 'Locked Upgrade';\r\n            else if (upg.meta?.unlockUpgrade) btn.title = 'Left-click: Details \u2022 Right-click: Unlock';\r\n            else btn.title = 'Left-click: Details \u2022 Right-click: Buy Max';\r\n            \r\n            // DOM Structure Update\r\n            const tileEl = btn.firstElementChild;\r\n            const baseImgEl = tileEl.querySelector('.base');\r\n            const iconImgEl = tileEl.querySelector('.icon');\r\n            \r\n            const costType = upg.meta?.costType || 'coins';\r\n            const useLockedBase = upg.useLockedBase || locked;\r\n            const baseSrc = useLockedBase ? LOCKED_BASE_ICON_SRC : (upg.baseIconOverride || BASE_ICON_SRC_BY_COST[costType] || BASE_ICON_SRC_BY_COST.coins);\r\n            if (baseImgEl.src !== baseSrc) baseImgEl.src = baseSrc;\r\n            \r\n            const rawIcon = upg.icon;\r\n            if (!rawIcon) {\r\n                if (!iconImgEl.hidden) iconImgEl.hidden = true;\r\n            } else {\r\n                if (iconImgEl.hidden) iconImgEl.hidden = false;\r\n                const iconSrc = rawIcon;\r\n                if (iconImgEl._lastSrc !== iconSrc) { iconImgEl.src = iconSrc; iconImgEl._lastSrc = iconSrc; }\r\n            }\r\n            \r\n            let maxedOverlay = tileEl.querySelector('.maxed-overlay');\r\n            const isAutomated = !locked && isUpgradeAutomated(upg.meta);\r\n            const showMaxed = !locked && capReached;\r\n            const showAutomated = !locked && !capReached && !evolveReady && isAutomated;\r\n\r\n            if (showMaxed || showAutomated) {\r\n                if (!maxedOverlay) {\r\n                    maxedOverlay = document.createElement('img');\r\n                    maxedOverlay.className = 'maxed-overlay';\r\n                    maxedOverlay.alt = '';\r\n                    tileEl.insertBefore(maxedOverlay, iconImgEl);\r\n                }\r\n\t\t\t\tconst targetSrc = showMaxed ? MAXED_BASE_OVERLAY_SRC : AUTOMATED_OVERLAY_SRC;\r\n                if (maxedOverlay.src !== targetSrc) maxedOverlay.src = targetSrc;\r\n            } else if (maxedOverlay) maxedOverlay.remove();\r\n            \r\n            let badge = tileEl.querySelector('.level-badge');\r\n            if (!locked) {\r\n                if (!badge) { badge = document.createElement('span'); badge.className = 'level-badge'; tileEl.appendChild(badge); }\r\n                badge.className = 'level-badge';\r\n                if (isTextBadge) badge.classList.add('text-badge');\r\n                if (needsTwoLines) badge.classList.add('two-line');\r\n                if (hasPlus || showUnlockableBadge) badge.classList.add('can-buy');\r\n                if (capReached) badge.classList.add('is-maxed');\r\n                if (badgeHtml === badgePlain) { if (badge.textContent !== badgeHtml) badge.textContent = badgeHtml; }\r\n                else { if (badge.innerHTML !== badgeHtml) badge.innerHTML = badgeHtml; }\r\n            } else if (badge) badge.remove();\r\n        }\r\n        \r\n        // Cleanup stale\r\n        Array.from(grid.children).forEach(child => {\r\n            if (child.dataset.upgId && !seenIds.has(child.dataset.upgId)) child.remove();\r\n        });\r\n    }\r\n\r\n    ensureOverlay() {\r\n        if (this.overlayEl) return;\r\n        \r\n        this.overlayEl = document.createElement('div');\r\n        this.overlayEl.className = 'shop-overlay';\r\n        if (this.mode === 'automation') {\r\n            this.overlayEl.classList.add('automation-shop-overlay');\r\n            // Unique ID not strictly required by CSS but useful\r\n            this.overlayEl.id = 'automation-shop-overlay'; \r\n        } else if (this.mode === 'dna') {\r\n            this.overlayEl.classList.add('dna-shop-overlay');\r\n            this.overlayEl.id = 'dna-shop-overlay';\r\n        } else {\r\n            this.overlayEl.id = 'shop-overlay';\r\n        }\r\n        \r\n        this.sheetEl = document.createElement('div');\r\n        this.sheetEl.className = 'shop-sheet';\r\n        this.sheetEl.setAttribute('role', 'dialog');\r\n        \r\n        const grabber = document.createElement('div');\r\n        grabber.className = 'shop-grabber';\r\n        grabber.innerHTML = `<div class=\"grab-handle\" aria-hidden=\"true\"></div>`;\r\n        \r\n        const content = document.createElement('div');\r\n        content.className = 'shop-content';\r\n        \r\n        const header = document.createElement('header');\r\n        header.className = 'shop-header';\r\n        header.innerHTML = `<div class=\"shop-title\">${this.adapter.title}</div><div class=\"shop-line\" aria-hidden=\"true\"></div>`;\r\n        \r\n        const grid = document.createElement('div');\r\n        grid.className = 'shop-grid';\r\n        if (this.mode === 'standard') grid.id = 'shop-grid'; // backwards compat for ID query\r\n        grid.setAttribute('role', 'grid');\r\n        \r\n        const scroller = document.createElement('div');\r\n        scroller.className = 'shop-scroller';\r\n        scroller.appendChild(grid);\r\n        \r\n        content.append(header, scroller);\r\n        ensureCustomScrollbar(this.overlayEl, this.sheetEl, '.shop-scroller');\r\n        \r\n        const actions = document.createElement('div');\r\n        actions.className = 'shop-actions';\r\n        \r\n        const closeBtn = document.createElement('button');\r\n        closeBtn.type = 'button';\r\n        closeBtn.className = 'shop-close';\r\n        closeBtn.textContent = 'Close';\r\n        \r\n        actions.appendChild(closeBtn);\r\n        \r\n        if (this.delveButtonVisible) {\r\n            const delveBtn = document.createElement('button');\r\n            delveBtn.type = 'button';\r\n            delveBtn.className = 'shop-delve';\r\n            delveBtn.textContent = 'Delve';\r\n            delveBtn.addEventListener('click', (e) => {\r\n                if (e && e.isTrusted && shouldSkipGhostTap(delveBtn)) return;\r\n                primeTypingSfx();\r\n                openMerchant();\r\n            });\r\n            this.delveBtnEl = delveBtn;\r\n            this.updateDelveGlow();\r\n            actions.append(delveBtn);\r\n        }\r\n        \r\n        this.sheetEl.append(grabber, content, actions);\r\n        this.overlayEl.appendChild(this.sheetEl);\r\n        document.body.appendChild(this.overlayEl);\r\n        \r\n        // Listeners\r\n        this.overlayEl.addEventListener('pointerdown', (e) => {\r\n            if (e.pointerType === 'mouse') return;\r\n            this.postOpenPointer = true;\r\n        }, { capture: true, passive: true });\r\n        \r\n        this.overlayEl.addEventListener('touchstart', (e) => {\r\n             this.postOpenPointer = true;\r\n        }, { capture: true, passive: true });\r\n        \r\n        this.overlayEl.addEventListener('click', (e) => {\r\n            if (!IS_MOBILE) return;\r\n            if (!this.postOpenPointer) {\r\n                e.preventDefault(); e.stopImmediatePropagation();\r\n                return;\r\n            }\r\n        }, { capture: true });\r\n        \r\n        closeBtn.addEventListener('click', () => {\r\n             if (IS_MOBILE) blockInteraction(80);\r\n             this.close();\r\n        }, { passive: true });\r\n        \r\n        setupDragToClose(grabber, this.sheetEl, () => this.isOpen, () => {\r\n             this.isOpen = false;\r\n             this.closeTimer = setTimeout(() => {\r\n                 this.closeTimer = null;\r\n                 this.close(true);\r\n             }, 150);\r\n        });\r\n        \r\n        this.update(true);\r\n    }\r\n    \r\n    open() {\r\n        this.ensureOverlay();\r\n        \r\n        if (this.closeTimer) { clearTimeout(this.closeTimer); this.closeTimer = null; }\r\n        \r\n        // Bind events if needed\r\n        if (!this.eventsBound) {\r\n            this.adapter.events.forEach(evt => window.addEventListener(evt, this.updateHandler));\r\n            if (this.mode === 'standard') {\r\n                document.addEventListener('ccc:upgrades:changed', this.updateHandler);\r\n            }\r\n            this.eventsBound = true;\r\n        }\r\n        \r\n        this.update(true);\r\n        if (this.isOpen) return;\r\n        \r\n        this.isOpen = true;\r\n\r\n        if (this.mode === 'standard') {\r\n            const slot = getActiveSlot();\r\n            if (slot != null && localStorage.getItem(`ccc:tsunami:dialoguePending:${slot}`) === '1') {\r\n                runPostTsunamiShopDialogue(() => {\r\n                    try { localStorage.removeItem(`ccc:tsunami:dialoguePending:${slot}`); } catch {}\r\n                    try { localStorage.setItem(`ccc:tsunami:labPending:${slot}`, '1'); } catch {}\r\n                    this.update(true);\r\n                });\r\n            }\r\n        }\r\n\r\n        this.sheetEl.style.transition = 'none';\r\n        this.sheetEl.style.transform = 'translateY(100%)';\r\n        this.overlayEl.style.pointerEvents = 'auto';\r\n        \r\n        void this.sheetEl.offsetHeight;\r\n        \r\n        requestAnimationFrame(() => {\r\n            requestAnimationFrame(() => {\r\n                this.sheetEl.style.transition = '';\r\n                this.sheetEl.style.transform = '';\r\n                this.overlayEl.classList.add('is-open');\r\n                this.postOpenPointer = false;\r\n                \r\n                if (IS_MOBILE) {\r\n                    try { setTimeout(() => suppressNextGhostTap(240), 120); } catch {}\r\n                }\r\n                \r\n                blockInteraction(10);\r\n                ensureCustomScrollbar(this.overlayEl, this.sheetEl);\r\n                \r\n                const focusable = this.overlayEl.querySelector('.shop-upgrade') || this.overlayEl.querySelector('.shop-grid');\r\n                if (focusable) focusable.focus();\r\n            });\r\n        });\r\n    }\r\n    \r\n    close(force = false) {\r\n        const forceClose = force === true;\r\n        const overlayOpen = this.overlayEl?.classList?.contains('is-open');\r\n        \r\n        if (!forceClose && !this.isOpen && !overlayOpen) {\r\n            if (this.closeTimer) { clearTimeout(this.closeTimer); this.closeTimer = null; }\r\n            return;\r\n        }\r\n        \r\n        if (this.closeTimer) { clearTimeout(this.closeTimer); this.closeTimer = null; }\r\n        \r\n        this.isOpen = false;\r\n        if (this.sheetEl) {\r\n            this.sheetEl.style.transition = '';\r\n            this.sheetEl.style.transform = '';\r\n        }\r\n        if (this.overlayEl) {\r\n            this.overlayEl.classList.remove('is-open');\r\n            this.overlayEl.style.pointerEvents = 'none';\r\n        }\r\n        this.postOpenPointer = false;\r\n        \r\n        if (this.eventsBound) {\r\n             this.adapter.events.forEach(evt => window.removeEventListener(evt, this.updateHandler));\r\n             if (this.mode === 'standard') {\r\n                 document.removeEventListener('ccc:upgrades:changed', this.updateHandler);\r\n             }\r\n             this.eventsBound = false;\r\n        }\r\n    }\r\n    \r\n    update(force = false) {\r\n        if (!force && !this.isOpen) return;\r\n        if (!force && isAnyMenuScrolling()) return;\r\n        this.buildUpgradesData();\r\n        this.render();\r\n        this.updateDelveGlow();\r\n    }\r\n}\r\n\r\nif (typeof window !== \"undefined\") {\r\n    window.addEventListener(\"menu:scrollStop\", () => {\r\n        updateShopOverlay(true);\r\n    });\r\n}\r\n\r\n// --- Static Instances ---\r\nconst shops = {\r\n    standard: new ShopInstance('standard'),\r\n    automation: new ShopInstance('automation'),\r\n    dna: new ShopInstance('dna')\r\n};\r\n\r\nexport function openShop(mode = 'standard') {\r\n    const instance = shops[mode] || shops.standard;\r\n    instance.open();\r\n}\r\n\r\nexport function closeShop(force = false) {\r\n    // Attempt to close all open shops\r\n    Object.values(shops).forEach(s => s.close(force));\r\n}\r\n\r\nexport function closeDelveSpecificOverlays() {\r\n    Object.entries(shops).forEach(([key, shop]) => {\r\n        if (key !== 'standard') {\r\n            shop.close();\r\n        }\r\n    });\r\n\r\n    if (upgOpen && currentUpgradeMode !== 'standard') {\r\n        closeUpgradeMenu();\r\n        const existing = document.querySelector('.hm-milestones-overlay');\r\n        if (existing) existing.remove();\r\n    }\r\n}\r\n\r\nexport function updateShopOverlay(force = false) {\r\n    // Update all open shops\r\n    Object.values(shops).forEach(s => s.update(force));\r\n}\r\n\r\nexport function setUpgradeCount() { updateShopOverlay(true); }\r\n\r\nexport function getUpgrades() { \r\n    // Return standard upgrades for backward compat? \r\n    // Or merge? getUpgrades was previously only returning current adapter data.\r\n    // If standard is open, return standard. If automation is open, return automation.\r\n    // If both, prioritizing automation makes sense? \r\n    // Or standard is \"main\" upgrades.\r\n    // Let's assume this is mostly for standard shop.\r\n    return shops.standard.upgrades;\r\n}\r\n\r\n// --- Upgrade Overlay (Shared) ---\r\nlet upgOverlayEl = null;\r\nlet upgSheetEl = null;\r\nlet upgOpen = false;\r\nlet upgOverlayCleanup = null;\r\nlet currentUpgradeMode = 'standard';\r\n\r\nfunction ensureUpgradeOverlay() {\r\n  if (upgOverlayEl) return;\r\n  upgOverlayEl = document.createElement('div');\r\n  upgOverlayEl.className = 'upg-overlay';\r\n\r\n  upgSheetEl = document.createElement('div');\r\n  upgSheetEl.className = 'upg-sheet';\r\n  upgSheetEl.setAttribute('role', 'dialog');\r\n  upgSheetEl.setAttribute('aria-modal', 'false');\r\n  upgSheetEl.setAttribute('aria-label', 'Upgrade');\r\n\r\n  const grab = document.createElement('div');\r\n  grab.className = 'upg-grabber';\r\n  grab.innerHTML = `<div class=\"grab-handle\" aria-hidden=\"true\"></div>`;\r\n\r\n  const header = document.createElement('header');\r\n  header.className = 'upg-header';\r\n\r\n  const content = document.createElement('div');\r\n  content.className = 'upg-content';\r\n\r\n  const milestones = document.createElement('div');\r\n  milestones.className = 'upg-milestones';\r\n\r\n  const actions = document.createElement('div');\r\n  actions.className = 'upg-actions';\r\n\r\n  upgSheetEl.append(grab, header, content, milestones, actions);\r\n  upgOverlayEl.appendChild(upgSheetEl);\r\n  document.body.appendChild(upgOverlayEl);\r\n\r\n  upgOverlayEl.addEventListener('pointerdown', (e) => {\r\n    if (!IS_MOBILE) return;\r\n    if (e.pointerType === 'mouse') return;\r\n    if (e.target === upgOverlayEl) { e.preventDefault(); e.stopPropagation(); }\r\n  }, true);\r\n  upgOverlayEl.addEventListener('click', (e) => {\r\n    if (!IS_MOBILE) return;\r\n    if (e.target === upgOverlayEl) { e.preventDefault(); e.stopImmediatePropagation(); }\r\n  }, true);\r\n\r\n  let drag = null;\r\n  function onDragStart(e) {\r\n    if (!upgOpen) return;\r\n    const y = typeof e.clientY === 'number' ? e.clientY : (e.touches?.[0]?.clientY || 0);\r\n    drag = { startY: y, lastY: y, moved: 0 };\r\n    upgSheetEl.style.transition = 'none';\r\n    window.addEventListener('pointermove', onDragMove);\r\n    window.addEventListener('pointerup', onDragEnd);\r\n    window.addEventListener('pointercancel', onDragEnd);\r\n  }\r\n  function onDragMove(e) {\r\n    if (!drag) return;\r\n    const y = e.clientY;\r\n    if (typeof y !== 'number') return;\r\n    const dy = Math.max(0, y - drag.startY);\r\n    drag.lastY = y;\r\n    drag.moved = dy;\r\n    upgSheetEl.style.transform = `translateY(${dy}px)`;\r\n  }\r\n  function onDragEnd(e) {\r\n    if (!drag) return;\r\n    const shouldClose = drag.moved > 140;\r\n    upgSheetEl.style.transition = 'transform 160ms ease';\r\n    upgSheetEl.style.transform = shouldClose ? 'translateY(100%)' : 'translateY(0)';\r\n    if (shouldClose) {\r\n      if (IS_MOBILE && (!e || e.pointerType !== 'mouse')) try { blockInteraction(120); } catch {}\r\n      setTimeout(closeUpgradeMenu, 160);\r\n    }\r\n    drag = null;\r\n    window.removeEventListener('pointermove', onDragMove);\r\n    window.removeEventListener('pointerup', onDragEnd);\r\n    window.removeEventListener('pointercancel', onDragEnd);\r\n  }\r\n  grab.addEventListener('pointerdown', onDragStart, { passive: true });\r\n}\r\n\r\nfunction closeUpgradeMenu() {\r\n  if (IS_MOBILE) try { blockInteraction(160); } catch {}\r\n  if (typeof upgOverlayCleanup === 'function') { const fn = upgOverlayCleanup; upgOverlayCleanup = null; try { fn(); } catch {} }\r\n  upgOpen = false;\r\n  if (!upgOverlayEl || !upgSheetEl) return;\r\n  upgSheetEl.style.transition = '';\r\n  upgSheetEl.style.transform = '';\r\n  upgOverlayEl.classList.remove('is-open');\r\n  upgOverlayEl.style.pointerEvents = 'none';\r\n}\r\n\r\nfunction openHmMilestoneDialog(lines) {\r\n  // ... (Re-implement logic or use existing. I will copy existing logic for brevity)\r\n  const existing = document.querySelector('.hm-milestones-overlay');\r\n  if (existing) existing.remove();\r\n  const overlay = document.createElement('div');\r\n  overlay.className = 'hm-milestones-overlay';\r\n  overlay.setAttribute('role', 'dialog');\r\n  const dialog = document.createElement('div');\r\n  dialog.className = 'hm-milestones-dialog';\r\n  const title = document.createElement('h3');\r\n  title.className = 'hm-milestones-title';\r\n  title.textContent = 'Milestones';\r\n  const list = document.createElement('ul');\r\n  list.className = 'hm-milestones-list';\r\n  for (const line of lines) {\r\n    const li = document.createElement('li');\r\n    const text = document.createElement('span');\r\n    text.className = 'hm-milestone-text';\r\n    if (line && typeof line === 'object') { text.textContent = line.text ?? ''; if (line.achieved) li.classList.add('hm-milestone-achieved'); } \r\n    else { text.textContent = line; }\r\n    li.appendChild(text); list.appendChild(li);\r\n  }\r\n  const closeBtn = document.createElement('button');\r\n  closeBtn.type = 'button';\r\n  closeBtn.className = 'hm-milestones-close';\r\n  closeBtn.textContent = 'Close';\r\n  const close = () => { overlay.remove(); document.removeEventListener('keydown', onKeydown); };\r\n  const onKeydown = (event) => { if (event.key === 'Escape') { event.preventDefault(); close(); } };\r\n  overlay.addEventListener('click', (event) => { if (event.target === overlay) close(); });\r\n  closeBtn.addEventListener('click', close);\r\n  document.addEventListener('keydown', onKeydown);\r\n  dialog.append(title, list, closeBtn);\r\n  overlay.appendChild(dialog);\r\n  document.body.appendChild(overlay);\r\n  if (typeof closeBtn.focus === 'function') closeBtn.focus({ preventScroll: true });\r\n}\r\n\r\nexport function openUpgradeOverlay(upgDef, mode = 'standard') {\r\n  ensureUpgradeOverlay();\r\n  upgOpen = true;\r\n  currentUpgradeMode = mode;\r\n  let upgOpenLocal = true;\r\n\r\n  const adapter = getAdapter(mode);\r\n  \r\n  // Initial checks\r\n  const initialLockState = adapter.getLockState(upgDef.id) || {};\r\n  const initialLocked = !!initialLockState.locked;\r\n  const initialMysterious = initialLocked && (initialLockState.hidden || initialLockState.hideEffect || initialLockState.hideCost || (typeof initialLockState.iconOverride === 'string' && initialLockState.iconOverride.includes('mysterious')));\r\n  if (initialLocked && !initialMysterious) { upgOpen = false; return; }\r\n\r\n  const isHM = (upgDef.upgType === 'HM');\r\n  const isEndlessXp = (upgDef.tie === UPGRADE_TIES.ENDLESS_XP);\r\n  \r\n  function ensureChild(parent, className, tagName = 'div') {\r\n      const targetClasses = className.split(' ').filter(c => c.length > 0);\r\n      let el = null; const extras = [];\r\n      for (let i = 0; i < parent.children.length; i++) {\r\n          const child = parent.children[i];\r\n          if (tagName && child.tagName.toLowerCase() !== tagName.toLowerCase()) continue;\r\n          if (targetClasses.every(cls => child.classList.contains(cls))) { if (!el) el = child; else extras.push(child); }\r\n      }\r\n      extras.forEach(e => e.remove());\r\n      if (!el) { el = document.createElement(tagName); el.className = className; parent.appendChild(el); }\r\n      return el;\r\n  }\r\n  const makeLine = (html) => { const d = document.createElement('div'); d.className = 'upg-line'; d.innerHTML = html; return d; };\r\n  \r\n  \r\n  let initialRender = true;\r\n  \r\n  const rerender = () => {\r\n      const model = adapter.getUiModel(upgDef.id);\r\n      if (!model) return;\r\n      \r\n      const lockState = model.lockState || adapter.getLockState(upgDef.id);\r\n      const locked = !!lockState?.locked;\r\n      const isHiddenUpgrade = locked && (lockState?.hidden || lockState?.hideEffect || lockState?.hideCost);\r\n      const isUnlockVisible = !!model.unlockUpgrade && !isHiddenUpgrade;\r\n      \r\n      upgSheetEl.classList.toggle('is-locked-hidden', isHiddenUpgrade);\r\n      \r\n      const header = upgSheetEl.querySelector('.upg-header');\r\n      const title = ensureChild(header, 'upg-title');\r\n      if (title.textContent !== (model.displayTitle || model.upg.title)) title.textContent = model.displayTitle || model.upg.title;\r\n      \r\n      const evolveReady = !!model.hmReadyToEvolve;\r\n      const capReached = evolveReady ? false : (model.lvlBn?.isInfinite?.() ? true : (Number.isFinite(model.upg.lvlCap) ? model.lvl >= model.upg.lvlCap : false));\r\n      \r\n      const level = ensureChild(header, 'upg-level');\r\n      const capHtml = model.lvlCapFmtHtml ?? model.upg.lvlCapFmtHtml ?? formatNumber(model.lvlCapBn);\r\n      const capPlain = model.lvlCapFmtText ?? model.upg.lvlCapFmtText ?? stripTags(capHtml);\r\n      const levelHtml = evolveReady ? `Level ${model.lvlFmtHtml} / ${capHtml} (EVOLVE READY)` : (capReached ? `Level ${model.lvlFmtHtml} / ${capHtml} (MAXED)` : `Level ${model.lvlFmtHtml} / ${capHtml}`);\r\n      const levelPlain = stripTags(levelHtml);\r\n      if (level.innerHTML !== levelHtml) level.innerHTML = levelHtml;\r\n      if (level.getAttribute('aria-label') !== levelPlain) level.setAttribute('aria-label', levelPlain);\r\n      level.hidden = isHiddenUpgrade;\r\n      if (!isHiddenUpgrade) level.removeAttribute('aria-hidden');\r\n      \r\n      upgSheetEl.classList.toggle('is-maxed', capReached);\r\n      upgSheetEl.classList.toggle('hm-evolve-ready', evolveReady);\r\n      upgSheetEl.classList.toggle('is-unlock-upgrade', isUnlockVisible);\r\n      upgSheetEl.classList.toggle('is-hm-upgrade', isHM && !isHiddenUpgrade);\r\n      upgSheetEl.classList.toggle('is-endless-xp', isEndlessXp);\r\n      upgSheetEl.classList.toggle('is-magnet-upgrade', upgDef.tie === UPGRADE_TIES.MAGNET);\r\n\t  upgSheetEl.classList.toggle('is-no-effect', !model.effect);\r\n\r\n            // --- Automation Toggle Logic ---\r\n      let autoToggleWrapper = header.querySelector('.auto-toggle-wrapper');\r\n\r\n      // Check for Master Upgrade logic in Automation Shop\r\n      const masterCostType = (mode === 'automation') ? MASTER_AUTOBUY_IDS[upgDef.id] : null;\r\n      // Also check for Workshop Level Master Switch (ID 6 in automation shop)\r\n      const isWorkshopMaster = (mode === 'automation' && upgDef.id === AUTOBUY_WORKSHOP_LEVELS_ID);\r\n\r\n      const isAutomationMaster = !!masterCostType;\r\n      \r\n      // Check for Standard Upgrade logic in Standard Shop\r\n      const standardAutobuyId = (mode === 'standard' || mode === 'dna') ? COST_TYPE_TO_AUTOBUY_ID[upgDef.costType] : null;\r\n\r\n      let autobuyLevel = 0;\r\n      if (standardAutobuyId) {\r\n          autobuyLevel = getLevelNumber(AUTOMATION_AREA_KEY, standardAutobuyId);\r\n      } else if (isAutomationMaster || isWorkshopMaster) {\r\n          // If viewing the master upgrade itself, we check its own level\r\n          autobuyLevel = getLevelNumber(AUTOMATION_AREA_KEY, upgDef.id);\r\n      }\r\n\r\n      const hasAutobuyer = autobuyLevel > 0;\r\n      const showAutoToggle = hasAutobuyer && (isAutomationMaster || standardAutobuyId || isWorkshopMaster) && !isHiddenUpgrade;\r\n\r\n      if (!autoToggleWrapper) {\r\n          autoToggleWrapper = document.createElement('div');\r\n          autoToggleWrapper.className = 'auto-toggle-wrapper hm-view-milestones-row';\r\n          header.appendChild(autoToggleWrapper);\r\n      }\r\n      \r\n      let toggleBtn = autoToggleWrapper.querySelector('button');\r\n      if (!toggleBtn) {\r\n          toggleBtn = document.createElement('button');\r\n          toggleBtn.type = 'button';\r\n          toggleBtn.style.padding = '10px 14px';\r\n          toggleBtn.style.fontSize = '16px';\r\n          toggleBtn.style.width = 'auto';\r\n          toggleBtn.style.minWidth = '180px';\r\n          \r\n          toggleBtn.addEventListener('click', (e) => {\r\n              if (typeof toggleBtn._onClick === 'function') toggleBtn._onClick(e);\r\n          });\r\n          \r\n          autoToggleWrapper.appendChild(toggleBtn);\r\n      }\r\n      \r\n      if (showAutoToggle) {\r\n         toggleBtn.style.visibility = '';\r\n         toggleBtn.style.pointerEvents = 'auto';\r\n\r\n         const activeSlot = getActiveSlot();\r\n         const slotSuffix = activeSlot != null ? `:${activeSlot}` : '';\r\n\r\n         let isEnabled = true;\r\n         if (isAutomationMaster) {\r\n             const key = `ccc:autobuy:master:${masterCostType}${slotSuffix}`;\r\n             // Check if ANY child upgrade is enabled\r\n             const upgrades = [\r\n                 ...getUpgradesForArea(AREA_KEYS.STARTER_COVE),\r\n                 ...getUpgradesForArea(DNA_AREA_KEY)\r\n             ];\r\n             let anyEnabled = false;\r\n             for (const u of upgrades) {\r\n                 if (u.costType === masterCostType) {\r\n                     const childKey = `ccc:autobuy:${u.area}:${u.id}${slotSuffix}`;\r\n                     // Use cached getter if available or fallback (here master check logic is slightly complex)\r\n                     // But wait, the master logic sums up children. \r\n                     // We should use getAutobuyerToggle(u.area, u.id) here to be consistent!\r\n                     if (getAutobuyerToggle(u.area, u.id) !== '0') {\r\n                         anyEnabled = true;\r\n                         break;\r\n                     }\r\n                 }\r\n             }\r\n             isEnabled = anyEnabled;\r\n         } else {\r\n             // Standard or Workshop Master\r\n             const val = getAutobuyerToggle(upgDef.area, upgDef.id);\r\n             isEnabled = val !== '0';\r\n         }\r\n\r\n         if (isEnabled) {\r\n             toggleBtn.className = 'shop-delve';\r\n             toggleBtn.textContent = 'Automation: ON';\r\n             toggleBtn.style.backgroundColor = '';\r\n         } else {\r\n             toggleBtn.className = 'shop-close';\r\n             toggleBtn.textContent = 'Automation: OFF';\r\n             toggleBtn.style.backgroundColor = '';\r\n         }\r\n         \r\n         toggleBtn._onClick = (e) => {\r\n             e.preventDefault(); e.stopPropagation();\r\n             if (IS_MOBILE) blockInteraction(50);\r\n             \r\n             const newState = !isEnabled;\r\n             const val = newState ? '1' : '0';\r\n             \r\n             if (isAutomationMaster) {\r\n                 localStorage.setItem(`ccc:autobuy:master:${masterCostType}${slotSuffix}`, val);\r\n                 const upgrades = [\r\n                     ...getUpgradesForArea(AREA_KEYS.STARTER_COVE),\r\n                     ...getUpgradesForArea(DNA_AREA_KEY)\r\n                 ];\r\n                 upgrades.forEach(u => {\r\n                    if (u.costType === masterCostType) {\r\n                        setAutobuyerToggle(u.area, u.id, val);\r\n                    }\r\n                 });\r\n             } else {\r\n                 setAutobuyerToggle(upgDef.area, upgDef.id, val);\r\n             }\r\n             rerender();\r\n         };\r\n      } else {\r\n         toggleBtn.style.visibility = 'hidden';\r\n         toggleBtn.style.pointerEvents = 'none';\r\n         toggleBtn.className = 'shop-delve';\r\n         toggleBtn.textContent = 'Automation: ON'; // Dummy content for height\r\n         toggleBtn._onClick = null;\r\n      }\r\n      // -------------------------------\r\n      \r\n      const content = upgSheetEl.querySelector('.upg-content');\r\n      if (initialRender) { content.scrollTop = 0; initialRender = false; }\r\n      \r\n      const desc = ensureChild(content, 'upg-desc centered');\r\n      desc.classList.toggle('lock-desc', isHiddenUpgrade);\r\n      const baseDesc = (model.displayDesc || model.upg.desc || '').trim();\r\n      if (evolveReady) {\r\n          desc.classList.add('hm-evolve-note');\r\n          if (desc.textContent !== 'Evolve this upgrade to multiply its effect by 1000x') desc.textContent = 'Evolve this upgrade to multiply its effect by 1000x';\r\n      } else if (baseDesc) {\r\n          desc.classList.remove('hm-evolve-note');\r\n          if (desc.textContent !== baseDesc) desc.textContent = baseDesc;\r\n          desc.hidden = false;\r\n      } else desc.hidden = true;\r\n      \r\n      const info = ensureChild(content, 'upg-info');\r\n      \r\n      let cursor = null;\r\n      const placeAfterCursor = (el) => {\r\n          if (!cursor) {\r\n              if (info.firstElementChild !== el) info.prepend(el);\r\n          } else {\r\n              if (cursor.nextElementSibling !== el) info.insertBefore(el, cursor.nextSibling);\r\n          }\r\n          cursor = el;\r\n      };\r\n\r\n      if (locked && lockState?.reason && !isHiddenUpgrade) {\r\n          const descText = (model.displayDesc || '').trim();\r\n          const reasonText = String(lockState.reason ?? '').trim();\r\n          if (descText !== reasonText) {\r\n              let wrap = info.querySelector('.lock-wrapper');\r\n              if (!wrap) { \r\n                 wrap = document.createElement('div'); wrap.className = 'lock-wrapper';\r\n                 const line = document.createElement('div'); line.className = 'upg-line lock-note';\r\n                 wrap.append(line);\r\n              }\r\n              const children = Array.from(wrap.children);\r\n              for (const c of children) {\r\n                  if (c.tagName === 'DIV' && !c.className && c.style.height === '12px') c.remove();\r\n              }\r\n              const line = wrap.querySelector('.lock-note');\r\n              if (line.textContent !== lockState.reason) line.textContent = lockState.reason;\r\n              placeAfterCursor(wrap);\r\n          } else {\r\n              const wrap = info.querySelector('.lock-wrapper');\r\n              if (wrap) wrap.remove();\r\n          }\r\n      } else {\r\n          const wrap = info.querySelector('.lock-wrapper');\r\n          if (wrap) wrap.remove();\r\n      }\r\n\r\n      if (model.effect && !(locked && lockState?.hideEffect)) {\r\n          let wrap = info.querySelector('.effect-wrapper');\r\n          if (!wrap) {\r\n               wrap = document.createElement('div'); wrap.className = 'effect-wrapper';\r\n               const line = document.createElement('div'); line.className = 'upg-line';\r\n               wrap.append(line);\r\n          }\r\n          const children = Array.from(wrap.children);\r\n          for (const c of children) {\r\n              if (c.tagName === 'DIV' && !c.className && c.style.height === '12px') c.remove();\r\n          }\r\n          const line = wrap.querySelector('.upg-line');\r\n          const html = `<span class=\"bonus-line\">${model.effect}</span>`;\r\n          if (line.innerHTML !== html) line.innerHTML = html;\r\n          placeAfterCursor(wrap);\r\n      } else {\r\n          const wrap = info.querySelector('.effect-wrapper');\r\n          if (wrap) wrap.remove();\r\n      }\r\n      \r\n      const iconHTML = currencyIconHTML(model.upg.costType);\r\n      const nextPriceBn = model.nextPrice instanceof BigNum ? model.nextPrice : BigNum.fromAny(model.nextPrice || 0);\r\n      const stopBuying = capReached || evolveReady;\r\n      \r\n      if (!model.unlockUpgrade && !stopBuying && (!locked || !lockState?.hideCost)) {\r\n          const costs = ensureChild(info, 'upg-costs');\r\n          placeAfterCursor(costs);\r\n          \r\n          const costLabel = getCurrencyLabel(model.upg.costType, nextPriceBn);\r\n          const costHtml = `Cost: ${iconHTML} ${bank[model.upg.costType].fmt(nextPriceBn)} ${costLabel}`;\r\n          \r\n          const lineCost = ensureChild(costs, 'cost-line', 'div');\r\n          if (!lineCost.className.includes('upg-line')) lineCost.className = 'upg-line cost-line';\r\n          if (lineCost.innerHTML !== costHtml) lineCost.innerHTML = costHtml;\r\n          \r\n          if (isHM) {\r\n             const lineMilestone = ensureChild(costs, 'milestone-line', 'div');\r\n             if (!lineMilestone.className.includes('upg-line')) lineMilestone.className = 'upg-line milestone-line';\r\n\r\n             let milestoneCost = '\u2014';\r\n             let milestoneLabel = '';\r\n             const isAutomated = isUpgradeAutomated(model.upg);\r\n             try {\r\n                if (model.hmNextMilestone && model.hmNextMilestone.cmp(model.lvlBn) > 0) {\r\n                    if (isAutomated) {\r\n                        const targetLevelBn = model.hmNextMilestone.sub(BigNum.fromInt(1));\r\n                        let targetLevelNum = 0;\r\n                        try {\r\n                            const s = targetLevelBn.toPlainIntegerString?.();\r\n                            if (s && s !== 'Infinity') targetLevelNum = Number(s);\r\n                            else targetLevelNum = Number(targetLevelBn.toString());\r\n                        } catch { targetLevelNum = 0; }\r\n                        \r\n                        let costAt = BigNum.fromInt(0);\r\n                        try {\r\n                            costAt = BigNum.fromAny(model.upg.costAtLevel(targetLevelNum));\r\n                        } catch {}\r\n                        \r\n                        milestoneCost = bank[model.upg.costType].fmt(costAt);\r\n                        milestoneLabel = getCurrencyLabel(model.upg.costType, costAt);\r\n                    } else {\r\n                        const deltaBn = model.hmNextMilestone.sub(model.lvlBn);\r\n                        const deltaPlain = deltaBn.toPlainIntegerString?.();\r\n                        const deltaNum = Math.max(0, Math.floor(Number(deltaPlain && deltaPlain !== 'Infinity' ? deltaPlain : Number(deltaBn.toString() || 0))));\r\n                        const { spent } = evaluateBulkPurchase(model.upg, model.lvlBn, BigNum.fromAny('Infinity'), deltaNum);\r\n                        milestoneCost = bank[model.upg.costType].fmt(spent);\r\n                        milestoneLabel = getCurrencyLabel(model.upg.costType, spent);\r\n                    }\r\n                }\r\n             } catch {}\r\n             const prefix = isAutomated ? 'Cost at next milestone:' : 'Cost to next milestone:';\r\n             const milestoneHtml = `${prefix} ${iconHTML} ${milestoneCost} ${milestoneLabel}`;\r\n             if (lineMilestone.innerHTML !== milestoneHtml) lineMilestone.innerHTML = milestoneHtml;\r\n          } else {\r\n             const lineMilestone = costs.querySelector('.milestone-line');\r\n             if (lineMilestone) lineMilestone.remove();\r\n          }\r\n          \r\n          const haveLabel = getCurrencyLabel(model.upg.costType, model.have);\r\n          const haveHtml = `You have: ${iconHTML} ${bank[model.upg.costType].fmt(model.have)} ${haveLabel}`;\r\n          \r\n          const lineHave = ensureChild(costs, 'have-line', 'div');\r\n          if (!lineHave.className.includes('upg-line')) lineHave.className = 'upg-line have-line';\r\n          if (lineHave.innerHTML !== haveHtml) lineHave.innerHTML = haveHtml;\r\n      } else {\r\n          const costs = info.querySelector('.upg-costs');\r\n          if (costs) costs.remove();\r\n      }\r\n      \r\n      // Milestones Row\r\n      const milestonesContainer = upgSheetEl.querySelector('.upg-milestones');\r\n      let milestonesRow = milestonesContainer.querySelector('.hm-view-milestones-row');\r\n      \r\n      if (!milestonesRow) {\r\n          milestonesRow = document.createElement('div'); \r\n          milestonesRow.className = 'hm-view-milestones-row';\r\n          const btn = document.createElement('button'); \r\n          btn.type='button'; \r\n          btn.className='shop-delve hm-view-milestones'; \r\n          btn.textContent='View Milestones';\r\n          btn.addEventListener('click', (e) => {\r\n              // Use _onClick pattern\r\n              if (btn._onClick) btn._onClick(e);\r\n          });\r\n          milestonesRow.appendChild(btn); \r\n          milestonesContainer.appendChild(milestonesRow);\r\n      }\r\n      \r\n      const milestoneBtn = milestonesRow.querySelector('button');\r\n\r\n      if (isHM && !isHiddenUpgrade) {\r\n          milestoneBtn.style.visibility = '';\r\n          milestoneBtn.style.pointerEvents = 'auto';\r\n          \r\n          milestoneBtn._onClick = () => {\r\n                 const milestones = Array.isArray(model.hmMilestones) ? model.hmMilestones : [];\r\n                 const evolutions = Math.max(0, Math.floor(Number(model.hmEvolutions ?? 0)));\r\n                 const evolutionOffset = (() => { try { return BigInt(HM_EVOLUTION_INTERVAL) * BigInt(evolutions); } catch { return 0n; } })();\r\n                 const lines = milestones.sort((a,b)=>(Number(a?.level||0)-Number(b?.level||0))).map(m => {\r\n                     const lvl = Math.max(0, Math.floor(Number(m?.level||0)));\r\n                     const milestoneLevelBn = (() => {\r\n                         if (model.lvlBn?.isInfinite?.()) return BigNum.fromAny('Infinity');\r\n                         try { return BigNum.fromAny((BigInt(lvl) + evolutionOffset).toString()); } catch { return BigNum.fromAny(lvl + (HM_EVOLUTION_INTERVAL * evolutions)); }\r\n                     })();\r\n                     const levelText = milestoneLevelBn?.isInfinite?.() ? 'Infinity' : formatNumber(milestoneLevelBn);\r\n                     const mult = formatMultForUi(m?.multiplier??m?.mult??m?.value??1);\r\n                     const target = `${m?.target??m?.type??'self'}`.toLowerCase();\r\n                     const achieved = (() => {\r\n                        if (model.lvlBn?.isInfinite?.()) return true;\r\n                        try { return model.lvlBn?.cmp?.(milestoneLevelBn) >= 0; } catch {}\r\n                        return false; \r\n                     })();\r\n                     let text = `Level ${levelText}: Multiplies this upgrade\u2019s effect by ${mult}x`;\r\n                     if (target === 'xp') text = `Level ${levelText}: Multiplies XP value by ${mult}x`;\r\n                     if (target === 'coin'||target==='coins') text = `Level ${levelText}: Multiplies Coin value by ${mult}x`;\r\n                     if (target === 'mp') text = `Level ${levelText}: Multiplies MP value by ${mult}x`;\r\n                     return { text, achieved };\r\n                 });\r\n                 openHmMilestoneDialog(lines);\r\n          };\r\n      } else {\r\n          milestoneBtn.style.visibility = 'hidden';\r\n          milestoneBtn.style.pointerEvents = 'none';\r\n          milestoneBtn._onClick = null;\r\n      }\r\n      \r\n      // Actions\r\n      const actions = upgSheetEl.querySelector('.upg-actions');\r\n      let closeBtn = actions.querySelector('.shop-close');\r\n      if (!closeBtn) {\r\n          closeBtn = document.createElement('button'); closeBtn.type='button'; closeBtn.className='shop-close'; closeBtn.textContent='Close';\r\n          closeBtn.addEventListener('click', () => { upgOpenLocal = false; closeUpgradeMenu(); });\r\n          actions.appendChild(closeBtn);\r\n      }\r\n      \r\n      if (locked || capReached) {\r\n          actions.querySelectorAll('button:not(.shop-close)').forEach(btn => btn.remove());\r\n          if (document.activeElement && document.activeElement !== closeBtn && !actions.contains(document.activeElement) && !document.activeElement.closest('.debug-panel')) closeBtn.focus();\r\n      } else {\r\n          const canAffordNext = model.have.cmp(nextPriceBn) >= 0;\r\n          const ensureButton = (className, text, onClick, index, disabled=false) => {\r\n              let btn = actions.querySelector(`.${className.split(' ').join('.')}`);\r\n              if (!btn) {\r\n                  btn = document.createElement('button'); btn.type='button'; btn.className=className; btn.textContent=text;\r\n                  \r\n                  const invoke = () => { if (typeof btn._onClick === 'function') btn._onClick(); };\r\n                  if ('PointerEvent' in window) btn.addEventListener('pointerdown', (e) => { if(e.pointerType==='mouse'||(typeof e.button==='number'&&e.button!==0))return; invoke(); e.preventDefault(); }, {passive:false});\r\n                  else btn.addEventListener('touchstart', (e)=>{ invoke(); e.preventDefault(); }, {passive:false});\r\n                  btn.addEventListener('click', ()=>{ if(IS_MOBILE)return; invoke(); });\r\n                  \r\n                  const siblings = actions.children;\r\n                  if (index >= siblings.length) actions.appendChild(btn); else actions.insertBefore(btn, siblings[index]);\r\n              }\r\n              btn._onClick = onClick;\r\n              if(btn.textContent!==text) btn.textContent=text;\r\n              if(btn.disabled!==disabled) btn.disabled=disabled;\r\n              return btn;\r\n          };\r\n          \r\n          if (evolveReady) {\r\n              actions.querySelectorAll('button:not(.shop-close):not(.hm-evolve-btn)').forEach(b => b.remove());\r\n              ensureButton('shop-delve hm-evolve-btn', 'Evolve', () => {\r\n                  const { evolved } = adapter.evolve(upgDef.id);\r\n                  if (evolved) { playEvolveSfx(); updateShopOverlay(); rerender(); }\r\n              }, 1, false);\r\n              return;\r\n          }\r\n          \r\n          if (model.unlockUpgrade) {\r\n               actions.querySelectorAll('button:not(.shop-close):not(.btn-unlock)').forEach(b => b.remove());\r\n               ensureButton('shop-delve btn-unlock', 'Unlock', () => {\r\n                   const { bought } = adapter.buyOne(upgDef.id);\r\n                   const boughtBn = bought instanceof BigNum ? bought : BigNum.fromAny(bought ?? 0);\r\n                   if (!boughtBn.isZero?.()) {\r\n                       playPurchaseSfx();\r\n                       if (isForgeUnlockUpgrade(upgDef, mode)) try { unlockMerchantTabs(['reset']); } catch {}\r\n                       updateShopOverlay(); rerender();\r\n                   }\r\n               }, 1, !canAffordNext);\r\n               return;\r\n          }\r\n          \r\n          actions.querySelectorAll('.hm-evolve-btn, .btn-unlock').forEach(b => b.remove());\r\n          \r\n          const performBuy = () => {\r\n              const fresh = adapter.getUiModel(upgDef.id);\r\n              if (fresh.have.cmp(fresh.nextPrice instanceof BigNum ? fresh.nextPrice : BigNum.fromAny(fresh.nextPrice||0)) < 0) return;\r\n              const { bought } = adapter.buyOne(upgDef.id);\r\n              const boughtBn = bought instanceof BigNum ? bought : BigNum.fromAny(bought ?? 0);\r\n              if (!boughtBn.isZero?.()) { playPurchaseSfx(); updateShopOverlay(); rerender(); }\r\n          };\r\n          ensureButton('shop-delve btn-buy-one', 'Buy', performBuy, 1, !canAffordNext);\r\n          \r\n          const capNumber = Number.isFinite(model.upg.lvlCap) ? model.upg.lvlCap : Infinity;\r\n          const isSingleLevelCap = capNumber === 1;\r\n\r\n          if (!isSingleLevelCap) {\r\n              const performBuyMax = () => {\r\n                  const fresh = adapter.getUiModel(upgDef.id);\r\n                  if (fresh.have.cmp(BigNum.fromInt(1)) < 0) return;\r\n                  const { bought } = adapter.buyMax(upgDef.id);\r\n                  const boughtBn = bought instanceof BigNum ? bought : BigNum.fromAny(bought ?? 0);\r\n                  if (!boughtBn.isZero?.()) { playPurchaseSfx(); updateShopOverlay(); rerender(); }\r\n              };\r\n              ensureButton('shop-delve btn-buy-max', 'Buy Max', performBuyMax, 2, !canAffordNext);\r\n\r\n              // Exclude early upgrades (Ids 1, 3, 4, 5, 6)\r\n              const isExcluded = [1, 3, 4, 5, 6].includes(resolveUpgradeId(model.upg));\r\n              if (!isHM && !isExcluded) {\r\n                  const performBuyCheap = () => {\r\n                      const fresh = adapter.getUiModel(upgDef.id);\r\n                      if (fresh.have.cmp(BigNum.fromInt(1)) < 0) return;\r\n                      const buyFn = adapter.buyCheap;\r\n                      if (!buyFn) return;\r\n                      const { bought } = buyFn(upgDef.id);\r\n                      const boughtBn = bought instanceof BigNum ? bought : BigNum.fromAny(bought ?? 0);\r\n                      if (!boughtBn.isZero?.()) { playPurchaseSfx(); updateShopOverlay(); rerender(); }\r\n                  };\r\n                  ensureButton('shop-delve btn-buy-cheap', 'Buy Cheap', performBuyCheap, 3, !canAffordNext);\r\n              } else {\r\n                  const stale = actions.querySelector('.btn-buy-cheap');\r\n                  if (stale) stale.remove();\r\n              }\r\n          } else {\r\n              const stale = actions.querySelector('.btn-buy-max');\r\n              if (stale) stale.remove();\r\n              const staleCheap = actions.querySelector('.btn-buy-cheap');\r\n              if (staleCheap) staleCheap.remove();\r\n          }\r\n          \r\n          if (isHM) {\r\n              const performBuyNext = () => {\r\n                  const fresh = adapter.getUiModel(upgDef.id);\r\n                  if (fresh.hmReadyToEvolve) return;\r\n                  const target = fresh.hmNextMilestone;\r\n                  if (!target || !fresh.lvlBn || target.cmp(fresh.lvlBn) <= 0) {\r\n                      const { bought } = adapter.buyMax(upgDef.id);\r\n                      if ((bought instanceof BigNum ? bought : BigNum.fromAny(bought??0)).isZero?.()) return;\r\n                      playPurchaseSfx(); updateShopOverlay(); rerender(); return;\r\n                  }\r\n                  let deltaNum = 0;\r\n                  try { const diffPlain = target.sub(fresh.lvlBn).toPlainIntegerString?.(); deltaNum = Math.max(0, Math.floor(Number((diffPlain&&diffPlain!=='Infinity')?diffPlain:target.sub(fresh.lvlBn).toString()))); } catch {}\r\n                  const walletRaw = bank[fresh.upg.costType]?.value;\r\n                  const walletBn = walletRaw instanceof BigNum ? walletRaw : BigNum.fromAny(walletRaw??0);\r\n                  const evalResult = evaluateBulkPurchase(fresh.upg, fresh.lvlBn, walletBn, deltaNum);\r\n                  const count = evalResult.count;\r\n                  let reachable = false;\r\n                  try { const plain = count?.toPlainIntegerString?.(); reachable = (plain&&plain!=='Infinity') ? Number(plain)>=deltaNum : Number(count??0)>=deltaNum; } catch {}\r\n                  const purchase = reachable ? adapter.buyNext(upgDef.id, deltaNum) : adapter.buyMax(upgDef.id);\r\n                  const boughtBn = purchase.bought instanceof BigNum ? purchase.bought : BigNum.fromAny(purchase.bought??0);\r\n                  if (!boughtBn.isZero?.()) { playPurchaseSfx(); updateShopOverlay(); rerender(); }\r\n              };\r\n              ensureButton('shop-delve btn-buy-next', 'Buy Next', performBuyNext, 3, model.have.cmp(BigNum.fromInt(1)) < 0);\r\n          } else {\r\n              const stale = actions.querySelector('.btn-buy-next'); if (stale) stale.remove();\r\n          }\r\n      }\r\n  };\r\n  \r\n  const onUpdate = () => { if (!upgOpenLocal) return; rerender(); };\r\n  adapter.events.forEach(evt => window.addEventListener(evt, onUpdate));\r\n  if (mode === 'standard') document.addEventListener('ccc:upgrades:changed', onUpdate);\r\n  \r\n  rerender();\r\n  upgOverlayEl.classList.add('is-open');\r\n  upgOverlayEl.classList.toggle('is-automation-upgrade', mode === 'automation');\r\n  upgOverlayEl.style.pointerEvents = 'auto';\r\n  blockInteraction(140);\r\n  upgSheetEl.style.transition = 'none';\r\n  upgSheetEl.style.transform = 'translateY(100%)';\r\n  void upgSheetEl.offsetHeight;\r\n  requestAnimationFrame(() => { upgSheetEl.style.transition = ''; upgSheetEl.style.transform = ''; });\r\n  \r\n  upgOverlayCleanup = () => {\r\n     upgOpenLocal = false;\r\n     adapter.events.forEach(evt => window.removeEventListener(evt, onUpdate));\r\n     if (mode === 'standard') document.removeEventListener('ccc:upgrades:changed', onUpdate);\r\n  };\r\n}\r\n\r\nexport function setupDragToClose(grabberEl, sheetEl, isOpenFn, performCloseFn) {\r\n  let drag = null;\r\n  function onDragStart(e) {\r\n    if (!isOpenFn()) return;\r\n    const clientY = typeof e.clientY === 'number' ? e.clientY : (e.touches?.[0]?.clientY || 0);\r\n    drag = { startY: clientY, lastY: clientY, startT: performance.now(), moved: 0, canceled: false };\r\n    sheetEl.style.transition = 'none';\r\n    window.addEventListener('pointermove', onDragMove);\r\n    window.addEventListener('pointerup', onDragEnd);\r\n    window.addEventListener('pointercancel', onDragEnd);\r\n  }\r\n  function onDragMove(e) {\r\n    if (!drag || drag.canceled) return;\r\n    const y = e.clientY;\r\n    if (typeof y !== 'number') return;\r\n    const dy = Math.max(0, y - drag.startY);\r\n    drag.lastY = y;\r\n    drag.moved = dy;\r\n    sheetEl.style.transform = `translateY(${dy}px)`;\r\n  }\r\n  function onDragEnd() {\r\n    if (!drag || drag.canceled) return cleanupDrag();\r\n    const dt = Math.max(1, performance.now() - drag.startT);\r\n    const dy = drag.moved;\r\n    const velocity = dy / dt;\r\n    const shouldClose = (velocity > 0.55 && dy > 40) || dy > 140;\r\n    if (shouldClose) {\r\n      suppressNextGhostTap(100);\r\n      blockInteraction(80);\r\n      sheetEl.style.transition = 'transform 140ms ease-out';\r\n      sheetEl.style.transform = 'translateY(100%)';\r\n      performCloseFn();\r\n    } else {\r\n      sheetEl.style.transition = 'transform 180ms ease';\r\n      sheetEl.style.transform = 'translateY(0)';\r\n    }\r\n    cleanupDrag();\r\n  }\r\n  function onDragCancel() {\r\n    if (!drag) return;\r\n    drag.canceled = true;\r\n    sheetEl.style.transition = 'transform 180ms ease';\r\n    sheetEl.style.transform = 'translateY(0)';\r\n    cleanupDrag();\r\n  }\r\n  function cleanupDrag() {\r\n    window.removeEventListener('pointermove', onDragMove);\r\n    window.removeEventListener('pointerup', onDragEnd);\r\n    window.removeEventListener('pointercancel', onDragEnd);\r\n    drag = null;\r\n  }\r\n  grabberEl.addEventListener('pointerdown', onDragStart);\r\n  grabberEl.addEventListener('touchstart', (e) => e.preventDefault(), { passive: false });\r\n}\r\n", "// js/ui/hudButtons.js\r\n\r\nimport { openShop } from './shopOverlay.js';\r\nimport { ensureMerchantOverlay } from './merchantTabs/dlgTab.js';\r\nimport { getActiveSlot, hasModifiedSave } from '../util/storage.js';\r\nimport {\r\n  shouldSkipGhostTap,\r\n} from '../util/ghostTapGuard.js';\r\n\r\nconst BASE_KEYS = {\r\n  SHOP: 'ccc:unlock:shop',\r\n  MAP:  'ccc:unlock:map',\r\n};\r\n\r\nfunction slotKey(base) {\r\n  const slot = getActiveSlot();\r\n  return slot == null ? base : `${base}:${slot}`;\r\n}\r\n\r\nfunction isUnlocked(base) {\r\n  const key = slotKey(base);\r\n  const slotRaw = localStorage.getItem(key);\r\n  if (slotRaw != null) return slotRaw === '1';\r\n  return localStorage.getItem(base) === '1';\r\n}\r\n\r\nexport function isShopUnlocked() {\r\n  ensureUnlockDefaults();\r\n  return isUnlocked(BASE_KEYS.SHOP);\r\n}\r\n\r\nexport function isMapUnlocked() {\r\n  ensureUnlockDefaults();\r\n  return isUnlocked(BASE_KEYS.MAP);\r\n}\r\n\r\nfunction setUnlocked(base, v) {\r\n  const val = v ? '1' : '0';\r\n  const key = slotKey(base);\r\n  localStorage.setItem(key, val);\r\n  if (key !== base && localStorage.getItem(base) != null) {\r\n    localStorage.setItem(base, val);\r\n  }\r\n  try {\r\n    window.dispatchEvent(new CustomEvent('unlock:change', {\r\n      detail: { key: base, slot: getActiveSlot() },\r\n    }));\r\n  } catch {}\r\n}\r\n\r\nfunction ensureUnlockDefaults() {\r\n  for (const key of Object.values(BASE_KEYS)) {\r\n    const sk = slotKey(key);\r\n    const hasSlot = localStorage.getItem(sk) != null;\r\n    if (!hasSlot) localStorage.setItem(sk, '0');\r\n  }\r\n}\r\n\r\nfunction setButtonVisible(key, visible) {\r\n  const el = document.querySelector(`.hud-bottom [data-btn=\"${key}\"]`);\r\n  if (el) el.hidden = !visible;\r\n}\r\n\r\nfunction updateShopButtonTamperState() {\r\n  const btn = document.querySelector('.hud-bottom [data-btn=\"shop\"]');\r\n  if (!btn) return;\r\n  btn.classList.toggle('btn-shop--modified', hasModifiedSave());\r\n}\r\n\r\nfunction phonePortrait() {\r\n  const isCoarse = window.matchMedia('(pointer: coarse)').matches;\r\n  const isPortrait = window.innerHeight >= window.innerWidth;\r\n  return isCoarse && isPortrait;\r\n}\r\n\r\nlet listenersBound = false;\r\nlet actionsBound = false;\r\n\r\n// ===============================\r\n// HUD layout\r\n// ===============================\r\nexport function applyHudLayout() {\r\n  const hud = document.querySelector('.hud-bottom');\r\n  if (!hud) return;\r\n\r\n  const mapBtn = hud.querySelector('[data-btn=\"map\"]');\r\n  const isMapVisible = !!(mapBtn && !mapBtn.hidden);\r\n  const isPhonePortrait = phonePortrait();\r\n  const baseOrder = ['help', 'shop', 'stats', 'map'];\r\n  const mobileMapOrder = ['help', 'stats', 'shop', 'map'];\r\n\r\n  const desiredOrder = isPhonePortrait && isMapVisible ? mobileMapOrder : baseOrder;\r\n\r\n  const desiredNodes = desiredOrder\r\n    .map(key => hud.querySelector(`.game-btn[data-btn=\"${key}\"]`))\r\n    .filter(Boolean);\r\n  const remainingNodes = [...hud.children].filter(el => !desiredNodes.includes(el));\r\n  const finalOrder = [...desiredNodes, ...remainingNodes];\r\n\r\n  const needsReorder = finalOrder.length && finalOrder.some((el, idx) => hud.children[idx] !== el);\r\n  if (needsReorder) {\r\n    const frag = document.createDocumentFragment();\r\n    finalOrder.forEach(node => frag.appendChild(node));\r\n    hud.appendChild(frag);\r\n  }\r\n\r\n  const all = [...hud.querySelectorAll('.game-btn')];\r\n  const visible = all.filter(el => !el.hidden);\r\n\r\n  // Reset previous hints\r\n  hud.classList.remove('is-2','is-3','is-4');\r\n  visible.forEach(el => {\r\n    el.style.gridColumn = '';\r\n    el.style.gridRow = '';\r\n    el.classList.remove('span-2');\r\n    el.style.order = '';\r\n  });\r\n  hud.style.gridTemplateColumns = '';\r\n  hud.classList.add(`is-${visible.length}`);\r\n\r\n  // Desktop centering\r\n  if (!isPhonePortrait) {\r\n    const cs  = getComputedStyle(hud);\r\n    const gap = parseFloat(cs.columnGap || cs.gap || '0') || 0;\r\n    const cw  = hud.clientWidth;\r\n    const per = Math.max(180, Math.floor((cw - 3 * gap) / 4));\r\n\r\n    if (visible.length === 2) {\r\n      hud.style.gridTemplateColumns = `1fr ${per}px ${per}px 1fr`;\r\n      visible[0].style.gridColumn = '2';\r\n      visible[1].style.gridColumn = '3';\r\n      return;\r\n    }\r\n    if (visible.length === 3) {\r\n      hud.style.gridTemplateColumns = `1fr ${per}px ${per}px ${per}px 1fr`;\r\n      visible[0].style.gridColumn = '2';\r\n      visible[1].style.gridColumn = '3';\r\n      visible[2].style.gridColumn = '4';\r\n      return;\r\n    }\r\n  }\r\n\r\n  // Mobile portrait (2\u00D72): Help & Stats top; Shop full width bottom\r\n  if (isPhonePortrait && visible.length === 3) {\r\n    const help  = hud.querySelector('[data-btn=\"help\"]:not([hidden])');\r\n    const stats = hud.querySelector('[data-btn=\"stats\"]:not([hidden])');\r\n    const shop  = hud.querySelector('[data-btn=\"shop\"]:not([hidden])');\r\n\r\n    if (help && stats && shop) {\r\n      help.style.gridColumn  = '1'; help.style.gridRow  = '1';\r\n      stats.style.gridColumn = '2'; stats.style.gridRow = '1';\r\n      shop.style.gridColumn  = '1 / -1'; shop.style.gridRow = '2';\r\n    }\r\n  }\r\n}\r\n\r\nexport function initHudButtons() {\r\n  ensureUnlockDefaults();\r\n\r\n  // Always-on buttons\r\n  setButtonVisible('help',  true);\r\n  setButtonVisible('stats', true);\r\n\r\n  setButtonVisible('shop', isUnlocked(BASE_KEYS.SHOP));\r\n  setButtonVisible('map',  isUnlocked(BASE_KEYS.MAP));\r\n  updateShopButtonTamperState();\r\n\r\n  applyHudLayout();\r\n  \r\n  // Preload Merchant Overlay (Delve screen) during idle time\r\n  // This is a performance optimization to ensure the heavy DOM is ready\r\n  // before the user clicks the \"Delve\" button in the shop.\r\n  if (typeof window.requestIdleCallback === 'function') {\r\n    window.requestIdleCallback(() => ensureMerchantOverlay(), { timeout: 5000 });\r\n  } else {\r\n    setTimeout(() => ensureMerchantOverlay(), 100);\r\n  }\r\n\r\n  if (!listenersBound) {\r\n    listenersBound = true;\r\n    window.addEventListener('resize', applyHudLayout);\r\n    window.addEventListener('orientationchange', applyHudLayout);\r\n    window.addEventListener('saveSlot:change', () => {\r\n      setButtonVisible('shop', isUnlocked(BASE_KEYS.SHOP));\r\n      setButtonVisible('map',  isUnlocked(BASE_KEYS.MAP));\r\n      updateShopButtonTamperState();\r\n      applyHudLayout();\r\n    });\r\n    window.addEventListener('saveSlot:modified', (event) => {\r\n      const active = getActiveSlot();\r\n      const slot = event?.detail?.slot;\r\n      if (slot != null && active != null && slot !== active) return;\r\n      updateShopButtonTamperState();\r\n    });\r\n  }\r\n\r\n  // Bind actions once (click \u2192 open shop)\r\n  if (!actionsBound) {\r\n    actionsBound = true;\r\n    const hud = document.querySelector('.hud-bottom');\r\n    if (hud) {\r\n      const activate = (btn) => {\r\n        if (!btn) return;\r\n        const key = btn.getAttribute('data-btn');\r\n        if (key === 'shop') {\r\n          openShop();\r\n        }\r\n        // future: help/settings/map can import their own modules, too\r\n      };\r\n\r\n      const onClick = (e) => {\r\n        const btn = e.target.closest('.game-btn');\r\n        if (!btn) return;\r\n        const key = btn.getAttribute('data-btn');\r\n        if (key !== 'shop') return;\r\n        if (e.isTrusted && shouldSkipGhostTap(btn)) return;\r\n        // markGhostTapTarget removed - global handler manages clicks\r\n        activate(btn);\r\n      };\r\n\r\n      hud.addEventListener('click', onClick, { passive: true });\r\n    }\r\n  }\r\n}\r\n\r\n// Convenience helpers (write both keys)\r\nexport function unlockShop() { setUnlocked(BASE_KEYS.SHOP, true);  setButtonVisible('shop', true); applyHudLayout(); }\r\nexport function unlockMap()  { setUnlocked(BASE_KEYS.MAP,  true);  setButtonVisible('map',  true); applyHudLayout(); }\r\nexport function lockShop()   { setUnlocked(BASE_KEYS.SHOP, false); setButtonVisible('shop', false); applyHudLayout(); }\r\nexport function lockMap()    { setUnlocked(BASE_KEYS.MAP,  false); setButtonVisible('map',  false); applyHudLayout(); }\r\n", "// js/game/cursorTrail.js\r\n\r\nexport function createCursorTrail(playfield) {\r\n  if (!playfield || typeof window === 'undefined') {\r\n    return { destroy() {} };\r\n  }\r\n\r\n  // Idempotency check\r\n  if (playfield.querySelector('.cursor-trail-canvas')) {\r\n      const old = playfield.querySelectorAll('.cursor-trail-canvas');\r\n      old.forEach(el => el.remove());\r\n  }\r\n\r\n  // --- Configuration ---\r\n  const CAPACITY = 10000;\r\n  const PARTICLE_LIFETIME = 500; // ms\r\n  const INTERPOLATION_STEP = 4; // px\r\n  // MAX_SPAWN_PER_FRAME is less relevant with coalesced events but still good for sanity\r\n  const MAX_SPAWN_PER_FRAME = 2000; \r\n  \r\n  // Visuals\r\n  const PARTICLE_SIZE = 16; \r\n  const PARTICLE_RADIUS = PARTICLE_SIZE / 2;\r\n  const GLOW_RADIUS = 8;\r\n  const TEXTURE_SIZE = 32; \r\n  const CENTER = TEXTURE_SIZE / 2;\r\n\r\n  // --- State ---\r\n  const STRIDE = 4;\r\n  const data = new Float32Array(CAPACITY * STRIDE);\r\n  \r\n  for (let i = 0; i < CAPACITY; i++) {\r\n    data[i * STRIDE + 2] = Infinity;\r\n  }\r\n  \r\n  const freeSlots = new Int16Array(CAPACITY);\r\n  let freeCount = CAPACITY;\r\n  // Reverse fill so we pop low indices first\r\n  for (let i = 0; i < CAPACITY; i++) freeSlots[i] = CAPACITY - 1 - i;\r\n\r\n  let maxActiveIndex = -1;\r\n\r\n  // --- DOM Setup ---\r\n  const canvas = document.createElement('canvas');\r\n  canvas.className = 'cursor-trail-canvas';\r\n  Object.assign(canvas.style, {\r\n    position: 'absolute',\r\n    top: '0',\r\n    left: '0',\r\n    width: '100%',\r\n    height: '100%',\r\n    pointerEvents: 'none',\r\n    zIndex: '5',\r\n    touchAction: 'none'\r\n  });\r\n  \r\n  playfield.appendChild(canvas);\r\n\r\n  // Use desynchronized for lower latency\r\n  const ctx = canvas.getContext('2d', { \r\n    alpha: true,\r\n    desynchronized: true \r\n  });\r\n\r\n  // --- Texture Generation ---\r\n  const texture = document.createElement('canvas');\r\n  texture.width = TEXTURE_SIZE;\r\n  texture.height = TEXTURE_SIZE;\r\n  const tCtx = texture.getContext('2d');\r\n  \r\n  tCtx.shadowColor = '#FFEB3B';\r\n  tCtx.shadowBlur = GLOW_RADIUS;\r\n  tCtx.fillStyle = '#FFEB3B';\r\n  \r\n  tCtx.beginPath();\r\n  tCtx.arc(CENTER, CENTER, PARTICLE_RADIUS, 0, Math.PI * 2);\r\n  tCtx.fill();\r\n\r\n  // --- Interaction State ---\r\n  let pointerInside = false;\r\n  let lastSpawnX = null;\r\n  let lastSpawnY = null;\r\n  \r\n  let rect = { left: 0, top: 0, width: 0, height: 0 };\r\n  let dpr = 1;\r\n  let destroyed = false;\r\n  let rafId = 0;\r\n  let lastTime = 0;\r\n  let wasDirty = false;\r\n  let lastClearRect = null;\r\n\r\n  // Queue for incoming pointer points (from coalesced events)\r\n  // Each entry is { x, y } in local coordinates\r\n  const pointsQueue = [];\r\n\r\n  // --- Methods ---\r\n\r\n  const updateBounds = () => {\r\n    if (destroyed) return;\r\n    // Optimization: Assume playfield fills the viewport (position: fixed, inset: 0)\r\n    // This avoids getBoundingClientRect() forcing reflows or returning stale offsets\r\n    const w = document.documentElement.clientWidth;\r\n    const h = document.documentElement.clientHeight;\r\n    rect = { left: 0, top: 0, width: w, height: h, right: w, bottom: h, x: 0, y: 0 };\r\n  };\r\n\r\n  const resize = () => {\r\n    if (destroyed) return;\r\n    updateBounds();\r\n    const baseDpr = Math.min(window.devicePixelRatio || 1, 2);\r\n    const MAX_CANVAS_WIDTH = 512;\r\n    const widthScale = (rect.width > 0) ? Math.min(baseDpr, MAX_CANVAS_WIDTH / rect.width) : baseDpr;\r\n    dpr = widthScale;\r\n\r\n    canvas.width = rect.width * dpr;\r\n    canvas.height = rect.height * dpr;\r\n    \r\n    ctx.scale(dpr, dpr);\r\n    lastClearRect = null; \r\n  };\r\n\r\n  let resizeObserver = null;\r\n  if (typeof ResizeObserver !== 'undefined') {\r\n    resizeObserver = new ResizeObserver(() => {\r\n        resize();\r\n    });\r\n    resizeObserver.observe(playfield);\r\n  }\r\n\r\n  const spawn = (x, y) => {\r\n    if (freeCount <= 0) return;\r\n    const idx = freeSlots[--freeCount];\r\n    if (idx > maxActiveIndex) maxActiveIndex = idx;\r\n    const offset = idx * STRIDE;\r\n    data[offset] = x;\r\n    data[offset + 1] = y;\r\n    data[offset + 2] = 0;\r\n    data[offset + 3] = PARTICLE_LIFETIME;\r\n  };\r\n\r\n  const processPoint = (localX, localY, budgetRef) => {\r\n      // Spawn at this point, interpolating from lastSpawnX if needed\r\n      if (lastSpawnX === null || lastSpawnY === null) {\r\n          if (budgetRef.count < MAX_SPAWN_PER_FRAME) {\r\n            spawn(localX, localY);\r\n            budgetRef.count++;\r\n          }\r\n      } else {\r\n        const dx = localX - lastSpawnX;\r\n        const dy = localY - lastSpawnY;\r\n        const dist = Math.hypot(dx, dy);\r\n        \r\n        if (dist >= INTERPOLATION_STEP) {\r\n          const steps = Math.floor(dist / INTERPOLATION_STEP);\r\n          for (let i = 1; i <= steps; i++) {\r\n             if (budgetRef.count >= MAX_SPAWN_PER_FRAME) break;\r\n             const fraction = (i * INTERPOLATION_STEP) / dist;\r\n             spawn(lastSpawnX + dx * fraction, lastSpawnY + dy * fraction);\r\n             budgetRef.count++;\r\n          }\r\n        }\r\n        // Always spawn the point itself if we haven't blown budget drastically\r\n        // (Actually, we should prioritize the *end* points of the coalesced events, \r\n        // but spawning intermediate interpolated points is fine too)\r\n        if (budgetRef.count < MAX_SPAWN_PER_FRAME) {\r\n            spawn(localX, localY);\r\n            budgetRef.count++;\r\n        }\r\n      }\r\n      lastSpawnX = localX;\r\n      lastSpawnY = localY;\r\n  };\r\n\r\n  const onPointerMove = (e) => {\r\n    if (destroyed) return;\r\n    if (!rafId) {\r\n      lastTime = 0;\r\n      rafId = requestAnimationFrame(loop);\r\n    }\r\n    if (!rect.width) updateBounds();\r\n\r\n    // Calculate offset once per event\r\n    // Note: rect.left/top are screen coordinates. clientX/Y are screen coordinates.\r\n    // Optimization: rect.left/top are assumed 0 for full-screen playfield\r\n    const offsetX = 0;\r\n    const offsetY = 0;\r\n\r\n    // Helper to check bounds\r\n    const isIn = (x, y) => (x >= 0 && x <= rect.width && y >= 0 && y <= rect.height);\r\n    \r\n    // Process coalesced events if available to get high-frequency path\r\n    if (e.getCoalescedEvents) {\r\n        const events = e.getCoalescedEvents();\r\n        if (events.length > 0) {\r\n            for (const ev of events) {\r\n                const lx = ev.clientX - offsetX;\r\n                const ly = ev.clientY - offsetY;\r\n                pointsQueue.push({ x: lx, y: ly, inside: isIn(lx, ly) });\r\n            }\r\n        } else {\r\n            // Fallback if empty list returned\r\n            const lx = e.clientX - offsetX;\r\n            const ly = e.clientY - offsetY;\r\n            pointsQueue.push({ x: lx, y: ly, inside: isIn(lx, ly) });\r\n        }\r\n    } else {\r\n        const lx = e.clientX - offsetX;\r\n        const ly = e.clientY - offsetY;\r\n        pointsQueue.push({ x: lx, y: ly, inside: isIn(lx, ly) });\r\n    }\r\n  };\r\n  \r\n  const onPointerLeave = () => {\r\n    pointerInside = false;\r\n    lastSpawnX = null;\r\n    lastSpawnY = null;\r\n    pointsQueue.length = 0; // Clear queue on leave\r\n  };\r\n\r\n  const loop = () => {\r\n    if (destroyed) return;\r\n    \r\n    const now = performance.now();\r\n    if (!lastTime) lastTime = now;\r\n    let dt = now - lastTime;\r\n    lastTime = now;\r\n    if (dt > 100) dt = 100;\r\n\r\n    // --- Spawning Logic (Process Queue) ---\r\n    const budget = { count: 0 };\r\n    \r\n    if (pointsQueue.length > 0) {\r\n        // We have new input data\r\n        for (const pt of pointsQueue) {\r\n            if (pt.inside) {\r\n                pointerInside = true;\r\n                processPoint(pt.x, pt.y, budget);\r\n            } else {\r\n                pointerInside = false;\r\n                lastSpawnX = null;\r\n                lastSpawnY = null;\r\n            }\r\n        }\r\n        // Force the last point to be spawned exactly, to ensure tip connectivity\r\n        // (processPoint already does this, but let's double check logic)\r\n        // processPoint spawns at (localX, localY). \r\n        // If the budget ran out, we might have skipped it. \r\n        // Let's force the very last point of the queue if it was inside.\r\n        const lastPt = pointsQueue[pointsQueue.length - 1];\r\n        if (lastPt.inside) {\r\n             // If we haven't spawned at exact last location yet (due to budget), force it.\r\n             // (Simple check: compare lastSpawnX/Y with lastPt)\r\n             if (lastSpawnX !== lastPt.x || lastSpawnY !== lastPt.y) {\r\n                 spawn(lastPt.x, lastPt.y);\r\n                 lastSpawnX = lastPt.x;\r\n                 lastSpawnY = lastPt.y;\r\n             }\r\n        }\r\n        \r\n        pointsQueue.length = 0; // Consumed\r\n    } else if (pointerInside && lastSpawnX !== null && lastSpawnY !== null) {\r\n        spawn(lastSpawnX, lastSpawnY);\r\n    }\r\n\r\n    // --- Render & Update ---\r\n    const activeParticles = CAPACITY - freeCount;\r\n    \r\n    if (activeParticles === 0 && !wasDirty) {\r\n      rafId = 0;\r\n      return;\r\n    }\r\n\r\n    if (lastClearRect) {\r\n      ctx.clearRect(lastClearRect.x, lastClearRect.y, lastClearRect.w, lastClearRect.h);\r\n    } else {\r\n      ctx.clearRect(0, 0, rect.width, rect.height);\r\n    }\r\n    wasDirty = false;\r\n    \r\n    let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;\r\n\r\n    let newMaxIndex = -1;\r\n    if (activeParticles > 0) {\r\n      for (let i = 0; i <= maxActiveIndex; i++) {\r\n        const offset = i * STRIDE;\r\n        let age = data[offset + 2];\r\n        \r\n        if (age >= data[offset + 3]) continue;\r\n        \r\n        age += dt;\r\n        data[offset + 2] = age;\r\n        \r\n        if (age >= data[offset + 3]) {\r\n          freeSlots[freeCount++] = i;\r\n          continue;\r\n        }\r\n\r\n        newMaxIndex = i;\r\n        \r\n        const maxAge = data[offset + 3];\r\n        const progress = age / maxAge;\r\n        const opacity = 1 - progress;\r\n        const scale = 1 - (0.4 * progress);\r\n        \r\n        wasDirty = true;\r\n        ctx.globalAlpha = opacity;\r\n        \r\n        const size = TEXTURE_SIZE * scale;\r\n        const halfSize = size / 2;\r\n        const x = data[offset];\r\n        const y = data[offset + 1];\r\n        \r\n        const drawX = Math.round(x - halfSize);\r\n        const drawY = Math.round(y - halfSize);\r\n        const drawSize = Math.round(size);\r\n        \r\n        ctx.drawImage(texture, drawX, drawY, drawSize, drawSize);\r\n\r\n        if (drawX < minX) minX = drawX;\r\n        if (drawY < minY) minY = drawY;\r\n        const right = drawX + drawSize;\r\n        const bottom = drawY + drawSize;\r\n        if (right > maxX) maxX = right;\r\n        if (bottom > maxY) maxY = bottom;\r\n      }\r\n    }\r\n    maxActiveIndex = newMaxIndex;\r\n\r\n    if (minX !== Infinity) {\r\n        const PADDING = 2;\r\n        minX -= PADDING;\r\n        minY -= PADDING;\r\n        maxX += PADDING;\r\n        maxY += PADDING;\r\n        lastClearRect = { x: minX, y: minY, w: maxX - minX, h: maxY - minY };\r\n    } else {\r\n        lastClearRect = null;\r\n    }\r\n    \r\n    rafId = requestAnimationFrame(loop);\r\n  };\r\n\r\n  // --- Listeners ---\r\n  window.addEventListener('resize', resize);\r\n  window.addEventListener('scroll', updateBounds, { passive: true });\r\n  window.addEventListener('focus', updateBounds, { passive: true });\r\n  document.addEventListener('visibilitychange', updateBounds, { passive: true });\r\n  \r\n  const opts = { passive: true };\r\n  \r\n  const onPointerEnter = (e) => {\r\n      updateBounds();\r\n      onPointerMove(e);\r\n  };\r\n\r\n  const onPointerDown = (e) => {\r\n      updateBounds();\r\n      onPointerMove(e);\r\n  };\r\n\r\n  playfield.addEventListener('pointermove', onPointerMove, opts);\r\n  playfield.addEventListener('pointerdown', onPointerDown, opts);\r\n  playfield.addEventListener('pointerenter', onPointerEnter, opts);\r\n  playfield.addEventListener('pointerleave', onPointerLeave, opts);\r\n  playfield.addEventListener('pointercancel', onPointerLeave, opts);\r\n\r\n  resize();\r\n  rafId = requestAnimationFrame(loop);\r\n\r\n  // Periodically update bounds to sync with any layout shifts\r\n  const syncInterval = setInterval(updateBounds, 1000);\r\n\r\n  const destroy = () => {\r\n    destroyed = true;\r\n    if (rafId) cancelAnimationFrame(rafId);\r\n    if (syncInterval) clearInterval(syncInterval);\r\n    \r\n    if (resizeObserver) {\r\n        resizeObserver.disconnect();\r\n        resizeObserver = null;\r\n    }\r\n\r\n    try { window.removeEventListener('resize', resize); } catch {}\r\n    try { window.removeEventListener('scroll', updateBounds); } catch {}\r\n    try { window.removeEventListener('focus', updateBounds); } catch {}\r\n    try { document.removeEventListener('visibilitychange', updateBounds); } catch {}\r\n    \r\n    try {\r\n      playfield.removeEventListener('pointermove', onPointerMove);\r\n      playfield.removeEventListener('pointerdown', onPointerDown);\r\n      playfield.removeEventListener('pointerenter', onPointerEnter); \r\n      playfield.removeEventListener('pointerleave', onPointerLeave);\r\n      playfield.removeEventListener('pointercancel', onPointerLeave);\r\n    } catch {}\r\n    \r\n    canvas.remove();\r\n  };\r\n\r\n  return { destroy };\r\n}\r\n", "// js/game/coinPickup.js\r\n\r\nimport { bank, CURRENCIES, getActiveSlot, isCurrencyLocked } from '../util/storage.js';\r\nimport { BigNum } from '../util/bigNum.js';\r\nimport { formatNumber } from '../util/numFormat.js';\r\nimport { unlockShop } from '../ui/hudButtons.js';\r\nimport { addXp, isXpSystemUnlocked } from './xpSystem.js';\r\nimport { IS_MOBILE } from '../main.js';\r\nimport {\r\n  addMutationPower,\r\n  isMutationUnlocked,\r\n  getMutationState,\r\n  onMutationChange,\r\n  computeMutationMultiplierForLevel,\r\n} from './mutationSystem.js';\r\nimport { getMpValueMultiplierBn, getMagnetLevel } from './upgrades.js';\r\nimport { createCursorTrail } from './cursorTrail.js';\r\nimport { playAudio } from '../util/audioManager.js';\r\nimport { onCoinCollected } from './comboSystem.js';\r\nimport { getComboUiString } from './surgeEffects.js';\r\n\r\nlet mutationUnlockedSnapshot = false;\r\nlet mutationLevelIsInfiniteSnapshot = false;\r\nlet mutationCurrentLevelStr = '0';\r\nlet mutationUnsub = null;\r\n\r\nfunction updateMutationSnapshot(state) {\r\n  if (!state || typeof state !== 'object') {\r\n    mutationUnlockedSnapshot = false;\r\n    mutationLevelIsInfiniteSnapshot = false;\r\n    mutationCurrentLevelStr = '0';\r\n    mutationMultiplierCache.clear();\r\n    return;\r\n  }\r\n\r\n  mutationUnlockedSnapshot = !!state.unlocked;\r\n  mutationLevelIsInfiniteSnapshot = !!state.level?.isInfinite?.();\r\n  try {\r\n    mutationCurrentLevelStr = state.level?.toPlainIntegerString?.() ?? '0';\r\n  } catch {\r\n    mutationCurrentLevelStr = '0';\r\n  }\r\n\r\n  if (!mutationUnlockedSnapshot) {\r\n    mutationMultiplierCache.clear();\r\n  } else if (mutationLevelIsInfiniteSnapshot) {\r\n    mutationMultiplierCache.clear();\r\n  }\r\n}\r\n\r\nfunction initMutationSnapshot() {\r\n  if (typeof mutationUnsub === 'function') {\r\n    try { mutationUnsub(); } catch {}\r\n  }\r\n  try {\r\n    updateMutationSnapshot(getMutationState());\r\n  } catch {\r\n    mutationUnlockedSnapshot = false;\r\n    mutationMultiplierCache.clear();\r\n  }\r\n  try {\r\n    mutationUnsub = onMutationChange((snapshot) => { updateMutationSnapshot(snapshot); });\r\n  } catch {\r\n    mutationUnsub = null;\r\n  }\r\n}\r\n\r\nlet coinPickup = null;\r\n\r\nconst XP_PER_COIN = BigNum.fromInt(1);\r\nconst BASE_COIN_VALUE = BigNum.fromInt(1);\r\nconst BN_ONE = BigNum.fromInt(1);\r\n\r\nlet BN_INF;\r\ntry {\r\n  BN_INF = BigNum.fromAny('Infinity');\r\n} catch {\r\n  BN_INF = null;\r\n}\r\n\r\nconst mutationMultiplierCache = new Map();\r\nlet COIN_MULTIPLIER = '1';\r\nlet mpValueMultiplierBn = BigNum.fromInt(1);\r\nlet mpMultiplierListenersBound = false;\r\n\r\n// Module-level state for queuing and HUD updates\r\nlet pendingCoinGain = null;\r\nlet pendingXpGain = null;\r\nlet pendingMutGain = null;\r\nlet flushScheduled = false;\r\nlet coinsVal = null; // Cached BigNum value for HUD\r\nlet updateHudFn = () => {}; // No-op until initialized\r\n\r\nlet hudUpdateScheduled = false;\r\nconst scheduleHudUpdate = () => {\r\n  if (hudUpdateScheduled) return;\r\n  hudUpdateScheduled = true;\r\n  requestAnimationFrame(() => {\r\n    hudUpdateScheduled = false;\r\n    updateHudFn();\r\n  });\r\n};\r\n\r\nexport function setCoinMultiplier(x) {\r\n  COIN_MULTIPLIER = x;\r\n  try {\r\n    if (bank.coins?.mult?.set) {\r\n      bank.coins.mult.set(x);\r\n    }\r\n  } catch {}\r\n}\r\n\r\nfunction refreshMpValueMultiplierCache() {\r\n  try {\r\n    const next = getMpValueMultiplierBn();\r\n    if (next instanceof BigNum) {\r\n      mpValueMultiplierBn = next.clone?.() ?? next;\r\n    } else if (next != null) {\r\n      mpValueMultiplierBn = BigNum.fromAny(next);\r\n    } else {\r\n      mpValueMultiplierBn = BigNum.fromInt(1);\r\n    }\r\n  } catch {\r\n    mpValueMultiplierBn = BigNum.fromInt(1);\r\n  }\r\n}\r\n\r\nfunction ensureMpValueMultiplierSync() {\r\n  if (mpMultiplierListenersBound) return;\r\n  mpMultiplierListenersBound = true;\r\n  refreshMpValueMultiplierCache();\r\n  if (typeof document !== 'undefined') {\r\n    document.addEventListener('ccc:upgrades:changed', refreshMpValueMultiplierCache);\r\n  }\r\n  if (typeof window !== 'undefined') {\r\n    window.addEventListener('saveSlot:change', refreshMpValueMultiplierCache);\r\n  }\r\n}\r\n\r\nfunction resolveCoinBase(el) {\r\n  if (el?.dataset?.bn) {\r\n    try { return BigNum.fromAny(el.dataset.bn); } catch {}\r\n  }\r\n  if (el?.dataset?.value) {\r\n    try { return BigNum.fromAny(el.dataset.value); } catch {}\r\n  }\r\n  try { return BASE_COIN_VALUE.clone?.() ?? BigNum.fromInt(1); }\r\n  catch { return BigNum.fromInt(1); }\r\n}\r\n\r\nconst MAGNET_UNIT_RATIO = 0.05;\r\nconst MAGNET_COLLECTION_BUFFER = 8; // Small buffer for collection feel\r\n\r\nfunction computeMagnetUnitPx() {\r\n  if (typeof window === 'undefined' || typeof document === 'undefined') return 0;\r\n  const root = document.documentElement;\r\n  const vw = Math.max(0, window.innerWidth || root?.clientWidth || 0);\r\n  const vh = Math.max(0, window.innerHeight || root?.clientHeight || 0);\r\n  if (!(vw > 0 && vh > 0)) return 0;\r\n  const minDim = Math.min(vw, vh);\r\n  return minDim * MAGNET_UNIT_RATIO;\r\n}\r\n\r\nfunction createMagnetController({ playfield, coinsLayer, coinSelector, collectFn, collectBatchFn, spawner }) {\r\n  if (!playfield || !coinsLayer || typeof collectFn !== 'function') {\r\n    return { destroy() {} };\r\n  }\r\n  if (typeof window === 'undefined' || typeof document === 'undefined') {\r\n    return { destroy() {} };\r\n  }\r\n\r\n  const indicator = document.createElement('div');\r\n  indicator.className = 'magnet-indicator';\r\n  indicator.setAttribute('aria-hidden', 'true');\r\n  playfield.appendChild(indicator);\r\n\r\n  let pointerInside = false;\r\n  let hasPointer = false;\r\n  let pointerClientX = 0;\r\n  let pointerClientY = 0;\r\n  let localX = 0;\r\n  let localY = 0;\r\n  // Track last local position for interpolation\r\n  let lastLocalX = null;\r\n  let lastLocalY = null;\r\n\r\n  let unitPx = computeMagnetUnitPx();\r\n  let magnetLevel = 0;\r\n  let radiusPx = 0;\r\n  let rafId = 0;\r\n  let destroyed = false;\r\n  let playfieldRect = null;\r\n  // Periodically update bounds to sync with any layout shifts\r\n  let syncInterval = null;\r\n\r\n  const updatePlayfieldRect = () => {\r\n    if (destroyed) return;\r\n    // Optimization: Assume playfield fills the viewport (position: fixed, inset: 0)\r\n    const w = document.documentElement.clientWidth;\r\n    const h = document.documentElement.clientHeight;\r\n    playfieldRect = { left: 0, top: 0, width: w, height: h, right: w, bottom: h, x: 0, y: 0 };\r\n  };\r\n\r\n  const hideIndicator = () => {\r\n    indicator.classList.remove('is-visible');\r\n    indicator.style.transform = 'translate3d(-9999px, -9999px, 0)';\r\n    lastLocalX = null;\r\n    lastLocalY = null;\r\n  };\r\n\r\n  const updateIndicator = () => {\r\n    if (!pointerInside || radiusPx <= 0) {\r\n      hideIndicator();\r\n      return;\r\n    }\r\n    const diameter = radiusPx * 2;\r\n    indicator.style.width = `${diameter}px`;\r\n    indicator.style.height = `${diameter}px`;\r\n    indicator.style.transform = `translate3d(${localX - radiusPx}px, ${localY - radiusPx}px, 0)`;\r\n    indicator.classList.add('is-visible');\r\n  };\r\n\r\n  const sweepCoins = () => {\r\n    if (!pointerInside || radiusPx <= 0) return;\r\n    \r\n    // Optimized: Use Spawner's spatial lookup if available\r\n    if (spawner && typeof spawner.findCoinTargetsInRadius === 'function') {\r\n        const radiusWithBuffer = radiusPx + MAGNET_COLLECTION_BUFFER;\r\n        \r\n        let candidates = [];\r\n        if (typeof spawner.findCoinTargetsInPath === 'function' && lastLocalX !== null && lastLocalY !== null) {\r\n             candidates = spawner.findCoinTargetsInPath(lastLocalX, lastLocalY, localX, localY, radiusWithBuffer);\r\n        } else {\r\n             candidates = spawner.findCoinTargetsInRadius(localX, localY, radiusWithBuffer);\r\n        }\r\n\r\n        lastLocalX = localX;\r\n        lastLocalY = localY;\r\n        \r\n        if (candidates && candidates.length > 0) {\r\n            if (typeof collectBatchFn === 'function') {\r\n                 const items = [];\r\n                 for (let i = 0; i < candidates.length; i++) {\r\n                     const c = candidates[i];\r\n                     const item = { coin: c };\r\n                     if (c.el && spawner.getCoinTransform) {\r\n                         item.opts = { transform: spawner.getCoinTransform(c.el) };\r\n                     }\r\n                     items.push(item);\r\n                 }\r\n                 collectBatchFn(items);\r\n            } else {\r\n                for (let i = 0; i < candidates.length; i++) {\r\n                    const c = candidates[i];\r\n                    const el = spawner.ensureCoinVisual ? spawner.ensureCoinVisual(c) : c.el;\r\n                    if (el) {\r\n                        const t = spawner.getCoinTransform ? spawner.getCoinTransform(el) : (el.style.transform || '');\r\n                        collectFn(el, { transform: t });\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    } else if (spawner && typeof spawner.findCoinsInRadius === 'function') {\r\n        // Fallback\r\n        const radiusWithBuffer = radiusPx + MAGNET_COLLECTION_BUFFER;\r\n        const candidates = spawner.findCoinsInRadius(localX, localY, radiusWithBuffer);\r\n        lastLocalX = localX; lastLocalY = localY;\r\n        \r\n        if (candidates && candidates.length > 0) {\r\n             const items = [];\r\n             for (let i = 0; i < candidates.length; i++) {\r\n                 const el = candidates[i];\r\n                 const t = spawner.getCoinTransform ? spawner.getCoinTransform(el) : el.style.transform;\r\n                 items.push({ el, opts: { transform: t } });\r\n             }\r\n             if (typeof collectBatchFn === 'function') collectBatchFn(items);\r\n        }\r\n    } else {\r\n        // Fallback (Slow) - should not be hit if spawner is passed\r\n        const coins = coinsLayer.children;\r\n        const radiusWithBuffer = radiusPx + MAGNET_COLLECTION_BUFFER;\r\n        const toCollect = [];\r\n        \r\n        for (let i = coins.length - 1; i >= 0; i--) {\r\n          const coin = coins[i];\r\n          if (coin.dataset.collected === '1') continue;\r\n          if (!coin.matches(coinSelector)) continue;\r\n    \r\n          const rect = coin.getBoundingClientRect();\r\n          const coinX = rect.left + rect.width / 2;\r\n          const coinY = rect.top + rect.height / 2;\r\n          const dx = coinX - pointerClientX;\r\n          const dy = coinY - pointerClientY;\r\n          if (Math.hypot(dx, dy) <= radiusWithBuffer) {\r\n            toCollect.push(coin);\r\n          }\r\n        }\r\n    \r\n        if (!toCollect.length) return;\r\n    \r\n        if (typeof collectBatchFn === 'function') {\r\n            const items = [];\r\n            for (let i = 0; i < toCollect.length; i++) {\r\n                const el = toCollect[i];\r\n                const cs = window.getComputedStyle(el);\r\n                items.push({ el, opts: { transform: cs.transform } });\r\n            }\r\n            collectBatchFn(items);\r\n        } else {\r\n            const transforms = [];\r\n            for (let i = 0; i < toCollect.length; i++) {\r\n                const el = toCollect[i];\r\n                const cs = window.getComputedStyle(el);\r\n                transforms.push(cs.transform);\r\n            }\r\n            for (let i = 0; i < toCollect.length; i++) {\r\n                collectFn(toCollect[i], { transform: transforms[i] });\r\n            }\r\n        }\r\n    }\r\n  };\r\n\r\n  const runSweep = () => {\r\n    rafId = 0;\r\n    updateIndicator();\r\n    if (!pointerInside || radiusPx <= 0 || destroyed) return;\r\n    sweepCoins();\r\n    ensureSweepLoop();\r\n  };\r\n\r\n  const ensureSweepLoop = () => {\r\n    if (!pointerInside || radiusPx <= 0 || rafId || destroyed) return;\r\n    rafId = requestAnimationFrame(runSweep);\r\n  };\r\n\r\n  const updatePointerFromEvent = (e) => {\r\n    if (!e || destroyed) return;\r\n    if (typeof e.clientX !== 'number' || typeof e.clientY !== 'number') return;\r\n    hasPointer = true;\r\n    pointerClientX = e.clientX;\r\n    pointerClientY = e.clientY;\r\n    \r\n    if (!playfieldRect) updatePlayfieldRect();\r\n    const rect = playfieldRect;\r\n\r\n    // Optimization: rect.left/top assumed 0\r\n    localX = pointerClientX;\r\n    localY = pointerClientY;\r\n    pointerInside = localX >= 0 && localX <= rect.width && localY >= 0 && localY <= rect.height;\r\n    \r\n    ensureSweepLoop();\r\n  };\r\n\r\n  const handlePointerLeave = () => {\r\n    pointerInside = false;\r\n    hideIndicator();\r\n    lastLocalX = null;\r\n    lastLocalY = null;\r\n  };\r\n  \r\n  const resetPointerHistory = () => {\r\n    lastLocalX = null;\r\n    lastLocalY = null;\r\n  };\r\n\r\n  const refreshMagnetLevel = () => {\r\n    const nextLevel = getMagnetLevel();\r\n    magnetLevel = nextLevel;\r\n    radiusPx = magnetLevel * unitPx;\r\n    updateIndicator();\r\n    ensureSweepLoop();\r\n  };\r\n\r\n  const handleScroll = () => {\r\n    if (destroyed || !hasPointer) return;\r\n    updatePlayfieldRect();\r\n    if (playfieldRect) {\r\n        const rect = playfieldRect;\r\n        localX = pointerClientX - rect.left;\r\n        localY = pointerClientY - rect.top;\r\n        pointerInside = localX >= 0 && localX <= rect.width && localY >= 0 && localY <= rect.height;\r\n    }\r\n    ensureSweepLoop();\r\n  };\r\n\r\n  const handleResize = () => {\r\n    unitPx = computeMagnetUnitPx();\r\n    radiusPx = magnetLevel * unitPx;\r\n    updatePlayfieldRect();\r\n    if (hasPointer && playfieldRect) {\r\n        const rect = playfieldRect;\r\n        localX = pointerClientX - rect.left;\r\n        localY = pointerClientY - rect.top;\r\n        pointerInside = localX >= 0 && localX <= rect.width && localY >= 0 && localY <= rect.height;\r\n    }\r\n    ensureSweepLoop();\r\n  };\r\n  \r\n  const forceUpdateAndMove = (e) => {\r\n    updatePlayfieldRect();\r\n    updatePointerFromEvent(e);\r\n  };\r\n\r\n  const handlePointerEnter = (e) => {\r\n    resetPointerHistory();\r\n    forceUpdateAndMove(e);\r\n  };\r\n\r\n  const destroy = () => {\r\n    destroyed = true;\r\n    if (rafId) {\r\n      cancelAnimationFrame(rafId);\r\n      rafId = 0;\r\n    }\r\n    if (syncInterval) clearInterval(syncInterval);\r\n    try { window.removeEventListener('scroll', handleScroll); } catch {}\r\n    try { window.removeEventListener('resize', handleResize); } catch {}\r\n    try { window.removeEventListener('saveSlot:change', refreshMagnetLevel); } catch {}\r\n    try { document.removeEventListener('ccc:upgrades:changed', refreshMagnetLevel); } catch {}\r\n    try { playfield.removeEventListener('pointermove', updatePointerFromEvent); } catch {}\r\n    try { playfield.removeEventListener('pointerdown', forceUpdateAndMove); } catch {}\r\n    try { playfield.removeEventListener('pointerenter', handlePointerEnter); } catch {}\r\n    try { playfield.removeEventListener('pointerleave', handlePointerLeave); } catch {}\r\n    try { playfield.removeEventListener('pointercancel', handlePointerLeave); } catch {}\r\n    try { window.removeEventListener('blur', resetPointerHistory); } catch {}\r\n    try { indicator.remove(); } catch {}\r\n  };\r\n\r\n  const pointerOpts = { passive: true };\r\n\r\n  playfield.addEventListener('pointermove', updatePointerFromEvent, pointerOpts);\r\n  playfield.addEventListener('pointerdown', forceUpdateAndMove, pointerOpts);\r\n  playfield.addEventListener('pointerenter', handlePointerEnter, pointerOpts);\r\n  playfield.addEventListener('pointerleave', handlePointerLeave, pointerOpts);\r\n  playfield.addEventListener('pointercancel', handlePointerLeave, pointerOpts);\r\n  window.addEventListener('resize', handleResize);\r\n  window.addEventListener('scroll', handleScroll, { passive: true });\r\n  window.addEventListener('focus', updatePlayfieldRect, { passive: true });\r\n  window.addEventListener('blur', resetPointerHistory, { passive: true });\r\n  document.addEventListener('visibilitychange', () => {\r\n      updatePlayfieldRect();\r\n      if (document.hidden) resetPointerHistory();\r\n  }, { passive: true });\r\n  window.addEventListener('saveSlot:change', refreshMagnetLevel);\r\n  document.addEventListener('ccc:upgrades:changed', refreshMagnetLevel);\r\n\r\n  syncInterval = setInterval(updatePlayfieldRect, 1000);\r\n\r\n  refreshMagnetLevel();\r\n\r\n  return { destroy };\r\n}\r\n\r\n// Queue helpers moved to module scope\r\nconst cloneBn = (value) => {\r\n  if (!value) return BigNum.fromInt(0);\r\n  if (typeof value.clone === 'function') {\r\n    try { return value.clone(); } catch {}\r\n  }\r\n  try { return BigNum.fromAny(value); } catch { return BigNum.fromInt(0); }\r\n};\r\n\r\nconst mergeGain = (current, gain) => {\r\n  if (!gain) return current;\r\n  if (!current) return cloneBn(gain);\r\n  try { return current.add(gain); }\r\n  catch {\r\n    try {\r\n      const base = cloneBn(current);\r\n      return base.add(gain);\r\n    } catch {\r\n      return cloneBn(gain);\r\n    }\r\n  }\r\n};\r\n\r\nconst flushPendingGains = () => {\r\n  const coinGain = pendingCoinGain;\r\n  pendingCoinGain = null;\r\n  if (coinGain && !coinGain.isZero?.()) {\r\n    try { bank.coins.add(coinGain); } catch {}\r\n  }\r\n\r\n  const xpGain = pendingXpGain;\r\n  pendingXpGain = null;\r\n  if (xpGain && !xpGain.isZero?.()) {\r\n    try { addXp(xpGain); } catch {}\r\n  }\r\n\r\n  const mutGain = pendingMutGain;\r\n  pendingMutGain = null;\r\n  if (mutGain && !mutGain.isZero?.()) {\r\n    try { addMutationPower(mutGain); } catch {}\r\n  }\r\n};\r\n\r\nconst scheduleFlush = () => {\r\n  if (flushScheduled) return;\r\n  flushScheduled = true;\r\n  requestAnimationFrame(() => {\r\n    flushScheduled = false;\r\n    flushPendingGains();\r\n  });\r\n};\r\n\r\nconst queueCoinGain = (gain) => {\r\n  pendingCoinGain = mergeGain(pendingCoinGain, gain);\r\n  scheduleFlush();\r\n};\r\n\r\nconst queueXpGain = (gain) => {\r\n  pendingXpGain = mergeGain(pendingXpGain, gain);\r\n  scheduleFlush();\r\n};\r\n\r\nconst queueMutationGain = (gain) => {\r\n  pendingMutGain = mergeGain(pendingMutGain, gain);\r\n  scheduleFlush();\r\n};\r\n\r\nif (typeof window !== 'undefined') {\r\n  window.addEventListener('beforeunload', flushPendingGains, { passive: true });\r\n}\r\n\r\nexport function clearPendingGains() {\r\n  pendingCoinGain = null;\r\n  pendingXpGain = null;\r\n  pendingMutGain = null;\r\n}\r\n\r\nlet coinMultiplierBn = null;\r\nlet coinMultiplierIsInfinite = false;\r\n\r\nconst refreshCoinMultiplierCache = () => {\r\n  try {\r\n    const multHandle = bank?.coins?.mult;\r\n    if (!multHandle || typeof multHandle.get !== 'function') {\r\n      coinMultiplierBn = null;\r\n      coinMultiplierIsInfinite = false;\r\n      return;\r\n    }\r\n    const next = multHandle.get();\r\n    if (!next) {\r\n      coinMultiplierBn = BigNum.fromInt(1);\r\n      coinMultiplierIsInfinite = false;\r\n      return;\r\n    }\r\n    coinMultiplierBn = next.clone?.() ?? BigNum.fromAny(next);\r\n    coinMultiplierIsInfinite = !!coinMultiplierBn?.isInfinite?.();\r\n  } catch {\r\n    coinMultiplierBn = null;\r\n    coinMultiplierIsInfinite = false;\r\n  }\r\n};\r\n\r\nconst applyCoinMultiplier = (value) => {\r\n  let base;\r\n  try {\r\n    base = value instanceof BigNum\r\n      ? (value.clone?.() ?? value)\r\n      : BigNum.fromAny(value ?? 0);\r\n  } catch {\r\n    try {\r\n      return bank?.coins?.mult?.applyTo ? bank.coins.mult.applyTo(value) : BigNum.fromInt(0);\r\n    } catch {\r\n      return BigNum.fromInt(0);\r\n    }\r\n  }\r\n\r\n  if (!coinMultiplierBn) refreshCoinMultiplierCache();\r\n  const mult = coinMultiplierBn;\r\n  if (!mult) {\r\n    try { return bank?.coins?.mult?.applyTo ? bank.coins.mult.applyTo(base) : base.clone?.() ?? base; }\r\n    catch { return base.clone?.() ?? base; }\r\n  }\r\n  const multIsInf = coinMultiplierIsInfinite || mult.isInfinite?.();\r\n  if (multIsInf) {\r\n    try { return BigNum.fromAny('Infinity'); }\r\n    catch { return base.clone?.() ?? base; }\r\n  }\r\n  if (base.isZero?.()) {\r\n    return base.clone?.() ?? base;\r\n  }\r\n  try {\r\n    return base.mulBigNumInteger(mult);\r\n  } catch {\r\n    try { return bank?.coins?.mult?.applyTo ? bank.coins.mult.applyTo(base) : base.clone?.() ?? base; }\r\n    catch { return base.clone?.() ?? base; }\r\n  }\r\n};\r\n\r\nconst computeMutationMultiplier = (spawnLevelStr) => {\r\n  if (!mutationUnlockedSnapshot) return null;\r\n\r\n  if (mutationLevelIsInfiniteSnapshot) {\r\n    if (BN_INF) {\r\n      try { return BN_INF.clone?.() ?? BN_INF; }\r\n      catch { return BN_INF; }\r\n    }\r\n    return null;\r\n  }\r\n\r\n  if (!spawnLevelStr) return null;\r\n  const key = String(spawnLevelStr).trim();\r\n  if (!key) return null;\r\n\r\n  const cached = mutationMultiplierCache.get(key);\r\n  if (cached) {\r\n    try { return cached.clone?.() ?? BigNum.fromAny(cached); }\r\n    catch { mutationMultiplierCache.delete(key); }\r\n  }\r\n\r\n  let levelBn;\r\n  try {\r\n    levelBn = BigNum.fromAny(key);\r\n  } catch {\r\n    return null;\r\n  }\r\n\r\n  let multiplier;\r\n  try {\r\n    multiplier = computeMutationMultiplierForLevel(levelBn);\r\n  } catch {\r\n    multiplier = null;\r\n  }\r\n\r\n  if (!multiplier) return null;\r\n  const isIdentity = multiplier.cmp?.(BN_ONE) === 0;\r\n  const stored = multiplier.clone?.() ?? multiplier;\r\n  mutationMultiplierCache.set(key, stored);\r\n  if (isIdentity) return null;\r\n  try { return stored.clone?.() ?? stored; }\r\n  catch { return stored; }\r\n};\r\n\r\n// --- New Logic for Passive/Active Automation ---\r\n\r\nfunction calculateCoinValue(spawnLevelStr) {\r\n  const base = BASE_COIN_VALUE.clone?.() ?? BigNum.fromInt(1);\r\n  let inc = applyCoinMultiplier(base);\r\n  let xpInc = cloneBn(XP_PER_COIN);\r\n\r\n  // If spawnLevelStr is null/undefined, use current mutation level (passive generation)\r\n  const levelStr = spawnLevelStr ?? mutationCurrentLevelStr;\r\n  const mutationMultiplier = computeMutationMultiplier(levelStr);\r\n  \r\n  if (mutationMultiplier) {\r\n    try { inc = inc.mulBigNumInteger(mutationMultiplier); } catch {}\r\n    try { xpInc = xpInc.mulBigNumInteger(mutationMultiplier); } catch {}\r\n  }\r\n  \r\n  const mpGain = (typeof isMutationUnlocked === 'function' && isMutationUnlocked())\r\n    ? cloneBn(mpValueMultiplierBn)\r\n    : BigNum.fromInt(0);\r\n\r\n  return { coinGain: inc, xpGain: xpInc, mpGain };\r\n}\r\n\r\nexport function getPassiveCoinReward() {\r\n  const { coinGain, xpGain, mpGain } = calculateCoinValue(null);\r\n  return { \r\n    coins: coinGain, \r\n    xp: xpGain, \r\n    mp: mpGain \r\n  };\r\n}\r\n\r\nexport function triggerPassiveCollect(count = 1) {\r\n  if (count <= 0) return;\r\n  const { coinGain, xpGain, mpGain } = calculateCoinValue(null);\r\n  \r\n  const totalCoin = coinGain.mulBigNumInteger(BigNum.fromAny(count));\r\n  const totalXp = xpGain.mulBigNumInteger(BigNum.fromAny(count));\r\n  const totalMp = mpGain.mulBigNumInteger(BigNum.fromAny(count));\r\n\r\n  const coinsLocked = isCurrencyLocked(CURRENCIES.COINS);\r\n  const incIsZero = typeof totalCoin?.isZero === 'function' ? totalCoin.isZero() : false;\r\n\r\n  if (!incIsZero && !coinsLocked) {\r\n    try {\r\n      coinsVal = coinsVal?.add ? coinsVal.add(totalCoin) : cloneBn(totalCoin);\r\n    } catch {\r\n      coinsVal = cloneBn(totalCoin);\r\n    }\r\n  }\r\n  scheduleHudUpdate();\r\n\r\n  if (!incIsZero) {\r\n    queueCoinGain(totalCoin);\r\n  }\r\n\r\n  const xpEnabled = typeof isXpSystemUnlocked === 'function' ? isXpSystemUnlocked() : true;\r\n  const xpIsZero = typeof totalXp?.isZero === 'function' ? totalXp.isZero() : false;\r\n  if (xpEnabled && !xpIsZero) {\r\n    queueXpGain(totalXp);\r\n  }\r\n\r\n  if (!totalMp.isZero?.()) {\r\n    queueMutationGain(totalMp);\r\n  }\r\n}\r\n\r\nexport function initCoinPickup({\r\n  spawner,\r\n  playfieldSelector   = '.area-cove .playfield',\r\n  coinsLayerSelector  = '.area-cove .coins-layer',\r\n  hudAmountSelector   = '.hud-top .coin-amount',\r\n  coinSelector        = '.coin, [data-coin], .coin-sprite',\r\n  soundSrc            = 'sounds/coin_pickup.ogg',\r\n  storageKey          = 'ccc:coins',\r\n  disableAnimation    = false, // Force false to re-enable on mobile\r\n} = {}) {\r\n  if (coinPickup?.destroy) {\r\n    coinPickup.destroy();\r\n  }\r\n  \r\n  const pf  = document.querySelector(playfieldSelector);\r\n  const cl  = document.querySelector(coinsLayerSelector);\r\n  const amt = document.querySelector(hudAmountSelector);\r\n  if (!pf || !cl || !amt) {\r\n    console.warn('[coinPickup] missing required nodes', { pf: !!pf, cl: !!cl, amt: !!amt });\r\n    return { destroy(){} };\r\n  }\r\n\r\n  initMutationSnapshot();\r\n  ensureMpValueMultiplierSync();\r\n\r\n  pf.style.touchAction = 'none';\r\n\r\n  let magnetController = null;\r\n  let cursorTrail = null;\r\n  coinsVal = bank.coins.value;\r\n  \r\n  updateHudFn = () => {\r\n    const formatted = formatNumber(coinsVal);\r\n    const comboStr = getComboUiString();\r\n    const fullText = formatted + comboStr;\r\n\r\n    if (fullText.includes('<span')) {\r\n      amt.innerHTML = fullText;\r\n    } else {\r\n      amt.textContent = fullText;\r\n    }\r\n  };\r\n  \r\n  refreshCoinMultiplierCache();\r\n  scheduleHudUpdate();\r\n\r\n  const onCurrencyChange = (e) => {\r\n    if (!e?.detail) return;\r\n    if (e.detail.key === 'coins') {\r\n      coinsVal = e.detail.value;\r\n      scheduleHudUpdate();\r\n    }\r\n  };\r\n  window.addEventListener('currency:change', onCurrencyChange);\r\n\r\n  const onCoinMultiplierChange = (event) => {\r\n    if (!event?.detail || event.detail.key !== 'coins') return;\r\n    try {\r\n      const { mult } = event.detail;\r\n      if (mult instanceof BigNum) {\r\n        coinMultiplierBn = mult.clone?.() ?? mult;\r\n      } else if (mult != null) {\r\n        coinMultiplierBn = BigNum.fromAny(mult);\r\n      } else {\r\n        coinMultiplierBn = BigNum.fromInt(1);\r\n      }\r\n      coinMultiplierIsInfinite = !!coinMultiplierBn?.isInfinite?.();\r\n    } catch {\r\n      coinMultiplierBn = null;\r\n      coinMultiplierIsInfinite = false;\r\n    }\r\n  };\r\n  window.addEventListener('currency:multiplier', onCoinMultiplierChange);\r\n\r\n  // ----- Slot-scoped shop unlock/progress keys -----\r\n  const slot = getActiveSlot();\r\n  if (slot == null) {\r\n    console.warn('[coinPickup] init called before a save slot is selected.');\r\n    return { destroy(){} };\r\n  }\r\n  const SHOP_UNLOCK_KEY   = `ccc:unlock:shop:${slot}`;\r\n  const SHOP_PROGRESS_KEY = `ccc:unlock:shop:progress:${slot}`;\r\n\r\n  const legacyP = localStorage.getItem('ccc:unlock:shop:progress');\r\n  const legacyU = localStorage.getItem('ccc:unlock:shop');\r\n  if (legacyP != null && localStorage.getItem(SHOP_PROGRESS_KEY) == null) {\r\n    localStorage.setItem(SHOP_PROGRESS_KEY, legacyP);\r\n  }\r\n  if (legacyU != null && localStorage.getItem(SHOP_UNLOCK_KEY) == null) {\r\n    localStorage.setItem(SHOP_UNLOCK_KEY, legacyU);\r\n  }\r\n  localStorage.removeItem('ccc:unlock:shop:progress');\r\n  localStorage.removeItem('ccc:unlock:shop');\r\n\r\n  {\r\n    const p = parseInt(localStorage.getItem(SHOP_PROGRESS_KEY) || '0', 10);\r\n    localStorage.setItem(SHOP_PROGRESS_KEY, String(p));\r\n    if (p >= 10 && localStorage.getItem(SHOP_UNLOCK_KEY) !== '1') {\r\n      try { unlockShop(); } catch {}\r\n      localStorage.setItem(SHOP_UNLOCK_KEY, '1');\r\n    }\r\n  }\r\n\r\n  const resolvedSrc = new URL(soundSrc, document.baseURI).href;\r\n  \r\n  // Optimization: use _coinObj if present, fallback to dataset/matches\r\n  const isCoin = (el) => {\r\n      if (!(el instanceof HTMLElement)) return false;\r\n      // Fast path: Check for attached object\r\n      if (el._coinObj) return !el._coinObj.isRemoved && el.dataset.collected !== '1';\r\n      return el.dataset.collected !== '1' && el.matches(coinSelector);\r\n  };\r\n\r\n  function ensureInteractive(el){ try { el.style.pointerEvents = 'auto'; } catch {} }\r\n  cl.querySelectorAll(coinSelector).forEach(ensureInteractive);\r\n  \r\n  // ----- Audio Handling -----\r\n  // Replaced with audioManager\r\n  const COIN_VOLUME = IS_MOBILE ? 0.12 : 0.3;\r\n  let lastAt = 0;\r\n\r\n  function playSound(src = resolvedSrc){\r\n    // Debounce slightly for default sound to avoid overwhelming accumulation\r\n    if (src === resolvedSrc) {\r\n        const now = performance.now();\r\n        if ((now - lastAt) < 40) return; \r\n        lastAt = now;\r\n    }\r\n    \r\n    // Use shared audio manager\r\n    playAudio(src, { \r\n        volume: COIN_VOLUME\r\n    });\r\n  }\r\n\r\n  function animateAndRemove(el, opts = {}){\r\n    // Notify spawner that this coin is \"taken\" so physics stops\r\n    if (spawner && typeof spawner.detachCoin === 'function') {\r\n        spawner.detachCoin(el);\r\n    }\r\n\r\n    const recycle = () => {\r\n        if (!el) return;\r\n        if (spawner && typeof spawner.recycleCoin === 'function') {\r\n            spawner.recycleCoin(el);\r\n        } else {\r\n            el.remove();\r\n        }\r\n    };\r\n\r\n    if (disableAnimation || IS_MOBILE) {\r\n        recycle();\r\n        return; \r\n    }\r\n    \r\n    let start = 'translate3d(0,0,0)';\r\n    if (opts.transform) {\r\n        if (opts.transform !== 'none') start = opts.transform;\r\n    } else {\r\n        // Fallback if no transform passed (shouldn't happen with new logic)\r\n        start = el.style.transform || 'translate3d(0,0,0)';\r\n    }\r\n\r\n    el.style.setProperty('--ccc-start', start);\r\n    el.classList.add('coin--collected');\r\n    \r\n    let complete = false;\r\n    const done = () => { \r\n        if (complete) return;\r\n        complete = true;\r\n        el.removeEventListener('animationend', done); \r\n        recycle();\r\n    };\r\n    el.addEventListener('animationend', done);\r\n    setTimeout(done, 600);\r\n  }\r\n\r\n  function collectBatch(items) {\r\n    if (!items || !items.length) return;\r\n    \r\n    // Find best sound and max size in batch\r\n    let bestSoundSrc = resolvedSrc;\r\n    let maxSizeIndex = -1;\r\n    let foundSound = false;\r\n\r\n    for (const item of items) {\r\n        const coinObj = item.coin || (item.el && item.el._coinObj);\r\n        if (coinObj) {\r\n            if (coinObj.sizeIndex !== undefined) {\r\n                if (coinObj.sizeIndex > maxSizeIndex) {\r\n                    maxSizeIndex = coinObj.sizeIndex;\r\n                    if (coinObj.soundSrc) {\r\n                        bestSoundSrc = coinObj.soundSrc;\r\n                        foundSound = true;\r\n                    }\r\n                }\r\n            } else if (coinObj.soundSrc && !foundSound) {\r\n                bestSoundSrc = coinObj.soundSrc;\r\n                foundSound = true;\r\n            }\r\n        }\r\n    }\r\n\r\n    playSound(bestSoundSrc);\r\n\r\n    let totalCoin = null;\r\n    let totalXp = null;\r\n    let totalMp = null;\r\n    let collectedCount = 0;\r\n\r\n    const coinsLocked = isCurrencyLocked(CURRENCIES.COINS);\r\n    const xpEnabled = typeof isXpSystemUnlocked === 'function' ? isXpSystemUnlocked() : true;\r\n    const mutEnabled = typeof isMutationUnlocked === 'function' && isMutationUnlocked();\r\n\r\n    const MAX_VISUALS = 15;\r\n    let visualCount = 0;\r\n\r\n    for (const item of items) {\r\n      let el = item.el;\r\n      let coinObj = item.coin;\r\n      \r\n      if (!coinObj && el && el._coinObj) coinObj = el._coinObj;\r\n      if (el && !isCoin(el)) continue;\r\n      if (coinObj && coinObj.isRemoved) continue;\r\n\r\n      collectedCount++;\r\n      if (el) el.dataset.collected = '1';\r\n\r\n      if (visualCount < MAX_VISUALS) {\r\n           if (!el && coinObj && spawner && spawner.ensureCoinVisual) {\r\n               el = spawner.ensureCoinVisual(coinObj);\r\n               if (el) el.dataset.collected = '1';\r\n           }\r\n           if (el) {\r\n               animateAndRemove(el, item.opts || {});\r\n               visualCount++;\r\n           } else {\r\n               if (coinObj && spawner && spawner.removeCoinTarget) spawner.removeCoinTarget(coinObj);\r\n           }\r\n      } else {\r\n           if (coinObj && spawner && spawner.removeCoinTarget) {\r\n               spawner.removeCoinTarget(coinObj);\r\n           } else if (el) {\r\n               if (spawner && spawner.detachCoin) spawner.detachCoin(el);\r\n               if (spawner && spawner.recycleCoin) spawner.recycleCoin(el);\r\n               else el.remove();\r\n           }\r\n      }\r\n\r\n      const base = el ? resolveCoinBase(el) : BASE_COIN_VALUE;\r\n      const spawnLevelStr = coinObj?.mutationLevel ?? (el?.dataset?.mutationLevel || null);\r\n      \r\n      let inc = applyCoinMultiplier(base);\r\n      let xpInc = cloneBn(XP_PER_COIN);\r\n      let mpInc = cloneBn(mpValueMultiplierBn);\r\n\r\n      // SURGE 2: Value Multiplier\r\n      if (coinObj && coinObj.valueMultiplier && coinObj.valueMultiplier > 1) {\r\n          try {\r\n             inc = inc.mulDecimalFloor(coinObj.valueMultiplier);\r\n          } catch {}\r\n          try {\r\n             xpInc = xpInc.mulDecimalFloor(coinObj.valueMultiplier);\r\n          } catch {}\r\n          try {\r\n             mpInc = mpInc.mulDecimalFloor(coinObj.valueMultiplier);\r\n          } catch {}\r\n      }\r\n\r\n      const mutationMultiplier = computeMutationMultiplier(spawnLevelStr);\r\n      if (mutationMultiplier) {\r\n        try { inc = inc.mulBigNumInteger(mutationMultiplier); } catch {}\r\n        try { xpInc = xpInc.mulBigNumInteger(mutationMultiplier); } catch {}\r\n      }\r\n      \r\n      if (!coinsLocked) {\r\n         totalCoin = mergeGain(totalCoin, inc);\r\n      }\r\n      if (xpEnabled) {\r\n         totalXp = mergeGain(totalXp, xpInc);\r\n      }\r\n      if (mutEnabled) {\r\n         totalMp = mergeGain(totalMp, mpInc);\r\n      }\r\n    }\r\n\r\n    if (collectedCount === 0) return;\r\n\r\n    onCoinCollected();\r\n\r\n    if (totalCoin && !totalCoin.isZero?.()) {\r\n      try {\r\n        coinsVal = coinsVal?.add ? coinsVal.add(totalCoin) : cloneBn(totalCoin);\r\n      } catch {\r\n        coinsVal = cloneBn(totalCoin);\r\n      }\r\n      queueCoinGain(totalCoin);\r\n      scheduleHudUpdate();\r\n    }\r\n    \r\n    if (totalXp && !totalXp.isZero?.()) {\r\n      queueXpGain(totalXp);\r\n    }\r\n    \r\n    if (totalMp && !totalMp.isZero?.()) {\r\n      queueMutationGain(totalMp);\r\n    }\r\n\r\n    if (localStorage.getItem(SHOP_UNLOCK_KEY) !== '1') {\r\n      const current = parseInt(localStorage.getItem(SHOP_PROGRESS_KEY) || '0', 10);\r\n      const next = current + collectedCount;\r\n      localStorage.setItem(SHOP_PROGRESS_KEY, String(next));\r\n      if (next >= 10) {\r\n        try { unlockShop(); } catch {}\r\n        localStorage.setItem(SHOP_UNLOCK_KEY, '1');\r\n      }\r\n    }\r\n  }\r\n\r\n  function collect(el, opts = {}) {\r\n    collectBatch([{ el, opts }]);\r\n    return true;\r\n  }\r\n\r\n  magnetController = createMagnetController({\r\n    playfield: pf,\r\n    coinsLayer: cl,\r\n    coinSelector,\r\n    collectFn: collect,\r\n    collectBatchFn: collectBatch,\r\n    spawner, // Pass spawner for optimized lookup\r\n  });\r\n  \r\n    cursorTrail = createCursorTrail(pf);\r\n\r\n  const onDelegatedInteract = (e) => {\r\n    if (e.target === cl) return;\r\n    const target = e.target.closest(coinSelector);\r\n    if (target && isCoin(target)) {\r\n      let opts = {};\r\n      if (spawner && typeof spawner.getCoinTransform === 'function') {\r\n          opts.transform = spawner.getCoinTransform(target);\r\n      }\r\n      collect(target, opts);\r\n    }\r\n  };\r\n\r\n  cl.addEventListener('pointerdown', onDelegatedInteract, { passive: true });\r\n  if (!IS_MOBILE) {\r\n    cl.addEventListener('mouseover', onDelegatedInteract, { passive: true });\r\n  }\r\n\r\n  const BRUSH_R = 25; // Slightly larger for single check\r\n  let cachedPfRect = null;\r\n  const updateCachedRect = () => {\r\n      // Optimization: Assume playfield fills viewport\r\n      const w = document.documentElement.clientWidth;\r\n      const h = document.documentElement.clientHeight;\r\n      cachedPfRect = { left: 0, top: 0, width: w, height: h, right: w, bottom: h, x: 0, y: 0 };\r\n  };\r\n  window.addEventListener('resize', updateCachedRect);\r\n  window.addEventListener('scroll', updateCachedRect, { passive: true });\r\n  updateCachedRect();\r\n\r\n  let lastBrushLocalX = null;\r\n  let lastBrushLocalY = null;\r\n\r\n  const resetBrushHistory = () => {\r\n      lastBrushLocalX = null;\r\n      lastBrushLocalY = null;\r\n  };\r\n\r\n  // Reset brush history on leave/enter/blur\r\n  pf.addEventListener('pointerleave', resetBrushHistory, { passive: true });\r\n  pf.addEventListener('pointerenter', resetBrushHistory, { passive: true });\r\n  window.addEventListener('blur', resetBrushHistory, { passive: true });\r\n\r\n  function brushAt(x,y){\r\n    if (spawner && typeof spawner.findCoinTargetsInRadius === 'function') {\r\n        if (!cachedPfRect) updateCachedRect();\r\n        const localX = x;\r\n        const localY = y;\r\n        \r\n        let candidates = [];\r\n        // Use visual hitbox = true for cursor interaction\r\n        if (typeof spawner.findCoinTargetsInPath === 'function' && lastBrushLocalX !== null && lastBrushLocalY !== null) {\r\n            candidates = spawner.findCoinTargetsInPath(lastBrushLocalX, lastBrushLocalY, localX, localY, BRUSH_R, true);\r\n        } else {\r\n            candidates = spawner.findCoinTargetsInRadius(localX, localY, BRUSH_R, true);\r\n        }\r\n        \r\n        lastBrushLocalX = localX;\r\n        lastBrushLocalY = localY;\r\n\r\n        if (candidates && candidates.length > 0) {\r\n            const items = [];\r\n            for (let i = 0; i < candidates.length; i++) {\r\n                const c = candidates[i];\r\n                const item = { coin: c };\r\n                if (c.el && spawner.getCoinTransform) {\r\n                    item.opts = { transform: spawner.getCoinTransform(c.el) };\r\n                }\r\n                items.push(item);\r\n            }\r\n            collectBatch(items);\r\n        }\r\n    } else if (spawner && typeof spawner.findCoinsInRadius === 'function') {\r\n        if (!cachedPfRect) updateCachedRect();\r\n        const localX = x; const localY = y;\r\n        const candidates = spawner.findCoinsInRadius(localX, localY, BRUSH_R);\r\n        lastBrushLocalX = localX; lastBrushLocalY = localY;\r\n        if (candidates && candidates.length > 0) {\r\n            const items = [];\r\n            for(const el of candidates) {\r\n                const t = spawner.getCoinTransform ? spawner.getCoinTransform(el) : el.style.transform;\r\n                items.push({ el, opts: { transform: t } });\r\n            }\r\n            collectBatch(items);\r\n        }\r\n    } else {\r\n        // Fallback: Legacy slow method (forced sync layout)\r\n        const OFF = [[0,0],[18,0],[-18,0],[0,18],[0,-18]];\r\n        const found = new Set();\r\n        for (let k=0;k<OFF.length;k++){\r\n          const px = x + OFF[k][0], py = y + OFF[k][1];\r\n          const stack = document.elementsFromPoint(px, py);\r\n          for (let i=0;i<stack.length;i++){\r\n            const el = stack[i];\r\n            if (isCoin(el) && !found.has(el)) { found.add(el); }\r\n          }\r\n        }\r\n        if (found.size > 0) {\r\n            const items = [];\r\n            found.forEach(el => items.push({ el }));\r\n            collectBatch(items);\r\n        }\r\n    }\r\n  }\r\n\r\n  let pending = null, brushScheduled = false;\r\n  function scheduleBrush(x,y){\r\n    pending = {x,y};\r\n    if (!brushScheduled){\r\n      brushScheduled = true;\r\n      requestAnimationFrame(() => {\r\n        if (pending){ brushAt(pending.x, pending.y); pending = null; }\r\n        brushScheduled = false;\r\n      });\r\n    }\r\n  }\r\n\r\n  pf.addEventListener('pointerdown', (e) => { scheduleBrush(e.clientX, e.clientY); }, { passive: true });\r\n  pf.addEventListener('pointermove', (e) => { if (e.pointerType !== 'mouse') scheduleBrush(e.clientX, e.clientY); }, { passive: true });\r\n  pf.addEventListener('pointerup',   (e) => { if (e.pointerType !== 'mouse') scheduleBrush(e.clientX, e.clientY); }, { passive: true });\r\n  pf.addEventListener('mousemove', (e) => { scheduleBrush(e.clientX, e.clientY); }, { passive: true });\r\n\r\n  function setMobileVolume(v){\r\n    // Mobile volume handled externally or ignored for now\r\n  }\r\n\r\n  // Periodically update bounds to sync with any layout shifts\r\n  const rectInterval = setInterval(updateCachedRect, 1000);\r\n\r\n  const destroy = () => {\r\n    clearInterval(rectInterval);\r\n    flushPendingGains();\r\n    updateHudFn = () => {};\r\n    if (typeof window !== 'undefined') {\r\n      window.removeEventListener('resize', updateCachedRect);\r\n      window.removeEventListener('beforeunload', flushPendingGains);\r\n      window.removeEventListener('currency:multiplier', onCoinMultiplierChange);\r\n      window.removeEventListener('currency:change', onCurrencyChange);\r\n      window.removeEventListener('blur', resetBrushHistory);\r\n    }\r\n    if (typeof mutationUnsub === 'function') {\r\n      try { mutationUnsub(); } catch {}\r\n      mutationUnsub = null;\r\n    }\r\n    if (magnetController?.destroy) {\r\n      try { magnetController.destroy(); } catch {}\r\n      magnetController = null;\r\n    }\r\n    if (cursorTrail?.destroy) {\r\n      try { cursorTrail.destroy(); } catch {}\r\n      cursorTrail = null;\r\n    }\r\n    try {\r\n      cl.removeEventListener('pointerdown', onDelegatedInteract);\r\n      if (!IS_MOBILE) {\r\n        cl.removeEventListener('mouseover', onDelegatedInteract);\r\n      }\r\n    } catch {}\r\n    try { ['pointerdown','pointermove','pointerup','mousemove'].forEach(evt => pf.replaceWith(pf.cloneNode(true))); } catch {}\r\n  };\r\n\r\n  coinPickup = { destroy };\r\n\r\n  return {\r\n    get count(){ return coinsVal; },\r\n    set count(v){\r\n      coinsVal = BigNum.fromAny ? BigNum.fromAny(v) : BigNum.fromInt(Number(v) || 0);\r\n      scheduleHudUpdate();\r\n    },\r\n    setMobileVolume,\r\n    destroy,\r\n    collectBatch,\r\n    getMagnetUnitPx: computeMagnetUnitPx,\r\n  };\r\n}\r\n", "export const getSurge9Description = (slot) => {\r\n  const state = getSurge9State(slot);\r\n  if (state === 0) return \"This milestone is hidden for now\";\r\n  if (state === 1) return \"This milestone is hidden until you research Lab Node 4\";\r\n  return \"Significantly boosts DNA gained from the Experiment reset\";\r\n};\r\n\r\nexport const getSurge10Description = (slot) => {\r\n  const state = getSurge10State(slot);\r\n  if (state === 0) return \"This milestone is hidden until you research Lab Node 4\";\r\n  return \"Unlocks new DNA upgrades\";\r\n};\r\n\r\nimport { formatNumber, formatMultForUi } from '../util/numFormat.js';\r\nimport { BigNum } from '../util/bigNum.js';\r\nimport { bigNumFromLog10, approxLog10BigNum } from '../util/bigNum.js';\r\nimport { getTsunamiNerf, getEffectiveTsunamiNerf, getSurge15Multiplier, getSurge15Divisor } from './surgeEffects.js';\r\nimport { getTsunamiResearchBonus, getResearchNodeLevel } from './labNodes.js';\r\nimport { getActiveSlot } from '../util/storage.js';\r\n\r\nexport const SURGE_MILESTONES = [\r\n  {\r\n    id: 1,\r\n    surgeLevel: 1,\r\n    affectedByTsunami: true,\r\n    description: [\r\n      \"Multiplies Coin, XP, and MP value by <span style=\\\"color:#00e5ff\\\">10x</span>\",\r\n      \"Unlocks the Warp tab\"\r\n    ]\r\n  },\r\n  {\r\n    id: 2,\r\n    surgeLevel: 2,\r\n    affectedByTsunami: true,\r\n    description: [\r\n      \"Allows some Coins to spawn with a larger size, yielding collection multipliers; the largest Coins won't despawn even when others do\",\r\n      \"Improves Effective Auto-Collect by <span style=\\\"color:#00e5ff\\\">10x</span>\"\r\n    ]\r\n  },\r\n  {\r\n    id: 3,\r\n    surgeLevel: 3,\r\n    affectedByTsunami: true,\r\n    description: [\r\n      \"Generates Books based on XP Level instead of earning a flat amount of Books on level up\",\r\n      \"Unlocks a new Book upgrade\"\r\n    ]\r\n  },\r\n  {\r\n    id: 4,\r\n    surgeLevel: 4,\r\n    affectedByTsunami: true,\r\n    description: [\r\n      `Multiplies MP value by <span style=\"color:#00e5ff\">${formatNumber(BigNum.fromInt(4.444e12))}x</span>`\r\n    ]\r\n  },\r\n    {\r\n    id: 5,\r\n    surgeLevel: 5,\r\n    description: [\r\n      \"Unlocks a new Gold upgrade\"\r\n    ]\r\n  },\r\n  {\r\n    id: 6,\r\n    surgeLevel: 6,\r\n    affectedByTsunami: true,\r\n    description: [\r\n      \"Unspent Coins boost Coins\",\r\n      \"Unspent Books boost Coins\",\r\n      \"Unspent Gold boosts Coins\",\r\n      \"Unspent Magic boosts Coins\"\r\n    ]\r\n  },\r\n  {\r\n    id: 7,\r\n    surgeLevel: 7,\r\n    description: [\r\n      \"Unlocks a new Magic upgrade\",\r\n      \"Makes each Workshop Level triple Gear production instead of doubling it\"\r\n    ]\r\n  },\r\n  {\r\n    id: 8,\r\n    surgeLevel: 8,\r\n    description: [\r\n      \"Invokes the Tsunami\"\r\n    ]\r\n  },\r\n  {\r\n    id: 9,\r\n    surgeLevel: 9,\r\n    affectedByTsunami: true,\r\n    description: [\r\n      \"Significantly boosts DNA gained from the Experiment reset\"\r\n    ]\r\n  },\r\n  {\r\n    id: 10,\r\n    surgeLevel: 10,\r\n    description: [\r\n      \"Unlocks new DNA upgrades\"\r\n    ]\r\n  },\r\n  {\r\n    id: 11,\r\n    surgeLevel: 11,\r\n    description: [\r\n      \"Unlocks a new automation upgrade\",\r\n      \"Makes each Workshop Level quadruple Gear production instead of tripling it\"\r\n    ]\r\n  },\r\n  {\r\n    id: 12,\r\n    surgeLevel: 12,\r\n    affectedByTsunami: true,\r\n    description: [\r\n      \"Adequately boosts the effect Lab Level has on RP multiplier\"\r\n    ]\r\n  },\r\n  {\r\n    id: 13,\r\n    surgeLevel: 13,\r\n    affectedByTsunami: true,\r\n    description: [\r\n      \"Activates generator: Passively generates <span style=\\\"color:#00e5ff\\\">0.1%</span> of pending Gold every second\"\r\n    ]\r\n  },\r\n  {\r\n    id: 14,\r\n    surgeLevel: 14,\r\n    affectedByTsunami: true,\r\n    description: [\r\n      `Multiplies DNA value by <span style=\"color:#00e5ff\">${formatNumber(BigNum.fromInt(14.14e18))}x</span>`,\r\n      \"Unlocks Combo: Collecting Coins increases a Combo which alleviates the exponent effect on larger Coins (beware, Combo decays)\",\r\n      \"Combo effect is shown in the Coin Counter\"\r\n    ]\r\n  },\r\n  {\r\n    id: 15,\r\n    surgeLevel: 15,\r\n    affectedByTsunami: true,\r\n    description: [\r\n      \"Unspent DNA boosts Coins: <span style=\\\"color:#00e5ff\\\">1x</span>\"\r\n    ]\r\n  },\r\n  {\r\n    id: 16,\r\n    surgeLevel: 16,\r\n    affectedByTsunami: true,\r\n    description: [\r\n      \"Activates generator: Passively generates <span style=\\\"color:#00e5ff\\\">0.1%</span> of pending Magic every second\"\r\n    ]\r\n  },\r\n  {\r\n    id: 17,\r\n    surgeLevel: 17,\r\n    affectedByTsunami: true,\r\n    description: [\r\n      `Multiplies Magic value by <span style=\"color:#00e5ff\">${formatNumber(BigNum.fromInt(1e15))}x</span>`,\r\n      `Divides Coin value by <span style=\"color:#00e5ff\">${formatNumber(BigNum.fromInt(1e5))}x</span>`,\r\n      `Divides DNA value by <span style=\"color:#00e5ff\">${formatNumber(BigNum.fromInt(1e5))}x</span>`,\r\n      \"Halves Wave value (immune to exponent)\"\r\n    ]\r\n  },\r\n  {\r\n    id: 18,\r\n    surgeLevel: 18,\r\n    affectedByTsunami: true,\r\n    description: [\r\n      `Multiplies Coin value by <span style=\"color:#00e5ff\">${formatNumber(BigNum.fromInt(1e15))}x</span>`,\r\n      `Divides Magic value by <span style=\"color:#00e5ff\">${formatNumber(BigNum.fromInt(1e5))}x</span>`,\r\n      `Divides DNA value by <span style=\"color:#00e5ff\">${formatNumber(BigNum.fromInt(1e5))}x</span>`,\r\n      \"Halves Wave value (immune to exponent)\"\r\n    ]\r\n  },\r\n  {\r\n    id: 19,\r\n    surgeLevel: 19,\r\n    description: [\r\n      \"Unlocks a new DNA upgrade\",\r\n      \"Doubles XP value (immune to exponent)\"\r\n    ]\r\n  }\r\n];\r\n\r\nexport const NERFED_SURGE_MILESTONE_IDS = SURGE_MILESTONES\r\n    .filter(m => m.affectedByTsunami)\r\n    .map(m => m.id);\r\n\r\nconst SURGE_9_STATE_KEY = (slot) => `ccc:surge:milestone9:state:${slot}`;\r\nconst SURGE_10_STATE_KEY = (slot) => `ccc:surge:milestone10:state:${slot}`;\r\nconst SURGE_14_STATE_KEY = (slot) => `ccc:surge:milestone14:state:${slot}`;\r\nconst SURGE_15_STATE_KEY = (slot) => `ccc:surge:milestone15:state:${slot}`;\r\n\r\nfunction getSurge9State(slot) {\r\n    if (slot == null) return 0;\r\n    try {\r\n        const val = localStorage.getItem(SURGE_9_STATE_KEY(slot));\r\n        return val ? parseInt(val, 10) : 0;\r\n    } catch {\r\n        return 0;\r\n    }\r\n}\r\n\r\nfunction saveSurge9State(slot, state) {\r\n    if (slot == null) return;\r\n    try {\r\n        localStorage.setItem(SURGE_9_STATE_KEY(slot), state.toString());\r\n    } catch {}\r\n}\r\n\r\nfunction getSurge10State(slot) {\r\n    if (slot == null) return 0;\r\n    try {\r\n        const val = localStorage.getItem(SURGE_10_STATE_KEY(slot));\r\n        return val ? parseInt(val, 10) : 0;\r\n    } catch {\r\n        return 0;\r\n    }\r\n}\r\n\r\nfunction saveSurge10State(slot, state) {\r\n    if (slot == null) return;\r\n    try {\r\n        localStorage.setItem(SURGE_10_STATE_KEY(slot), state.toString());\r\n    } catch {}\r\n}\r\n\r\nfunction getSurge14State(slot) {\r\n    if (slot == null) return 0;\r\n    try {\r\n        const val = localStorage.getItem(SURGE_14_STATE_KEY(slot));\r\n        return val ? parseInt(val, 10) : 0;\r\n    } catch {\r\n        return 0;\r\n    }\r\n}\r\n\r\nfunction saveSurge14State(slot, state) {\r\n    if (slot == null) return;\r\n    try {\r\n        localStorage.setItem(SURGE_14_STATE_KEY(slot), state.toString());\r\n    } catch {}\r\n}\r\n\r\nfunction getSurge15State(slot) {\r\n    if (slot == null) return 0;\r\n    try {\r\n        const val = localStorage.getItem(SURGE_15_STATE_KEY(slot));\r\n        return val ? parseInt(val, 10) : 0;\r\n    } catch {\r\n        return 0;\r\n    }\r\n}\r\n\r\nfunction saveSurge15State(slot, state) {\r\n    if (slot == null) return;\r\n    try {\r\n        localStorage.setItem(SURGE_15_STATE_KEY(slot), state.toString());\r\n    } catch {}\r\n}\r\n\r\nexport function getVisibleMilestones(currentSurgeLevel) {\r\n  let currentLevel = 0;\r\n  let isSurge8 = false;\r\n  \r\n  if (typeof currentSurgeLevel === 'number') {\r\n    currentLevel = currentSurgeLevel;\r\n    if (currentLevel >= 8) isSurge8 = true;\r\n  } else if (typeof currentSurgeLevel === 'bigint') {\r\n    if (currentSurgeLevel > Number.MAX_SAFE_INTEGER) {\r\n      currentLevel = Number.MAX_SAFE_INTEGER;\r\n    } else {\r\n      currentLevel = Number(currentSurgeLevel);\r\n    }\r\n    if (currentSurgeLevel >= 8n) isSurge8 = true;\r\n  } else if (currentSurgeLevel === Infinity) {\r\n      currentLevel = Infinity;\r\n      isSurge8 = true;\r\n  } else if (currentSurgeLevel && typeof currentSurgeLevel.toString === 'function') {\r\n      try {\r\n          const val = Number(currentSurgeLevel.toString());\r\n          if (!isNaN(val)) currentLevel = val;\r\n          if (currentSurgeLevel === 'Infinity' || val === Infinity) {\r\n              isSurge8 = true;\r\n          }\r\n      } catch {}\r\n  }\r\n\r\n  // --- Surge 9 Text Logic ---\r\n  const slot = getActiveSlot();\r\n  let s9State = getSurge9State(slot);\r\n  let newState = s9State;\r\n\r\n  if (newState < 1) {\r\n      if (isSurge8) newState = 1;\r\n  }\r\n  \r\n  if (newState < 2) {\r\n      const lab4Level = getResearchNodeLevel(4);\r\n      if (lab4Level >= 1) newState = 2;\r\n  }\r\n  \r\n  if (newState !== s9State) {\r\n      s9State = newState;\r\n      saveSurge9State(slot, s9State);\r\n  }\r\n  // -------------------------\r\n\r\n  // --- Surge 10 Text Logic ---\r\n  let s10State = getSurge10State(slot);\r\n  let newS10State = s10State;\r\n\r\n  if (newS10State < 1) {\r\n      const lab4Level = getResearchNodeLevel(4);\r\n      if (lab4Level >= 1) newS10State = 1;\r\n  }\r\n\r\n  if (newS10State !== s10State) {\r\n      s10State = newS10State;\r\n      saveSurge10State(slot, s10State);\r\n  }\r\n  // -------------------------\r\n\r\n  // --- Surge 14 Text Logic ---\r\n  let s14State = getSurge14State(slot);\r\n  let newS14State = s14State;\r\n\r\n  if (newS14State < 1) {\r\n      const lab4Level = getResearchNodeLevel(4);\r\n      if (lab4Level >= 1) newS14State = 1;\r\n  }\r\n\r\n  if (newS14State !== s14State) {\r\n      s14State = newS14State;\r\n      saveSurge14State(slot, s14State);\r\n  }\r\n  // -------------------------\r\n\r\n  // --- Surge 15 Text Logic ---\r\n  let s15State = getSurge15State(slot);\r\n  let newS15State = s15State;\r\n\r\n  if (newS15State < 1) {\r\n      const lab4Level = getResearchNodeLevel(4);\r\n      if (lab4Level >= 1) newS15State = 1;\r\n  }\r\n\r\n  if (newS15State !== s15State) {\r\n      s15State = newS15State;\r\n      saveSurge15State(slot, s15State);\r\n  }\r\n  // -------------------------\r\n  \r\n  const reached = [];\r\n  const future = [];\r\n  \r\n  for (const m of SURGE_MILESTONES) {\r\n    let milestone = m;\r\n    \r\n    if (isSurge8) {\r\n      // Clone milestone to avoid mutating the original\r\n      milestone = { ...m, description: [...m.description] };\r\n      \r\n      const baseNerf = getTsunamiNerf();\r\n      const bonus = getTsunamiResearchBonus();\r\n      let nerf = baseNerf + bonus;\r\n      if (nerf > 1) nerf = 1;\r\n      \r\n      if (m.id === 1) {\r\n        const val = Math.pow(10, nerf);\r\n        const valStr = formatMultForUi(val);\r\n        \r\n        milestone.description[0] = milestone.description[0].replace(\r\n            /<span style=\"color:#00e5ff\">.*?x<\\/span>/, \r\n            `<span style=\"color:#00e5ff\">${valStr}x</span>`\r\n        );\r\n      } else if (m.id === 2) {\r\n        const val = Math.pow(10, nerf);\r\n        const valStr = formatMultForUi(val);\r\n\r\n        milestone.description[1] = milestone.description[1].replace(\r\n            /<span style=\"color:#00e5ff\">.*?x<\\/span>/, \r\n            `<span style=\"color:#00e5ff\">${valStr}x</span>`\r\n        );\r\n\r\n      } else if (m.id === 4) {\r\n        const log10 = Math.log10(4.444e12);\r\n        const newVal = bigNumFromLog10(log10 * nerf);\r\n        const valStr = formatNumber(newVal);\r\n        \r\n        milestone.description[0] = milestone.description[0].replace(\r\n            /<span style=\"color:#00e5ff\">.*?x<\\/span>/, \r\n            `<span style=\"color:#00e5ff\">${valStr}x</span>`\r\n        );\r\n      } else if (m.id === 14) {\r\n        const log10 = Math.log10(14.14e18);\r\n        const newVal = bigNumFromLog10(log10 * nerf);\r\n        const valStr = formatNumber(newVal);\r\n        \r\n        milestone.description[0] = milestone.description[0].replace(\r\n            /<span style=\"color:#00e5ff\">.*?x<\\/span>/, \r\n            `<span style=\"color:#00e5ff\">${valStr}x</span>`\r\n        );\r\n      } else if (m.id === 17) {\r\n        const logMult = 15;\r\n        const logDiv = 5;\r\n        \r\n        const newMult = bigNumFromLog10(logMult * nerf);\r\n        const newDiv = bigNumFromLog10(logDiv * nerf);\r\n        \r\n        const multStr = formatNumber(newMult);\r\n        const divStr = formatNumber(newDiv);\r\n        \r\n        milestone.description[0] = milestone.description[0].replace(\r\n            /<span style=\"color:#00e5ff\">.*?<\\/span>/, \r\n            `<span style=\"color:#00e5ff\">${multStr}x</span>`\r\n        );\r\n        milestone.description[1] = milestone.description[1].replace(\r\n            /<span style=\"color:#00e5ff\">.*?<\\/span>/, \r\n            `<span style=\"color:#00e5ff\">${divStr}x</span>`\r\n        );\r\n        milestone.description[2] = milestone.description[2].replace(\r\n            /<span style=\"color:#00e5ff\">.*?<\\/span>/, \r\n            `<span style=\"color:#00e5ff\">${divStr}x</span>`\r\n        );\r\n      } else if (m.id === 18) {\r\n        const logMult = 15;\r\n        const logDiv = 5;\r\n        \r\n        const newMult = bigNumFromLog10(logMult * nerf);\r\n        const newDiv = bigNumFromLog10(logDiv * nerf);\r\n        \r\n        const multStr = formatNumber(newMult);\r\n        const divStr = formatNumber(newDiv);\r\n        \r\n        milestone.description[0] = milestone.description[0].replace(\r\n            /<span style=\"color:#00e5ff\">.*?<\\/span>/, \r\n            `<span style=\"color:#00e5ff\">${multStr}x</span>`\r\n        );\r\n        milestone.description[1] = milestone.description[1].replace(\r\n            /<span style=\"color:#00e5ff\">.*?<\\/span>/, \r\n            `<span style=\"color:#00e5ff\">${divStr}x</span>`\r\n        );\r\n        milestone.description[2] = milestone.description[2].replace(\r\n            /<span style=\"color:#00e5ff\">.*?<\\/span>/, \r\n            `<span style=\"color:#00e5ff\">${divStr}x</span>`\r\n        );\r\n      }\r\n    }\r\n\r\n    if (m.id === 9) {\r\n        if (milestone === m) {\r\n            milestone = { ...m, description: [...m.description] };\r\n        }\r\n        \r\n        if (s9State === 0) {\r\n            milestone.description = [\"This milestone is hidden for now\"];\r\n        } else if (s9State === 1) {\r\n            milestone.description = [\"This milestone is hidden until you research Lab Node 4\"];\r\n        }\r\n    }\r\n\r\n    if (m.id === 10) {\r\n        if (milestone === m) {\r\n            milestone = { ...m, description: [...m.description] };\r\n        }\r\n        \r\n        if (s10State === 0) {\r\n            milestone.description = [\"This milestone is hidden until you research Lab Node 4\"];\r\n        }\r\n    }\r\n\r\n    if (m.id === 13) {\r\n      if (milestone === m) {\r\n          milestone = { ...m, description: [...m.description] };\r\n      }\r\n      \r\n      const effectiveNerf = getEffectiveTsunamiNerf();\r\n      const mapped = effectiveNerf * 1.5 - 0.5;\r\n      const pct = Math.pow(100, mapped);\r\n      const valStr = formatMultForUi(pct);\r\n\r\n      milestone.description[0] = `Activates generator: Passively generates <span style=\"color:#00e5ff\">${valStr}%</span> of pending Gold every second`;\r\n    }\r\n\r\n    if (m.id === 14) {\r\n        if (milestone === m) {\r\n            milestone = { ...m, description: [...m.description] };\r\n        }\r\n        \r\n        if (s14State === 0) {\r\n            milestone.description = [\"This milestone is hidden until you research Lab Node 4\"];\r\n        }\r\n    }\r\n    \r\n    if (m.id === 15) {\r\n        if (milestone === m) {\r\n            milestone = { ...m, description: [...m.description] };\r\n        }\r\n        \r\n        if (s15State === 0) {\r\n            milestone.description = [\"This milestone is hidden until you research Lab Node 4\"];\r\n        } else {\r\n            const mult = getSurge15Multiplier(true);\r\n            const valStr = formatMultForUi(mult);\r\n            milestone.description[0] = `Unspent DNA boosts Coins: <span style=\"color:#00e5ff\">${valStr}x</span>`;\r\n\r\n            const div = getSurge15Divisor(true);\r\n            const divStr = formatMultForUi(div);\r\n            milestone.description.push(`Unspent DNA also divides the value of Coins and the value of Magic by <span style=\"color:#00e5ff\">${divStr}x</span>`);\r\n        }\r\n    }\r\n\r\n    if (m.id === 16) {\r\n      if (milestone === m) {\r\n          milestone = { ...m, description: [...m.description] };\r\n      }\r\n      \r\n      const effectiveNerf = getEffectiveTsunamiNerf();\r\n      const mapped = effectiveNerf * 1.5 - 0.5;\r\n      const pct = Math.pow(100, mapped);\r\n      const valStr = formatMultForUi(pct);\r\n\r\n      milestone.description[0] = `Activates generator: Passively generates <span style=\"color:#00e5ff\">${valStr}%</span> of pending Magic every second`;\r\n    }\r\n\r\n    if (m.surgeLevel <= currentLevel) {\r\n      reached.push(milestone);\r\n    } else {\r\n      future.push(milestone);\r\n    }\r\n  }\r\n  \r\n  return [...reached, ...future.slice(0, 2)];\r\n}\r\n", "import { playAudio } from '../util/audioManager.js';\r\n\r\nexport function playTsunamiSequence(container, durationMs, onComplete, options = {}) {\r\n    // Hide cursor initially\r\n    container.style.cursor = 'none';\r\n\r\n    // --- Audio Handles ---\r\n    let ambienceAudio = null;\r\n    let rumbleAudio = null;\r\n    let humAudio = null;\r\n    let explosionAudioTriggered = false;\r\n\r\n    // Start Ambience Immediately (Wind/Storm Buildup)\r\n    ambienceAudio = playAudio('sounds/tsu_storm_ambience.ogg', { volume: 0.8 });\r\n\r\n    // --- BG Canvas (Sky, Sand) ---\r\n    const bgCanvas = document.createElement('canvas');\r\n    bgCanvas.id = 'tsunami-bg-canvas';\r\n    bgCanvas.style.position = 'absolute';\r\n    bgCanvas.style.inset = '0';\r\n    bgCanvas.style.width = '100%';\r\n    bgCanvas.style.height = '100%';\r\n    bgCanvas.style.zIndex = '2147483644'; // Bottom\r\n    container.appendChild(bgCanvas);\r\n\r\n    // --- Overlay UI (XP/MP) ---\r\n    const uiContainer = document.createElement('div');\r\n    uiContainer.id = 'tsunami-ui-container';\r\n    uiContainer.style.position = 'absolute';\r\n    uiContainer.style.inset = '0';\r\n    uiContainer.style.zIndex = '2147483645'; // Middle\r\n    uiContainer.style.pointerEvents = 'none';\r\n    uiContainer.style.color = '#fff';\r\n    uiContainer.style.textShadow = '0 1px 2px rgba(0,0,0,0.8)';\r\n\r\n    // Helper to style wrappers\r\n    function styleWrapper(wrapper, type) {\r\n        wrapper.style.position = 'absolute';\r\n        wrapper.style.left = '50%';\r\n        \r\n        // Flipped upside down (rotateZ 180deg) and tilted back (rotateX 50deg)\r\n        const transformBase = `perspective(600px) rotateX(50deg) rotateZ(180deg)`;\r\n        \r\n        const hasXp = !!options.xpHTML;\r\n        const hasMp = !!options.mpHTML;\r\n\r\n        if (type === 'coin') {\r\n            wrapper.style.top = '77%';\r\n            wrapper.style.transform = `translateX(-50%) ${transformBase}`;\r\n        } else if (hasXp && hasMp) {\r\n            // Both XP and MP: Side-by-side centered\r\n            // Compromise vertical position\r\n            wrapper.style.top = '72.5%';\r\n            if (type === 'mp') {\r\n                // Left side (gap of ~88px total)\r\n                wrapper.style.transform = `translateX(calc(-100% - 44px)) ${transformBase}`;\r\n            } else {\r\n                // Right side (XP)\r\n                wrapper.style.transform = `translateX(44px) ${transformBase}`;\r\n            }\r\n        } else {\r\n            // Single XP or MP\r\n            if (type === 'mp') wrapper.style.top = '66%';\r\n            else if (type === 'xp') wrapper.style.top = '72%';\r\n            wrapper.style.transform = `translateX(-50%) ${transformBase}`;\r\n        }\r\n        \r\n        wrapper.style.transformOrigin = 'center center';\r\n        \r\n        const counter = wrapper.firstElementChild;\r\n        if (counter) {\r\n            counter.removeAttribute('hidden');\r\n            counter.style.display = 'flex';\r\n        }\r\n    }\r\n    \r\n    if (options.coinHTML) {\r\n        const coinWrapper = document.createElement('div');\r\n        coinWrapper.innerHTML = options.coinHTML;\r\n        styleWrapper(coinWrapper, 'coin');\r\n        uiContainer.appendChild(coinWrapper);\r\n    }\r\n    if (options.xpHTML) {\r\n        const xpWrapper = document.createElement('div');\r\n        xpWrapper.innerHTML = options.xpHTML;\r\n        styleWrapper(xpWrapper, 'xp');\r\n        uiContainer.appendChild(xpWrapper);\r\n    }\r\n    if (options.mpHTML) {\r\n        const mpWrapper = document.createElement('div');\r\n        mpWrapper.innerHTML = options.mpHTML;\r\n        styleWrapper(mpWrapper, 'mp');\r\n        uiContainer.appendChild(mpWrapper);\r\n    }\r\n    container.appendChild(uiContainer);\r\n\r\n    // --- FG Canvas (Water, Effects) ---\r\n    const fgCanvas = document.createElement('canvas');\r\n    fgCanvas.id = 'tsunami-fg-canvas';\r\n    fgCanvas.style.position = 'absolute';\r\n    fgCanvas.style.inset = '0';\r\n    fgCanvas.style.width = '100%';\r\n    fgCanvas.style.height = '100%';\r\n    fgCanvas.style.zIndex = '2147483646'; // Top\r\n    fgCanvas.style.pointerEvents = 'none';\r\n    container.appendChild(fgCanvas);\r\n\r\n    // --- Assets ---\r\n    const merchantImg = new Image();\r\n    merchantImg.src = 'img/misc/merchant.webp';\r\n    let merchantLoaded = false;\r\n    merchantImg.onload = () => { \r\n        merchantLoaded = true; \r\n    };\r\n    merchantImg.onerror = (e) => {\r\n        console.error('Tsunami: Merchant load failed', e);\r\n    };\r\n\r\n    // Handle resizing\r\n    let width, height;\r\n    let props = [];\r\n    let sandSpeckles = [];\r\n    let cloudBaseY = 0;\r\n\r\n    function generateProps() {\r\n        props = [];\r\n        sandSpeckles = [];\r\n        const sandY = height * 0.65;\r\n        const d3y = sandY + height * 0.15;\r\n        \r\n        // Merchant Safe Zone\r\n        const merchScale = Math.min(width, height) * 0.0005; \r\n        const merchW = 300 * merchScale;\r\n        const merchX = width * 0.80;\r\n        const merchSafeMin = merchX - (merchW * 0.6);\r\n        const merchSafeMax = merchX + (merchW * 0.6);\r\n\r\n        // Generate static speckles\r\n        for(let i=0; i<100; i++) {\r\n            const sx = Math.random() * width;\r\n            const sy = d3y + Math.random() * (height - d3y);\r\n            sandSpeckles.push({x: sx, y: sy});\r\n        }\r\n        \r\n        const isSafe = (x, y, type) => {\r\n            // HUD Avoidance\r\n            // Center X band (10% to 90%)\r\n            if (x > width * 0.10 && x < width * 0.90) {\r\n                // Main HUD occupies roughly 70% to 85% Y, but lies on a higher z-index.\r\n                // We allow spawning behind the HUD.\r\n                // User requirement: In the middle band, only spawn in the top 15% of the sand.\r\n                // Sand is from sandY to height.\r\n                const sandH = height - sandY;\r\n                const limitY = sandY + (sandH * 0.15);\r\n\r\n                if (y > limitY) return false;\r\n            } else {\r\n                // Outer bands: Only spawn in the top 50% of the sand region\r\n                // Restrict this logic ONLY to trees\r\n                if (type === 'tree') {\r\n                    const sandH = height - sandY;\r\n                    const limitY = sandY + (sandH * 0.50);\r\n                    if (y > limitY) return false;\r\n                }\r\n            }\r\n\r\n            // Merchant Avoidance\r\n            if (type === 'tree' && x > merchSafeMin && x < merchSafeMax) {\r\n                return false;\r\n            }\r\n\r\n            return true;\r\n        };\r\n\r\n        const addProp = (type, count, scaleBase, scaleVar, xFn) => {\r\n            for(let i=0; i<count; i++) {\r\n                let x, y, safe = false;\r\n                let attempts = 0;\r\n                while(!safe && attempts < 50) {\r\n                    if (xFn) {\r\n                        x = xFn();\r\n                    } else {\r\n                        // Standard Uniform Distribution\r\n                        x = Math.random() * width;\r\n                    }\r\n\r\n                    // Spawn anywhere on the sand (sandY to height)\r\n                    // The isSafe function handles the specific restrictions for the middle.\r\n                    const maxY = height; \r\n                    // Bias towards sandY (top) using quadratic curve\r\n                    const r = Math.random();\r\n                    y = sandY + 20 + (r * r) * (maxY - sandY - 20);\r\n                    \r\n                    if (isSafe(x, y, type)) {\r\n                        safe = true;\r\n                        // Distance check for trees to prevent clumping\r\n                        if (type === 'tree') {\r\n                            for (const p of props) {\r\n                                if (p.type === 'tree') {\r\n                                    const dx = p.x - x;\r\n                                    const dy = p.y - y;\r\n                                    const dist = Math.sqrt(dx*dx + dy*dy);\r\n                                    // Ensure decent spacing: larger of 8% width or 100px\r\n                                    if (dist < Math.max(width * 0.08, 100)) { \r\n                                        safe = false;\r\n                                        break;\r\n                                    }\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n                    attempts++;\r\n                }\r\n                if(safe) {\r\n                    // Perspective scaling: items further down (larger y) are closer -> larger\r\n                    const depth = (y - sandY) / (height - sandY); // 0 to 1\r\n                    const perspScale = 0.6 + depth * 0.6; \r\n                    \r\n                    const scale = (scaleBase + Math.random() * scaleVar) * perspScale;\r\n                    props.push({ type, x, y, scale });\r\n                }\r\n            }\r\n        };\r\n\r\n        const outerTreeCount = 3 + Math.floor(Math.random() * 3);\r\n        // Left\r\n        addProp('tree', outerTreeCount, 0.8, 0.4, () => Math.random() * (width * 0.1));\r\n        // Right\r\n        addProp('tree', outerTreeCount, 0.8, 0.4, () => (width * 0.9) + Math.random() * (width * 0.1));\r\n        // Center: Ensure at least 5 trees\r\n        const centerTreeCount = 5 + Math.floor(Math.random() * 3);\r\n        addProp('tree', centerTreeCount, 0.8, 0.4, () => (width * 0.1) + Math.random() * (width * 0.8));\r\n        \r\n        addProp('rock', 20, 0.6, 0.4);\r\n        addProp('shell', 30, 0.3, 0.3);\r\n\r\n        props.sort((a, b) => a.y - b.y);\r\n    }\r\n\r\n    const bgCtx = bgCanvas.getContext('2d', { alpha: false });\r\n    const fgCtx = fgCanvas.getContext('2d', { alpha: true });\r\n\r\n    function resize() {\r\n        const dpr = window.devicePixelRatio || 1;\r\n        width = window.innerWidth;\r\n        height = window.innerHeight;\r\n\r\n        bgCanvas.width = width * dpr;\r\n        bgCanvas.height = height * dpr;\r\n        bgCanvas.style.width = width + 'px';\r\n        bgCanvas.style.height = height + 'px';\r\n\r\n        fgCanvas.width = width * dpr;\r\n        fgCanvas.height = height * dpr;\r\n        fgCanvas.style.width = width + 'px';\r\n        fgCanvas.style.height = height + 'px';\r\n\r\n        bgCtx.scale(dpr, dpr);\r\n        fgCtx.scale(dpr, dpr);\r\n\r\n        generateProps();\r\n        cloudBaseY = -50;\r\n    }\r\n    window.addEventListener('resize', resize);\r\n    resize();\r\n    \r\n    const startTime = Date.now();\r\n    let isRunning = true;\r\n    let animationFrameId;\r\n    let visualsFinished = false;\r\n\r\n    // --- Configuration & State ---\r\n    \r\n    // Palettes for interpolation\r\n    const SUNNY_PALETTE = {\r\n        skyTop: '#4fa8ff',\r\n        skyBottom: '#b8e1ff',\r\n        sun: '#ffeb3b',\r\n        waterDeep: '#005b96',\r\n        waterMid: '#0077be',\r\n        waterPeak: '#005b96',\r\n        foam: '#005b96',\r\n        sandLight: '#f1dcb1',\r\n        sandDark: '#debe7c',\r\n        rock: '#5d4037',\r\n        leaf: '#4caf50',\r\n        shell: '#fff0f5'\r\n    };\r\n\r\n    const STORM_PALETTE = {\r\n        skyTop: '#000510',\r\n        skyBottom: '#000815',\r\n        sun: '#2a2a2a', // Dim/hidden\r\n        waterDeep: '#050e2e', // Menacing deep dark blue\r\n        waterMid: '#08183d',  // Dark navy\r\n        waterPeak: '#102a5c', // Menacing storm blue\r\n        foam: '#102a5c',      // Matches waterPeak (no visible foam)\r\n        sandLight: '#2c2a20', // Dark wet sand\r\n        sandDark: '#1a1810',\r\n        rock: '#1a1a1a',\r\n        leaf: '#1b2e1b',\r\n        shell: '#3b3035'\r\n    };\r\n\r\n    // New State for \"Crazy Stuff\"\r\n    let beaconsActive = false;\r\n    let beacons = [];\r\n    let beaconStartTime = 0;\r\n    let finalFadeActive = false;\r\n    let finalFadeStart = 0;\r\n    let finalFadeDuration = 5000;\r\n    let finalExplosionTriggered = false;\r\n    let flashWhite = 0;\r\n\r\n    const waves = [];\r\n    const layerCount = 6;\r\n    for (let i = 0; i < layerCount; i++) {\r\n        waves.push({\r\n            offset: Math.random() * 1000,\r\n            speedBase: 0.001 + (i * 0.0005),\r\n            amplitudeBase: 10 + (i * 5),\r\n        });\r\n    }\r\n\r\n    const rainParticles = [];\r\n    const maxRain = 400;\r\n\r\n    // --- Helpers ---\r\n    function lerp(start, end, t) {\r\n        return start * (1 - t) + end * t;\r\n    }\r\n\r\n    // Hex to RGB helper for color interpolation\r\n    function hexToRgb(hex) {\r\n        const bigint = parseInt(hex.slice(1), 16);\r\n        return { r: (bigint >> 16) & 255, g: (bigint >> 8) & 255, b: bigint & 255 };\r\n    }\r\n\r\n    function lerpColor(c1, c2, t) {\r\n        const rgb1 = hexToRgb(c1);\r\n        const rgb2 = hexToRgb(c2);\r\n        const r = Math.round(lerp(rgb1.r, rgb2.r, t));\r\n        const g = Math.round(lerp(rgb1.g, rgb2.g, t));\r\n        const b = Math.round(lerp(rgb1.b, rgb2.b, t));\r\n        return `rgb(${r},${g},${b})`;\r\n    }\r\n\r\n    function createBolt(x, y, height) {\r\n        const segments = [];\r\n        let currX = x;\r\n        let currY = y;\r\n        const segmentHeight = 20;\r\n        while (currY < height) {\r\n            const nextX = currX + (Math.random() - 0.5) * 60;\r\n            const nextY = currY + segmentHeight + Math.random() * 30;\r\n            segments.push({ x1: currX, y1: currY, x2: nextX, y2: nextY });\r\n            currX = nextX;\r\n            currY = nextY;\r\n        }\r\n        return segments;\r\n    }\r\n\r\n    function drawRoundedRect(ctx, x, y, width, height, radius) {\r\n        ctx.beginPath();\r\n        ctx.moveTo(x + radius, y);\r\n        ctx.lineTo(x + width - radius, y);\r\n        ctx.quadraticCurveTo(x + width, y, x + width, y + radius);\r\n        ctx.lineTo(x + width, y + height - radius);\r\n        ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);\r\n        ctx.lineTo(x + radius, y + height);\r\n        ctx.quadraticCurveTo(x, y + height, x, y + height - radius);\r\n        ctx.lineTo(x, y + radius);\r\n        ctx.quadraticCurveTo(x, y, x + radius, y);\r\n        ctx.closePath();\r\n    }\r\n\r\n    // --- Procedural Drawing Helpers ---\r\n    function drawPalmTree(ctx, x, y, scale, palette) {\r\n        ctx.save();\r\n        ctx.translate(x, y);\r\n        ctx.scale(scale, scale);\r\n\r\n        // Trunk\r\n        ctx.beginPath();\r\n        ctx.moveTo(0, 0);\r\n        ctx.quadraticCurveTo(10, -40, -5, -80); \r\n        ctx.lineTo(5, -80);\r\n        ctx.quadraticCurveTo(20, -40, 10, 0);\r\n        ctx.fillStyle = palette.rock; // Use rock color (brown) for trunk\r\n        ctx.fill();\r\n\r\n        // Leaves\r\n        ctx.translate(0, -80);\r\n        ctx.fillStyle = palette.leaf;\r\n        for(let i=0; i<7; i++) {\r\n            ctx.save();\r\n            ctx.rotate((i / 7) * Math.PI * 2 - Math.PI/2); // Spread around top\r\n            ctx.beginPath();\r\n            ctx.moveTo(0, 0);\r\n            ctx.quadraticCurveTo(30, -10, 60, 0);\r\n            ctx.quadraticCurveTo(30, 10, 0, 0);\r\n            ctx.fill();\r\n            ctx.restore();\r\n        }\r\n        ctx.restore();\r\n    }\r\n\r\n    function drawRock(ctx, x, y, scale, palette) {\r\n        ctx.save();\r\n        ctx.translate(x, y);\r\n        ctx.scale(scale, scale);\r\n        \r\n        ctx.fillStyle = palette.rock;\r\n        ctx.beginPath();\r\n        ctx.moveTo(-20, 0);\r\n        ctx.bezierCurveTo(-20, -15, -10, -25, 0, -25);\r\n        ctx.bezierCurveTo(10, -25, 20, -15, 20, 0);\r\n        ctx.fill();\r\n\r\n        // Shadow\r\n        ctx.fillStyle = 'rgba(0,0,0,0.2)';\r\n        ctx.beginPath();\r\n        ctx.ellipse(0, 0, 20, 5, 0, 0, Math.PI * 2);\r\n        ctx.fill();\r\n\r\n        ctx.restore();\r\n    }\r\n\r\n    function drawShell(ctx, x, y, scale, palette) {\r\n        ctx.save();\r\n        ctx.translate(x, y);\r\n        ctx.scale(scale, scale);\r\n\r\n        ctx.fillStyle = palette.shell;\r\n        ctx.beginPath();\r\n        ctx.arc(0, 0, 10, Math.PI, 0);\r\n        ctx.lineTo(0,0);\r\n        ctx.fill();\r\n        \r\n        ctx.strokeStyle = palette.sandDark;\r\n        ctx.lineWidth = 1;\r\n        ctx.beginPath();\r\n        for(let i=1; i<5; i++) {\r\n            const angle = Math.PI + (i/5)*Math.PI;\r\n            ctx.moveTo(0, 0);\r\n            ctx.lineTo(Math.cos(angle)*10, Math.sin(angle)*10);\r\n        }\r\n        ctx.stroke();\r\n\r\n        ctx.restore();\r\n    }\r\n\r\n    function drawDunes(ctx, width, height, sandY, palette) {\r\n        // Base Background\r\n        ctx.fillStyle = palette.sandDark;\r\n        ctx.fillRect(-50, sandY, width + 100, height - sandY);\r\n\r\n        // Dune 1 (Back)\r\n        ctx.fillStyle = palette.sandDark;\r\n        // Slightly lighter than base for contrast? \r\n        // Actually palette.sandDark is the darkest. palette.sandLight is lightest.\r\n        // Let's interpolate manually or just use alpha.\r\n        \r\n        // Let's use semi-transparent light sand to create layers.\r\n        \r\n        ctx.save();\r\n        \r\n        // Layer 1\r\n        ctx.fillStyle = palette.sandLight; \r\n        ctx.globalAlpha = 0.3;\r\n        ctx.beginPath();\r\n        ctx.moveTo(-50, height + 100);\r\n        ctx.lineTo(-50, sandY);\r\n        ctx.bezierCurveTo(width*0.3, sandY - 20, width*0.7, sandY + 20, width + 50, sandY);\r\n        ctx.lineTo(width + 50, height + 100);\r\n        ctx.fill();\r\n\r\n        // Layer 2 (Closer)\r\n        ctx.globalAlpha = 0.6;\r\n        const d2y = sandY + height * 0.05;\r\n        ctx.beginPath();\r\n        ctx.moveTo(-50, height + 100);\r\n        ctx.lineTo(-50, d2y);\r\n        ctx.bezierCurveTo(width*0.4, d2y + 40, width*0.6, d2y - 10, width + 50, d2y + 20);\r\n        ctx.lineTo(width + 50, height + 100);\r\n        ctx.fill();\r\n        \r\n        // Layer 3 (Closest)\r\n        ctx.globalAlpha = 1.0;\r\n        const d3y = sandY + height * 0.15;\r\n        ctx.beginPath();\r\n        ctx.moveTo(-50, height + 100);\r\n        ctx.lineTo(-50, d3y);\r\n        ctx.bezierCurveTo(width*0.2, d3y - 10, width*0.8, d3y + 30, width + 50, d3y + 10);\r\n        ctx.lineTo(width + 50, height + 100);\r\n        ctx.fill();\r\n\r\n        // Speckles/Texture\r\n        ctx.fillStyle = palette.sandDark;\r\n        ctx.globalAlpha = 0.1;\r\n        sandSpeckles.forEach(s => {\r\n            ctx.fillRect(s.x, s.y, 2, 2);\r\n        });\r\n\r\n        ctx.restore();\r\n    }\r\n\r\n    function spawnBeacon(ctx, width, height, forceSize = null) {\r\n        // Darker blue range: 225-245 (Pure Blue to Indigo, avoiding Cyan & Purple)\r\n        const sizeMult = forceSize ? forceSize : 1;\r\n        const isFinal = !!forceSize && forceSize > 5;\r\n        \r\n        // Sound for spawn\r\n        // Safety: Explicitly block sound if explosion has triggered\r\n        if (beaconsActive && !isFinal && !finalExplosionTriggered) {\r\n             playAudio('sounds/tsu_beacon_spawn.ogg', { volume: 0.3 + Math.random() * 0.2 });\r\n        }\r\n\r\n        beacons.push({\r\n            x: isFinal ? width / 2 : Math.random() * width,\r\n            y: isFinal ? height / 2 : Math.random() * height,\r\n            radius: 0,\r\n            maxRadius: isFinal ? Math.max(width, height) * 1.5 : (100 + Math.random() * 400) * sizeMult,\r\n            speed: isFinal ? 40 : (5 + Math.random() * 15) * sizeMult,\r\n            opacity: 1,\r\n            hue: 225 + Math.random() * 15, \r\n            life: 1.0\r\n        });\r\n    }\r\n\r\n    function drawBeacons(ctx, width, height, intensity = 0.5, allowSpawn = true) {\r\n        // Dynamic spawn chance based on intensity\r\n        const chance = 0.1 + (intensity * 0.7);\r\n        const spawnCount = Math.floor(1 + intensity * 4); \r\n\r\n        if (allowSpawn && !finalExplosionTriggered) {\r\n            for(let k=0; k<spawnCount; k++) {\r\n                if (beacons.length < 50 && Math.random() < chance) {\r\n                    const sizeMult = 1 + intensity * 2;\r\n                    spawnBeacon(ctx, width, height, sizeMult);\r\n                }\r\n            }\r\n        }\r\n\r\n        ctx.save();\r\n        ctx.globalCompositeOperation = 'lighter'; // Additive blending\r\n\r\n        for (let i = beacons.length - 1; i >= 0; i--) {\r\n            const b = beacons[i];\r\n            b.radius += b.speed;\r\n            b.opacity -= 0.015; // Slightly faster fade\r\n            b.life -= 0.015;\r\n\r\n            if (b.opacity <= 0 || b.radius > b.maxRadius) {\r\n                beacons.splice(i, 1);\r\n                continue;\r\n            }\r\n\r\n            const grad = ctx.createRadialGradient(b.x, b.y, 0, b.x, b.y, b.radius);\r\n            // Deep Blue gradients\r\n            const alpha = b.opacity;\r\n            // 80% lightness in center (was 90%)\r\n            grad.addColorStop(0, `hsla(${b.hue}, 100%, 80%, ${alpha})`); \r\n            // 40% lightness mid (Deep Blue)\r\n            grad.addColorStop(0.3, `hsla(${b.hue}, 100%, 40%, ${alpha * 0.9})`); \r\n            // 15% lightness outer (Very Dark Blue)\r\n            grad.addColorStop(0.7, `hsla(${b.hue}, 100%, 15%, ${alpha * 0.6})`); \r\n            grad.addColorStop(1, `hsla(${b.hue}, 100%, 5%, 0)`);\r\n\r\n            ctx.fillStyle = grad;\r\n            ctx.beginPath();\r\n            ctx.arc(b.x, b.y, b.radius, 0, Math.PI * 2);\r\n            ctx.fill();\r\n        }\r\n\r\n        ctx.restore();\r\n    }\r\n\r\n    // --- Render Loop ---\r\n    function loop() {\r\n        if (!isRunning) return;\r\n\r\n        const now = Date.now();\r\n        const elapsed = now - startTime;\r\n        const progress = Math.min(elapsed / durationMs, 1.0);\r\n\r\n        if (progress >= 1.0 && !visualsFinished) {\r\n            visualsFinished = true;\r\n            \r\n            // Fix: Stop storm audio when visuals finish, to handle desync from tab switching\r\n            if (ambienceAudio) ambienceAudio.stop();\r\n            if (rumbleAudio) rumbleAudio.stop();\r\n\r\n            if (onComplete) onComplete();\r\n            // Do not return; keep looping to allow beacons etc.\r\n        }\r\n\r\n        // Timeline Constants (ms)\r\n        const FADE_IN_END = 5000;\r\n        const STORM_START = 6000;\r\n        const STRIKE_TIME = 50000;\r\n        const FADE_OUT_START = 50000;\r\n        const FADE_OUT_DURATION = 5000;\r\n        const IMPACT_START = 40000;\r\n\r\n        // 1. Storm Factor (0 to 1)\r\n        // 0s - 7.5s: 0\r\n        // 7.5s - 55s: Ramp 0 -> 1\r\n        let stormFactor = 0;\r\n        if (elapsed < STORM_START) {\r\n            stormFactor = 0;\r\n        } else if (elapsed < STRIKE_TIME) {\r\n            stormFactor = (elapsed - STORM_START) / (STRIKE_TIME - STORM_START);\r\n        } else {\r\n            stormFactor = 1;\r\n        }\r\n\r\n        // Audio: Rumble (Impact)\r\n        let impactFactor = 0;\r\n        if (elapsed > IMPACT_START) {\r\n            impactFactor = Math.max(0, (elapsed - IMPACT_START) / (STRIKE_TIME - IMPACT_START));\r\n        }\r\n        // Clamp impact factor to 1 until fade out completes, though elapsed > STRIKE_TIME covers it.\r\n        if (elapsed > STRIKE_TIME) impactFactor = 1;\r\n\r\n        if (impactFactor > 0.1 && !rumbleAudio) {\r\n            rumbleAudio = playAudio('sounds/tsu_rumble.ogg', { volume: 0.8 });\r\n        }\r\n\r\n        // Interpolate Palette\r\n        const currentPalette = {\r\n            skyTop: lerpColor(SUNNY_PALETTE.skyTop, STORM_PALETTE.skyTop, stormFactor),\r\n            skyBottom: lerpColor(SUNNY_PALETTE.skyBottom, STORM_PALETTE.skyBottom, stormFactor),\r\n            sun: lerpColor(SUNNY_PALETTE.sun, STORM_PALETTE.sun, stormFactor),\r\n            waterDeep: lerpColor(SUNNY_PALETTE.waterDeep, STORM_PALETTE.waterDeep, stormFactor),\r\n            waterMid: lerpColor(SUNNY_PALETTE.waterMid, STORM_PALETTE.waterMid, stormFactor),\r\n            waterPeak: lerpColor(SUNNY_PALETTE.waterPeak, STORM_PALETTE.waterPeak, stormFactor),\r\n            foam: lerpColor(SUNNY_PALETTE.foam, STORM_PALETTE.foam, stormFactor),\r\n            sandLight: lerpColor(SUNNY_PALETTE.sandLight, STORM_PALETTE.sandLight, stormFactor),\r\n            sandDark: lerpColor(SUNNY_PALETTE.sandDark, STORM_PALETTE.sandDark, stormFactor),\r\n            rock: lerpColor(SUNNY_PALETTE.rock, STORM_PALETTE.rock, stormFactor),\r\n            leaf: lerpColor(SUNNY_PALETTE.leaf, STORM_PALETTE.leaf, stormFactor),\r\n            shell: lerpColor(SUNNY_PALETTE.shell, STORM_PALETTE.shell, stormFactor)\r\n        };\r\n\r\n        // Screen Shake\r\n        let shakeX = 0;\r\n        let shakeY = 0;\r\n        if (stormFactor > 0.5 || finalExplosionTriggered) {\r\n            let shakeMag = (stormFactor - 0.5) * 2 * 5 + (impactFactor * 25);\r\n            \r\n            // Extra chaos during explosion (flashWhite is counting down from 60)\r\n            if (flashWhite > 0) {\r\n                 shakeMag += 50; \r\n            }\r\n            \r\n            shakeX = (Math.random() - 0.5) * shakeMag;\r\n            shakeY = (Math.random() - 0.5) * shakeMag;\r\n        }\r\n\r\n        // Clear FG\r\n        fgCtx.clearRect(0, 0, width, height);\r\n\r\n        bgCtx.save();\r\n        bgCtx.translate(shakeX, shakeY);\r\n        \r\n        fgCtx.save();\r\n        fgCtx.translate(shakeX, shakeY);\r\n\r\n        // 1. Draw Sky (BG)\r\n        const grad = bgCtx.createLinearGradient(0, 0, 0, height);\r\n        grad.addColorStop(0, currentPalette.skyTop);\r\n        grad.addColorStop(1, currentPalette.skyBottom);\r\n        bgCtx.fillStyle = grad;\r\n        bgCtx.fillRect(-50, -50, width + 100, height + 100);\r\n\r\n        // 2. Draw Sun (BG)\r\n        if (stormFactor < 1.0) {\r\n            const sunY = height * 0.15 + (stormFactor * 50); // Sun sets slightly\r\n            bgCtx.beginPath();\r\n            bgCtx.arc(width * 0.7, sunY, 40, 0, Math.PI * 2);\r\n            bgCtx.fillStyle = currentPalette.sun;\r\n            bgCtx.globalAlpha = 1 - stormFactor; // Fade out\r\n            bgCtx.shadowColor = currentPalette.sun;\r\n            bgCtx.shadowBlur = 20;\r\n            bgCtx.fill();\r\n            bgCtx.globalAlpha = 1.0;\r\n            bgCtx.shadowBlur = 0;\r\n        }\r\n\r\n\r\n\r\n        // 3. Draw Merchant (BG)\r\n        const sandY = height * 0.65; // Starts at 65% down\r\n\r\n        if (merchantLoaded && stormFactor < 1) { \r\n            bgCtx.save();\r\n            // Position: Right side, lower down\r\n            const merchScale = Math.min(width, height) * 0.0005; \r\n            const merchW = 300 * merchScale;\r\n            const merchH = 300 * merchScale; \r\n            // Position him to peek from behind the sand\r\n            const merchX = width * 0.80; \r\n            \r\n            // Anchor to sand line so he doesn't float on mobile\r\n            // Bottom of sprite is at (merchY + merchH/2).\r\n            // We want bottom to be slightly below sandY (overlap).\r\n            const overlap = merchH * 0.15; \r\n            const merchY = sandY - (merchH / 2) + overlap;\r\n\r\n            bgCtx.translate(merchX, merchY);\r\n            bgCtx.rotate(0.1); // Slight slant\r\n            bgCtx.drawImage(merchantImg, -merchW/2, -merchH/2, merchW, merchH);\r\n            bgCtx.restore();\r\n        }\r\n\r\n        // 4. Draw Sand & Props (BG)\r\n        // Draw Dunes\r\n        drawDunes(bgCtx, width, height, sandY, currentPalette);\r\n\r\n        // Draw Props\r\n        // Only draw props if they are not underwater?\r\n        // Actually, the tsunami covers everything eventually.\r\n        // The water drawing logic (step 7 and 8) is on fgCanvas (foreground).\r\n        // Props are on bgCanvas.\r\n        // So they will be naturally covered by the water drawn on fgCanvas.\r\n        \r\n        props.forEach(prop => {\r\n            if (prop.type === 'tree') drawPalmTree(bgCtx, prop.x, prop.y, prop.scale, currentPalette);\r\n            else if (prop.type === 'rock') drawRock(bgCtx, prop.x, prop.y, prop.scale, currentPalette);\r\n            else if (prop.type === 'shell') drawShell(bgCtx, prop.x, prop.y, prop.scale, currentPalette);\r\n        });\r\n\r\n        // 5. Draw Cliffs - REMOVED\r\n\r\n        // 6. Lightning Logic (FG) - REMOVED\r\n\r\n        // 6.5. Rain (FG) - Moved here to be behind water\r\n        if (stormFactor > 0.3) {\r\n            const rainIntensity = (stormFactor - 0.3) / 0.7;\r\n            const rainCount = Math.floor(maxRain * rainIntensity);\r\n            \r\n            fgCtx.strokeStyle = `rgba(120, 180, 255, ${0.1 + rainIntensity * 0.3})`;\r\n            fgCtx.lineWidth = 1 + rainIntensity;\r\n            fgCtx.beginPath();\r\n\r\n            // Add particles\r\n            if (rainParticles.length < rainCount) {\r\n                for(let i=0; i<10; i++) {\r\n                    rainParticles.push({\r\n                        x: Math.random() * width * 1.5, // Wide spawn for angle\r\n                        y: cloudBaseY,\r\n                        speed: 20 + Math.random() * 20,\r\n                        len: 10 + Math.random() * 20\r\n                    });\r\n                }\r\n            }\r\n\r\n            const wind = 10 + rainIntensity * 20;\r\n\r\n            for (let i = 0; i < rainParticles.length; i++) {\r\n                const p = rainParticles[i];\r\n                p.y += p.speed;\r\n                p.x -= wind;\r\n\r\n                fgCtx.moveTo(p.x, p.y);\r\n                fgCtx.lineTo(p.x - wind * 0.5, p.y + p.len);\r\n\r\n                if (p.y > height || p.x < -100) {\r\n                    if (i < rainCount) {\r\n                        p.x = Math.random() * width * 1.5;\r\n                        p.y = cloudBaseY;\r\n                    } else {\r\n                        rainParticles.splice(i, 1);\r\n                        i--;\r\n                    }\r\n                }\r\n            }\r\n            fgCtx.stroke();\r\n        }\r\n\r\n        // 7. Distant Tsunami Wall (FG)\r\n        // Start showing wall when storm is roughly 30% active (around 22s mark)\r\n        const WALL_START_FACTOR = 0.3; \r\n        if (stormFactor > WALL_START_FACTOR) {\r\n            const wallProgress = (stormFactor - WALL_START_FACTOR) / (1 - WALL_START_FACTOR); // 0 to 1\r\n            const wallHeight = lerp(0, height * 1.5, wallProgress * wallProgress); // Accelerate\r\n            \r\n            fgCtx.fillStyle = currentPalette.waterDeep;\r\n            fgCtx.beginPath();\r\n            \r\n            fgCtx.moveTo(-50, height + 100);\r\n            fgCtx.lineTo(-50, height - wallHeight * 0.3); // Left side lower\r\n            \r\n            // Bezier for the wave crest\r\n            fgCtx.bezierCurveTo(\r\n                width * 0.3, height - wallHeight * 0.4, \r\n                width * 0.6, height - wallHeight * 1.2, // The crest peak\r\n                width + 50, height - wallHeight * 0.8\r\n            );\r\n            \r\n            fgCtx.lineTo(width + 50, height + 100);\r\n            fgCtx.fill();\r\n        }\r\n\r\n        // 8. Normal Ocean Waves (FG)\r\n        const tideRise = lerp(0, height * 0.5, stormFactor); \r\n        const impactRise = lerp(0, height * 1.5, impactFactor * impactFactor);\r\n        \r\n        // Start water lower to show sand (0.85)\r\n        const baseWaterY = height * 0.85 - tideRise - impactRise;\r\n\r\n        waves.forEach((wave, index) => {\r\n            // Mix colors based on layer\r\n            let baseColor;\r\n            if (index === layerCount - 1) baseColor = currentPalette.waterPeak;\r\n            else if (index % 2 === 0) baseColor = currentPalette.waterDeep;\r\n            else baseColor = currentPalette.waterMid;\r\n\r\n            fgCtx.fillStyle = baseColor;\r\n            fgCtx.beginPath();\r\n\r\n            // Turbulence\r\n            const waveAmp = wave.amplitudeBase * (1 + stormFactor * 2 + impactFactor * 5);\r\n            const waveFreq = 0.003 + (stormFactor * 0.005);\r\n            const speed = wave.speedBase * (1 + stormFactor * 5 + impactFactor * 10);\r\n            \r\n            const timeOffset = elapsed * speed + wave.offset;\r\n            const yOffset = index * 15 * (1 - impactFactor); // Compress layers on impact\r\n\r\n            const layerY = baseWaterY + yOffset;\r\n\r\n            fgCtx.moveTo(-50, height + 100);\r\n            fgCtx.lineTo(-50, layerY);\r\n\r\n            for (let x = -50; x <= width + 50; x += 15) {\r\n                const y = layerY + \r\n                          Math.sin(x * waveFreq + timeOffset) * waveAmp + \r\n                          Math.cos(x * waveFreq * 2.3 + timeOffset) * (waveAmp * 0.5);\r\n                fgCtx.lineTo(x, y);\r\n            }\r\n\r\n            fgCtx.lineTo(width + 50, height + 100);\r\n            fgCtx.fill();\r\n\r\n            // Foam on top layer or high storm factor\r\n            if (index === layerCount - 1 || (stormFactor > 0.6 && index > layerCount - 3)) {\r\n                // fgCtx.fillStyle = `rgba(255, 255, 255, ${0.1 + stormFactor * 0.3})`;\r\n                // Use palette foam color instead of hardcoded white\r\n                fgCtx.save();\r\n                fgCtx.globalAlpha = 0.1 + stormFactor * 0.3;\r\n                fgCtx.fillStyle = currentPalette.foam;\r\n\r\n                // Simple foam pass\r\n                fgCtx.beginPath();\r\n                for (let x = -50; x <= width + 50; x += 10) {\r\n                    let y = layerY + \r\n                          Math.sin(x * waveFreq + timeOffset) * waveAmp + \r\n                          Math.cos(x * waveFreq * 2.3 + timeOffset) * (waveAmp * 0.5);\r\n                    if (Math.random() > 0.5) y -= 5; // Spray\r\n                    if(x===-50) fgCtx.moveTo(x,y); else fgCtx.lineTo(x, y);\r\n                }\r\n                fgCtx.lineTo(width + 50, height + 100);\r\n                fgCtx.lineTo(-50, height + 100);\r\n                fgCtx.fill();\r\n                fgCtx.restore();\r\n            }\r\n        });\r\n\r\n        // 10. Intro Fade In (FG)\r\n        if (elapsed < FADE_IN_END) {\r\n            let opacity = 1;\r\n            if (elapsed > 1000) {\r\n                opacity = 1 - ((elapsed - 1000) / (FADE_IN_END - 1000));\r\n            }\r\n            fgCtx.fillStyle = `rgba(0, 0, 0, ${opacity})`;\r\n            fgCtx.fillRect(-50, -50, width + 100, height + 100);\r\n        }\r\n\r\n        // 11. Initial Storm Fade Out (FG) - Time Based\r\n        if (elapsed > FADE_OUT_START) {\r\n            const fade = Math.min(1, (elapsed - FADE_OUT_START) / FADE_OUT_DURATION);\r\n            fgCtx.fillStyle = `rgba(0, 0, 0, ${fade})`;\r\n            fgCtx.fillRect(-50, -50, width + 100, height + 100);\r\n        }\r\n\r\n        // 12. Solar Beacons (Crazy Stuff) - Triggered Manually, On Top of Black\r\n        if (beaconsActive) {\r\n            const beaconElapsed = now - beaconStartTime;\r\n            \r\n            // 15 seconds total duration.\r\n            // Requirement: Explosion much later (closer to fade out).\r\n            // Let's aim for 12.0s (total sequence is ~15s).\r\n            \r\n            const EXPLOSION_TIME = 12000;\r\n            \r\n            let intensity = 0;\r\n            let allowSpawn = true;\r\n            \r\n            // Ramp up 0 -> 1 over 12.0s\r\n            if (beaconElapsed < EXPLOSION_TIME) {\r\n                intensity = beaconElapsed / EXPLOSION_TIME;\r\n            } else {\r\n                intensity = 1.0;\r\n                // Final explosion check\r\n                if (!finalExplosionTriggered) {\r\n                    finalExplosionTriggered = true;\r\n                    // Spawn huge explosion center screen\r\n                    spawnBeacon(fgCtx, width, height, 25.0); // Larger visual impact\r\n                    flashWhite = 60; // Extended flash frames (approx 1 sec at 60fps)\r\n                    \r\n                    if (!explosionAudioTriggered) {\r\n                        explosionAudioTriggered = true;\r\n                        playAudio('sounds/tsu_explosion.ogg', { volume: 1.0 });\r\n                        \r\n                        // Stop hum/charge\r\n                        if (humAudio) humAudio.stop();\r\n                    }\r\n                }\r\n            }\r\n            \r\n            // Stop regular spawning when final fade starts\r\n            if (finalFadeActive) {\r\n                allowSpawn = false;\r\n            }\r\n            \r\n            drawBeacons(fgCtx, width, height, intensity, allowSpawn);\r\n        }\r\n\r\n        // 13. Final Blackout Fade Out (FG) - Manual Trigger\r\n        if (finalFadeActive) {\r\n            const fadeElapsed = now - finalFadeStart;\r\n            const fade = Math.min(1, fadeElapsed / finalFadeDuration);\r\n            fgCtx.fillStyle = `rgba(0, 0, 0, ${fade})`;\r\n            fgCtx.fillRect(-50, -50, width + 100, height + 100);\r\n        }\r\n\r\n        // 14. Flash White (Boom)\r\n        if (flashWhite > 0) {\r\n            // Smooth fade out: 60 frames max. \r\n            // Normalized 0 to 1.\r\n            const t = flashWhite / 60; \r\n            // Ease out cubic (starts fast, slows down) or simple linear?\r\n            // User requested \"fades out smoothly\". \r\n            // Linear opacity: t. \r\n            // Let's use a curve to keep it bright longer then fade.\r\n            const alpha = t * t; \r\n            \r\n            fgCtx.fillStyle = `rgba(255, 255, 255, ${alpha})`;\r\n            fgCtx.fillRect(-50, -50, width + 100, height + 100);\r\n            flashWhite--;\r\n        }\r\n\r\n        bgCtx.restore();\r\n        fgCtx.restore();\r\n\r\n        animationFrameId = requestAnimationFrame(loop);\r\n    }\r\n\r\n    function cleanup() {\r\n        isRunning = false;\r\n        container.style.cursor = '';\r\n        if (animationFrameId) cancelAnimationFrame(animationFrameId);\r\n        window.removeEventListener('resize', resize);\r\n        if (bgCanvas.parentNode) bgCanvas.parentNode.removeChild(bgCanvas);\r\n        if (fgCanvas.parentNode) fgCanvas.parentNode.removeChild(fgCanvas);\r\n        if (uiContainer.parentNode) uiContainer.parentNode.removeChild(uiContainer);\r\n        \r\n        // Stop Audio\r\n        if (ambienceAudio) ambienceAudio.stop();\r\n        if (rumbleAudio) rumbleAudio.stop();\r\n        if (humAudio) humAudio.stop();\r\n    }\r\n\r\n    function triggerBeacons() {\r\n        beaconsActive = true;\r\n        beaconStartTime = Date.now();\r\n        finalExplosionTriggered = false;\r\n        flashWhite = 0;\r\n        \r\n        // Audio: Hum Loop\r\n        if (!humAudio) {\r\n            humAudio = playAudio('sounds/tsu_beacon_hum.ogg', { loop: true, volume: 0.6 });\r\n        }\r\n    }\r\n\r\n    function triggerFinalFade() {\r\n        finalFadeActive = true;\r\n        finalFadeStart = Date.now();\r\n        // Ensure hum stops if it hasn't already\r\n        if (humAudio) humAudio.stop();\r\n    }\r\n\r\n    function showCursor() {\r\n        container.style.cursor = '';\r\n    }\r\n\r\n    function hideCursor() {\r\n        container.style.cursor = 'none';\r\n    }\r\n\r\n    function stopHumLoop() {\r\n        if (humAudio) {\r\n            humAudio.stop();\r\n            humAudio = null;\r\n        }\r\n    }\r\n\r\n    loop();\r\n    \r\n    // Return controls\r\n    return {\r\n        cleanup,\r\n        triggerBeacons,\r\n        triggerFinalFade,\r\n        showCursor,\r\n        hideCursor,\r\n        stopHumLoop\r\n    };\r\n}\r\n", "// js/ui/merchantTabs/resetTab.js\r\nimport { BigNum } from '../../util/bigNum.js';\r\nimport { IS_MOBILE } from '../../main.js';\r\nimport {\r\n  bank,\r\n  getActiveSlot,\r\n  watchStorageKey,\r\n  primeStorageWatcherSnapshot,\r\n  onCurrencyChange,\r\n  CURRENCIES,\r\n} from '../../util/storage.js';\r\nimport { formatNumber } from '../../util/numFormat.js';\r\nimport {\r\n  getXpState,\r\n  resetXpProgress,\r\n  onXpChange,\r\n} from '../../game/xpSystem.js';\r\nimport {\r\n  AREA_KEYS,\r\n  UPGRADE_TIES,\r\n  getUpgradesForArea,\r\n  getLevelNumber,\r\n  setLevel,\r\n  approxLog10BigNum,\r\n  bigNumFromLog10,\r\n  formatMultForUi,\r\n} from '../../game/upgrades.js';\r\nimport {\r\n  initMutationSystem,\r\n  unlockMutationSystem,\r\n  isMutationUnlocked,\r\n  getMutationCoinSprite,\r\n  onMutationChange,\r\n  getMutationState,\r\n  getTotalCumulativeMp,\r\n} from '../../game/mutationSystem.js';\r\nimport { shouldSkipGhostTap } from '../../util/ghostTapGuard.js';\r\nimport { clearPendingGains } from '../../game/coinPickup.js';\r\nimport { getVisibleMilestones, NERFED_SURGE_MILESTONE_IDS } from '../../game/surgeMilestones.js';\r\nimport { ensureCustomScrollbar, closeShop, openShop, isAnyMenuScrolling } from '../shopOverlay.js';\r\nimport { playAudio } from '../../util/audioManager.js';\r\nimport { \r\n  getBookProductionRate, \r\n  getSurge6WealthMultipliers, \r\n  getTsunamiNerf,\r\n  getTsunamiSequenceSeen,\r\n  setTsunamiSequenceSeen,\r\n  isSurgeActive,\r\n  getEffectiveTsunamiNerf\r\n} from '../../game/surgeEffects.js';\r\nimport { \r\n    getTsunamiResearchBonus,\r\n    isExperimentUnlocked as isLabExperimentUnlocked,\r\n    resetLab,\r\n    getLabGoldMultiplier,\r\n    getLabMagicMultiplier\r\n} from '../../game/labNodes.js';\r\nimport { getLabLevel } from './labTab.js';\r\nimport { closeMerchant, runTsunamiDialogue } from './dlgTab.js';\r\nimport { playTsunamiSequence } from '../../game/tsunamiVisuals.js';\r\n\r\nconst BN = BigNum;\r\n\r\nconst LOG1_1 = Math.log10(1.1);\r\nconst bnZero = () => BN.fromInt(0);\r\nconst bnOne = () => BN.fromInt(1);\r\n\r\nconst GOLD_ICON_SRC = 'img/currencies/gold/gold.webp';\r\nconst MAGIC_ICON_SRC = 'img/currencies/magic/magic.webp';\r\nconst DNA_ICON_SRC = 'img/currencies/dna/dna.webp';\r\nconst RESET_ICON_SRC = 'img/misc/forge.webp';\r\nconst INFUSE_ICON_SRC = 'img/misc/infuse.webp';\r\nconst SURGE_ICON_SRC = 'img/misc/surge.webp';\r\nconst EXPERIMENT_ICON_SRC = 'img/misc/experiment.webp';\r\nconst WAVES_ICON_SRC = 'img/currencies/wave/wave.webp';\r\nconst FORGE_RESET_SOUND_SRC = 'sounds/forge_reset.ogg';\r\nconst INFUSE_RESET_SOUND_SRC = 'sounds/infuse_reset.ogg';\r\nconst SURGE_RESET_SOUND_SRC = 'sounds/surge_reset.ogg';\r\nconst EXPERIMENT_RESET_SOUND_SRC = 'sounds/experiment_reset.ogg';\r\n\r\n// Add reset names here (e.g. 'forge', 'infuse', 'surge') to exclude them from wiping the playfield\r\nconst RESET_WIPE_EXCLUSIONS = [];\r\n\r\n\r\nfunction shouldWipePlayfield(resetType) {\r\n  return !RESET_WIPE_EXCLUSIONS.includes(resetType);\r\n}\r\n\r\nfunction playForgeResetSound() {\r\n  playAudio(FORGE_RESET_SOUND_SRC, { volume: 0.4 });\r\n}\r\n\r\nfunction playInfuseResetSound() {\r\n  playAudio(INFUSE_RESET_SOUND_SRC, { volume: 0.45 });\r\n}\r\n\r\nfunction playSurgeResetSound() {\r\n  playAudio(SURGE_RESET_SOUND_SRC, { volume: 0.5 });\r\n}\r\n\r\nfunction playExperimentResetSound() {\r\n  playAudio(EXPERIMENT_RESET_SOUND_SRC, { volume: 0.8 });\r\n}\r\n\r\nconst FORGE_UNLOCK_KEY = (slot) => `ccc:reset:forge:${slot}`;\r\nconst FORGE_COMPLETED_KEY = (slot) => `ccc:reset:forge:completed:${slot}`;\r\nconst FORGE_DEBUG_OVERRIDE_KEY = (slot) => `ccc:debug:forgeUnlocked:${slot}`;\r\n\r\nconst INFUSE_UNLOCK_KEY = (slot) => `ccc:reset:infuse:${slot}`;\r\nconst INFUSE_COMPLETED_KEY = (slot) => `ccc:reset:infuse:completed:${slot}`;\r\nconst INFUSE_DEBUG_OVERRIDE_KEY = (slot) => `ccc:debug:infuseUnlocked:${slot}`;\r\n\r\nconst SURGE_UNLOCK_KEY = (slot) => `ccc:reset:surge:${slot}`;\r\nconst SURGE_DEBUG_OVERRIDE_KEY = (slot) => `ccc:debug:surgeUnlocked:${slot}`;\r\nconst SURGE_COMPLETED_KEY = (slot) => `ccc:reset:surge:completed:${slot}`;\r\nexport const getSurgeBarLevelKey = (slot) => `ccc:reset:surge:barLevel:${slot}`;\r\nconst SURGE_BAR_LEVEL_KEY = getSurgeBarLevelKey;\r\n\r\nconst EXPERIMENT_COMPLETED_KEY = (slot) => `ccc:reset:experiment:completed:${slot}`;\r\n\r\nconst MIN_FORGE_LEVEL = BN.fromInt(31);\r\nconst MIN_INFUSE_MUTATION_LEVEL = BN.fromInt(7);\r\n\r\nlet isUpdatingWaveBar = false;\r\nlet _shouldBlockBigCoins = false;\r\n\r\nexport function shouldBlockBigCoins() {\r\n  return _shouldBlockBigCoins;\r\n}\r\n\r\nfunction updateBlockBigCoinsStatus() {\r\n  const slot = ensureResetSlot();\r\n  const currentWaves = bank.waves?.value ?? bnZero();\r\n  let barLevel = 0n;\r\n  try { barLevel = getSurgeBarLevel(slot); } catch {}\r\n  \r\n  const pending = resetState.pendingWaves;\r\n  const potentialLevel = predictSurgeLevel(barLevel, currentWaves, pending);\r\n\r\n  let isSurge8 = false;\r\n  if (potentialLevel === Infinity) isSurge8 = true;\r\n  else if (typeof potentialLevel === 'bigint') isSurge8 = potentialLevel >= 8n;\r\n  else if (typeof potentialLevel === 'number') isSurge8 = potentialLevel >= 8;\r\n\r\n  _shouldBlockBigCoins = isSurge8 && !getTsunamiSequenceSeen();\r\n}\r\n\r\nconst resetState = {\r\n  slot: null,\r\n  forgeUnlocked: false,\r\n  forgeDebugOverride: null,\r\n  hasDoneForgeReset: false,\r\n  infuseUnlocked: false,\r\n  infuseDebugOverride: null,\r\n  hasDoneInfuseReset: false,\r\n  surgeUnlocked: false,\r\n  surgeDebugOverride: null,\r\n  hasDoneSurgeReset: false,\r\n  hasDoneExperimentReset: false,\r\n  pendingGold: bnZero(),\r\n  pendingMagic: bnZero(),\r\n  pendingWaves: bnZero(),\r\n  pendingDna: bnZero(),\r\n  panel: null,\r\n  visible: {\r\n    forge: false,\r\n    infuse: false,\r\n    surge: false,\r\n    experiment: false,\r\n    surgeMilestones: false\r\n  },\r\n  elements: {\r\n    forge: {\r\n      card: null,\r\n      status: null,\r\n      btn: null,\r\n    },\r\n    infuse: {\r\n      card: null,\r\n      status: null,\r\n      btn: null,\r\n    },\r\n    surge: {\r\n      card: null,\r\n      status: null,\r\n      btn: null,\r\n      bar: null,\r\n      barFill: null,\r\n      barText: null,\r\n      milestones: null,\r\n      headerVal: null,\r\n    },\r\n    experiment: {\r\n      card: null,\r\n      status: null,\r\n      btn: null,\r\n    },\r\n  },\r\n  layerButtons: {},\r\n  flagsPrimed: false,\r\n  lastRenderedSurgeLevel: null,\r\n};\r\n\r\nconst watchers = [];\r\nlet watchersBoundSlot = null;\r\nlet initialized = false;\r\nlet mutationUnsub = null;\r\nlet pendingGoldInputSignature = null;\r\nlet coinChangeUnsub = null;\r\nlet xpChangeUnsub = null;\r\n\r\nfunction resetPendingGoldSignature() {\r\n  pendingGoldInputSignature = null;\r\n}\r\n\r\nfunction notifyForgeUnlockChange() {\r\n  const slot = resetState.slot ?? getActiveSlot();\r\n  try {\r\n    window.dispatchEvent(new CustomEvent('unlock:change', { detail: { key: 'forge', slot } }));\r\n  } catch {}\r\n}\r\n\r\nfunction notifyInfuseUnlockChange() {\r\n  const slot = resetState.slot ?? getActiveSlot();\r\n  try {\r\n    window.dispatchEvent(new CustomEvent('unlock:change', { detail: { key: 'infuse', slot } }));\r\n  } catch {}\r\n}\r\n\r\nfunction notifySurgeUnlockChange() {\r\n  const slot = resetState.slot ?? getActiveSlot();\r\n  try {\r\n    window.dispatchEvent(new CustomEvent('unlock:change', { detail: { key: 'surge', slot } }));\r\n  } catch {}\r\n}\r\n\r\nfunction getPendingGoldWithMultiplier(multiplierOverride = null) {\r\n  try {\r\n    const labMult = getLabGoldMultiplier();\r\n    let val = resetState.pendingGold.clone?.() ?? resetState.pendingGold;\r\n    if (multiplierOverride) {\r\n      const mult = multiplierOverride instanceof BN ? multiplierOverride : BN.fromAny(multiplierOverride ?? 1);\r\n      if (mult.isInfinite?.()) return BN.fromAny('Infinity');\r\n      val = val.mulBigNumInteger(mult);\r\n    } else {\r\n      val = bank.gold?.mult?.applyTo?.(val) ?? val;\r\n    }\r\n    return val.mulDecimal(labMult.toScientific());\r\n  } catch {\r\n    return resetState.pendingGold;\r\n  }\r\n}\r\n\r\nfunction cleanupWatchers() {\r\n  while (watchers.length) {\r\n    const stop = watchers.pop();\r\n    try { stop?.(); } catch {}\r\n  }\r\n}\r\n\r\nfunction ensureValueListeners() {\r\n  if (!coinChangeUnsub && typeof onCurrencyChange === 'function') {\r\n    coinChangeUnsub = onCurrencyChange((detail = {}) => {\r\n      if (detail?.key && detail.key !== CURRENCIES.COINS && detail.key !== CURRENCIES.WAVES) return;\r\n      if (detail?.slot != null && resetState.slot != null && detail.slot !== resetState.slot) return;\r\n      \r\n      if (detail?.key === CURRENCIES.WAVES) {\r\n          updateWaveBar();\r\n          updateResetPanel();\r\n      } else {\r\n          recomputePendingGold();\r\n          recomputePendingMagic();\r\n          recomputePendingWaves();\r\n      }\r\n    });\r\n  }\r\n  if (!xpChangeUnsub && typeof onXpChange === 'function') {\r\n    xpChangeUnsub = onXpChange((detail = {}) => {\r\n      if (detail?.slot != null && resetState.slot != null && detail.slot !== resetState.slot) return;\r\n      recomputePendingGold();\r\n      recomputePendingWaves();\r\n      recomputePendingDna();\r\n      updateResetPanel();\r\n    });\r\n  }\r\n}\r\n\r\nfunction levelToNumber(levelBn) {\r\n  if (!levelBn || typeof levelBn !== 'object') return 0;\r\n  if (levelBn.isInfinite?.()) return Number.POSITIVE_INFINITY;\r\n  try {\r\n    const plain = levelBn.toPlainIntegerString?.();\r\n    if (plain && plain !== 'Infinity' && plain.length <= 15) {\r\n      const num = Number(plain);\r\n      if (Number.isFinite(num)) return num;\r\n    }\r\n  } catch {}\r\n  const approx = approxLog10BigNum(levelBn);\r\n  if (!Number.isFinite(approx)) return Number.POSITIVE_INFINITY;\r\n  if (approx > 308) return Number.POSITIVE_INFINITY;\r\n  return Math.pow(10, approx);\r\n}\r\n\r\nfunction getXpLevelBn() {\r\n  try {\r\n    const state = getXpState();\r\n    if (state && state.xpLevel) return state.xpLevel;\r\n  } catch {}\r\n  return bnZero();\r\n}\r\n\r\nfunction computeForgeGold(coinsBn, levelBn) {\r\n  if (!coinsBn || typeof coinsBn !== 'object') return bnZero();\r\n  const logCoins = approxLog10BigNum(coinsBn);\r\n  if (!Number.isFinite(logCoins)) {\r\n    if (logCoins > 0) return BN.fromAny('Infinity');\r\n  }\r\n  const logScaled = Math.max(0, logCoins - 5);\r\n  if (!Number.isFinite(logScaled)) return bnZero();\r\n  const pow2 = bigNumFromLog10(logScaled * Math.log10(2));\r\n  const levelNum = Math.max(0, levelToNumber(levelBn));\r\n  const levelFactor = Math.max(0, (levelNum - 30) / 5);\r\n  const pow14 = levelFactor <= 0\r\n    ? bnOne()\r\n    : bigNumFromLog10(levelFactor * Math.log10(1.4));\r\n  const floorLog = Math.floor(logScaled);\r\n  const pow115 = floorLog <= 0\r\n    ? bnOne()\r\n    : bigNumFromLog10(floorLog * Math.log10(1.15));\r\n  let total = BN.fromInt(10);\r\n  total = total.mulBigNumInteger(pow2);\r\n  total = total.mulBigNumInteger(pow14);\r\n  total = total.mulBigNumInteger(pow115);\r\n  const floored = total.floorToInteger();\r\n  return floored.isZero?.() ? bnZero() : floored;\r\n}\r\n\r\nfunction computeInfuseMagicBase(coinsBn, cumulativeMpBn) {\r\n  if (!coinsBn) return bnZero();\r\n\r\n\r\n  const logCoins = approxLog10BigNum(coinsBn);\r\n  if (!Number.isFinite(logCoins)) { if (logCoins > 0) return BN.fromAny('Infinity'); }\r\n\r\n  const logCRatio = Math.max(0, logCoins - 12);\r\n\r\n  const LOG_BASE = 0.811078; // Math.log10(6.4726)\r\n  const LOG_1_5 = 0.176091;  // Math.log10(1.5)\r\n  const LOG_1_03 = 0.012837; // Math.log10(1.03)\r\n  const LOG_2 = 0.301030;    // Math.log10(2)\r\n\r\n  let logMpRatio = 0;\r\n  if (cumulativeMpBn && !cumulativeMpBn.isZero?.()) {\r\n    const logMp = approxLog10BigNum(cumulativeMpBn);\r\n    if (Number.isFinite(logMp)) {\r\n       logMpRatio = Math.max(0, logMp - 4);\r\n    }\r\n  }\r\n\r\n  const term1 = logCRatio * LOG_1_5;\r\n  const term2 = Math.floor(logCRatio) * LOG_1_03;\r\n  const term3 = logMpRatio * LOG_2;\r\n\r\n  const totalLog = LOG_BASE + term1 + term2 + term3;\r\n  \r\n  if (!Number.isFinite(totalLog)) return BN.fromAny('Infinity');\r\n  \r\n  return bigNumFromLog10(totalLog).floorToInteger();\r\n}\r\n\r\nfunction computeInfuseMagic(coinsBn, cumulativeMpBn, multiplierOverride = null) {\r\n  const base = computeInfuseMagicBase(coinsBn, cumulativeMpBn);\r\n  const labMult = getLabMagicMultiplier();\r\n  let result;\r\n  if (multiplierOverride) {\r\n    const mult = multiplierOverride instanceof BN ? multiplierOverride : BN.fromAny(multiplierOverride ?? 1);\r\n    if (mult.isInfinite?.()) return BN.fromAny('Infinity');\r\n    result = base.mulBigNumInteger(mult);\r\n  } else {\r\n    result = bank.magic?.mult?.applyTo?.(base) ?? base;\r\n  }\r\n  return result.mulDecimal(labMult.toScientific());\r\n}\r\n\r\nexport function computeForgeGoldFromInputs(coinsBn, levelBn) {\r\n  return computeForgeGold(coinsBn, levelBn);\r\n}\r\n\r\nexport function computeInfuseMagicFromInputs(coinsBn, cumulativeMpBn) {\r\n  return computeInfuseMagic(coinsBn, cumulativeMpBn);\r\n}\r\n\r\nexport function computeSurgeWavesFromInputs(xpLevelBn, coinsBn, goldBn, magicBn, mpBn) {\r\n  return computeSurgeWaves(xpLevelBn, coinsBn, goldBn, magicBn, mpBn);\r\n}\r\n\r\nexport function computePendingDnaFromInputs(labLevelBn, xpLevelBn, isSurge9Override = null) {\r\n    if (!labLevelBn) labLevelBn = bnZero();\r\n    if (!xpLevelBn) xpLevelBn = bnZero();\r\n    \r\n    let logBaseVal = 0.30103; // log10(2)\r\n    let logMultiplier = 0;\r\n\r\n    const useSurge9 = isSurge9Override !== null ? !!isSurge9Override : isSurgeActive(9);\r\n\r\n    if (useSurge9) {\r\n        const effectiveNerf = getEffectiveTsunamiNerf();\r\n        // Base: 2 + nerf (nerfed to 2 + 0.5*nerf for max 2.5)\r\n        logBaseVal = Math.log10(2 + effectiveNerf * 0.5);\r\n        // Multiplier: 10^(30*nerf) -> log10 is 30*nerf\r\n        logMultiplier = 30 * effectiveNerf;\r\n    }\r\n\r\n    if (isSurgeActive(14)) {\r\n        // Multiplier: 14.14e18\r\n        if (isSurgeActive(8)) {\r\n            const effectiveNerf = getEffectiveTsunamiNerf();\r\n            const log14 = Math.log10(14.14e18);\r\n            logMultiplier += log14 * effectiveNerf;\r\n        } else {\r\n            logMultiplier += Math.log10(14.14e18);\r\n        }\r\n    }\r\n\r\n    if (isSurgeActive(17)) {\r\n        if (isSurgeActive(8)) {\r\n            const effectiveNerf = getEffectiveTsunamiNerf();\r\n            logMultiplier -= 5 * effectiveNerf;\r\n        } else {\r\n            logMultiplier -= 5;\r\n        }\r\n    }\r\n\r\n    if (isSurgeActive(18)) {\r\n        if (isSurgeActive(8)) {\r\n            const effectiveNerf = getEffectiveTsunamiNerf();\r\n            logMultiplier -= 5 * effectiveNerf;\r\n        } else {\r\n            logMultiplier -= 5;\r\n        }\r\n    }\r\n\r\n    const logBaseStr = logBaseVal.toFixed(18);\r\n\r\n    try {\r\n        const labFactor = labLevelBn.mulDecimal(logBaseStr, 18);\r\n        const xpTerm = xpLevelBn.div(BigNum.fromInt(20));\r\n        const xpFactor = xpTerm.mulDecimal(logBaseStr, 18);\r\n        \r\n        let totalLog10 = labFactor.add(xpFactor);\r\n\r\n        if (logMultiplier > 0) {\r\n             totalLog10 = totalLog10.add(BigNum.fromAny(logMultiplier));\r\n        }\r\n        \r\n        let logVal = 0;\r\n        if (totalLog10.isInfinite()) {\r\n             logVal = Infinity;\r\n        } else {\r\n             logVal = Number(totalLog10.toScientific(10));\r\n        }\r\n        \r\n        return bigNumFromLog10(logVal).floorToInteger();\r\n    } catch (e) {\r\n        return bnZero();\r\n    }\r\n}\r\n\r\nfunction computeSurgeWaves(xpLevelBn, coinsBn, goldBn, magicBn, mpBn) {\r\n  const xpLevel = levelToNumber(xpLevelBn);\r\n  if (xpLevel < 201) return bnZero();\r\n\r\n  // Formula: 10 * 10^((XP - 201)/35) * Multipliers\r\n  const xpTerm = (xpLevel - 201) / 35;\r\n  \r\n  // Log-based multipliers\r\n  const logCoins = approxLog10BigNum(coinsBn);\r\n  const logGold = approxLog10BigNum(goldBn);\r\n  const logMagic = approxLog10BigNum(magicBn);\r\n  const logMp = approxLog10BigNum(mpBn);\r\n\r\n  // Handle Infinity\r\n  if (logCoins === Number.POSITIVE_INFINITY || \r\n      logGold === Number.POSITIVE_INFINITY || \r\n      logMagic === Number.POSITIVE_INFINITY || \r\n      logMp === Number.POSITIVE_INFINITY) {\r\n    return BN.fromAny('Infinity');\r\n  }\r\n\r\n  let logSum = 0;\r\n\r\n  if (Number.isFinite(logCoins) && logCoins > 24) {\r\n    logSum += (logCoins - 24) * LOG1_1;\r\n  }\r\n  if (Number.isFinite(logGold) && logGold > 13) {\r\n    logSum += (logGold - 13) * LOG1_1;\r\n  }\r\n  if (Number.isFinite(logMagic) && logMagic > 5) {\r\n    logSum += (logMagic - 5) * LOG1_1;\r\n  }\r\n  if (Number.isFinite(logMp) && logMp > 12) {\r\n    logSum += (logMp - 12) * LOG1_1;\r\n  }\r\n  \r\n  // Combine: 10 * 10^logSum * 10^(xpTerm)\r\n  // log10(Waves) = 1 + logSum + xpTerm\r\n  \r\n  let logTotal = 1 + logSum + xpTerm;\r\n\r\n  // Surge 17 and 18 halve Wave value (immune to exponent)\r\n  if (isSurgeActive(17)) logTotal -= Math.log10(2);\r\n  if (isSurgeActive(18)) logTotal -= Math.log10(2);\r\n\r\n  if (!Number.isFinite(logTotal)) return BN.fromAny('Infinity');\r\n  \r\n  const baseWaves = bigNumFromLog10(logTotal).floorToInteger();\r\n  return bank.waves?.mult?.applyTo?.(baseWaves) ?? baseWaves;\r\n}\r\n\r\nfunction getXpLevelNumber() {\r\n  return Math.max(0, levelToNumber(getXpLevelBn()));\r\n}\r\n\r\nfunction ensureResetSlot() {\r\n  if (resetState.slot != null) return resetState.slot;\r\n  const slot = getActiveSlot();\r\n  resetState.slot = slot;\r\n  return slot;\r\n}\r\n\r\nexport function setForgeResetCompleted(value) {\r\n  const slot = ensureResetSlot();\r\n  if (slot == null) return;\r\n  resetState.hasDoneForgeReset = !!value;\r\n  try { localStorage.setItem(FORGE_COMPLETED_KEY(slot), resetState.hasDoneForgeReset ? '1' : '0'); }\r\n  catch {}\r\n  try { window.dispatchEvent(new CustomEvent('forge:completed', { detail: { slot } })); }\r\n  catch {}\r\n}\r\n\r\nexport function setInfuseResetCompleted(value) {\r\n  const slot = ensureResetSlot();\r\n  if (slot == null) return;\r\n  resetState.hasDoneInfuseReset = !!value;\r\n  try { localStorage.setItem(INFUSE_COMPLETED_KEY(slot), resetState.hasDoneInfuseReset ? '1' : '0'); }\r\n  catch {}\r\n  try { window.dispatchEvent(new CustomEvent('unlock:change', { detail: { key: 'infuse', slot } })); }\r\n  catch {}\r\n}\r\n\r\nexport function setSurgeResetCompleted(value) {\r\n  const slot = ensureResetSlot();\r\n  if (slot == null) return;\r\n  resetState.hasDoneSurgeReset = !!value;\r\n  try { localStorage.setItem(SURGE_COMPLETED_KEY(slot), resetState.hasDoneSurgeReset ? '1' : '0'); }\r\n  catch {}\r\n  // Notify for \"Unlock Warp\" toggle in debug panel\r\n  try { window.dispatchEvent(new CustomEvent('unlock:change', { detail: { key: 'surge_completed', slot } })); }\r\n  catch {}\r\n}\r\n\r\nexport function setExperimentResetCompleted(value) {\r\n  const slot = ensureResetSlot();\r\n  if (slot == null) return;\r\n  resetState.hasDoneExperimentReset = !!value;\r\n  try { localStorage.setItem(EXPERIMENT_COMPLETED_KEY(slot), resetState.hasDoneExperimentReset ? '1' : '0'); }\r\n  catch {}\r\n  try { window.dispatchEvent(new CustomEvent('unlock:change', { detail: { key: 'experiment_completed', slot } })); }\r\n  catch {}\r\n}\r\n\r\nfunction getForgeDebugOverride(slot = getActiveSlot()) {\r\n  if (slot == null) return null;\r\n  try {\r\n    const raw = localStorage.getItem(FORGE_DEBUG_OVERRIDE_KEY(slot));\r\n    if (raw === '1') return true;\r\n    if (raw === '0') return false;\r\n  } catch {}\r\n  return null;\r\n}\r\n\r\nexport function getForgeDebugOverrideState(slot = getActiveSlot()) {\r\n  return getForgeDebugOverride(slot);\r\n}\r\n\r\nexport function setForgeDebugOverride(value, slot = getActiveSlot()) {\r\n  if (slot == null) return;\r\n  const normalized = value == null ? null : !!value;\r\n  if (resetState.forgeDebugOverride === normalized) return;\r\n\r\n  resetState.forgeDebugOverride = normalized;\r\n\r\n  if (normalized == null) {\r\n    try { localStorage.removeItem(FORGE_DEBUG_OVERRIDE_KEY(slot)); } catch {}\r\n  } else {\r\n    try { localStorage.setItem(FORGE_DEBUG_OVERRIDE_KEY(slot), normalized ? '1' : '0'); }\r\n    catch {}\r\n  }\r\n  primeStorageWatcherSnapshot(FORGE_DEBUG_OVERRIDE_KEY(slot));\r\n  notifyForgeUnlockChange();\r\n  updateResetPanel();\r\n}\r\n\r\nfunction getInfuseDebugOverride(slot = getActiveSlot()) {\r\n  if (slot == null) return null;\r\n  try {\r\n    const raw = localStorage.getItem(INFUSE_DEBUG_OVERRIDE_KEY(slot));\r\n    if (raw === '1') return true;\r\n    if (raw === '0') return false;\r\n  } catch {}\r\n  return null;\r\n}\r\n\r\nexport function getInfuseDebugOverrideState(slot = getActiveSlot()) {\r\n  return getInfuseDebugOverride(slot);\r\n}\r\n\r\nexport function setInfuseUnlockedForDebug(value) {\r\n  setInfuseUnlocked(value);\r\n}\r\n\r\nexport function setInfuseDebugOverride(value, slot = getActiveSlot()) {\r\n  if (slot == null) return;\r\n  const normalized = value == null ? null : !!value;\r\n  if (resetState.infuseDebugOverride === normalized) return;\r\n\r\n  resetState.infuseDebugOverride = normalized;\r\n\r\n  if (normalized == null) {\r\n    try { localStorage.removeItem(INFUSE_DEBUG_OVERRIDE_KEY(slot)); } catch {}\r\n  } else {\r\n    try { localStorage.setItem(INFUSE_DEBUG_OVERRIDE_KEY(slot), normalized ? '1' : '0'); }\r\n    catch {}\r\n  }\r\n  primeStorageWatcherSnapshot(INFUSE_DEBUG_OVERRIDE_KEY(slot));\r\n  notifyInfuseUnlockChange();\r\n  updateResetPanel();\r\n}\r\n\r\nfunction setInfuseUnlocked(value) {\r\n  const slot = ensureResetSlot();\r\n  if (slot == null) return;\r\n  const next = !!value;\r\n  if (resetState.infuseUnlocked === next) return;\r\n  resetState.infuseUnlocked = next;\r\n  try { localStorage.setItem(INFUSE_UNLOCK_KEY(slot), resetState.infuseUnlocked ? '1' : '0'); }\r\n  catch {}\r\n  primeStorageWatcherSnapshot(INFUSE_UNLOCK_KEY(slot));\r\n  notifyInfuseUnlockChange();\r\n}\r\n\r\nfunction setForgeUnlocked(value) {\r\n  const slot = ensureResetSlot();\r\n  if (slot == null) return;\r\n  const next = !!value;\r\n  if (resetState.forgeUnlocked === next) return;\r\n  resetState.forgeUnlocked = next;\r\n  try { localStorage.setItem(FORGE_UNLOCK_KEY(slot), resetState.forgeUnlocked ? '1' : '0'); }\r\n  catch {}\r\n  primeStorageWatcherSnapshot(FORGE_UNLOCK_KEY(slot));\r\n  notifyForgeUnlockChange();\r\n}\r\n\r\nfunction getSurgeDebugOverride(slot = getActiveSlot()) {\r\n  if (slot == null) return null;\r\n  try {\r\n    const raw = localStorage.getItem(SURGE_DEBUG_OVERRIDE_KEY(slot));\r\n    if (raw === '1') return true;\r\n    if (raw === '0') return false;\r\n  } catch {}\r\n  return null;\r\n}\r\n\r\nexport function getSurgeDebugOverrideState(slot = getActiveSlot()) {\r\n  return getSurgeDebugOverride(slot);\r\n}\r\n\r\nexport function setSurgeUnlockedForDebug(value) {\r\n  setSurgeUnlocked(value);\r\n}\r\n\r\nfunction setSurgeUnlocked(value) {\r\n  const slot = ensureResetSlot();\r\n  if (slot == null) return;\r\n  const next = !!value;\r\n  if (resetState.surgeUnlocked === next) return;\r\n  resetState.surgeUnlocked = next;\r\n  try { localStorage.setItem(SURGE_UNLOCK_KEY(slot), resetState.surgeUnlocked ? '1' : '0'); }\r\n  catch {}\r\n  primeStorageWatcherSnapshot(SURGE_UNLOCK_KEY(slot));\r\n  notifySurgeUnlockChange();\r\n}\r\n\r\nfunction readPersistentFlags(slot) {\r\n  if (slot == null) {\r\n    resetState.forgeUnlocked = false;\r\n    resetState.forgeDebugOverride = null;\r\n    resetState.hasDoneForgeReset = false;\r\n    resetState.infuseUnlocked = false;\r\n    resetState.infuseDebugOverride = null;\r\n    resetState.hasDoneInfuseReset = false;\r\n    resetState.surgeUnlocked = false;\r\n    resetState.surgeDebugOverride = null;\r\n    resetState.hasDoneSurgeReset = false;\r\n    resetState.hasDoneExperimentReset = false;\r\n    resetState.flagsPrimed = false;\r\n    return;\r\n  }\r\n  try {\r\n    resetState.forgeUnlocked = localStorage.getItem(FORGE_UNLOCK_KEY(slot)) === '1';\r\n  } catch {\r\n    resetState.forgeUnlocked = false;\r\n  }\r\n  resetState.forgeDebugOverride = getForgeDebugOverride(slot);\r\n  try {\r\n    resetState.hasDoneForgeReset = localStorage.getItem(FORGE_COMPLETED_KEY(slot)) === '1';\r\n  } catch {\r\n    resetState.hasDoneForgeReset = false;\r\n  }\r\n  try {\r\n    resetState.infuseUnlocked = localStorage.getItem(INFUSE_UNLOCK_KEY(slot)) === '1';\r\n  } catch {\r\n    resetState.infuseUnlocked = false;\r\n  }\r\n  try {\r\n    resetState.hasDoneInfuseReset = localStorage.getItem(INFUSE_COMPLETED_KEY(slot)) === '1';\r\n  } catch {\r\n    resetState.hasDoneInfuseReset = false;\r\n  }\r\n  resetState.infuseDebugOverride = getInfuseDebugOverride(slot);\r\n  \r\n  try {\r\n    resetState.surgeUnlocked = localStorage.getItem(SURGE_UNLOCK_KEY(slot)) === '1';\r\n  } catch {\r\n    resetState.surgeUnlocked = false;\r\n  }\r\n  resetState.surgeDebugOverride = getSurgeDebugOverride(slot);\r\n  try {\r\n    resetState.hasDoneSurgeReset = localStorage.getItem(SURGE_COMPLETED_KEY(slot)) === '1';\r\n  } catch {\r\n    resetState.hasDoneSurgeReset = false;\r\n  }\r\n  try {\r\n    resetState.hasDoneExperimentReset = localStorage.getItem(EXPERIMENT_COMPLETED_KEY(slot)) === '1';\r\n  } catch {\r\n    resetState.hasDoneExperimentReset = false;\r\n  }\r\n\r\n  resetState.flagsPrimed = true;\r\n}\r\n\r\nfunction ensurePersistentFlagsPrimed() {\r\n  const slot = getActiveSlot();\r\n  if (slot == null) {\r\n    resetState.flagsPrimed = false;\r\n    return;\r\n  }\r\n  if (resetState.slot !== slot) {\r\n    resetState.slot = slot;\r\n    resetPendingGoldSignature();\r\n    resetState.flagsPrimed = false;\r\n  }\r\n  if (!resetState.flagsPrimed) {\r\n    readPersistentFlags(slot);\r\n  }\r\n}\r\n\r\nfunction bindStorageWatchers(slot) {\r\n  if (watchersBoundSlot === slot) return;\r\n  cleanupWatchers();\r\n  watchersBoundSlot = slot;\r\n  if (slot == null) return;\r\n  watchers.push(watchStorageKey(FORGE_UNLOCK_KEY(slot), {\r\n    onChange(value) {\r\n      const next = value === '1';\r\n      if (resetState.forgeUnlocked !== next) {\r\n        resetState.forgeUnlocked = next;\r\n        notifyForgeUnlockChange();\r\n        updateResetPanel();\r\n      }\r\n    },\r\n  }));\r\n  watchers.push(watchStorageKey(FORGE_COMPLETED_KEY(slot), {\r\n    onChange(value) {\r\n      const next = value === '1';\r\n      if (resetState.hasDoneForgeReset !== next) {\r\n        resetState.hasDoneForgeReset = next;\r\n        updateResetPanel();\r\n      }\r\n    },\r\n  }));\r\n  watchers.push(watchStorageKey(FORGE_DEBUG_OVERRIDE_KEY(slot), {\r\n    onChange(value) {\r\n      let next = null;\r\n      if (value === '1') next = true;\r\n      else if (value === '0') next = false;\r\n      if (resetState.forgeDebugOverride !== next) {\r\n        resetState.forgeDebugOverride = next;\r\n        notifyForgeUnlockChange();\r\n        updateResetPanel();\r\n      }\r\n    },\r\n  }));\r\n  watchers.push(watchStorageKey(INFUSE_UNLOCK_KEY(slot), {\r\n    onChange(value) {\r\n      const next = value === '1';\r\n      if (resetState.infuseUnlocked !== next) {\r\n        resetState.infuseUnlocked = next;\r\n        notifyInfuseUnlockChange();\r\n        updateResetPanel();\r\n      }\r\n    },\r\n  }));\r\n  watchers.push(watchStorageKey(INFUSE_COMPLETED_KEY(slot), {\r\n    onChange(value) {\r\n      const next = value === '1';\r\n      if (resetState.hasDoneInfuseReset !== next) {\r\n        resetState.hasDoneInfuseReset = next;\r\n        updateResetPanel();\r\n      }\r\n    },\r\n  }));\r\n  watchers.push(watchStorageKey(INFUSE_DEBUG_OVERRIDE_KEY(slot), {\r\n    onChange(value) {\r\n      let next = null;\r\n      if (value === '1') next = true;\r\n      else if (value === '0') next = false;\r\n      if (resetState.infuseDebugOverride !== next) {\r\n        resetState.infuseDebugOverride = next;\r\n        notifyInfuseUnlockChange();\r\n        updateResetPanel();\r\n      }\r\n    },\r\n  }));\r\n  watchers.push(watchStorageKey(SURGE_UNLOCK_KEY(slot), {\r\n    onChange(value) {\r\n      const next = value === '1';\r\n      if (resetState.surgeUnlocked !== next) {\r\n        resetState.surgeUnlocked = next;\r\n        notifySurgeUnlockChange();\r\n        updateResetPanel();\r\n      }\r\n    },\r\n  }));\r\n  watchers.push(watchStorageKey(SURGE_DEBUG_OVERRIDE_KEY(slot), {\r\n    onChange(value) {\r\n      let next = null;\r\n      if (value === '1') next = true;\r\n      else if (value === '0') next = false;\r\n      if (resetState.surgeDebugOverride !== next) {\r\n        resetState.surgeDebugOverride = next;\r\n        notifySurgeUnlockChange();\r\n        updateResetPanel();\r\n      }\r\n    },\r\n  }));\r\n  watchers.push(watchStorageKey(SURGE_COMPLETED_KEY(slot), {\r\n    onChange(value) {\r\n      const next = value === '1';\r\n      if (resetState.hasDoneSurgeReset !== next) {\r\n        resetState.hasDoneSurgeReset = next;\r\n        updateResetPanel();\r\n      }\r\n    },\r\n  }));\r\n  watchers.push(watchStorageKey(EXPERIMENT_COMPLETED_KEY(slot), {\r\n    onChange(value) {\r\n      const next = value === '1';\r\n      if (resetState.hasDoneExperimentReset !== next) {\r\n        resetState.hasDoneExperimentReset = next;\r\n        updateResetPanel();\r\n      }\r\n    },\r\n  }));\r\n}\r\n\r\nfunction getPendingInputSignature(coins, level) {\r\n  const coinSig = coins?.toStorage?.()\r\n    ?? coins?.toString?.()\r\n    ?? String(coins ?? '');\r\n  const levelSig = level?.toStorage?.()\r\n    ?? level?.toString?.()\r\n    ?? String(level ?? '');\r\n  return `${coinSig}|${levelSig}`;\r\n}\r\n\r\nfunction recomputePendingGold(force = false) {\r\n  const coins = bank.coins?.value ?? bnZero();\r\n  const level = getXpLevelBn();\r\n  const signature = getPendingInputSignature(coins, level);\r\n  if (!force && pendingGoldInputSignature === signature) {\r\n    return;\r\n  }\r\n  pendingGoldInputSignature = signature;\r\n\r\n  if (!meetsLevelRequirement()) {\r\n    resetState.pendingGold = bnZero();\r\n  } else {\r\n    resetState.pendingGold = computeForgeGold(coins, level);\r\n  }\r\n\r\n  updateResetPanel();\r\n}\r\n\r\nexport function recomputePendingMagic(multiplierOverride = null) {\r\n  const coins = bank.coins?.value ?? bnZero();\r\n  const cumulativeMp = getTotalCumulativeMp();\r\n  \r\n  if (!meetsInfuseRequirement()) {\r\n    resetState.pendingMagic = bnZero();\r\n  } else {\r\n    resetState.pendingMagic = computeInfuseMagic(coins, cumulativeMp, multiplierOverride);\r\n  }\r\n  recomputePendingWaves();\r\n  updateResetPanel();\r\n}\r\n\r\nfunction recomputePendingWaves() {\r\n  if (!isSurgeUnlocked()) {\r\n    resetState.pendingWaves = bnZero();\r\n    recomputePendingDna();\r\n    return;\r\n  }\r\n  const xpLevel = getXpLevelBn();\r\n  const coins = bank.coins?.value ?? bnZero();\r\n  const gold = bank.gold?.value ?? bnZero();\r\n  const magic = bank.magic?.value ?? bnZero();\r\n  const mp = getTotalCumulativeMp();\r\n\r\n  resetState.pendingWaves = computeSurgeWaves(xpLevel, coins, gold, magic, mp);\r\n\r\n  if (!hasDoneSurgeReset()) {\r\n    if (resetState.pendingWaves.cmp(BN.fromInt(10)) > 0) {\r\n      resetState.pendingWaves = BN.fromInt(10);\r\n    }\r\n  }\r\n  recomputePendingDna();\r\n  updateBlockBigCoinsStatus();\r\n}\r\n\r\nfunction recomputePendingDna() {\r\n    if (!isExperimentUnlocked()) {\r\n        resetState.pendingDna = bnZero();\r\n        return;\r\n    }\r\n    \r\n    let logBaseVal = 0.30103; // log10(2)\r\n    let logMultiplier = 0;\r\n\r\n    if (isSurgeActive(9)) {\r\n        const effectiveNerf = getEffectiveTsunamiNerf();\r\n        // Base: 2 + nerf (nerfed to 2 + 0.5*nerf for max 2.5)\r\n        logBaseVal = Math.log10(2 + effectiveNerf * 0.5);\r\n        // Multiplier: 10^(30*nerf) -> log10 is 30*nerf\r\n        logMultiplier = 30 * effectiveNerf;\r\n    }\r\n\r\n    if (isSurgeActive(14)) {\r\n        // Multiplier: 14.14e6\r\n        if (isSurgeActive(8)) {\r\n            const effectiveNerf = getEffectiveTsunamiNerf();\r\n            const log14 = Math.log10(14.14e6);\r\n            logMultiplier += log14 * effectiveNerf;\r\n        } else {\r\n            logMultiplier += Math.log10(14.14e6);\r\n        }\r\n    }\r\n\r\n    if (isSurgeActive(17)) {\r\n        if (isSurgeActive(8)) {\r\n            const effectiveNerf = getEffectiveTsunamiNerf();\r\n            logMultiplier -= 5 * effectiveNerf;\r\n        } else {\r\n            logMultiplier -= 5;\r\n        }\r\n    }\r\n\r\n    if (isSurgeActive(18)) {\r\n        if (isSurgeActive(8)) {\r\n            const effectiveNerf = getEffectiveTsunamiNerf();\r\n            logMultiplier -= 5 * effectiveNerf;\r\n        } else {\r\n            logMultiplier -= 5;\r\n        }\r\n    }\r\n\r\n    const logBaseStr = logBaseVal.toFixed(18);\r\n\r\n    // Formula: Multiplier * Base^labLevel * Base^(xpLevel/20)\r\n    const labLevel = getLabLevel ? getLabLevel() : bnZero();\r\n    const xpLevel = getXpLevelBn();\r\n    try {\r\n        const labFactor = labLevel.mulDecimal(logBaseStr, 18);\r\n        const xpTerm = xpLevel.div(BigNum.fromInt(20));\r\n        const xpFactor = xpTerm.mulDecimal(logBaseStr, 18);\r\n        \r\n        let totalLog10 = labFactor.add(xpFactor);\r\n\r\n        if (logMultiplier > 0) {\r\n             totalLog10 = totalLog10.add(BigNum.fromAny(logMultiplier));\r\n        }\r\n        \r\n        let logVal = 0;\r\n        if (totalLog10.isInfinite()) {\r\n             logVal = Infinity;\r\n        } else {\r\n             // toScientific returns string, Number() parses it.\r\n             logVal = Number(totalLog10.toScientific(10));\r\n        }\r\n        \r\n        resetState.pendingDna = bigNumFromLog10(logVal).floorToInteger();\r\n    } catch (e) {\r\n        // Fallback for extreme values or errors\r\n        // Simplified fallback: 2^labLevel\r\n        try {\r\n             // If calculation fails, assume 0 for safety\r\n             resetState.pendingDna = bnZero();\r\n        } catch {\r\n             resetState.pendingDna = bnZero();\r\n        }\r\n    }\r\n}\r\n\r\nfunction canAccessForgeTab() {\r\n  const override = getForgeDebugOverride();\r\n  if (override != null) return !!override;\r\n  return resetState.forgeUnlocked || getLevelNumber(AREA_KEYS.STARTER_COVE, UPGRADE_TIES.UNLOCK_FORGE) >= 1;\r\n}\r\n\r\nfunction meetsLevelRequirement() {\r\n  try {\r\n    const levelBn = getXpLevelBn();\r\n    if (levelBn && typeof levelBn.cmp === 'function') {\r\n      return levelBn.cmp(MIN_FORGE_LEVEL) >= 0;\r\n    }\r\n  } catch {}\r\n  return false;\r\n}\r\n\r\nfunction meetsInfuseRequirement() {\r\n  try {\r\n    const mState = getMutationState();\r\n    if (mState && mState.level && typeof mState.level.cmp === 'function') {\r\n      return mState.level.cmp(MIN_INFUSE_MUTATION_LEVEL) >= 0;\r\n    }\r\n  } catch {}\r\n  return false;\r\n}\r\n\r\nexport function isForgeUnlocked() {\r\n  ensurePersistentFlagsPrimed();\r\n  const override = getForgeDebugOverride();\r\n  if (override != null) return !!override;\r\n  return !!resetState.forgeUnlocked || canAccessForgeTab();\r\n}\r\n\r\nexport function isInfuseUnlocked() {\r\n  ensurePersistentFlagsPrimed();\r\n  const override = getInfuseDebugOverride();\r\n  if (override != null) return !!override;\r\n  return !!resetState.infuseUnlocked;\r\n}\r\n\r\nexport function isSurgeUnlocked() {\r\n  ensurePersistentFlagsPrimed();\r\n  const override = getSurgeDebugOverride();\r\n  if (override != null) return !!override;\r\n  return !!resetState.surgeUnlocked;\r\n}\r\n\r\nexport function isExperimentUnlocked() {\r\n    return isLabExperimentUnlocked();\r\n}\r\n\r\nexport function getCurrentSurgeLevel() {\r\n  const slot = ensureResetSlot();\r\n  if (slot == null) return 0n;\r\n  return getSurgeBarLevel(slot);\r\n}\r\n\r\nexport function hasDoneForgeReset() {\r\n  ensurePersistentFlagsPrimed();\r\n  return !!resetState.hasDoneForgeReset;\r\n}\r\n\r\nexport function hasDoneInfuseReset() {\r\n  ensurePersistentFlagsPrimed();\r\n  return !!resetState.hasDoneInfuseReset;\r\n}\r\n\r\nexport function hasDoneSurgeReset() {\r\n  ensurePersistentFlagsPrimed();\r\n  return !!resetState.hasDoneSurgeReset;\r\n}\r\n\r\nexport function hasDoneExperimentReset() {\r\n  ensurePersistentFlagsPrimed();\r\n  return !!resetState.hasDoneExperimentReset;\r\n}\r\n\r\nexport function computePendingForgeGold() {\r\n  recomputePendingGold();\r\n  return resetState.pendingGold.clone?.() ?? resetState.pendingGold;\r\n}\r\n\r\nexport function canPerformForgeReset() {\r\n  if (!isForgeUnlocked()) return false;\r\n  if (!meetsLevelRequirement()) return false;\r\n  if (resetState.pendingGold.isZero?.()) return false;\r\n  return true;\r\n}\r\n\r\nexport function canPerformInfuseReset() {\r\n  if (!isInfuseUnlocked()) return false;\r\n  if (!meetsInfuseRequirement()) return false;\r\n  if (resetState.pendingMagic.isZero?.()) return false;\r\n  return true;\r\n}\r\n\r\nfunction resetUpgrades({ resetGold = false, resetMagic = false } = {}) {\r\n  const upgrades = getUpgradesForArea(AREA_KEYS.STARTER_COVE);\r\n  for (const upg of upgrades) {\r\n    if (!upg) continue;\r\n    const tieKey = upg.tieKey || upg.tie;\r\n    if (tieKey === UPGRADE_TIES.UNLOCK_XP || tieKey === UPGRADE_TIES.UNLOCK_FORGE || tieKey === UPGRADE_TIES.UNLOCK_INFUSE || tieKey === UPGRADE_TIES.UNLOCK_SURGE) continue;\r\n    if (upg.costType === 'gold' && !resetGold) continue;\r\n    if (upg.costType === 'magic' && !resetMagic) continue;\r\n    setLevel(AREA_KEYS.STARTER_COVE, upg.id, 0, true, { resetHmEvolutions: true });\r\n  }\r\n}\r\n\r\nfunction applyForgeResetEffects({ resetGold = false, resetMagic = false } = {}) {\r\n  try { bank.coins.set(0); } catch {}\r\n  try { bank.books.set(0); } catch {}\r\n  try { resetXpProgress({ keepUnlock: true }); } catch {}\r\n  try { clearPendingGains(); } catch {}\r\n  resetUpgrades({ resetGold, resetMagic });\r\n}\r\n\r\nexport function performForgeReset() {\r\n  if (!canPerformForgeReset()) return false;\r\n  const finalReward = getPendingGoldWithMultiplier();\r\n  try {\r\n    if (bank.gold?.add) {\r\n      bank.gold.add(finalReward);\r\n    }\r\n  } catch {}\r\n  \r\n  applyForgeResetEffects({ resetGold: false });\r\n\r\n  recomputePendingGold();\r\n  setForgeUnlocked(true);\r\n  if (!resetState.hasDoneForgeReset) {\r\n    setForgeResetCompleted(true);\r\n  }\r\n  initMutationSystem();\r\n  unlockMutationSystem();\r\n  \r\n  if (shouldWipePlayfield('forge')) {\r\n    try { window.spawner?.clearPlayfield?.('forge'); } catch {}\r\n  }\r\n\r\n  updateResetPanel();\r\n  return true;\r\n}\r\n\r\nexport function performInfuseReset() {\r\n  if (!canPerformInfuseReset()) return false;\r\n  const reward = resetState.pendingMagic.clone?.() ?? resetState.pendingMagic;\r\n  try {\r\n    if (bank.magic?.add) {\r\n       bank.magic.add(reward);\r\n    }\r\n  } catch {}\r\n\r\n  applyForgeResetEffects({ resetGold: true });\r\n\r\n  try { bank.gold.set(0); } catch {}\r\n  \r\n  try {\r\n     const slot = getActiveSlot();\r\n     const KEY_LEVEL = (s) => `ccc:mutation:level:${s}`;\r\n     const KEY_PROGRESS = (s) => `ccc:mutation:progress:${s}`;\r\n     localStorage.setItem(KEY_LEVEL(slot), '0');\r\n     localStorage.setItem(KEY_PROGRESS(slot), '0');\r\n     initMutationSystem({ forceReload: true });\r\n  } catch {}\r\n\r\n  recomputePendingGold();\r\n  recomputePendingMagic();\r\n  \r\n  if (shouldWipePlayfield('infuse')) {\r\n    try { window.spawner?.clearPlayfield?.('infuse'); } catch {}\r\n  }\r\n\r\n  setInfuseUnlocked(true);\r\n  if (!resetState.hasDoneInfuseReset) {\r\n    setInfuseResetCompleted(true);\r\n  }\r\n\r\n  updateResetPanel();\r\n  return true;\r\n}\r\n\r\nfunction applySurgeResetLogic(rewardWaves, { playEffects = true, skipVisuals = false } = {}) {\r\n  const slot = ensureResetSlot();\r\n\r\n  try {\r\n    if (bank.waves?.add && rewardWaves && !rewardWaves.isZero?.()) {\r\n      bank.waves.add(rewardWaves);\r\n    }\r\n  } catch {}\r\n\r\n  applyForgeResetEffects({ resetGold: true, resetMagic: true });\r\n  try { bank.gold.set(0); } catch {}\r\n  try { bank.magic.set(0); } catch {}\r\n  \r\n  try {\r\n     const KEY_LEVEL = (s) => `ccc:mutation:level:${s}`;\r\n     const KEY_PROGRESS = (s) => `ccc:mutation:progress:${s}`;\r\n     localStorage.setItem(KEY_LEVEL(slot), '0');\r\n     localStorage.setItem(KEY_PROGRESS(slot), '0');\r\n     initMutationSystem({ forceReload: true });\r\n  } catch {}\r\n\r\n  updateWaveBar();\r\n\r\n  setSurgeUnlocked(true);\r\n  if (!resetState.hasDoneSurgeReset) {\r\n    setSurgeResetCompleted(true);\r\n  }\r\n\r\n  recomputePendingGold();\r\n  recomputePendingMagic();\r\n  recomputePendingWaves();\r\n  \r\n  if (playEffects) {\r\n      if (!skipVisuals) playSurgeResetSound();\r\n      if (!skipVisuals) triggerSurgeWaveAnimation();\r\n  }\r\n\r\n  if (shouldWipePlayfield('surge')) {\r\n    try { window.spawner?.clearPlayfield?.('surge'); } catch {}\r\n  }\r\n  \r\n  updateResetPanel();\r\n}\r\n\r\nfunction performExperimentReset() {\r\n    if (!isExperimentUnlocked()) return false;\r\n    \r\n    // Check Requirements\r\n    const labLevel = getLabLevel ? getLabLevel() : bnZero();\r\n    if (labLevel.cmp(10) < 0) return false;\r\n    \r\n    const reward = resetState.pendingDna.clone?.() ?? resetState.pendingDna;\r\n    \r\n    // Grant DNA\r\n    try {\r\n        if (bank.DNA?.add) {\r\n            bank.DNA.add(reward);\r\n        }\r\n    } catch {}\r\n    \r\n    // Trigger Surge Reset Logic (wipes everything Surge does)\r\n    // Pass 0 waves because we aren't giving waves, just using the wipe mechanic\r\n    applySurgeResetLogic(bnZero(), { playEffects: false });\r\n    \r\n    playExperimentResetSound();\r\n\r\n    // Wipe Lab (except node 4)\r\n    resetLab([4]);\r\n    \r\n    // Set Completed Flag\r\n    if (!resetState.hasDoneExperimentReset) {\r\n        setExperimentResetCompleted(true);\r\n    }\r\n    \r\n    // Update UI\r\n    recomputePendingGold();\r\n    recomputePendingMagic();\r\n    recomputePendingWaves();\r\n    recomputePendingDna();\r\n    updateResetPanel();\r\n    \r\n    return true;\r\n}\r\n\r\nlet tsunamiCleanup = null;\r\n\r\nfunction startTsunamiSequence() {\r\n    // 1. Dispatch music stop\r\n    if (typeof window !== 'undefined') window.dispatchEvent(new CustomEvent('audio:stopMusic'));\r\n    \r\n    // 2. Stop spawning\r\n    if (window.spawner && typeof window.spawner.stop === 'function') {\r\n        window.spawner.stop();\r\n    }\r\n    \r\n    // 3. Close overlays\r\n    try { closeShop(true); } catch {}\r\n    try { closeMerchant(); } catch {}\r\n    \r\n    // 4. Black screen overlay\r\n    const overlay = document.createElement('div');\r\n    overlay.id = 'tsunami-sequence-overlay';\r\n    overlay.style.position = 'fixed';\r\n    overlay.style.inset = '0';\r\n    overlay.style.backgroundColor = 'black';\r\n    overlay.style.zIndex = '2147483645';\r\n    overlay.style.pointerEvents = 'all';\r\n    document.body.appendChild(overlay);\r\n    \r\n    // 5. Set active flag\r\n    window.__tsunamiActive = true;\r\n    \r\n    // 6. Set Seen Flag (immediately, to prevent softlock/re-sequence if user quits early)\r\n    setTsunamiSequenceSeen(true);\r\n    \r\n    // 7. Capture State for Visuals\r\n    const coinCounter = document.querySelector('.coin-counter');\r\n    const xpCounter = document.querySelector('.xp-counter');\r\n    const mpCounter = document.querySelector('.mp-counter');\r\n    const visualOptions = {\r\n        coinHTML: coinCounter ? coinCounter.outerHTML : '',\r\n        xpHTML: xpCounter ? xpCounter.outerHTML : '',\r\n        mpHTML: mpCounter ? mpCounter.outerHTML : ''\r\n    };\r\n\r\n    // 8. Start Visuals\r\n    // Restored 60000ms duration for proper storm buildup/blackout timing\r\n    // onComplete now signifies \"Ready for Dialogue\" (screen is black)\r\n    const controls = playTsunamiSequence(overlay, 60000, () => {\r\n        // 9. Start Dialogue (Screen is black, visuals still running in background)\r\n        if (controls && controls.showCursor) controls.showCursor();\r\n        \r\n        runTsunamiDialogue(overlay, () => {\r\n            // Dialogue/Crazy Stuff finished\r\n            setTimeout(endTsunamiSequence, 0);\r\n        }, controls);\r\n    }, visualOptions);\r\n    \r\n    tsunamiCleanup = controls.cleanup;\r\n}\r\n\r\nfunction endTsunamiSequence() {\r\n    if (tsunamiCleanup) {\r\n        tsunamiCleanup();\r\n        tsunamiCleanup = null;\r\n    }\r\n\r\n    // 1. Remove overlay\r\n    const overlay = document.getElementById('tsunami-sequence-overlay');\r\n    if (overlay) overlay.remove();\r\n    \r\n    // 2. Force Reset (0 waves, no effects)\r\n    applySurgeResetLogic(BigNum.fromInt(0), { playEffects: false });\r\n    \r\n    // 4. Restart music\r\n    if (typeof window !== 'undefined') window.dispatchEvent(new CustomEvent('audio:restartMusic'));\r\n    \r\n    // 5. Resume spawning\r\n    if (window.spawner && typeof window.spawner.start === 'function') {\r\n        window.spawner.start();\r\n    }\r\n    \r\n    // 6. Clear active flag\r\n    window.__tsunamiActive = false;\r\n\r\n    // 7. Set Dialogue Pending Flag\r\n    const slot = getActiveSlot();\r\n    if (slot != null) {\r\n        try { localStorage.setItem(`ccc:tsunami:dialoguePending:${slot}`, '1'); } catch {}\r\n    }\r\n}\r\n\r\nexport function performSurgeReset() {\r\n  if (!isSurgeUnlocked()) return false;\r\n  if (getXpLevelNumber() < 201) return false;\r\n  \r\n  const reward = resetState.pendingWaves.clone?.() ?? resetState.pendingWaves;\r\n  if (reward.isZero?.()) return false;\r\n\r\n  const slot = ensureResetSlot();\r\n  \r\n  // Calculate if we hit Surge 8\r\n  const currentWaves = bank.waves?.value ?? bnZero();\r\n  const barLevel = getSurgeBarLevel(slot);\r\n  const potentialLevel = predictSurgeLevel(barLevel, currentWaves, reward);\r\n  \r\n  let isSurge8 = false;\r\n  if (potentialLevel === Infinity) isSurge8 = true;\r\n  else if (typeof potentialLevel === 'bigint') isSurge8 = potentialLevel >= 8n;\r\n  else if (typeof potentialLevel === 'number') isSurge8 = potentialLevel >= 8;\r\n  \r\n  // Check sequence condition\r\n  if (isSurge8 && !getTsunamiSequenceSeen()) {\r\n      // Trigger sequence logic\r\n      startTsunamiSequence();\r\n      \r\n      // First reset (give waves, reset stuff), but NO visuals/sound\r\n      // We do this after starting sequence so the visualizer captures pre-reset XP/MP\r\n      applySurgeResetLogic(reward, { playEffects: false });\r\n      return true;\r\n  }\r\n\r\n  // Normal reset\r\n  applySurgeResetLogic(reward, { playEffects: true });\r\n  return true;\r\n}\r\n\r\nfunction triggerSurgeWaveAnimation() {\r\n  if (typeof document === 'undefined') return;\r\n  const existing = document.querySelector('.surge-wipe-overlay');\r\n  if (existing) existing.remove();\r\n\r\n  const overlay = document.createElement('div');\r\n  overlay.className = 'surge-wipe-overlay';\r\n  \r\n  const wave = document.createElement('div');\r\n  wave.className = 'surge-wipe-wave';\r\n  \r\n  overlay.appendChild(wave);\r\n  document.body.appendChild(overlay);\r\n\r\n  void wave.offsetWidth;\r\n  wave.classList.add('animate');\r\n\r\n  wave.addEventListener('animationend', () => {\r\n     overlay.remove();\r\n  }, { once: true });\r\n  \r\n  setTimeout(() => {\r\n     if (document.body.contains(overlay)) overlay.remove();\r\n  }, 2000);\r\n}\r\n\r\nfunction getSurgeBarLevel(slot) {\r\n  let barLevel = 0n;\r\n  try {\r\n    const raw = localStorage.getItem(SURGE_BAR_LEVEL_KEY(slot));\r\n    if (raw) {\r\n       if (raw === 'Infinity') return Infinity;\r\n       barLevel = BigInt(raw);\r\n    }\r\n  } catch {}\r\n  if (barLevel === Infinity) return Infinity;\r\n  return barLevel < 0n ? 0n : barLevel;\r\n}\r\n\r\nfunction isSurgeLevelLocked(slot) {\r\n  const key = SURGE_BAR_LEVEL_KEY(slot);\r\n  if (typeof window !== 'undefined' && window.__cccLockedStorageKeys instanceof Set) {\r\n    return window.__cccLockedStorageKeys.has(key);\r\n  }\r\n  return false;\r\n}\r\n\r\nfunction getSafeLog10BigInt(bn) {\r\n  if (!(bn instanceof BN)) return -1n;\r\n  if (bn.isZero?.() || bn.isInfinite?.()) return -1n;\r\n  let totalExp = BigInt(bn.e || 0);\r\n  if (bn._eOffset) totalExp += bn._eOffset;\r\n  const s = bn.sig.toString();\r\n  const sigLog = BigInt(s.length - 1);\r\n  return totalExp + sigLog;\r\n}\r\n\r\nfunction calculateSurgeLevelJump(startLevelBigInt, wavesBn) {\r\n  if (startLevelBigInt === Infinity || (typeof startLevelBigInt === 'string' && startLevelBigInt === 'Infinity')) {\r\n    return { level: Infinity, remainingWaves: wavesBn, changed: false, safety: 0 };\r\n  }\r\n\r\n  let currentWaves = wavesBn.clone ? wavesBn.clone() : wavesBn;\r\n  if (currentWaves.isInfinite?.()) {\r\n    return { level: Infinity, remainingWaves: currentWaves, changed: true, safety: 0 };\r\n  }\r\n\r\n  let barLevel = startLevelBigInt;\r\n  let req = new BigNum(10n, { base: 0, offset: barLevel });\r\n  let changed = false;\r\n\r\n  // Optimization for massive waves: jump to the approximate level\r\n  const logCurrentBigInt = getSafeLog10BigInt(currentWaves);\r\n  const logReqBigInt = getSafeLog10BigInt(req);\r\n\r\n  if (logCurrentBigInt != -1n && logReqBigInt != -1n && logCurrentBigInt > logReqBigInt + 5n) {\r\n    try {\r\n      const targetLevel = logCurrentBigInt > 0n ? logCurrentBigInt - 1n : 0n;\r\n\r\n      if (targetLevel > barLevel) {\r\n        const nextReq = new BigNum(10n, { base: 0, offset: targetLevel });\r\n\r\n        // Cost = (10^(targetLevel+1) - 10^(barLevel+1)) / 9\r\n        const cost = nextReq.sub(req).div(BigNum.fromInt(9));\r\n\r\n        if (currentWaves.cmp(cost) >= 0) {\r\n          currentWaves = currentWaves.sub(cost);\r\n          barLevel = targetLevel;\r\n          changed = true;\r\n          req = nextReq;\r\n        }\r\n      }\r\n    } catch {}\r\n  }\r\n\r\n  let safety = 0;\r\n\r\n  while (safety < 100) {\r\n    if (currentWaves.cmp(req) < 0) break;\r\n\r\n    currentWaves = currentWaves.sub(req);\r\n\r\n    barLevel += 1n;\r\n    changed = true;\r\n\r\n    req = req.mulBigNumInteger(BigNum.fromInt(10));\r\n    safety++;\r\n  }\r\n  \r\n  return { level: barLevel, remainingWaves: currentWaves, changed, safety };\r\n}\r\n\r\nfunction updateWaveBar() {\r\n  const slot = ensureResetSlot();\r\n  if (slot == null) return;\r\n  if (!isSurgeUnlocked()) return;\r\n  if (isUpdatingWaveBar) return;\r\n  if (isSurgeLevelLocked(slot)) return;\r\n\r\n  const currentWaves = bank.waves?.value ?? bnZero();\r\n  \r\n  let barLevel = getSurgeBarLevel(slot);\r\n  if (barLevel === Infinity) return;\r\n\r\n  const result = calculateSurgeLevelJump(barLevel, currentWaves);\r\n  \r\n  if (result.changed) {\r\n      barLevel = result.level;\r\n      try { localStorage.setItem(SURGE_BAR_LEVEL_KEY(slot), barLevel.toString()); } catch {}\r\n      try { window.dispatchEvent(new CustomEvent(\"surge:level:change\", { detail: { slot, level: barLevel } })); } catch {}\r\n      \r\n      isUpdatingWaveBar = true;\r\n      try {\r\n        bank.waves.set(result.remainingWaves);\r\n      } finally {\r\n        isUpdatingWaveBar = false;\r\n      }\r\n\r\n      updateResetPanel();\r\n\r\n      if (result.safety >= 100) {\r\n        setTimeout(updateWaveBar, 0);\r\n      }\r\n  }\r\n  updateBlockBigCoinsStatus();\r\n}\r\n\r\nfunction formatBn(value) {\r\n  if (value === Infinity || (value && (value === 'Infinity' || (typeof value.isInfinite === 'function' && value.isInfinite())))) {\r\n    return '<span class=\"infinity-symbol\">\u221E</span>';\r\n  }\r\n  let bn = value;\r\n  if (typeof value === 'bigint') {\r\n    try { bn = BN.fromInt(value); } catch {}\r\n  }\r\n  try { return formatNumber(bn); }\r\n  catch { return value?.toString?.() ?? '0'; }\r\n}\r\n\r\n\r\nfunction generateDnaSvgDataUri() {\r\n  const w = 120; // Tile width matching CSS animation\r\n  const h = 100; // coordinate system height\r\n  const colors = { red: '#d93629', blue: '#4ba7d8' };\r\n  \r\n  let paths = [];\r\n  \r\n  // Rungs (8 per period)\r\n  for(let i=0; i<8; i++) {\r\n      const x = (i/8) * w;\r\n      const angle = (i/8) * Math.PI * 2;\r\n      const y1 = 50 + 30 * Math.sin(angle);\r\n      const y2 = 50 + 30 * Math.sin(angle + Math.PI);\r\n      \r\n      paths.push(`<line x1=\"${x.toFixed(1)}\" y1=\"${y1.toFixed(1)}\" x2=\"${x.toFixed(1)}\" y2=\"${y2.toFixed(1)}\" stroke=\"#ffffff\" stroke-width=\"2\" />`);\r\n  }\r\n\r\n  const segments = 20; \r\n  \r\n  // Function to generate path d attribute\r\n  const getPath = (startAngle, endAngle, color, phaseOffset) => {\r\n      let d = \"\";\r\n      for (let i=0; i<=segments; i++) {\r\n          const t = i / segments;\r\n          const angle = startAngle + t * (endAngle - startAngle);\r\n          const x = (angle / (Math.PI * 2)) * w;\r\n          const y = 50 + 30 * Math.sin(angle + phaseOffset);\r\n          d += (i===0 ? \"M\" : \"L\") + ` ${x.toFixed(1)} ${y.toFixed(1)}`;\r\n      }\r\n      return `<path d=\"${d}\" stroke=\"${color}\" stroke-width=\"6\" fill=\"none\" stroke-linecap=\"butt\" />`;\r\n  };\r\n\r\n  const overlap = 0.2; // Extend lines slightly to prevent gaps between tiles\r\n\r\n  // Improved Draw Order for smoother weaving:\r\n  // Instead of drawing whole 0..PI segments, we split at PI/2 boundaries to properly layer\r\n  // the strands at the crossing points (0 and PI).\r\n  \r\n  // Back Layer (drawn first)\r\n  // Blue at 0 (Back), Blue at 2PI (Back), Red at PI (Back)\r\n  \r\n  // Blue Back 1: 0..PI/2 (Phase PI)\r\n  paths.push(getPath(-overlap, Math.PI/2 + overlap, colors.blue, Math.PI));\r\n  \r\n  // Blue Back 2: 3PI/2..2PI (Phase PI)\r\n  paths.push(getPath(3*Math.PI/2 - overlap, 2*Math.PI + overlap, colors.blue, Math.PI));\r\n  \r\n  // Red Back: PI/2..3PI/2 (Phase 0)\r\n  paths.push(getPath(Math.PI/2 - overlap, 3*Math.PI/2 + overlap, colors.red, 0));\r\n  \r\n  // Front Layer (drawn last)\r\n  // Red at 0 (Front), Red at 2PI (Front), Blue at PI (Front)\r\n  \r\n  // Red Front 1: 0..PI/2 (Phase 0)\r\n  paths.push(getPath(-overlap, Math.PI/2 + overlap, colors.red, 0));\r\n  \r\n  // Red Front 2: 3PI/2..2PI (Phase 0)\r\n  paths.push(getPath(3*Math.PI/2 - overlap, 2*Math.PI + overlap, colors.red, 0));\r\n  \r\n  // Blue Front: PI/2..3PI/2 (Phase PI)\r\n  paths.push(getPath(Math.PI/2 - overlap, 3*Math.PI/2 + overlap, colors.blue, Math.PI));\r\n  \r\n  const svg = `<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 ${w} ${h}\" width=\"${w}\" height=\"${h}\" preserveAspectRatio=\"none\">${paths.join('')}</svg>`;\r\n  \r\n  return `data:image/svg+xml;charset=utf-8,${encodeURIComponent(svg)}`;\r\n}\r\n\r\nfunction buildPanel(panelEl) {\r\n  panelEl.innerHTML = `<div class=\"merchant-reset\"><aside class=\"merchant-reset__sidebar\"><button type=\"button\" class=\"merchant-reset__layer\" data-reset-layer=\"forge\"><img src=\"${RESET_ICON_SRC}\" alt=\"\"><span>Forge</span></button><button type=\"button\" class=\"merchant-reset__layer\" data-reset-layer=\"infuse\" style=\"display:none\"><img src=\"${INFUSE_ICON_SRC}\" alt=\"\"><span>Infuse</span></button><button type=\"button\" class=\"merchant-reset__layer\" data-reset-layer=\"surge\" style=\"display:none\"><img src=\"${SURGE_ICON_SRC}\" alt=\"\"><span>Surge</span></button><button type=\"button\" class=\"merchant-reset__layer\" data-reset-layer=\"experiment\" style=\"display:none\"><img src=\"${EXPERIMENT_ICON_SRC}\" alt=\"\"><span>Experiment</span></button></aside><div class=\"merchant-reset__list\"><div class=\"merchant-reset__card merchant-reset__main\" id=\"reset-card-forge\"><div class=\"merchant-reset__layout\"><header class=\"merchant-reset__header\"><div class=\"merchant-reset__titles\"><h3>Forge</h3></div></header><div class=\"merchant-reset__content\"><div class=\"merchant-reset__titles\"><p data-reset-desc=\"forge\"> Resets Coins, Books, XP, Coin upgrades, and Book upgrades for Gold<br> Increase pending Gold amount by increasing Coins and XP Level<br> The button below shows how much Gold you will get upon reset </p></div><div class=\"merchant-reset__status\" data-reset-status=\"forge\"></div></div><div class=\"merchant-reset__actions\"><button type=\"button\" class=\"merchant-reset__action\" data-reset-action=\"forge\"><span class=\"merchant-reset__action-plus\">+</span><span class=\"merchant-reset__action-icon\"><img src=\"${GOLD_ICON_SRC}\" alt=\"\"></span><span class=\"merchant-reset__action-amount\" data-reset-pending=\"forge\">0</span></button></div></div></div><div class=\"merchant-reset__card merchant-reset__main is-infuse\" id=\"reset-card-infuse\" style=\"display:none\"><div class=\"merchant-reset__layout\"><header class=\"merchant-reset__header\"><div class=\"merchant-reset__titles\"><h3>Infuse</h3></div></header><div class=\"merchant-reset__content\"><div class=\"merchant-reset__titles\"><p data-reset-desc=\"infuse\"> Resets everything Forge does as well as Gold, MP, and Gold upgrades for Magic<br> Increase pending Magic amount by increasing Coins and MP </p></div><div class=\"merchant-reset__status\" data-reset-status=\"infuse\"></div></div><div class=\"merchant-reset__actions\"><button type=\"button\" class=\"merchant-reset__action\" data-reset-action=\"infuse\"><span class=\"merchant-reset__action-plus\">+</span><span class=\"merchant-reset__action-icon\"><img src=\"${MAGIC_ICON_SRC}\" alt=\"\"></span><span class=\"merchant-reset__action-amount\" data-reset-pending=\"infuse\">0</span></button></div></div></div><div class=\"merchant-reset__card merchant-reset__main is-surge\" id=\"reset-card-surge\" style=\"display:none\"><div class=\"merchant-reset__layout\"><header class=\"merchant-reset__header\"><div class=\"merchant-reset__titles\"><h3>Surge</h3></div></header><div class=\"merchant-reset__content\"><div class=\"merchant-reset__titles\"><p data-reset-desc=\"surge\"> Resets everything Infuse does as well as Magic and Magic upgrades for Waves<br> Increase pending Wave amount by increasing Coins, XP Level, Gold, MP, and Magic<br> Waves cannot be spent on upgrades, rather they are only useful for filling a bar<br> Each time you fill this bar below, obtain powerful bonuses from Surge milestones<br> Multiple milestones may be obtained in one reset, but Wave requirement scales 10x each fill </p></div><div class=\"merchant-reset__status\" data-reset-status=\"surge\"></div><div class=\"merchant-reset__bar-container\"><div class=\"merchant-reset__bar-wrapper\"><div class=\"merchant-reset__bar-fill\" data-reset-bar-fill=\"surge\"></div><span class=\"merchant-reset__bar-text\" data-reset-bar-text=\"surge\">0 / 10</span></div></div><div class=\"surge-header\">You are at Surge <span class=\"surge-level-display\" data-surge-level>0</span></div><div class=\"surge-milestone-wrapper\"><div class=\"surge-milestone-container\" data-reset-milestones=\"surge\"></div></div></div><div class=\"merchant-reset__actions\"><button type=\"button\" class=\"merchant-reset__action\" data-reset-action=\"surge\"><span class=\"merchant-reset__action-plus\">+</span><span class=\"merchant-reset__action-icon\"><img src=\"${WAVES_ICON_SRC}\" alt=\"\"></span><span class=\"merchant-reset__action-amount\" data-reset-pending=\"surge\">0</span></button></div></div></div><div class=\"merchant-reset__card merchant-reset__main is-experiment\" id=\"reset-card-experiment\" style=\"display:none\"><div class=\"merchant-reset__layout\"><header class=\"merchant-reset__header\"><div class=\"merchant-reset__titles\"><h3>Experiment</h3></div></header><div class=\"merchant-reset__content\"><div class=\"merchant-reset__titles\"><p data-reset-desc=\"experiment\"> Resets everything Surge does as well as the entire Lab for DNA<br> Increase pending DNA amount by increasing Lab Level and XP Level<br> ${IS_MOBILE ? 'Tap' : 'Click'} the button below to access DNA upgrades </p></div><div class=\"merchant-reset__status\" data-reset-status=\"experiment\"></div><div class=\"dna-btn-container\"></div></div><div class=\"merchant-reset__actions\"><button type=\"button\" class=\"merchant-reset__action\" data-reset-action=\"experiment\"><span class=\"merchant-reset__action-plus\">+</span><span class=\"merchant-reset__action-icon\"><img src=\"${DNA_ICON_SRC}\" alt=\"\"></span><span class=\"merchant-reset__action-amount\" data-reset-pending=\"experiment\">0</span></button></div></div></div></div><div class=\"merchant-reset__spacer\"></div></div>`;\r\n  resetState.panel = panelEl;\r\n  \r\n  // Bind Forge Elements\r\n  resetState.elements.forge.card = panelEl.querySelector('#reset-card-forge');\r\n  resetState.elements.forge.status = panelEl.querySelector('[data-reset-status=\"forge\"]');\r\n  resetState.elements.forge.btn = panelEl.querySelector('[data-reset-action=\"forge\"]');\r\n  resetState.elements.forge.pending = panelEl.querySelector('[data-reset-pending=\"forge\"]');\r\n\r\n  // Bind Infuse Elements\r\n  resetState.elements.infuse.card = panelEl.querySelector('#reset-card-infuse');\r\n  resetState.elements.infuse.status = panelEl.querySelector('[data-reset-status=\"infuse\"]');\r\n  resetState.elements.infuse.btn = panelEl.querySelector('[data-reset-action=\"infuse\"]');\r\n  resetState.elements.infuse.pending = panelEl.querySelector('[data-reset-pending=\"infuse\"]');\r\n\r\n  // Bind Surge Elements\r\n  resetState.elements.surge.card = panelEl.querySelector('#reset-card-surge');\r\n  resetState.elements.surge.status = panelEl.querySelector('[data-reset-status=\"surge\"]');\r\n  resetState.elements.surge.btn = panelEl.querySelector('[data-reset-action=\"surge\"]');\r\n  resetState.elements.surge.barFill = panelEl.querySelector('[data-reset-bar-fill=\"surge\"]');\r\n  resetState.elements.surge.barText = panelEl.querySelector('[data-reset-bar-text=\"surge\"]');\r\n  resetState.elements.surge.milestones = panelEl.querySelector('[data-reset-milestones=\"surge\"]');\r\n  resetState.elements.surge.headerVal = panelEl.querySelector('[data-surge-level]');\r\n  resetState.elements.surge.header = panelEl.querySelector('.surge-header');\r\n\r\n  // Bind Experiment Elements\r\n  resetState.elements.experiment.card = panelEl.querySelector('#reset-card-experiment');\r\n  resetState.elements.experiment.status = panelEl.querySelector('[data-reset-status=\"experiment\"]');\r\n  resetState.elements.experiment.btn = panelEl.querySelector('[data-reset-action=\"experiment\"]');\r\n\r\n  const surgeWrapper = panelEl.querySelector('.surge-milestone-wrapper');\r\n  if (resetState.elements.surge.milestones && surgeWrapper) {\r\n      ensureCustomScrollbar(\r\n        panelEl, \r\n        surgeWrapper, \r\n        '[data-reset-milestones=\"surge\"]',\r\n        { orientation: 'horizontal' }\r\n      );\r\n  }\r\n\r\n  // Init IntersectionObserver to track visibility\r\n  if (typeof IntersectionObserver !== 'undefined') {\r\n    const observer = new IntersectionObserver((entries) => {\r\n      entries.forEach(entry => {\r\n        const target = entry.target;\r\n        const isVisible = entry.isIntersecting;\r\n        \r\n        if (target === resetState.elements.forge.card) {\r\n          resetState.visible.forge = isVisible;\r\n          if (isVisible) updateForgeCard();\r\n        } else if (target === resetState.elements.infuse.card) {\r\n          resetState.visible.infuse = isVisible;\r\n          if (isVisible) updateInfuseCard();\r\n        } else if (target === resetState.elements.surge.card) {\r\n          resetState.visible.surge = isVisible;\r\n          if (isVisible) updateSurgeCard();\r\n        } else if (target === resetState.elements.experiment.card) {\r\n          resetState.visible.experiment = isVisible;\r\n          if (isVisible) updateExperimentCard();\r\n        } else if (target === resetState.elements.surge.milestones) {\r\n          resetState.visible.surgeMilestones = isVisible;\r\n          if (isVisible) updateSurgeCard();\r\n        }\r\n      });\r\n    }, { threshold: 0 }); // Trigger if even 1 pixel is visible\r\n\r\n    if (resetState.elements.forge.card) observer.observe(resetState.elements.forge.card);\r\n    if (resetState.elements.infuse.card) observer.observe(resetState.elements.infuse.card);\r\n    if (resetState.elements.surge.card) observer.observe(resetState.elements.surge.card);\r\n    if (resetState.elements.experiment.card) observer.observe(resetState.elements.experiment.card);\r\n    if (resetState.elements.surge.milestones) observer.observe(resetState.elements.surge.milestones);\r\n  } else {\r\n    // Fallback if IO not supported\r\n    resetState.visible.forge = true;\r\n    resetState.visible.infuse = true;\r\n    resetState.visible.surge = true;\r\n    resetState.visible.experiment = true;\r\n    resetState.visible.surgeMilestones = true;\r\n  }\r\n\r\n  // Sidebar Buttons\r\n  resetState.layerButtons = {\r\n    forge: panelEl.querySelector('[data-reset-layer=\"forge\"]'),\r\n    infuse: panelEl.querySelector('[data-reset-layer=\"infuse\"]'),\r\n    surge: panelEl.querySelector('[data-reset-layer=\"surge\"]'),\r\n    experiment: panelEl.querySelector('[data-reset-layer=\"experiment\"]'),\r\n  };\r\n  \r\n  // Sidebar Click Handlers (Scroll)\r\n  Object.entries(resetState.layerButtons).forEach(([key, btn]) => {\r\n    if (!btn) return;\r\n\r\n    let lastPointerType = null;\r\n    const handleClick = (e) => {\r\n      if (e && e.isTrusted && shouldSkipGhostTap(btn)) return;\r\n      // markGhostTapTarget removed - global handler manages clicks\r\n      \r\n      const card = resetState.elements[key]?.card;\r\n      if (card) {\r\n        const scrollContainer = card.closest('.merchant-content');\r\n        if (key === 'forge' && scrollContainer) {\r\n          scrollContainer.scrollTo({ top: 0, behavior: 'smooth' });\r\n        } else {\r\n          card.scrollIntoView({ behavior: 'smooth', block: 'start' });\r\n        }\r\n      }\r\n    };\r\n\r\n    btn.addEventListener('click', (e) => {\r\n        if (lastPointerType && lastPointerType !== 'mouse') {\r\n            lastPointerType = null;\r\n            return;\r\n        }\r\n        lastPointerType = null;\r\n        handleClick(e);\r\n    });\r\n  });\r\n  \r\n  // Action Button Handlers\r\n  if (resetState.elements.forge.btn) {\r\n    resetState.elements.forge.btn.addEventListener('click', () => {\r\n       if (performForgeReset()) {\r\n         playForgeResetSound();\r\n         updateResetPanel();\r\n       }\r\n    });\r\n  }\r\n\r\n  if (resetState.elements.infuse.btn) {\r\n    resetState.elements.infuse.btn.addEventListener('click', () => {\r\n       if (performInfuseReset()) {\r\n         playInfuseResetSound();\r\n         updateResetPanel();\r\n       }\r\n    });\r\n  }\r\n\r\n  if (resetState.elements.surge.btn) {\r\n    resetState.elements.surge.btn.addEventListener('click', () => {\r\n       if (performSurgeReset()) {\r\n         // performSurgeReset handles playing sound\r\n         updateResetPanel();\r\n       }\r\n    });\r\n  }\r\n\r\n  if (resetState.elements.experiment.btn) {\r\n    resetState.elements.experiment.btn.addEventListener('click', () => {\r\n       if (performExperimentReset()) {\r\n         updateResetPanel();\r\n       }\r\n    });\r\n  }\r\n  const dnaContainer = panelEl.querySelector(\".dna-btn-container\");\r\n  if (dnaContainer) {\r\n      // Build structure\r\n      dnaContainer.innerHTML = `<button class=\"btn-dna-shop\"><div class=\"dna-btn-bg\"></div><div class=\"dna-label\">DNA</div></button>`;\r\n      \r\n      const dnaBtn = dnaContainer.querySelector(\".btn-dna-shop\");\r\n      const dnaBg = dnaBtn.querySelector(\".dna-btn-bg\");\r\n\r\n      // Set DNA SVG Background\r\n      const svgUri = generateDnaSvgDataUri();\r\n      if (dnaBg) {\r\n          dnaBg.style.backgroundImage = `url(\"${svgUri}\")`;\r\n          dnaBg.style.backgroundSize = `120px 100%`;\r\n      }\r\n\r\n      dnaBtn.addEventListener(\"click\", () => { openShop(\"dna\"); });\r\n\r\n      const syncLayout = () => {\r\n          if (!dnaBtn.offsetParent) return;\r\n          const statsBtn = document.querySelector(\".hud-bottom [data-btn=stats]\");\r\n          if (statsBtn && dnaBtn) {\r\n              const rect = statsBtn.getBoundingClientRect();\r\n              const w = `${rect.width}px`;\r\n              const h = `${rect.height}px`;\r\n              if (dnaBtn.style.width !== w) dnaBtn.style.width = w;\r\n              if (dnaBtn.style.height !== h) dnaBtn.style.height = h;\r\n              if (dnaBtn.style.minWidth !== \"0\") dnaBtn.style.minWidth = \"0\";\r\n              if (dnaBtn.style.maxWidth !== \"none\") dnaBtn.style.maxWidth = \"none\";\r\n          }\r\n      };\r\n\r\n      if (typeof IntersectionObserver !== 'undefined') {\r\n          const observer = new IntersectionObserver((entries) => {\r\n              entries.forEach(entry => {\r\n                  if (entry.isIntersecting) {\r\n                      if (dnaBg && dnaBg.style.animationPlayState !== 'running') {\r\n                          dnaBg.style.animationPlayState = 'running';\r\n                      }\r\n                      syncLayout();\r\n                  } else {\r\n                      if (dnaBg && dnaBg.style.animationPlayState !== 'paused') {\r\n                          dnaBg.style.animationPlayState = 'paused';\r\n                      }\r\n                  }\r\n              });\r\n          }, { threshold: 0.1 });\r\n          observer.observe(panelEl);\r\n      }\r\n\r\n      if (typeof ResizeObserver !== \"undefined\") {\r\n          const ro = new ResizeObserver(syncLayout);\r\n          const hud = document.querySelector(\".hud-bottom\");\r\n          if (hud) ro.observe(hud);\r\n          window.addEventListener(\"resize\", syncLayout);\r\n          requestAnimationFrame(syncLayout);\r\n      } else {\r\n          window.addEventListener(\"resize\", syncLayout);\r\n          requestAnimationFrame(syncLayout);\r\n      }\r\n  }\r\n\r\n  updateResetPanel();\r\n}\r\n\r\nexport function initResetPanel(panelEl) {\r\n  if (!panelEl || panelEl.__resetInit) return;\r\n  panelEl.__resetInit = true;\r\n  buildPanel(panelEl);\r\n}\r\n\r\nfunction updateResetButtonContent(btn, state, iconSrc, pendingAmountBn) {\r\n  if (!btn) return;\r\n  const { disabled, msg } = state;\r\n  \r\n  if (btn.disabled !== disabled) btn.disabled = disabled;\r\n  \r\n  // State: \"msg\" or \"action\"\r\n  const targetMode = msg ? 'msg' : 'action';\r\n  const currentMode = btn.dataset.mode;\r\n  \r\n  if (targetMode === 'msg') {\r\n      if (currentMode !== 'msg' || btn.textContent !== msg) {\r\n          btn.innerHTML = `<span class=\"merchant-reset__req-msg\">${msg}</span>`;\r\n          btn.dataset.mode = 'msg';\r\n      }\r\n      return;\r\n  }\r\n  \r\n  // Action mode\r\n  const amountStr = formatBn(pendingAmountBn);\r\n  \r\n  if (currentMode !== 'action') {\r\n      // Build structure\r\n      btn.innerHTML = `<span class=\"merchant-reset__action-plus\">+</span><span class=\"merchant-reset__action-icon\"><img src=\"${iconSrc}\" alt=\"\"></span><span class=\"merchant-reset__action-amount\">${amountStr}</span>`;\r\n      btn.dataset.mode = 'action';\r\n  } else {\r\n      // Update amount only\r\n      const amountEl = btn.querySelector('.merchant-reset__action-amount');\r\n      if (amountEl && amountEl.innerHTML !== amountStr) {\r\n          amountEl.innerHTML = amountStr;\r\n      }\r\n      // Ensure icon (in case it was somehow lost or incorrect, though unlikely here)\r\n      const iconImg = btn.querySelector('.merchant-reset__action-icon img');\r\n      if (iconImg && !iconImg.src.includes(iconSrc)) iconImg.src = iconSrc;\r\n  }\r\n}\r\n\r\nfunction updateForgeCard({ goldMult = null } = {}) {\r\n  const el = resetState.elements.forge;\r\n  if (!el.card || !el.btn) return;\r\n\r\n  if (!isForgeUnlocked()) {\r\n     // Even if not visible, we might want to set msg state once, but defer DOM updates\r\n     // However, let's just stick to the plan: if not visible, return.\r\n     if (!resetState.visible.forge) return;\r\n     updateResetButtonContent(el.btn, { disabled: true, msg: 'Unlock the Forge upgrade to access resets' });\r\n     return;\r\n  }\r\n  \r\n  if (!resetState.visible.forge) return;\r\n\r\n  ensurePersistentFlagsPrimed();\r\n  el.card.classList.toggle('is-forge-complete', !!resetState.hasDoneForgeReset);\r\n  \r\n  if (el.status) {\r\n      if (resetState.hasDoneForgeReset) {\r\n        if (el.status.innerHTML !== '') el.status.innerHTML = '';\r\n      } else {\r\n        const expected = `<span style=\"color:#02e815; text-shadow: 0 3px 6px rgba(0,0,0,0.55);\"> Forging for the first time will unlock new Shop upgrades, a new Merchant dialogue, and <strong style=\"color:#ffb347; text-shadow: 0 3px 6px rgba(0,0,0,0.55); \">Mutations</strong><br> Mutated Coins yield more Coin and XP value than normal </span>`.trim();\r\n        // Simple length check or substring to avoid constant re-render\r\n        if (!el.status.innerHTML.includes('Mutations')) el.status.innerHTML = expected;\r\n      }\r\n  }\r\n\r\n  if (!meetsLevelRequirement()) {\r\n    updateResetButtonContent(el.btn, { disabled: true, msg: 'Reach XP Level 31 to perform a Forge reset' });\r\n    return;\r\n  }\r\n\r\n\r\n  updateResetButtonContent(el.btn, { disabled: false }, GOLD_ICON_SRC, getPendingGoldWithMultiplier(goldMult));\r\n}\r\n\r\nfunction updateInfuseCard() {\r\n  const el = resetState.elements.infuse;\r\n  if (!el.card || !el.btn) return;\r\n\r\n  if (!isInfuseUnlocked()) {\r\n    if (el.card.style.display !== 'none') el.card.style.display = 'none';\r\n    if (resetState.layerButtons.infuse && resetState.layerButtons.infuse.style.display !== 'none') {\r\n        resetState.layerButtons.infuse.style.display = 'none';\r\n    }\r\n    return;\r\n  }\r\n\r\n  if (el.card.style.display !== 'flex') el.card.style.display = 'flex';\r\n  if (resetState.layerButtons.infuse && resetState.layerButtons.infuse.style.display !== 'flex') {\r\n      resetState.layerButtons.infuse.style.display = 'flex';\r\n  }\r\n  \r\n  if (!resetState.visible.infuse) return;\r\n\r\n  ensurePersistentFlagsPrimed();\r\n  \r\n  el.card.classList.toggle('is-complete', !!resetState.hasDoneInfuseReset);\r\n\r\n  if (el.status) {\r\n      if (resetState.hasDoneInfuseReset) {\r\n        if (el.status.innerHTML !== '') el.status.innerHTML = '';\r\n      } else {\r\n         const expected = `<span style=\"color:#02e815; text-shadow: 0 3px 6px rgba(0,0,0,0.55);\"> Infusing for the first time will unlock new Shop upgrades, a new Merchant dialogue, and a new tab: <strong style=\"color:#c68cff\">Workshop</strong><br> This new tab will allow you to passively generate Gears<br> Spend Gears on new upgrades in the Shop to automate various things </span>`.trim();\r\n         if (!el.status.innerHTML.includes('Workshop')) el.status.innerHTML = expected;\r\n      }\r\n  }\r\n\r\n  if (!meetsInfuseRequirement()) {\r\n    updateResetButtonContent(el.btn, { disabled: true, msg: 'Reach Mutation Level 7 to perform an Infuse reset' });\r\n    return;\r\n  }\r\n  \r\n  \r\n  updateResetButtonContent(el.btn, { disabled: false }, MAGIC_ICON_SRC, resetState.pendingMagic);\r\n}\r\n\r\n\r\nfunction predictSurgeLevel(currentLevelBigInt, currentWaves, pendingWaves) {\r\n  const availableWaves = currentWaves.add(pendingWaves);\r\n  const result = calculateSurgeLevelJump(currentLevelBigInt, availableWaves);\r\n  return result.level;\r\n}\r\n\r\nfunction updateSurgeCard() {\r\n  const el = resetState.elements.surge;\r\n  if (!el.card || !el.btn) return;\r\n\r\n  if (!isSurgeUnlocked()) {\r\n    if (el.card.style.display !== 'none') el.card.style.display = 'none';\r\n    if (resetState.layerButtons.surge && resetState.layerButtons.surge.style.display !== 'none') {\r\n        resetState.layerButtons.surge.style.display = 'none';\r\n    }\r\n    return;\r\n  }\r\n\r\n  if (el.card.style.display !== 'flex') el.card.style.display = 'flex';\r\n  if (resetState.layerButtons.surge && resetState.layerButtons.surge.style.display !== 'flex') {\r\n      resetState.layerButtons.surge.style.display = 'flex';\r\n  }\r\n  \r\n  if (!resetState.visible.surge) return;\r\n\r\n  ensurePersistentFlagsPrimed();\r\n  \r\n  // Bar Logic Visualization\r\n  const slot = ensureResetSlot();\r\n  const currentWaves = bank.waves?.value ?? bnZero();\r\n  let barLevel = 0n;\r\n  try { barLevel = getSurgeBarLevel(slot); } catch {}\r\n  \r\n  let req;\r\n  if (barLevel === Infinity) {\r\n    req = BigNum.fromAny('Infinity');\r\n  } else {\r\n    req = new BigNum(10n, { base: 0, offset: barLevel });\r\n  }\r\n  \r\n  let pct = 0;\r\n  if (currentWaves?.isInfinite?.()) {\r\n      pct = 100;\r\n  } else if (currentWaves && req && !req.isZero?.()) {\r\n      if (req.isInfinite?.()) {\r\n          pct = 0;\r\n      } else {\r\n          try {\r\n              const ratio = currentWaves.div(req);\r\n              // Convert to number for percentage\r\n              const rNum = Number(ratio.toScientific?.() ?? '0');\r\n              pct = Math.min(100, Math.max(0, rNum * 100));\r\n          } catch { pct = 0; }\r\n      }\r\n  }\r\n  \r\n  if (el.barFill) {\r\n    el.barFill.style.width = `${pct}%`;\r\n  }\r\n\r\n  if (el.header) {\r\n    const isInf = barLevel === Infinity || (typeof barLevel.isInfinite === 'function' && barLevel.isInfinite()) || String(barLevel) === 'Infinity';\r\n    const sLevel = isInf ? '<span class=\"surge-infinity-symbol\">\u221E</span>' : formatBn(barLevel);\r\n    \r\n    let newContent = `You are at Surge <span class=\"surge-level-display\" data-surge-level>${sLevel}</span>`;\r\n    \r\n    if (!isInf) {\r\n       const pending = resetState.pendingWaves;\r\n       if (pending && !pending.isZero?.()) {\r\n           const predicted = predictSurgeLevel(barLevel, currentWaves, pending);\r\n           let isIncrease = false;\r\n           if (predicted === Infinity) {\r\n             isIncrease = true;\r\n           } else {\r\n             try { isIncrease = predicted > barLevel; } catch {}\r\n           }\r\n\r\n           if (isIncrease) {\r\n               const pLevel = (predicted === Infinity) ? '<span class=\"surge-infinity-symbol\">\u221E</span>' : formatBn(predicted);\r\n               newContent = `Your Surge will increase from <span class=\"surge-level-display\">${sLevel}</span> to <span class=\"surge-level-display\">${pLevel}</span>`;\r\n           }\r\n       }\r\n    }\r\n\r\n    if (el.header.innerHTML !== newContent) {\r\n        el.header.innerHTML = newContent;\r\n        el.headerVal = el.header.querySelector('[data-surge-level]');\r\n    }\r\n  } else if (el.headerVal) {\r\n    const isInf = barLevel === Infinity || (typeof barLevel.isInfinite === 'function' && barLevel.isInfinite()) || String(barLevel) === 'Infinity';\r\n    const sLevel = isInf ? '<span class=\"surge-infinity-symbol\">\u221E</span>' : barLevel.toString();\r\n    if (el.headerVal.innerHTML !== sLevel) el.headerVal.innerHTML = sLevel;\r\n  }\r\n  if (el.barText) el.barText.innerHTML = `<span class=\"wave-bar-nums\"><img src=\"${WAVES_ICON_SRC}\">${formatBn(currentWaves)} / <img src=\"${WAVES_ICON_SRC}\">${formatBn(req)}</span>`;\r\n\r\n  if (el.milestones && resetState.visible.surgeMilestones) {\r\n    const visible = getVisibleMilestones(barLevel);\r\n    const existingItems = Array.from(el.milestones.children);\r\n    \r\n    visible.forEach((m, i) => {\r\n        const isReached = BigInt(m.surgeLevel) <= barLevel;\r\n        const reachedClass = isReached ? 'is-reached' : '';\r\n        let desc = m.description.map(d => {\r\n            if (d.includes('Invokes the Tsunami') && !isReached) {\r\n                return `<div class=\"tsunami-text\">- ${d}</div>`;\r\n            }\r\n            return `<div>- ${d}</div>`;\r\n        }).join('');\r\n\r\n        if (isReached && m.surgeLevel === 3) {\r\n            const rate = getBookProductionRate ? getBookProductionRate() : BN.fromInt(0);\r\n            desc += `<div style=\"color:#02e815\">- Current Books/sec: ${formatNumber(rate.floorToInteger())}</div>`;\r\n        }\r\n\r\n        if (isReached && m.surgeLevel === 6) {\r\n            const mults = getSurge6WealthMultipliers();\r\n            desc = `<div>- Unspent Coins boost Coins: <span style=\"color:#00e5ff\">${formatMultForUi(mults.coins)}x</span></div><div>- Unspent Books boost Coins: <span style=\"color:#00e5ff\">${formatMultForUi(mults.books)}x</span></div><div>- Unspent Gold boosts Coins: <span style=\"color:#00e5ff\">${formatMultForUi(mults.gold)}x</span></div><div>- Unspent Magic boosts Coins: <span style=\"color:#00e5ff\">${formatMultForUi(mults.magic)}x</span></div>`;\r\n        }\r\n\r\n        if (isReached && m.surgeLevel === 13) {\r\n            const effectiveNerf = getEffectiveTsunamiNerf();\r\n            const mapped = effectiveNerf * 1.5 - 0.5;\r\n            const log10Rate = 2 * mapped - 2;\r\n            const rateMultiplier = bigNumFromLog10(log10Rate);\r\n            \r\n            const pending = getPendingGoldWithMultiplier();\r\n            const goldPerSec = pending.mulDecimal(rateMultiplier.toScientific());\r\n            \r\n            desc += `<div style=\"color:#02e815\">- Current Gold/sec: ${formatNumber(goldPerSec.floorToInteger())}</div>`;\r\n        }\r\n        if (isReached && m.surgeLevel === 16) {\r\n            const effectiveNerf = getEffectiveTsunamiNerf();\r\n            const mapped = effectiveNerf * 1.5 - 0.5;\r\n            const log10Rate = 2 * mapped - 2;\r\n            const rateMultiplier = bigNumFromLog10(log10Rate);\r\n            \r\n            const magicPerSec = resetState.pendingMagic.mulDecimal(rateMultiplier.toScientific());\r\n            \r\n            desc += `<div style=\"color:#02e815\">- Current Magic/sec: ${formatNumber(magicPerSec.floorToInteger())}</div>`;\r\n        }\r\n\r\n        let isSurge8 = false;\r\n        if (barLevel === Infinity || (typeof barLevel === 'string' && barLevel === 'Infinity')) isSurge8 = true;\r\n        else if (typeof barLevel.isInfinite === 'function' && barLevel.isInfinite()) isSurge8 = true;\r\n        else if (typeof barLevel === 'bigint' && barLevel >= 8n) isSurge8 = true;\r\n        else if (typeof barLevel === 'number' && barLevel >= 8) isSurge8 = true;\r\n\r\n        const effectiveNerf = getEffectiveTsunamiNerf();\r\n\r\n        let isNerfed = false;\r\n        if (isReached && isSurge8 && effectiveNerf < 1 && NERFED_SURGE_MILESTONE_IDS.includes(m.id)) {\r\n            isNerfed = true;\r\n        }\r\n        const nerfedClass = isNerfed ? ' is-nerfed' : '';\r\n\r\n        let itemEl = existingItems[i];\r\n        \r\n        if (!itemEl) {\r\n            itemEl = document.createElement('div');\r\n            itemEl.className = `surge-milestone-item ${reachedClass}${nerfedClass}`;\r\n            itemEl.dataset.isReached = String(isReached);\r\n            itemEl.innerHTML = `<div class=\"surge-milestone-nerf-arrow\" style=\"display:none\"></div><div class=\"surge-milestone-title\">Surge ${m.surgeLevel}</div><div class=\"surge-milestone-desc\"></div><div class=\"surge-milestone-title\" style=\"visibility:hidden\">Surge ${m.surgeLevel}</div>`;\r\n            el.milestones.appendChild(itemEl);\r\n        } else {\r\n            if (itemEl.className !== `surge-milestone-item ${reachedClass}${nerfedClass}`) {\r\n                itemEl.className = `surge-milestone-item ${reachedClass}${nerfedClass}`;\r\n            }\r\n            const isReachedStr = String(isReached);\r\n            if (itemEl.dataset.isReached !== isReachedStr) {\r\n                itemEl.dataset.isReached = isReachedStr;\r\n            }\r\n        }\r\n        \r\n        // Update Description\r\n        const descEl = itemEl.querySelector('.surge-milestone-desc');\r\n        if (descEl && descEl.innerHTML !== desc) {\r\n            descEl.innerHTML = desc;\r\n        }\r\n\r\n        // Update Arrow\r\n        const arrowEl = itemEl.querySelector('.surge-milestone-nerf-arrow');\r\n        if (arrowEl) {\r\n             let shouldHaveArrow = false;\r\n             if (isSurge8 && effectiveNerf < 1) {\r\n                if (NERFED_SURGE_MILESTONE_IDS.includes(m.id)) {\r\n                    shouldHaveArrow = true;\r\n                }\r\n             }\r\n             const display = shouldHaveArrow ? '' : 'none';\r\n             if (arrowEl.style.display !== display) {\r\n                 arrowEl.style.display = display;\r\n             }\r\n        }\r\n    });\r\n    \r\n    // Remove excess elements\r\n    while (el.milestones.children.length > visible.length) {\r\n        el.milestones.lastChild.remove();\r\n    }\r\n\r\n    // Force scrollbar update if content changed\r\n    requestAnimationFrame(() => {\r\n        if (el.milestones && el.milestones.__customScroll && typeof el.milestones.__customScroll.update === 'function') {\r\n            el.milestones.__customScroll.update();\r\n        }\r\n    });\r\n\r\n    if (resetState.lastRenderedSurgeLevel !== barLevel) {\r\n        resetState.lastRenderedSurgeLevel = barLevel;\r\n        if (el.milestones) el.milestones.dataset.scrolled = '0';\r\n    }\r\n\r\n    if (el.milestones.dataset.scrolled !== '1') {\r\n        requestAnimationFrame(() => {\r\n           requestAnimationFrame(() => {\r\n               if (!el.milestones) return;\r\n               if (el.milestones.offsetParent === null) return;\r\n\r\n               const reachedItems = el.milestones.querySelectorAll('.surge-milestone-item[data-is-reached=\"true\"]');\r\n               if (reachedItems.length > 0) {\r\n                  const lastReached = reachedItems[reachedItems.length - 1];\r\n                  const allItems = el.milestones.children;\r\n                  const isLastItem = lastReached === allItems[allItems.length - 1];\r\n                  \r\n                  if (isLastItem) {\r\n                      el.milestones.scrollTo({ left: el.milestones.scrollWidth, behavior: 'smooth' });\r\n                  } else {\r\n                      el.milestones.scrollTo({ left: lastReached.offsetLeft - 12, behavior: 'smooth' });\r\n                  }\r\n                  el.milestones.dataset.scrolled = '1';\r\n               }\r\n           });\r\n        });\r\n    }\r\n  }\r\n\r\n  el.card.classList.toggle('is-complete', !!resetState.hasDoneSurgeReset);\r\n\r\n  if (el.status) {\r\n      if (resetState.hasDoneSurgeReset) {\r\n        if (el.status.innerHTML !== '') el.status.innerHTML = '';\r\n      } else {\r\n         const expected = `<span style=\"color:#02e815; text-shadow: 0 3px 6px rgba(0,0,0,0.55);\"> Surging for the first time will unlock a new Merchant dialogue and a new tab: <span style=\"color:#00e5ff\"><strong>Warp</strong></span><br> Warps may speed up gameplay a bit, so definitely check them out<br> You can only get 10 Waves on your first Surge, so you should do it immediately </span>`.trim();\r\n         if (!el.status.innerHTML.includes('Warp')) el.status.innerHTML = expected;\r\n      }\r\n  }\r\n\r\n  if (getXpLevelNumber() < 201) {\r\n    updateResetButtonContent(el.btn, { disabled: true, msg: 'Reach XP Level 201 to perform a Surge reset' });\r\n    return;\r\n  }\r\n  \r\n  if (resetState.pendingWaves.isZero?.()) {\r\n    updateResetButtonContent(el.btn, { disabled: true, msg: 'Collect more coins/resources to earn Waves from a Surge reset' });\r\n    return;\r\n  }\r\n  \r\n  updateResetButtonContent(el.btn, { disabled: false }, WAVES_ICON_SRC, resetState.pendingWaves);\r\n}\r\n\r\nfunction updateExperimentCard() {\r\n  const el = resetState.elements.experiment;\r\n  if (!el.card || !el.btn) return;\r\n\r\n  if (!isExperimentUnlocked()) {\r\n    if (el.card.style.display !== 'none') el.card.style.display = 'none';\r\n    if (resetState.layerButtons.experiment && resetState.layerButtons.experiment.style.display !== 'none') {\r\n        resetState.layerButtons.experiment.style.display = 'none';\r\n    }\r\n    return;\r\n  }\r\n\r\n  if (el.card.style.display !== 'flex') el.card.style.display = 'flex';\r\n  if (resetState.layerButtons.experiment && resetState.layerButtons.experiment.style.display !== 'flex') {\r\n      resetState.layerButtons.experiment.style.display = 'flex';\r\n  }\r\n  \r\n  if (!resetState.visible.experiment) return;\r\n\r\n  ensurePersistentFlagsPrimed();\r\n  \r\n  el.card.classList.toggle('is-complete', !!resetState.hasDoneExperimentReset);\r\n\r\n  if (el.status) {\r\n      if (resetState.hasDoneExperimentReset) {\r\n        if (el.status.innerHTML !== '') el.status.innerHTML = '';\r\n      } else {\r\n         const expected = `<span style=\"color:#02e815; text-shadow: 0 3px 6px rgba(0,0,0,0.55);\"> Experimenting for the first time will unlock new Lab nodes </span>`.trim();\r\n         if (el.status.innerHTML !== expected) el.status.innerHTML = expected;\r\n      }\r\n  }\r\n\r\n  // Priority 1: Lab Level 10\r\n  const labLevel = getLabLevel ? getLabLevel() : bnZero();\r\n  if (labLevel.cmp(10) < 0) {\r\n      updateResetButtonContent(el.btn, { disabled: true, msg: 'Reach Lab Level 10 to perform an Experiment reset' });\r\n      return;\r\n  }\r\n\r\n\r\n  updateResetButtonContent(el.btn, { disabled: false }, DNA_ICON_SRC, resetState.pendingDna);\r\n}\r\n\r\nexport function updateResetPanel({ goldMult = null } = {}) {\r\n  if (!resetState.panel) return;\r\n  // We no longer block updates during scrolling because we have efficient visibility checks\r\n  // for each card. This ensures values update even while holding scrollbars.\r\n  updateForgeCard({ goldMult });\r\n  updateInfuseCard();\r\n  updateSurgeCard();\r\n  updateExperimentCard();\r\n}\r\n\r\nexport function onForgeUpgradeUnlocked() {\r\n  initResetSystem();\r\n  setForgeUnlocked(true);\r\n  updateResetPanel();\r\n}\r\n\r\nexport function onInfuseUpgradeUnlocked() {\r\n  initResetSystem();\r\n  setInfuseUnlocked(true);\r\n  updateResetPanel();\r\n}\r\n\r\nexport function onSurgeUpgradeUnlocked() {\r\n  initResetSystem();\r\n  setSurgeUnlocked(true);\r\n  updateResetPanel();\r\n}\r\n\r\nfunction triggerSurgeBarAnimation() {\r\n  if (!resetState.panel) return;\r\n  const overlay = resetState.panel.closest('.merchant-overlay');\r\n  if (!overlay || !overlay.classList.contains('is-open')) return;\r\n  if (!resetState.panel.classList.contains('is-active')) return;\r\n\r\n  if (!resetState.elements.surge.barFill) return;\r\n  const barFill = resetState.elements.surge.barFill;\r\n  const wrapper = barFill.parentElement;\r\n  if (!wrapper) return;\r\n  \r\n  wrapper.classList.remove('surge-bar-pulse');\r\n  \r\n  // Snap to 100% immediately\r\n  barFill.style.transition = 'none';\r\n  barFill.style.width = '100%';\r\n  \r\n  void barFill.offsetWidth;\r\n  \r\n  wrapper.classList.add('surge-bar-pulse');\r\n  // Match the pulse animation duration (0.5s) for the drain effect.\r\n  // This causes the bar to animate from the forced 100% (set above) \r\n  // down to the actual value (set by updateSurgeCard below).\r\n  barFill.style.transition = 'width 0.5s ease-out';\r\n  \r\n  // Trigger update to animate to actual value\r\n  updateSurgeCard();\r\n\r\n  wrapper.addEventListener('animationend', () => {\r\n    wrapper.classList.remove('surge-bar-pulse');\r\n    // Revert to default stylesheet transition\r\n    barFill.style.transition = '';\r\n    updateSurgeCard();\r\n  }, { once: true });\r\n}\r\n\r\nfunction bindGlobalEvents() {\r\n  if (typeof window === 'undefined') return;\r\n  window.addEventListener('menu:scrollStop', () => {\r\n    updateResetPanel();\r\n  });\r\n  window.addEventListener('surge:level:change', () => {\r\n    triggerSurgeBarAnimation();\r\n  });\r\n  window.addEventListener('currency:change', (e) => {\r\n    if (e.detail?.key === 'coins') {\r\n      recomputePendingGold();\r\n      recomputePendingMagic();\r\n      recomputePendingWaves();\r\n    }\r\n    if (e.detail?.key === 'waves') {\r\n        updateWaveBar();\r\n        updateResetPanel();\r\n    }\r\n    if (e.detail?.key === 'gold' || e.detail?.key === 'magic' || e.detail?.key === 'books') {\r\n        recomputePendingWaves();\r\n        updateResetPanel();\r\n    }\r\n  });\r\n  window.addEventListener('surge:bookResidue', () => {\r\n    if (resetState.panel && resetState.panel.offsetParent !== null) {\r\n       const surgeCard = resetState.elements.surge.card;\r\n       if (surgeCard && surgeCard.style.display !== 'none') {\r\n           updateResetPanel();\r\n       }\r\n    }\r\n  });\r\n  window.addEventListener('currency:multiplier', (e) => {\r\n    const detail = e?.detail;\r\n    if (!detail) return;\r\n    if (detail.key === CURRENCIES.GOLD) {\r\n      if (detail.slot != null && resetState.slot != null && detail.slot !== resetState.slot) return;\r\n      recomputePendingGold(true);\r\n      // Pass the new multiplier explicitly so visual updates are instant\r\n      const goldMult = detail.mult instanceof BigNum ? detail.mult : BN.fromAny(detail.mult ?? 1);\r\n      \r\n      // Force update with explicit override to ensure reactivity\r\n      if (resetState.panel) {\r\n        updateForgeCard({ goldMult });\r\n      }\r\n      return;\r\n    }\r\n    if (detail.key === CURRENCIES.MAGIC) {\r\n      if (detail.slot != null && resetState.slot != null && detail.slot !== resetState.slot) return;\r\n      const magicMult = detail.mult instanceof BigNum ? detail.mult : BN.fromAny(detail.mult ?? 1);\r\n      recomputePendingMagic(magicMult);\r\n      // Ensure visual update happens immediately with the new multiplier\r\n      if (resetState.panel) {\r\n        updateInfuseCard();\r\n      }\r\n      return;\r\n    }\r\n  });\r\n  window.addEventListener('xp:change', () => {\r\n    recomputePendingGold();\r\n    recomputePendingWaves();\r\n    recomputePendingDna();\r\n    updateResetPanel();\r\n  });\r\n  window.addEventListener('mutation:change', () => {\r\n    recomputePendingMagic();\r\n    recomputePendingWaves();\r\n    updateResetPanel();\r\n  });\r\n  window.addEventListener('debug:change', (e) => {\r\n    if (e?.detail?.slot != null && resetState.slot != null && e.detail.slot !== resetState.slot) return;\r\n    resetPendingGoldSignature();\r\n    recomputePendingGold(true);\r\n    recomputePendingMagic();\r\n    recomputePendingWaves();\r\n    recomputePendingDna();\r\n    updateResetPanel();\r\n  });\r\n  window.addEventListener('lab:level:change', () => {\r\n      recomputePendingDna();\r\n      updateResetPanel();\r\n  });\r\n  window.addEventListener('lab:node:change', () => {\r\n      recomputePendingMagic();\r\n      updateResetPanel();\r\n  });\r\n}\r\n\r\nexport function initResetSystem() {\r\n  if (initialized) {\r\n    resetState.slot = getActiveSlot();\r\n    resetPendingGoldSignature();\r\n    ensureValueListeners();\r\n    recomputePendingGold(true);\r\n    recomputePendingMagic();\r\n    recomputePendingWaves();\r\n    recomputePendingDna();\r\n    return;\r\n  }\r\n  \r\n  // Guard against circular dependency initialization issues\r\n  try {\r\n    initMutationSystem();\r\n  } catch (e) {\r\n    // If initMutationSystem fails (likely due to accessing hudRefs before mutationSystem fully loads in a circular dep cycle),\r\n    // we abort initialization. This allows a subsequent call (e.g. from main.js) to succeed later.\r\n    return;\r\n  }\r\n\r\n  initialized = true;\r\n  const slot = getActiveSlot();\r\n  resetState.slot = slot;\r\n  resetPendingGoldSignature();\r\n  readPersistentFlags(slot);\r\n  if (resetState.hasDoneForgeReset && !isMutationUnlocked()) {\r\n    try { unlockMutationSystem(); } catch {}\r\n  }\r\n  if (!resetState.forgeUnlocked && canAccessForgeTab()) {\r\n    setForgeUnlocked(true);\r\n  }\r\n  bindStorageWatchers(slot);\r\n  ensureValueListeners();\r\n  bindGlobalEvents();\r\n  recomputePendingGold(true);\r\n  recomputePendingMagic();\r\n  recomputePendingWaves();\r\n  recomputePendingDna();\r\n  if (mutationUnsub) {\r\n    try { mutationUnsub(); } catch {}\r\n    mutationUnsub = null;\r\n  }\r\n  mutationUnsub = onMutationChange(() => {\r\n    const sprite = getMutationCoinSprite();\r\n    if (typeof window !== 'undefined' && window.spawner && typeof window.spawner.setCoinSprite === 'function') {\r\n      try { window.spawner.setCoinSprite(sprite); } catch {}\r\n    }\r\n  });\r\n  if (typeof window !== 'undefined') {\r\n    window.addEventListener('saveSlot:change', () => {\r\n      const nextSlot = getActiveSlot();\r\n      resetState.slot = nextSlot;\r\n      resetPendingGoldSignature();\r\n      readPersistentFlags(nextSlot);\r\n      if (resetState.hasDoneForgeReset && !isMutationUnlocked()) {\r\n        try { unlockMutationSystem(); } catch {}\r\n      }\r\n      if (!resetState.forgeUnlocked && canAccessForgeTab()) {\r\n        setForgeUnlocked(true);\r\n      }\r\n      bindStorageWatchers(nextSlot);\r\n      ensureValueListeners();\r\n      recomputePendingGold(true);\r\n      recomputePendingMagic();\r\n      recomputePendingWaves();\r\n      recomputePendingDna();\r\n      updateResetPanel();\r\n    });\r\n  }\r\n}\r\n\r\nif (typeof window !== 'undefined') {\r\n  window.resetSystem = window.resetSystem || {};\r\n  Object.assign(window.resetSystem, {\r\n    initResetSystem,\r\n    performForgeReset,\r\n    performInfuseReset,\r\n    performSurgeReset,\r\n    performExperimentReset,\r\n    computePendingForgeGold,\r\n    computeForgeGoldFromInputs,\r\n    computeInfuseMagicFromInputs,\r\n    computeSurgeWavesFromInputs,\r\n    computePendingDnaFromInputs,\r\n    getForgeDebugOverrideState,\r\n    hasDoneForgeReset,\r\n    isForgeUnlocked,\r\n    setForgeDebugOverride,\r\n    setForgeResetCompleted,\r\n    updateResetPanel,\r\n    isInfuseUnlocked,\r\n    setInfuseDebugOverride,\r\n    getInfuseDebugOverrideState,\r\n    recomputePendingMagic,\r\n    setInfuseUnlockedForDebug,\r\n    setInfuseResetCompleted,\r\n    hasDoneInfuseReset,\r\n    isSurgeUnlocked,\r\n    setSurgeUnlockedForDebug,\r\n    getSurgeDebugOverrideState,\r\n    setSurgeResetCompleted,\r\n    hasDoneSurgeReset,\r\n    getCurrentSurgeLevel,\r\n    shouldBlockBigCoins,\r\n    hasDoneExperimentReset,\r\n    setExperimentResetCompleted,\r\n    isExperimentUnlocked,\r\n  });\r\n}\r\n", "// js/game/upgrades.js\r\nimport { bank, getActiveSlot, watchStorageKey, primeStorageWatcherSnapshot, isStorageKeyLocked } from '../util/storage.js';\r\nimport { BigNum, approxLog10BigNum, bigNumFromLog10, log10OnePlusPow10 } from '../util/bigNum.js';\r\nexport { approxLog10BigNum, bigNumFromLog10, log10OnePlusPow10 };\r\nimport { formatNumber, formatMultForUi } from '../util/numFormat.js';\r\nexport { formatMultForUi };\r\nimport {\r\n  unlockXpSystem,\r\n  isXpSystemUnlocked,\r\n  getXpState,\r\n  refreshCoinMultiplierFromXpLevel,\r\n} from './xpSystem.js';\r\nimport { getMutationMultiplier } from './mutationSystem.js';\r\nimport {\r\n  initResetSystem,\r\n  onForgeUpgradeUnlocked,\r\n  isForgeUnlocked,\r\n  hasDoneForgeReset,\r\n  onInfuseUpgradeUnlocked,\r\n  isInfuseUnlocked,\r\n  hasDoneInfuseReset,\r\n  onSurgeUpgradeUnlocked,\r\n  getCurrentSurgeLevel,\r\n  hasDoneSurgeReset,\r\n  isSurgeUnlocked,\r\n} from '../ui/merchantTabs/resetTab.js';\r\nimport { getTsunamiNerf } from './surgeEffects.js';\r\nimport { REGISTRY as AUTOMATION_REGISTRY, AUTOMATION_AREA_KEY, EFFECTIVE_AUTO_COLLECT_ID } from './automationUpgrades.js';\r\nimport { getEacAmountMultiplier } from './automationEffects.js';\r\nimport { REGISTRY as DNA_REGISTRY, DNA_AREA_KEY } from './dnaUpgrades.js';\r\nimport {\r\n  invalidateEffectsCache,\r\n  triggerUpgradesChanged,\r\n  computeUpgradeEffects,\r\n  onUpgradesChanged,\r\n  getMpValueMultiplierBn,\r\n  getMagnetLevel,\r\n  syncBookCurrencyMultiplierFromUpgrade,\r\n  registerXpUpgradeEffects,\r\n} from './upgradeEffects.js';\r\n\r\nexport {\r\n  computeUpgradeEffects,\r\n  onUpgradesChanged,\r\n  getMpValueMultiplierBn,\r\n  getMagnetLevel,\r\n  syncBookCurrencyMultiplierFromUpgrade,\r\n};\r\n\r\nexport const MAX_LEVEL_DELTA = BigNum.fromAny('Infinity');\r\n\r\nexport const HM_EVOLUTION_INTERVAL = 1000;\r\nconst HM_EVOLUTION_EFFECT_MULT_BN = BigNum.fromInt(1000);\r\nconst HM_EVOLUTION_LOG10 = 3; // log10(1000)\r\nconst DEFAULT_AREA_KEY = '';\r\n\r\nexport const AREA_KEYS = {\r\n  STARTER_COVE: 'starter_cove',\r\n  AUTOMATION: AUTOMATION_AREA_KEY,\r\n  DNA: DNA_AREA_KEY,\r\n};\r\n\r\nlet isBatching = false;\r\nconst pendingAreaSaves = new Map(); // key -> {areaKey, stateArr, slot} [Legacy/Fallback]\r\nconst pendingUpgradeSaves = new Map(); // key -> {areaKey, upgId, state, slot}\r\nlet pendingNotify = false;\r\n\r\nconst deferredWrites = new Map();\r\nlet deferredFlushTimer = null;\r\n\r\nfunction flushDeferredWrites() {\r\n  if (deferredWrites.size === 0) return;\r\n  deferredWrites.forEach(({ areaKey, upgId, state, slot }, key) => {\r\n    try {\r\n      const payload = JSON.stringify(state);\r\n      localStorage.setItem(key, payload);\r\n      try { primeStorageWatcherSnapshot(key, payload); } catch {}\r\n    } catch (e) {\r\n      console.warn('Failed to save deferred upgrade state', areaKey, upgId, e);\r\n    }\r\n  });\r\n  deferredWrites.clear();\r\n}\r\n\r\nfunction initDeferredFlush() {\r\n  if (typeof window === 'undefined') return;\r\n  if (deferredFlushTimer) return;\r\n  deferredFlushTimer = setInterval(flushDeferredWrites, 2000);\r\n  try { window.addEventListener('beforeunload', flushDeferredWrites); } catch {}\r\n  try { window.addEventListener('pagehide', flushDeferredWrites); } catch {}\r\n  try { document.addEventListener('visibilitychange', () => {\r\n      if (document.hidden) flushDeferredWrites();\r\n  }); } catch {}\r\n}\r\n\r\nexport function batchUpgradeOperations(fn) {\r\n  if (isBatching) {\r\n    return fn();\r\n  }\r\n  isBatching = true;\r\n  try {\r\n    return fn();\r\n  } finally {\r\n    isBatching = false;\r\n    pendingUpgradeSaves.forEach(({ areaKey, upgId, state, slot }) => {\r\n        try { saveUpgradeState(areaKey, upgId, state, slot); }\r\n        catch (e) { console.warn('Deferred upgrade save failed', e); }\r\n    });\r\n    pendingUpgradeSaves.clear();\r\n    \r\n    // Legacy/Fallback flush\r\n    pendingAreaSaves.forEach(({ areaKey, stateArr, slot }) => {\r\n      try { saveAreaState(areaKey, stateArr, slot); }\r\n      catch (e) { console.warn('Deferred area save failed', e); }\r\n    });\r\n    pendingAreaSaves.clear();\r\n\r\n    if (pendingNotify) {\r\n      pendingNotify = false;\r\n      notifyChanged();\r\n    }\r\n  }\r\n}\r\n\r\nfunction hasScaling(upg) {\r\n  try {\r\n    const scaling = ensureUpgradeScaling(upg);\r\n    if (!scaling) return false;\r\n    if (scaling.ratioMinus1 > 0) return true;\r\n\r\n    const c0 = BigNum.fromAny(upg.costAtLevel?.(0) ?? 0);\r\n    const c1 = BigNum.fromAny(upg.costAtLevel?.(1) ?? 0);\r\n    const cF = BigNum.fromAny(upg.costAtLevel?.(32) ?? 0);\r\n    return !(c0.cmp(c1) === 0 && c0.cmp(cF) === 0);\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\nconst SCALED_INFINITY_LVL_LOG10 = 308;\r\nfunction isInfinityLevelForScaled(upg, lvlBn) {\r\n  if (!hasScaling(upg)) return false;\r\n  try {\r\n    const bn = lvlBn?.clone ? lvlBn : BigNum.fromAny(lvlBn ?? 0);\r\n    if (bn.isInfinite?.()) return true;\r\n    const log10 = approxLog10BigNum(bn);\r\n    return Number.isFinite(log10) && log10 >= SCALED_INFINITY_LVL_LOG10;\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\nconst MAX_LEVEL_STORAGE_LENGTH = 1024;\r\n\r\nfunction sanitizeStoredLevelValue(raw, { allowEmpty = false } = {}) {\r\n  if (typeof raw !== 'string') return raw;\r\n  const trimmed = raw.trim();\r\n  if (!trimmed) return allowEmpty ? '' : '0';\r\n  if (trimmed.length > MAX_LEVEL_STORAGE_LENGTH) return 'Infinity';\r\n\r\n  if (trimmed.startsWith('BN:')) {\r\n    const expPart = trimmed.slice(trimmed.lastIndexOf(':') + 1);\r\n    const caret = expPart.indexOf('^');\r\n    const expDigits = caret >= 0 ? expPart.slice(0, caret) : expPart;\r\n    if (expPart.length > MAX_LEVEL_STORAGE_LENGTH / 2) return 'Infinity';\r\n    if (expDigits.length > MAX_LEVEL_STORAGE_LENGTH / 2) return 'Infinity';\r\n  }\r\n\r\n  return trimmed;\r\n}\r\n\r\n\r\n\r\nexport const UPGRADE_TIES = {\r\n  FASTER_COINS: 'coin_1',\r\n  UNLOCK_XP: 'none_1',\r\n  FASTER_COINS_II: 'book_1',\r\n  COIN_VALUE_I: 'book_2',\r\n  BOOK_VALUE_I: 'book_3',\r\n  XP_VALUE_I: 'coin_2',\r\n  UNLOCK_FORGE: 'none_2',\r\n  COIN_VALUE_II: 'gold_1',\r\n  XP_VALUE_II: 'gold_2',\r\n  MP_VALUE_I: 'gold_3',\r\n  MAGNET: 'gold_4',\r\n  ENDLESS_XP: 'coin_3',\r\n  UNLOCK_INFUSE: 'none_3',\r\n  COIN_VALUE_III: 'magic_1',\r\n  XP_VALUE_III: 'magic_2',\r\n  MP_VALUE_II: 'magic_3',\r\n  FASTER_COINS_III: 'magic_4',\r\n  ENDLESS_MP: 'coin_4',\r\n  UNLOCK_SURGE: 'none_4',\r\n  ENDLESS_COINS: 'book_4',\r\n  ENDLESS_COINS_II: 'gold_5',\r\n  ENDLESS_COINS_III: 'magic_5',\r\n};\r\n\r\nconst HM_MILESTONES_STARTER_COVE = [\r\n  { level: 10, multiplier: 1.5, target: 'self' },\r\n  { level: 25, multiplier: 2, target: 'self' },\r\n  { level: 50, multiplier: 5, target: 'mp' },\r\n  { level: 100, multiplier: 10, target: 'xp' },\r\n  { level: 200, multiplier: 15, target: 'coin' },\r\n  { level: 400, multiplier: 25, target: 'self' },\r\n  { level: 800, multiplier: 100, target: 'self' },\r\n];\r\n\r\nconst HM_MILESTONES_BY_AREA = {\r\n  [AREA_KEYS.STARTER_COVE]: HM_MILESTONES_STARTER_COVE,\r\n};\r\n\r\nconst LOCKED_UPGRADE_ICON_DATA_URL = 'img/misc/locked.webp';\r\nconst MYSTERIOUS_UPGRADE_ICON_DATA_URL = 'img/misc/mysterious.webp';\r\nconst HIDDEN_UPGRADE_TITLE = 'Hidden Upgrade';\r\nconst LOCKED_UPGRADE_TITLE = 'Locked Upgrade';\r\nconst FORGE_PLACEHOLDER_TIES = new Set([\r\n  UPGRADE_TIES.COIN_VALUE_II,\r\n  UPGRADE_TIES.XP_VALUE_II,\r\n  UPGRADE_TIES.MP_VALUE_I,\r\n  UPGRADE_TIES.MAGNET,\r\n  UPGRADE_TIES.ENDLESS_XP,\r\n]);\r\nconst INFUSE_PLACEHOLDER_TIES = new Set([\r\n  UPGRADE_TIES.COIN_VALUE_III,\r\n  UPGRADE_TIES.XP_VALUE_III,\r\n  UPGRADE_TIES.MP_VALUE_II,\r\n  UPGRADE_TIES.FASTER_COINS_III,\r\n  UPGRADE_TIES.ENDLESS_MP,\r\n]);\r\nconst SPECIAL_LOCK_STATE_TIES = new Set([\r\n  UPGRADE_TIES.UNLOCK_XP,\r\n  UPGRADE_TIES.UNLOCK_FORGE,\r\n  UPGRADE_TIES.UNLOCK_INFUSE,\r\n  UPGRADE_TIES.UNLOCK_SURGE,\r\n  ...FORGE_PLACEHOLDER_TIES,\r\n  ...INFUSE_PLACEHOLDER_TIES,\r\n]);\r\nconst XP_MYSTERY_UPGRADE_TIES = new Set([\r\n  UPGRADE_TIES.FASTER_COINS_II,\r\n  UPGRADE_TIES.COIN_VALUE_I,\r\n  UPGRADE_TIES.BOOK_VALUE_I,\r\n  UPGRADE_TIES.XP_VALUE_I,\r\n]);\r\nconst XP_MYSTERY_LEGACY_KEYS = new Set([\r\n  'starter_cove:3',\r\n  'starter_cove:4',\r\n  'starter_cove:5',\r\n  'starter_cove:6',\r\n]);\r\nconst MERCHANT_MET_KEY_BASE = 'ccc:merchantMet';\r\nconst SHOP_REVEAL_STATE_KEY_BASE = 'ccc:shop:reveals';\r\nconst SHOP_PERMA_UNLOCK_KEY_BASE = 'ccc:shop:permaUnlocks';\r\nconst SHOP_PERMA_MYST_KEY_BASE   = 'ccc:shop:permaMyst';\r\nconst SHOP_REVEAL_STATUS_ORDER = { locked: 0, mysterious: 1, unlocked: 2 };\r\nconst shopRevealStateCache = new Map();\r\nconst shopPermaUnlockStateCache = new Map();\r\nconst shopPermaMystStateCache   = new Map();\r\nconst upgradeTieLookup = new Map();\r\nconst BOOK_VALUE_TIE_KEY = normalizeUpgradeTie(UPGRADE_TIES.BOOK_VALUE_I);\r\n\r\nconst BN = BigNum;\r\nconst toBn = (x) => BN.fromAny(x ?? 0);\r\n\r\nfunction effectBN(fn) {\r\n  return (level) => {\r\n    const L = toBn(level);\r\n    let out;\r\n    try { out = fn({ L, BN }); } catch { out = 1; }\r\n    if (out instanceof BN) return out;\r\n    const n = Number(out);\r\n    if (Number.isFinite(n)) return n;\r\n    try { return BN.fromAny(out ?? 1); } catch { return BN.fromInt(1); }\r\n  };\r\n}\r\n\r\nconst E = {\r\n  addPctPerLevel(p) {\r\n    const pNum = Number(p);\r\n    const pStr = String(pNum);\r\n    return (level) => {\r\n      const L = toBn(level);\r\n      try {\r\n        const plain = L.toPlainIntegerString?.();\r\n        if (plain && plain !== 'Infinity' && plain.length <= 15) {\r\n          const lvl = Math.max(0, Number(plain));\r\n          return 1 + pNum * lvl;\r\n        }\r\n      } catch {}\r\n      try { return BN.fromInt(1).add(L.mulDecimal(pStr)); }\r\ncatch {\r\n  const logL = approxLog10BigNum(L);\r\n  if (Number.isFinite(logL)) {\r\n    const logTerm = logL + Math.log10(Math.abs(pNum || 0));\r\n    return bigNumFromLog10(logTerm);\r\n  }\r\n  return BigNum.fromAny('Infinity');\r\n}\r\n\r\n    };\r\n  },\r\n\r\n  addFlatPerLevel(x) {\r\n    const xNum = Number(x);\r\n    const xStr = String(xNum);\r\n    return (level) => {\r\n      const L = toBn(level);\r\n      try {\r\n        const plain = L.toPlainIntegerString?.();\r\n        if (plain && plain !== 'Infinity' && plain.length <= 15) {\r\n          const lvl = Math.max(0, Number(plain));\r\n          return 1 + xNum * lvl;\r\n        }\r\n      } catch {}\r\n      try { return BN.fromInt(1).add(L.mulDecimal(xStr)); } catch { return 1; }\r\n    };\r\n  },\r\n\r\n  powPerLevel(base) {\r\n    const baseNum = Number(base);\r\n    const b = Number.isFinite(baseNum) ? baseNum : Number(toBn(base).toScientific(6));\r\n    const log10b = Math.log10(b);\r\n    const LOG10_INFINITY_TRIGGER = 1e305;\r\n\r\n    return (level) => {\r\n      const L = toBn(level);\r\n\r\n      if (log10b > 0) {\r\n        const approxLevelLog = approxLog10BigNum(L);\r\n\r\n        if (!Number.isFinite(approxLevelLog)) {\r\n          if (approxLevelLog > 0) return BigNum.fromAny('Infinity');\r\n        } else {\r\n          const triggerLevelLog = Math.log10(LOG10_INFINITY_TRIGGER / log10b);\r\n          if (approxLevelLog >= triggerLevelLog) return BigNum.fromAny('Infinity');\r\n        }\r\n      }\r\n\r\n      try {\r\n        const plain = L.toPlainIntegerString?.();\r\n        if (plain && plain !== 'Infinity' && plain.length <= 7) {\r\n          const lvl = Math.max(0, Number(plain));\r\n          const log10 = log10b * lvl;\r\n\r\n          if (log10 < 308) {\r\n            const val = Math.pow(b, lvl);\r\n            if (Number.isFinite(val)) return val;\r\n          }\r\n          return bigNumFromLog10(log10);\r\n        }\r\n      } catch {}\r\n\r\n      try {\r\n        const approxLvl = levelBigNumToNumber(L);\r\n        const log10 = log10b * approxLvl;\r\n        return bigNumFromLog10(log10);\r\n      } catch {\r\n        return BigNum.fromInt(1);\r\n      }\r\n    };\r\n  }\r\n};\r\n\r\nfunction shopStatusRank(status) {\r\n  return SHOP_REVEAL_STATUS_ORDER[status] ?? 0;\r\n}\r\n\r\nfunction classifyUpgradeStatus(lockState) {\r\n  if (!lockState || lockState.locked === false) return 'unlocked';\r\n  if (lockState.hidden) return 'mysterious';\r\n  return 'locked';\r\n}\r\n\r\nfunction upgradeRevealKey(areaKey, upg) {\r\n  const normArea = normalizeAreaKey(areaKey || upg?.area);\r\n  if (!normArea) return null;\r\n  const tieKey = normalizeUpgradeTie(upg?.tie ?? upg?.tieKey);\r\n  if (tieKey) {\r\n    return `${normArea}:${tieKey}`;\r\n  }\r\n  const rawId = normalizeUpgradeId(upg?.id);\r\n  let idStr = '';\r\n  if (typeof rawId === 'number') {\r\n    if (!Number.isFinite(rawId)) return null;\r\n    idStr = String(Math.trunc(rawId));\r\n  } else if (typeof rawId === 'string') {\r\n    const trimmed = rawId.trim();\r\n    if (!trimmed) return null;\r\n    idStr = trimmed;\r\n  } else {\r\n    return null;\r\n  }\r\n  return `${normArea}:${idStr}`;\r\n}\r\n\r\nfunction upgradeLegacyRevealKey(areaKey, upg) {\r\n  const normArea = normalizeAreaKey(areaKey || upg?.area);\r\n  if (!normArea) return null;\r\n  const rawId = normalizeUpgradeId(upg?.id);\r\n  if (rawId == null) return null;\r\n  if (typeof rawId === 'number') {\r\n    if (!Number.isFinite(rawId)) return null;\r\n    return `${normArea}:${Math.trunc(rawId)}`;\r\n  }\r\n  const trimmed = String(rawId).trim();\r\n  return trimmed ? `${normArea}:${trimmed}` : null;\r\n}\r\n\r\nfunction migrateUpgradeStateKey(state, fromKey, toKey) {\r\n  if (!state || !state.upgrades || typeof state.upgrades !== 'object') return false;\r\n  if (!fromKey || !toKey || fromKey === toKey) return false;\r\n  if (state.upgrades[toKey]) return false;\r\n  if (!state.upgrades[fromKey]) return false;\r\n  state.upgrades[toKey] = state.upgrades[fromKey];\r\n  delete state.upgrades[fromKey];\r\n  return true;\r\n}\r\n\r\nfunction ensureShopRevealState(slot = getActiveSlot()) {\r\n  const slotKey = String(slot ?? 'default');\r\n  if (shopRevealStateCache.has(slotKey)) {\r\n    return shopRevealStateCache.get(slotKey);\r\n  }\r\n\r\n  let parsed = { upgrades: {} };\r\n  if (typeof localStorage !== 'undefined') {\r\n    try {\r\n      const raw = localStorage.getItem(`${SHOP_REVEAL_STATE_KEY_BASE}:${slotKey}`);\r\n      if (raw) {\r\n        const obj = JSON.parse(raw);\r\n        if (obj && typeof obj === 'object') {\r\n          const upgrades = (obj.upgrades && typeof obj.upgrades === 'object') ? obj.upgrades : {};\r\n          parsed = { upgrades };\r\n        }\r\n      }\r\n    } catch {}\r\n  }\r\n\r\n  if (!parsed || typeof parsed !== 'object') parsed = { upgrades: {} };\r\n  if (!parsed.upgrades || typeof parsed.upgrades !== 'object') parsed.upgrades = {};\r\n\r\n  shopRevealStateCache.set(slotKey, parsed);\r\n  return parsed;\r\n}\r\n\r\nfunction saveShopRevealState(state, slot = getActiveSlot()) {\r\n  const slotKey = String(slot ?? 'default');\r\n  if (!state || typeof state !== 'object') {\r\n    state = { upgrades: {} };\r\n  }\r\n  if (!state.upgrades || typeof state.upgrades !== 'object') {\r\n    state.upgrades = {};\r\n  }\r\n  shopRevealStateCache.set(slotKey, state);\r\n  if (typeof localStorage === 'undefined') return;\r\n  try {\r\n    localStorage.setItem(`${SHOP_REVEAL_STATE_KEY_BASE}:${slotKey}`, JSON.stringify(state));\r\n  } catch {}\r\n}\r\n\r\nfunction ensureShopPermaUnlockState(slot = getActiveSlot()) {\r\n  const slotKey = String(slot ?? 'default');\r\n  if (shopPermaUnlockStateCache.has(slotKey)) {\r\n    return shopPermaUnlockStateCache.get(slotKey);\r\n  }\r\n\r\n  let parsed = { upgrades: {} };\r\n  if (typeof localStorage !== 'undefined') {\r\n    try {\r\n      const raw = localStorage.getItem(`${SHOP_PERMA_UNLOCK_KEY_BASE}:${slotKey}`);\r\n      if (raw) {\r\n        const obj = JSON.parse(raw);\r\n        if (obj && typeof obj === 'object') {\r\n          const upgrades = (obj.upgrades && typeof obj.upgrades === 'object') ? obj.upgrades : {};\r\n          parsed = { upgrades };\r\n        }\r\n      }\r\n    } catch {}\r\n  }\r\n\r\n  if (!parsed || typeof parsed !== 'object') parsed = { upgrades: {} };\r\n  if (!parsed.upgrades || typeof parsed.upgrades !== 'object') parsed.upgrades = {};\r\n\r\n  shopPermaUnlockStateCache.set(slotKey, parsed);\r\n  return parsed;\r\n}\r\n\r\nfunction saveShopPermaUnlockState(state, slot = getActiveSlot()) {\r\n  const slotKey = String(slot ?? 'default');\r\n  if (!state || typeof state !== 'object') {\r\n    state = { upgrades: {} };\r\n  }\r\n  if (!state.upgrades || typeof state.upgrades !== 'object') {\r\n    state.upgrades = {};\r\n  }\r\n  shopPermaUnlockStateCache.set(slotKey, state);\r\n  if (typeof localStorage === 'undefined') return;\r\n  try {\r\n    localStorage.setItem(`${SHOP_PERMA_UNLOCK_KEY_BASE}:${slotKey}`, JSON.stringify(state));\r\n  } catch {}\r\n}\r\n\r\nfunction ensureShopPermaMystState(slot = getActiveSlot()) {\r\n  const slotKey = String(slot ?? 'default');\r\n  if (shopPermaMystStateCache.has(slotKey)) {\r\n    return shopPermaMystStateCache.get(slotKey);\r\n  }\r\n  let parsed = { upgrades: {} };\r\n  if (typeof localStorage !== 'undefined') {\r\n    try {\r\n      const raw = localStorage.getItem(`${SHOP_PERMA_MYST_KEY_BASE}:${slotKey}`);\r\n      if (raw) {\r\n        const obj = JSON.parse(raw);\r\n        if (obj && typeof obj === 'object') {\r\n          const upgrades = (obj.upgrades && typeof obj.upgrades === 'object') ? obj.upgrades : {};\r\n          parsed = { upgrades };\r\n        }\r\n      }\r\n    } catch {}\r\n  }\r\n  if (!parsed || typeof parsed !== 'object') parsed = { upgrades: {} };\r\n  if (!parsed.upgrades || typeof parsed.upgrades !== 'object') parsed.upgrades = {};\r\n  shopPermaMystStateCache.set(slotKey, parsed);\r\n  return parsed;\r\n}\r\n\r\nfunction saveShopPermaMystState(state, slot = getActiveSlot()) {\r\n  const slotKey = String(slot ?? 'default');\r\n  if (!state || typeof state !== 'object') state = { upgrades: {} };\r\n  if (!state.upgrades || typeof state.upgrades !== 'object') state.upgrades = {};\r\n  shopPermaMystStateCache.set(slotKey, state);\r\n  if (typeof localStorage === 'undefined') return;\r\n  try {\r\n    localStorage.setItem(`${SHOP_PERMA_MYST_KEY_BASE}:${slotKey}`, JSON.stringify(state));\r\n  } catch {}\r\n}\r\n\r\nfunction markUpgradePermanentlyMysterious(areaKey, upg, slot = getActiveSlot()) {\r\n  const key = upgradeRevealKey(areaKey, upg);\r\n  if (!key) return;\r\n  const legacyKey = upgradeLegacyRevealKey(areaKey, upg);\r\n  const state = ensureShopPermaMystState(slot);\r\n  if (state.upgrades[key]) return;\r\n  state.upgrades[key] = true;\r\n  if (legacyKey && state.upgrades[legacyKey]) {\r\n    delete state.upgrades[legacyKey];\r\n  }\r\n  saveShopPermaMystState(state, slot);\r\n}\r\n\r\nfunction isUpgradePermanentlyMysterious(areaKey, upg, slot = getActiveSlot()) {\r\n  const key = upgradeRevealKey(areaKey, upg);\r\n  if (!key) return false;\r\n  const legacyKey = upgradeLegacyRevealKey(areaKey, upg);\r\n  const state = ensureShopPermaMystState(slot);\r\n  if (state.upgrades[key]) return true;\r\n  if (legacyKey && state.upgrades[legacyKey]) {\r\n    state.upgrades[key] = state.upgrades[legacyKey];\r\n    delete state.upgrades[legacyKey];\r\n    saveShopPermaMystState(state, slot);\r\n    return true;\r\n  }\r\n  return false;\r\n}\r\n\r\nexport function markUpgradePermanentlyUnlocked(areaKey, upg, slot = getActiveSlot()) {\r\n  const key = upgradeRevealKey(areaKey, upg);\r\n  if (!key) return;\r\n  const legacyKey = upgradeLegacyRevealKey(areaKey, upg);\r\n  const state = ensureShopPermaUnlockState(slot);\r\n  if (state.upgrades[key]) return;\r\n  state.upgrades[key] = true;\r\n  if (legacyKey && state.upgrades[legacyKey]) {\r\n    delete state.upgrades[legacyKey];\r\n  }\r\n  saveShopPermaUnlockState(state, slot);\r\n}\r\n\r\nexport function clearPermanentUpgradeUnlock(areaKey, upg, slot = getActiveSlot()) {\r\n  const key = upgradeRevealKey(areaKey, upg);\r\n  if (!key) return;\r\n\r\n  const permaState = ensureShopPermaUnlockState(slot);\r\n  if (permaState.upgrades[key]) {\r\n    delete permaState.upgrades[key];\r\n    saveShopPermaUnlockState(permaState, slot);\r\n  }\r\n\r\n  const revealState = ensureShopRevealState(slot);\r\n  if (!revealState.upgrades[key] || revealState.upgrades[key].status !== 'locked') {\r\n    revealState.upgrades[key] = { status: 'locked' };\r\n    saveShopRevealState(revealState, slot);\r\n  }\r\n\r\n  const upgId = typeof upg?.id !== 'undefined' ? upg.id : upg;\r\n  if (upgId != null) {\r\n    invalidateUpgradeState(areaKey, upgId, slot);\r\n  }\r\n  notifyChanged();\r\n}\r\n\r\nfunction isUpgradePermanentlyUnlocked(areaKey, upg, slot = getActiveSlot()) {\r\n  const key = upgradeRevealKey(areaKey, upg);\r\n  if (!key) return false;\r\n  const legacyKey = upgradeLegacyRevealKey(areaKey, upg);\r\n  const state = ensureShopPermaUnlockState(slot);\r\n  if (state.upgrades[key]) return true;\r\n  if (legacyKey && state.upgrades[legacyKey]) {\r\n    state.upgrades[key] = state.upgrades[legacyKey];\r\n    delete state.upgrades[legacyKey];\r\n    saveShopPermaUnlockState(state, slot);\r\n    return true;\r\n  }\r\n  return false;\r\n}\r\n\r\nfunction determineLockState(ctx) {\r\n  // Be robust if called unbound or without ctx.upg\r\n  const upgRef = (ctx && ctx.upg) ? ctx.upg : (this && typeof this === 'object' ? this : null);\r\n  const tieKey = normalizeUpgradeTie(upgRef?.tie ?? upgRef?.tieKey);\r\n  const area = ctx?.areaKey || AREA_KEYS.STARTER_COVE;\r\n\r\n  if (!tieKey || !SPECIAL_LOCK_STATE_TIES.has(tieKey)) {\r\n    return { locked: true, iconOverride: LOCKED_UPGRADE_ICON_DATA_URL, useLockedBase: true };\r\n  }\r\n\r\n  // If any level has already been bought, it\u2019s unlocked.\r\n  let currentLevel = 0;\r\n  try {\r\n    currentLevel = (upgRef && typeof upgRef.id !== 'undefined') ? getLevelNumber(area, upgRef.id) : 0;\r\n  } catch {}\r\n  if (currentLevel >= 1) {\r\n    return { locked: false, hidden: false, useLockedBase: false };\r\n  }\r\n\r\n  // XPs unlocked?\r\n  let xpUnlocked = false;\r\n  try {\r\n    xpUnlocked = (ctx && typeof ctx.xpUnlocked !== 'undefined')\r\n      ? !!ctx.xpUnlocked\r\n      : safeIsXpUnlocked();\r\n  } catch {}\r\n\r\n  function determineUnlockXpLockState() {\r\n    if (safeHasMetMerchant()) {\r\n      // Merchant met -> upgrade is fully visible and purchasable\r\n      return {\r\n        locked: false,\r\n        hidden: false,\r\n        hideCost: false,\r\n        hideEffect: false,\r\n        useLockedBase: false,\r\n      };\r\n    }\r\n\r\n    // Merchant not met -> mysterious placeholder\r\n    const revealText = 'Explore the Delve menu to reveal this upgrade';\r\n    return {\r\n      locked: true,\r\n      iconOverride: MYSTERIOUS_UPGRADE_ICON_DATA_URL,\r\n      titleOverride: HIDDEN_UPGRADE_TITLE,\r\n      descOverride: revealText,\r\n      reason: revealText,\r\n      hidden: true,\r\n      hideCost: true,\r\n      hideEffect: true,\r\n      useLockedBase: true,\r\n    };\r\n  }\r\n\r\n  // ==== Unlock XP ====\r\n  if (tieKey === UPGRADE_TIES.UNLOCK_XP) {\r\n    return determineUnlockXpLockState();\r\n  }\r\n\r\n  // ==== Unlock Forge ====\r\n  if (tieKey === UPGRADE_TIES.UNLOCK_FORGE) {\r\n    // No XP system -> LOCKED padlock\r\n    if (!xpUnlocked) {\r\n      return { locked: true, iconOverride: LOCKED_UPGRADE_ICON_DATA_URL, useLockedBase: true };\r\n    }\r\n    // Before 31 -> show same requirement text as mysterious, but without generic \"hidden\" line\r\n    let xp31 = false;\r\n    try { const xpBn = currentXpLevelBigNum(); xp31 = levelBigNumToNumber(xpBn) >= 31; } catch {}\r\n    if (!xp31) {\r\n      const revealText = (upgRef?.revealRequirement) || 'Reach XP Level 31 to reveal this upgrade';\r\n      return {\r\n        locked: true,\r\n        iconOverride: MYSTERIOUS_UPGRADE_ICON_DATA_URL,\r\n        hidden: true,\r\n        hideCost: true,\r\n        hideEffect: true,\r\n        useLockedBase: true,\r\n        titleOverride: HIDDEN_UPGRADE_TITLE,\r\n        descOverride: revealText,\r\n        reason: revealText,\r\n      };\r\n    }\r\n    // XP \u2265 31 -> visible/unlocked\r\n    return { locked: false };\r\n  }\r\n\r\n  // ==== Unlock Infuse ====\r\n  if (tieKey === UPGRADE_TIES.UNLOCK_INFUSE) {\r\n    if (!hasDoneForgeReset()) {\r\n      return {\r\n        locked: true,\r\n        iconOverride: LOCKED_UPGRADE_ICON_DATA_URL,\r\n        useLockedBase: true,\r\n        hidden: false,\r\n        hideCost: true,\r\n        hideEffect: true,\r\n        titleOverride: LOCKED_UPGRADE_TITLE,\r\n        descOverride: 'Do a Forge reset to reveal this upgrade',\r\n        reason: 'Do a Forge reset to reveal this upgrade',\r\n      };\r\n    }\r\n\r\n    let xp101 = false;\r\n    try { const xpBn = currentXpLevelBigNum(); xp101 = levelBigNumToNumber(xpBn) >= 101; } catch {}\r\n    if (!xp101) {\r\n      const revealText = (upgRef?.revealRequirement) || 'Reach XP Level 101 to reveal this upgrade';\r\n      return {\r\n        locked: true,\r\n        iconOverride: MYSTERIOUS_UPGRADE_ICON_DATA_URL,\r\n        hidden: true,\r\n        hideCost: true, hideEffect: true, useLockedBase: true,\r\n        titleOverride: HIDDEN_UPGRADE_TITLE,\r\n        descOverride: revealText,\r\n        reason: revealText,\r\n      };\r\n    }\r\n    return { locked: false };\r\n  }\r\n\r\n  // ==== Unlock Surge ====\r\n  if (tieKey === UPGRADE_TIES.UNLOCK_SURGE) {\r\n    if (!hasDoneInfuseReset()) {\r\n      return {\r\n        locked: true,\r\n        iconOverride: LOCKED_UPGRADE_ICON_DATA_URL,\r\n        useLockedBase: true,\r\n        hidden: false,\r\n        hideCost: true,\r\n        hideEffect: true,\r\n        titleOverride: LOCKED_UPGRADE_TITLE,\r\n        descOverride: 'Do an Infuse reset to reveal this upgrade',\r\n        reason: 'Do an Infuse reset to reveal this upgrade',\r\n      };\r\n    }\r\n\r\n    let xp201 = false;\r\n    try { const xpBn = currentXpLevelBigNum(); xp201 = levelBigNumToNumber(xpBn) >= 201; } catch {}\r\n    if (!xp201) {\r\n      const revealText = (upgRef?.revealRequirement) || 'Reach XP Level 201 to reveal this upgrade';\r\n      return {\r\n        locked: true,\r\n        iconOverride: MYSTERIOUS_UPGRADE_ICON_DATA_URL,\r\n        hidden: true,\r\n        hideCost: true, hideEffect: true, useLockedBase: true,\r\n        titleOverride: HIDDEN_UPGRADE_TITLE,\r\n        descOverride: revealText,\r\n        reason: revealText,\r\n      };\r\n    }\r\n    return { locked: false };\r\n  }\r\n\r\n  // ==== Infuse Placeholders ====\r\n  if (INFUSE_PLACEHOLDER_TIES.has(tieKey)) {\r\n    if (hasDoneInfuseReset() || isUpgradePermanentlyUnlocked(area, upgRef)) {\r\n      try { markUpgradePermanentlyUnlocked(area, upgRef); } catch {}\r\n      return { locked: false, hidden: false, useLockedBase: false };\r\n    }\r\n\r\n    let xp101 = false;\r\n    try { const xpBn = currentXpLevelBigNum(); xp101 = levelBigNumToNumber(xpBn) >= 101; } catch {}\r\n\r\n    // Before 101 -> hard LOCKED\r\n    if (!xp101) {\r\n      return {\r\n        locked: true,\r\n        iconOverride: LOCKED_UPGRADE_ICON_DATA_URL,\r\n        useLockedBase: true,\r\n        titleOverride: LOCKED_UPGRADE_TITLE,\r\n        descOverride: 'Locked',\r\n        reason: 'Locked',\r\n        hidden: false,\r\n        hideCost: false,\r\n        hideEffect: false,\r\n      };\r\n    }\r\n\r\n    // 101+ -> Mysterious\r\n    const revealText = 'Do an Infuse reset to reveal this upgrade';\r\n    try { markUpgradePermanentlyMysterious(area, upgRef); } catch {}\r\n    return {\r\n      locked: true,\r\n      iconOverride: MYSTERIOUS_UPGRADE_ICON_DATA_URL,\r\n      hidden: true, hideCost: true, hideEffect: true, useLockedBase: true,\r\n      titleOverride: HIDDEN_UPGRADE_TITLE,\r\n      descOverride: revealText,\r\n      reason: revealText,\r\n    };\r\n  }\r\n\r\n  if (hasDoneForgeReset() || isUpgradePermanentlyUnlocked(area, upgRef)) {\r\n    try { markUpgradePermanentlyUnlocked(area, upgRef); } catch {}\r\n    return { locked: false, hidden: false, useLockedBase: false };\r\n  }\r\n\r\n  // No XP system -> LOCKED padlock\r\n  if (!xpUnlocked) {\r\n    return { locked: true, iconOverride: LOCKED_UPGRADE_ICON_DATA_URL, useLockedBase: true };\r\n  }\r\n\r\n  if (isUpgradePermanentlyMysterious(area, upgRef)) {\r\n    const revealText = 'Do a Forge reset to reveal this upgrade';\r\n    return {\r\n      locked: true,\r\n      iconOverride: MYSTERIOUS_UPGRADE_ICON_DATA_URL,\r\n      hidden: true, hideCost: true, hideEffect: true, useLockedBase: true,\r\n      titleOverride: HIDDEN_UPGRADE_TITLE,\r\n      descOverride: revealText,\r\n      reason: revealText,\r\n    };\r\n  }\r\n\r\n  // Compute XP \u2265 31 once (for the *first-time* reveal/burn)\r\n  let xp31 = false;\r\n  try { const xpBn = currentXpLevelBigNum(); xp31 = levelBigNumToNumber(xpBn) >= 31; } catch {}\r\n\r\n// Before 31 -> hard LOCKED (not mysterious, not clickable)\r\nif (!xp31) {\r\n  const revealText = 'Do a Forge reset to reveal this upgrade';\r\n  return {\r\n    locked: true,\r\n    iconOverride: LOCKED_UPGRADE_ICON_DATA_URL,\r\n    useLockedBase: true,\r\n    titleOverride: LOCKED_UPGRADE_TITLE,\r\n    descOverride: revealText,\r\n    reason: revealText,\r\n    hidden: false,\r\n    hideCost: false,\r\n    hideEffect: false,\r\n  };\r\n}\r\n\r\n  // First time hitting 31 -> burn perma-mysterious and show MYSTERIOUS\r\n  try { markUpgradePermanentlyMysterious(area, upgRef); } catch {}\r\n  return {\r\n    locked: true,\r\n    iconOverride: MYSTERIOUS_UPGRADE_ICON_DATA_URL,\r\n    hidden: true, hideCost: true, hideEffect: true, useLockedBase: true,\r\n  };\r\n}\r\n\r\nfunction snapshotUpgradeLockState(lockState) {\r\n  if (!lockState || typeof lockState !== 'object') return null;\r\n  const snapshot = {};\r\n  const keys = [\r\n    'iconOverride',\r\n    'titleOverride',\r\n    'descOverride',\r\n    'reason',\r\n    'hideCost',\r\n    'hideEffect',\r\n    'hidden',\r\n    'useLockedBase',\r\n  ];\r\n  for (const key of keys) {\r\n    if (lockState[key] !== undefined) snapshot[key] = lockState[key];\r\n  }\r\n  return snapshot;\r\n}\r\n\r\nfunction normalizeAreaKey(areaKey) {\r\n  if (typeof areaKey === 'string') {\r\n    const trimmed = areaKey.trim();\r\n    if (trimmed) {\r\n      return trimmed.toLowerCase().replace(/[^a-z0-9]+/g, '_');\r\n    }\r\n  }\r\n  return '';\r\n}\r\n\r\nfunction normalizeUpgradeTie(tieValue) {\r\n  if (typeof tieValue === 'string') {\r\n    const trimmed = tieValue.trim();\r\n    if (trimmed) {\r\n      return trimmed.toLowerCase().replace(/[^a-z0-9]+/g, '_');\r\n    }\r\n  }\r\n  return '';\r\n}\r\n\r\n\r\nfunction isXpAdjacentUpgrade(areaKey, upg) {\r\n  const tieKey = normalizeUpgradeTie(upg?.tie ?? upg?.tieKey);\r\n  if (tieKey && XP_MYSTERY_UPGRADE_TIES.has(tieKey)) {\r\n    return true;\r\n  }\r\n  const normalizedId = normalizeUpgradeId(upg?.id);\r\n  const numericId = typeof normalizedId === 'number'\r\n    ? normalizedId\r\n    : Number.parseInt(normalizedId, 10);\r\n  const idKey = Number.isFinite(numericId)\r\n    ? String(numericId)\r\n    : (normalizedId != null ? String(normalizedId) : '');\r\n  if (!idKey) return false;\r\n\r\n  const areaCandidates = [];\r\n  if (areaKey != null) areaCandidates.push(areaKey);\r\n  if (upg?.area != null) areaCandidates.push(upg.area);\r\n\r\n  for (const candidate of areaCandidates) {\r\n    const normArea = normalizeAreaKey(candidate);\r\n    if (!normArea) continue;\r\n    if (XP_MYSTERY_LEGACY_KEYS.has(`${normArea}:${idKey}`)) {\r\n      return true;\r\n    }\r\n  }\r\n\r\n  return false;\r\n}\r\n\r\nfunction safeIsXpUnlocked() {\r\n  try {\r\n    return !!isXpSystemUnlocked();\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\nfunction safeHasMetMerchant(slot = getActiveSlot()) {\r\n  const slotKey = String(slot ?? 'default');\r\n  if (typeof localStorage === 'undefined') return false;\r\n  try {\r\n    return localStorage.getItem(`${MERCHANT_MET_KEY_BASE}:${slotKey}`) === '1';\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\nfunction currentXpLevelBigNum() {\r\n  try {\r\n    const state = typeof getXpState === 'function' ? getXpState() : null;\r\n    if (state?.xpLevel instanceof BigNum) {\r\n      return state.xpLevel.clone?.() ?? state.xpLevel;\r\n    }\r\n    if (state?.xpLevel != null) {\r\n      return BigNum.fromAny(state.xpLevel);\r\n    }\r\n  } catch {}\r\n  return BigNum.fromInt(0);\r\n}\r\n\r\n\r\n\r\nexport function normalizedUpgradeLevel(levelValue) {\r\n  if (typeof levelValue === 'number' && Number.isFinite(levelValue)) {\r\n    return Math.max(0, Math.floor(levelValue));\r\n  }\r\n  if (typeof levelValue === 'bigint') {\r\n    if (levelValue < 0n) return 0;\r\n    const maxSafe = BigInt(Number.MAX_SAFE_INTEGER);\r\n    const clamped = levelValue > maxSafe ? maxSafe : levelValue;\r\n    return Number(clamped);\r\n  }\r\n  if (levelValue instanceof BigNum) {\r\n    try {\r\n      const plain = levelValue.toPlainIntegerString?.();\r\n      if (plain && plain !== 'Infinity') {\r\n        const parsed = Number.parseInt(plain, 10);\r\n        if (Number.isFinite(parsed)) {\r\n          return Math.max(0, parsed);\r\n        }\r\n      }\r\n    } catch {}\r\n  }\r\n  return 0;\r\n}\r\n\r\nfunction getLinearBonusMultiplier(levelValue, amountPerLevel) {\r\n  const lvl = normalizedUpgradeLevel(levelValue);\r\n  if (lvl <= 0) {\r\n    return BigNum.fromInt(1);\r\n  }\r\n  const perLevel = Math.max(0, Math.floor(Number(amountPerLevel) || 0));\r\n  if (perLevel === 0) return BigNum.fromInt(1);\r\n\r\n  try {\r\n    const asBigInt = (BigInt(lvl) * BigInt(perLevel)) + 1n;\r\n    return BigNum.fromAny(asBigInt.toString());\r\n  } catch {\r\n    try {\r\n      return BigNum.fromAny(String(1 + perLevel * lvl));\r\n    } catch {\r\n      return BigNum.fromInt(1);\r\n    }\r\n  }\r\n}\r\n\r\nfunction mergeLockStates(base, override) {\r\n  const merged = Object.assign({ locked: false }, base || {});\r\n  if (!override || typeof override !== 'object') return merged;\r\n  const keys = [\r\n    'locked',\r\n    'iconOverride',\r\n    'titleOverride',\r\n    'descOverride',\r\n    'reason',\r\n    'hideCost',\r\n    'hideEffect',\r\n    'hidden',\r\n    'useLockedBase',\r\n  ];\r\n  for (const key of keys) {\r\n    if (override[key] !== undefined) merged[key] = override[key];\r\n  }\r\n  return merged;\r\n}\r\n\r\nfunction normalizeUpgradeId(upgId) {\r\n  if (typeof upgId === 'number') {\r\n    if (!Number.isFinite(upgId)) return upgId;\r\n    return Math.trunc(upgId);\r\n  }\r\n  if (typeof upgId === 'string') {\r\n    const trimmed = upgId.trim();\r\n    if (!trimmed) return trimmed;\r\n    if (/^[+-]?\\d+$/.test(trimmed)) {\r\n      const parsed = Number.parseInt(trimmed, 10);\r\n      if (Number.isFinite(parsed)) return parsed;\r\n    }\r\n    return trimmed;\r\n  }\r\n  return upgId;\r\n}\r\n\r\nexport function ensureLevelBigNum(value) {\r\n  try {\r\n    value = sanitizeStoredLevelValue(value, { allowEmpty: true });\r\n    if (typeof value === 'string') {\r\n      const trimmed = value.trim();\r\n      if (!trimmed) return BigNum.fromInt(0);\r\n      if (/^inf(?:inity)?$/i.test(trimmed)) return BigNum.fromAny('Infinity');\r\n\r\n      // If the value is an enormous integer string, avoid constructing a huge BigInt.\r\n      if (!trimmed.startsWith('BN:') && /^[+-]?\\d+$/.test(trimmed)) {\r\n        const unsigned = trimmed.replace(/^[+-]/, '').replace(/^0+(?=\\d)/, '');\r\n        if (!unsigned) return BigNum.fromInt(0);\r\n        if (unsigned.length > BigNum.MAX_PLAIN_DIGITS) return BigNum.fromAny('Infinity');\r\n        if (unsigned.length > 32) {\r\n          return bigNumFromLog10(unsigned.length - 1);\r\n        }\r\n      }\r\n    }\r\n\r\n    const bn = value instanceof BigNum ? value : BigNum.fromAny(value ?? 0);\r\n    if (bn.isInfinite?.()) return bn.clone?.() ?? bn;\r\n\r\n    const approxDigits = approxLog10BigNum(bn);\r\n    if (!Number.isFinite(approxDigits)) {\r\n      return approxDigits > 0 ? BigNum.fromAny('Infinity') : BigNum.fromInt(0);\r\n    }\r\n    if (approxDigits + 1 > BigNum.MAX_PLAIN_DIGITS) return bn.clone?.() ?? bn;\r\n    if (approxDigits > 32) return bn.clone?.() ?? bn;\r\n\r\n    const plain = bn.toPlainIntegerString?.();\r\n    if (plain === 'Infinity') return BigNum.fromAny('Infinity');\r\n    if (!plain) return BigNum.fromInt(0);\r\n    const normalized = plain.replace(/^0+(?=\\d)/, '');\r\n    if (!normalized) return BigNum.fromInt(0);\r\n    return BigNum.fromAny(normalized);\r\n  } catch {\r\n    const num = Math.max(0, Math.floor(Number(value) || 0));\r\n    return BigNum.fromInt(num);\r\n  }\r\n}\r\n\r\nexport function levelBigNumToNumber(value) {\r\n  let bn;\r\n  try {\r\n    bn = value instanceof BigNum ? value : BigNum.fromAny(value ?? 0);\r\n  } catch {\r\n    return 0;\r\n  }\r\n\r\n  if (bn.isInfinite?.()) return Number.POSITIVE_INFINITY;\r\n\r\n  const approx = approxLog10BigNum(bn);\r\n  if (!Number.isFinite(approx)) return approx > 0 ? Number.MAX_VALUE : 0;\r\n  if (approx > 308) return Number.MAX_VALUE;\r\n  if (approx < -324) return 0;\r\n  if (approx > 20) {\r\n    const value = Math.pow(10, approx);\r\n    return Number.isFinite(value) ? value : Number.MAX_VALUE;\r\n  }\r\n\r\n  try {\r\n    const plain = bn.toPlainIntegerString?.();\r\n    if (!plain || plain === 'Infinity') {\r\n      return plain === 'Infinity' ? Number.MAX_VALUE : 0;\r\n    }\r\n\r\n    const digits = plain.replace(/^0+/, '');\r\n    if (!digits) return 0;\r\n\r\n    if (digits.length <= 15) {\r\n      const num = Number(digits);\r\n      return Number.isFinite(num) ? num : 0;\r\n    }\r\n\r\n    const lead = digits.slice(0, 15);\r\n    const leadNum = Number(lead);\r\n    const leadLen = lead.length;\r\n    if (!Number.isFinite(leadNum) || leadNum <= 0) return 0;\r\n\r\n    let mantissa = leadNum / Math.pow(10, leadLen - 1);\r\n    let exponent = digits.length - 1;\r\n\r\n    if (mantissa <= 0 || !Number.isFinite(mantissa)) return 0;\r\n\r\n    if (mantissa >= 10) {\r\n      const shift = Math.floor(Math.log10(mantissa));\r\n      if (Number.isFinite(shift) && shift > 0) {\r\n        mantissa /= Math.pow(10, shift);\r\n        exponent += shift;\r\n      }\r\n    } else if (mantissa < 1) {\r\n      const shift = Math.ceil(Math.log10(1 / mantissa));\r\n      if (Number.isFinite(shift) && shift > 0) {\r\n        mantissa *= Math.pow(10, shift);\r\n        exponent -= shift;\r\n      }\r\n    }\r\n\r\n    if (exponent > 308) {\r\n      return Number.MAX_VALUE;\r\n    }\r\n    if (exponent < -324) {\r\n      return 0;\r\n    }\r\n\r\n    const approx = mantissa * Math.pow(10, exponent);\r\n    if (!Number.isFinite(approx)) {\r\n      return exponent > 0 ? Number.MAX_VALUE : 0;\r\n    }\r\n    return approx;\r\n  } catch {\r\n    const approx = approxLog10BigNum(bn);\r\n    if (!Number.isFinite(approx)) return Number.MAX_VALUE;\r\n    if (approx > 308) return Number.MAX_VALUE;\r\n    if (approx < -324) return 0;\r\n    const value = Math.pow(10, approx);\r\n    return Number.isFinite(value) ? value : Number.MAX_VALUE;\r\n  }\r\n}\r\n\r\nconst LN10 = Math.log(10);\r\n\r\nfunction plainLevelDelta(nextLevelBn, prevLevelBn) {\r\n  const next = ensureLevelBigNum(nextLevelBn);\r\n  const prev = ensureLevelBigNum(prevLevelBn);\r\n\r\n  if (next.isInfinite?.()) {\r\n    return prev.isInfinite?.() ? BigNum.fromInt(0) : BigNum.fromAny('Infinity');\r\n  }\r\n  if (prev.isInfinite?.()) {\r\n    return BigNum.fromInt(0);\r\n  }\r\n\r\n  try {\r\n    const nextDigits = Math.floor(approxLog10BigNum(next)) + 1;\r\n    const prevDigits = Math.floor(approxLog10BigNum(prev)) + 1;\r\n    if (!Number.isFinite(nextDigits) || nextDigits > 120 || !Number.isFinite(prevDigits)) {\r\n      if (!Number.isFinite(prevDigits) || nextDigits <= prevDigits) return BigNum.fromInt(0);\r\n      return BigNum.fromAny('Infinity');\r\n    }\r\n\r\n    const nextPlain = next.toPlainIntegerString?.();\r\n    const prevPlain = prev.toPlainIntegerString?.();\r\n    if (!nextPlain || !prevPlain) return BigNum.fromInt(0);\r\n    if (nextPlain === 'Infinity') return BigNum.fromAny('Infinity');\r\n    if (prevPlain === 'Infinity') return BigNum.fromInt(0);\r\n    if (nextPlain === prevPlain) return BigNum.fromInt(0);\r\n    const diff = BigInt(nextPlain) - BigInt(prevPlain);\r\n    if (diff <= 0n) return BigNum.fromInt(0);\r\n    return BigNum.fromAny(diff.toString());\r\n  } catch {\r\n    return BigNum.fromInt(0);\r\n  }\r\n}\r\n\r\nfunction decimalMultiplierString(value) {\r\n  if (!Number.isFinite(value) || value <= 0) return '1';\r\n  let out = value.toFixed(12);\r\n  out = out.replace(/0+$/, '');\r\n  if (out.endsWith('.')) out += '0';\r\n  return out;\r\n}\r\n\r\nfunction normalizeHmEvolutionCount(value) {\r\n  const n = Number(value);\r\n  if (Number.isFinite(n) && n > 0) return Math.max(0, Math.floor(n));\r\n  return 0;\r\n}\r\n\r\nfunction activeEvolutionsForUpgrade(upg) {\r\n  if (!upg) return 0;\r\n  const active = Number(upg.activeEvolutions);\r\n  if (Number.isFinite(active) && active >= 0) return active;\r\n  return normalizeHmEvolutionCount(upg.numUpgEvolutions);\r\n}\r\n\r\nexport function computeDefaultUpgradeCost(baseCost, level, upgType = 'NM') {\r\n  let baseBn;\r\n  try { baseBn = BigNum.fromAny(baseCost ?? 0); }\r\n  catch { baseBn = BigNum.fromInt(0); }\r\n\r\n  const levelNumber = levelBigNumToNumber(level);\r\n\r\n  const upg = { upgType, numUpgEvolutions: 0 };\r\n  if (`${upgType ?? ''}`.toUpperCase() === 'HM') {\r\n    const evolutions = Math.max(0, Math.floor(levelNumber / HM_EVOLUTION_INTERVAL));\r\n    if (Number.isFinite(evolutions)) {\r\n      upg.numUpgEvolutions = evolutions;\r\n    }\r\n  }\r\n\r\n  const preset = resolveDefaultScalingRatio(upg);\r\n  let ratio = (preset?.ratio > 0) ? preset.ratio : 1;\r\n  // If ratio is infinite, treat it as > 1 logic but ensure we have ratioLog10\r\n  if (ratio === Infinity && preset?.ratioLog10 == null) {\r\n      // Fallback if no explicit log provided for infinity?\r\n      // Just keep ratio as Infinity, Math.log10(Infinity) is Infinity.\r\n  }\r\n  \r\n  let ratioLog10 = (preset && preset.ratioLog10 != null)\r\n      ? preset.ratioLog10\r\n      : Math.log10(Math.max(ratio, 1));\r\n      \r\n  const scaling = {\r\n    baseBn,\r\n    baseLog10: approxLog10BigNum(baseBn),\r\n    ratio,\r\n    ratioMinus1: Math.max(0, ratio - 1),\r\n    ratioLog10,\r\n    ratioLn: ratioLog10 * Math.LN10,\r\n    ratioStr: decimalMultiplierString(Math.max(ratio, 1)),\r\n    defaultPreset: preset?.preset,\r\n  };\r\n\r\n  upg.scaling = scaling;\r\n\r\n  return costAtLevelUsingScaling(upg, levelNumber);\r\n}\r\n\r\nconst DEFAULT_SCALING_PRESETS = {\r\n  STANDARD(upg) {\r\n    const upgType = `${upg?.upgType ?? ''}`.toUpperCase();\r\n    if (upgType === 'HM') {\r\n      const evol = activeEvolutionsForUpgrade(upg);\r\n      const evolThreshold = 1000; // Corresponds to level 1M\r\n      if (evol > evolThreshold) {\r\n        const evol_after_1m = evol - evolThreshold;\r\n        const base_scaling = 0.1 * evolThreshold;\r\n        const r = 1.001;\r\n        // Sum of a geometric series: 0.1 * r * (r^n - 1) / (r - 1)\r\n        const extra_scaling = 0.1 * (r / (r - 1)) * (Math.pow(r, evol_after_1m) - 1);\r\n        return 1.50 + base_scaling + extra_scaling;\r\n      }\r\n      return 1.50 + (0.10 * evol);\r\n    }\r\n    return 1.20;\r\n  },\r\n  HM(upg) {\r\n    const evol = activeEvolutionsForUpgrade(upg);\r\n    // Relaxed linear scaling for Phase 1 & 2 (up to 1,000,000 evolutions / Level 1B)\r\n    let ratio = 1.50 + (0.10 * evol);\r\n\r\n    // Phase 3: Double-Exponential Softcap starting at Level 1 Billion\r\n    const softcapStart = 1_000_000;\r\n    if (evol > softcapStart) {\r\n      const delta = evol - softcapStart;\r\n      // Calibrated to hit BN Infinity around Level 4 Trillion (4e9 evolutions)\r\n      const rate = 1.8e-7;\r\n      const baseLog = 5;\r\n      const ratioLog10 = baseLog * Math.exp(rate * delta);\r\n      let ratio = Infinity;\r\n      if (ratioLog10 < 308) {\r\n        ratio = Math.pow(10, ratioLog10);\r\n      }\r\n      return { ratio, ratioLog10 };\r\n    }\r\n    return ratio;\r\n  },\r\n  NM() {\r\n    return 1.20;\r\n  },\r\n};\r\n\r\nfunction hmLevelCapForEvolutions(evolutions) {\r\n  const cycles = normalizeHmEvolutionCount(evolutions);\r\n  const cap = HM_EVOLUTION_INTERVAL * (cycles + 1);\r\n  const capBn = BigNum.fromAny(cap);\r\n  return {\r\n    cap,\r\n    capBn,\r\n    capFmtHtml: formatBigNumAsHtml(capBn),\r\n    capFmtText: formatBigNumAsPlain(capBn),\r\n  };\r\n}\r\n\r\nfunction hmMilestoneHits(levelBn, milestoneLevel) {\r\n  if (!levelBn || typeof milestoneLevel !== 'number') return 0;\r\n  const approxDigits = Math.floor(approxLog10BigNum(levelBn)) + 1;\r\n  if (!Number.isFinite(approxDigits)) return 0;\r\n  if (approxDigits > 120) {\r\n    const approx = levelBigNumToNumber(levelBn);\r\n    if (!Number.isFinite(approx) || approx < milestoneLevel) return 0;\r\n    const delta = approx - milestoneLevel;\r\n    return Math.max(0, Math.floor(delta / HM_EVOLUTION_INTERVAL) + 1);\r\n  }\r\n  try {\r\n    const plain = levelBn.toPlainIntegerString?.();\r\n    if (!plain || plain === 'Infinity') return 0;\r\n    const lvl = BigInt(plain);\r\n    const base = BigInt(Math.max(0, Math.floor(milestoneLevel)));\r\n    const interval = BigInt(HM_EVOLUTION_INTERVAL);\r\n    if (lvl < base) return 0;\r\n    const delta = lvl - base;\r\n    const cycles = delta / interval;\r\n    return Number(cycles + 1n);\r\n  } catch {\r\n    const approx = levelBigNumToNumber(levelBn);\r\n    if (!Number.isFinite(approx) || approx < milestoneLevel) return 0;\r\n    const delta = approx - milestoneLevel;\r\n    return Math.max(0, Math.floor(delta / HM_EVOLUTION_INTERVAL) + 1);\r\n  }\r\n}\r\n\r\nfunction hmMilestoneMultiplier(multiplier, hits) {\r\n  if (!(hits > 0)) return BigNum.fromInt(1);\r\n\r\n  let base;\r\n  try { base = BigNum.fromAny(multiplier ?? 1); }\r\n  catch { base = BigNum.fromInt(1); }\r\n\r\n  const hitCount = Math.max(0, Math.floor(hits));\r\n  if (!Number.isFinite(hitCount)) return BigNum.fromAny('Infinity');\r\n  if (hitCount <= 1) return base.clone?.() ?? base;\r\n\r\n  const multiply = (a, b) => {\r\n    try { return a.mulBigNumInteger(b); } catch {}\r\n    try { return a.mulDecimal(b.toScientific?.(12) ?? String(multiplier ?? '1'), 18); } catch {}\r\n    try { return b.mulDecimal(a.toScientific?.(12) ?? String(multiplier ?? '1'), 18); } catch {}\r\n    return BigNum.fromAny('Infinity');\r\n  };\r\n\r\n  // For small hit counts preserve precision with a short loop.\r\n  if (hitCount <= 8) {\r\n    let result = base.clone?.() ?? base;\r\n    for (let i = 1; i < hitCount; i += 1) {\r\n      result = multiply(result, base);\r\n    }\r\n    return result;\r\n  }\r\n\r\n  // Use exponentiation by squaring to avoid O(hits) loops for huge levels.\r\n  let result = BigNum.fromInt(1);\r\n  let factor = base.clone?.() ?? base;\r\n  let exp = hitCount;\r\n\r\n  while (exp > 0) {\r\n    if (exp % 2 === 1) result = multiply(result, factor);\r\n    exp = Math.floor(exp / 2);\r\n    if (exp > 0) factor = multiply(factor, factor);\r\n  }\r\n\r\n  return result;\r\n}\r\n\r\nfunction resolveHmMilestones(upg, areaKey = DEFAULT_AREA_KEY) {\r\n  if (Array.isArray(upg?.hmMilestones)) return upg.hmMilestones;\r\n  const normalizedArea = normalizeAreaKey(areaKey || upg?.area || DEFAULT_AREA_KEY);\r\n  return HM_MILESTONES_BY_AREA[normalizedArea] || HM_MILESTONES_STARTER_COVE;\r\n}\r\n\r\nexport function safeMultiplyBigNum(base, factor) {\r\n  let out = base instanceof BigNum ? base : BigNum.fromAny(base ?? 1);\r\n  let f = factor instanceof BigNum ? factor : null;\r\n  if (!f) {\r\n    try { f = BigNum.fromAny(factor ?? 1); }\r\n    catch { return out; }\r\n  }\r\n  try { return out.mulBigNumInteger(f); }\r\n  catch {}\r\n  try { return out.mulDecimal(f.toScientific?.(12) ?? String(factor ?? '1'), 18); }\r\n  catch {}\r\n  return out;\r\n}\r\n\r\nfunction applyHmEvolutionMeta(upg, evolutions = 0) {\r\n  if (!upg || upg.upgType !== 'HM') return;\r\n  delete upg.scaling;\r\n  const { cap, capBn, capFmtHtml, capFmtText } = hmLevelCapForEvolutions(evolutions);\r\n  upg.activeEvolutions = evolutions;\r\n  upg.lvlCap = cap;\r\n  upg.lvlCapBn = capBn;\r\n  upg.lvlCapFmtHtml = capFmtHtml;\r\n  upg.lvlCapFmtText = capFmtText;\r\n}\r\n\r\nexport function computeHmMultipliers(upg, levelBn, areaKey = DEFAULT_AREA_KEY) {\r\n  if (!upg || upg.upgType !== 'HM') {\r\n    return {\r\n      selfMult: BigNum.fromInt(1),\r\n      xpMult: BigNum.fromInt(1),\r\n      coinMult: BigNum.fromInt(1),\r\n      mpMult: BigNum.fromInt(1),\r\n    };\r\n  }\r\n\r\n  const milestones = resolveHmMilestones(upg, areaKey);\r\n  let selfMult = BigNum.fromInt(1);\r\n  let xpMult = BigNum.fromInt(1);\r\n  let coinMult = BigNum.fromInt(1);\r\n  let mpMult = BigNum.fromInt(1);\r\n\r\n  for (const m of milestones) {\r\n    const hits = hmMilestoneHits(levelBn, Number(m?.level ?? m?.lvl ?? 0));\r\n    if (!(hits > 0)) continue;\r\n    const mult = hmMilestoneMultiplier(m.multiplier ?? m.mult ?? m.value ?? 1, hits);\r\n    const target = `${m.target ?? m.type ?? 'self'}`.toLowerCase();\r\n    if (target === 'xp') {\r\n      xpMult = safeMultiplyBigNum(xpMult, mult);\r\n    } else if (target === 'coin' || target === 'coins') {\r\n      coinMult = safeMultiplyBigNum(coinMult, mult);\r\n    } else if (target === 'mp') {\r\n      mpMult = safeMultiplyBigNum(mpMult, mult);\r\n    } else {\r\n      selfMult = safeMultiplyBigNum(selfMult, mult);\r\n    }\r\n  }\r\n\r\n  const evolutions = activeEvolutionsForUpgrade(upg);\r\n  if (evolutions > 0) {\r\n    const totalLog10 = HM_EVOLUTION_LOG10 * evolutions;\r\n    const evolMult = bigNumFromLog10(totalLog10);\r\n    selfMult = safeMultiplyBigNum(selfMult, evolMult);\r\n  }\r\n\r\n  return { selfMult, xpMult, coinMult, mpMult };\r\n}\r\n\r\nfunction hmNextMilestoneLevel(upg, levelBn, areaKey = DEFAULT_AREA_KEY) {\r\n  if (!upg || upg.upgType !== 'HM') return null;\r\n  if (levelBn?.isInfinite?.()) return BigNum.fromAny('Infinity');\r\n  const milestones = resolveHmMilestones(upg, areaKey);\r\n  if (!milestones.length) return null;\r\n\r\n  let best = null;\r\n  for (const m of milestones) {\r\n    const lvl = Math.max(0, Math.floor(Number(m?.level ?? m?.lvl ?? 0)));\r\n    const hits = hmMilestoneHits(levelBn, lvl);\r\n    let candidate = null;\r\n    try {\r\n      const base = BigInt(lvl);\r\n      const nextHits = BigInt(Math.max(0, hits));\r\n      const targetBi = base + (BigInt(HM_EVOLUTION_INTERVAL) * nextHits);\r\n      if (targetBi > 0n) {\r\n        candidate = BigNum.fromAny(targetBi.toString());\r\n      }\r\n    } catch {}\r\n    if (!candidate) {\r\n      const increment = BigNum.fromAny(HM_EVOLUTION_INTERVAL * Math.max(0, hits));\r\n      try { candidate = increment.add(BigNum.fromAny(lvl)); }\r\n      catch { candidate = BigNum.fromAny(lvl + HM_EVOLUTION_INTERVAL * hits); }\r\n    }\r\n    if (!candidate) continue;\r\n    if (levelBn?.cmp?.(candidate) >= 0) {\r\n      try { candidate = candidate.add(BigNum.fromAny(HM_EVOLUTION_INTERVAL)); }\r\n      catch {}\r\n    }\r\n    if (!best || best.cmp(candidate) > 0) {\r\n      best = candidate;\r\n    }\r\n  }\r\n  return best;\r\n}\r\n\r\nfunction resolveDefaultScalingRatio(upg) {\r\n  if (!upg) return null;\r\n\r\n  const tryPreset = (name) => {\r\n    const presetName = `${name ?? ''}`.toUpperCase();\r\n    if (!presetName) return null;\r\n    const presetFn = DEFAULT_SCALING_PRESETS[presetName];\r\n    if (typeof presetFn !== 'function') return null;\r\n    const res = presetFn(upg);\r\n    if (typeof res === 'object' && res !== null) {\r\n      // Allow objects with ratioLog10 even if ratio is infinite\r\n      if (res.ratioLog10 != null || res.ratio > 0) {\r\n        return {\r\n          ratio: res.ratio ?? 1,\r\n          ratioLog10: res.ratioLog10,\r\n          preset: presetName\r\n        };\r\n      }\r\n      return null;\r\n    }\r\n    const ratio = res;\r\n    if ((!Number.isFinite(ratio) && ratio !== Infinity) || ratio <= 0) return null;\r\n    return { ratio, preset: presetName };\r\n  };\r\n\r\n  return (\r\n    tryPreset(upg.scalingPreset)\r\n    || tryPreset(upg.upgType)\r\n    || tryPreset('STANDARD')\r\n  );\r\n}\r\n\r\nfunction ensureUpgradeScaling(upg) {\r\n  if (!upg) return null;\r\n  if (upg.scaling && upg.scaling.baseBn) return upg.scaling;\r\n  try {\r\n    const baseBn = BigNum.fromAny(upg.baseCost ?? upg.baseCostBn ?? 0);\r\n\r\n    const providedScaling = upg.scaling ?? {};\r\n    let ratio = Number(providedScaling.ratio);\r\n    if (!(ratio > 0) || (!Number.isFinite(ratio) && ratio !== Infinity)) ratio = null;\r\n\r\n    let ratioStr = typeof providedScaling.ratioStr === 'string'\r\n      ? providedScaling.ratioStr.trim()\r\n      : '';\r\n    if (!ratio && ratioStr) {\r\n      const parsed = Number(ratioStr);\r\n      if (Number.isFinite(parsed) && parsed > 0) {\r\n        ratio = parsed;\r\n      }\r\n    }\r\n\r\n    let ratioLog10 = Number(providedScaling.ratioLog10);\r\n    if (!Number.isFinite(ratioLog10)) ratioLog10 = null;\r\n    if (!ratio && ratioLog10 != null) {\r\n      const pow = Math.pow(10, ratioLog10);\r\n      if (Number.isFinite(pow) && pow > 0) ratio = pow;\r\n    }\r\n\r\n    let ratioLn = Number(providedScaling.ratioLn);\r\n    if (!Number.isFinite(ratioLn)) ratioLn = null;\r\n    if (!ratio && ratioLn != null) {\r\n      const exp = Math.exp(ratioLn);\r\n      if (Number.isFinite(exp) && exp > 0) ratio = exp;\r\n    }\r\n\r\n    if (!ratio) {\r\n      const ratioMinus1 = Number(providedScaling.ratioMinus1);\r\n      if (Number.isFinite(ratioMinus1) && ratioMinus1 > 0) {\r\n        ratio = ratioMinus1 + 1;\r\n      }\r\n    }\r\n\r\n    let defaultPreset = null;\r\n    if (!ratio) {\r\n      const resolved = resolveDefaultScalingRatio(upg);\r\n      if (resolved) {\r\n        ratio = resolved.ratio;\r\n        if (resolved.ratioLog10 != null) ratioLog10 = resolved.ratioLog10;\r\n        defaultPreset = resolved.preset;\r\n      }\r\n    }\r\n\r\n    if (!(ratio > 1)) {\r\n      ratio = 1;\r\n      ratioStr = '1';\r\n      ratioLog10 = 0;\r\n      ratioLn = 0;\r\n      var ratioMinus1 = 0;\r\n    } else {\r\n      ratio = Number(ratio);\r\n      ratioStr = decimalMultiplierString(ratio);\r\n      \r\n      // Use existing ratioLog10 if available and we are handling the Infinity case,\r\n      // or if normal calculation would be redundant/less precise.\r\n      if (ratioLog10 == null || (ratio === Infinity && Number.isFinite(ratioLog10))) {\r\n          // keep current ratioLog10 if it's finite and ratio is infinite\r\n          if (ratioLog10 == null) ratioLog10 = Math.log10(ratio);\r\n      } else {\r\n          // Standard case: sync log10 to ratio if ratio is finite\r\n          if (Number.isFinite(ratio)) {\r\n             ratioLog10 = Math.log10(ratio);\r\n          }\r\n      }\r\n      \r\n      if (Number.isFinite(ratioLog10)) {\r\n          ratioLn = ratioLog10 * Math.LN10;\r\n      } else {\r\n          ratioLn = Math.log(ratio);\r\n      }\r\n      var ratioMinus1 = Math.max(1e-12, ratio - 1);\r\n    }\r\n\r\n    const baseLog10 = approxLog10BigNum(baseBn);\r\n\r\n    const scaling = Object.assign({}, providedScaling, {\r\n      baseBn,\r\n      baseLog10,\r\n      ratio,\r\n      ratioMinus1,\r\n      ratioLog10,\r\n      ratioLn,\r\n      ratioStr,\r\n      defaultPreset: defaultPreset ?? providedScaling.defaultPreset,\r\n    });\r\n\r\n    // Expose the in-progress scaling so recursive cost checks can use it\r\n    upg.scaling = scaling;\r\n\r\n    try {\r\n      const c0 = BigNum.fromAny(upg.costAtLevel?.(0) ?? 0);\r\n      const c1 = BigNum.fromAny(upg.costAtLevel?.(1) ?? 0);\r\n      const cF = BigNum.fromAny(upg.costAtLevel?.(32) ?? 0);\r\n      if (c0.cmp(c1) === 0 && c0.cmp(cF) === 0) {\r\n        scaling.ratio = 1;\r\n        scaling.ratioMinus1 = 0;\r\n        scaling.ratioLog10 = 0;\r\n        scaling.ratioLn = 0;\r\n        scaling.ratioStr = '1';\r\n      }\r\n    } catch {}\r\n\r\n    return scaling;\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\nfunction costAtLevelUsingScaling(upg, level) {\r\n  const scaling = ensureUpgradeScaling(upg);\r\n  if (!scaling) return BigNum.fromInt(0);\r\n  const lvl = Math.max(0, Math.floor(Number(level) || 0));\r\n  if (lvl === 0) return BigNum.fromAny(scaling.baseBn);\r\n\r\n  // Approach A (robust & simple): multiply without flooring, floor once at end\r\n  if (lvl <= 100) {\r\n    let price = BigNum.fromAny(scaling.baseBn);\r\n    for (let i = 0; i < lvl; i += 1) {\r\n      // precise decimal multiply (no truncation each step)\r\n      price = price.mulDecimal(scaling.ratioStr);\r\n    }\r\n    return price.floorToInteger();\r\n  }\r\n\r\n  // Existing mid-range anchor + tail (kept as-is)\r\n  if (lvl < 10000) {\r\n    const anchor = Math.max(0, lvl - 10);\r\n    let price = bigNumFromLog10(scaling.baseLog10 + anchor * scaling.ratioLog10);\r\n    for (let step = anchor; step < lvl; step += 1) {\r\n      price = price.mulDecimal(scaling.ratioStr);\r\n    }\r\n    return price.floorToInteger();\r\n  }\r\n\r\n  // Very large levels: closed form via logs\r\n  return bigNumFromLog10(scaling.baseLog10 + lvl * scaling.ratioLog10).floorToInteger();\r\n}\r\n\r\n\r\nfunction logExpMinus1(x) {\r\n  if (!Number.isFinite(x)) return x;\r\n  if (x < 1e-6) {\r\n    return Math.log(Math.expm1(x));\r\n  }\r\n  if (x < 50) {\r\n    return Math.log(Math.expm1(x));\r\n  }\r\n  const negExp = Math.exp(-x);\r\n  return x + Math.log1p(-negExp);\r\n}\r\n\r\nfunction logSeriesTotal(upg, startLevel, count) {\r\n  if (!(count > 0)) return Number.NEGATIVE_INFINITY;\r\n  const scaling = ensureUpgradeScaling(upg);\r\n  if (!scaling) return Number.NEGATIVE_INFINITY;\r\n  if (!Number.isFinite(scaling.ratioLn)) {\r\n    if (count > 1) return Number.POSITIVE_INFINITY;\r\n    // For count=1, it is just startLn\r\n    const startLn = (scaling.baseLog10 * LN10) + (startLevel * scaling.ratioLn);\r\n    return startLn / LN10;\r\n  }\r\n  if (!(scaling.ratioMinus1 > 0)) {\r\n    return Number.POSITIVE_INFINITY;\r\n  }\r\n\r\n  const startLn = (scaling.baseLog10 * LN10) + (startLevel * scaling.ratioLn);\r\n  const growth = scaling.ratioLn * count;\r\n  const numerLn = logExpMinus1(growth);\r\n  if (!Number.isFinite(numerLn)) return Number.POSITIVE_INFINITY;\r\n  const denomLn = Math.log(scaling.ratioMinus1);\r\n  const totalLn = startLn + numerLn - denomLn;\r\n  return totalLn / LN10;\r\n}\r\n\r\nfunction totalCostBigNum(upg, startLevel, count) {\r\n  if (!(count > 0)) return BigNum.fromInt(0);\r\n  const scaling = ensureUpgradeScaling(upg);\r\n  if (!scaling) return BigNum.fromInt(0);\r\n  const targetLevel = startLevel + count;\r\n\r\n  if (targetLevel <= 100) {\r\n    let price = BigNum.fromAny(upg.costAtLevel(startLevel));\r\n    let total = BigNum.fromInt(0);\r\n    for (let i = 0; i < count; i += 1) {\r\n      total = total.add(price);\r\n      if (i + 1 < count) price = price.mulDecimalFloor(scaling.ratioStr);\r\n    }\r\n    return total;\r\n  }\r\n\r\n  if (targetLevel < 10000) {\r\n    const tailCount = Math.min(10, count);\r\n    const headCount = count - tailCount;\r\n    let total = BigNum.fromInt(0);\r\n    if (headCount > 0) {\r\n      const headLog = logSeriesTotal(upg, startLevel, headCount);\r\n      total = total.add(bigNumFromLog10(headLog));\r\n    }\r\n    if (tailCount > 0) {\r\n      const tailStart = startLevel + headCount;\r\n      let price = BigNum.fromAny(upg.costAtLevel(tailStart));\r\n      for (let i = 0; i < tailCount; i += 1) {\r\n        total = total.add(price);\r\n        if (i + 1 < tailCount) price = price.mulDecimalFloor(scaling.ratioStr);\r\n      }\r\n    }\r\n    return total;\r\n  }\r\n\r\n  const totalLog = logSeriesTotal(upg, startLevel, count);\r\n  return bigNumFromLog10(totalLog);\r\n}\r\n\r\n\r\nconst MAX_LEVEL_DELTA_LIMIT = (() => {\r\n  try {\r\n    const approx = levelBigNumToNumber(MAX_LEVEL_DELTA);\r\n    if (!Number.isFinite(approx)) return Number.POSITIVE_INFINITY;\r\n    if (approx <= 0) return 0;\r\n    return Math.floor(approx);\r\n  } catch {\r\n    return Number.MAX_SAFE_INTEGER;\r\n  }\r\n})();\r\n\r\nconst FLOAT64_BUFFER = new ArrayBuffer(8);\r\nconst FLOAT64_VIEW = new Float64Array(FLOAT64_BUFFER);\r\nconst INT64_VIEW = new BigInt64Array(FLOAT64_BUFFER);\r\n\r\nfunction nextDownPositive(value) {\r\n  if (!(value > 0) || !Number.isFinite(value)) return value;\r\n  FLOAT64_VIEW[0] = value;\r\n  if (FLOAT64_VIEW[0] <= 0) return 0;\r\n  INT64_VIEW[0] -= 1n;\r\n  const next = FLOAT64_VIEW[0];\r\n  return next > 0 ? next : 0;\r\n}\r\n\r\nfunction nextUpPositive(value) {\r\n  if (!(value >= 0) || !Number.isFinite(value)) return value;\r\n  FLOAT64_VIEW[0] = value;\r\n  INT64_VIEW[0] += 1n;\r\n  const next = FLOAT64_VIEW[0];\r\n  return next > value ? next : value;\r\n}\r\n\r\nfunction safeDecrementCount(value) {\r\n  if (!(value > 0)) return 0;\r\n  const dec = Math.floor(value - 1);\r\n  if (dec < value) return dec;\r\n  const next = nextDownPositive(value);\r\n  if (next < value) return next;\r\n  return value > 1 ? value / 2 : 0;\r\n}\r\n\r\nfunction countToBigNum(count) {\r\n  if (!(count > 0) || !Number.isFinite(count)) return BigNum.fromInt(0);\r\n  const floored = Math.floor(count);\r\n  if (!(floored > 0)) return BigNum.fromInt(0);\r\n  if (floored <= Number.MAX_SAFE_INTEGER) {\r\n    return BigNum.fromInt(floored);\r\n  }\r\n  let str;\r\n  try {\r\n    str = floored.toLocaleString('fullwide', { useGrouping: false, maximumFractionDigits: 0 });\r\n  } catch {\r\n    str = floored.toString();\r\n  }\r\n  if (!str || !/\\d/.test(str)) return BigNum.fromInt(0);\r\n  return BigNum.fromAny(str);\r\n}\r\n\r\nfunction calculateBulkPurchase(upg, startLevel, walletBn, maxLevels = MAX_LEVEL_DELTA, options = {}) {\r\n  const scaling = ensureUpgradeScaling(upg);\r\n  const zero = BigNum.fromInt(0);\r\n  const opts = options || {};\r\n  const fastOnly = !!opts.fastOnly;\r\n  walletBn = walletBn instanceof BigNum ? walletBn : BigNum.fromAny(walletBn ?? 0);\r\n  if (!scaling) {\r\n    return { count: zero, spent: zero, nextPrice: zero, numericCount: 0 };\r\n  }\r\n\r\n  const startLevelNum = Math.max(0, Math.floor(levelBigNumToNumber(startLevel)));\r\n\r\n  const cap = Number.isFinite(upg.lvlCap)\r\n    ? Math.max(0, Math.floor(upg.lvlCap))\r\n    : Number.POSITIVE_INFINITY;\r\n  const maxLevelsNum = typeof maxLevels === 'number'\r\n    ? maxLevels\r\n    : levelBigNumToNumber(maxLevels);\r\n  const capRoom = Number.isFinite(cap)\r\n    ? Math.max(0, cap - startLevelNum)\r\n    : MAX_LEVEL_DELTA_LIMIT;\r\n  let room = Number.isFinite(maxLevelsNum)\r\n    ? Math.max(0, Math.floor(maxLevelsNum))\r\n    : MAX_LEVEL_DELTA_LIMIT;\r\n  room = Math.min(room, MAX_LEVEL_DELTA_LIMIT, capRoom);\r\n  if (!(room > 0)) {\r\n    const nextPrice = capRoom <= 0 ? zero : BigNum.fromAny(upg.costAtLevel(startLevelNum));\r\n    return { count: zero, spent: zero, nextPrice, numericCount: 0 };\r\n  }\r\n\r\n  // For small levels we can cheaply compute an exact floored progression, which\r\n  // avoids undercounting caused by geometric approximations that ignore per-step\r\n  // flooring (e.g., costs like 3 \u2192 3 \u2192 4 instead of 3 \u2192 3.6 \u2192 4.32).\r\n  const remainingToHundred = 100 - startLevelNum;\r\n  if (Number.isFinite(startLevelNum) && remainingToHundred > 0) {\r\n    const limit = Math.min(room, remainingToHundred);\r\n\r\n    // \u26A1 Bolt Optimization: If wallet is massive compared to cost, skip the expensive loop.\r\n    // The loop calls costAtLevel which itself loops for levels < 100 (O(N^2) total).\r\n    // If we have enough currency to easily buy this batch, assume we buy it all.\r\n    if (opts.fastOnly && scaling && Number.isFinite(scaling.ratioLog10) && Number.isFinite(scaling.baseLog10)) {\r\n      const walletLog = approxLog10BigNum(walletBn);\r\n      // Estimate log cost of the most expensive level in this batch\r\n      // Cost ~= base * ratio^level -> logCost = baseLog + level * ratioLog\r\n      const maxLevelInBatch = startLevelNum + limit;\r\n      const maxCostLog = scaling.baseLog10 + (maxLevelInBatch * scaling.ratioLog10);\r\n\r\n      // If wallet is > 100,000x the max cost (log difference > 5), we can definitely afford this batch.\r\n      if (walletLog > maxCostLog + 5) {\r\n        const countBn = countToBigNum(limit);\r\n        const nextStartLevel = startLevelNum + limit;\r\n        // Recurse for the rest. Pass full wallet as spent is negligible.\r\n        const tail = calculateBulkPurchase(\r\n          upg,\r\n          nextStartLevel,\r\n          walletBn,\r\n          room - limit,\r\n          options,\r\n        );\r\n\r\n        const tailCount = tail?.count instanceof BigNum ? tail.count : countToBigNum(tail?.numericCount ?? 0);\r\n        return {\r\n          count: countBn.add(tailCount),\r\n          spent: zero, // fastOnly doesn't need accurate spent\r\n          nextPrice: tail?.nextPrice ?? zero,\r\n          numericCount: limit + (tail?.numericCount ?? 0),\r\n        };\r\n      }\r\n    }\r\n\r\n    let price = BigNum.fromAny(upg.costAtLevel(startLevelNum));\r\n    let spent = zero;\r\n    let count = 0;\r\n\r\n    while (count < limit) {\r\n      // Use the exact per-level cost function (with its own flooring logic)\r\n      // instead of multiplying by ratio, so we don't drift when costs change\r\n      // non-geometrically around low levels.\r\n      price = BigNum.fromAny(upg.costAtLevel(startLevelNum + count));\r\n      const newSpent = spent.add(price);\r\n      if (newSpent.cmp(walletBn) > 0) break;\r\n      spent = newSpent;\r\n      count += 1;\r\n    }\r\n\r\n    const nextLevel = startLevelNum + count;\r\n    const reachedCap = Number.isFinite(cap) && nextLevel >= cap;\r\n    const countBn = countToBigNum(count);\r\n\r\n    if (count < limit || reachedCap || room <= count) {\r\n      const nextPrice = reachedCap\r\n        ? zero\r\n        : BigNum.fromAny(upg.costAtLevel(nextLevel));\r\n      return { count: countBn, spent, nextPrice, numericCount: count };\r\n    }\r\n\r\n    const nextStartLevel = (() => {\r\n      try { return toUpgradeBigNum(startLevel ?? startLevelNum, startLevelNum).add(countBn); }\r\n      catch { return startLevelNum + count; }\r\n    })();\r\n    const tail = calculateBulkPurchase(\r\n      upg,\r\n      nextStartLevel,\r\n      walletBn.sub(spent),\r\n      room - count,\r\n      options,\r\n    );\r\n\r\n    const tailCount = tail?.count instanceof BigNum ? tail.count : countToBigNum(tail?.numericCount ?? 0);\r\n    const totalCount = countBn.add(tailCount);\r\n    const totalSpent = (tail?.spent ?? zero).add(spent);\r\n\r\n    return {\r\n      count: totalCount,\r\n      spent: totalSpent,\r\n      nextPrice: tail?.nextPrice ?? zero,\r\n      numericCount: count + (tail?.numericCount ?? 0),\r\n    };\r\n  }\r\n\r\nlet walletLog = approxLog10BigNum(walletBn);\r\n\r\nconst ratioLog10 = scaling.ratioLog10;\r\nconst ratioMinus1 = scaling.ratioMinus1;\r\nconst firstPrice = BigNum.fromAny(upg.costAtLevel(startLevelNum));\r\n\r\n\r\nconst startPriceLog = scaling.baseLog10 + (startLevelNum * ratioLog10);\r\n\r\n// Fallback: if walletLog isn't finite *or* magnitudes are so huge that\r\n// double-precision subtraction will be meaningless, do a pure-BigNum search.\r\nconst needBnSearch =\r\n  (ratioMinus1 > 0) && (\r\n    !Number.isFinite(walletLog) ||\r\n    (Math.abs(walletLog) > 1e6 && Math.abs(startPriceLog) > 1e6)\r\n  );\r\n\r\nif (needBnSearch) {\r\n  // Quick \"can't even buy 1\" check\r\n  const firstPrice = BigNum.fromAny(upg.costAtLevel(startLevelNum));\r\n  if (walletBn.cmp(firstPrice) < 0) {\r\n    return { count: zero, spent: zero, nextPrice: firstPrice, numericCount: 0 };\r\n  }\r\n\r\n  // Bound the affordable count using only BigNum compares\r\n  const hardLimit = Number.isFinite(room) ? Math.max(1, Math.floor(room)) : Number.MAX_VALUE;\r\n  let lo = 1;\r\n  let hi = 1;\r\n\r\nwhile (hi < hardLimit) {\r\n  const spentLog = logSeriesTotal(upg, startLevelNum, hi);\r\n  const spentBn  = bigNumFromLog10(spentLog);\r\n  if (spentBn.cmp(walletBn) <= 0) {\r\n    const doubled = hi * 2;\r\n    if (!Number.isFinite(doubled) || doubled <= hi) { hi = hardLimit; break; }\r\n    lo = hi;\r\n    hi = Math.min(doubled, hardLimit);\r\n  } else {\r\n    break;\r\n  }\r\n}\r\n\r\n  let steps = 0;\r\n  while (lo < hi && steps < 256) {\r\n    const mid = Math.max(lo + 1, Math.floor((lo + hi + 1) / 2));\r\n    const spentLog = logSeriesTotal(upg, startLevelNum, mid);\r\n    const spentBn  = bigNumFromLog10(spentLog);\r\n    if (spentBn.cmp(walletBn) <= 0) {\r\n      lo = mid;\r\n    } else {\r\n      hi = mid - 1;\r\n    }\r\n    steps++;\r\n  }\r\n\r\n  const count = Math.max(1, lo);\r\n  const countBn = countToBigNum(count);\r\n\r\n  // In fastOnly mode we can skip exact 'spent'; otherwise compute precisely.\r\n  let spent = zero;\r\n  let nextPrice = zero;\r\n  if (!fastOnly) {\r\n    spent = totalCostBigNum(upg, startLevelNum, count);\r\n    if (Number.isFinite(cap)) {\r\n      const capRoom = Math.max(0, Math.floor(cap - Math.min(startLevelNum, cap)));\r\n      if (count >= capRoom) {\r\n        nextPrice = zero;\r\n      } else {\r\n        nextPrice = bigNumFromLog10(startPriceLog + count * ratioLog10);\r\n      }\r\n    } else {\r\n      nextPrice = bigNumFromLog10(startPriceLog + count * ratioLog10);\r\n    }\r\n  }\r\n\r\n  return {\r\n    count: countBn,\r\n    spent,\r\n    nextPrice,\r\n    numericCount: count,\r\n  };\r\n}\r\n\r\n  if (walletBn.cmp(firstPrice) < 0) {\r\n    return { count: zero, spent: zero, nextPrice: firstPrice, numericCount: 0 };\r\n  }\r\n\r\nlet isConstantCost = false;\r\nlet secondPrice = null, farPrice = null;\r\n\r\ntry { secondPrice = BigNum.fromAny(upg.costAtLevel(startLevelNum + 1)); } catch {}\r\ntry {\r\n  const farProbe = Math.min(\r\n    Number.isFinite(cap) ? Math.max(startLevelNum + 1, Math.floor(cap)) : startLevelNum + 32,\r\n    startLevelNum + 32\r\n  );\r\n  farPrice = BigNum.fromAny(upg.costAtLevel(farProbe));\r\n} catch {}\r\nif (!isConstantCost && !(scaling.ratioMinus1 > 0)) {\r\n  isConstantCost = true;\r\n}\r\n\r\nif (secondPrice && farPrice) {\r\n  isConstantCost =\r\n    secondPrice.cmp(firstPrice) === 0 &&\r\n    farPrice.cmp(firstPrice) === 0;\r\n}\r\n\r\nif (!isConstantCost && !(scaling.ratioMinus1 > 0)) {\r\n  isConstantCost = true;\r\n}\r\n\r\n  const limit = Number.isFinite(room)\r\n    ? Math.max(0, Math.floor(room))\r\n    : Number.MAX_VALUE;\r\n\r\n  if (isConstantCost) {\r\n  const capBn = toUpgradeBigNum(upg.lvlCapBn ?? 'Infinity', 'Infinity');\r\n  const lvlBn = toUpgradeBigNum(startLevel ?? 0, 0);\r\n  const roomBn = capBn.isInfinite?.()\r\n    ? BigNum.fromAny('Infinity')\r\n    : capBn.sub(lvlBn).floorToInteger();\r\n\r\n  const { count, countBn, spent, nextPrice } = estimateFlatBulk(\r\n    firstPrice,\r\n    walletBn,\r\n    roomBn\r\n  );\r\n\r\n  return {\r\n    count: countBn,\r\n    spent,\r\n    nextPrice,\r\n    numericCount: count,\r\n  };\r\n}\r\n\r\nif (!(ratioLog10 > 0) || !(ratioMinus1 > 0)) {\r\n  const capBn = toUpgradeBigNum(upg.lvlCapBn ?? 'Infinity', 'Infinity');\r\n  const lvlBn = toUpgradeBigNum(startLevel ?? 0, 0);\r\n  const roomBn = capBn.isInfinite?.()\r\n    ? BigNum.fromAny('Infinity')\r\n    : capBn.sub(lvlBn).floorToInteger();\r\n\r\n  const { count, countBn, spent, nextPrice } =\r\n    estimateFlatBulk(firstPrice, walletBn, roomBn);\r\n\r\n  return { count: countBn, spent, nextPrice, numericCount: count };\r\n}\r\n\r\n  const ratioMinus1Log = Math.log10(ratioMinus1);\r\n  if (!Number.isFinite(ratioMinus1Log)) {\r\n    return { count: zero, spent: zero, nextPrice: firstPrice, numericCount: 0 };\r\n  }\r\n\r\n  const logTarget = log10OnePlusPow10(walletLog + ratioMinus1Log - startPriceLog);\r\n  let approxCount = logTarget / ratioLog10;\r\n  if (!Number.isFinite(approxCount) || approxCount < 0) approxCount = 0;\r\n\r\n  let count = Math.floor(Math.min(limit, approxCount));\r\n  if (!Number.isFinite(count)) count = limit;\r\n  if (count <= 0) count = 1;\r\n\r\n  const EPS = 1e-7;\r\n  let spentLog = logSeriesTotal(upg, startLevelNum, count);\r\n  let tuneSteps = 0;\r\n  const MAX_TUNE_STEPS = 2048;\r\n\r\n  while (count > 0 && (!Number.isFinite(spentLog) || spentLog > walletLog + EPS) && tuneSteps < MAX_TUNE_STEPS) {\r\n    const overshoot = Number.isFinite(spentLog)\r\n      ? Math.max(1, Math.ceil((spentLog - walletLog) / Math.max(ratioLog10, 1e-12)))\r\n      : Math.max(1, Math.floor(count / 2));\r\n    const reduced = Math.max(0, Math.floor(count - overshoot));\r\n    if (reduced < count) {\r\n      count = reduced;\r\n    } else {\r\n      const next = nextDownPositive(count);\r\n      if (!(next < count)) break;\r\n      count = next;\r\n    }\r\n    spentLog = count > 0 ? logSeriesTotal(upg, startLevelNum, count) : Number.NEGATIVE_INFINITY;\r\n    tuneSteps += 1;\r\n  }\r\n\r\n  if (count <= 0 || !Number.isFinite(count)) {\r\n    if (walletBn.cmp(firstPrice) >= 0) {\r\n      count = 1;\r\n      spentLog = approxLog10BigNum(firstPrice);\r\n    } else {\r\n      return { count: zero, spent: zero, nextPrice: firstPrice, numericCount: 0 };\r\n    }\r\n  }\r\n\r\n  if (count < limit) {\r\n  const safeTimes2 = (x) => {\r\n    const y = x * 2;\r\n    return Number.isFinite(y) ? y : Number.MAX_VALUE;\r\n  };\r\n\r\n  let lo = count;\r\n  let hi = Math.min(limit, Math.max(count + 1, safeTimes2(count)));\r\n  let hiLog = logSeriesTotal(upg, startLevelNum, hi);\r\n\r\n  while (lo < hi && Number.isFinite(hiLog) && hiLog <= walletLog + EPS && hi < limit) {\r\n    lo = hi;\r\n    hi = Math.min(limit, safeTimes2(hi));\r\n    hiLog = logSeriesTotal(upg, startLevelNum, hi);\r\n  }\r\n\r\n  let left = lo, right = hi;\r\n  for (let i = 0; i < 256 && left < right; i += 1) {\r\n    const mid = Math.floor((left + right + 1) / 2);\r\n    const midLog = logSeriesTotal(upg, startLevelNum, mid);\r\n    if (Number.isFinite(midLog) && midLog <= walletLog + EPS) {\r\n      left = mid;\r\n      spentLog = midLog;\r\n    } else {\r\n      right = mid - 1;\r\n    }\r\n  }\r\n  count = left;\r\n}\r\n\r\n  let spent = null;\r\n  if (!fastOnly) {\r\n    spent = totalCostBigNum(upg, startLevelNum, count);\r\n    let guard = 0;\r\n    while (spent.cmp(walletBn) > 0 && count > 0 && guard < MAX_TUNE_STEPS) {\r\n      const decremented = safeDecrementCount(count);\r\n      if (!(decremented < count)) break;\r\n      count = decremented;\r\n      spent = totalCostBigNum(upg, startLevelNum, count);\r\n      guard += 1;\r\n    }\r\n    if (count <= 0) {\r\n      return { count: zero, spent: zero, nextPrice: firstPrice, numericCount: 0 };\r\n    }\r\n\r\n    if (count < limit && guard < MAX_TUNE_STEPS) {\r\n      while (count < limit && guard < MAX_TUNE_STEPS) {\r\n        const nextLevel = startLevelNum + count;\r\n        let nextCost;\r\n\r\n        try {\r\n          if (Number.isFinite(nextLevel) && nextLevel < Number.MAX_SAFE_INTEGER / 2) {\r\n            nextCost = BigNum.fromAny(upg.costAtLevel(nextLevel));\r\n          } else {\r\n            const nextLog = startPriceLog + (count * ratioLog10);\r\n            nextCost = bigNumFromLog10(nextLog).floorToInteger();\r\n          }\r\n        } catch {\r\n          break;\r\n        }\r\n\r\n        const newSpent = spent.add(nextCost);\r\n        if (newSpent.cmp(walletBn) > 0) {\r\n          break;\r\n        }\r\n\r\n        spent = newSpent;\r\n        count += 1;\r\n        guard += 1;\r\n      }\r\n    }\r\n  }\r\n\r\nlet nextPrice = zero;\r\n\r\nconst canUseNumericFinal =\r\n  !fastOnly &&\r\n  Number.isFinite(startLevelNum) &&\r\n  Number.isFinite(count) &&\r\n  startLevelNum < Number.MAX_SAFE_INTEGER / 2 &&\r\n  count < Number.MAX_SAFE_INTEGER / 2;\r\n\r\nif (!fastOnly) {\r\n  if (Number.isFinite(cap)) {\r\n    const capRoom = Math.max(0, Math.floor(cap - Math.min(startLevelNum, cap)));\r\n    if (count >= capRoom) {\r\n      nextPrice = zero;\r\n    } else if (canUseNumericFinal) {\r\n      const finalLevel = Math.floor(startLevelNum + count);\r\n      nextPrice = BigNum.fromAny(upg.costAtLevel(finalLevel));\r\n    } else {\r\n      // Fallback: compute via logs to avoid unsafe integer math\r\n      const nextLog = startPriceLog + count * ratioLog10;\r\n      nextPrice = bigNumFromLog10(nextLog);\r\n    }\r\n  } else {\r\n    if (canUseNumericFinal) {\r\n      const finalLevel = Math.floor(startLevelNum + count);\r\n      nextPrice = BigNum.fromAny(upg.costAtLevel(finalLevel));\r\n    } else {\r\n      const nextLog = startPriceLog + count * ratioLog10;\r\n      nextPrice = bigNumFromLog10(nextLog);\r\n    }\r\n  }\r\n}\r\n\r\n  const countBn = countToBigNum(count);\r\n  return {\r\n    count: countBn,\r\n    spent,\r\n    nextPrice,\r\n    numericCount: count,\r\n  };\r\n}\r\n\r\nfunction computeBulkMeta(upg) {\r\n  try {\r\n    const basePrice = BigNum.fromAny(upg.costAtLevel(0));\r\n    const nextPrice = BigNum.fromAny(\r\n      typeof upg.nextCostAfter === 'function'\r\n        ? upg.nextCostAfter(basePrice, 1)\r\n        : upg.costAtLevel(1)\r\n    );\r\n    const logBase = approxLog10BigNum(basePrice);\r\n    const logNext = approxLog10BigNum(nextPrice);\r\n    if (!Number.isFinite(logBase) || !Number.isFinite(logNext)) return null;\r\n    const ratioLog = logNext - logBase;\r\n    if (!Number.isFinite(ratioLog) || ratioLog <= 0) return null;\r\n    const ratio = Math.pow(10, ratioLog);\r\n    if (!Number.isFinite(ratio) || ratio <= 1) return null;\r\n    const denom = ratio - 1;\r\n    if (!(denom > 0) || !Number.isFinite(denom)) return null;\r\n    return {\r\n      ratio,\r\n      ratioLog,\r\n      logDenom: Math.log10(denom),\r\n    };\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\nexport function estimateFlatBulk(priceBn, walletBn, roomBn) {\r\n  // Guardrails\r\n  if (!(priceBn instanceof BigNum)) priceBn = BigNum.fromAny(priceBn ?? 0);\r\n  if (!(walletBn instanceof BigNum)) walletBn = BigNum.fromAny(walletBn ?? 0);\r\n  if (!(roomBn instanceof BigNum)) roomBn = BigNum.fromAny(roomBn ?? 0);\r\n  if (priceBn.isZero?.()) return { count: 0 };\r\n  if (walletBn.isZero?.()) return { count: 0 };\r\n\r\nconst wPlain = walletBn.toPlainIntegerString?.();\r\nconst pPlain = priceBn.toPlainIntegerString?.();\r\nif (wPlain && wPlain !== 'Infinity' && pPlain && pPlain !== 'Infinity') {\r\n  const q = BigInt(wPlain) / BigInt(pPlain);\r\n  let countBn = BigNum.fromAny(q.toString());\r\n  if (!roomBn.isInfinite?.() && countBn.cmp(roomBn) > 0) countBn = roomBn;\r\n  const spent = priceBn.mulBigNumInteger(countBn);\r\n  return { count: levelCapToNumber(countBn), countBn, spent, nextPrice: priceBn };\r\n}\r\n\r\nconst wl = approxLog10BigNum(walletBn);\r\nconst pl = approxLog10BigNum(priceBn);\r\nif (!Number.isFinite(wl) || !Number.isFinite(pl) || wl < pl) return { count: 0 };\r\nlet countBn = bigNumFromLog10(wl - pl).floorToInteger();\r\n  \r\n  if (!roomBn.isInfinite?.() && countBn.cmp(roomBn) > 0) countBn = roomBn;\r\n  \r\n  const spent = priceBn.mulBigNumInteger(countBn);\r\n  const nextPrice = priceBn;\r\n  \r\n  return { count: levelCapToNumber(countBn), countBn, spent, nextPrice };\r\n}\r\n\r\nexport function estimateGeometricBulk(priceBn, walletBn, meta, maxLevels) {\r\n  if (!meta || maxLevels <= 0) return { count: 0 };\r\n  const walletLog = approxLog10BigNum(walletBn);\r\n  const priceLog = approxLog10BigNum(priceBn);\r\n  if (!Number.isFinite(walletLog) || !Number.isFinite(priceLog)) return { count: 0 };\r\n  if (walletLog < priceLog) return { count: 0 };\r\n\r\n  const numerator = walletLog - priceLog + meta.logDenom;\r\n  if (!Number.isFinite(numerator) || numerator <= 0) return { count: 0 };\r\n\r\n  let hi = Math.floor(numerator / meta.ratioLog);\r\n  if (!Number.isFinite(hi) || hi <= 0) return { count: 0 };\r\n  hi = Math.min(hi, maxLevels);\r\n  if (hi <= 0) return { count: 0 };\r\n\r\n  let lo = 0;\r\n  let hiBound = hi;\r\n  for (let iter = 0; iter < 64 && lo < hiBound; iter += 1) {\r\n    const mid = Math.max(0, Math.floor((lo + hiBound + 1) / 2));\r\n    const spentLog = priceLog + mid * meta.ratioLog - meta.logDenom;\r\n    if (spentLog <= walletLog) {\r\n      lo = mid;\r\n    } else {\r\n      hiBound = mid - 1;\r\n    }\r\n  }\r\n\r\n  const best = Math.min(lo, maxLevels);\r\n  if (best <= 0) return { count: 0 };\r\n  const spentLog = priceLog + best * meta.ratioLog - meta.logDenom;\r\n  if (spentLog > walletLog) return { count: 0 };\r\n  const nextPriceLog = priceLog + best * meta.ratioLog;\r\n  const spent = bigNumFromLog10(spentLog);\r\n  const nextPrice = bigNumFromLog10(nextPriceLog);\r\n  return {\r\n    count: best,\r\n    spent,\r\n    nextPrice,\r\n    spentLog,\r\n    nextPriceLog,\r\n  };\r\n}\r\n\r\nfunction toUpgradeBigNum(value, fallback) {\r\n  try {\r\n    return BigNum.fromAny(value ?? fallback ?? 0);\r\n  } catch {\r\n    return BigNum.fromAny(fallback ?? 0);\r\n  }\r\n}\r\n\r\nfunction levelCapToNumber(bn) {\r\n  if (!(bn instanceof BigNum)) return Infinity;\r\n  if (bn.isInfinite?.()) return Infinity;\r\n  try {\r\n    const plain = bn.toPlainIntegerString();\r\n    if (plain === 'Infinity') return Infinity;\r\n    if (!plain) return 0;\r\n    if (plain.length > 15) return Number.MAX_SAFE_INTEGER;\r\n    const num = Number(plain);\r\n    if (!Number.isFinite(num)) return Number.MAX_SAFE_INTEGER;\r\n    return Math.max(0, Math.floor(num));\r\n  } catch {\r\n    return Number.MAX_SAFE_INTEGER;\r\n  }\r\n}\r\n\r\nfunction formatBigNumAsHtml(bn) {\r\n  return formatNumber(bn instanceof BigNum ? bn : BigNum.fromAny(bn ?? 0));\r\n}\r\n\r\n\r\n\r\nfunction formatBigNumAsPlain(bn) {\r\n  return formatBigNumAsHtml(bn).replace(/<[^>]*>/g, '');\r\n}\r\n\r\nfunction safeCloneBigNum(value) {\r\n  if (value instanceof BigNum) {\r\n    try { return value.clone?.() ?? BigNum.fromAny(value); }\r\n    catch { return BigNum.fromInt(0); }\r\n  }\r\n  try {\r\n    return BigNum.fromAny(value ?? 0);\r\n  } catch {\r\n    return BigNum.fromInt(0);\r\n  }\r\n}\r\n\r\nfunction emitUpgradeLevelChange(upg, prevLevelNum, prevLevelBn, nextLevelNum, nextLevelBn) {\r\n  if (!upg || typeof upg.onLevelChange !== 'function') return;\r\n\r\n  const oldBn = safeCloneBigNum(prevLevelBn ?? prevLevelNum ?? 0);\r\n  const newBn = safeCloneBigNum(nextLevelBn ?? nextLevelNum ?? 0);\r\n  const payload = {\r\n    upgrade: upg,\r\n    oldLevel: Number.isFinite(prevLevelNum)\r\n      ? prevLevelNum\r\n      : levelBigNumToNumber(oldBn),\r\n    newLevel: Number.isFinite(nextLevelNum)\r\n      ? nextLevelNum\r\n      : levelBigNumToNumber(newBn),\r\n    oldLevelBn: oldBn,\r\n    newLevelBn: newBn,\r\n  };\r\n\r\n  try {\r\n    upg.onLevelChange(payload);\r\n  } catch {}\r\n}\r\n\r\nfunction nmCostBN(upg, level) {\r\n  return costAtLevelUsingScaling(upg, level);\r\n}\r\n\r\n\r\n\r\n\r\n/**\r\n * upgType:\r\n *  - \"NM\" = No Milestones\r\n *  - \"HM\" = Has Milestones\r\n *\r\n * Optional field:\r\n *  - scaling: Manually change the multiplicative scaling ratio of an upgrade; not necessary for upgrades that have no scaling\r\n */\r\nexport const REGISTRY = [\r\n  {\r\n    area: AREA_KEYS.STARTER_COVE,\r\n    id: 1,\r\n    tie: UPGRADE_TIES.FASTER_COINS,\r\n    title: \"Faster Coins\",\r\n    desc: \"Increases Coin Spawn Rate by +10% per level\",\r\n    lvlCap: 10,\r\n    baseCost: 10,\r\n    costType: \"coins\",\r\n    upgType: \"NM\",\r\n    effectType: \"coin_spawn\",\r\n    icon: \"sc_upgrade_icons/faster_coins1.webp\",\r\n    costAtLevel(level) { return nmCostBN(this, level); },\r\n    nextCostAfter(_, nextLevel) { return nmCostBN(this, nextLevel); },\r\n    effectSummary(level) {\r\n      const mult = this.effectMultiplier(level);\r\n      return `Coin Spawn Rate bonus: ${formatMultForUi(mult)}x`;\r\n    },\r\n    effectMultiplier: E.addPctPerLevel(0.10),\r\n  },\r\n  {\r\n    area: AREA_KEYS.STARTER_COVE,\r\n    id: 2,\r\n    tie: UPGRADE_TIES.UNLOCK_XP,\r\n    title: \"Unlock XP\",\r\n    desc: \"Unlocks the XP system and a new Merchant dialogue\\nXP system: Collect Coins for XP to level up and gain Books\\nEach XP Level also boosts Coin value by a decent amount\",\r\n    lvlCap: 1,\r\n    upgType: \"NM\",\r\n    icon: \"stats/xp/xp.webp\",\r\n    baseIconOverride: \"stats/xp/xp_base.webp\",\r\n    unlockUpgrade: true,\r\n    costAtLevel() { return BigNum.fromInt(0); },\r\n    nextCostAfter() { return BigNum.fromInt(0); },\r\n    computeLockState: determineLockState,\r\n    effectSummary() { return \"\"; },\r\n    onLevelChange({ newLevel, newLevelBn }) {\r\n      const reached = Number.isFinite(newLevel)\r\n        ? newLevel >= 1\r\n        : (newLevelBn?.cmp?.(BigNum.fromInt(1)) ?? -1) >= 0;\r\n      if (reached) { try { unlockXpSystem(); } catch {} }\r\n    },\r\n  },\r\n  {\r\n    area: AREA_KEYS.STARTER_COVE,\r\n    id: 3,\r\n    tie: UPGRADE_TIES.FASTER_COINS_II,\r\n    title: \"Faster Coins II\",\r\n    desc: \"Increases Coin Spawn Rate by +10% per level\",\r\n    lvlCap: 15,\r\n    baseCost: 1,\r\n    costType: \"books\",\r\n    upgType: \"NM\",\r\n    effectType: \"coin_spawn\",\r\n    icon: \"sc_upgrade_icons/faster_coins2.webp\",\r\n    requiresUnlockXp: true,\r\n    costAtLevel() { return this.baseCostBn?.clone?.() ?? BigNum.fromInt(1); },\r\n    nextCostAfter() { return this.costAtLevel(); },\r\n    effectSummary(level) {\r\n      const mult = this.effectMultiplier(level);\r\n      return `Coin Spawn Rate bonus: ${formatMultForUi(mult)}x`;\r\n    },\r\n    effectMultiplier: E.addPctPerLevel(0.10),\r\n  },\r\n  {\r\n    area: AREA_KEYS.STARTER_COVE,\r\n    id: 4,\r\n    tie: UPGRADE_TIES.COIN_VALUE_I,\r\n    title: \"Coin Value\",\r\n    desc: \"Increases Coin value by +50% per level\",\r\n    lvlCap: 100,\r\n    baseCost: 1,\r\n    costType: \"books\",\r\n    upgType: \"NM\",\r\n    effectType: \"coin_value\",\r\n    icon: \"sc_upgrade_icons/coin_val1.webp\",\r\n    requiresUnlockXp: true,\r\n    costAtLevel() { return this.baseCostBn?.clone?.() ?? BigNum.fromInt(1); },\r\n    nextCostAfter() { return this.costAtLevel(); },\r\n    effectSummary(level) {\r\n      const mult = this.effectMultiplier(level);\r\n      return `Coin value bonus: ${formatMultForUi(mult)}x`;\r\n    },\r\n    effectMultiplier: E.addPctPerLevel(0.50),\r\n    onLevelChange() { try { refreshCoinMultiplierFromXpLevel(); } catch {} },\r\n  },\r\n  {\r\n    area: AREA_KEYS.STARTER_COVE,\r\n    id: 5,\r\n    tie: UPGRADE_TIES.BOOK_VALUE_I,\r\n    title: \"Book Value\",\r\n    desc: \"Doubles Books gained when increasing XP Level\",\r\n    lvlCap: 1,\r\n    baseCost: 10,\r\n    costType: \"books\",\r\n    upgType: \"NM\",\r\n    effectType: \"book_value\",\r\n    icon: \"sc_upgrade_icons/book_val1.webp\",\r\n    requiresUnlockXp: true,\r\n    costAtLevel() { return this.baseCostBn?.clone?.() ?? BigNum.fromInt(1); },\r\n    nextCostAfter() { return this.costAtLevel(); },\r\n    effectSummary(level) {\r\n      return `Book value bonus: 2x`;\r\n    },\r\n    effectMultiplier: (lvl) => normalizedUpgradeLevel(lvl) > 0 ? 2 : 1,\r\n    onLevelChange({ newLevel }) { syncBookCurrencyMultiplierFromUpgrade(newLevel); },\r\n  },\r\n  {\r\n    area: AREA_KEYS.STARTER_COVE,\r\n    id: 6,\r\n    tie: UPGRADE_TIES.XP_VALUE_I,\r\n    title: \"XP Value\",\r\n    desc: \"Increases XP value by +200% per level\",\r\n    lvlCap: 10,\r\n    baseCost: 1000,\r\n    costType: \"coins\",\r\n    upgType: \"NM\",\r\n    effectType: \"xp_value\",\r\n    icon: \"sc_upgrade_icons/xp_val1.webp\",\r\n    requiresUnlockXp: true,\r\n    costAtLevel(level) { return nmCostBN(this, level); },\r\n    nextCostAfter(_, nextLevel) { return nmCostBN(this, nextLevel); },\r\n    effectSummary(level) {\r\n      const mult = this.effectMultiplier(level);\r\n      return `XP value bonus: ${formatMultForUi(mult)}x`;\r\n    },\r\n    effectMultiplier: E.addFlatPerLevel(2),\r\n  },\r\n  {\r\n    area: AREA_KEYS.STARTER_COVE,\r\n    id: 7,\r\n    tie: UPGRADE_TIES.UNLOCK_FORGE,\r\n    title: \"Unlock Forge\",\r\n    desc: \"Unlocks the Reset tab and the Forge reset in the Delve menu\",\r\n    lvlCap: 1,\r\n    upgType: \"NM\",\r\n    icon: \"misc/forge.webp\",\r\n    baseIconOverride: \"stats/mp/mp_base.webp\",\r\n    requiresUnlockXp: true,\r\n    revealRequirement: 'Reach XP Level 31 to reveal this upgrade',\r\n    unlockUpgrade: true,\r\n    costAtLevel() { return BigNum.fromInt(0); },\r\n    nextCostAfter() { return BigNum.fromInt(0); },\r\n    computeLockState: determineLockState,\r\n    onLevelChange({ newLevel }) {\r\n      if ((newLevel ?? 0) >= 1) {\r\n        try { onForgeUpgradeUnlocked(); } catch {}\r\n      }\r\n    },\r\n  },\r\n  {\r\n    area: AREA_KEYS.STARTER_COVE,\r\n    id: 8,\r\n    tie: UPGRADE_TIES.COIN_VALUE_II,\r\n    title: \"Coin Value II\",\r\n    desc: `Increases Coin value by +${formatNumber(BigNum.fromInt(1000))}% per level`,\r\n    lvlCap: 100,\r\n    baseCost: 1,\r\n    costType: \"gold\",\r\n    upgType: \"NM\",\r\n    effectType: \"coin_value\",\r\n    icon: \"sc_upgrade_icons/coin_val2.webp\",\r\n    requiresUnlockXp: true,\r\n    costAtLevel(level) { return nmCostBN(this, level); },\r\n    nextCostAfter(_, nextLevel) { return nmCostBN(this, nextLevel); },\r\n    computeLockState: determineLockState,\r\n    effectSummary(level) {\r\n      const mult = this.effectMultiplier(level);\r\n      return `Coin value bonus: ${formatMultForUi(mult)}x`;\r\n    },\r\n    effectMultiplier: E.addPctPerLevel(10),\r\n    onLevelChange() { try { refreshCoinMultiplierFromXpLevel(); } catch {} },\r\n  },\r\n  {\r\n    area: AREA_KEYS.STARTER_COVE,\r\n    id: 9,\r\n    tie: UPGRADE_TIES.XP_VALUE_II,\r\n    title: \"XP Value II\",\r\n    desc: \"Increases XP value by +100% per level\",\r\n    lvlCap: 100,\r\n    baseCost: 3,\r\n    costType: \"gold\",\r\n    upgType: \"NM\",\r\n    effectType: \"xp_value\",\r\n    icon: \"sc_upgrade_icons/xp_val2.webp\",\r\n    requiresUnlockXp: true,\r\n    costAtLevel(level) { return nmCostBN(this, level); },\r\n    nextCostAfter(_, nextLevel) { return nmCostBN(this, nextLevel); },\r\n    computeLockState: determineLockState,\r\n    effectSummary(level) {\r\n      const mult = this.effectMultiplier(level);\r\n      return `XP value bonus: ${formatMultForUi(mult)}x`;\r\n    },\r\n    effectMultiplier: E.addPctPerLevel(1),\r\n  },\r\n  {\r\n    area: AREA_KEYS.STARTER_COVE,\r\n    id: 10,\r\n    tie: UPGRADE_TIES.MP_VALUE_I,\r\n    title: \"MP Value\",\r\n    desc: \"Increases MP value by +100% per level\",\r\n    lvlCap: 100,\r\n    baseCost: 25,\r\n    costType: \"gold\",\r\n    upgType: \"NM\",\r\n    effectType: \"mp_value\",\r\n    icon: \"sc_upgrade_icons/mp_val1.webp\",\r\n    requiresUnlockXp: true,\r\n    costAtLevel(level) { return nmCostBN(this, level); },\r\n    nextCostAfter(_, nextLevel) { return nmCostBN(this, nextLevel); },\r\n    computeLockState: determineLockState,\r\n    effectSummary(level) {\r\n      const mult = this.effectMultiplier(level);\r\n      return `MP value bonus: ${formatMultForUi(mult)}x`;\r\n    },\r\n    effectMultiplier: E.addPctPerLevel(1),\r\n  },\r\n  {\r\n    area: AREA_KEYS.STARTER_COVE,\r\n    id: 11,\r\n    tie: UPGRADE_TIES.MAGNET,\r\n    title: \"Magnet\",\r\n    desc: \"Increases Magnet radius by +1 Unit per level\\nMagnet: Increases the distance from which you can collect Coins\",\r\n    lvlCap: 5,\r\n    baseCost: 100,\r\n    costType: \"gold\",\r\n    upgType: \"NM\",\r\n    effectType: \"magnet_radius\",\r\n    icon: \"sc_upgrade_icons/magnet.webp\",\r\n    requiresUnlockXp: true,\r\n    scaling: { ratio: 5 },\r\n    costAtLevel(level) { return nmCostBN(this, level); },\r\n    nextCostAfter(_, nextLevel) { return nmCostBN(this, nextLevel); },\r\n    computeLockState: determineLockState,\r\n    effectSummary(level) {\r\n      const units = normalizedUpgradeLevel(level); // zero-based (+0 units at level 0)\r\n      const unitsText = formatMultForUi(units);\r\n      const suffix = (unitsText === '1') ? 'Unit' : 'Units';\r\n      return `Magnet radius: ${unitsText} ${suffix}`;\r\n    },\r\n    effectMultiplier: (lvl) => normalizedUpgradeLevel(lvl),\r\n  },\r\n  {\r\n    area: AREA_KEYS.STARTER_COVE,\r\n    id: 12,\r\n    tie: UPGRADE_TIES.ENDLESS_XP,\r\n    title: \"Endless XP\",\r\n    desc: \"The first Milestone-type upgrade\\nMilestones: Reach certain upgrade levels for powerful buffs\\nMultiplies XP value by 1.1x per level\",\r\n    lvlCap: HM_EVOLUTION_INTERVAL,\r\n    baseCost: 1e6,\r\n    costType: \"coins\",\r\n    upgType: \"HM\",\r\n    effectType: \"xp_value\",\r\n    icon: \"sc_upg_icons/xp_val_hm.webp\",\r\n    requiresUnlockXp: true,\r\n    scalingPreset: 'HM',\r\n    costAtLevel(level) { return costAtLevelUsingScaling(this, level); },\r\n    nextCostAfter(_, nextLevel) { return costAtLevelUsingScaling(this, nextLevel); },\r\n    computeLockState: determineLockState,\r\n    effectSummary(level) {\r\n      const lvlBn = ensureLevelBigNum(level);\r\n      let baseMult;\r\n      try { baseMult = this.effectMultiplier(lvlBn); }\r\n      catch { baseMult = 1; }\r\n      const { selfMult } = computeHmMultipliers(this, lvlBn, this.area);\r\n      const total = safeMultiplyBigNum(baseMult, selfMult);\r\n      return `XP value bonus: ${formatMultForUi(total)}x`;\r\n    },\r\n    effectMultiplier: E.powPerLevel(1.1),\r\n  },\r\n  {\r\n    area: AREA_KEYS.STARTER_COVE,\r\n    id: 13,\r\n    tie: UPGRADE_TIES.UNLOCK_INFUSE,\r\n    title: \"Unlock Infuse\",\r\n    desc: \"Unlocks the Infuse reset\",\r\n    lvlCap: 1,\r\n    upgType: \"NM\",\r\n    icon: \"misc/infuse.webp\",\r\n    baseIconOverride: \"misc/infuse_base.webp\",\r\n    requiresUnlockXp: true,\r\n    revealRequirement: 'Reach XP Level 101 to reveal this upgrade',\r\n    unlockUpgrade: true,\r\n    costAtLevel() { return BigNum.fromInt(0); },\r\n    nextCostAfter() { return BigNum.fromInt(0); },\r\n    computeLockState: determineLockState,\r\n    onLevelChange({ newLevel }) {\r\n      if ((newLevel ?? 0) >= 1) {\r\n        try { onInfuseUpgradeUnlocked(); } catch {}\r\n      }\r\n    },\r\n  },\r\n  {\r\n    area: AREA_KEYS.STARTER_COVE,\r\n    id: 14,\r\n    tie: UPGRADE_TIES.COIN_VALUE_III,\r\n    title: \"Coin Value III\",\r\n    desc: `Increases Coin value by +${formatNumber(BigNum.fromInt(100000))}% per level`,\r\n    lvlCap: 100,\r\n    baseCost: 1,\r\n    costType: \"magic\",\r\n    upgType: \"NM\",\r\n    effectType: \"coin_value\",\r\n    icon: \"sc_upg_icons/coin_val3.webp\",\r\n    requiresUnlockXp: true,\r\n    costAtLevel(level) { return nmCostBN(this, level); },\r\n    nextCostAfter(_, nextLevel) { return nmCostBN(this, nextLevel); },\r\n    computeLockState: determineLockState,\r\n    effectSummary(level) {\r\n      const mult = this.effectMultiplier(level);\r\n      return `Coin value bonus: ${formatMultForUi(mult)}x`;\r\n    },\r\n    effectMultiplier: E.addPctPerLevel(1000),\r\n  },\r\n  {\r\n    area: AREA_KEYS.STARTER_COVE,\r\n    id: 15,\r\n    tie: UPGRADE_TIES.XP_VALUE_III,\r\n    title: \"XP Value III\",\r\n    desc: \"Increases XP value by +100% per level\",\r\n    lvlCap: 100,\r\n    baseCost: 3,\r\n    costType: \"magic\",\r\n    upgType: \"NM\",\r\n    effectType: \"xp_value\",\r\n    icon: \"sc_upg_icons/xp_val3.webp\",\r\n    requiresUnlockXp: true,\r\n    costAtLevel(level) { return nmCostBN(this, level); },\r\n    nextCostAfter(_, nextLevel) { return nmCostBN(this, nextLevel); },\r\n    computeLockState: determineLockState,\r\n    effectSummary(level) {\r\n      const mult = this.effectMultiplier(level);\r\n      return `XP value bonus: ${formatMultForUi(mult)}x`;\r\n    },\r\n    effectMultiplier: E.addPctPerLevel(1),\r\n  },\r\n  {\r\n    area: AREA_KEYS.STARTER_COVE,\r\n    id: 16,\r\n    tie: UPGRADE_TIES.MP_VALUE_II,\r\n    title: \"MP Value II\",\r\n    desc: \"Increases MP value by +100% per level\",\r\n    lvlCap: 100,\r\n    baseCost: 25,\r\n    costType: \"magic\",\r\n    upgType: \"NM\",\r\n    effectType: \"mp_value\",\r\n    icon: \"sc_upg_icons/mp_val2.webp\",\r\n    requiresUnlockXp: true,\r\n    costAtLevel(level) { return nmCostBN(this, level); },\r\n    nextCostAfter(_, nextLevel) { return nmCostBN(this, nextLevel); },\r\n    computeLockState: determineLockState,\r\n    effectSummary(level) {\r\n      const mult = this.effectMultiplier(level);\r\n      return `MP value bonus: ${formatMultForUi(mult)}x`;\r\n    },\r\n    effectMultiplier: E.addPctPerLevel(1),\r\n  },\r\n  {\r\n    area: AREA_KEYS.STARTER_COVE,\r\n    id: 17,\r\n    tie: UPGRADE_TIES.FASTER_COINS_III,\r\n    title: \"Faster Coins III\",\r\n    desc: \"Doubles Coin Spawn Rate\",\r\n    lvlCap: 1,\r\n    baseCost: 100,\r\n    costType: \"magic\",\r\n    upgType: \"NM\",\r\n    effectType: \"coin_spawn\",\r\n    icon: \"sc_upg_icons/faster_coins3.webp\",\r\n    requiresUnlockXp: true,\r\n    costAtLevel(level) { return nmCostBN(this, level); },\r\n    nextCostAfter(_, nextLevel) { return nmCostBN(this, nextLevel); },\r\n    computeLockState: determineLockState,\r\n    effectSummary(level) {\r\n      const mult = this.effectMultiplier(level);\r\n      return `Coin Spawn Rate bonus: ${formatMultForUi(mult)}x`;\r\n    },\r\n    effectMultiplier: E.addPctPerLevel(1),\r\n  },\r\n  {\r\n    area: AREA_KEYS.STARTER_COVE,\r\n    id: 18,\r\n    tie: UPGRADE_TIES.ENDLESS_MP,\r\n    title: \"Endless MP\",\r\n    desc: \"Multiplies MP value by 1.1x per level\",\r\n    lvlCap: HM_EVOLUTION_INTERVAL,\r\n    baseCost: 1e12,\r\n    costType: \"coins\",\r\n    upgType: \"HM\",\r\n    effectType: \"mp_value\",\r\n    icon: \"sc_upg_icons/mp_val_hm.webp\",\r\n    requiresUnlockXp: true,\r\n    scalingPreset: 'HM',\r\n    costAtLevel(level) { return costAtLevelUsingScaling(this, level); },\r\n    nextCostAfter(_, nextLevel) { return costAtLevelUsingScaling(this, nextLevel); },\r\n    computeLockState: determineLockState,\r\n    effectSummary(level) {\r\n      const lvlBn = ensureLevelBigNum(level);\r\n      let baseMult;\r\n      try { baseMult = this.effectMultiplier(lvlBn); }\r\n      catch { baseMult = 1; }\r\n      const { selfMult } = computeHmMultipliers(this, lvlBn, this.area);\r\n      const total = safeMultiplyBigNum(baseMult, selfMult);\r\n      return `MP value bonus: ${formatMultForUi(total)}x`;\r\n    },\r\n    effectMultiplier: E.powPerLevel(1.1),\r\n  },\r\n  {\r\n    area: AREA_KEYS.STARTER_COVE,\r\n    id: 19,\r\n    tie: UPGRADE_TIES.UNLOCK_SURGE,\r\n    title: \"Unlock Surge\",\r\n    desc: \"Unlocks the Surge reset\",\r\n    lvlCap: 1,\r\n    upgType: \"NM\",\r\n    icon: \"\",\r\n    baseIconOverride: \"misc/surge_plus_base.webp\",\r\n    requiresUnlockXp: true,\r\n    revealRequirement: 'Reach XP Level 201 to reveal this upgrade',\r\n    unlockUpgrade: true,\r\n    costAtLevel() { return BigNum.fromInt(0); },\r\n    nextCostAfter() { return BigNum.fromInt(0); },\r\n    computeLockState: determineLockState,\r\n    onLevelChange({ newLevel }) {\r\n      if ((newLevel ?? 0) >= 1) {\r\n        try { onSurgeUpgradeUnlocked(); } catch {}\r\n      }\r\n    },\r\n  },\r\n  {\r\n    area: AREA_KEYS.STARTER_COVE,\r\n    id: 20,\r\n    tie: UPGRADE_TIES.ENDLESS_COINS,\r\n    title: \"Endless Coins\",\r\n    desc: \"Multiplies Coin value by 1.1x per level\",\r\n    lvlCap: HM_EVOLUTION_INTERVAL,\r\n    baseCost: 1e17,\r\n    costType: \"books\",\r\n    upgType: \"HM\",\r\n    effectType: \"coin_value\",\r\n    icon: \"sc_upg_icons/coin_val_hm1.webp\",\r\n    scalingPreset: 'HM',\r\n    costAtLevel(level) { return costAtLevelUsingScaling(this, level); },\r\n    nextCostAfter(_, nextLevel) { return costAtLevelUsingScaling(this, nextLevel); },\r\n    computeLockState(ctx) {\r\n      const surgeLevel = getCurrentSurgeLevel();\r\n      // surgeLevel might be BigNum or Number or Infinity.\r\n      // getCurrentSurgeLevel returns BigInt or Infinity.\r\n      \r\n      let isUnlocked = false;\r\n      if (surgeLevel === Infinity || (typeof surgeLevel === 'string' && surgeLevel === 'Infinity')) {\r\n          isUnlocked = true;\r\n      } else if (typeof surgeLevel === 'bigint') {\r\n          isUnlocked = surgeLevel >= 3n;\r\n      } else if (typeof surgeLevel === 'number') {\r\n          isUnlocked = surgeLevel >= 3;\r\n      }\r\n      \r\n      if (isUnlocked) {\r\n          return { locked: false };\r\n      }\r\n      \r\n      let xp201 = false;\r\n      try { const xpBn = currentXpLevelBigNum(); xp201 = levelBigNumToNumber(xpBn) >= 201; } catch {}\r\n\r\n      if (xp201) {\r\n          const revealText = \"Reach Surge 3 to reveal this upgrade\";\r\n          return {\r\n              locked: true,\r\n              iconOverride: MYSTERIOUS_UPGRADE_ICON_DATA_URL,\r\n              titleOverride: HIDDEN_UPGRADE_TITLE,\r\n              descOverride: revealText,\r\n              reason: revealText,\r\n              hidden: true,\r\n              hideCost: true,\r\n              hideEffect: true,\r\n              useLockedBase: true,\r\n          };\r\n      }\r\n      \r\n      return {\r\n          locked: true,\r\n          hidden: false,\r\n          hideCost: true,\r\n          hideEffect: true,\r\n          useLockedBase: true,\r\n          titleOverride: LOCKED_UPGRADE_TITLE,\r\n          descOverride: 'Locked',\r\n      };\r\n    },\r\n    onLevelChange() { try { refreshCoinMultiplierFromXpLevel(); } catch {} },\r\n    effectSummary(level) {\r\n      const lvlBn = ensureLevelBigNum(level);\r\n      let baseMult;\r\n      try { baseMult = this.effectMultiplier(lvlBn); }\r\n      catch { baseMult = 1; }\r\n      const { selfMult } = computeHmMultipliers(this, lvlBn, this.area);\r\n      const total = safeMultiplyBigNum(baseMult, selfMult);\r\n      return `Coin value bonus: ${formatMultForUi(total)}x`;\r\n    },\r\n    effectMultiplier: E.powPerLevel(1.1),\r\n  },\r\n  {\r\n    area: AREA_KEYS.STARTER_COVE,\r\n    id: 21,\r\n    tie: UPGRADE_TIES.ENDLESS_COINS_II,\r\n    title: \"Endless Coins II\",\r\n    desc: \"Multiplies Coin value by 1.1x per level\",\r\n    lvlCap: HM_EVOLUTION_INTERVAL,\r\n    baseCost: 1e11,\r\n    costType: \"gold\",\r\n    upgType: \"HM\",\r\n    effectType: \"coin_value\",\r\n    icon: \"sc_upg_icons/coin_val_hm2.webp\",\r\n    scalingPreset: 'HM',\r\n    costAtLevel(level) { return costAtLevelUsingScaling(this, level); },\r\n    nextCostAfter(_, nextLevel) { return costAtLevelUsingScaling(this, nextLevel); },\r\n    computeLockState(ctx) {\r\n      const surgeLevel = getCurrentSurgeLevel();\r\n      \r\n      let isUnlocked = false;\r\n      if (surgeLevel === Infinity || (typeof surgeLevel === 'string' && surgeLevel === 'Infinity')) {\r\n          isUnlocked = true;\r\n      } else if (typeof surgeLevel === 'bigint') {\r\n          isUnlocked = surgeLevel >= 5n;\r\n      } else if (typeof surgeLevel === 'number') {\r\n          isUnlocked = surgeLevel >= 5;\r\n      }\r\n      \r\n      if (isUnlocked) {\r\n          return { locked: false };\r\n      }\r\n      \r\n      let xp201 = false;\r\n      try { const xpBn = currentXpLevelBigNum(); xp201 = levelBigNumToNumber(xpBn) >= 201; } catch {}\r\n\r\n      if (xp201) {\r\n          const revealText = \"Reach Surge 5 to reveal this upgrade\";\r\n          return {\r\n              locked: true,\r\n              iconOverride: MYSTERIOUS_UPGRADE_ICON_DATA_URL,\r\n              titleOverride: HIDDEN_UPGRADE_TITLE,\r\n              descOverride: revealText,\r\n              reason: revealText,\r\n              hidden: true,\r\n              hideCost: true,\r\n              hideEffect: true,\r\n              useLockedBase: true,\r\n          };\r\n      }\r\n      \r\n      return {\r\n          locked: true,\r\n          hidden: false,\r\n          hideCost: true,\r\n          hideEffect: true,\r\n          useLockedBase: true,\r\n          titleOverride: LOCKED_UPGRADE_TITLE,\r\n          descOverride: 'Locked',\r\n      };\r\n    },\r\n    onLevelChange() { try { refreshCoinMultiplierFromXpLevel(); } catch {} },\r\n    effectSummary(level) {\r\n      const lvlBn = ensureLevelBigNum(level);\r\n      let baseMult;\r\n      try { baseMult = this.effectMultiplier(lvlBn); }\r\n      catch { baseMult = 1; }\r\n      const { selfMult } = computeHmMultipliers(this, lvlBn, this.area);\r\n      const total = safeMultiplyBigNum(baseMult, selfMult);\r\n      return `Coin value bonus: ${formatMultForUi(total)}x`;\r\n    },\r\n    effectMultiplier: E.powPerLevel(1.1),\r\n  },\r\n  {\r\n    area: AREA_KEYS.STARTER_COVE,\r\n    id: 22,\r\n    tie: UPGRADE_TIES.ENDLESS_COINS_III,\r\n    title: \"Endless Coins III\",\r\n    desc: \"Multiplies Coin value by 1.1x per level\",\r\n    lvlCap: HM_EVOLUTION_INTERVAL,\r\n    baseCost: 1e14,\r\n    costType: \"magic\",\r\n    upgType: \"HM\",\r\n    effectType: \"coin_value\",\r\n    icon: \"sc_upg_icons/coin_val_hm3.webp\",\r\n    scalingPreset: 'HM',\r\n    costAtLevel(level) { return costAtLevelUsingScaling(this, level); },\r\n    nextCostAfter(_, nextLevel) { return costAtLevelUsingScaling(this, nextLevel); },\r\n    computeLockState(ctx) {\r\n      const surgeLevel = getCurrentSurgeLevel();\r\n      \r\n      let isUnlocked = false;\r\n      if (surgeLevel === Infinity || (typeof surgeLevel === 'string' && surgeLevel === 'Infinity')) {\r\n          isUnlocked = true;\r\n      } else if (typeof surgeLevel === 'bigint') {\r\n          isUnlocked = surgeLevel >= 7n;\r\n      } else if (typeof surgeLevel === 'number') {\r\n          isUnlocked = surgeLevel >= 7;\r\n      }\r\n      \r\n      if (isUnlocked) {\r\n          return { locked: false };\r\n      }\r\n      \r\n      let xp201 = false;\r\n      try { const xpBn = currentXpLevelBigNum(); xp201 = levelBigNumToNumber(xpBn) >= 201; } catch {}\r\n\r\n      if (xp201) {\r\n          const revealText = \"Reach Surge 7 to reveal this upgrade\";\r\n          return {\r\n              locked: true,\r\n              iconOverride: MYSTERIOUS_UPGRADE_ICON_DATA_URL,\r\n              titleOverride: HIDDEN_UPGRADE_TITLE,\r\n              descOverride: revealText,\r\n              reason: revealText,\r\n              hidden: true,\r\n              hideCost: true,\r\n              hideEffect: true,\r\n              useLockedBase: true,\r\n          };\r\n      }\r\n      \r\n      return {\r\n          locked: true,\r\n          hidden: false,\r\n          hideCost: true,\r\n          hideEffect: true,\r\n          useLockedBase: true,\r\n          titleOverride: LOCKED_UPGRADE_TITLE,\r\n          descOverride: 'Locked',\r\n      };\r\n    },\r\n    onLevelChange() { try { refreshCoinMultiplierFromXpLevel(); } catch {} },\r\n    effectSummary(level) {\r\n      const lvlBn = ensureLevelBigNum(level);\r\n      let baseMult;\r\n      try { baseMult = this.effectMultiplier(lvlBn); }\r\n      catch { baseMult = 1; }\r\n      const { selfMult } = computeHmMultipliers(this, lvlBn, this.area);\r\n      const total = safeMultiplyBigNum(baseMult, selfMult);\r\n      return `Coin value bonus: ${formatMultForUi(total)}x`;\r\n    },\r\n    effectMultiplier: E.powPerLevel(1.1),\r\n  },\r\n  ...AUTOMATION_REGISTRY,\r\n  ...DNA_REGISTRY,\r\n\r\n];\r\nfor (const upg of REGISTRY) {\r\n  const tieKey = normalizeUpgradeTie(upg.tie ?? upg.tieKey);\r\n  if (tieKey && !upgradeTieLookup.has(tieKey)) {\r\n    upgradeTieLookup.set(tieKey, upg);\r\n  }\r\n  upg.baseCost = toUpgradeBigNum(upg.baseCost ?? 0, 0);\r\n  upg.baseCostBn = upg.baseCost;\r\n\r\n  if (upg._dnaEffectVal) {\r\n    if (upg._costScaling === 'HM') {\r\n      upg.costAtLevel = function(level) { return costAtLevelUsingScaling(this, level); };\r\n      upg.nextCostAfter = function(_, nextLevel) { return costAtLevelUsingScaling(this, nextLevel); };\r\n    }\r\n    \r\n    if (typeof upg.effectMultiplier !== 'function') {\r\n      upg.effectMultiplier = E.powPerLevel(upg._dnaEffectVal);\r\n    }\r\n    \r\n    if (typeof upg.effectSummary !== 'function') {\r\n      upg.effectSummary = function(level) {\r\n        const lvlBn = ensureLevelBigNum(level);\r\n        let baseMult;\r\n        try { baseMult = this.effectMultiplier(lvlBn); }\r\n        catch { baseMult = 1; }\r\n        const { selfMult } = computeHmMultipliers(this, lvlBn, this.area);\r\n        const total = safeMultiplyBigNum(baseMult, selfMult);\r\n        \r\n        if (typeof this.bonusLine === 'function') {\r\n            return this.bonusLine(level, total);\r\n        }\r\n        \r\n        let label = \"Bonus\";\r\n        if (this.effectType === 'coin_value') label = \"Coin value bonus\";\r\n        if (this.effectType === 'xp_value') label = \"XP value bonus\";\r\n        \r\n        return `${label}: ${formatMultForUi(total)}x`;\r\n      };\r\n    }\r\n  }\r\n\r\n  upg.numUpgEvolutions = normalizeHmEvolutionCount(upg.numUpgEvolutions);\r\n  if (upg.upgType === 'HM') {\r\n    applyHmEvolutionMeta(upg, upg.numUpgEvolutions);\r\n  } else {\r\n    upg.lvlCapBn = toUpgradeBigNum(upg.lvlCap ?? Infinity, Infinity);\r\n    upg.lvlCap = levelCapToNumber(upg.lvlCapBn);\r\n    upg.lvlCapFmtHtml = formatBigNumAsHtml(upg.lvlCapBn);\r\n    upg.lvlCapFmtText = formatBigNumAsPlain(upg.lvlCapBn);\r\n  }\r\n\r\n  upg.bulkMeta = computeBulkMeta(upg);\r\n  ensureUpgradeScaling(upg);\r\n}\r\n\r\nconst areaStatePayloadCache = new Map(); // key \u2192 last serialized payload\r\nconst areaStateMemoryCache = new Map(); // key \u2192 last parsed array reference\r\nconst upgradeStateCache = new Map(); // key \u2192 { areaKey, upgId, upg, rec, arr, lvl, nextCostBn }\r\nconst areaUpgradeOrderCache = new Map();\r\n\r\nfunction getAreaUpgradeOrder(areaKey) {\r\n  const normalizedArea = normalizeAreaKey(areaKey);\r\n  if (!normalizedArea) return null;\r\n\r\n  if (areaUpgradeOrderCache.has(normalizedArea)) {\r\n    return areaUpgradeOrderCache.get(normalizedArea);\r\n  }\r\n\r\n  const order = new Map();\r\n  let rank = 0;\r\n  for (const upg of REGISTRY) {\r\n    if (normalizeAreaKey(upg?.area) !== normalizedArea) continue;\r\n    const normalizedId = normalizeUpgradeId(upg?.id);\r\n    if (normalizedId == null || order.has(normalizedId)) continue;\r\n    order.set(normalizedId, rank);\r\n    rank += 1;\r\n  }\r\n\r\n  areaUpgradeOrderCache.set(normalizedArea, order);\r\n  return order;\r\n}\r\n\r\nfunction normalizeAreaStateRecordOrder(areaKey, arr) {\r\n  if (!Array.isArray(arr) || arr.length <= 1) return false;\r\n  const order = getAreaUpgradeOrder(areaKey);\r\n  if (!(order?.size)) return false;\r\n\r\n  const baseRank = order.size;\r\n  const entries = arr.map((rec, idx) => {\r\n    const normalizedId = normalizeUpgradeId(rec?.id);\r\n    const rank = order.has(normalizedId)\r\n      ? order.get(normalizedId)\r\n      : baseRank + idx;\r\n    return { rec, rank, idx };\r\n  });\r\n\r\n  let needsSort = false;\r\n  for (let i = 1; i < entries.length; i += 1) {\r\n    const prev = entries[i - 1];\r\n    const curr = entries[i];\r\n    if (curr.rank < prev.rank || (curr.rank === prev.rank && curr.idx < prev.idx)) {\r\n      needsSort = true;\r\n      break;\r\n    }\r\n  }\r\n\r\n  if (!needsSort) return false;\r\n\r\n  entries.sort((a, b) => (a.rank - b.rank) || (a.idx - b.idx));\r\n  arr.length = 0;\r\n  for (const entry of entries) arr.push(entry.rec);\r\n  return true;\r\n}\r\n\r\nfunction parseUpgradeStateArray(raw) {\r\n  if (typeof raw !== 'string' || !raw) return null;\r\n  if (raw.length > 1_000_000) return null;\r\n  try {\r\n    const parsed = JSON.parse(raw);\r\n    return Array.isArray(parsed) ? parsed : null;\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\nfunction readStateFromAvailableStorage(key, options = {}) {\r\n  const {\r\n    includeLocal = true,\r\n  } = options || {};\r\n\r\n  const result = {\r\n    data: null,\r\n    raw: null,\r\n    storageChecked: false,\r\n    storageFound: false,\r\n    checkedLocal: false,\r\n    foundLocal: false,\r\n    sourceType: null,\r\n  };\r\n\r\n  if (!key) return result;\r\n\r\n  const storages = [];\r\n  try {\r\n    if (includeLocal && typeof localStorage !== 'undefined') {\r\n      storages.push({ storage: localStorage, type: 'local' });\r\n      result.storageChecked = true;\r\n      result.checkedLocal = true;\r\n    }\r\n  } catch {}\r\n\r\n  for (const entry of storages) {\r\n    const { storage, type } = entry || {};\r\n    const getItem = storage?.getItem;\r\n    if (typeof getItem !== 'function') continue;\r\n    let raw;\r\n    try { raw = getItem.call(storage, key); }\r\n    catch { raw = null; }\r\n    if (raw != null) {\r\n      result.storageFound = true;\r\n      if (type === 'local') result.foundLocal = true;\r\n    }\r\n    const parsed = parseUpgradeStateArray(raw);\r\n    if (parsed) {\r\n      const payload = typeof raw === 'string' && raw ? raw : (() => {\r\n        try { return JSON.stringify(parsed); } catch { return null; }\r\n      })();\r\n      result.data = parsed;\r\n      result.raw = payload;\r\n      result.sourceType = type;\r\n      return result;\r\n    }\r\n  }\r\n\r\n  return result;\r\n}\r\n\r\nfunction cacheAreaState(key, arr, raw) {\r\n  if (!key) return;\r\n  if (Array.isArray(arr)) {\r\n    areaStateMemoryCache.set(key, arr);\r\n  }\r\n  if (typeof raw === 'string') {\r\n    areaStatePayloadCache.set(key, raw);\r\n  }\r\n}\r\n\r\nfunction clearCachedAreaState(storageKey) {\r\n  if (!storageKey) return;\r\n  areaStateMemoryCache.delete(storageKey);\r\n  areaStatePayloadCache.delete(storageKey);\r\n}\r\n\r\nfunction clearCachedUpgradeStates(areaKey, slot) {\r\n  const slotKey = slot == null ? 'null' : String(slot);\r\n  const prefix = `${slotKey}:${areaKey}:`;\r\n  for (const key of upgradeStateCache.keys()) {\r\n    if (key.startsWith(prefix)) {\r\n      upgradeStateCache.delete(key);\r\n    }\r\n  }\r\n}\r\n\r\nfunction keyForArea(areaKey, slot = getActiveSlot()) {\r\n  if (slot == null) return null;\r\n  return `ccc:upgrades:${areaKey}:${slot}`;\r\n}\r\n\r\nexport function getUpgradeStorageKey(areaKey, upgId, slot = getActiveSlot()) {\r\n    if (slot == null) return null;\r\n    const normalizedArea = normalizeAreaKey(areaKey);\r\n    const resolvedId = resolveUpgradeIdentifier(areaKey, upgId);\r\n    if (!normalizedArea || resolvedId == null) return null;\r\n    return `ccc:upgrades:${normalizedArea}:${resolvedId}:${slot}`;\r\n}\r\n\r\nconst upgradeStorageWatcherCleanup = new Map();\r\nlet upgradeStorageWatcherBoundSlot = null;\r\n\r\nfunction cleanupUpgradeStorageWatchers() {\r\n  upgradeStorageWatcherCleanup.forEach((stop) => {\r\n    try { stop?.(); } catch {}\r\n  });\r\n  upgradeStorageWatcherCleanup.clear();\r\n}\r\n\r\nfunction handleUpgradeStorageChange(areaKey, slot, storageKey, rawPayload, meta = {}) {\r\n    // In the new system, listeners on individual keys would be too expensive/complex to maintain\r\n    // for every single upgrade. We rely on the game loop and events.\r\n    // However, if we need to detect external changes (e.g. other tabs), we might just\r\n    // broadcast a generic change event.\r\n    clearCachedUpgradeStates(areaKey, slot);\r\n    notifyChanged();\r\n}\r\n\r\nfunction bindUpgradeStorageWatchersForSlot(slot) {\r\n  // Deprecated: We don't watch hundreds of individual keys.\r\n  // Reliance is on in-memory state and explicit events.\r\n  // If multi-tab sync is required, we can revisit a more sophisticated strategy.\r\n  cleanupUpgradeStorageWatchers();\r\n}\r\n\r\nif (typeof window !== 'undefined') {\r\n  bindUpgradeStorageWatchersForSlot(getActiveSlot());\r\n  window.addEventListener('saveSlot:change', () => {\r\n    bindUpgradeStorageWatchersForSlot(getActiveSlot());\r\n    notifyChanged();\r\n  });\r\n  window.addEventListener('surge:level:change', () => {\r\n    notifyChanged();\r\n  });\r\n}\r\n\r\nfunction migrateLegacyStorage(areaKey, slot) {\r\n    if (typeof localStorage === 'undefined') return;\r\n    const legacyKey = keyForArea(areaKey, slot);\r\n    const raw = localStorage.getItem(legacyKey);\r\n    if (!raw) return;\r\n\r\n    try {\r\n        const arr = JSON.parse(raw);\r\n        if (Array.isArray(arr)) {\r\n            let migratedCount = 0;\r\n            arr.forEach(rec => {\r\n                if (rec && rec.id != null) {\r\n                    const key = getUpgradeStorageKey(areaKey, rec.id, slot);\r\n                    if (key) {\r\n                        // Only write if individual key doesn't exist to prevent overwriting\r\n                        // if migration ran partially before.\r\n                        if (localStorage.getItem(key) === null) {\r\n                            localStorage.setItem(key, JSON.stringify(rec));\r\n                            migratedCount++;\r\n                        }\r\n                    }\r\n                }\r\n            });\r\n        }\r\n    } catch (e) {\r\n        console.warn('Failed to migrate legacy upgrade storage', e);\r\n    }\r\n\r\n    // Rename legacy key to .bak or delete\r\n    try {\r\n        localStorage.removeItem(legacyKey);\r\n        localStorage.removeItem(`${legacyKey}:backup`);\r\n    } catch {}\r\n}\r\n\r\nfunction loadUpgradeFromStorage(areaKey, upgId, slot) {\r\n    migrateLegacyStorage(areaKey, slot);\r\n    const key = getUpgradeStorageKey(areaKey, upgId, slot);\r\n    if (!key) return null;\r\n\r\n    if (isBatching && pendingUpgradeSaves.has(key)) {\r\n        try {\r\n            const pending = pendingUpgradeSaves.get(key);\r\n            if (pending?.state) {\r\n                return JSON.parse(JSON.stringify(pending.state));\r\n            }\r\n        } catch {}\r\n    }\r\n\r\n    if (deferredWrites.has(key)) {\r\n        try {\r\n            const deferred = deferredWrites.get(key);\r\n            if (deferred?.state) {\r\n                return JSON.parse(JSON.stringify(deferred.state));\r\n            }\r\n        } catch {}\r\n    }\r\n\r\n    try {\r\n        const raw = localStorage.getItem(key);\r\n        return raw ? JSON.parse(raw) : null;\r\n    } catch {\r\n        return null;\r\n    }\r\n}\r\n\r\nfunction loadAreaState(areaKey, slot = getActiveSlot(), options = {}) {\r\n  const { forceReload = false } = options || {};\r\n  // For compatibility, we return an array of all upgrade states for the area.\r\n  // This function now eagerly reads all individual keys.\r\n  \r\n  migrateLegacyStorage(areaKey, slot);\r\n\r\n  const upgrades = getUpgradesForArea(areaKey);\r\n  const arr = [];\r\n\r\n  upgrades.forEach(upg => {\r\n      const rec = loadUpgradeFromStorage(areaKey, upg.id, slot);\r\n      if (rec) {\r\n          // Ensure ID is correct\r\n          rec.id = normalizeUpgradeId(upg.id);\r\n          arr.push(rec);\r\n      }\r\n  });\r\n\r\n  // Cache is less relevant for the \"whole area array\" concept now,\r\n  // but we can still populate it to satisfy ensureUpgradeState's expected finding logic\r\n  // if we want to keep ensuring 'arr' exists.\r\n  const storageKey = keyForArea(areaKey, slot); // virtual key for cache\r\n  if (storageKey) {\r\n      cacheAreaState(storageKey, arr, JSON.stringify(arr));\r\n  }\r\n\r\n  return arr;\r\n}\r\n\r\nfunction saveUpgradeState(areaKey, upgId, state, slot = getActiveSlot(), options = {}) {\r\n    const key = getUpgradeStorageKey(areaKey, upgId, slot);\r\n    if (!key) return;\r\n    \r\n    if (isBatching) {\r\n        pendingUpgradeSaves.set(key, { areaKey, upgId, state, slot });\r\n        return;\r\n    }\r\n\r\n    if (options && options.deferSave) {\r\n        deferredWrites.set(key, { areaKey, upgId, state, slot });\r\n        return;\r\n    }\r\n\r\n    if (deferredWrites.has(key)) {\r\n        deferredWrites.delete(key);\r\n    }\r\n\r\n    try {\r\n        const payload = JSON.stringify(state);\r\n        localStorage.setItem(key, payload);\r\n        try { primeStorageWatcherSnapshot(key, payload); } catch {}\r\n    } catch (e) {\r\n        console.warn('Failed to save upgrade state', areaKey, upgId, e);\r\n    }\r\n}\r\n\r\nfunction saveAreaState(areaKey, stateArr, slot = getActiveSlot()) {\r\n  // Deprecated: Loops and saves individual upgrades\r\n  if (!Array.isArray(stateArr)) return;\r\n  stateArr.forEach(rec => {\r\n      if (rec && rec.id != null) {\r\n          saveUpgradeState(areaKey, rec.id, rec, slot);\r\n      }\r\n  });\r\n}\r\n\r\nfunction resolveUpgradeIdentifier(areaKey, upgId) {\r\n  if (upgId && typeof upgId === 'object' && typeof upgId.id !== 'undefined') {\r\n    return normalizeUpgradeId(upgId.id);\r\n  }\r\n  const normalized = normalizeUpgradeId(upgId);\r\n  if (typeof normalized === 'number' || normalized == null) {\r\n    return normalized;\r\n  }\r\n  if (typeof normalized === 'string') {\r\n    const tieKey = normalizeUpgradeTie(normalized);\r\n    if (tieKey) {\r\n      const upg = upgradeTieLookup.get(tieKey);\r\n      if (upg) {\r\n        const requestedArea = normalizeAreaKey(areaKey);\r\n        if (!requestedArea || normalizeAreaKey(upg.area) === requestedArea) {\r\n          return normalizeUpgradeId(upg.id);\r\n        }\r\n      }\r\n    }\r\n  }\r\n  return normalized;\r\n}\r\n\r\nfunction upgradeCacheKey(areaKey, upgId, slot = getActiveSlot()) {\r\n  const slotKey = slot == null ? 'null' : String(slot);\r\n  const resolvedId = resolveUpgradeIdentifier(areaKey, upgId);\r\n  return `${slotKey}:${areaKey}:${normalizeUpgradeId(resolvedId)}`;\r\n}\r\n\r\nfunction ensureUpgradeState(areaKey, upgId) {\r\n  const resolvedId = resolveUpgradeIdentifier(areaKey, upgId);\r\n  const normalizedId = normalizeUpgradeId(resolvedId);\r\n  const slot = getActiveSlot();\r\n  const key = upgradeCacheKey(areaKey, normalizedId, slot);\r\n  let state = upgradeStateCache.get(key);\r\n  if (state) return state;\r\n\r\n  const upg = getUpgrade(areaKey, normalizedId);\r\n  // We can try to load just this specific upgrade first\r\n  let rec = loadUpgradeFromStorage(areaKey, normalizedId, slot);\r\n  \r\n  // If we found it, great. If not, it might be because loadAreaState hasn't run yet to migrate?\r\n  // But migrateLegacyStorage handles key conversion.\r\n  // For safety, we can fall back to array load, but loadAreaState now just calls loadUpgradeFromStorage iteratively anyway.\r\n  \r\n  let recNeedsSave = false;\r\n  if (!rec) {\r\n    // Migration check implicit in loadAreaState or we can run it here for this area if totally missing?\r\n    // Let's assume loadAreaState runs on init. If we access an upgrade, it should exist if persisted.\r\n    // If not, it's new.\r\n    rec = { id: normalizedId, lvl: BigNum.fromInt(0).toStorage() };\r\n    if (upg) {\r\n      try {\r\n        rec.nextCost = BigNum.fromAny(upg.costAtLevel(0)).toStorage();\r\n      } catch {\r\n        rec.nextCost = BigNum.fromInt(0).toStorage();\r\n      }\r\n    }\r\n    rec.nextCostLvl = rec.lvl;\r\n    saveUpgradeState(areaKey, normalizedId, rec, slot);\r\n  } else if (rec.id !== normalizedId) {\r\n    rec.id = normalizedId;\r\n    recNeedsSave = true;\r\n  }\r\n\r\n  const prevLvlStorage = rec.lvl;\r\n  const prevNextCost = rec.nextCost;\r\n  const prevNextCostLvl = rec.nextCostLvl;\r\n  rec.lvl = sanitizeStoredLevelValue(rec.lvl);\r\n  rec.nextCost = sanitizeStoredLevelValue(rec.nextCost, { allowEmpty: true });\r\n  rec.nextCostLvl = sanitizeStoredLevelValue(rec.nextCostLvl, { allowEmpty: true });\r\n  if (\r\n    rec.lvl !== prevLvlStorage\r\n    || rec.nextCost !== prevNextCost\r\n    || rec.nextCostLvl !== prevNextCostLvl\r\n  ) {\r\n    recNeedsSave = true;\r\n  }\r\n\r\n  let hmEvolutions = 0;\r\n  if (upg?.upgType === 'HM') {\r\n    hmEvolutions = normalizeHmEvolutionCount(\r\n      rec.hmEvolutions ?? rec.evolutions ?? rec.evol ?? upg.numUpgEvolutions\r\n    );\r\n    applyHmEvolutionMeta(upg, hmEvolutions);\r\n  }\r\n\r\n  const lvlBn = ensureLevelBigNum(rec.lvl);\r\n  let lvl = levelBigNumToNumber(lvlBn);\r\ntry {\r\n  const capBn = upg?.lvlCapBn ?? BigNum.fromAny('Infinity');\r\n  if (!(capBn.isInfinite?.()) && lvlBn.cmp(capBn) > 0) {\r\n    const clamped = capBn.clone?.() ?? capBn;\r\n    lvl = levelBigNumToNumber(clamped);\r\n    const clampedStorage = clamped.toStorage();\r\n    rec.lvl = clampedStorage;\r\n    rec.nextCost = BigNum.fromInt(0).toStorage();\r\n    rec.nextCostLvl = clampedStorage;\r\n    saveUpgradeState(areaKey, normalizedId, rec, slot);\r\n  }\r\n} catch {}\r\n\r\n  let normalizedLvlStorage = null;\r\n  try {\r\n    normalizedLvlStorage = lvlBn?.toStorage?.() ?? ensureLevelBigNum(lvl).toStorage();\r\n  } catch {}\r\n  if (normalizedLvlStorage && rec.lvl !== normalizedLvlStorage) {\r\n    rec.lvl = normalizedLvlStorage;\r\n    recNeedsSave = true;\r\n  }\r\n\r\n  const costLevelStorage = typeof rec.nextCostLvl === 'string' ? rec.nextCostLvl : null;\r\n  let nextCostStale = !costLevelStorage || costLevelStorage !== normalizedLvlStorage;\r\n\r\n  let nextCostBn = null;\r\n\r\n  if (!nextCostBn || nextCostStale) {\r\n    if (upg) {\r\n      try {\r\n        nextCostBn = BigNum.fromAny(upg.costAtLevel(lvl));\r\n      } catch {\r\n        nextCostBn = BigNum.fromInt(0);\r\n      }\r\n    } else {\r\n      nextCostBn = BigNum.fromInt(0);\r\n    }\r\n    try {\r\n      rec.nextCost = nextCostBn.toStorage();\r\n      if (normalizedLvlStorage) {\r\n        rec.nextCostLvl = normalizedLvlStorage;\r\n      } else {\r\n        delete rec.nextCostLvl;\r\n      }\r\n      recNeedsSave = true;\r\n    } catch {}\r\n  }\r\n\r\n  if (recNeedsSave) {\r\n    try { saveUpgradeState(areaKey, normalizedId, rec, slot); }\r\n    catch {}\r\n  }\r\n\r\n  if (upg?.upgType === 'HM' && lvlBn?.isInfinite?.()) {\r\n    if (!upg.lvlCapBn?.isInfinite?.()) {\r\n      const infCap = BigNum.fromAny('Infinity');\r\n      upg.lvlCapBn = infCap;\r\n      upg.lvlCap = Number.POSITIVE_INFINITY;\r\n      upg.lvlCapFmtHtml = formatBigNumAsHtml(infCap);\r\n      upg.lvlCapFmtText = formatBigNumAsPlain(infCap);\r\n    }\r\n  }\r\n\r\n  // We no longer strictly maintain 'arr' in state, but we can pass an empty [] or null\r\n  // since most consumers should look at 'rec'.\r\n  state = { areaKey, upgId: normalizedId, upg, rec, arr: [], lvl, lvlBn, nextCostBn, slot, hmEvolutions };\r\n  upgradeStateCache.set(key, state);\r\n  return state;\r\n}\r\n\r\nfunction commitUpgradeState(state, options = {}) {\r\n  if (!state) return;\r\n  const { areaKey } = state;\r\n  const slot = state.slot ?? getActiveSlot();\r\n  if (!areaKey || slot == null) return;\r\n\r\n  const normalizedId = normalizeUpgradeId(state.upgId ?? state.rec?.id);\r\n  // We do NOT reload the whole area here. We work on the cached rec.\r\n  \r\n  let rec = state.rec;\r\n  if (!rec) {\r\n      rec = { id: normalizedId };\r\n      state.rec = rec;\r\n  }\r\n\r\ntry {\r\n  const capBn = state.upg?.lvlCapBn ?? BigNum.fromAny('Infinity');\r\n  let inBn = state.lvlBn?.clone?.() ?? ensureLevelBigNum(state.lvlBn ?? state.lvl);\r\n  if (!(capBn.isInfinite?.()) && inBn.cmp(capBn) > 0) {\r\n    inBn = capBn.clone?.() ?? capBn;\r\n    state.lvlBn = inBn;\r\n    state.lvl = levelBigNumToNumber(inBn);\r\n  }\r\n} catch {}\r\n\r\n  try {\r\n    rec.lvl = state.lvlBn?.toStorage?.() ?? ensureLevelBigNum(state.lvlBn ?? state.lvl).toStorage();\r\n  } catch {\r\n    rec.lvl = ensureLevelBigNum(state.lvl ?? 0).toStorage();\r\n  }\r\n  rec.lvl = sanitizeStoredLevelValue(rec.lvl);\r\n  const currentLvlStorage = rec.lvl;\r\n\r\n  if (state.nextCostBn != null) {\r\n    try {\r\n      rec.nextCost = BigNum.fromAny(state.nextCostBn).toStorage();\r\n    } catch {\r\n      try { rec.nextCost = BigNum.fromAny(state.nextCostBn ?? 0).toStorage(); }\r\n      catch { rec.nextCost = BigNum.fromInt(0).toStorage(); }\r\n    }\r\n    rec.nextCost = sanitizeStoredLevelValue(rec.nextCost, { allowEmpty: true });\r\n    rec.nextCostLvl = currentLvlStorage;\r\n  } else {\r\n    delete rec.nextCostLvl;\r\n  }\r\n\r\n  if (state.hmEvolutions != null) {\r\n    rec.hmEvolutions = normalizeHmEvolutionCount(state.hmEvolutions);\r\n  }\r\n\r\n  saveUpgradeState(areaKey, normalizedId, rec, slot, options);\r\n  state.slot = slot;\r\n}\r\n\r\nfunction invalidateUpgradeState(areaKey, upgId, slot = getActiveSlot()) {\r\n  upgradeStateCache.delete(upgradeCacheKey(areaKey, upgId, slot));\r\n}\r\n\r\nexport function getLevelNumber(areaKey, upgId) {\r\n  return ensureUpgradeState(areaKey, upgId).lvl;\r\n}\r\n\r\nexport function getHmEvolutions(areaKey, upgId) {\r\n  return ensureUpgradeState(areaKey, upgId).hmEvolutions ?? 0;\r\n}\r\n\r\n\r\n\r\n\r\nfunction computeUpgradeLockStateFor(areaKey, upg) {\r\n  if (!upg) return { locked: false };\r\n\r\n  const xpUnlocked = safeIsXpUnlocked();\r\n  const xpLevelBn = xpUnlocked ? currentXpLevelBigNum() : BigNum.fromInt(0);\r\n  const xpLevel = xpUnlocked ? levelBigNumToNumber(xpLevelBn) : 0;\r\n\r\n  let baseState = { locked: false };\r\nif (upg.requiresUnlockXp && !xpUnlocked) {\r\n  const isXpAdj = isXpAdjacentUpgrade(areaKey, upg);\r\n  const xpRevealText = 'Unlock the XP system to reveal this upgrade';\r\n  const unlockXpVisible = safeHasMetMerchant();\r\n\r\n  if (isXpAdj) {\r\n    if (!unlockXpVisible) {\r\n      const meetText = 'Meet the Merchant to reveal \"Unlock XP\"';\r\n      baseState = {\r\n        locked: true,\r\n        iconOverride: LOCKED_UPGRADE_ICON_DATA_URL,\r\n        titleOverride: LOCKED_UPGRADE_TITLE,\r\n        descOverride: meetText,\r\n        reason: meetText,\r\n        hidden: false,\r\n        hideCost: false,\r\n        hideEffect: false,\r\n        useLockedBase: true,\r\n      };\r\n    } else {\r\n      baseState = {\r\n        locked: true,\r\n        iconOverride: MYSTERIOUS_UPGRADE_ICON_DATA_URL,\r\n        titleOverride: HIDDEN_UPGRADE_TITLE,\r\n        descOverride: xpRevealText,\r\n        reason: xpRevealText,\r\n        hidden: true,\r\n        hideCost: true,\r\n        hideEffect: true,\r\n        useLockedBase: true,\r\n      };\r\n    }\r\n  } else {\r\n    baseState = {\r\n      locked: true,\r\n      iconOverride: LOCKED_UPGRADE_ICON_DATA_URL,\r\n      titleOverride: LOCKED_UPGRADE_TITLE,\r\n      descOverride: xpRevealText,\r\n      reason: 'Purchase \"Unlock XP\" to reveal this upgrade',\r\n      hidden: false,\r\n      hideCost: false,\r\n      hideEffect: false,\r\n      useLockedBase: true,\r\n    };\r\n  }\r\n}\r\n\r\n  let state = mergeLockStates({ locked: false }, baseState);\r\n  if (typeof upg.computeLockState === 'function') {\r\n    try {\r\n      const ctx = {\r\n        areaKey,\r\n        upg,\r\n        xpUnlocked,\r\n        xpLevelBn,\r\n        xpLevel,\r\n        surgeLevel: getCurrentSurgeLevel(),\r\n        surgeUnlocked: isSurgeUnlocked(),\r\n        baseLocked: state.locked,\r\n        getUpgradeLevel(targetId) { return getLevelNumber(areaKey, targetId); },\r\n      };\r\n      const custom = upg.computeLockState(ctx);\r\n      state = mergeLockStates(state, custom);\r\n    } catch {}\r\n  }\r\n\r\n  const slot = getActiveSlot();\r\n  const revealKey = upgradeRevealKey(areaKey, upg);\r\n  const permaUnlocked = revealKey ? isUpgradePermanentlyUnlocked(areaKey, upg, slot) : false;\r\n  if (revealKey) {\r\n    const revealState = ensureShopRevealState(slot);\r\n    const permaState  = ensureShopPermaUnlockState(slot);\r\n    const permaMystState = ensureShopPermaMystState(slot);\r\n    const hyphenKey   = revealKey.replace(/_/g, '-');\r\n    const legacyKey   = upgradeLegacyRevealKey(areaKey, upg);\r\n\r\n    let needsRevealSave = false;\r\n    if (migrateUpgradeStateKey(revealState, hyphenKey, revealKey)) {\r\n      needsRevealSave = true;\r\n    }\r\n    if (legacyKey && migrateUpgradeStateKey(revealState, legacyKey, revealKey)) {\r\n      needsRevealSave = true;\r\n    }\r\n    if (needsRevealSave) {\r\n      saveShopRevealState(revealState, slot);\r\n    }\r\n\r\n    let needsPermaSave = false;\r\n    if (migrateUpgradeStateKey(permaState, hyphenKey, revealKey)) {\r\n      needsPermaSave = true;\r\n    }\r\n    if (legacyKey && migrateUpgradeStateKey(permaState, legacyKey, revealKey)) {\r\n      needsPermaSave = true;\r\n    }\r\n    if (needsPermaSave) {\r\n      saveShopPermaUnlockState(permaState, slot);\r\n    }\r\n\r\n    let needsPermaMystSave = false;\r\n    if (migrateUpgradeStateKey(permaMystState, hyphenKey, revealKey)) {\r\n      needsPermaMystSave = true;\r\n    }\r\n    if (legacyKey && migrateUpgradeStateKey(permaMystState, legacyKey, revealKey)) {\r\n      needsPermaMystSave = true;\r\n    }\r\n    if (needsPermaMystSave) {\r\n      saveShopPermaMystState(permaMystState, slot);\r\n    }\r\n  }\r\n\r\n  if (state.locked) {\r\n    const hiddenState = !!state.hidden;\r\n    if (!state.iconOverride) state.iconOverride = LOCKED_UPGRADE_ICON_DATA_URL;\r\n\r\n    if (hiddenState) {\r\n      if (!state.titleOverride) state.titleOverride = HIDDEN_UPGRADE_TITLE;\r\n    } else if (!state.titleOverride || state.titleOverride === HIDDEN_UPGRADE_TITLE) {\r\n      state.titleOverride = LOCKED_UPGRADE_TITLE;\r\n    }\r\n\r\n    if (state.useLockedBase == null) state.useLockedBase = true;\r\n    if (!state.reason && upg?.revealRequirement) state.reason = upg.revealRequirement;\r\n\r\n    if (!state.descOverride) {\r\n      if (state.reason) {\r\n        state.descOverride = `${state.reason}`;\r\n      } else if (upg?.revealRequirement) {\r\n        state.descOverride = upg.revealRequirement;\r\n      } else if (hiddenState) {\r\n        state.descOverride = 'This upgrade is currently hidden.';\r\n      }\r\n    }\r\n  } else {\r\n    state.hidden = false;\r\n    state.hideCost = false;\r\n    state.hideEffect = false;\r\n    state.useLockedBase = false;\r\n    if (state.iconOverride === LOCKED_UPGRADE_ICON_DATA_URL ||\r\n        state.iconOverride === MYSTERIOUS_UPGRADE_ICON_DATA_URL) {\r\n      delete state.iconOverride;\r\n    }\r\n    if (state.titleOverride === HIDDEN_UPGRADE_TITLE ||\r\n        state.titleOverride === LOCKED_UPGRADE_TITLE) {\r\n      delete state.titleOverride;\r\n    }\r\n    delete state.descOverride;\r\n    delete state.reason;\r\n  }\r\n\r\n  if (state.locked && upg.requiresUnlockXp && !xpUnlocked && !state.iconOverride) {\r\n    state.iconOverride = LOCKED_UPGRADE_ICON_DATA_URL;\r\n  }\r\n\r\n  if (revealKey) {\r\n    const revealState = ensureShopRevealState(slot);\r\n    const rec = revealState.upgrades[revealKey] || {};\r\n    const tieKey = normalizeUpgradeTie(upg?.tie ?? upg?.tieKey);\r\n    const isForgePlaceholder = tieKey && FORGE_PLACEHOLDER_TIES.has(tieKey);\r\n    const isInfusePlaceholder = tieKey && INFUSE_PLACEHOLDER_TIES.has(tieKey);\r\n\r\n    let storedStatus = rec.status || 'locked';\r\n\r\n    if (isUpgradePermanentlyUnlocked(areaKey, upg, slot)) {\r\n      storedStatus = 'unlocked';\r\n    } else if (\r\n      isUpgradePermanentlyMysterious(areaKey, upg, slot) &&\r\n      storedStatus === 'locked'\r\n    ) {\r\n      let xpReached31 = false;\r\n      try { xpReached31 = levelBigNumToNumber(currentXpLevelBigNum()) >= 31; } catch {}\r\n      let xpReached101 = false;\r\n      try { xpReached101 = levelBigNumToNumber(currentXpLevelBigNum()) >= 101; } catch {}\r\n\r\n      if (isForgePlaceholder && !xpReached31) {\r\n        storedStatus = 'locked';\r\n      } else if (isInfusePlaceholder && !xpReached101) {\r\n        storedStatus = 'locked';\r\n      } else {\r\n        storedStatus = 'mysterious';\r\n      }\r\n    }\r\n\r\n    let storedRank = shopStatusRank(storedStatus);\r\n\r\n    let currentStatus = classifyUpgradeStatus(state);\r\n    let currentRank = shopStatusRank(currentStatus);\r\n\r\n    const applyStoredMysterious = () => {\r\n      state.locked = true;\r\n\r\n      const snap = rec.snapshot;\r\n      if (snap && typeof snap === 'object') {\r\n        state = mergeLockStates(state, snap);\r\n      }\r\n\r\n      state.iconOverride  = MYSTERIOUS_UPGRADE_ICON_DATA_URL;\r\n      state.titleOverride = HIDDEN_UPGRADE_TITLE;\r\n\r\n      const reasonText =\r\n        upg?.revealRequirement ||\r\n        state.reason ||\r\n        state.descOverride ||\r\n        'This upgrade is currently hidden.';\r\n      state.descOverride = reasonText;\r\n      if (!state.reason && upg?.revealRequirement) state.reason = upg.revealRequirement;\r\n\r\n      state.hidden      = true;\r\n      state.hideCost    = true;\r\n      state.hideEffect  = true;\r\n      state.useLockedBase = true;\r\n    };\r\n\r\n    if (storedRank > currentRank) {\r\n      if (storedStatus === 'unlocked') {\r\n        state.locked = false;\r\n        state.hidden = false;\r\n        state.hideCost = false;\r\n        state.hideEffect = false;\r\n        state.useLockedBase = false;\r\n      } else if (storedStatus === 'mysterious') {\r\n        applyStoredMysterious();\r\n      }\r\n      currentStatus = classifyUpgradeStatus(state);\r\n      currentRank = shopStatusRank(currentStatus);\r\n    }\r\n\r\n    let shouldSave = false;\r\n    let normalizedStatus = (rec && typeof rec === 'object' && typeof rec.status === 'string')\r\n      ? rec.status\r\n      : 'locked';\r\n\r\n    const isForgePlaceholderForSave = isForgePlaceholder;\r\n\r\n    let xpReached31Now = false;\r\n    try { xpReached31Now = levelBigNumToNumber(currentXpLevelBigNum()) >= 31; } catch {}\r\n    let xpReached101Now = false;\r\n    try { xpReached101Now = levelBigNumToNumber(currentXpLevelBigNum()) >= 101; } catch {}\r\n\r\n    if (isForgePlaceholderForSave && !xpReached31Now && normalizedStatus === 'mysterious') {\r\n      normalizedStatus = 'locked';\r\n    } else if (isInfusePlaceholder && !xpReached101Now && normalizedStatus === 'mysterious') {\r\n      normalizedStatus = 'locked';\r\n    }\r\n\r\n    if (!rec || typeof rec !== 'object' || Object.keys(rec).length !== 1 || rec.status !== normalizedStatus) {\r\n      revealState.upgrades[revealKey] = { status: normalizedStatus };\r\n      shouldSave = true;\r\n    }\r\n\r\n    if (currentRank > storedRank) {\r\n      rec.status = currentStatus;\r\n      revealState.upgrades[revealKey] = { status: rec.status };\r\n      shouldSave = true;\r\n\r\n      storedStatus = currentStatus;\r\n      storedRank   = currentRank;\r\n\r\n      if (currentStatus === 'unlocked') {\r\n        markUpgradePermanentlyUnlocked(areaKey, upg, slot);\r\n      } else if (currentStatus === 'mysterious') {\r\n        let xpReached31 = false;\r\n        try { xpReached31 = levelBigNumToNumber(currentXpLevelBigNum()) >= 31; } catch {}\r\n\r\n        if (!isForgePlaceholder || xpReached31) {\r\n          markUpgradePermanentlyMysterious(areaKey, upg, slot);\r\n        }\r\n      }\r\n    }\r\n\r\n    if (storedStatus === 'unlocked') {\r\n      state.locked = false;\r\n      state.hidden = false;\r\n      state.hideCost = false;\r\n      state.hideEffect = false;\r\n      state.useLockedBase = false;\r\n\r\n      if (state.iconOverride === LOCKED_UPGRADE_ICON_DATA_URL ||\r\n          state.iconOverride === MYSTERIOUS_UPGRADE_ICON_DATA_URL) {\r\n        delete state.iconOverride;\r\n      }\r\n      if (state.titleOverride === HIDDEN_UPGRADE_TITLE ||\r\n          state.titleOverride === LOCKED_UPGRADE_TITLE) {\r\n        delete state.titleOverride;\r\n      }\r\n      delete state.descOverride;\r\n      delete state.reason;\r\n\r\n      if (rec.status !== 'unlocked') {\r\n        revealState.upgrades[revealKey] = { status: 'unlocked' };\r\n        shouldSave = true;\r\n      }\r\n      markUpgradePermanentlyUnlocked(areaKey, upg, slot);\r\n\r\n    } else if (storedStatus === 'mysterious' && currentStatus !== 'mysterious') {\r\n      applyStoredMysterious();\r\n      currentStatus = classifyUpgradeStatus(state);\r\n      currentRank = shopStatusRank(currentStatus);\r\n    }\r\n\r\n    if (shouldSave) saveShopRevealState(revealState, slot);\r\n  }\r\n  \r\n  return state;\r\n}\r\n\r\nfunction isUpgradeLocked(areaKey, upg) {\r\n  return !!computeUpgradeLockStateFor(areaKey, upg).locked;\r\n}\r\n\r\nfunction isHmReadyToEvolve(upg, lvlBn, evolutions = null) {\r\n  if (!upg || upg.upgType !== 'HM') return false;\r\n\r\n  // Once an HM upgrade reaches BN Infinity, treat it as permanently maxed\r\n  // and suppress further evolutions so the UI can show the maxed frame.\r\n  if (lvlBn?.isInfinite?.()) return false;\r\n  const safeEvol = Number.isFinite(evolutions)\r\n    ? evolutions\r\n    : activeEvolutionsForUpgrade(upg);\r\n  const { capBn, cap } = hmLevelCapForEvolutions(safeEvol);\r\n  try { return lvlBn?.cmp?.(capBn) >= 0; }\r\n  catch {}\r\n  const lvlNum = levelBigNumToNumber(lvlBn);\r\n  return Number.isFinite(lvlNum) && lvlNum >= cap;\r\n}\r\n\r\nexport function getLevel(areaKey, upgId) {\r\n  const state = ensureUpgradeState(areaKey, upgId);\r\n  if (state.lvlBn?.clone) return state.lvlBn.clone();\r\n  return ensureLevelBigNum(state.lvl ?? 0);\r\n}\r\n\r\nexport function peekNextPrice(areaKey, upgId) {\r\n  const state = ensureUpgradeState(areaKey, upgId);\r\n  const upg = state.upg;\r\n  if (!upg) return BigNum.fromInt(0);\r\n\r\n  if (state.nextCostBn && !state.nextCostBn.isZero?.()) {\r\n    return state.nextCostBn.clone?.() ?? BigNum.fromAny(state.nextCostBn);\r\n  }\r\n\r\n  const lvlBn  = state.lvlBn ?? ensureLevelBigNum(state.lvl ?? 0);\r\n  const currentNum = levelBigNumToNumber(lvlBn);\r\n  try {\r\n    return BigNum.fromAny(upg.costAtLevel(currentNum));\r\n  } catch {\r\n    return BigNum.fromInt(0);\r\n  }\r\n}\r\n\r\n\r\nexport function setLevel(areaKey, upgId, lvl, clampToCap = true, options = {}) {\r\n  const state = ensureUpgradeState(areaKey, upgId);\r\n  const upg = state.upg;\r\n  const { resetHmEvolutions = false } = options ?? {};\r\n\r\n  if (resetHmEvolutions && upg?.upgType === 'HM') {\r\n    state.hmEvolutions = 0;\r\n    applyHmEvolutionMeta(upg, 0);\r\n  }\r\n  const cap = upg?.lvlCap ?? Infinity;\r\n  const prevLevelNum = state.lvl;\r\n  const prevLevelBn = safeCloneBigNum(state.lvlBn ?? ensureLevelBigNum(state.lvl ?? 0));\r\n  let desiredBn = ensureLevelBigNum(lvl);\r\n  if (desiredBn.isInfinite?.()) {\r\n    desiredBn = BigNum.fromAny('Infinity');\r\n  }\r\n   let nextBn = desiredBn;\r\n  try {\r\n    if (upg && isInfinityLevelForScaled(upg, nextBn)) {\r\n      nextBn = BigNum.fromAny('Infinity');\r\n    }\r\n  } catch {}\r\n  if (clampToCap && Number.isFinite(cap)) {\r\n    const capBn = ensureLevelBigNum(cap);\r\n    if (nextBn.cmp(capBn) > 0) nextBn = capBn;\r\n  }\r\n  if (clampToCap && Number.isFinite(cap)) {\r\n    const capBn = ensureLevelBigNum(cap);\r\n    if (nextBn.cmp(capBn) > 0) nextBn = capBn;\r\n  }\r\n\r\n  if (state.lvlBn?.cmp && state.lvlBn.cmp(nextBn) === 0) return state.lvl;\r\n  const nextNum = levelBigNumToNumber(nextBn);\r\n\r\n  if (!upg) {\r\n    state.lvl = nextNum;\r\n    state.lvlBn = nextBn;\r\n    state.nextCostBn = BigNum.fromInt(0);\r\n    commitUpgradeState(state);\r\n    invalidateUpgradeState(areaKey, upgId);\r\n    notifyChanged();\r\n    return state.lvl;\r\n  }\r\n\r\n  state.lvl = nextNum;\r\n  state.lvlBn = nextBn;\r\n  try {\r\n    state.nextCostBn = BigNum.fromAny(upg.costAtLevel(nextNum));\r\n  } catch {\r\n    state.nextCostBn = BigNum.fromInt(0);\r\n  }\r\n\r\n  commitUpgradeState(state, { deferSave: options?.deferSave });\r\n  invalidateUpgradeState(areaKey, upgId);\r\n  emitUpgradeLevelChange(upg, prevLevelNum, prevLevelBn, state.lvl, state.lvlBn);\r\n  notifyChanged();\r\n  return state.lvl;\r\n}\r\n\r\n/* ---------------------------- Registry helpers ---------------------------- */\r\n\r\nexport function getUpgradesForArea(areaKey) {\r\n  return REGISTRY.filter(u => u.area === areaKey);\r\n}\r\n\r\nexport function getUpgrade(areaKey, upgId) {\r\n  const normalizedArea = normalizeAreaKey(areaKey);\r\n  const normalizedId = normalizeUpgradeId(upgId);\r\n  const tieKey = (typeof normalizedId === 'string')\r\n    ? normalizeUpgradeTie(normalizedId)\r\n    : normalizeUpgradeTie(upgId);\r\n  return REGISTRY.find((u) => {\r\n    if (normalizedArea && normalizeAreaKey(u.area) !== normalizedArea) return false;\r\n    if (normalizeUpgradeId(u.id) === normalizedId) return true;\r\n    if (tieKey && u.tieKey === tieKey) return true;\r\n    return false;\r\n  }) || null;\r\n}\r\n\r\nexport function getUpgradeLockState(areaKey, upgId) {\r\n  const upg = typeof upgId === 'object' && upgId ? upgId : getUpgrade(areaKey, upgId);\r\n  return computeUpgradeLockStateFor(areaKey, upg);\r\n}\r\n\r\nexport function normalizeUpgradeIconPath(iconPath) {\r\n  const raw = String(iconPath ?? '').trim();\r\n  if (!raw) return '';\r\n\r\n  if (/^(?:https?:|data:|blob:)/i.test(raw)) return raw;\r\n  if (raw.startsWith('//')) return raw;\r\n\r\n  const replaceSlashes = (value) => value.replace(/\\\\+/g, '/');\r\n  let path = replaceSlashes(raw);\r\n\r\n  if (path.startsWith('/')) {\r\n    return path.replace(/\\/{2,}/g, '/');\r\n  }\r\n\r\n  path = path.replace(/^\\.\\/+/u, '');\r\n  while (path.startsWith('../')) {\r\n    path = path.slice(3);\r\n  }\r\n\r\n  const segments = path\r\n    .split('/')\r\n    .map(seg => seg.trim())\r\n    .filter(seg => seg && seg !== '.');\r\n\r\n  if (!segments.length) return '';\r\n\r\n  const normalized = [];\r\n  for (const segment of segments) {\r\n    if (segment === '..') {\r\n      normalized.pop();\r\n      continue;\r\n    }\r\n    normalized.push(segment);\r\n  }\r\n\r\n  if (!normalized.length) return '';\r\n\r\n  const SHARED_ROOTS = new Set(['stats', 'currencies', 'misc']);\r\n\r\n  for (let i = 0; i < normalized.length; i += 1) {\r\n    const lower = normalized[i].toLowerCase();\r\n    if (lower === 'img') {\r\n      normalized.splice(i, 1);\r\n      i -= 1;\r\n      continue;\r\n    }\r\n\r\n    if (lower === 'sc_upgrade_icons' || lower === 'sc_upg_icons') {\r\n      normalized[i] = 'sc_upg_icons';\r\n      while (normalized[i + 1] && /^(?:sc_upgrade_icons|sc_upg_icons)$/i.test(normalized[i + 1])) {\r\n        normalized.splice(i + 1, 1);\r\n      }\r\n    }\r\n  }\r\n\r\n  if (!normalized.length) return '';\r\n\r\n  if (\r\n    normalized.length > 1\r\n    && normalized[0].toLowerCase() === 'sc_upg_icons'\r\n    && SHARED_ROOTS.has(normalized[1].toLowerCase())\r\n  ) {\r\n    normalized.shift();\r\n  }\r\n\r\n  if (normalized.length === 1) {\r\n    normalized.unshift('sc_upg_icons');\r\n  }\r\n\r\n  const result = normalized.join('/');\r\n  if (!result) return '';\r\n\r\n  return `img/${result}`;\r\n}\r\n\r\nexport function getIconUrl(upg) {\r\n  if (!upg) return '';\r\n  return normalizeUpgradeIconPath(upg.icon);\r\n}\r\n\r\n/* ------------------------------ Cost helpers ------------------------------ */\r\n\r\nfunction sumNextNLevelsCost(upg, currentLevel, n) {\r\n  let total = 0;\r\n  for (let i = 0; i < n; i++) {\r\n    total += upg.costAtLevel(currentLevel + i);\r\n  }\r\n  return total;\r\n}\r\n\r\nexport function costToBuyOne(areaKey, upgId) {\r\n  const upg = getUpgrade(areaKey, upgId);\r\n  const lvlBn = getLevel(areaKey, upgId);\r\n  const lvl = levelBigNumToNumber(lvlBn);\r\n  if (!upg) return 0;\r\n  if (lvl >= upg.lvlCap) return 0;\r\n  return upg.costAtLevel(lvl);\r\n}\r\n\r\nexport function buyOne(areaKey, upgId) {\r\n  const state = ensureUpgradeState(areaKey, upgId);\r\n  const upg = state.upg;\r\n  if (!upg) return { bought: 0, spent: 0 };\r\n\r\n  if (isUpgradeLocked(areaKey, upg)) {\r\n    return { bought: 0, spent: 0 };\r\n  }\r\n\r\n  const lvlNum = state.lvl;\r\n  const lvlBn = state.lvlBn ?? ensureLevelBigNum(lvlNum);\r\n  const prevLevelBn = safeCloneBigNum(lvlBn);\r\n\r\n  if (lvlNum >= upg.lvlCap) return { bought: 0, spent: 0 };\r\n\r\n  if (isInfinityLevelForScaled(upg, lvlBn)) {\r\n    state.lvlBn = BigNum.fromAny('Infinity');\r\n    state.lvl = levelBigNumToNumber(state.lvlBn);\r\n    state.nextCostBn = BigNum.fromAny('Infinity');\r\n    commitUpgradeState(state);\r\n    invalidateUpgradeState(areaKey, upgId);\r\n    notifyChanged();\r\n    return { bought: 0, spent: 0 };\r\n  }\r\n\r\n  const rawPrice = state.nextCostBn ?? BigNum.fromAny(upg.costAtLevel(lvlNum));\r\n  const priceBn = rawPrice instanceof BigNum\r\n    ? rawPrice\r\n    : BigNum.fromAny(rawPrice ?? 0);\r\n\r\n  const costType = upg.costType;\r\n  const walletEntry = costType ? bank[costType] : null;\r\n\r\n  let spent = BigNum.fromInt(0);\r\n\r\n  if (walletEntry && !priceBn.isZero?.()) {\r\n    const haveRaw = walletEntry.value;\r\n    const have = haveRaw instanceof BigNum\r\n      ? haveRaw\r\n      : BigNum.fromAny(haveRaw ?? 0);\r\n\r\n    if (have.cmp(priceBn) < 0) {\r\n      return { bought: 0, spent: 0 };\r\n    }\r\n\r\n    spent = priceBn.clone?.() ?? BigNum.fromAny(priceBn);\r\n    walletEntry.sub(spent);\r\n  } else {\r\n    if (!priceBn.isZero?.()) {\r\n      return { bought: 0, spent: 0 };\r\n    }\r\n    spent = BigNum.fromInt(0);\r\n  }\r\n\r\n  const nextLevelBn = lvlBn.add(BigNum.fromInt(1));\r\n  state.lvlBn = nextLevelBn;\r\n  state.lvl = levelBigNumToNumber(nextLevelBn);\r\n  state.nextCostBn = BigNum.fromAny(\r\n    typeof upg.nextCostAfter === 'function'\r\n      ? upg.nextCostAfter(spent, state.lvl)\r\n      : upg.costAtLevel(state.lvl)\r\n  );\r\n\r\n  commitUpgradeState(state);\r\n  invalidateUpgradeState(areaKey, upgId);\r\n  emitUpgradeLevelChange(upg, lvlNum, prevLevelBn, state.lvl, state.lvlBn);\r\n  notifyChanged();\r\n\r\n  return { bought: 1, spent };\r\n}\r\n\r\nexport function evolveUpgrade(areaKey, upgId) {\r\n  const state = ensureUpgradeState(areaKey, upgId);\r\n  const upg = state.upg;\r\n  if (!upg || upg.upgType !== 'HM') return { evolved: false };\r\n\r\n  const lvlBn = state.lvlBn ?? ensureLevelBigNum(state.lvl);\r\n  if (!isHmReadyToEvolve(upg, lvlBn, state.hmEvolutions)) {\r\n    return { evolved: false };\r\n  }\r\n\r\n  const nextEvol = normalizeHmEvolutionCount(state.hmEvolutions) + 1;\r\n  state.hmEvolutions = nextEvol;\r\n  applyHmEvolutionMeta(upg, nextEvol);\r\n\r\n  try { state.nextCostBn = BigNum.fromAny(upg.costAtLevel(state.lvl)); }\r\n  catch { state.nextCostBn = BigNum.fromAny('Infinity'); }\r\n\r\n  commitUpgradeState(state);\r\n  invalidateUpgradeState(areaKey, upgId);\r\n  emitUpgradeLevelChange(upg, state.lvl, lvlBn, state.lvl, lvlBn);\r\n  notifyChanged();\r\n\r\n  return { evolved: true };\r\n}\r\n\r\nexport function buyMax(areaKey, upgId) {\r\n  const state = ensureUpgradeState(areaKey, upgId);\r\n  const upg = state.upg;\r\n  if (!upg) return { bought: 0, spent: BigNum.fromInt(0) };\r\n\r\n  if (isUpgradeLocked(areaKey, upg)) {\r\n    return { bought: BigNum.fromInt(0), spent: BigNum.fromInt(0) };\r\n  }\r\n\r\n  const lvlNum = state.lvl;\r\n  const lvlBn = state.lvlBn ?? ensureLevelBigNum(lvlNum);\r\n  const cap = Number.isFinite(upg.lvlCap)\r\n    ? Math.max(0, Math.floor(upg.lvlCap))\r\n    : Infinity;\r\n  if (Number.isFinite(cap) && lvlNum >= cap) return { bought: 0, spent: BigNum.fromInt(0) };\r\n\r\n  const walletHandle = bank[upg.costType];\r\n  const walletValue = walletHandle?.value;\r\n  const wallet = walletValue instanceof BigNum\r\n    ? walletValue.clone?.() ?? BigNum.fromAny(walletValue)\r\n    : BigNum.fromAny(walletValue ?? 0);\r\n\r\n  if (upg.unlockUpgrade) {\r\n    const nextCost = state.nextCostBn?.clone?.() ?? BigNum.fromInt(0);\r\n    if (nextCost.isZero?.()) {\r\n      return buyOne(areaKey, upgId);\r\n    }\r\n  }\r\n\r\n  if (wallet.isZero?.()) return { bought: BigNum.fromInt(0), spent: BigNum.fromInt(0) };\r\n\r\n  if (wallet.isInfinite?.()) {\r\n    const prevLevel = lvlBn.clone?.() ?? ensureLevelBigNum(lvlBn);\r\n    const prevLevelNum = levelBigNumToNumber(prevLevel);\r\n    const prevLevelStorage = prevLevel.toStorage?.();\r\n    let targetLevelBn;\r\n\r\n    if (upg.upgType === 'HM') {\r\n      targetLevelBn = BigNum.fromAny('Infinity');\r\n\r\n      if (!upg.lvlCapBn?.isInfinite?.()) {\r\n        const infCap = BigNum.fromAny('Infinity');\r\n        upg.lvlCapBn = infCap;\r\n        upg.lvlCap = Number.POSITIVE_INFINITY;\r\n        upg.lvlCapFmtHtml = formatBigNumAsHtml(infCap);\r\n        upg.lvlCapFmtText = formatBigNumAsPlain(infCap);\r\n      }\r\n    } else {\r\n      const capBn = upg.lvlCapBn?.clone?.() ?? toUpgradeBigNum(upg.lvlCap ?? Infinity, Infinity);\r\n      targetLevelBn = capBn?.clone?.() ?? capBn;\r\n    }\r\n\r\n    let purchased = targetLevelBn.sub(prevLevel);\r\n    if (purchased.isZero?.()) {\r\n      const plainDelta = plainLevelDelta(targetLevelBn, prevLevel);\r\n      if (!plainDelta.isZero?.()) {\r\n        purchased = plainDelta;\r\n      }\r\n    }\r\n    if (purchased.isZero?.()) {\r\n      const nextStorage = targetLevelBn.toStorage?.();\r\n      if (prevLevelStorage && nextStorage && prevLevelStorage !== nextStorage) {\r\n        if (targetLevelBn.isInfinite?.()) {\r\n          try { purchased = BigNum.fromAny('Infinity'); }\r\n          catch { purchased = BigNum.fromInt(1); }\r\n        } else {\r\n          purchased = BigNum.fromInt(1);\r\n        }\r\n      }\r\n    }\r\n    state.lvlBn = targetLevelBn.clone?.() ?? targetLevelBn;\r\n    if (upg.upgType === 'NM' && Number.isFinite(upg.lvlCap)) {\r\n      state.lvl = upg.lvlCap;\r\n    } else {\r\n      state.lvl = levelBigNumToNumber(state.lvlBn);\r\n    }\r\n    state.nextCostBn = BigNum.fromAny('Infinity');\r\n\r\n    bank[upg.costType].set(wallet);\r\n\r\n    commitUpgradeState(state);\r\n    invalidateUpgradeState(areaKey, upgId);\r\n    emitUpgradeLevelChange(\r\n      upg,\r\n      prevLevelNum,\r\n      prevLevel,\r\n      state.lvl,\r\n      state.lvlBn,\r\n    );\r\n    notifyChanged();\r\n\r\n    return { bought: purchased, spent: BigNum.fromInt(0) };\r\n  }\r\n\r\n  const nextCost = state.nextCostBn?.clone?.() ?? BigNum.fromAny(upg.costAtLevel(lvlNum));\r\n  if (wallet.cmp(nextCost) < 0) {\r\n    return { bought: BigNum.fromInt(0), spent: BigNum.fromInt(0) };\r\n  }\r\n\r\n  const room = Number.isFinite(cap) ? Math.max(0, cap - lvlNum) : MAX_LEVEL_DELTA;\r\n  if (!(room > 0)) {\r\n    return { bought: BigNum.fromInt(0), spent: BigNum.fromInt(0) };\r\n  }\r\n\r\n  const outcome = calculateBulkPurchase(upg, lvlBn, wallet, room);\r\n  const countBn = outcome.count instanceof BigNum\r\n    ? outcome.count\r\n    : BigNum.fromAny(outcome.count ?? 0);\r\n  if (countBn.isZero?.()) {\r\n    return { bought: BigNum.fromInt(0), spent: BigNum.fromInt(0) };\r\n  }\r\n\r\n  const spent = outcome.spent ?? BigNum.fromInt(0);\r\n  const remaining = wallet.sub(spent);\r\n  bank[upg.costType].set(remaining);\r\n\r\n  const nextLevelBn = lvlBn.add(countBn);\r\n  state.lvlBn = nextLevelBn;\r\n  state.lvl = levelBigNumToNumber(nextLevelBn);\r\n  if (outcome.nextPrice) {\r\n    state.nextCostBn = outcome.nextPrice;\r\n  } else if (Number.isFinite(state.lvl)) {\r\n    state.nextCostBn = BigNum.fromAny(upg.costAtLevel(state.lvl));\r\n  } else {\r\n    state.nextCostBn = BigNum.fromAny('Infinity');\r\n  }\r\n  commitUpgradeState(state);\r\n  invalidateUpgradeState(areaKey, upgId);\r\n  emitUpgradeLevelChange(upg, lvlNum, lvlBn, state.lvl, state.lvlBn);\r\n  notifyChanged();\r\n\r\n  return { bought: countBn, spent };\r\n}\r\n\r\nexport function buyTowards(areaKey, upgId, maxLevels) {\r\n  const state = ensureUpgradeState(areaKey, upgId);\r\n  const upg = state.upg;\r\n  if (!upg) return { bought: 0, spent: BigNum.fromInt(0) };\r\n\r\n  if (isUpgradeLocked(areaKey, upg)) {\r\n    return { bought: BigNum.fromInt(0), spent: BigNum.fromInt(0) };\r\n  }\r\n\r\n  const lvlNum = state.lvl;\r\n  const lvlBn = state.lvlBn ?? ensureLevelBigNum(lvlNum);\r\n  const cap = Number.isFinite(upg.lvlCap)\r\n    ? Math.max(0, Math.floor(upg.lvlCap))\r\n    : Infinity;\r\n  if (Number.isFinite(cap) && lvlNum >= cap) return { bought: 0, spent: BigNum.fromInt(0) };\r\n\r\n  const walletHandle = bank[upg.costType];\r\n  const walletValue = walletHandle?.value;\r\n  const wallet = walletValue instanceof BigNum\r\n    ? walletValue.clone?.() ?? BigNum.fromAny(walletValue)\r\n    : BigNum.fromAny(walletValue ?? 0);\r\n\r\n  if (wallet.isZero?.()) return { bought: BigNum.fromInt(0), spent: BigNum.fromInt(0) };\r\n\r\n  const capRoom = Number.isFinite(cap) ? Math.max(0, cap - lvlNum) : undefined;\r\n  const maxRoom = Number.isFinite(maxLevels)\r\n    ? Math.max(0, Math.floor(maxLevels))\r\n    : (maxLevels instanceof BigNum ? levelBigNumToNumber(maxLevels) : undefined);\r\n  const room = Number.isFinite(capRoom)\r\n    ? (Number.isFinite(maxRoom) ? Math.min(capRoom, maxRoom) : capRoom)\r\n    : maxRoom;\r\n\r\n  const outcome = calculateBulkPurchase(upg, lvlBn, wallet, room);\r\n  const countBn = outcome.count instanceof BigNum\r\n    ? outcome.count\r\n    : BigNum.fromAny(outcome.count ?? 0);\r\n  if (countBn.isZero?.()) {\r\n    return { bought: BigNum.fromInt(0), spent: BigNum.fromInt(0) };\r\n  }\r\n\r\n  const spent = outcome.spent ?? BigNum.fromInt(0);\r\n  const remaining = wallet.sub(spent);\r\n  bank[upg.costType].set(remaining);\r\n\r\n  const nextLevelBn = lvlBn.add(countBn);\r\n  state.lvlBn = nextLevelBn;\r\n  state.lvl = levelBigNumToNumber(nextLevelBn);\r\n  if (outcome.nextPrice) {\r\n    state.nextCostBn = outcome.nextPrice;\r\n  } else if (Number.isFinite(state.lvl)) {\r\n    state.nextCostBn = BigNum.fromAny(upg.costAtLevel(state.lvl));\r\n  } else {\r\n    state.nextCostBn = BigNum.fromAny('Infinity');\r\n  }\r\n  commitUpgradeState(state);\r\n  invalidateUpgradeState(areaKey, upgId);\r\n  emitUpgradeLevelChange(upg, lvlNum, lvlBn, state.lvl, state.lvlBn);\r\n  notifyChanged();\r\n\r\n  return { bought: countBn, spent };\r\n}\r\n\r\nexport function evaluateBulkPurchase(upg, startLevel, walletBn, maxLevels = MAX_LEVEL_DELTA, options = {}) {\r\n  const wallet = walletBn instanceof BigNum ? walletBn : BigNum.fromAny(walletBn ?? 0);\r\n  const outcome = calculateBulkPurchase(upg, startLevel, wallet, maxLevels, options);\r\n  return {\r\n    count: outcome.count,\r\n    spent: outcome.spent ?? BigNum.fromInt(0),\r\n    nextPrice: outcome.nextPrice ?? BigNum.fromInt(0),\r\n    numericCount: outcome.numericCount ?? 0,\r\n  };\r\n}\r\n\r\n/* ------------------------------ Effects wiring ---------------------------- */\r\n\r\nfunction notifyChanged() {\r\n  if (isBatching) {\r\n    pendingNotify = true;\r\n    invalidateEffectsCache();\r\n    return;\r\n  }\r\n  invalidateEffectsCache();\r\n  triggerUpgradesChanged();\r\n}\r\n\r\n/* ----------------------- Area detection (DOM mapping) ---------------------- */\r\n\r\nexport function getCurrentAreaKey() {\r\n  const gameRoot = document.getElementById('game-root');\r\n  if (gameRoot?.classList?.contains('area-cove')) return AREA_KEYS.STARTER_COVE;\r\n  return AREA_KEYS.STARTER_COVE;\r\n}\r\n\r\n/* ------------------------------ UI helpers -------------------------------- */\r\n\r\nexport function upgradeUiModel(areaKey, upgId) {\r\n  const upg = getUpgrade(areaKey, upgId);\r\n  if (!upg) return null;\r\n  const lvlBn = getLevel(areaKey, upgId);\r\n  const lvl = levelBigNumToNumber(lvlBn);\r\n  const lvlFmtHtml = formatBigNumAsHtml(lvlBn);\r\n  const lvlFmtText = formatBigNumAsPlain(lvlBn);\r\n  const lvlCapBn = upg.lvlCapBn ?? toUpgradeBigNum(upg.lvlCap ?? Infinity, Infinity);\r\n  const lvlCapFmtHtml = upg.lvlCapFmtHtml ?? formatBigNumAsHtml(lvlCapBn);\r\n  const lvlCapFmtText = upg.lvlCapFmtText ?? formatBigNumAsPlain(lvlCapBn);\r\n  const nextPrice = lvl < upg.lvlCap ? peekNextPrice(areaKey, upgId) : BigNum.fromInt(0);\r\n  const nextPriceFmt = formatBigNumAsHtml(nextPrice);\r\n  const haveRaw = bank[upg.costType]?.value;\r\n  const have = haveRaw instanceof BigNum\r\n    ? haveRaw\r\n    : BigNum.fromAny(haveRaw ?? 0);\r\n  const lockState = getUpgradeLockState(areaKey, upgId);\r\n  const locked = !!lockState.locked;\r\n  const displayTitle = lockState.titleOverride ?? upg.title;\r\n  let displayDesc = lockState.descOverride ?? upg.desc;\r\n\r\n  if (areaKey === AUTOMATION_AREA_KEY && normalizeUpgradeId(upgId) === EFFECTIVE_AUTO_COLLECT_ID) {\r\n    const multiplier = getEacAmountMultiplier();\r\n    if (Math.abs(multiplier - 1) > 0.0001 && displayDesc) {\r\n      const multStr = formatMultForUi(multiplier);\r\n      displayDesc = displayDesc.replace(\r\n        \"Generates the equivalent of picking up a Coin on an interval\",\r\n        \"Generates the equivalent of picking up \" + multStr + \" Coins on an interval\"\r\n      );\r\n    }\r\n  }\r\n  const hmMilestones = resolveHmMilestones(upg, areaKey);\r\n  let effect = '';\r\n  if (typeof upg.effectSummary === 'function' && !(locked && lockState.hideEffect)) {\r\n    effect = upg.effectSummary(lvl);\r\n    if (typeof effect === 'string') effect = effect.trim();\r\n  }\r\n  const iconUrl = lockState.iconOverride ?? getIconUrl(upg);\r\n  return {\r\n    upg,\r\n    lvl,\r\n    lvlBn,\r\n    lvlFmtHtml,\r\n    lvlFmtText,\r\n    lvlCapBn,\r\n    lvlCapFmtHtml,\r\n    lvlCapFmtText,\r\n    nextPrice,\r\n    nextPriceFmt,\r\n    have,\r\n    haveFmt: bank[upg.costType]?.fmt(have) ?? String(have),\r\n    effect,\r\n    iconUrl,\r\n    lockState,\r\n    locked,\r\n    areaKey,\r\n    hmMilestones,\r\n    displayTitle,\r\n    displayDesc,\r\n    unlockUpgrade: !!upg.unlockUpgrade,\r\n    hmEvolutions: upg.upgType === 'HM' ? getHmEvolutions(areaKey, upgId) : 0,\r\n    hmReadyToEvolve: upg.upgType === 'HM' ? isHmReadyToEvolve(upg, lvlBn, getHmEvolutions(areaKey, upgId)) : false,\r\n    hmNextMilestone: upg.upgType === 'HM' ? hmNextMilestoneLevel(upg, lvlBn, areaKey) : null,\r\n  };\r\n}\r\n\r\nexport function getHmNextMilestoneLevel(areaKey, upgId) {\r\n  const upg = getUpgrade(areaKey, upgId);\r\n  if (!upg || upg.upgType !== 'HM') return null;\r\n  const lvlBn = getLevel(areaKey, upgId);\r\n  return hmNextMilestoneLevel(upg, lvlBn, areaKey);\r\n}\r\n\r\nexport function normalizeBigNum(value) {\r\n  return bigNumFromLog10(approxLog10BigNum(value ?? 0));\r\n}\r\n\r\nexport function performFreeAutobuy(areaKey, upgId) {\r\n  const state = ensureUpgradeState(areaKey, upgId);\r\n  const upg = state.upg;\r\n  if (!upg) return { bought: 0 };\r\n\r\n  const storageKey = keyForArea(areaKey, state.slot);\r\n  if (isStorageKeyLocked(storageKey)) return { bought: 0 };\r\n\r\n  const upgradeKey = getUpgradeStorageKey(areaKey, upgId, state.slot);\r\n  if (isStorageKeyLocked(upgradeKey)) return { bought: 0 };\r\n\r\n  if (isUpgradeLocked(areaKey, upg)) return { bought: 0 };\r\n\r\n  const lvlNum = state.lvl;\r\n  const lvlBn = state.lvlBn ?? ensureLevelBigNum(lvlNum);\r\n  const cap = Number.isFinite(upg.lvlCap)\r\n    ? Math.max(0, Math.floor(upg.lvlCap))\r\n    : Infinity;\r\n  if (Number.isFinite(cap) && lvlNum >= cap) return { bought: 0 };\r\n\r\n  if (upg.upgType === 'HM' && isHmReadyToEvolve(upg, lvlBn, state.hmEvolutions)) {\r\n    return { bought: 0 };\r\n  }\r\n\r\n  const walletHandle = bank[upg.costType];\r\n  const walletValue = walletHandle?.value;\r\n  const wallet = walletValue instanceof BigNum\r\n    ? walletValue.clone?.() ?? BigNum.fromAny(walletValue)\r\n    : BigNum.fromAny(walletValue ?? 0);\r\n\r\n  if (wallet.isZero?.()) return { bought: 0 };\r\n\r\n  const outcome = calculateBulkPurchase(upg, lvlBn, wallet, MAX_LEVEL_DELTA);\r\n  const countBn = outcome.count instanceof BigNum\r\n    ? outcome.count\r\n    : BigNum.fromAny(outcome.count ?? 0);\r\n  if (countBn.isZero?.()) return { bought: 0 };\r\n\r\n  // Set the new level without deducting currency\r\n  const nextLevelBn = lvlBn.add(countBn);\r\n  initDeferredFlush();\r\n  setLevel(areaKey, upgId, nextLevelBn, true, { deferSave: true });\r\n\r\n  return { bought: countBn };\r\n}\r\n\r\nregisterXpUpgradeEffects();\r\n\r\nexport function buyCheap(areaKey, upgId) {\r\n  const state = ensureUpgradeState(areaKey, upgId);\r\n  const upg = state.upg;\r\n  if (!upg) return { bought: 0, spent: BigNum.fromInt(0) };\r\n  if (isUpgradeLocked(areaKey, upg)) return { bought: 0, spent: BigNum.fromInt(0) };\r\n\r\n  const lvlBn = state.lvlBn ?? ensureLevelBigNum(state.lvl);\r\n  const startLvl = levelBigNumToNumber(lvlBn);\r\n  const cap = Number.isFinite(upg.lvlCap) ? upg.lvlCap : Infinity;\r\n  \r\n  if (Number.isFinite(cap) && startLvl >= cap) return { bought: 0, spent: BigNum.fromInt(0) };\r\n\r\n  const walletHandle = bank[upg.costType];\r\n  const wallet = walletHandle?.value instanceof BigNum ? walletHandle.value.clone() : BigNum.fromAny(walletHandle?.value ?? 0);\r\n  if (wallet.isZero()) return { bought: 0, spent: BigNum.fromInt(0) };\r\n\r\n  // 1. Calculate Max possible purchase (Budget: Wallet)\r\n  // Use evaluateBulkPurchase to get the max count N\r\n  const maxEval = evaluateBulkPurchase(upg, lvlBn, wallet, BigNum.fromAny('Infinity'));\r\n  let n = maxEval.numericCount; \r\n  \r\n  if (n <= 0) return { bought: 0, spent: BigNum.fromInt(0) };\r\n  \r\n  // 2. Find optimal k <= n\r\n  // Condition for k: \r\n  //   Last bought level (k-1) cost <= 0.1 * Remaining Wallet (after buying k-1)\r\n  \r\n  // Helper to check k (k is number of levels to buy)\r\n  const check = (k) => {\r\n      if (k <= 0) return true; \r\n      \r\n      // Calculate Remainder after buying k-1 levels\r\n      // Cost of buying 0..k-2 (total k-1 levels)\r\n      const costOfPrev = totalCostBigNum(upg, startLvl, k - 1);\r\n      const walletRem = wallet.sub(costOfPrev);\r\n      \r\n      // Cost of the k-th level (index startLvl + k - 1)\r\n      const nextLevel = startLvl + k - 1;\r\n      // Optimization: if scaling is simple/constant, could compute directly, but costAtLevel is safe.\r\n      const costOfNext = BigNum.fromAny(upg.costAtLevel(nextLevel));\r\n      \r\n      const threshold = walletRem.div(10);\r\n      return costOfNext.cmp(threshold) <= 0;\r\n  };\r\n  \r\n  let bestK = 0;\r\n  \r\n  if (n < 2000) {\r\n      // Linear scan backwards\r\n      // We can incrementally update spent to be faster than calling totalCostBigNum repeatedly\r\n      \r\n      let currentSpent = maxEval.spent;\r\n      let currentK = n;\r\n      \r\n      while (currentK > 0) {\r\n          // Level index of the last one bought\r\n          const lastLvlIdx = startLvl + currentK - 1;\r\n          const lastCost = BigNum.fromAny(upg.costAtLevel(lastLvlIdx));\r\n          \r\n          // Cost of K-1 levels\r\n          const prevSpent = currentSpent.sub(lastCost);\r\n          const prevRem = wallet.sub(prevSpent);\r\n          \r\n          const threshold = prevRem.div(10);\r\n          if (lastCost.cmp(threshold) <= 0) {\r\n              bestK = currentK;\r\n              break;\r\n          }\r\n          \r\n          currentSpent = prevSpent;\r\n          currentK--;\r\n      }\r\n  } else {\r\n      // Binary Search\r\n      let lo = 0, hi = n;\r\n      while (lo < hi) {\r\n          const mid = Math.ceil((lo + hi) / 2);\r\n          if (check(mid)) {\r\n              lo = mid;\r\n          } else {\r\n              hi = mid - 1;\r\n          }\r\n      }\r\n      bestK = lo;\r\n  }\r\n  \r\n  if (bestK <= 0) return { bought: 0, spent: BigNum.fromInt(0) };\r\n  \r\n  // 3. Execute Buy\r\n  return buyTowards(areaKey, upgId, bestK);\r\n}\r\n", "// js/util/debugPanel.js\r\n// Using a debug panel is much faster and more convenient than\r\n// Editing local storage every time I want to change something.\r\n\r\nimport { BigNum, bigNumFromLog10 } from './bigNum.js';\r\nimport { formatNumber, formatMultForUi } from './numFormat.js';\r\nimport {\r\n    bank,\r\n    CURRENCIES,\r\n    KEYS,\r\n    getActiveSlot,\r\n    markSaveSlotModified,\r\n    peekCurrency,\r\n    primeStorageWatcherSnapshot,\r\n    setCurrency,\r\n    setCurrencyMultiplierBN,\r\n} from './storage.js';\r\nimport { broadcastXpChange, computeCoinMultiplierForXpLevel, getXpGainMultiplier, getXpRequirementForXpLevel, getXpState, initXpSystem, resetXpProgress, unlockXpSystem } from '../game/xpSystem.js';\r\nimport { broadcastMutationChange, computeMutationMultiplierForLevel, computeMutationRequirementForLevel, getMutationMultiplier, getMutationGainMultiplier, getMutationState, initMutationSystem, setMutationUnlockedForDebug, unlockMutationSystem } from '../game/mutationSystem.js';\r\nimport { IS_MOBILE } from '../main.js';\r\nimport {\r\n    getUpgradeStorageKey,\r\n    AREA_KEYS,\r\n    computeDefaultUpgradeCost,\r\n    computeUpgradeEffects,\r\n    getLevel,\r\n    getMpValueMultiplierBn,\r\n    getUpgradesForArea,\r\n    markUpgradePermanentlyUnlocked,\r\n    clearPermanentUpgradeUnlock,\r\n    setLevel,\r\n    getUpgradeLockState,\r\n    batchUpgradeOperations,\r\n} from '../game/upgrades.js';\r\nimport { isMapUnlocked, isShopUnlocked, lockMap, lockShop, unlockMap, unlockShop } from '../ui/hudButtons.js';\r\nimport { DLG_CATALOG, MERCHANT_DLG_STATE_KEY_BASE, isJeffUnlocked, setJeffUnlocked } from '../ui/merchantTabs/dlgTab.js';\r\nimport { getGenerationLevelKey, getGenerationUpgradeCost } from '../ui/merchantTabs/workshopTab.js';\r\nimport { getSurgeBarLevelKey, hasDoneInfuseReset } from '../ui/merchantTabs/resetTab.js';\r\nimport { getTsunamiNerf, setTsunamiNerf, getTsunamiNerfKey, getTsunamiSequenceSeen, setTsunamiSequenceSeen, getEffectiveTsunamiNerf } from '../game/surgeEffects.js';\r\nimport { setAutobuyerToggle } from '../game/automationEffects.js';\r\nimport { AUTOBUY_WORKSHOP_LEVELS_ID, AUTOMATION_AREA_KEY, MASTER_AUTOBUY_IDS } from '../game/automationUpgrades.js';\r\n\r\nimport { updateWarpTab } from '../ui/merchantTabs/warpTab.js';\r\nimport { getLabLevel, setLabLevel, getLabLevelKey, getRpMultBase } from '../ui/merchantTabs/labTab.js';\r\nimport { \r\n    RESEARCH_NODES,\r\n    getResearchNodeLevel,\r\n    setResearchNodeLevel,\r\n    getResearchNodeRp,\r\n    setResearchNodeRp,\r\n    isResearchNodeActive,\r\n    setResearchNodeActive,\r\n    getTsunamiResearchBonus,\r\n    NODE_LEVEL_KEY,\r\n    NODE_RP_KEY\r\n} from '../game/labNodes.js';\r\nimport { calculateOfflineRewards, grantOfflineRewards, showOfflinePanel, calculatePreAutomationRewards } from '../game/offlinePanel.js';\r\nconst DEBUG_PANEL_STYLE_ID = 'debug-panel-style';\r\nconst DEBUG_PANEL_ID = 'debug-panel';\r\nconst DEBUG_PANEL_TOGGLE_ID = 'debug-panel-toggle';\r\nconst DEFAULT_MISC_RESET_SELECTION = `currency:${CURRENCIES.COINS}`;\r\nlet debugPanelOpen = false;\r\nlet debugPanelAccess = false;\r\nlet debugPanelCleanups = [];\r\nlet debugPanelExpansionState = createEmptyExpansionState();\r\nlet debugPanelScrollTop = 0;\r\nlet debugPanelMiscResetSelection = DEFAULT_MISC_RESET_SELECTION;\r\nlet sectionKeyCounter = 0;\r\nlet subsectionKeyCounter = 0;\r\nconst liveBindings = [];\r\nlet actionLogContainer = null;\r\n\r\nconst currencyOverrides = new Map();\r\nconst currencyOverrideBaselines = new Map();\r\nconst currencyOverrideApplications = new Set();\r\nconst statOverrides = new Map();\r\nconst statOverrideBaselines = new Map();\r\nconst lockedStorageKeys = new Set();\r\nif (typeof window !== 'undefined') {\r\n    window.__cccLockedStorageKeys = lockedStorageKeys;\r\n}\r\nlet storageLockPatched = false;\r\nlet originalSetItem = null;\r\nlet originalRemoveItem = null;\r\n\r\nconst STAT_MULTIPLIER_STORAGE_PREFIX = 'ccc:debug:stat-mult';\r\nconst ACTION_LOG_STORAGE_PREFIX = 'ccc:actionLog';\r\nconst MAX_ACTION_LOG_ENTRIES = 100;\r\nconst WARP_CHARGES_KEY = (slot) => `ccc:warp:charges:${slot}`;\r\nconst MAX_WARPS = 24;\r\n\r\nfunction isOnMenu() {\r\n    const menuRoot = document.querySelector('.menu-root');\r\n    if (!menuRoot) return false;\r\n\r\n    const style = window.getComputedStyle?.(menuRoot);\r\n    if (!style) return menuRoot.style.display !== 'none';\r\n\r\n    return style.display !== 'none' && style.visibility !== 'hidden' && !menuRoot.hidden;\r\n}\r\n\r\nfunction isGameVisible() {\r\n    const gameRoot = document.getElementById('game-root');\r\n    if (!gameRoot) return false;\r\n\r\n    const style = window.getComputedStyle?.(gameRoot);\r\n    if (!style) {\r\n        return gameRoot.style.display !== 'none'\r\n            && gameRoot.style.visibility !== 'hidden'\r\n            && !gameRoot.hidden;\r\n    }\r\n\r\n    return style.display !== 'none' && style.visibility !== 'hidden' && !gameRoot.hidden;\r\n}\r\n\r\nfunction addDebugPanelCleanup(fn) {\r\n    if (typeof fn === 'function') {\r\n        debugPanelCleanups.push(fn);\r\n    }\r\n}\r\n\r\nfunction createEmptyExpansionState() {\r\n    return { sections: new Set(), subsections: new Set() };\r\n}\r\n\r\nfunction captureDebugPanelExpansionState() {\r\n    const panel = document.getElementById(DEBUG_PANEL_ID);\r\n    if (!panel) return createEmptyExpansionState();\r\n\r\n    const sections = new Set();\r\n    panel.querySelectorAll('.debug-panel-section-toggle').forEach((toggle) => {\r\n        const key = toggle.dataset.sectionKey ?? toggle.textContent;\r\n        if (toggle.classList.contains('expanded')) {\r\n            sections.add(key);\r\n        }\r\n    });\r\n\r\n    const subsections = new Set();\r\n    panel.querySelectorAll('.debug-panel-subsection-toggle').forEach((toggle) => {\r\n        const key = toggle.dataset.subsectionKey ?? toggle.textContent;\r\n        if (toggle.classList.contains('expanded')) {\r\n            subsections.add(key);\r\n        }\r\n    });\r\n\r\n    return { sections, subsections };\r\n}\r\n\r\nfunction applyDebugPanelExpansionState(panel) {\r\n    const { sections, subsections } = debugPanelExpansionState ?? createEmptyExpansionState();\r\n\r\n    panel.querySelectorAll('.debug-panel-section-toggle').forEach((toggle) => {\r\n        const key = toggle.dataset.sectionKey ?? toggle.textContent;\r\n        if (!sections.has(key)) return;\r\n        const content = toggle.nextElementSibling;\r\n        toggle.classList.add('expanded');\r\n        if (content) content.classList.add('active');\r\n    });\r\n\r\n    panel.querySelectorAll('.debug-panel-subsection-toggle').forEach((toggle) => {\r\n        const key = toggle.dataset.subsectionKey ?? toggle.textContent;\r\n        if (!subsections.has(key)) return;\r\n        const content = toggle.nextElementSibling;\r\n        toggle.classList.add('expanded');\r\n        if (content) content.classList.add('active');\r\n    });\r\n}\r\n\r\nfunction cleanupDebugPanelResources() {\r\n    debugPanelCleanups.forEach((fn) => {\r\n        try { fn?.(); } catch {}\r\n    });\r\n    debugPanelCleanups = [];\r\n    liveBindings.length = 0;\r\n}\r\n\r\nfunction registerLiveBinding(binding) {\r\n    if (!binding || typeof binding.refresh !== 'function') return;\r\n    liveBindings.push(binding);\r\n}\r\n\r\nfunction refreshLiveBindings(predicate) {\r\n    liveBindings.forEach((binding) => {\r\n        if (typeof predicate === 'function' && !predicate(binding)) return;\r\n        try { binding.refresh(); } catch {}\r\n    });\r\n}\r\n\r\nfunction setupLiveBindingListeners() {\r\n    if (typeof window === 'undefined') return;\r\n\r\n    const currencyHandler = (event) => {\r\n        const { key, slot } = event?.detail ?? {};\r\n        const targetSlot = slot ?? getActiveSlot();\r\n        refreshLiveBindings((binding) => binding.type === 'currency'\r\n            && binding.key === key\r\n            && binding.slot === targetSlot);\r\n    };\r\n    window.addEventListener('currency:change', currencyHandler, { passive: true });\r\n    addDebugPanelCleanup(() => window.removeEventListener('currency:change', currencyHandler));\r\n\r\n    const currencyMultiplierHandler = (event) => {\r\n        const { key, slot } = event?.detail ?? {};\r\n        const targetSlot = slot ?? getActiveSlot();\r\n        refreshLiveBindings((binding) => binding.type === 'currency-mult'\r\n            && binding.key === key\r\n            && binding.slot === targetSlot);\r\n    };\r\n    window.addEventListener('currency:multiplier', currencyMultiplierHandler, { passive: true });\r\n    addDebugPanelCleanup(() => window.removeEventListener('currency:multiplier', currencyMultiplierHandler));\r\n\r\n    const xpHandler = (event) => {\r\n        const { slot, changeType, unlocked } = event?.detail ?? {};\r\n        const targetSlot = slot ?? getActiveSlot();\r\n        refreshLiveBindings((binding) => binding.type === 'xp'\r\n            && binding.slot === targetSlot);\r\n        refreshLiveBindings((binding) => binding.type === 'stat-mult'\r\n            && binding.key === 'xp'\r\n            && binding.slot === targetSlot);\r\n        if (changeType === 'unlock' || typeof unlocked === 'boolean') {\r\n            refreshLiveBindings((binding) => binding.type === 'unlock'\r\n                && (binding.slot == null || binding.slot === targetSlot));\r\n        }\r\n    };\r\n    window.addEventListener('xp:change', xpHandler, { passive: true });\r\n    window.addEventListener('xp:unlock', xpHandler, { passive: true });\r\n    addDebugPanelCleanup(() => {\r\n        window.removeEventListener('xp:change', xpHandler);\r\n        window.removeEventListener('xp:unlock', xpHandler);\r\n    });\r\n\r\n    const mutationHandler = (event) => {\r\n        const { changeType, slot } = event?.detail ?? {};\r\n        const targetSlot = slot ?? getActiveSlot();\r\n        refreshLiveBindings((binding) => binding.type === 'mutation'\r\n            && binding.slot === targetSlot);\r\n        refreshLiveBindings((binding) => binding.type === 'stat-mult'\r\n            && binding.key === 'mutation'\r\n            && binding.slot === targetSlot);\r\n        if (changeType === 'unlock') {\r\n            refreshLiveBindings((binding) => binding.type === 'unlock'\r\n                && (binding.slot == null || binding.slot === targetSlot));\r\n        }\r\n    };\r\n    window.addEventListener('mutation:change', mutationHandler, { passive: true });\r\n    addDebugPanelCleanup(() => window.removeEventListener('mutation:change', mutationHandler));\r\n\r\n    const upgradeHandler = () => {\r\n        const targetSlot = getActiveSlot();\r\n        refreshLiveBindings((binding) => binding.type === 'upgrade'\r\n            && binding.slot === targetSlot);\r\n        refreshLiveBindings((binding) => binding.type === 'currency-mult'\r\n            && binding.slot === targetSlot);\r\n        refreshLiveBindings((binding) => binding.type === 'stat-mult'\r\n            && binding.slot === targetSlot);\r\n    };\r\n    document.addEventListener('ccc:upgrades:changed', upgradeHandler, { passive: true });\r\n    addDebugPanelCleanup(() => document.removeEventListener('ccc:upgrades:changed', upgradeHandler));\r\n\r\n    const slotHandler = () => {\r\n        const targetSlot = getActiveSlot();\r\n        refreshLiveBindings((binding) => binding.slot === targetSlot);\r\n    };\r\n    window.addEventListener('saveSlot:change', slotHandler, { passive: true });\r\n    addDebugPanelCleanup(() => window.removeEventListener('saveSlot:change', slotHandler));\r\n\r\n    const unlockHandler = (event) => {\r\n        const { slot, key } = event?.detail ?? {};\r\n        const targetSlot = slot ?? getActiveSlot();\r\n        refreshLiveBindings((binding) => binding.type === 'unlock'\r\n            && (binding.slot == null || binding.slot === targetSlot)\r\n            && (binding.key == null || binding.key === key));\r\n    };\r\n    window.addEventListener('unlock:change', unlockHandler, { passive: true });\r\n    addDebugPanelCleanup(() => window.removeEventListener('unlock:change', unlockHandler));\r\n\r\n    const workshopHandler = (event) => {\r\n        const { slot } = event?.detail ?? {};\r\n        const targetSlot = slot ?? getActiveSlot();\r\n        refreshLiveBindings((binding) => binding.type === 'workshop-level'\r\n            && binding.slot === targetSlot);\r\n    };\r\n    window.addEventListener('workshop:change', workshopHandler, { passive: true });\r\n    addDebugPanelCleanup(() => window.removeEventListener('workshop:change', workshopHandler));\r\n\r\n    const surgeHandler = (event) => {\r\n        const { slot } = event?.detail ?? {};\r\n        const targetSlot = slot ?? getActiveSlot();\r\n        refreshLiveBindings((binding) => binding.type === 'surge-level'\r\n            && binding.slot === targetSlot);\r\n    };\r\n    window.addEventListener('surge:level:change', surgeHandler, { passive: true });\r\n    addDebugPanelCleanup(() => window.removeEventListener('surge:level:change', surgeHandler));\r\n\r\n    const tsunamiHandler = (event) => {\r\n        const { slot } = event?.detail ?? {};\r\n        const targetSlot = slot ?? getActiveSlot();\r\n        refreshLiveBindings((binding) => binding.type === 'tsunami-nerf'\r\n            && (binding.slot == null || binding.slot === targetSlot));\r\n    };\r\n    window.addEventListener('surge:nerf:change', tsunamiHandler, { passive: true });\r\n    addDebugPanelCleanup(() => window.removeEventListener('surge:nerf:change', tsunamiHandler));\r\n\r\n    const labHandler = (event) => {\r\n        const { slot } = event?.detail ?? {};\r\n        const targetSlot = slot ?? getActiveSlot();\r\n        refreshLiveBindings((binding) => binding.type === 'lab-level'\r\n            && (binding.slot == null || binding.slot === targetSlot));\r\n        refreshLiveBindings((binding) => binding.type === 'stat-mult'\r\n            && binding.key === 'rp'\r\n            && (binding.slot == null || binding.slot === targetSlot));\r\n    };\r\n    window.addEventListener('lab:level:change', labHandler, { passive: true });\r\n    addDebugPanelCleanup(() => window.removeEventListener('lab:level:change', labHandler));\r\n\r\n    const labNodeHandler = (event) => {\r\n        const { id, level } = event?.detail ?? {};\r\n        const targetSlot = getActiveSlot();\r\n        refreshLiveBindings((binding) => binding.type === 'lab-node-level'\r\n            && binding.slot === targetSlot\r\n            && binding.id === id);\r\n        \r\n        if (id === 1) {\r\n            refreshLiveBindings((binding) => binding.type === 'tsunami-nerf'\r\n                && (binding.slot == null || binding.slot === targetSlot));\r\n        }\r\n        if (id === 4) {\r\n            refreshLiveBindings((binding) => binding.type === 'unlock'\r\n                && (binding.slot == null || binding.slot === targetSlot));\r\n        }\r\n    };\r\n    window.addEventListener('lab:node:change', labNodeHandler, { passive: true });\r\n    addDebugPanelCleanup(() => window.removeEventListener('lab:node:change', labNodeHandler));\r\n\r\n    const labNodeRpHandler = (event) => {\r\n        const { id, rp } = event?.detail ?? {};\r\n        const targetSlot = getActiveSlot();\r\n        refreshLiveBindings((binding) => binding.type === 'lab-node-rp'\r\n            && binding.slot === targetSlot\r\n            && binding.id === id);\r\n    };\r\n    window.addEventListener('lab:node:rp', labNodeRpHandler, { passive: true });\r\n    addDebugPanelCleanup(() => window.removeEventListener('lab:node:rp', labNodeRpHandler));\r\n}\r\n\r\nconst XP_KEY_PREFIX = 'ccc:xp';\r\nconst XP_KEYS = {\r\n    unlock: (slot) => `${XP_KEY_PREFIX}:unlocked:${slot}`,\r\n    level:  (slot) => `${XP_KEY_PREFIX}:level:${slot}`,\r\n    progress: (slot) => `${XP_KEY_PREFIX}:progress:${slot}`,\r\n};\r\n\r\nconst MUTATION_KEY_PREFIX = 'ccc:mutation';\r\nconst MUTATION_KEYS = {\r\n    unlock: (slot) => `${MUTATION_KEY_PREFIX}:unlocked:${slot}`,\r\n    level:  (slot) => `${MUTATION_KEY_PREFIX}:level:${slot}`,\r\n    progress: (slot) => `${MUTATION_KEY_PREFIX}:progress:${slot}`,\r\n};\r\n\r\nconst STAT_MULTIPLIERS = [\r\n    { key: 'spawnRate', label: 'Spawn Rate' },\r\n    { key: 'xp', label: 'XP' },\r\n    { key: 'mutation', label: 'MP' },\r\n    { key: 'rp', label: 'RP' },\r\n];\r\n\r\nfunction getAreas() {\r\n    return [\r\n        {\r\n            key: AREA_KEYS.STARTER_COVE,\r\n            title: 'The Cove',\r\n            currencies: [\r\n                { key: CURRENCIES.COINS, label: 'Coins' },\r\n                { key: CURRENCIES.BOOKS, label: 'Books' },\r\n                { key: CURRENCIES.GOLD,  label: 'Gold'  },\r\n                { key: CURRENCIES.MAGIC, label: 'Magic' },\r\n                { key: CURRENCIES.GEARS, label: 'Gears' },\r\n                { key: CURRENCIES.WAVES, label: 'Waves' },\r\n                { key: CURRENCIES.DNA,   label: 'DNA'   },\r\n            ],\r\n            stats: [\r\n                { key: 'spawnRate', label: 'Spawn Rate' },\r\n                { key: 'xp', label: 'XP' },\r\n                { key: 'mutation', label: 'MP' },\r\n            ],\r\n        },\r\n    ];\r\n}\r\n\r\n\r\nfunction ensureDebugPanelStyles() {\r\n    if (document.getElementById(DEBUG_PANEL_STYLE_ID)) return;\r\n\r\n    const existingLink = document.querySelector(`link[href$=\"css/misc/debug.css\"]`);\r\n    if (existingLink) {\r\n        existingLink.id = DEBUG_PANEL_STYLE_ID;\r\n        return;\r\n    }\r\n\r\n    const bundledStylesheet = document.querySelector('link[href$=\"styles.css\"]');\r\n    if (bundledStylesheet) {\r\n        const marker = document.createElement('meta');\r\n        marker.id = DEBUG_PANEL_STYLE_ID;\r\n        marker.setAttribute('data-debug-panel-styles', 'bundled');\r\n        document.head.appendChild(marker);\r\n        return;\r\n    }\r\n\r\n    const link = document.createElement('link');\r\n    link.rel = 'stylesheet';\r\n    link.href = 'css/misc/debug.css';\r\n    link.id = DEBUG_PANEL_STYLE_ID;\r\n    document.head.appendChild(link);\r\n}\r\n\r\nfunction removeDebugPanelToggleButton() {\r\n    const existingButton = document.getElementById(DEBUG_PANEL_TOGGLE_ID);\r\n    if (existingButton) existingButton.remove();\r\n}\r\n\r\nfunction shouldShowDebugPanelToggleButton() {\r\n    return debugPanelAccess\r\n        && IS_MOBILE\r\n        && getActiveSlot() != null\r\n        && !isOnMenu()\r\n        && isGameVisible();\r\n}\r\n\r\nfunction onMenuVisibilityChange(event) {\r\n    if (event?.detail?.visible) {\r\n        closeDebugPanel();\r\n    }\r\n    createDebugPanelToggleButton();\r\n}\r\n\r\nfunction createSection(title, contentId, contentBuilder) {\r\n    const section = document.createElement('div');\r\n    section.className = 'debug-panel-section';\r\n\r\n    const toggle = document.createElement('button');\r\n    toggle.className = 'debug-panel-section-toggle';\r\n    toggle.type = 'button';\r\n    toggle.textContent = title;\r\n    const stateKey = contentId || `${title}-${sectionKeyCounter++}`;\r\n    toggle.dataset.sectionKey = stateKey;\r\n    section.appendChild(toggle);\r\n\r\n    const content = document.createElement('div');\r\n    content.className = 'debug-panel-section-content';\r\n    content.id = contentId;\r\n    content.dataset.sectionKey = stateKey;\r\n    contentBuilder(content);\r\n    section.appendChild(content);\r\n\r\n    let lastPointerType = null;\r\n\r\n    const handleToggle = (event) => {\r\n        const expanded = toggle.classList.toggle('expanded');\r\n        content.classList.toggle('active', expanded);\r\n    };\r\n\r\n    toggle.addEventListener('click', (event) => {\r\n        if (lastPointerType && lastPointerType !== 'mouse') {\r\n            lastPointerType = null;\r\n            return;\r\n        }\r\n        lastPointerType = null;\r\n        handleToggle(event);\r\n    });\r\n\r\n    return section;\r\n}\r\n\r\nfunction createSubsection(title, contentBuilder, { defaultExpanded = false } = {}) {\r\n    const container = document.createElement('div');\r\n    container.className = 'debug-panel-subsection';\r\n\r\n    const toggle = document.createElement('button');\r\n    toggle.type = 'button';\r\n    toggle.className = 'debug-panel-subsection-toggle';\r\n    toggle.textContent = title;\r\n    const stateKey = `${title}-${subsectionKeyCounter++}`;\r\n    toggle.dataset.subsectionKey = stateKey;\r\n    container.appendChild(toggle);\r\n\r\n    const content = document.createElement('div');\r\n    content.className = 'debug-panel-subsection-content';\r\n    content.dataset.subsectionKey = stateKey;\r\n    contentBuilder(content);\r\n    container.appendChild(content);\r\n\r\n    let lastPointerType = null;\r\n\r\n    const handleToggle = (event) => {\r\n        const expanded = toggle.classList.toggle('expanded');\r\n        content.classList.toggle('active', expanded);\r\n    };\r\n\r\n    toggle.addEventListener('click', (event) => {\r\n        if (lastPointerType && lastPointerType !== 'mouse') {\r\n            lastPointerType = null;\r\n            return;\r\n        }\r\n        lastPointerType = null;\r\n        handleToggle(event);\r\n    });\r\n\r\n    if (defaultExpanded) {\r\n        toggle.classList.add('expanded');\r\n        content.classList.add('active');\r\n    }\r\n\r\n    return container;\r\n}\r\n\r\nfunction bigNumEquals(a, b) {\r\n    if (a === b) return true;\r\n    if (a == null || b == null) return a == null && b == null;\r\n    if (typeof a?.cmp === 'function') {\r\n        try { return a.cmp(b) === 0; } catch {}\r\n    }\r\n    if (typeof b?.cmp === 'function') {\r\n        try { return b.cmp(a) === 0; } catch {}\r\n    }\r\n    try { return Object.is(String(a), String(b)); }\r\n    catch { return false; }\r\n}\r\n\r\nfunction bigNumToFiniteNumber(value) {\r\n    try {\r\n        const fromScientific = value?.toScientific?.(18);\r\n        const num = Number.parseFloat(fromScientific ?? value);\r\n        return Number.isFinite(num) ? num : Number.NaN;\r\n    } catch {\r\n        return Number.NaN;\r\n    }\r\n}\r\n\r\nfunction getCurrencyStorageKey(currencyKey, slot = getActiveSlot()) {\r\n    const resolvedSlot = slot ?? getActiveSlot();\r\n    if (resolvedSlot == null) return null;\r\n    return `${KEYS.CURRENCY[currencyKey]}:${resolvedSlot}`;\r\n}\r\n\r\nfunction getCurrencyValueForSlot(currencyKey, slot = getActiveSlot()) {\r\n    const resolvedSlot = slot ?? getActiveSlot();\r\n    if (resolvedSlot == null) return BigNum.fromInt(0);\r\n\r\n    const handle = bank?.[currencyKey];\r\n    if (handle) {\r\n        try { return handle.value ?? BigNum.fromInt(0); }\r\n        catch {}\r\n    }\r\n\r\n    try { return peekCurrency(resolvedSlot, currencyKey); }\r\n    catch { return BigNum.fromInt(0); }\r\n}\r\n\r\nfunction applyCurrencyState(currencyKey, value, slot = getActiveSlot()) {\r\n    const resolvedSlot = slot ?? getActiveSlot();\r\n    const previous = getCurrencyValueForSlot(currencyKey, resolvedSlot);\r\n    if (resolvedSlot == null || resolvedSlot !== getActiveSlot()) {\r\n        return { previous, next: previous };\r\n    }\r\n\r\n    const storageKey = getCurrencyStorageKey(currencyKey, resolvedSlot);\r\n    const wasLocked = storageKey && isStorageKeyLocked(storageKey);\r\n\r\n    if (wasLocked) unlockStorageKey(storageKey);\r\n\r\n    let next = previous;\r\n    try {\r\n        markSaveSlotModified(resolvedSlot);\r\n        const effective = setCurrency(currencyKey, value, { previous });\r\n        next = effective ?? previous;\r\n        if (storageKey) primeStorageWatcherSnapshot(storageKey);\r\n    } catch {}\r\n    finally {\r\n        if (wasLocked) lockStorageKey(storageKey);\r\n    }\r\n\r\n    refreshLiveBindings((binding) => binding.type === 'currency'\r\n        && binding.key === currencyKey\r\n        && binding.slot === resolvedSlot);\r\n\r\n    return { previous, next };\r\n}\r\n\r\nfunction buildOverrideKey(slot, key) {\r\n    return `${slot ?? 'null'}::${key}`;\r\n}\r\n\r\nfunction getCurrencyOverride(slot, key) {\r\n    return currencyOverrides.get(buildOverrideKey(slot, key)) ?? null;\r\n}\r\n\r\nfunction getCurrencyMultiplierStorageKey(currencyKey, slot = getActiveSlot()) {\r\n    const resolvedSlot = slot ?? getActiveSlot();\r\n    if (!currencyKey || resolvedSlot == null) return null;\r\n    return `${KEYS.MULTIPLIER[currencyKey]}:${resolvedSlot}`;\r\n}\r\n\r\nfunction isCurrencyMultiplierLocked(currencyKey, slot = getActiveSlot()) {\r\n    return isStorageKeyLocked(getCurrencyMultiplierStorageKey(currencyKey, slot));\r\n}\r\n\r\nfunction clearCurrencyMultiplierOverride(currencyKey, slot = getActiveSlot()) {\r\n    const cacheKey = buildOverrideKey(slot, currencyKey);\r\n    currencyOverrides.delete(cacheKey);\r\n    currencyOverrideBaselines.delete(cacheKey);\r\n    refreshLiveBindings((binding) => binding.type === 'currency-mult'\r\n        && binding.key === currencyKey\r\n        && binding.slot === slot);\r\n}\r\n\r\nfunction getStatOverride(slot, key) {\r\n    const lockAwareRefresh = !isStatMultiplierLocked(key, slot);\r\n    const cacheKey = buildOverrideKey(slot, key);\r\n    const cached = statOverrides.get(cacheKey);\r\n    if (!lockAwareRefresh && cached) return cached;\r\n\r\n    const fromStorage = loadStatMultiplierOverrideFromStorage(key, slot);\r\n    if (!fromStorage) {\r\n        if (lockAwareRefresh) statOverrides.delete(cacheKey);\r\n        return null;\r\n    }\r\n\r\n    statOverrides.set(cacheKey, fromStorage);\r\n    return fromStorage;\r\n}\r\n\r\nfunction notifyStatMultiplierChange(statKey, slot) {\r\n    refreshLiveBindings((binding) => binding.type === 'stat-mult'\r\n        && binding.key === statKey\r\n        && binding.slot === slot);\r\n}\r\n\r\nfunction clearStatMultiplierOverride(statKey, slot = getActiveSlot()) {\r\n    const storageKey = getStatMultiplierStorageKey(statKey, slot);\r\n    statOverrides.delete(buildOverrideKey(slot, statKey));\r\n    statOverrideBaselines.delete(buildOverrideKey(slot, statKey));\r\n    if (!storageKey || typeof localStorage === 'undefined') return;\r\n    if (isStorageKeyLocked(storageKey)) return;\r\n    try { localStorage.removeItem(storageKey); } catch {}\r\n    notifyStatMultiplierChange(statKey, slot);\r\n}\r\n\r\nfunction isStatMultiplierLocked(statKey, slot = getActiveSlot()) {\r\n    return isStorageKeyLocked(getStatMultiplierStorageKey(statKey, slot));\r\n}\r\n\r\nfunction getLockedStatOverride(slot, statKey) {\r\n    if (!isStatMultiplierLocked(statKey, slot)) return null;\r\n    return getStatOverride(slot, statKey);\r\n}\r\n\r\nfunction getStatMultiplierDisplayValue(statKey, slot = getActiveSlot()) {\r\n    const gameValue = getGameStatMultiplier(statKey);\r\n    const effectiveOverride = getEffectiveStatMultiplierOverride(statKey, slot, gameValue);\r\n    return effectiveOverride ?? gameValue;\r\n}\r\n\r\nfunction getStatMultiplierStorageKey(statKey, slot = getActiveSlot()) {\r\n    if (!statKey) return null;\r\n    const resolvedSlot = slot ?? getActiveSlot();\r\n    if (resolvedSlot == null) return null;\r\n    return `${STAT_MULTIPLIER_STORAGE_PREFIX}:${statKey}:${resolvedSlot}`;\r\n}\r\n\r\nfunction getGameStatMultiplier(statKey) {\r\n    try {\r\n        if (statKey === 'xp') {\r\n            const mult = getXpGainMultiplier();\r\n            if (mult) return mult;\r\n        } else if (statKey === 'mutation') {\r\n            const valueMult = getMutationGainMultiplier?.();\r\n            if (valueMult) return valueMult;\r\n\r\n            const mult = getMutationMultiplier();\r\n            if (mult) return mult;\r\n        } else if (statKey === 'spawnRate') {\r\n            const eff = computeUpgradeEffects(AREA_KEYS.STARTER_COVE);\r\n            if (eff?.coinsPerSecondMult) {\r\n                return BigNum.fromAny(eff.coinsPerSecondMult);\r\n            }\r\n        }\r\n        else if (statKey === 'rp') {\r\n            return getRpMultBase();\r\n        }\r\n    } catch {}\r\n\r\n    return BigNum.fromInt(1);\r\n}\r\n\r\nfunction loadStatMultiplierOverrideFromStorage(statKey, slot = getActiveSlot()) {\r\n    const storageKey = getStatMultiplierStorageKey(statKey, slot);\r\n    if (!storageKey || typeof localStorage === 'undefined') return null;\r\n    const raw = localStorage.getItem(storageKey);\r\n    if (!raw) return null;\r\n    try { return BigNum.fromAny(raw); }\r\n    catch { return null; }\r\n}\r\n\r\nfunction storeStatMultiplierOverride(statKey, slot, value) {\r\n    const storageKey = getStatMultiplierStorageKey(statKey, slot);\r\n    if (!storageKey || typeof localStorage === 'undefined') return;\r\n    try {\r\n        const bn = value instanceof BigNum ? value : BigNum.fromAny(value ?? 1);\r\n        const locked = isStorageKeyLocked(storageKey);\r\n        const setter = locked && originalSetItem ? originalSetItem : localStorage.setItem.bind(localStorage);\r\n        if (locked && !originalSetItem) unlockStorageKey(storageKey);\r\n        setter(storageKey, bn.toStorage?.() ?? String(bn));\r\n        if (locked && !originalSetItem) lockStorageKey(storageKey);\r\n    } catch {}\r\n}\r\n\r\nfunction applyCurrencyOverrideForSlot(currencyKey, slot = getActiveSlot()) {\r\n    if (slot == null) return;\r\n    const override = getCurrencyOverride(slot, currencyKey);\r\n    if (!override) return;\r\n    if (slot !== getActiveSlot()) return;\r\n\r\n    const cacheKey = buildOverrideKey(slot, currencyKey);\r\n    if (currencyOverrideApplications.has(cacheKey)) return;\r\n\r\n    currencyOverrideApplications.add(cacheKey);\r\n    try {\r\n        const current = bank?.[currencyKey]?.mult?.get?.();\r\n        if (!bigNumEquals(current, override)) {\r\n            bank?.[currencyKey]?.mult?.set?.(override);\r\n        }\r\n    } catch {} finally {\r\n        currencyOverrideApplications.delete(cacheKey);\r\n    }\r\n}\r\n\r\nlet currencyListenerAttached = false;\r\nfunction ensureCurrencyOverrideListener() {\r\n    if (currencyListenerAttached || typeof window === 'undefined') return;\r\n    currencyListenerAttached = true;\r\n    try {\r\n        window.addEventListener('currency:multiplier', (event) => {\r\n            const { key, slot, mult } = event?.detail ?? {};\r\n            const targetSlot = slot ?? getActiveSlot();\r\n            const cacheKey = buildOverrideKey(targetSlot, key);\r\n            if (!targetSlot || !currencyOverrides.has(cacheKey)) return;\r\n            if (currencyOverrideApplications.has(cacheKey)) return;\r\n\r\n            const baseline = currencyOverrideBaselines.get(cacheKey);\r\n            const override = getCurrencyOverride(targetSlot, key);\r\n\r\n            if (baseline && override && mult) {\r\n                try {\r\n                    // Fix: Use BigNum div instead of native division for ratio calculation\r\n                    // This handles numbers > 1.8e308 correctly.\r\n                    const baselineBn = BigNum.fromAny(baseline);\r\n                    const nextBn = BigNum.fromAny(mult);\r\n                    \r\n                    if (!baselineBn.isZero()) {\r\n                        const ratio = nextBn.div(baselineBn);\r\n                        // If ratio != 1 (ignoring exact equality check for simplicity, or we can check via cmp)\r\n                        // A ratio of exactly 1 means no change, so we can skip scaling.\r\n                        const ratioNum = ratio.sig === 1n && ratio.e === 0 && ratio._eOffset === 0n \r\n                                         ? 1 \r\n                                         : null; // dummy check, actually just multiply.\r\n                        \r\n                        // Just apply the ratio. If it's 1, mulDecimal(1) or mulBigNum(1) is safe.\r\n                        // Wait, mulDecimal takes number/string. mulBigNum takes BigNum.\r\n                        // Let's use mulBigNumInteger if ratio is integer? No, ratio is likely decimal.\r\n                        // BigNum doesn't have mulBigNumDecimal yet?\r\n                        // Wait, `div` returns a BigNum.\r\n                        // `override` is a BigNum.\r\n                        // We need `override * ratio`.\r\n                        // BigNum has `mulBigNumInteger`. It does NOT have `mulBigNum`.\r\n                        // But `mulBigNumInteger` logic:\r\n                        // return new BigNum(this.sig * b.sig, { base: baseSum, offset: offsetSum }, this.p);\r\n                        // This logic is generic! It multiplies two BigNums.\r\n                        // The method name says \"Integer\" but the implementation supports exponents.\r\n                        // Let's verify BigNum.js implementation of mulBigNumInteger:\r\n                        // const baseSum = this.e + b.e;\r\n                        // const offsetSum = this._eOffset + b._eOffset;\r\n                        // return new BigNum(this.sig * b.sig, { base: baseSum, offset: offsetSum }, this.p);\r\n                        // Yes, this is correct for ANY BigNum multiplication.\r\n                        \r\n                        const scaledOverride = override.mulBigNumInteger(ratio);\r\n                        currencyOverrides.set(cacheKey, scaledOverride);\r\n                    }\r\n                } catch (e) {\r\n                     // fallback or ignore\r\n                }\r\n\r\n                currencyOverrideBaselines.set(cacheKey, mult);\r\n            } else if (mult) {\r\n                currencyOverrideBaselines.set(cacheKey, mult);\r\n            }\r\n\r\n            applyCurrencyOverrideForSlot(key, targetSlot);\r\n        }, { passive: true });\r\n        window.addEventListener('saveSlot:change', () => {\r\n            applyAllCurrencyOverridesForActiveSlot();\r\n        }, { passive: true });\r\n    } catch {}\r\n}\r\n\r\nexport function applyAllCurrencyOverridesForActiveSlot() {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) return;\r\n    Object.values(CURRENCIES).forEach((key) => {\r\n        applyCurrencyOverrideForSlot(key, slot);\r\n    });\r\n}\r\n\r\nexport function setDebugCurrencyMultiplierOverride(currencyKey, value, slot = getActiveSlot()) {\r\n    if (!currencyKey || slot == null) return null;\r\n    ensureCurrencyOverrideListener();\r\n    let bn;\r\n    try { bn = value instanceof BigNum ? value.clone?.() ?? value : BigNum.fromAny(value ?? 1); }\r\n    catch { bn = BigNum.fromInt(1); }\r\n    const cacheKey = buildOverrideKey(slot, currencyKey);\r\n    currencyOverrides.set(cacheKey, bn);\r\n    \r\n    // Fix: Only set the baseline if it's not already set.\r\n    // If we overwrite the baseline with the current bank value (which might be the OLD override),\r\n    // we create a feedback loop that crushes the value when the game ticks.\r\n    if (!currencyOverrideBaselines.has(cacheKey)) {\r\n        const gameValue = bank?.[currencyKey]?.mult?.get?.();\r\n        currencyOverrideBaselines.set(cacheKey, gameValue);\r\n    }\r\n    \r\n    applyCurrencyOverrideForSlot(currencyKey, slot);\r\n    return bn;\r\n}\r\n\r\n\r\nexport function getDebugCurrencyMultiplierOverride(currencyKey, slot = getActiveSlot()) {\r\n    if (!currencyKey || slot == null) return null;\r\n    return getCurrencyOverride(slot, currencyKey);\r\n}\r\n\r\nexport function setDebugStatMultiplierOverride(statKey, value, slot = getActiveSlot()) {\r\n    if (!statKey || slot == null) return null;\r\n    let bn;\r\n    try { bn = value instanceof BigNum ? value.clone?.() ?? value : BigNum.fromAny(value ?? 1); }\r\n    catch { bn = BigNum.fromInt(1); }\r\n    statOverrides.set(buildOverrideKey(slot, statKey), bn);\r\n    statOverrideBaselines.set(buildOverrideKey(slot, statKey), getGameStatMultiplier(statKey));\r\n    storeStatMultiplierOverride(statKey, slot, bn);\r\n    notifyStatMultiplierChange(statKey, slot);\r\n    return bn;\r\n}\r\n\r\nexport function getDebugStatMultiplierOverride(statKey, slot = getActiveSlot()) {\r\n    if (!statKey || slot == null) return null;\r\n    return getStatOverride(slot, statKey);\r\n}\r\n\r\nexport function applyStatMultiplierOverride(statKey, amount, slot = getActiveSlot()) {\r\n    const gameValue = getGameStatMultiplier(statKey);\r\n    const override = getEffectiveStatMultiplierOverride(statKey, slot, gameValue);\r\n    if (!override) return amount;\r\n\r\n    let base;\r\n    try {\r\n        base = amount instanceof BigNum ? amount.clone?.() ?? amount : BigNum.fromAny(amount ?? 0);\r\n    } catch {\r\n        return amount;\r\n    }\r\n\r\n    // If the caller is passing the raw in-game multiplier itself (e.g. XP Value,\r\n    // MP Value, etc.), avoid ratio math and just return the override directly.\r\n    try {\r\n        if (bigNumEquals(base, gameValue)) {\r\n            return override;\r\n        }\r\n    } catch {\r\n        // fall through and apply ratio logic below\r\n    }\r\n\r\n    try {\r\n        if (base.isZero?.()) return base;\r\n    } catch {\r\n        return base;\r\n    }\r\n\r\n    const cacheKey = buildOverrideKey(slot, statKey);\r\n    const baseline = statOverrideBaselines.get(cacheKey);\r\n    const multiplierForRatio =\r\n        (isStatMultiplierLocked(statKey, slot) && baseline) ? baseline : gameValue;\r\n\r\n    // Fix: Use BigNum div instead of converting to finite numbers\r\n    let ratio = null;\r\n    try {\r\n         const numBn = BigNum.fromAny(override);\r\n         const denomBn = BigNum.fromAny(multiplierForRatio);\r\n         if (!denomBn.isZero()) {\r\n             ratio = numBn.div(denomBn);\r\n         }\r\n    } catch (e) {\r\n        ratio = null;\r\n    }\r\n\r\n    if (ratio) {\r\n        try { \r\n            // mulBigNumInteger supports generic BigNum multiplication\r\n            return base.mulBigNumInteger(ratio); \r\n        }\r\n        catch {}\r\n    }\r\n\r\n    return base;\r\n}\r\n\r\nfunction getEffectiveStatMultiplierOverride(statKey, slot, gameValue) {\r\n    const override = getStatOverride(slot, statKey);\r\n    const cacheKey = buildOverrideKey(slot, statKey);\r\n    if (!override) {\r\n        statOverrideBaselines.delete(cacheKey);\r\n        return null;\r\n    }\r\n\r\n    const baseline = statOverrideBaselines.get(cacheKey);\r\n    const locked = isStatMultiplierLocked(statKey, slot);\r\n\r\n    if (!baseline) {\r\n        statOverrideBaselines.set(cacheKey, gameValue);\r\n    } else if (!bigNumEquals(baseline, gameValue)) {\r\n        if (locked) {\r\n            statOverrideBaselines.set(cacheKey, gameValue);\r\n            return override;\r\n        }\r\n        clearStatMultiplierOverride(statKey, slot);\r\n        return null;\r\n    }\r\n\r\n    return override;\r\n}\r\n\r\nfunction ensureStorageLockPatch() {\r\n    if (storageLockPatched || typeof localStorage === 'undefined') return;\r\n    storageLockPatched = true;\r\n    try {\r\n        originalSetItem = localStorage.setItem.bind(localStorage);\r\n        originalRemoveItem = localStorage.removeItem.bind(localStorage);\r\n        localStorage.setItem = (key, value) => {\r\n            if (lockedStorageKeys.has(key)) return;\r\n            return originalSetItem(key, value);\r\n        };\r\n        localStorage.removeItem = (key) => {\r\n            if (lockedStorageKeys.has(key)) return;\r\n            return originalRemoveItem(key);\r\n        };\r\n    } catch {}\r\n}\r\n\r\nfunction isStorageKeyLocked(key) {\r\n    return key != null && lockedStorageKeys.has(key);\r\n}\r\n\r\nfunction lockStorageKey(key) {\r\n    if (!key) return;\r\n    ensureStorageLockPatch();\r\n    lockedStorageKeys.add(key);\r\n}\r\n\r\nfunction unlockStorageKey(key) {\r\n    if (!key) return;\r\n    lockedStorageKeys.delete(key);\r\n}\r\n\r\nfunction toggleStorageLock(key) {\r\n    if (!key) return false;\r\n    if (isStorageKeyLocked(key)) {\r\n        unlockStorageKey(key);\r\n        return false;\r\n    }\r\n    lockStorageKey(key);\r\n    return true;\r\n}\r\n\r\nfunction createLockToggle(storageKey, { onToggle } = {}) {\r\n    const button = document.createElement('button');\r\n    button.type = 'button';\r\n    button.className = 'debug-lock-button';\r\n\r\n    const refresh = () => {\r\n        const locked = isStorageKeyLocked(storageKey);\r\n        button.textContent = locked ? 'L' : 'UL';\r\n        button.classList.toggle('locked', locked);\r\n    };\r\n\r\n    button.addEventListener('click', () => {\r\n        toggleStorageLock(storageKey);\r\n        if (typeof onToggle === 'function') {\r\n            try { onToggle(isStorageKeyLocked(storageKey)); }\r\n            catch {}\r\n        }\r\n        refresh();\r\n    });\r\n\r\n    refresh();\r\n    return { button, refresh };\r\n}\r\n\r\nfunction createCompositeLockToggle(resolveKeys, { onToggle } = {}) {\r\n    const button = document.createElement('button');\r\n    button.type = 'button';\r\n    button.className = 'debug-lock-button';\r\n\r\n    const getKeys = () =>\r\n        Array.from(new Set((resolveKeys?.() ?? []).filter(Boolean)));\r\n\r\n    const isLocked = () => {\r\n        const keys = getKeys();\r\n        return keys.length > 0 && keys.every((key) => isStorageKeyLocked(key));\r\n    };\r\n\r\n    const hasAnyLocked = () => {\r\n        const keys = getKeys();\r\n        return keys.length > 0 && keys.some((key) => isStorageKeyLocked(key));\r\n    };\r\n\r\n    const refresh = () => {\r\n        const keys = getKeys();\r\n        const anyLocked = hasAnyLocked();\r\n        button.textContent = anyLocked ? 'L' : 'UL';\r\n        button.classList.toggle('locked', anyLocked);\r\n        button.disabled = keys.length === 0;\r\n    };\r\n\r\n    button.addEventListener('click', () => {\r\n        const keys = getKeys();\r\n        if (keys.length === 0) return;\r\n\r\n        const locked = isLocked();\r\n        keys.forEach((key) => {\r\n            if (locked) {\r\n                unlockStorageKey(key);\r\n            } else {\r\n                lockStorageKey(key);\r\n            }\r\n        });\r\n\r\n        if (typeof onToggle === 'function') {\r\n            try { onToggle(isLocked()); }\r\n            catch {}\r\n        }\r\n\r\n        refresh();\r\n    });\r\n\r\n    refresh();\r\n    return { button, refresh, isLocked };\r\n}\r\n\r\napplyAllCurrencyOverridesForActiveSlot();\r\nensureCurrencyOverrideListener();\r\n\r\nfunction collapseAllDebugCategories() {\r\n    const panel = document.getElementById(DEBUG_PANEL_ID);\r\n    if (!panel) return;\r\n\r\n    panel.querySelectorAll('.debug-panel-section-toggle').forEach((toggle) => {\r\n        toggle.classList.remove('expanded');\r\n        const content = toggle.nextElementSibling;\r\n        if (content) content.classList.remove('active');\r\n    });\r\n\r\n    panel.querySelectorAll('.debug-panel-subsection-toggle').forEach((toggle) => {\r\n        toggle.classList.remove('expanded');\r\n        const content = toggle.nextElementSibling;\r\n        if (content) content.classList.remove('active');\r\n    });\r\n}\r\n\r\nfunction withTemporaryUnlock(keys, fn) {\r\n    const uniqueKeys = Array.from(new Set((keys ?? []).filter(Boolean)));\r\n    const relock = [];\r\n\r\n    uniqueKeys.forEach((key) => {\r\n        if (isStorageKeyLocked(key)) {\r\n            relock.push(key);\r\n            unlockStorageKey(key);\r\n        }\r\n    });\r\n\r\n    try {\r\n        return fn?.();\r\n    } finally {\r\n        relock.forEach((key) => lockStorageKey(key));\r\n    }\r\n}\r\n\r\nfunction formatBigNumForInput(value) {\r\n    try {\r\n        const bn = value instanceof BigNum ? value : BigNum.fromAny(value ?? 0);\r\n        if (bn.isInfinite?.()) {\r\n            const precision = Number.parseInt(bn?.p, 10) || BigNum.DEFAULT_PRECISION;\r\n            return `BN:${precision}:1:${BigNum.MAX_E}`;\r\n        }\r\n        const storage = bn.toStorage?.();\r\n        const [, pStr = `${BigNum.DEFAULT_PRECISION}`, sigPart = '0', expPart = '0'] = (storage || '').split(':');\r\n        const precision = Number.parseInt(pStr, 10) || BigNum.DEFAULT_PRECISION;\r\n        if (bn.isZero?.()) {\r\n            return `BN:${precision}:${'0'.repeat(precision)}:-17`;\r\n        }\r\n        const paddedSig = sigPart.padStart(precision, '0');\r\n        return `BN:${precision}:${paddedSig}:${expPart}`;\r\n    } catch {\r\n        return String(value ?? '');\r\n    }\r\n}\r\n\r\nfunction parseBigNumInput(raw) {\r\n    let trimmed = String(raw ?? '').trim();\r\n    if (!trimmed) return BigNum.fromInt(0);\r\n\r\n    if (trimmed.startsWith('.')) {\r\n        trimmed = '0' + trimmed;\r\n    } else if (trimmed.startsWith('-.')) {\r\n        trimmed = '-0' + trimmed.substring(1);\r\n    }\r\n\r\n    try {\r\n        if (/^inf(?:inity)?$/i.test(trimmed)) {\r\n            return BigNum.fromAny('Infinity');\r\n        }\r\n        return BigNum.fromAny(trimmed);\r\n    } catch {\r\n        return null;\r\n    }\r\n}\r\n\r\nfunction setInputValidity(input, valid) {\r\n    input.classList.toggle('debug-invalid', !valid);\r\n}\r\n\r\nfunction flagDebugUsage() {\r\n    const slot = getActiveSlot();\r\n    try { markSaveSlotModified(slot); }\r\n    catch {}\r\n    try { window.dispatchEvent(new CustomEvent('debug:change', { detail: { slot } })); }\r\n    catch {}\r\n}\r\n\r\nfunction getActionLogKey(slot = getActiveSlot()) {\r\n    if (slot == null) return null;\r\n    return `${ACTION_LOG_STORAGE_PREFIX}:${slot}`;\r\n}\r\n\r\nfunction getCurrentActionLog(slot = getActiveSlot()) {\r\n    const key = getActionLogKey(slot);\r\n    if (!key) return [];\r\n\r\n    let raw = null;\r\n    try { raw = localStorage.getItem(key); }\r\n    catch {}\r\n    if (!raw) return [];\r\n\r\n    try {\r\n        const parsed = JSON.parse(raw);\r\n        return Array.isArray(parsed) ? parsed : [];\r\n    } catch {\r\n        return [];\r\n    }\r\n}\r\n\r\nfunction persistActionLog(entries, slot = getActiveSlot()) {\r\n    const key = getActionLogKey(slot);\r\n    if (!key || typeof localStorage === 'undefined') return;\r\n\r\n    const trimmed = (Array.isArray(entries) ? entries : []).slice(0, MAX_ACTION_LOG_ENTRIES);\r\n    try { localStorage.setItem(key, JSON.stringify(trimmed)); }\r\n    catch {}\r\n}\r\n\r\nfunction appendActionLogEntry(entry, slot = getActiveSlot()) {\r\n    const log = getCurrentActionLog(slot);\r\n    log.unshift(entry);\r\n    if (log.length > MAX_ACTION_LOG_ENTRIES) {\r\n        log.length = MAX_ACTION_LOG_ENTRIES;\r\n    }\r\n    persistActionLog(log, slot);\r\n    return log;\r\n}\r\n\r\nfunction logAction(message) {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) return;\r\n\r\n    const now = new Date();\r\n    const entry = {\r\n        time: now.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit', hour12: true }),\r\n        message,\r\n        timestamp: now.getTime(),\r\n    };\r\n    appendActionLogEntry(entry, slot);\r\n    updateActionLogDisplay();\r\n}\r\n\r\nfunction updateActionLogDisplay() {\r\n    if (!actionLogContainer) return;\r\n\r\n    const actionLog = getCurrentActionLog();\r\n    if (actionLog.length === 0) {\r\n        actionLogContainer.innerHTML = '';\r\n        const msg = document.createElement('div');\r\n        msg.className = 'action-log-empty';\r\n        msg.textContent = 'Actions you perform in the Debug Panel will be logged permanently in this action log.';\r\n        actionLogContainer.appendChild(msg);\r\n        return;\r\n    }\r\n\r\n    actionLogContainer.innerHTML = actionLog.map((entry) => {\r\n        const formattedTime = String(entry.time ?? '').replace(/^0(\\d)/, '$1');\r\n        let formattedMessage = entry.message?.replace?.(/\\[GOLD\\](.*?)\\[\\/GOLD\\]/g, '<span class=\"action-log-gold\">$1</span>') ?? '';\r\n        formattedMessage = formattedMessage.replace(/\\b(?:Level|Lv)\\s?(\\d+)\\b/g, '<span class=\"action-log-level\">Lv$1</span>');\r\n        formattedMessage = formattedMessage.replace(/(\\d[\\d,.]*(?:e[+-]?\\d+)*(?:[KMBTQa-zA-Z]*))/g, (match) => /\\d/.test(match) ? `<span class=\"action-log-number\">${match}</span>` : match);\r\n        formattedMessage = formattedMessage.replace(/<span[^>]*class=\"[^\"]*infinity-symbol[^\"]*\"[^>]*>\\u221E<\\/span>/g, '<span class=\"action-log-number\">inf</span>');\r\n        formattedMessage = formattedMessage.replace(/\\u221E/g, '<span class=\"action-log-number\">inf</span>');\r\n\r\n        return `<div class=\"action-log-entry\"><span class=\"action-log-time\">${formattedTime}:</span><span class=\"action-log-message\">${formattedMessage}</span></div>`;\r\n    }).join('');\r\n}\r\n\r\nfunction dialogueStateStorageKey(slot = getActiveSlot()) {\r\n    if (slot == null) return null;\r\n    return `${MERCHANT_DLG_STATE_KEY_BASE}:${slot}`;\r\n}\r\n\r\nfunction persistDialogueState(state, slot = getActiveSlot()) {\r\n    const key = dialogueStateStorageKey(slot);\r\n    if (!key) return;\r\n    try {\r\n        const payload = JSON.stringify(state || {});\r\n        localStorage.setItem(key, payload);\r\n    } catch {}\r\n}\r\n\r\nfunction loadDialogueState(slot = getActiveSlot()) {\r\n    const key = dialogueStateStorageKey(slot);\r\n    if (!key) return {};\r\n    try {\r\n        const raw = localStorage.getItem(key);\r\n        return raw ? JSON.parse(raw) : {};\r\n    } catch {\r\n        return {};\r\n    }\r\n}\r\n\r\nfunction grantDialogueReward(reward) {\r\n    if (!reward) return;\r\n\r\n    if (Object.values(CURRENCIES).includes(reward.type)) {\r\n        try {\r\n            if (reward.type === CURRENCIES.BOOKS) {\r\n                bank.books.addWithMultiplier?.(reward.amount) ?? bank.books.add(reward.amount);\r\n            } else {\r\n                bank[reward.type].add(reward.amount);\r\n            }\r\n        } catch (e) {\r\n            console.warn(`Failed to grant ${reward.type} reward:`, reward, e);\r\n        }\r\n        return;\r\n    }\r\n\r\n    try { window.dispatchEvent(new CustomEvent('merchantReward', { detail: reward })); }\r\n    catch {}\r\n}\r\n\r\nfunction completeAllDialoguesForDebug() {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) return { completed: 0 };\r\n\r\n    const state = loadDialogueState(slot);\r\n    let completed = 0;\r\n\r\n    Object.entries(DLG_CATALOG).forEach(([id, meta]) => {\r\n        const key = String(id);\r\n        const prev = state[key] || {};\r\n        const alreadyClaimed = !!prev.claimed;\r\n        const next = Object.assign({}, prev, { status: 'unlocked', claimed: true });\r\n        state[key] = next;\r\n        if (!alreadyClaimed) {\r\n            completed += 1;\r\n            grantDialogueReward(meta.reward);\r\n        }\r\n    });\r\n\r\n    persistDialogueState(state, slot);\r\n    return { completed };\r\n}\r\n\r\nfunction restoreAllDialoguesForDebug() {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) return { restored: 0 };\r\n\r\n    const state = loadDialogueState(slot);\r\n    let restored = 0;\r\n\r\n    Object.entries(DLG_CATALOG).forEach(([id]) => {\r\n        const key = String(id);\r\n        const prev = state[key] || {};\r\n        if (prev.claimed) restored += 1;\r\n        state[key] = Object.assign({}, prev, { claimed: false });\r\n    });\r\n\r\n    persistDialogueState(state, slot);\r\n    return { restored };\r\n}\r\n\r\nfunction createInputRow(labelText, initialValue, onCommit, { idLabel, storageKey, onLockChange, format } = {}) {\r\n    const row = document.createElement('div');\r\n    row.className = 'debug-panel-row';\r\n\r\n    const label = document.createElement('label');\r\n    label.textContent = labelText;\r\n    if (idLabel != null) {\r\n        label.append(' ');\r\n        const idSpan = document.createElement('span');\r\n        idSpan.className = 'debug-panel-id';\r\n        idSpan.textContent = `(ID: ${idLabel})`;\r\n        label.appendChild(idSpan);\r\n    }\r\n    row.appendChild(label);\r\n\r\n    const input = document.createElement('input');\r\n    input.type = 'text';\r\n    input.className = 'debug-panel-input';\r\n    let editing = false;\r\n    let pendingValue = null;\r\n    let skipBlurCommit = false;\r\n    const lockToggle = storageKey ? createLockToggle(storageKey, { onToggle: onLockChange }) : null;\r\n\r\n    const setValue = (value) => {\r\n        if (editing) {\r\n            pendingValue = value;\r\n            return;\r\n        }\r\n        pendingValue = null;\r\n        input.value = typeof format === 'function'\r\n            ? format(value)\r\n            : formatBigNumForInput(value);\r\n    };\r\n\r\n    row.appendChild(input);\r\n    if (lockToggle) {\r\n        row.appendChild(lockToggle.button);\r\n    }\r\n\r\n    const commitValue = () => {\r\n        const parsed = parseBigNumInput(input.value);\r\n        if (!parsed) {\r\n            setInputValidity(input, false);\r\n            return;\r\n        }\r\n        setInputValidity(input, true);\r\n\r\n        const wasLocked = storageKey && isStorageKeyLocked(storageKey);\r\n        if (wasLocked) unlockStorageKey(storageKey);\r\n        try {\r\n            onCommit(parsed, { input, setValue });\r\n        } finally {\r\n            if (wasLocked) lockStorageKey(storageKey);\r\n            if (lockToggle) lockToggle.refresh();\r\n        }\r\n    };\r\n\r\n    input.addEventListener('focus', () => { editing = true; });\r\n    input.addEventListener('change', commitValue);\r\n    input.addEventListener('keydown', (event) => {\r\n        if (event.key === 'Enter') {\r\n            event.preventDefault();\r\n            skipBlurCommit = true;\r\n            commitValue();\r\n            input.blur();\r\n        }\r\n    });\r\n    input.addEventListener('blur', () => {\r\n        editing = false;\r\n        if (!skipBlurCommit) {\r\n            commitValue();\r\n        }\r\n        skipBlurCommit = false;\r\n        if (pendingValue != null) {\r\n            const next = pendingValue;\r\n            pendingValue = null;\r\n            setValue(next);\r\n        }\r\n    });\r\n\r\n    setValue(initialValue);\r\n    if (lockToggle) lockToggle.refresh();\r\n\r\n    return { row, input, setValue, isEditing: () => editing };\r\n}\r\n\r\nfunction createUnlockToggleRow({ labelText, description, isUnlocked, onEnable, onDisable, slot }) {\r\n    const row = document.createElement('div');\r\n    row.className = 'debug-panel-row debug-unlock-row';\r\n\r\n    const toggle = document.createElement('label');\r\n    toggle.className = 'flag-toggle';\r\n    toggle.setAttribute('aria-label', labelText);\r\n\r\n    const input = document.createElement('input');\r\n    input.type = 'checkbox';\r\n\r\n    const slider = document.createElement('span');\r\n    slider.className = 'flag-slider';\r\n\r\n    toggle.appendChild(input);\r\n    toggle.appendChild(slider);\r\n\r\n    const textContainer = document.createElement('div');\r\n    textContainer.className = 'debug-unlock-text';\r\n\r\n    const title = document.createElement('span');\r\n    title.className = 'debug-unlock-title';\r\n    title.textContent = labelText;\r\n    textContainer.appendChild(title);\r\n\r\n    if (description) {\r\n        const desc = document.createElement('span');\r\n        desc.className = 'debug-unlock-desc';\r\n        desc.textContent = `- ${description}`;\r\n        textContainer.appendChild(desc);\r\n    }\r\n\r\n    row.appendChild(toggle);\r\n    row.appendChild(textContainer);\r\n\r\n    const toggleRow = () => {\r\n        input.checked = !input.checked;\r\n        input.dispatchEvent(new Event('change', { bubbles: true }));\r\n    };\r\n\r\n    row.addEventListener('click', (event) => {\r\n        if (toggle.contains(event.target)) return;\r\n        toggleRow();\r\n    });\r\n\r\n    let lastKnown = false;\r\n\r\n    const refresh = () => {\r\n        let unlocked = false;\r\n        try { unlocked = typeof isUnlocked === 'function' ? !!isUnlocked() : false; }\r\n        catch {}\r\n        input.checked = unlocked;\r\n        lastKnown = unlocked;\r\n        return unlocked;\r\n    };\r\n\r\n    input.addEventListener('change', () => {\r\n        const previous = lastKnown;\r\n        const unlocked = input.checked;\r\n        try {\r\n            if (unlocked) {\r\n                onEnable?.();\r\n            } else {\r\n                onDisable?.();\r\n            }\r\n        } catch {}\r\n        flagDebugUsage();\r\n        const refreshed = refresh();\r\n        if (previous !== refreshed) {\r\n            logAction(`Toggled ${labelText} [GOLD]${previous ? 'True' : 'False'}[/GOLD] \u2192 [GOLD]${refreshed ? 'True' : 'False'}[/GOLD]`);\r\n        }\r\n    });\r\n\r\n    refresh();\r\n    registerLiveBinding({ type: 'unlock', slot, refresh });\r\n    return row;\r\n}\r\n\r\nfunction formatCalculatorResult(value) {\r\n    try {\r\n        if (value instanceof BigNum || typeof value?.toScientific === 'function') {\r\n            return formatNumber(value);\r\n        }\r\n        const num = Number(value);\r\n        if (Number.isFinite(num)) {\r\n            return formatNumber(num);\r\n        }\r\n        return String(value ?? '\u2014');\r\n    } catch {\r\n        return '\u2014';\r\n    }\r\n}\r\n\r\nfunction createCalculatorRow({ labelText, inputs = [], compute }) {\r\n    const row = document.createElement('div');\r\n    row.className = 'debug-panel-row debug-calculator-row';\r\n\r\n    const label = document.createElement('label');\r\n    label.textContent = labelText;\r\n    row.appendChild(label);\r\n\r\n    const controls = document.createElement('div');\r\n    controls.className = 'debug-calculator-inputs';\r\n    row.appendChild(controls);\r\n\r\n    const output = document.createElement('div');\r\n    output.className = 'debug-calculator-output';\r\n    output.textContent = '\u2014';\r\n    row.appendChild(output);\r\n\r\n    const fieldEls = [];\r\n\r\n    const recompute = () => {\r\n        const values = {};\r\n        let hasError = false;\r\n\r\n        fieldEls.forEach(({ config, el }) => {\r\n            if (config.type === 'select') {\r\n                values[config.key] = el.value;\r\n                return;\r\n            }\r\n\r\n            const parsed = parseBigNumInput(el.value);\r\n            const valid = parsed instanceof BigNum;\r\n            setInputValidity(el, valid);\r\n            if (!valid) {\r\n                hasError = true;\r\n                return;\r\n            }\r\n            values[config.key] = parsed;\r\n        });\r\n\r\n        if (hasError || typeof compute !== 'function') {\r\n            output.textContent = '\u2014';\r\n            return;\r\n        }\r\n\r\n        try {\r\n            const result = compute(values);\r\n            output.innerHTML = formatCalculatorResult(result);\r\n        } catch {\r\n            output.textContent = '\u2014';\r\n        }\r\n    };\r\n\r\n    inputs.forEach((inputConfig) => {\r\n        const config = Object.assign({ type: 'text', defaultValue: '' }, inputConfig);\r\n        if (!config.key) return;\r\n\r\n        if (config.type === 'select') {\r\n            const select = document.createElement('select');\r\n            select.className = 'debug-panel-input';\r\n            (config.options || []).forEach(({ value, label: optLabel }) => {\r\n                const option = document.createElement('option');\r\n                option.value = value;\r\n                option.textContent = optLabel ?? value;\r\n                if (config.defaultValue != null && config.defaultValue === value) {\r\n                    option.selected = true;\r\n                }\r\n                select.appendChild(option);\r\n            });\r\n            select.addEventListener('change', recompute);\r\n            controls.appendChild(select);\r\n            fieldEls.push({ config, el: select });\r\n        } else {\r\n            const input = document.createElement('input');\r\n            input.type = 'text';\r\n            input.className = 'debug-panel-input';\r\n            input.placeholder = config.label || '';\r\n            input.value = config.defaultValue ?? '';\r\n            input.addEventListener('input', recompute);\r\n            input.addEventListener('keydown', (event) => {\r\n                if (event.key === 'Enter') {\r\n                    event.preventDefault();\r\n                    recompute();\r\n                }\r\n            });\r\n            controls.appendChild(input);\r\n            fieldEls.push({ config, el: input });\r\n        }\r\n    });\r\n\r\n    recompute();\r\n\r\n    return row;\r\n}\r\n\r\nfunction applyXpState({ level, progress }) {\r\n  const slot = getActiveSlot();\r\n  if (slot == null) return;\r\n\r\n  const current = (() => {\r\n    try { return getXpState(); }\r\n    catch { return null; }\r\n  })();\r\n\r\n  const zero = (() => {\r\n    try { return BigNum.fromInt(0); }\r\n    catch { return null; }\r\n  })();\r\n\r\n  const toBnOrNull = (value) => {\r\n    if (value == null) return null;\r\n    try { return value instanceof BigNum ? value.clone?.() ?? value : BigNum.fromAny(value); }\r\n    catch { return null; }\r\n  };\r\n\r\n  let nextLevel = toBnOrNull(level) ?? current?.xpLevel ?? null;\r\n  let nextProgress = toBnOrNull(progress) ?? current?.progress ?? null;\r\n\r\n  const levelIsFinite = !(nextLevel?.isInfinite?.());\r\n  const progressIsFinite = !(nextProgress?.isInfinite?.());\r\n\r\n  // If either field is being changed back to a finite value, but its partner\r\n  // was still stuck at Infinity, zero it out so the XP system can resume\r\n  // normal accumulation.\r\n  if ((level != null || progress != null) && zero) {\r\n    if (levelIsFinite && !progressIsFinite) {\r\n      if (level != null) {\r\n        nextProgress = zero.clone?.() ?? zero;\r\n      }\r\n    } else if (progressIsFinite && !levelIsFinite) {\r\n      if (progress != null) {\r\n        nextLevel = zero.clone?.() ?? zero;\r\n      }\r\n    }\r\n  }\r\n\r\n    // If we're manually editing XP stats from the debug panel, the XP system\r\n    // should be treated as unlocked.\r\n    try { unlockXpSystem(); } catch {}\r\n\r\n    const unlockKey = XP_KEYS.unlock(slot);\r\n    try { localStorage.setItem(unlockKey, '1'); } catch {}\r\n    primeStorageWatcherSnapshot(unlockKey, '1');\r\n\r\n  if (nextLevel != null) {\r\n    try {\r\n      const raw = nextLevel.toStorage?.() ?? BigNum.fromAny(nextLevel).toStorage();\r\n      const key = XP_KEYS.level(slot);\r\n      localStorage.setItem(key, raw);\r\n      primeStorageWatcherSnapshot(key, raw);\r\n    } catch {}\r\n  }\r\n\r\n  if (nextProgress != null) {\r\n    try {\r\n      const raw = nextProgress.toStorage?.() ?? BigNum.fromAny(nextProgress).toStorage();\r\n      const key = XP_KEYS.progress(slot);\r\n      localStorage.setItem(key, raw);\r\n      primeStorageWatcherSnapshot(key, raw);\r\n    } catch {}\r\n  }\r\n\r\n    try {\r\n        initXpSystem({ forceReload: true });\r\n    } catch {}\r\n\r\n    // Let any XP listeners know we've made a manual change so dependent UI (like\r\n    // the Forge reset panel) can refresh immediately without waiting for normal\r\n    // gameplay hooks to fire.\r\n    try {\r\n        broadcastXpChange({ changeType: 'debug-panel', slot });\r\n    } catch {}\r\n\r\n    // Also keep ALL debug live bindings in sync (including the Unlocks tab\r\n    // \"Unlock XP\" flag, which reads getXpState().unlocked).\r\n    try {\r\n        refreshLiveBindings();\r\n    } catch {}\r\n}\r\n\r\nfunction applyMutationState({ level, progress }) {\r\n  const slot = getActiveSlot();\r\n  if (slot == null) return;\r\n\r\n  const current = (() => {\r\n    try { return getMutationState(); }\r\n    catch { return null; }\r\n  })();\r\n\r\n  const zero = (() => {\r\n    try { return BigNum.fromInt(0); }\r\n    catch { return null; }\r\n  })();\r\n\r\n  const toBnOrNull = (value) => {\r\n    if (value == null) return null;\r\n    try { return value instanceof BigNum ? value.clone?.() ?? value : BigNum.fromAny(value); }\r\n    catch { return null; }\r\n  };\r\n\r\n  let nextLevel = toBnOrNull(level) ?? current?.level ?? null;\r\n  let nextProgress = toBnOrNull(progress) ?? current?.progress ?? null;\r\n\r\n  const levelIsFinite = !(nextLevel?.isInfinite?.());\r\n  const progressIsFinite = !(nextProgress?.isInfinite?.());\r\n\r\n  if ((level != null || progress != null) && zero) {\r\n    if (levelIsFinite && !progressIsFinite) {\r\n      nextProgress = zero.clone?.() ?? zero;\r\n    } else if (progressIsFinite && !levelIsFinite) {\r\n      nextLevel = zero.clone?.() ?? zero;\r\n    }\r\n  }\r\n\r\n    // If the MP system isn't unlocked yet, setting its level/progress should\r\n    // auto-enable the relevant unlock flags so the UI and systems stay in\r\n    // sync.\r\n    try {\r\n        const forgeUnlocked = typeof window.resetSystem?.isForgeUnlocked === 'function' ? window.resetSystem.isForgeUnlocked() : false;\r\n        const forgeOverride = typeof window.resetSystem?.getForgeDebugOverrideState === 'function'\r\n            ? window.resetSystem.getForgeDebugOverrideState()\r\n            : null;\r\n        if (!forgeUnlocked && forgeOverride !== true) {\r\n            window.resetSystem?.setForgeDebugOverride?.(true);\r\n        }\r\n    } catch {}\r\n\r\n    try {\r\n        if (typeof window.resetSystem?.hasDoneForgeReset === 'function' && !window.resetSystem.hasDoneForgeReset()) {\r\n            window.resetSystem?.setForgeResetCompleted?.(true);\r\n        }\r\n    } catch {}\r\n\r\n    try { setMutationUnlockedForDebug(true); } catch {}\r\n\r\n    try { window.resetSystem?.updateResetPanel?.(); } catch {}\r\n\r\n    // Make sure the mutation / MP system is treated as unlocked if we're\r\n    // manually editing its stats from the debug panel.\r\n    try { initMutationSystem(); } catch {}\r\n    try { unlockMutationSystem(); } catch {}\r\n\r\n    const unlockKey = MUTATION_KEYS.unlock(slot);\r\n    try { localStorage.setItem(unlockKey, '1'); } catch {}\r\n    primeStorageWatcherSnapshot(unlockKey, '1');\r\n\r\n    if (level != null) {\r\n        try {\r\n            const raw = level.toStorage?.() ?? BigNum.fromAny(level).toStorage();\r\n            const key = MUTATION_KEYS.level(slot);\r\n            localStorage.setItem(key, raw);\r\n            primeStorageWatcherSnapshot(key, raw);\r\n        } catch {}\r\n    }\r\n\r\n    if (progress != null) {\r\n        try {\r\n            const raw = progress.toStorage?.() ?? BigNum.fromAny(progress).toStorage();\r\n            const key = MUTATION_KEYS.progress(slot);\r\n            localStorage.setItem(key, raw);\r\n            primeStorageWatcherSnapshot(key, raw);\r\n        } catch {}\r\n    }\r\n\r\n    try {\r\n        initMutationSystem({ forceReload: true });\r\n    } catch {}\r\n\r\n    try {\r\n        broadcastMutationChange({ changeType: 'debug-panel', slot });\r\n    } catch {}\r\n\r\n    try { window.resetSystem?.recomputePendingMagic?.(); } catch {}\r\n    try { window.resetSystem?.updateResetPanel?.(); } catch {}\r\n\r\n    // Keep all debug rows that depend on mutation / MP state in sync.\r\n    try {\r\n        refreshLiveBindings();\r\n    } catch {}\r\n}\r\n\r\nfunction buildAreaCurrencies(container, area) {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) {\r\n        const msg = document.createElement('div');\r\n        msg.className = 'debug-panel-empty';\r\n        msg.textContent = 'Select a save slot to edit currency values.';\r\n        container.appendChild(msg);\r\n        return;\r\n    }\r\n\r\n    const areaLabel = area?.title ?? area?.key ?? 'Unknown Area';\r\n\r\n    area.currencies.forEach((currency) => {\r\n        const storageKey = getCurrencyStorageKey(currency.key, slot);\r\n        const current = getCurrencyValueForSlot(currency.key, slot);\r\n        const currencyRow = createInputRow(currency.label, current, (value, { setValue }) => {\r\n            const latestSlot = getActiveSlot();\r\n            if (latestSlot == null) return;\r\n            const previous = getCurrencyValueForSlot(currency.key, latestSlot);\r\n            const { next } = applyCurrencyState(currency.key, value, latestSlot);\r\n            setValue(next);\r\n            if (!bigNumEquals(previous, next)) {\r\n                flagDebugUsage();\r\n                logAction(`Modified ${currency.label} (${areaLabel}) ${formatNumber(previous)} \u2192 ${formatNumber(next)}`);\r\n            }\r\n        }, {\r\n            storageKey,\r\n            onLockChange: () => currencyRow.setValue(getCurrencyValueForSlot(currency.key, getActiveSlot())),\r\n        });\r\n        registerLiveBinding({\r\n            type: 'currency',\r\n            key: currency.key,\r\n            slot,\r\n            refresh: () => {\r\n                if (slot !== getActiveSlot()) return;\r\n                const latest = getCurrencyValueForSlot(currency.key, slot);\r\n                currencyRow.setValue(latest);\r\n            },\r\n        });\r\n        container.appendChild(currencyRow.row);\r\n    });\r\n}\r\n\r\nfunction buildAreaStats(container, area) {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) {\r\n        const msg = document.createElement('div');\r\n        msg.className = 'debug-panel-empty';\r\n        msg.textContent = 'Select a save slot to edit stats.';\r\n        container.appendChild(msg);\r\n        return;\r\n    }\r\n\t\r\n\t    const spawnRateKey = 'spawnRate';\r\n    const spawnRateStorageKey = getStatMultiplierStorageKey(spawnRateKey, slot);\r\n    const spawnRateRow = createInputRow('Coin Spawn Rate', getStatMultiplierDisplayValue(spawnRateKey, slot), (value, { setValue }) => {\r\n        const latestSlot = getActiveSlot();\r\n        if (latestSlot == null) return;\r\n        const previous = getStatMultiplierDisplayValue(spawnRateKey, latestSlot);\r\n        try { setDebugStatMultiplierOverride(spawnRateKey, value, latestSlot); } catch {}\r\n        const refreshed = getStatMultiplierDisplayValue(spawnRateKey, latestSlot);\r\n        setValue(refreshed);\r\n        if (!bigNumEquals(previous, refreshed)) {\r\n            flagDebugUsage();\r\n            logAction(`Modified Spawn Rate (${areaLabel}) ${formatNumber(previous)} \u2192 ${formatNumber(refreshed)}`);\r\n        }\r\n    }, {\r\n        storageKey: spawnRateStorageKey,\r\n        onLockChange: (locked) => {\r\n            const latestSlot = getActiveSlot();\r\n            if (latestSlot == null) return;\r\n            if (locked) {\r\n                const existingOverride = getLockedStatOverride(latestSlot, spawnRateKey);\r\n                if (existingOverride) return;\r\n                try {\r\n                    setDebugStatMultiplierOverride(\r\n                        spawnRateKey,\r\n                        getGameStatMultiplier(spawnRateKey),\r\n                        latestSlot\r\n                    );\r\n                } catch {}\r\n            } else {\r\n                getEffectiveStatMultiplierOverride(\r\n                    spawnRateKey,\r\n                    latestSlot,\r\n                    getGameStatMultiplier(spawnRateKey)\r\n                );\r\n            }\r\n            spawnRateRow.setValue(getStatMultiplierDisplayValue(spawnRateKey, latestSlot));\r\n        },\r\n    });\r\n\r\n    registerLiveBinding({\r\n        type: 'stat-mult',\r\n        key: spawnRateKey,\r\n        slot,\r\n        refresh: () => {\r\n            if (slot !== getActiveSlot()) return;\r\n            const latest = getStatMultiplierDisplayValue(spawnRateKey, slot);\r\n            spawnRateRow.setValue(latest);\r\n        },\r\n    });\r\n\r\n    registerLiveBinding({\r\n        type: 'upgrade',\r\n        key: spawnRateKey,\r\n        slot,\r\n        refresh: () => {\r\n            if (slot !== getActiveSlot()) return;\r\n            const latest = getStatMultiplierDisplayValue(spawnRateKey, slot);\r\n            spawnRateRow.setValue(latest);\r\n        },\r\n    });\r\n\r\n    container.appendChild(spawnRateRow.row);\r\n\r\n    const xp = getXpState();\r\n    const mutation = getMutationState();\r\n    const areaLabel = area?.title ?? area?.key ?? 'Unknown Area';\r\n\r\n    const xpLevelKey = XP_KEYS.level(slot);\r\n    const xpLevelRow = createInputRow('XP Level', xp.xpLevel, (value, { setValue }) => {\r\n        const prev = getXpState().xpLevel;\r\n        applyXpState({ level: value });\r\n        const latest = getXpState();\r\n        setValue(latest.xpLevel);\r\n        if (!bigNumEquals(prev, latest.xpLevel)) {\r\n            flagDebugUsage();\r\n            logAction(`Modified XP Level (${areaLabel}) ${formatNumber(prev)} \u2192 ${formatNumber(latest.xpLevel)}`);\r\n        }\r\n    }, { storageKey: xpLevelKey });\r\n    registerLiveBinding({\r\n        type: 'xp',\r\n        slot,\r\n        refresh: () => {\r\n            if (slot !== getActiveSlot()) return;\r\n            xpLevelRow.setValue(getXpState().xpLevel);\r\n        },\r\n    });\r\n    container.appendChild(xpLevelRow.row);\r\n\r\n    const xpProgressKey = XP_KEYS.progress(slot);\r\n    const xpProgressRow = createInputRow('XP Progress', xp.progress, (value, { setValue }) => {\r\n        const prev = getXpState();\r\n        const prevLevel = prev?.xpLevel?.clone?.() ?? prev?.xpLevel;\r\n        const prevProgress = prev?.progress?.clone?.() ?? prev?.progress;\r\n        applyXpState({ progress: value });\r\n        const latest = getXpState();\r\n        setValue(latest.progress);\r\n        xpLevelRow.setValue(latest.xpLevel);\r\n        if (!bigNumEquals(prevProgress, latest.progress) || !bigNumEquals(prevLevel, latest.xpLevel)) {\r\n            flagDebugUsage();\r\n            logAction(`Modified XP Progress (${areaLabel}) ${formatNumber(prevProgress)} \u2192 ${formatNumber(latest.progress)}`);\r\n        }\r\n    }, { storageKey: xpProgressKey });\r\n    registerLiveBinding({\r\n        type: 'xp',\r\n        slot,\r\n        refresh: () => {\r\n            if (slot !== getActiveSlot()) return;\r\n            xpProgressRow.setValue(getXpState().progress);\r\n        },\r\n    });\r\n    container.appendChild(xpProgressRow.row);\r\n\r\n    const mpLevelKey = MUTATION_KEYS.level(slot);\r\n    const mpLevelRow = createInputRow('MP Level', mutation.level, (value, { setValue }) => {\r\n        const prev = getMutationState().level;\r\n        applyMutationState({ level: value });\r\n        const latest = getMutationState();\r\n        setValue(latest.level);\r\n        if (!bigNumEquals(prev, latest.level)) {\r\n            flagDebugUsage();\r\n            logAction(`Modified MP Level (${areaLabel}) ${formatNumber(prev)} \u2192 ${formatNumber(latest.level)}`);\r\n        }\r\n    }, { storageKey: mpLevelKey });\r\n    registerLiveBinding({\r\n        type: 'mutation',\r\n        slot,\r\n        refresh: () => {\r\n            if (slot !== getActiveSlot()) return;\r\n            mpLevelRow.setValue(getMutationState().level);\r\n        },\r\n    });\r\n    container.appendChild(mpLevelRow.row);\r\n\r\n    const mpProgressKey = MUTATION_KEYS.progress(slot);\r\n    const mpProgressRow = createInputRow('MP Progress', mutation.progress, (value, { setValue }) => {\r\n        const prev = getMutationState();\r\n        const prevLevel = prev?.level?.clone?.() ?? prev?.level;\r\n        const prevProgress = prev?.progress?.clone?.() ?? prev?.progress;\r\n        applyMutationState({ progress: value });\r\n        const latest = getMutationState();\r\n        setValue(latest.progress);\r\n        mpLevelRow.setValue(latest.level);\r\n        if (!bigNumEquals(prevProgress, latest.progress) || !bigNumEquals(prevLevel, latest.level)) {\r\n            flagDebugUsage();\r\n            logAction(`Modified MP Progress (${areaLabel}) ${formatNumber(prevProgress)} \u2192 ${formatNumber(latest.progress)}`);\r\n        }\r\n    }, { storageKey: mpProgressKey });\r\n    registerLiveBinding({\r\n        type: 'mutation',\r\n        slot,\r\n        refresh: () => {\r\n            if (slot !== getActiveSlot()) return;\r\n            mpProgressRow.setValue(getMutationState().progress);\r\n        },\r\n    });\r\n    container.appendChild(mpProgressRow.row);\r\n\t\r\n\t    // Workshop Level\r\n    const genLevelKey = getGenerationLevelKey(slot);\r\n    if (genLevelKey) {\r\n        let currentGenLevel = 0;\r\n        try {\r\n            const raw = localStorage.getItem(genLevelKey);\r\n            const bn = BigNum.fromAny(raw || '0');\r\n            if (bn.isInfinite()) {\r\n                currentGenLevel = Infinity;\r\n            } else {\r\n                try {\r\n                    currentGenLevel = Number(bn.toScientific(20));\r\n                } catch {\r\n                    currentGenLevel = 0;\r\n                }\r\n            }\r\n        } catch {}\r\n\r\n        const genLevelRow = createInputRow('Workshop Level', currentGenLevel, (value, { setValue }) => {\r\n            // Helper to get a finite number from input, which might be BigNum or string/number\r\n            let valNum = Number(value);\r\n\r\n            if (value instanceof BigNum) {\r\n                 if (value.isInfinite()) {\r\n                     valNum = Infinity; \r\n                 } else {\r\n                     try {\r\n                        // Use a large enough precision for toScientific to preserve the exponent\r\n                        // toScientific(20) returns e.g. \"1.000...e21\"\r\n                        valNum = Number(value.toScientific(20));\r\n                     } catch {\r\n                        valNum = NaN;\r\n                     }\r\n                 }\r\n            }\r\n\r\n            if (Number.isNaN(valNum) || valNum < 0) return;\r\n            const cleanVal = (valNum === Infinity) ? 'Infinity' : String(Math.floor(valNum));\r\n            \r\n            try {\r\n                localStorage.setItem(genLevelKey, cleanVal);\r\n                flagDebugUsage();\r\n                logAction(`Modified Workshop Level (The Cove) ${formatNumber(currentGenLevel)} \u2192 ${cleanVal}`);\r\n                currentGenLevel = valNum;\r\n            } catch {}\r\n            \r\n            setValue(valNum);\r\n        }, {\r\n            storageKey: genLevelKey,\r\n            onLockChange: () => {\r\n                let newVal = 0;\r\n                try {\r\n                    const r = localStorage.getItem(genLevelKey);\r\n                    const bn = BigNum.fromAny(r || '0');\r\n                    if (bn.isInfinite()) newVal = Infinity;\r\n                    else newVal = Number(bn.toScientific(20));\r\n                } catch {}\r\n                genLevelRow.setValue(newVal);\r\n            }\r\n        });\r\n        \r\n        container.appendChild(genLevelRow.row);\r\n\r\n        registerLiveBinding({\r\n            type: 'workshop-level',\r\n            slot,\r\n            refresh: () => {\r\n                if (slot !== getActiveSlot()) return;\r\n                let newVal = 0;\r\n                try {\r\n                    const r = localStorage.getItem(genLevelKey);\r\n                    const bn = BigNum.fromAny(r || '0');\r\n                    if (bn.isInfinite()) newVal = Infinity;\r\n                    else newVal = Number(bn.toScientific(20));\r\n                } catch {}\r\n                genLevelRow.setValue(newVal);\r\n            }\r\n        });\r\n    }\r\n\r\n    // Surge Level\r\n    const surgeLevelKey = getSurgeBarLevelKey(slot);\r\n    if (surgeLevelKey) {\r\n        let currentSurgeLevel = 0;\r\n        try {\r\n            const raw = localStorage.getItem(surgeLevelKey);\r\n            if (raw === 'Infinity') {\r\n                currentSurgeLevel = Infinity;\r\n            } else {\r\n                currentSurgeLevel = BigNum.fromAny(raw || '0');\r\n            }\r\n        } catch {\r\n            currentSurgeLevel = BigNum.fromInt(0);\r\n        }\r\n\r\n        const surgeLevelRow = createInputRow('Surge Level', currentSurgeLevel, (value, { setValue }) => {\r\n            let valToStore = '0';\r\n            let valForDisplay = 0;\r\n\r\n            if (value instanceof BigNum) {\r\n                 if (value.isInfinite()) {\r\n                     valToStore = 'Infinity';\r\n                     valForDisplay = Infinity;\r\n                 } else {\r\n                     valToStore = value.toPlainIntegerString();\r\n                     valForDisplay = value;\r\n                 }\r\n            } else if (value === Infinity || (typeof value === 'string' && /infinity/i.test(value))) {\r\n                 valToStore = 'Infinity';\r\n                 valForDisplay = Infinity;\r\n            } else {\r\n                 valToStore = String(value);\r\n                 valForDisplay = value;\r\n            }\r\n\r\n            try {\r\n                localStorage.setItem(surgeLevelKey, valToStore);\r\n                flagDebugUsage();\r\n                \r\n                const displayStr = valForDisplay === Infinity ? 'Infinity' : formatNumber(valForDisplay);\r\n                const prevStr = (currentSurgeLevel === Infinity || (currentSurgeLevel instanceof BigNum && currentSurgeLevel.isInfinite())) \r\n                                ? 'Infinity' \r\n                                : formatNumber(currentSurgeLevel);\r\n                \r\n                logAction(`Modified Surge Level (The Cove) ${prevStr} \u2192 ${displayStr}`);\r\n                \r\n                if (valForDisplay === Infinity) {\r\n                    currentSurgeLevel = Infinity;\r\n                } else if (valForDisplay instanceof BigNum) {\r\n                    currentSurgeLevel = valForDisplay;\r\n                } else {\r\n                    currentSurgeLevel = BigNum.fromAny(valForDisplay);\r\n                }\r\n\r\n                // If setting level to >= 8, enforce Tsunami Nerf state immediately\r\n                let isSurge8 = false;\r\n                if (currentSurgeLevel === Infinity) {\r\n                    isSurge8 = true;\r\n                } else if (currentSurgeLevel instanceof BigNum) {\r\n                    // Check against 8\r\n                    if (typeof currentSurgeLevel.cmp === 'function' && currentSurgeLevel.cmp(8) >= 0) {\r\n                        isSurge8 = true;\r\n                    }\r\n                } else if (typeof currentSurgeLevel === 'number') {\r\n                    if (currentSurgeLevel >= 8) isSurge8 = true;\r\n                }\r\n\r\n                if (isSurge8) {\r\n                    setTsunamiNerf(0.00);\r\n                    if (!getTsunamiSequenceSeen()) {\r\n                        setTsunamiSequenceSeen(true);\r\n                    }\r\n                }\r\n            } catch {}\r\n            \r\n            setValue(valForDisplay);\r\n            try { window.resetSystem?.updateResetPanel?.(); } catch {}\r\n            try {\r\n                let eventLevel = currentSurgeLevel;\r\n                if (eventLevel !== Infinity && eventLevel instanceof BigNum) {\r\n                    try { eventLevel = BigInt(eventLevel.toPlainIntegerString()); } catch {}\r\n                }\r\n                window.dispatchEvent(new CustomEvent('surge:level:change', {\r\n                    detail: { slot, level: eventLevel }\r\n                }));\r\n            } catch {}\r\n        }, {\r\n            storageKey: surgeLevelKey,\r\n            onLockChange: (locked) => {\r\n                 let newVal = BigNum.fromInt(0);\r\n                 try {\r\n                    const r = localStorage.getItem(surgeLevelKey);\r\n                     if (r === 'Infinity') {\r\n                         newVal = Infinity;\r\n                     } else {\r\n                         newVal = BigNum.fromAny(r || '0');\r\n                     }\r\n                 } catch {}\r\n                 surgeLevelRow.setValue(newVal);\r\n            }\r\n        });\r\n        \r\n        registerLiveBinding({\r\n            type: 'surge-level', \r\n            slot,\r\n            refresh: () => {\r\n                 if (slot !== getActiveSlot()) return;\r\n                 let newVal = BigNum.fromInt(0);\r\n                 try {\r\n                    const r = localStorage.getItem(surgeLevelKey);\r\n                     if (r === 'Infinity') {\r\n                         newVal = Infinity;\r\n                     } else {\r\n                         newVal = BigNum.fromAny(r || '0');\r\n                     }\r\n                 } catch {}\r\n                 surgeLevelRow.setValue(newVal);\r\n            }\r\n        });\r\n        \r\n        container.appendChild(surgeLevelRow.row);\r\n    }\r\n\r\n    // Lab Level\r\n    const labLevel = getLabLevel();\r\n    const labLevelRow = createInputRow('Lab Level', labLevel, (value, { setValue }) => {\r\n        let valBn;\r\n        try {\r\n             valBn = value instanceof BigNum ? value : BigNum.fromAny(value);\r\n             if (valBn.isNegative && valBn.isNegative()) valBn = BigNum.fromInt(0);\r\n        } catch {\r\n             setValue(getLabLevel());\r\n             return;\r\n        }\r\n\r\n        const prev = getLabLevel();\r\n        setLabLevel(valBn);\r\n        \r\n        flagDebugUsage();\r\n        if (!bigNumEquals(prev, valBn)) {\r\n            logAction(`Modified Lab Level (The Cove) ${formatNumber(prev)} \u2192 ${formatNumber(valBn)}`);\r\n        }\r\n        setValue(valBn);\r\n    }, {\r\n        storageKey: getLabLevelKey(slot)\r\n    });\r\n    \r\n    registerLiveBinding({\r\n        type: 'lab-level',\r\n        slot,\r\n        refresh: () => {\r\n            if (slot !== getActiveSlot()) return;\r\n            labLevelRow.setValue(getLabLevel());\r\n        }\r\n    });\r\n    \r\n    container.appendChild(labLevelRow.row);\r\n\r\n    // Tsunami Exponent\r\n    // This value is 0.00 when the tsunami is fully active (nerfing everything),\r\n    // and goes up to 1.00 (restored) as you gain Surge Levels.\r\n    // We display it as a decimal (0.00 - 1.00).\r\n    // The displayed value includes the Research Lab bonus.\r\n    const getEffectiveTsunamiNerf = () => {\r\n        const base = getTsunamiNerf();\r\n        const bonus = getTsunamiResearchBonus();\r\n        let val = base + bonus;\r\n        if (val > 1) val = 1;\r\n        return val;\r\n    };\r\n\r\n    const tsunamiRow = createInputRow('Tsunami Exponent', getEffectiveTsunamiNerf().toFixed(2), (value, { setValue }) => {\r\n        let valNum = Number(value);\r\n        \r\n        // Handle BigNum inputs or \"inf\"\r\n        if (value instanceof BigNum) {\r\n             if (value.isInfinite()) valNum = Infinity;\r\n             else valNum = Number(value.toScientific(10));\r\n        } else if (typeof value === 'string' && /infinity/i.test(value)) {\r\n             valNum = Infinity;\r\n        }\r\n\r\n        if (Number.isNaN(valNum)) {\r\n             setValue(getEffectiveTsunamiNerf().toFixed(2));\r\n             return;\r\n        }\r\n        \r\n        // The user is inputting the *effective* value they want.\r\n        // We need to calculate what base value produces that effective value.\r\n        // Effective = Base + Bonus\r\n        // Base = Effective - Bonus\r\n        \r\n        const bonus = getTsunamiResearchBonus();\r\n        let targetBase = valNum - bonus;\r\n        \r\n        // Clamp base to [0, 1] (logic from before, though strictly it should be 0 to 1)\r\n        if (targetBase > 1) targetBase = 1;\r\n        // It's possible for targetBase to be < 0 if they input something smaller than the bonus.\r\n        // In that case, we set base to 0.\r\n        if (targetBase < 0) targetBase = 0;\r\n        \r\n        // Round base to 2 decimal places to keep it clean\r\n        targetBase = Math.round(targetBase * 100) / 100;\r\n\r\n        const prevBase = getTsunamiNerf();\r\n        setTsunamiNerf(targetBase);\r\n        \r\n        flagDebugUsage();\r\n        if (Math.abs(prevBase - targetBase) > 0.0001) {\r\n            logAction(`Modified Tsunami Exponent (The Cove) Base:${prevBase.toFixed(2)} \u2192 ${targetBase.toFixed(2)} (Effective: ${valNum.toFixed(2)})`);\r\n        }\r\n        setValue(getEffectiveTsunamiNerf().toFixed(2));\r\n    }, {\r\n        storageKey: getTsunamiNerfKey(slot),\r\n        format: (val) => {\r\n            // Ensure we format nicely as a number with 2 decimals if possible\r\n            const n = Number(val);\r\n            return Number.isFinite(n) ? n.toFixed(2) : String(val);\r\n        }\r\n    });\r\n    \r\n    registerLiveBinding({\r\n        type: 'tsunami-nerf',\r\n        slot,\r\n        refresh: () => {\r\n            if (slot !== getActiveSlot()) return;\r\n            const val = getEffectiveTsunamiNerf();\r\n            tsunamiRow.setValue(val.toFixed(2));\r\n        }\r\n    });\r\n    container.appendChild(tsunamiRow.row);\r\n}\r\n\r\nfunction buildAreaUpgrades(container, area) {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) {\r\n        const msg = document.createElement('div');\r\n        msg.className = 'debug-panel-empty';\r\n        msg.textContent = 'Select a save slot to edit upgrades.';\r\n        container.appendChild(msg);\r\n        return;\r\n    }\r\n\r\n    const upgrades = getUpgradesForArea(area.key);\r\n    if (!upgrades || upgrades.length === 0) {\r\n        const msg = document.createElement('div');\r\n        msg.className = 'debug-panel-empty';\r\n        msg.textContent = 'No upgrades found for this area yet.';\r\n        container.appendChild(msg);\r\n        return;\r\n    }\r\n\r\n    const areaLabel = area?.title ?? area?.key ?? 'Unknown Area';\r\n\r\n    upgrades.forEach((upg) => {\r\n        const idLabel = upg.id ?? upg.tie ?? upg.tieKey;\r\n        const title = upg.title || `Upgrade ${idLabel ?? ''}`.trim();\r\n        const current = getLevel(area.key, upg.id ?? upg.tie);\r\n        const storageKey = getUpgradeStorageKey(area.key, upg.id ?? upg.tie, slot);\r\n        const upgradeRow = createInputRow(title, current, (value, { setValue }) => {\r\n            const latestSlot = getActiveSlot();\r\n            if (latestSlot == null) return;\r\n            const previous = getLevel(area.key, upg.id ?? upg.tie);\r\n            try { setLevel(area.key, upg.id ?? upg.tie, value, false); } catch {}\r\n            const refreshed = getLevel(area.key, upg.id ?? upg.tie);\r\n            setValue(refreshed);\r\n            if (!bigNumEquals(previous, refreshed)) {\r\n                flagDebugUsage();\r\n                logAction(`Modified ${title} (${areaLabel} - ID: ${idLabel ?? 'Unknown'}) Lv${formatNumber(previous)} \u2192 Lv${formatNumber(refreshed)}`);\r\n            }\r\n        }, { idLabel, storageKey });\r\n        registerLiveBinding({\r\n            type: 'upgrade',\r\n            slot,\r\n            refresh: () => {\r\n                if (slot !== getActiveSlot()) return;\r\n                const refreshed = getLevel(area.key, upg.id ?? upg.tie);\r\n                upgradeRow.setValue(refreshed);\r\n            },\r\n        });\r\n        container.appendChild(upgradeRow.row);\r\n    });\r\n}\r\n\r\nfunction buildAreaCurrencyMultipliers(container, area) {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) {\r\n        const msg = document.createElement('div');\r\n        msg.className = 'debug-panel-empty';\r\n        msg.textContent = 'Select a save slot to edit currency multipliers.';\r\n        container.appendChild(msg);\r\n        return;\r\n    }\r\n\r\n    const areaLabel = area?.title ?? area?.key ?? 'Unknown Area';\r\n\r\n    area.currencies.forEach((currency) => {\r\n        const handle = bank?.[currency.key]?.mult;\r\n        const currentOverride = getDebugCurrencyMultiplierOverride(currency.key, slot);\r\n        const current = currentOverride ?? handle?.get?.() ?? BigNum.fromInt(1);\r\n        const storageKey = `${KEYS.MULTIPLIER[currency.key]}:${slot}`;\r\n        const row = createInputRow(`${currency.label} Multiplier`, current, (value, { setValue }) => {\r\n            const latestSlot = getActiveSlot();\r\n            if (latestSlot == null) return;\r\n            const previous = getDebugCurrencyMultiplierOverride(currency.key, latestSlot)\r\n                ?? handle?.get?.()\r\n                ?? BigNum.fromInt(1);\r\n            try { setDebugCurrencyMultiplierOverride(currency.key, value, latestSlot); } catch {}\r\n            applyAllCurrencyOverridesForActiveSlot();\r\n            const refreshedOverride = getDebugCurrencyMultiplierOverride(currency.key, latestSlot);\r\n            const refreshed = refreshedOverride ?? handle?.get?.() ?? BigNum.fromInt(1);\r\n            setValue(refreshed);\r\n            if (!bigNumEquals(previous, refreshed)) {\r\n                flagDebugUsage();\r\n                logAction(`Modified ${currency.label} Multiplier (${areaLabel}) ${formatNumber(previous)} \u2192 ${formatNumber(refreshed)}`);\r\n            }\r\n        }, { storageKey });\r\n        registerLiveBinding({\r\n            type: 'currency-mult',\r\n            key: currency.key,\r\n            slot,\r\n            refresh: () => {\r\n                if (slot !== getActiveSlot()) return;\r\n                const latestOverride = getDebugCurrencyMultiplierOverride(currency.key, slot);\r\n                const latest = latestOverride ?? handle?.get?.() ?? BigNum.fromInt(1);\r\n                row.setValue(latest);\r\n            },\r\n        });\r\n        container.appendChild(row.row);\r\n    });\r\n}\r\n\r\nfunction setAllCurrenciesToInfinity() {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) return 0;\r\n\r\n    const inf = BigNum.fromAny('Infinity');\r\n    let updated = 0;\r\n\r\n    Object.values(CURRENCIES).forEach((key) => {\r\n        const handle = bank?.[key];\r\n        if (!handle) return;\r\n        try {\r\n            const current = handle.value ?? handle.get?.();\r\n            const isAlreadyInf =\r\n                current?.isInfinite?.() ||\r\n                bigNumEquals(current, inf);\r\n\r\n            if (isAlreadyInf) return;\r\n\r\n            handle.set(inf);\r\n            updated += 1;\r\n        } catch {}\r\n    });\r\n\r\n    return updated;\r\n}\r\n\r\nfunction setAllCurrenciesToZero() {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) return 0;\r\n\r\n    const zero = BigNum.fromInt(0);\r\n    let updated = 0;\r\n\r\n    Object.values(CURRENCIES).forEach((key) => {\r\n        const handle = bank?.[key];\r\n        if (!handle) return;\r\n        try {\r\n            handle.set?.(zero);\r\n            updated += 1;\r\n        } catch {}\r\n    });\r\n\r\n    return updated;\r\n}\r\n\r\nfunction setAllStatsToInfinity() {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) return 0;\r\n\r\n    const inf = BigNum.fromAny('Infinity');\r\n    let touched = 0;\r\n\r\n    let xpState;\r\n    let mutationState;\r\n\r\n    try { xpState = getXpState(); } catch {}\r\n    try { mutationState = getMutationState(); } catch {}\r\n\r\n    // XP: only touch if unlocked and level/progress aren\u2019t already infinite\r\n    try {\r\n        if (xpState?.unlocked) {\r\n            const levelInf =\r\n                xpState?.xpLevel?.isInfinite?.() ||\r\n                bigNumEquals(xpState?.xpLevel, inf);\r\n            const progInf =\r\n                xpState?.progress?.isInfinite?.() ||\r\n                bigNumEquals(xpState?.progress, inf);\r\n\r\n            if (!levelInf || !progInf) {\r\n                applyXpState({ level: inf, progress: inf });\r\n                touched += 1; // count \"XP\" as one stat block\r\n            }\r\n        }\r\n    } catch {}\r\n\r\n    // MP / Mutation: only if unlocked\r\n    try {\r\n        if (mutationState?.unlocked) {\r\n            const levelInf =\r\n                mutationState?.level?.isInfinite?.() ||\r\n                bigNumEquals(mutationState?.level, inf);\r\n            const progInf =\r\n                mutationState?.progress?.isInfinite?.() ||\r\n                bigNumEquals(mutationState?.progress, inf);\r\n\r\n            if (!levelInf || !progInf) {\r\n                applyMutationState({ level: inf, progress: inf });\r\n                touched += 1; // count \"MP\" as one stat block\r\n            }\r\n        }\r\n    } catch {}\r\n\r\n    // Workshop Level\r\n    try {\r\n        const genLevelKey = getGenerationLevelKey(slot);\r\n        if (genLevelKey) {\r\n            const raw = localStorage.getItem(genLevelKey);\r\n            const current = parseFloat(raw || '0');\r\n            if (current !== Infinity) {\r\n                localStorage.setItem(genLevelKey, 'Infinity');\r\n                touched += 1;\r\n            }\r\n        }\r\n    } catch {}\r\n\r\n    // Surge Level\r\n    try {\r\n        const surgeLevelKey = getSurgeBarLevelKey(slot);\r\n        if (surgeLevelKey) {\r\n            const raw = localStorage.getItem(surgeLevelKey);\r\n            if (raw !== 'Infinity') {\r\n                localStorage.setItem(surgeLevelKey, 'Infinity');\r\n                touched += 1;\r\n                try {\r\n                    window.dispatchEvent(new CustomEvent('surge:level:change', {\r\n                        detail: { slot, level: Infinity }\r\n                    }));\r\n                } catch {}\r\n            }\r\n        }\r\n    } catch {}\r\n\r\n    try { window.resetSystem?.updateResetPanel?.(); } catch {}\r\n\r\n    try { refreshLiveBindings(); } catch {}\r\n\r\n    return touched;\r\n}\r\n\r\nfunction setAllStatsToZero() {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) return 0;\r\n\r\n    const zero = BigNum.fromInt(0);\r\n    let touched = 0;\r\n\r\n    let xpState;\r\n    let mutationState;\r\n\r\n    try { xpState = getXpState(); } catch {}\r\n    try { mutationState = getMutationState(); } catch {}\r\n\r\n    try {\r\n        if (xpState?.unlocked) {\r\n            applyXpState({ level: zero, progress: zero });\r\n            touched += 1;\r\n        }\r\n    } catch {}\r\n\r\n    try {\r\n        if (mutationState?.unlocked) {\r\n            applyMutationState({ level: zero, progress: zero });\r\n            touched += 1;\r\n        }\r\n    } catch {}\r\n\r\n    // Workshop Level\r\n    try {\r\n        const genLevelKey = getGenerationLevelKey(slot);\r\n        if (genLevelKey) {\r\n            const raw = localStorage.getItem(genLevelKey);\r\n            if (raw !== '0') {\r\n                localStorage.setItem(genLevelKey, '0');\r\n                touched += 1;\r\n            }\r\n        }\r\n    } catch {}\r\n\r\n    // Surge Level\r\n    try {\r\n        const surgeLevelKey = getSurgeBarLevelKey(slot);\r\n        if (surgeLevelKey) {\r\n            const raw = localStorage.getItem(surgeLevelKey);\r\n            if (raw !== '0') {\r\n                localStorage.setItem(surgeLevelKey, '0');\r\n                touched += 1;\r\n                try {\r\n                    window.dispatchEvent(new CustomEvent('surge:level:change', {\r\n                        detail: { slot, level: 0n }\r\n                    }));\r\n                } catch {}\r\n            }\r\n        }\r\n    } catch {}\r\n\r\n    try { window.resetSystem?.updateResetPanel?.(); } catch {}\r\n\r\n    try { refreshLiveBindings(); } catch {}\r\n\r\n    return touched;\r\n}\r\n\r\nfunction getUnlockRowDefinitions(slot) {\r\n    return [\r\n        {\r\n            labelText: 'Unlock XP',\r\n            description: 'If true, unlocks the XP system',\r\n            isUnlocked: () => {\r\n                try { return !!getXpState()?.unlocked; }\r\n                catch { return false; }\r\n            },\r\n            onEnable: () => {\r\n                try { unlockXpSystem(); }\r\n                catch {}\r\n                try { initXpSystem({ forceReload: true }); }\r\n                catch {}\r\n            },\r\n            onDisable: () => {\r\n                try { resetXpProgress({ keepUnlock: false }); }\r\n                catch {}\r\n                try { window.resetSystem?.setForgeDebugOverride?.(false); }\r\n                catch {}\r\n                try { window.resetSystem?.updateResetPanel?.(); }\r\n                catch {}\r\n            },\r\n            slot,\r\n        },\r\n\t\t{\r\n            labelText: 'Unlock Warp',\r\n            description: 'If true, unlocks the Warp tab',\r\n            isUnlocked: () => {\r\n                try { return window.resetSystem?.hasDoneSurgeReset?.() ?? false; }\r\n                catch { return false; }\r\n            },\r\n            onEnable: () => {\r\n                try { window.resetSystem?.setSurgeResetCompleted?.(true); }\r\n                catch {}\r\n                try { window.resetSystem?.updateResetPanel?.(); }\r\n                catch {}\r\n            },\r\n            onDisable: () => {\r\n                try { window.resetSystem?.setSurgeResetCompleted?.(false); }\r\n                catch {}\r\n                try { window.resetSystem?.updateResetPanel?.(); }\r\n                catch {}\r\n            },\r\n            slot,\r\n        },\r\n        {\r\n            labelText: 'Unlock Workshop',\r\n            description: 'If true, unlocks the Workshop tab',\r\n            isUnlocked: () => {\r\n                try { return window.resetSystem?.hasDoneInfuseReset?.() ?? false; }\r\n                catch { return false; }\r\n            },\r\n            onEnable: () => {\r\n                try { window.resetSystem?.setInfuseResetCompleted?.(true); }\r\n                catch {}\r\n                try { window.resetSystem?.updateResetPanel?.(); }\r\n                catch {}\r\n            },\r\n            onDisable: () => {\r\n                try { window.resetSystem?.setInfuseResetCompleted?.(false); }\r\n                catch {}\r\n                try { window.resetSystem?.updateResetPanel?.(); }\r\n                catch {}\r\n            },\r\n            slot,\r\n        },\r\n\t\t{\r\n            labelText: 'Unlock MP',\r\n            description: 'If true, unlocks the MP system',\r\n            isUnlocked: () => {\r\n                try { return window.resetSystem?.hasDoneForgeReset?.() ?? false; }\r\n                catch { return false; }\r\n            },\r\n            onEnable: () => {\r\n                try { window.resetSystem?.setForgeResetCompleted?.(true); }\r\n                catch {}\r\n                try { setMutationUnlockedForDebug(true); }\r\n                catch {}\r\n                try { window.resetSystem?.updateResetPanel?.(); }\r\n                catch {}\r\n            },\r\n            onDisable: () => {\r\n                try { window.resetSystem?.setForgeResetCompleted?.(false); }\r\n                catch {}\r\n                try { setMutationUnlockedForDebug(false); }\r\n                catch {}\r\n                try { window.resetSystem?.updateResetPanel?.(); }\r\n                catch {}\r\n            },\r\n            slot,\r\n        },\r\n        {\r\n            labelText: 'Unlock Forge',\r\n            description: 'If true, unlocks the Forge reset and Reset tab',\r\n            isUnlocked: () => {\r\n                try {\r\n                    const override = window.resetSystem?.getForgeDebugOverrideState?.();\r\n                    if (override != null) return override;\r\n                } catch {}\r\n                try { return !!window.resetSystem?.isForgeUnlocked?.(); }\r\n                catch { return false; }\r\n                return false;\r\n            },\r\n            onEnable: () => {\r\n                try { window.resetSystem?.setForgeDebugOverride?.(true); }\r\n                catch {}\r\n                try { window.resetSystem?.updateResetPanel?.(); }\r\n                catch {}\r\n            },\r\n            onDisable: () => {\r\n                try { window.resetSystem?.setForgeDebugOverride?.(false); }\r\n                catch {}\r\n                try { window.resetSystem?.updateResetPanel?.(); }\r\n                catch {}\r\n            },\r\n        },\r\n        {\r\n            labelText: 'Unlock Infuse',\r\n            description: 'If true, unlocks the Infuse reset',\r\n            isUnlocked: () => {\r\n                try {\r\n                    const override = window.resetSystem?.getInfuseDebugOverrideState?.();\r\n                    if (override != null) return override;\r\n                } catch {}\r\n                try { return !!window.resetSystem?.isInfuseUnlocked?.(); }\r\n                catch { return false; }\r\n            },\r\n            onEnable: () => {\r\n                try { window.resetSystem?.setInfuseUnlockedForDebug?.(true); }\r\n                catch {}\r\n                try { window.resetSystem?.updateResetPanel?.(); }\r\n                catch {}\r\n            },\r\n            onDisable: () => {\r\n                try { window.resetSystem?.setInfuseUnlockedForDebug?.(false); }\r\n                catch {}\r\n                try { window.resetSystem?.updateResetPanel?.(); }\r\n                catch {}\r\n            },\r\n            slot,\r\n        },\r\n\t\t{\r\n            labelText: 'Unlock Surge',\r\n            description: 'If true, unlocks the Surge reset',\r\n            isUnlocked: () => {\r\n                try {\r\n                    const override = window.resetSystem?.getSurgeDebugOverrideState?.();\r\n                    if (override != null) return override;\r\n                } catch {}\r\n                try { return !!window.resetSystem?.isSurgeUnlocked?.(); }\r\n                catch { return false; }\r\n            },\r\n            onEnable: () => {\r\n                try { window.resetSystem?.setSurgeUnlockedForDebug?.(true); }\r\n                catch {}\r\n                try { window.resetSystem?.updateResetPanel?.(); }\r\n                catch {}\r\n            },\r\n            onDisable: () => {\r\n                try { window.resetSystem?.setSurgeUnlockedForDebug?.(false); }\r\n                catch {}\r\n                try { window.resetSystem?.updateResetPanel?.(); }\r\n                catch {}\r\n            },\r\n            slot,\r\n        },\r\n        {\r\n            labelText: 'Unlock Shop',\r\n            description: 'If true, makes the Shop button visible',\r\n            isUnlocked: () => {\r\n                try { return isShopUnlocked(); }\r\n                catch { return false; }\r\n            },\r\n            onEnable: () => {\r\n                try { unlockShop(); }\r\n                catch {}\r\n            },\r\n            onDisable: () => {\r\n                try { lockShop(); }\r\n                catch {}\r\n            },\r\n            slot,\r\n        },\r\n        {\r\n            labelText: 'Unlock Map',\r\n            description: 'If true, makes the Map button visible',\r\n            isUnlocked: () => {\r\n                try { return isMapUnlocked(); }\r\n                catch { return false; }\r\n            },\r\n            onEnable: () => {\r\n                try { unlockMap(); }\r\n                catch {}\r\n            },\r\n            onDisable: () => {\r\n                try { lockMap(); }\r\n                catch {}\r\n            },\r\n            slot,\r\n        },\r\n\r\n        {\r\n            labelText: 'Unlock Jeff',\r\n            description: 'If true, changes the Merchant\\'s name to Jeff',\r\n            isUnlocked: () => {\r\n                try { return isJeffUnlocked(); }\r\n                catch { return false; }\r\n            },\r\n            onEnable: () => {\r\n                try { setJeffUnlocked(true); }\r\n                catch {}\r\n            },\r\n            onDisable: () => {\r\n                try { setJeffUnlocked(false); }\r\n                catch {}\r\n            },\r\n            slot,\r\n        },\r\n        {\r\n            labelText: 'Unlock Tsunami',\r\n            description: 'If true, marks the Tsunami sequence as seen',\r\n            isUnlocked: () => {\r\n                try { return !!getTsunamiSequenceSeen(); }\r\n                catch { return false; }\r\n            },\r\n            onEnable: () => {\r\n                try { setTsunamiSequenceSeen(true); }\r\n                catch {}\r\n            },\r\n            onDisable: () => {\r\n                try { setTsunamiSequenceSeen(false); }\r\n                catch {}\r\n            },\r\n            slot,\r\n        },\r\n        {\r\n            labelText: 'Unlock Experiment',\r\n            description: 'If true, Lab node 4 is maxed',\r\n            isUnlocked: () => {\r\n                try { return getResearchNodeLevel(4) >= 1; }\r\n                catch { return false; }\r\n            },\r\n            onEnable: () => {\r\n                try { setResearchNodeLevel(4, 1); }\r\n                catch {}\r\n                try { window.resetSystem?.updateResetPanel?.(); }\r\n                catch {}\r\n            },\r\n            onDisable: () => {\r\n                try { setResearchNodeLevel(4, 0); }\r\n                catch {}\r\n                try { window.resetSystem?.updateResetPanel?.(); }\r\n                catch {}\r\n            },\r\n            slot,\r\n        },\r\n        {\r\n            labelText: 'Unlock Past N4',\r\n            description: 'If true, unlocks Lab nodes past node 4',\r\n            isUnlocked: () => {\r\n                try { return !!window.resetSystem?.hasDoneExperimentReset?.(); }\r\n                catch { return false; }\r\n            },\r\n            onEnable: () => {\r\n                try { window.resetSystem?.setExperimentResetCompleted?.(true); }\r\n                catch {}\r\n                try { window.resetSystem?.updateResetPanel?.(); }\r\n                catch {}\r\n            },\r\n            onDisable: () => {\r\n                try { window.resetSystem?.setExperimentResetCompleted?.(false); }\r\n                catch {}\r\n                try { window.resetSystem?.updateResetPanel?.(); }\r\n                catch {}\r\n            },\r\n            slot,\r\n        },\r\n    ];\r\n}\r\n\r\nfunction setAllUnlockToggles(targetState) {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) return 0;\r\n\r\n    let toggled = 0;\r\n    getUnlockRowDefinitions(slot).forEach((rowDef) => {\r\n        let unlocked = false;\r\n        try { unlocked = typeof rowDef.isUnlocked === 'function' ? !!rowDef.isUnlocked() : false; }\r\n        catch {}\r\n\r\n        if (unlocked === targetState) return;\r\n\r\n        try {\r\n            if (targetState) {\r\n                rowDef.onEnable?.();\r\n            } else {\r\n                rowDef.onDisable?.();\r\n            }\r\n            toggled += 1;\r\n        } catch {}\r\n    });\r\n\r\n    try { refreshLiveBindings(); } catch {}\r\n\r\n    return toggled;\r\n}\r\n\r\nfunction unlockAllUnlocks() {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) return { unlocks: 0, toggles: 0 };\r\n    let unlocked = 0;\r\n    getAreas().forEach((area) => {\r\n        getUpgradesForArea(area.key).forEach((upg) => {\r\n            if (!upg?.unlockUpgrade) return;\r\n            try { markUpgradePermanentlyUnlocked(area.key, upg, slot); unlocked += 1; }\r\n            catch {}\r\n        });\r\n    });\r\n    try { unlockShop(); } catch {}\r\n    try { unlockMap(); } catch {}\r\n    const toggled = setAllUnlockToggles(true);\r\n    return { unlocks: unlocked, toggles: toggled };\r\n}\r\n\r\nfunction lockAllUnlockUpgrades() {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) return { locks: 0, toggles: 0 };\r\n    let locked = 0;\r\n    getAreas().forEach((area) => {\r\n        getUpgradesForArea(area.key).forEach((upg) => {\r\n            if (!upg?.unlockUpgrade) return;\r\n            try { clearPermanentUpgradeUnlock(area.key, upg, slot); locked += 1; }\r\n            catch {}\r\n        });\r\n    });\r\n    try { lockShop(); } catch {}\r\n    try { lockMap(); } catch {}\r\n    const toggled = setAllUnlockToggles(false);\r\n    return { locks: locked, toggles: toggled };\r\n}\r\n\r\nfunction getResetTargetLockKeys(target, slot = getActiveSlot()) {\r\n    const resolvedSlot = slot ?? getActiveSlot();\r\n    if (resolvedSlot == null) return [];\r\n\r\n    const keys = new Set();\r\n    const add = (key) => { if (key) keys.add(key); };\r\n\r\n    const addCurrencyKeys = (currencyKey) => {\r\n        add(getCurrencyStorageKey(currencyKey, resolvedSlot));\r\n        add(getCurrencyMultiplierStorageKey(currencyKey, resolvedSlot));\r\n    };\r\n\r\n    const addStatMultiplier = (statKey) => add(getStatMultiplierStorageKey(statKey, resolvedSlot));\r\n\r\n    const addStatKeys = (statKey) => {\r\n        addStatMultiplier(statKey);\r\n        if (statKey === 'xp' || statKey === 'xpLevel' || statKey === 'xpProgress') {\r\n            add(XP_KEYS.level(resolvedSlot));\r\n            add(XP_KEYS.progress(resolvedSlot));\r\n        }\r\n        if (statKey === 'mutation' || statKey === 'mp' || statKey === 'mpLevel' || statKey === 'mpProgress') {\r\n            add(MUTATION_KEYS.level(resolvedSlot));\r\n            add(MUTATION_KEYS.progress(resolvedSlot));\r\n        }\r\n    };\r\n\r\n    if (target === 'all') {\r\n        Object.values(CURRENCIES).forEach(addCurrencyKeys);\r\n        addStatKeys('xp');\r\n        addStatKeys('mutation');\r\n        STAT_MULTIPLIERS.forEach(({ key }) => addStatMultiplier(key));\r\n        return Array.from(keys);\r\n    }\r\n\r\n    if (target === 'allCurrencies') {\r\n        Object.values(CURRENCIES).forEach(addCurrencyKeys);\r\n        return Array.from(keys);\r\n    }\r\n\r\n    if (target === 'allUnlockedStats') {\r\n        if (getXpState()?.unlocked) addStatKeys('xp');\r\n        if (getMutationState()?.unlocked) addStatKeys('mutation');\r\n        return Array.from(keys);\r\n    }\r\n\r\n    if (target === 'allUnlocked') {\r\n        Object.values(CURRENCIES).forEach(addCurrencyKeys);\r\n        if (getXpState()?.unlocked) addStatKeys('xp');\r\n        if (getMutationState()?.unlocked) addStatKeys('mutation');\r\n        return Array.from(keys);\r\n    }\r\n\r\n    if (target.startsWith('currency:')) {\r\n        addCurrencyKeys(target.slice('currency:'.length));\r\n        return Array.from(keys);\r\n    }\r\n\r\n    if (target.startsWith('statmult:')) {\r\n        addStatMultiplier(target.slice('statmult:'.length));\r\n        return Array.from(keys);\r\n    }\r\n\r\n    if (target.startsWith('stat:')) {\r\n        addStatKeys(target.slice('stat:'.length));\r\n        return Array.from(keys);\r\n    }\r\n\r\n    return Array.from(keys);\r\n}\r\n\r\nfunction resetCurrencyAndMultiplier(currencyKey) {\r\n    try {\r\n        // Reset the banked amount\r\n        bank?.[currencyKey]?.set?.(BigNum.fromInt(0));\r\n    } catch {}\r\n\r\n    try {\r\n        // Clear any debug override for this currency\r\n        clearCurrencyMultiplierOverride(currencyKey);\r\n    } catch {}\r\n\r\n    try {\r\n        // Put the actual in-game multiplier back to 1x\r\n        setCurrencyMultiplierBN(currencyKey, BigNum.fromInt(1));\r\n    } catch {}\r\n}\r\n\r\nfunction resetStatsAndMultipliers(target) {\r\n    if (target === 'all') {\r\n        // All currencies + multipliers: clear overrides and put real multipliers back to 1x\r\n        Object.values(CURRENCIES).forEach((key) => resetCurrencyAndMultiplier(key));\r\n\r\n        const zero = BigNum.fromInt(0);\r\n\r\n        // XP + MP (mutation) state \u2192 0\r\n        applyXpState({ level: zero, progress: zero });\r\n        applyMutationState({ level: zero, progress: zero });\r\n\r\n        // For stats, behave like the stat multiplier debug field:\r\n        // create a temporary 1x override that will be auto-cleared on the next\r\n        // normal game multiplier update (XP Value, MP Value, etc.).\r\n        STAT_MULTIPLIERS.forEach(({ key }) => {\r\n            try { setDebugStatMultiplierOverride(key, BigNum.fromInt(1)); } catch {}\r\n        });\r\n\r\n        const totalCount = Object.values(CURRENCIES).length + STAT_MULTIPLIERS.length + 2; // XP + MP\r\n        return { label: '[GOLD]all[/GOLD] currency/stats', count: totalCount };\r\n    }\r\n\r\n    if (target === 'allCurrencies') {\r\n        let currencyCount = 0;\r\n        Object.values(CURRENCIES).forEach((key) => {\r\n            resetCurrencyAndMultiplier(key);\r\n            currencyCount += 1;\r\n        });\r\n\r\n        const label = currencyCount === 1 ? '1 currency' : `${currencyCount} currencies`;\r\n        return { label, count: currencyCount };\r\n    }\r\n\r\n    if (target === 'allUnlockedStats') {\r\n        const zero = BigNum.fromInt(0);\r\n        let resetCount = 0;\r\n\r\n        try {\r\n            if (getXpState()?.unlocked) {\r\n                applyXpState({ level: zero, progress: zero });\r\n                try { setDebugStatMultiplierOverride('xp', BigNum.fromInt(1)); } catch {}\r\n                resetCount += 1;\r\n            }\r\n        } catch {}\r\n\r\n        try {\r\n            if (getMutationState()?.unlocked) {\r\n                applyMutationState({ level: zero, progress: zero });\r\n                try { setDebugStatMultiplierOverride('mutation', BigNum.fromInt(1)); } catch {}\r\n                resetCount += 1;\r\n            }\r\n        } catch {}\r\n\r\n        const label = resetCount === 1 ? '1 unlocked stat' : `${resetCount} unlocked stats`;\r\n        return { label, count: resetCount };\r\n    }\r\n\r\n    if (target === 'allUnlocked') {\r\n        let currencyCount = 0;\r\n        Object.values(CURRENCIES).forEach((key) => {\r\n            resetCurrencyAndMultiplier(key);\r\n            currencyCount += 1;\r\n        });\r\n\r\n        const zero = BigNum.fromInt(0);\r\n        let resetCount = 0;\r\n\r\n        try {\r\n            if (getXpState()?.unlocked) {\r\n                applyXpState({ level: zero, progress: zero });\r\n                try { setDebugStatMultiplierOverride('xp', BigNum.fromInt(1)); } catch {}\r\n                resetCount += 1;\r\n            }\r\n        } catch {}\r\n\r\n        try {\r\n            if (getMutationState()?.unlocked) {\r\n                applyMutationState({ level: zero, progress: zero });\r\n                try { setDebugStatMultiplierOverride('mutation', BigNum.fromInt(1)); } catch {}\r\n                resetCount += 1;\r\n            }\r\n        } catch {}\r\n\r\n        const parts = [];\r\n\r\n        if (resetCount === 1) parts.push('1 unlocked stat');\r\n        else parts.push(`${resetCount} unlocked stats`);\r\n\r\n        parts.push(currencyCount === 1 ? '1 currency' : `${currencyCount} currencies`);\r\n\r\n        return { label: parts.join(' and '), count: resetCount + currencyCount };\r\n    }\r\n\r\n    if (target.startsWith('currency:')) {\r\n        const currencyKey = target.slice('currency:'.length);\r\n        resetCurrencyAndMultiplier(currencyKey);\r\n        return { label: `${currencyKey}`, count: 1 };\r\n    }\r\n\r\n    if (target.startsWith('statmult:')) {\r\n        const statKey = target.slice('statmult:'.length);\r\n        // \"Reset this stat multiplier\" = remove any debug override,\r\n        // let the game recalculate the multiplier normally.\r\n        try { clearStatMultiplierOverride(statKey); } catch {}\r\n        return { label: `${statKey} multiplier`, count: 1 };\r\n    }\r\n\r\n    if (!target.startsWith('stat:')) {\r\n        return { label: `unknown target ${target}`, count: 0 };\r\n    }\r\n\r\n    const statKey = target.slice('stat:'.length);\r\n    const zero = BigNum.fromInt(0);\r\n\r\n    // Treat any XP-related key as \"XP\": level + progress + multiplier.\r\n    if (statKey === 'xp' || statKey === 'xpLevel' || statKey === 'xpProgress') {\r\n        applyXpState({ level: zero, progress: zero });\r\n        // Temporarily force XP multiplier to 1x (override cleared on next real update)\r\n        try { setDebugStatMultiplierOverride('xp', BigNum.fromInt(1)); } catch {}\r\n        return { label: 'XP', count: 1 };\r\n    }\r\n\r\n    // Treat any MP / mutation key as \"MP\": level + progress + multiplier.\r\n    if (\r\n        statKey === 'mutation' ||\r\n        statKey === 'mp' ||\r\n        statKey === 'mpLevel' ||\r\n        statKey === 'mpProgress'\r\n    ) {\r\n        applyMutationState({ level: zero, progress: zero });\r\n        // Temporarily force MP multiplier to 1x, same semantics as XP\r\n        try { setDebugStatMultiplierOverride('mutation', BigNum.fromInt(1)); } catch {}\r\n        return 'MP';\r\n    }\r\n\r\n    // Fallback: generic stat multiplier reset -> same semantics as the debug stat input\r\n    try { setDebugStatMultiplierOverride(statKey, BigNum.fromInt(1)); } catch {}\r\n    return `stat ${statKey}`;\r\n}\r\n\r\nfunction buildAreaStatMultipliers(container, area) {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) {\r\n        const msg = document.createElement('div');\r\n        msg.className = 'debug-panel-empty';\r\n        msg.textContent = 'Select a save slot to edit stat multipliers.';\r\n        container.appendChild(msg);\r\n        return;\r\n    }\r\n\r\n    const areaLabel = area?.title ?? area?.key ?? 'Unknown Area';\r\n\r\n    STAT_MULTIPLIERS.forEach((stat) => {\r\n        if (stat.key === 'spawnRate') return;\r\n        const storageKey = getStatMultiplierStorageKey(stat.key, slot);\r\n        const row = createInputRow(\r\n            `${stat.label} Multiplier`,\r\n            getStatMultiplierDisplayValue(stat.key, slot),\r\n            (value, { setValue }) => {\r\n                const latestSlot = getActiveSlot();\r\n                if (latestSlot == null) return;\r\n                const previous = getStatMultiplierDisplayValue(stat.key, latestSlot);\r\n                try { setDebugStatMultiplierOverride(stat.key, value, latestSlot); } catch {}\r\n                const refreshed = getStatMultiplierDisplayValue(stat.key, latestSlot);\r\n                setValue(refreshed);\r\n                if (!bigNumEquals(previous, refreshed)) {\r\n                    flagDebugUsage();\r\n                    logAction(\r\n                        `Modified ${stat.label} Multiplier (${areaLabel}) ${formatNumber(previous)} \u2192 ${formatNumber(refreshed)}`\r\n                    );\r\n                }\r\n            },\r\n            {\r\n                storageKey,\r\n                onLockChange: (locked) => {\r\n                    const latestSlot = getActiveSlot();\r\n                    if (latestSlot == null) return;\r\n                    if (locked) {\r\n                        const existingOverride = getLockedStatOverride(latestSlot, stat.key);\r\n                        if (existingOverride) return;\r\n                        try {\r\n                            setDebugStatMultiplierOverride(\r\n                                stat.key,\r\n                                getGameStatMultiplier(stat.key),\r\n                                latestSlot\r\n                            );\r\n                        } catch {}\r\n                    } else {\r\n                        getEffectiveStatMultiplierOverride(\r\n                            stat.key,\r\n                            latestSlot,\r\n                            getGameStatMultiplier(stat.key)\r\n                        );\r\n                    }\r\n                    row.setValue(getStatMultiplierDisplayValue(stat.key, latestSlot));\r\n                },\r\n            }\r\n        );\r\n\r\n        registerLiveBinding({\r\n            type: 'stat-mult',\r\n            key: stat.key,\r\n            slot,\r\n            refresh: () => {\r\n                if (slot !== getActiveSlot()) return;\r\n                const latest = getStatMultiplierDisplayValue(stat.key, slot);\r\n                row.setValue(latest);\r\n            },\r\n        });\r\n\r\n        registerLiveBinding({\r\n            type: 'upgrade',\r\n            key: stat.key,\r\n            slot,\r\n            refresh: () => {\r\n                if (slot !== getActiveSlot()) return;\r\n                const latest = getStatMultiplierDisplayValue(stat.key, slot);\r\n                row.setValue(latest);\r\n            },\r\n        });\r\n\r\n        if (stat.key === 'mutation') {\r\n            registerLiveBinding({\r\n                type: 'mutation',\r\n                key: stat.key,\r\n                slot,\r\n                refresh: () => {\r\n                    if (slot !== getActiveSlot()) return;\r\n                    const latest = getStatMultiplierDisplayValue(stat.key, slot);\r\n                    row.setValue(latest);\r\n                },\r\n            });\r\n        }\r\n\r\n        container.appendChild(row.row);\r\n    });\r\n}\r\n\r\nfunction buildLabNodesDebug(container) {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) {\r\n        const msg = document.createElement('div');\r\n        msg.className = 'debug-panel-empty';\r\n        msg.textContent = 'Select a save slot to edit lab nodes.';\r\n        container.appendChild(msg);\r\n        return;\r\n    }\r\n\r\n    if (!RESEARCH_NODES || RESEARCH_NODES.length === 0) {\r\n        const msg = document.createElement('div');\r\n        msg.className = 'debug-panel-empty';\r\n        msg.textContent = 'No lab nodes found.';\r\n        container.appendChild(msg);\r\n        return;\r\n    }\r\n\r\n    RESEARCH_NODES.forEach((node) => {\r\n        const nodeContainer = createSubsection(`${node.title || `Node ${node.id}`} (ID: ${node.id})`, (sub) => {\r\n            // Level\r\n            const levelKey = NODE_LEVEL_KEY(slot, node.id);\r\n            const levelRow = createInputRow('Level', getResearchNodeLevel(node.id), (value, { setValue }) => {\r\n                let valNum = Number(value);\r\n                if (value instanceof BigNum) {\r\n                     valNum = value.isInfinite() ? Infinity : Number(value.toScientific(10));\r\n                }\r\n                if (Number.isNaN(valNum) || valNum < 0) return;\r\n                \r\n                // Allow up to maxLevel\r\n                if (valNum > node.maxLevel) valNum = node.maxLevel;\r\n                valNum = Math.floor(valNum);\r\n\r\n                const prev = getResearchNodeLevel(node.id);\r\n                setResearchNodeLevel(node.id, valNum);\r\n                flagDebugUsage();\r\n                \r\n                if (prev !== valNum) {\r\n                    logAction(`Modified Node ${node.id} Level (The Cove) ${prev} \u2192 ${valNum}`);\r\n                }\r\n                setValue(valNum);\r\n            }, {\r\n                storageKey: levelKey\r\n            });\r\n            registerLiveBinding({\r\n                type: 'lab-node-level',\r\n                slot,\r\n                id: node.id,\r\n                refresh: () => {\r\n                    if (slot !== getActiveSlot()) return;\r\n                    levelRow.setValue(getResearchNodeLevel(node.id));\r\n                }\r\n            });\r\n            sub.appendChild(levelRow.row);\r\n\r\n            // RP\r\n            const rpKey = NODE_RP_KEY(slot, node.id);\r\n            const rpRow = createInputRow('Current RP', getResearchNodeRp(node.id), (value, { setValue }) => {\r\n                let bn;\r\n                try {\r\n                     bn = value instanceof BigNum ? value : BigNum.fromAny(value);\r\n                     if (bn.isNegative && bn.isNegative()) bn = BigNum.fromInt(0);\r\n                } catch {\r\n                     setValue(getResearchNodeRp(node.id));\r\n                     return;\r\n                }\r\n\r\n                const prev = getResearchNodeRp(node.id);\r\n                setResearchNodeRp(node.id, bn);\r\n                flagDebugUsage();\r\n                \r\n                if (!bigNumEquals(prev, bn)) {\r\n                    logAction(`Modified Node ${node.id} RP (The Cove) ${formatNumber(prev)} \u2192 ${formatNumber(bn)}`);\r\n                }\r\n                setValue(bn);\r\n            }, {\r\n                storageKey: rpKey\r\n            });\r\n            registerLiveBinding({\r\n                type: 'lab-node-rp',\r\n                slot,\r\n                id: node.id,\r\n                refresh: () => {\r\n                    if (slot !== getActiveSlot()) return;\r\n                    rpRow.setValue(getResearchNodeRp(node.id));\r\n                }\r\n            });\r\n            sub.appendChild(rpRow.row);\r\n        });\r\n        container.appendChild(nodeContainer);\r\n    });\r\n}\r\n\r\nfunction buildAreaCalculators(container) {\r\n    const calculators = [\r\n        {\r\n            title: 'Currencies',\r\n            rows: [\r\n                {\r\n                    label: 'Pending Gold (Forge)',\r\n                    inputs: [\r\n                        { key: 'coins', label: 'Coins' },\r\n                        { key: 'xpLevel', label: 'XP Level' },\r\n                    ],\r\n                    compute: ({ coins, xpLevel }) => window.resetSystem?.computeForgeGoldFromInputs?.(coins, xpLevel),\r\n                },\r\n                {\r\n                    label: 'Pending Magic (Infuse)',\r\n                    inputs: [\r\n                        { key: 'coins', label: 'Coins' },\r\n                        { key: 'mp', label: 'Cumulative MP' },\r\n                    ],\r\n                    compute: ({ coins, mp }) => window.resetSystem?.computeInfuseMagicFromInputs?.(coins, mp),\r\n                },\r\n                {\r\n                    label: 'Pending Waves (Surge)',\r\n                    inputs: [\r\n                        { key: 'xpLevel', label: 'XP Level' },\r\n                        { key: 'coins', label: 'Coins' },\r\n                        { key: 'gold', label: 'Gold' },\r\n                        { key: 'magic', label: 'Magic' },\r\n                        { key: 'mp', label: 'Cumulative MP' },\r\n                    ],\r\n                    compute: ({ xpLevel, coins, gold, magic, mp }) => window.resetSystem?.computeSurgeWavesFromInputs?.(xpLevel, coins, gold, magic, mp),\r\n                },\r\n                {\r\n                    label: 'Pending DNA (Experiment)',\r\n                    inputs: [\r\n                        { key: 'labLevel', label: 'Lab Level' },\r\n                        { key: 'xpLevel', label: 'XP Level' },\r\n                        {\r\n                            key: 'isSurge9',\r\n                            type: 'select',\r\n                            defaultValue: 'No',\r\n                            options: [\r\n                                { value: 'No', label: 'Surge 9? No' },\r\n                                { value: 'Yes', label: 'Surge 9? Yes' },\r\n                            ],\r\n                        },\r\n                    ],\r\n                    compute: ({ labLevel, xpLevel, isSurge9 }) => window.resetSystem?.computePendingDnaFromInputs?.(labLevel, xpLevel, isSurge9 === 'Yes'),\r\n                },\r\n            ],\r\n        },\r\n        {\r\n            title: 'Stats',\r\n            rows: [\r\n                {\r\n                    label: 'XP Requirement',\r\n                    inputs: [\r\n                        { key: 'xpLevel', label: 'XP Level' },\r\n                    ],\r\n                    compute: ({ xpLevel }) => getXpRequirementForXpLevel(xpLevel),\r\n                },\r\n                {\r\n                    label: 'XP Level Coin Multiplier',\r\n                    inputs: [\r\n                        { key: 'xpLevel', label: 'XP Level' },\r\n                    ],\r\n                    compute: ({ xpLevel }) => computeCoinMultiplierForXpLevel(xpLevel),\r\n                },\r\n                {\r\n                    label: 'MP Requirement',\r\n                    inputs: [\r\n                        { key: 'mpLevel', label: 'MP Level' },\r\n                    ],\r\n                    compute: ({ mpLevel }) => computeMutationRequirementForLevel(mpLevel),\r\n                },\r\n                {\r\n                    label: 'MP Level Coin/XP Multiplier',\r\n                    inputs: [\r\n                        { key: 'mpLevel', label: 'MP Level' },\r\n                    ],\r\n                    compute: ({ mpLevel }) => computeMutationMultiplierForLevel(mpLevel),\r\n                },\r\n                {\r\n                    label: 'Workshop Level Cost',\r\n                    inputs: [\r\n                        { key: 'level', label: 'Level' },\r\n                    ],\r\n                    compute: ({ level }) => getGenerationUpgradeCost(level),\r\n                },\r\n                {\r\n                    label: 'Lab Level RP Boost',\r\n                    inputs: [\r\n                        { key: 'level', label: 'Lab Level' },\r\n                        {\r\n                            key: 'isSurge12',\r\n                            type: 'select',\r\n                            defaultValue: 'No',\r\n                            options: [\r\n                                { value: 'No', label: 'Surge 12? No' },\r\n                                { value: 'Yes', label: 'Surge 12? Yes' },\r\n                            ],\r\n                        },\r\n                    ],\r\n                    compute: ({ level, isSurge12 }) => {\r\n                        let lvlNum = 0;\r\n                        if (level instanceof BigNum) {\r\n                            if (level.isInfinite()) return BigNum.fromAny('Infinity');\r\n                            try {\r\n                                lvlNum = Number(level.toScientific(10));\r\n                            } catch { lvlNum = 0; }\r\n                        } else {\r\n                            lvlNum = Number(level);\r\n                        }\r\n                        \r\n                        if (!Number.isFinite(lvlNum)) return BigNum.fromInt(1);\r\n                        \r\n                        if (isSurge12 === 'Yes') {\r\n                            const effectiveNerf = getEffectiveTsunamiNerf();\r\n                            const multLog10 = 5 * effectiveNerf;\r\n                            const base = 2 + (effectiveNerf / 2);\r\n                            const logBase = Math.log10(base);\r\n                            const totalLog = (lvlNum * logBase) + multLog10;\r\n                            return bigNumFromLog10(totalLog);\r\n                        }\r\n                        \r\n                        const logVal = lvlNum * Math.log10(2);\r\n                        return bigNumFromLog10(logVal);\r\n                    },\r\n                },\r\n            ],\r\n        },\r\n        {\r\n            title: 'Other',\r\n            rows: [\r\n                {\r\n                    label: 'Default Upgrade Level Cost',\r\n                    inputs: [\r\n                        { key: 'baseCost', label: 'Base Cost' },\r\n                        { key: 'level', label: 'Current Upgrade Level' },\r\n                        {\r\n                            key: 'mode',\r\n                            type: 'select',\r\n                            defaultValue: 'NM',\r\n                            options: [\r\n                                { value: 'NM', label: 'No Milestones' },\r\n                                { value: 'HM', label: 'Has Milestones' },\r\n                            ],\r\n                        },\r\n                    ],\r\n                    compute: ({ baseCost, level, mode }) => computeDefaultUpgradeCost(baseCost, level, mode),\r\n                },\r\n                {\r\n                    label: 'Currency Generation Percentage',\r\n                    inputs: [\r\n                        { key: 'tsunamiExp', label: 'Tsunami Exponent' },\r\n                    ],\r\n                    compute: ({ tsunamiExp }) => {\r\n                        let val = Number(tsunamiExp);\r\n                        if (tsunamiExp instanceof BigNum) {\r\n                            val = tsunamiExp.isInfinite() ? Infinity : Number(tsunamiExp.toScientific(10));\r\n                        }\r\n                        if (!Number.isFinite(val)) return '\u2014';\r\n                        \r\n                        const mapped = val * 1.5 - 0.5;\r\n                        const pct = Math.pow(100, mapped);\r\n                        return formatMultForUi(pct) + '%';\r\n                    },\r\n                },\r\n            ],\r\n        },\r\n    ];\r\n\r\n    calculators.forEach((group) => {\r\n        const subsection = createSubsection(group.title, (sub) => {\r\n            if (!group.rows || group.rows.length === 0) {\r\n                const msg = document.createElement('div');\r\n                msg.className = 'debug-panel-empty';\r\n                msg.textContent = 'No calculators available yet.';\r\n                sub.appendChild(msg);\r\n                return;\r\n            }\r\n\r\n            group.rows.forEach((row) => {\r\n                const calculatorRow = createCalculatorRow({\r\n                    labelText: row.label,\r\n                    inputs: row.inputs,\r\n                    compute: row.compute,\r\n                });\r\n                sub.appendChild(calculatorRow);\r\n            });\r\n        });\r\n\r\n        container.appendChild(subsection);\r\n    });\r\n}\r\n\r\nfunction buildAreasContent(content) {\r\n    content.innerHTML = '';\r\n\r\n    const slot = getActiveSlot();\r\n    if (slot == null) {\r\n        const placeholder = document.createElement('div');\r\n        placeholder.className = 'debug-panel-empty';\r\n        placeholder.textContent = 'Areas are available once a save slot is selected.';\r\n        content.appendChild(placeholder);\r\n        return;\r\n    }\r\n\r\n    applyAllCurrencyOverridesForActiveSlot();\r\n\r\n    const areas = getAreas();\r\n\r\n    areas.forEach((area) => {\r\n        const areaContainer = createSubsection(area.title, (areaContent) => {\r\n            const currencies = createSubsection('Currencies', (sub) => {\r\n                buildAreaCurrencies(sub, area);\r\n            });\r\n            const stats = createSubsection('Stats', (sub) => {\r\n                buildAreaStats(sub, area);\r\n            });\r\n            const multipliers = createSubsection('Multipliers', (sub) => {\r\n                const currencyMultipliers = createSubsection('Currencies', (subsection) => {\r\n                    buildAreaCurrencyMultipliers(subsection, area);\r\n                });\r\n                const statMultipliers = createSubsection('Stats', (subsection) => {\r\n                    buildAreaStatMultipliers(subsection, area);\r\n                });\r\n\r\n                sub.appendChild(currencyMultipliers);\r\n                sub.appendChild(statMultipliers);\r\n            });\r\n            const upgrades = createSubsection('Upgrades', (sub) => {\r\n                buildAreaUpgrades(sub, area);\r\n            });\r\n            \r\n            let automationUpgrades = null;\r\n            let dnaUpgrades = null;\r\n            let labNodesSection = null;\r\n            if (area.key === AREA_KEYS.STARTER_COVE) {\r\n                automationUpgrades = createSubsection('Automation Upgrades', (sub) => {\r\n                    buildAreaUpgrades(sub, { key: AREA_KEYS.AUTOMATION, title: 'Automation' });\r\n                });\r\n                dnaUpgrades = createSubsection('DNA Upgrades', (sub) => {\r\n                    buildAreaUpgrades(sub, { key: AREA_KEYS.DNA, title: 'DNA' });\r\n                });\r\n                labNodesSection = createSubsection('Lab Nodes', (sub) => {\r\n                    buildLabNodesDebug(sub);\r\n                });\r\n            }\r\n\r\n            const calculators = createSubsection('Calculators', (sub) => {\r\n                buildAreaCalculators(sub);\r\n            });\r\n\t\t\t\r\n            areaContent.appendChild(currencies);\r\n            areaContent.appendChild(stats);\r\n            areaContent.appendChild(multipliers);\r\n            areaContent.appendChild(upgrades);\r\n            if (automationUpgrades) {\r\n                areaContent.appendChild(automationUpgrades);\r\n            }\r\n            if (dnaUpgrades) {\r\n                areaContent.appendChild(dnaUpgrades);\r\n            }\r\n            if (labNodesSection) {\r\n                areaContent.appendChild(labNodesSection);\r\n            }\r\n            areaContent.appendChild(calculators);\r\n        });\r\n        areaContainer.classList.add('debug-panel-area');\r\n\r\n        content.appendChild(areaContainer);\r\n    });\r\n}\r\n\r\nfunction setAllUpgradesMaxed(onlyUnlocked = false) {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) return 0;\r\n\r\n    let count = 0;\r\n    const areas = Object.values(AREA_KEYS);\r\n    const targets = [];\r\n\r\n    areas.forEach(areaKey => {\r\n        const upgrades = getUpgradesForArea(areaKey);\r\n        upgrades.forEach(upg => {\r\n            if (onlyUnlocked) {\r\n                const lockState = getUpgradeLockState(areaKey, upg.id);\r\n                if (lockState.locked) return;\r\n            }\r\n            targets.push({ areaKey, upg });\r\n        });\r\n    });\r\n\r\n    batchUpgradeOperations(() => {\r\n        targets.forEach(({ areaKey, upg }) => {\r\n            try {\r\n                const targetLevel = upg.lvlCap;\r\n                setLevel(areaKey, upg.id, targetLevel);\r\n                count++;\r\n            } catch (e) {\r\n                console.warn('Failed to max upgrade', upg, e);\r\n            }\r\n        });\r\n    });\r\n    return count;\r\n}\r\n\r\nfunction setAllUpgradesZero(onlyUnlocked = false) {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) return 0;\r\n\r\n    let count = 0;\r\n    const areas = Object.values(AREA_KEYS);\r\n    const targets = [];\r\n\r\n    areas.forEach(areaKey => {\r\n        const upgrades = getUpgradesForArea(areaKey);\r\n        upgrades.forEach(upg => {\r\n            if (onlyUnlocked) {\r\n                const lockState = getUpgradeLockState(areaKey, upg.id);\r\n                if (lockState.locked) return;\r\n            }\r\n            targets.push({ areaKey, upg });\r\n        });\r\n    });\r\n\r\n    const resetAction = () => {\r\n        batchUpgradeOperations(() => {\r\n            targets.forEach(({ areaKey, upg }) => {\r\n                try {\r\n                    setAutobuyerToggle(areaKey, upg.id, '0');\r\n                    setLevel(areaKey, upg.id, 0);\r\n                } catch (e) {\r\n                    console.warn('Failed to zero upgrade', upg, e);\r\n                }\r\n            });\r\n        });\r\n    };\r\n\r\n    resetAction();\r\n    setTimeout(resetAction, 500);\r\n\r\n    return targets.length;\r\n}\r\n\r\nfunction setAllAutomationToggles(targetState) {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) return 0;\r\n\r\n    const val = targetState ? '1' : '0';\r\n    let count = 0;\r\n\t\r\n\t// 1. Max (or Zero) Automation Upgrades\r\n    const automationUpgrades = getUpgradesForArea(AUTOMATION_AREA_KEY);\r\n    batchUpgradeOperations(() => {\r\n        automationUpgrades.forEach(upg => {\r\n            try {\r\n                // If targetState is true, set to max level (lvlCap).\r\n                // If false, set to 0.\r\n                const lvl = targetState ? upg.lvlCap : 0;\r\n                setLevel(AUTOMATION_AREA_KEY, upg.id, lvl);\r\n                count++;\r\n            } catch (e) {\r\n                console.warn('Failed to set automation level', upg, e);\r\n            }\r\n        });\r\n    });\r\n\r\n    // 2. Set Master Switches (UI state)\r\n    // Keys: ccc:autobuy:master:{type}:{slot}\r\n    const masterTypes = Object.values(MASTER_AUTOBUY_IDS);\r\n    const automatedCostTypes = new Set(masterTypes);\r\n    \r\n    masterTypes.forEach(type => {\r\n         const key = `ccc:autobuy:master:${type}:${slot}`;\r\n         localStorage.setItem(key, val);\r\n    });\r\n\r\n    // 3. Set Individual Toggles (Logic state)\r\n    // Iterate over ALL areas to support future upgrades\r\n    Object.values(AREA_KEYS).forEach(areaKey => {\r\n        if (areaKey === AUTOMATION_AREA_KEY) return; // Handled separately below (or via specific logic)\r\n        \r\n        const upgrades = getUpgradesForArea(areaKey);\r\n        upgrades.forEach((upg) => {\r\n            if (automatedCostTypes.has(upg.costType)) {\r\n                setAutobuyerToggle(areaKey, upg.id, val);\r\n                count++;\r\n            }\r\n        });\r\n    });\r\n\r\n    // 4. Workshop Special Case\r\n    setAutobuyerToggle(AUTOMATION_AREA_KEY, AUTOBUY_WORKSHOP_LEVELS_ID, val);\r\n    count++;\r\n\r\n    // Force UI refresh if shop is open\r\n    try { window.dispatchEvent(new CustomEvent('debug:change', { detail: { slot } })); } catch {}\r\n\r\n    return count;\r\n}\r\n\r\nfunction buildMiscContent(content) {\r\n    content.innerHTML = '';\r\n\r\n    const slot = getActiveSlot();\r\n    if (slot == null) {\r\n        const placeholder = document.createElement('div');\r\n        placeholder.className = 'debug-panel-empty';\r\n        placeholder.textContent = 'Miscellaneous tools are available once a save slot is selected.';\r\n        content.appendChild(placeholder);\r\n        return;\r\n    }\r\n\r\n    const buttons = [\r\n        {\r\n            label: 'Complete Dialogues',\r\n            onClick: () => {\r\n                const { completed } = completeAllDialoguesForDebug();\r\n                flagDebugUsage();\r\n                logAction(`Completed all dialogues (${completed} newly claimed).`);\r\n            },\r\n        },\r\n        {\r\n            label: 'Restore Dialogues',\r\n            onClick: () => {\r\n                const { restored } = restoreAllDialoguesForDebug();\r\n                flagDebugUsage();\r\n                const entryLabel = restored === 1 ? 'entry' : 'entries';\r\n                logAction(`Restored dialogues to unclaimed state (${restored} ${entryLabel} reset).`);\r\n            },\r\n        },\r\n        {\r\n            label: 'All Currencies Inf',\r\n            onClick: () => {\r\n                const touched = setAllCurrenciesToInfinity();\r\n                flagDebugUsage();\r\n                logAction(`Set all currencies to Infinity (${touched} ${touched === 1 ? 'currency' : 'currencies'} updated).`);\r\n            },\r\n        },\r\n        {\r\n            label: 'All Stats Inf',\r\n            onClick: () => {\r\n                                const touched = setAllStatsToInfinity();\r\n                flagDebugUsage();\r\n                logAction(`Set all stats to Infinity (${touched} ${touched === 1 ? 'stat' : 'stats'} updated).`);\r\n            },\r\n        },\r\n\t\t{\r\n            label: 'All Currencies 0',\r\n            onClick: () => {\r\n                const touched = setAllCurrenciesToZero();\r\n                flagDebugUsage();\r\n                logAction(`Set all currencies to 0 (${touched} ${touched === 1 ? 'currency' : 'currencies'} updated).`);\r\n            },\r\n        },\r\n        {\r\n            label: 'All Stats 0',\r\n            onClick: () => {\r\n                const touched = setAllStatsToZero();\r\n                flagDebugUsage();\r\n                logAction(`Set all unlocked stats to 0 (${touched} ${touched === 1 ? 'stat' : 'stats'} updated).`);\r\n            },\r\n        },\r\n        {\r\n            label: 'Max All Upgs',\r\n            onClick: () => {\r\n                const count = setAllUpgradesMaxed(false);\r\n                flagDebugUsage();\r\n                logAction(`Maxed all ${count} upgrades.`);\r\n            },\r\n        },\r\n        {\r\n            label: 'All Upgs 0',\r\n            onClick: () => {\r\n                const count = setAllUpgradesZero(false);\r\n                flagDebugUsage();\r\n                logAction(`Reset all ${count} upgrades to 0.`);\r\n            },\r\n        },\r\n        {\r\n            label: 'Enable All Auto',\r\n            onClick: () => {\r\n                const count = setAllAutomationToggles(true);\r\n                flagDebugUsage();\r\n                logAction(`Enabled automation for ${count} upgrades.`);\r\n            },\r\n        },\r\n        {\r\n            label: 'Disable All Auto',\r\n            onClick: () => {\r\n                const count = setAllAutomationToggles(false);\r\n                flagDebugUsage();\r\n                logAction(`Disabled automation for ${count} upgrades.`);\r\n            },\r\n        },\r\n        {\r\n            label: 'Unlock All Unlocks',\r\n            onClick: () => {\r\n                const { unlocks, toggles } = unlockAllUnlocks();\r\n                flagDebugUsage();\r\n                logAction(`Unlocked all unlock-type upgrades (${unlocks} entries) and unlock flags (${toggles} toggled).`);\r\n            },\r\n        },\r\n        {\r\n            label: 'Lock All Unlocks',\r\n            onClick: () => {\r\n                const { locks, toggles } = lockAllUnlockUpgrades();\r\n                flagDebugUsage();\r\n                logAction(`Locked all unlock-type upgrades (${locks} entries) and unlock flags (${toggles} toggled).`);\r\n            },\r\n        },\r\n        {\r\n            label: 'Max All Lab Nodes',\r\n            onClick: () => {\r\n                let count = 0;\r\n                RESEARCH_NODES.forEach((node) => {\r\n                   if (Number.isFinite(node.maxLevel)) {\r\n                       setResearchNodeLevel(node.id, node.maxLevel);\r\n                       count++;\r\n                   }\r\n                });\r\n                flagDebugUsage();\r\n                logAction(`Maxed ${count} Lab Nodes.`);\r\n            },\r\n        },\r\n        {\r\n            label: 'All Lab Nodes 0',\r\n            onClick: () => {\r\n                let count = 0;\r\n                RESEARCH_NODES.forEach((node) => {\r\n                    setResearchNodeLevel(node.id, 0);\r\n                    setResearchNodeRp(node.id, 0);\r\n                    if (isResearchNodeActive(node.id)) {\r\n                        setResearchNodeActive(node.id, false);\r\n                    }\r\n                    count++;\r\n                });\r\n                flagDebugUsage();\r\n                logAction(`Reset ${count} Lab Nodes to 0 (Level & RP).`);\r\n            },\r\n        },\r\n        {\r\n            label: 'Wipe Action Log',\r\n            onClick: () => {\r\n                persistActionLog([], slot);\r\n                updateActionLogDisplay();\r\n                flagDebugUsage();\r\n                logAction('Action log wiped and reset.');\r\n            },\r\n        },\r\n        {\r\n            label: 'Restock Warps',\r\n            onClick: () => {\r\n                const slot = getActiveSlot();\r\n                if (slot != null) {\r\n                    try {\r\n                        localStorage.setItem(WARP_CHARGES_KEY(slot), String(MAX_WARPS));\r\n                        updateWarpTab(true);\r\n                        flagDebugUsage();\r\n                        logAction('Restocked Warps to full.');\r\n                    } catch {}\r\n                }\r\n            },\r\n        },\r\n        {\r\n            label: 'OP Time Warp',\r\n            onClick: () => {\r\n                const raw = window.prompt(\"Enter amount of seconds to warp:\");\r\n                if (raw == null) return;\r\n                const seconds = parseBigNumInput(raw);\r\n                if (!seconds || (typeof seconds.isZero === 'function' && seconds.isZero()) || (typeof seconds.isNegative === 'function' && seconds.isNegative())) return;\r\n\r\n                let rewards;\r\n                let isPreAutomation = false;\r\n\r\n                if (!hasDoneInfuseReset()) {\r\n                    rewards = calculatePreAutomationRewards(seconds);\r\n                    isPreAutomation = true;\r\n                } else {\r\n                    rewards = calculateOfflineRewards(seconds);\r\n                }\r\n\r\n                grantOfflineRewards(rewards);\r\n                const ms = seconds.mulSmall ? seconds.mulSmall(1000) : seconds.mulBigNumInteger(BigNum.fromInt(1000));\r\n                showOfflinePanel(rewards, ms, isPreAutomation);\r\n\r\n                flagDebugUsage();\r\n                logAction(`Performed OP Time Warp for ${formatNumber(seconds)} seconds.`);\r\n            }\r\n        },\r\n    ];\r\n\r\n    const buttonGrid = document.createElement('div');\r\n    buttonGrid.className = 'debug-misc-button-list';\r\n    buttons.forEach((cfg) => {\r\n        const btn = document.createElement('button');\r\n        btn.type = 'button';\r\n        btn.className = 'debug-panel-toggle debug-misc-button';\r\n        btn.textContent = cfg.label;\r\n        btn.addEventListener('click', cfg.onClick);\r\n        buttonGrid.appendChild(btn);\r\n    });\r\n    content.appendChild(buttonGrid);\r\n\r\n    const resetRow = document.createElement('div');\r\n    resetRow.className = 'debug-panel-row';\r\n    const resetLabel = document.createElement('label');\r\n    resetLabel.textContent = 'Reset Values & Multis For:';\r\n    resetRow.appendChild(resetLabel);\r\n\r\n    const resetSelect = document.createElement('select');\r\n    resetSelect.className = 'debug-panel-input debug-reset-values-select';\r\n\r\n    getAreas().forEach((area) => {\r\n        const group = document.createElement('optgroup');\r\n        group.label = area.title || area.key;\r\n        area.currencies.forEach((currency) => {\r\n            const opt = document.createElement('option');\r\n            opt.value = `currency:${currency.key}`;\r\n            opt.textContent = `${area.title || area.key} \u2192 ${currency.label}`;\r\n            group.appendChild(opt);\r\n        });\r\n        area.stats.forEach((stat) => {\r\n            const opt = document.createElement('option');\r\n            opt.value = `stat:${stat.key}`;\r\n            opt.textContent = `${area.title || area.key} \u2192 ${stat.label}`;\r\n            group.appendChild(opt);\r\n        });\r\n        resetSelect.appendChild(group);\r\n    });\r\n\r\n    const allCurrenciesOption = document.createElement('option');\r\n    allCurrenciesOption.value = 'allCurrencies';\r\n    allCurrenciesOption.textContent = 'All Currencies';\r\n    resetSelect.appendChild(allCurrenciesOption);\r\n\r\n    const allUnlockedStatsOption = document.createElement('option');\r\n    allUnlockedStatsOption.value = 'allUnlockedStats';\r\n    allUnlockedStatsOption.textContent = 'All Unlocked Stats';\r\n    resetSelect.appendChild(allUnlockedStatsOption);\r\n\t\r\n\tconst allUnlockedOption = document.createElement('option');\r\n    allUnlockedOption.value = 'allUnlocked';\r\n    allUnlockedOption.textContent = 'All Unlocked Stats & Currs';\r\n    resetSelect.appendChild(allUnlockedOption);\r\n\r\n    const allOption = document.createElement('option');\r\n    allOption.value = 'all';\r\n    allOption.textContent = 'All';\r\n    resetSelect.appendChild(allOption);\r\n\r\n    if (!resetSelect.querySelector(`option[value=\"${debugPanelMiscResetSelection}\"]`)) {\r\n        debugPanelMiscResetSelection = DEFAULT_MISC_RESET_SELECTION;\r\n    }\r\n    resetSelect.value = debugPanelMiscResetSelection;\r\n\r\n    const resolveResetLockKeys = () => getResetTargetLockKeys(resetSelect.value || DEFAULT_MISC_RESET_SELECTION, getActiveSlot());\r\n\r\n    const resetLockToggle = createCompositeLockToggle(resolveResetLockKeys);\r\n    resetSelect.addEventListener('change', () => {\r\n        debugPanelMiscResetSelection = resetSelect.value || DEFAULT_MISC_RESET_SELECTION;\r\n        resetLockToggle.refresh();\r\n    });\r\n\r\n    resetLockToggle.refresh();\r\n\r\n    resetRow.appendChild(resetSelect);\r\n    resetRow.appendChild(resetLockToggle.button);\r\n\r\n    const resetBtn = document.createElement('button');\r\n    resetBtn.type = 'button';\r\n    resetBtn.className = 'debug-panel-toggle reset-check';\r\n    resetBtn.textContent = '\u2705';\r\n    resetBtn.addEventListener('click', () => {\r\n        const target = resetSelect.value || DEFAULT_MISC_RESET_SELECTION;\r\n        const lockKeys = resolveResetLockKeys();\r\n        const shouldRelock = resetLockToggle.isLocked();\r\n\r\n        const performReset = (logEntry = true) => {\r\n            const result = withTemporaryUnlock(lockKeys, () => resetStatsAndMultipliers(target))\r\n                ?? { label: target, count: 0 };\r\n\r\n            if (shouldRelock) {\r\n                lockKeys.forEach((key) => lockStorageKey(key));\r\n            }\r\n\r\n            resetLockToggle.refresh();\r\n            flagDebugUsage();\r\n\r\n            if (logEntry) {\r\n                const { label, count } = result;\r\n                const nounPhrase = count === 1 ? 'value and multiplier' : 'values and multipliers';\r\n                logAction(`Reset ${nounPhrase} for ${label} to defaults.`);\r\n            }\r\n        };\r\n\r\n        performReset(true);\r\n        setTimeout(() => performReset(false), 100);\r\n    });\r\n    resetRow.appendChild(resetBtn);\r\n    content.appendChild(resetRow);\r\n\r\n    const actionLogRow = document.createElement('div');\r\n    actionLogRow.className = 'debug-panel-row';\r\n\r\nconst wipeSlotBtn = document.createElement('button');\r\nwipeSlotBtn.type = 'button';\r\nwipeSlotBtn.className = 'debug-panel-toggle debug-danger-button';\r\nwipeSlotBtn.textContent = 'Wipe Slot & Refresh';\r\nwipeSlotBtn.addEventListener('click', () => {\r\n    const confirmWipe = window.confirm?.(\r\n        'Are you sure you want to wipe current slot data and refresh the page? This cannot be undone.'\r\n    );\r\n    if (!confirmWipe) return;\r\n\r\n    try {\r\n        localStorage.setItem('ccc:pendingSlotWipe', String(slot));\r\n    } catch {}\r\n\r\n    try {\r\n        localStorage.removeItem('ccc:saveSlot');\r\n    } catch {}\r\n\r\n    try {\r\n        const menuRoot = document.querySelector('.menu-root');\r\n        const gameRoot = document.getElementById('game-root');\r\n        if (menuRoot) {\r\n            menuRoot.hidden = false;\r\n            menuRoot.style.display = '';\r\n            menuRoot.style.visibility = '';\r\n        }\r\n        if (gameRoot) {\r\n            gameRoot.hidden = true;\r\n            gameRoot.style.display = 'none';\r\n        }\r\n    } catch {}\r\n\r\n    try {\r\n        setTimeout(() => {\r\n            try { window.location.reload(); } catch {}\r\n        }, 16);\r\n    } catch {\r\n        try { window.location.reload(); } catch {}\r\n    }\r\n});\r\nactionLogRow.appendChild(wipeSlotBtn);\r\n\r\n    content.appendChild(actionLogRow);\r\n}\r\n\r\nfunction buildUnlocksContent(content) {\r\n    content.innerHTML = '';\r\n\r\n    const slot = getActiveSlot();\r\n    if (slot == null) {\r\n        const placeholder = document.createElement('div');\r\n        placeholder.className = 'debug-panel-empty';\r\n        placeholder.textContent = 'Unlocks are available once a save slot is selected.';\r\n        content.appendChild(placeholder);\r\n        return;\r\n    }\r\n\r\n    try { initXpSystem(); }\r\n    catch {}\r\n\r\n    const rows = getUnlockRowDefinitions(slot);\r\n\r\n    rows.sort((a, b) => {\r\n        const textA = a.labelText ?? '';\r\n        const textB = b.labelText ?? '';\r\n        return textA.localeCompare(textB, undefined, { sensitivity: 'base' });\r\n    });\r\n\r\n    rows.forEach((rowDef) => {\r\n        content.appendChild(createUnlockToggleRow(rowDef));\r\n    });\r\n}\r\n\r\nfunction buildDebugPanel() {\r\n    if (!debugPanelAccess || isOnMenu()) return;\r\n    cleanupDebugPanelResources();\r\n    ensureDebugPanelStyles();\r\n    sectionKeyCounter = 0;\r\n    subsectionKeyCounter = 0;\r\n\r\n    const existingPanel = document.getElementById(DEBUG_PANEL_ID);\r\n    if (existingPanel) existingPanel.remove();\r\n\r\n    const panel = document.createElement('div');\r\n    panel.id = DEBUG_PANEL_ID;\r\n    panel.className = 'debug-panel';\r\n\r\n    const header = document.createElement('div');\r\n    header.className = 'debug-panel-header';\r\n\r\n    const titleContainer = document.createElement('div');\r\n\r\n    const title = document.createElement('div');\r\n    title.className = 'debug-panel-title';\r\n    title.textContent = 'Debug Panel';\r\n\r\n    const closeButtonContainer = document.createElement('div');\r\n    closeButtonContainer.className = 'debug-panel-close-buttons';\r\n\r\n    const closeButton = document.createElement('button');\r\n    closeButton.className = 'debug-panel-close';\r\n    closeButton.type = 'button';\r\n    closeButton.setAttribute('aria-label', 'Close Debug Panel');\r\n    closeButton.textContent = 'Close';\r\n    closeButton.addEventListener('click', () => closeDebugPanel({ preserveExpansionState: true }));\r\n\r\n    const collapseCloseButton = document.createElement('button');\r\n    collapseCloseButton.className = 'debug-panel-close debug-panel-close-collapse';\r\n    collapseCloseButton.type = 'button';\r\n    collapseCloseButton.setAttribute('aria-label', 'Close Debug Panel and Collapse Sections');\r\n    collapseCloseButton.textContent = 'Close & Collapse';\r\n    collapseCloseButton.addEventListener('click', () => closeDebugPanel());\r\n\r\n    closeButtonContainer.appendChild(closeButton);\r\n    closeButtonContainer.appendChild(collapseCloseButton);\r\n\r\n    titleContainer.appendChild(title);\r\n    const info = document.createElement('div');\r\n    info.className = 'debug-panel-info';\r\n\r\n    const infoLines = [\r\n        { text: 'C: Close and preserve panels', hideOnMobile: true },\r\n        { text: 'Shift+C: Close and collapse panels', hideOnMobile: true },\r\n        { text: 'Input fields can take a normal, scientific, or BN number as input' },\r\n        { text: 'Input value \"inf\" sets a value to infinity or an upgrade to its level cap' },\r\n        { text: 'Toggle UL/L (Unlocked/Locked) on a value to freeze it from accruing normally' },\r\n    ];\r\n\r\n    infoLines.forEach(({ text, hideOnMobile }) => {\r\n        const infoLine = document.createElement('div');\r\n        infoLine.className = 'debug-panel-info-line';\r\n        if (hideOnMobile) infoLine.classList.add('debug-panel-info-mobile-hidden');\r\n        infoLine.textContent = text;\r\n        info.appendChild(infoLine);\r\n    });\r\n\r\n    titleContainer.appendChild(info);\r\n\r\n    header.appendChild(titleContainer);\r\n    header.appendChild(closeButtonContainer);\r\n    panel.appendChild(header);\r\n\r\n    panel.appendChild(createSection('Areas: main currency/stat/upgrade management for each area', 'debug-areas', content => {\r\n        buildAreasContent(content);\r\n    }));\r\n\r\n    panel.appendChild(createSection('Unlocks: modify specific unlock flags', 'debug-unlocks', content => {\r\n        buildUnlocksContent(content);\r\n    }));\r\n\r\n    panel.appendChild(createSection('Action Log: keep track of everything you do', 'debug-action-log', content => {\r\n        const container = document.createElement('div');\r\n        container.id = 'action-log-entries';\r\n        container.className = 'debug-panel-action-log';\r\n        container.style.maxHeight = '240px';\r\n        container.style.overflowY = 'auto';\r\n        content.appendChild(container);\r\n        actionLogContainer = container;\r\n        updateActionLogDisplay();\r\n        addDebugPanelCleanup(() => { actionLogContainer = null; });\r\n    }));\r\n\t\r\n    panel.appendChild(createSection('Miscellaneous: helpful miscellaneous functions', 'debug-misc', content => {\r\n        buildMiscContent(content);\r\n    }));\r\n\r\n    applyDebugPanelExpansionState(panel);\r\n\r\n    document.body.appendChild(panel);\r\n\r\n    if (debugPanelScrollTop > 0) {\r\n        try { panel.scrollTop = debugPanelScrollTop; }\r\n        catch {}\r\n    }\r\n    setupLiveBindingListeners();\r\n    debugPanelOpen = true;\r\n}\r\n\r\nfunction openDebugPanel() {\r\n    if (!debugPanelAccess || isOnMenu()) return;\r\n    if (getActiveSlot() == null) {\r\n        closeDebugPanel();\r\n        return;\r\n    }\r\n    if (debugPanelOpen) return;\r\n    buildDebugPanel();\r\n}\r\n\r\nfunction closeDebugPanel({ preserveExpansionState = false } = {}) {\r\n    debugPanelExpansionState = preserveExpansionState\r\n        ? captureDebugPanelExpansionState()\r\n        : createEmptyExpansionState();\r\n    const panel = document.getElementById(DEBUG_PANEL_ID);\r\n    if (panel) {\r\n        try { debugPanelScrollTop = panel.scrollTop ?? 0; }\r\n        catch { debugPanelScrollTop = 0; }\r\n        panel.remove();\r\n    }\r\n    cleanupDebugPanelResources();\r\n    debugPanelOpen = false;\r\n}\r\n\r\nfunction toggleDebugPanel() {\r\n    if (!debugPanelAccess || isOnMenu() || getActiveSlot() == null) {\r\n        closeDebugPanel();\r\n        return;\r\n    }\r\n    if (debugPanelOpen) {\r\n        closeDebugPanel({ preserveExpansionState: true });\r\n    } else {\r\n        openDebugPanel();\r\n    }\r\n}\r\n\r\nfunction teardownDebugPanel() {\r\n    closeDebugPanel();\r\n    removeDebugPanelToggleButton();\r\n}\r\n\r\nfunction createDebugPanelToggleButton() {\r\n    if (!shouldShowDebugPanelToggleButton()) {\r\n        removeDebugPanelToggleButton();\r\n        closeDebugPanel();\r\n        return;\r\n    }\r\n    ensureDebugPanelStyles();\r\n\r\n    removeDebugPanelToggleButton();\r\n\r\n    const button = document.createElement('button');\r\n    button.id = DEBUG_PANEL_TOGGLE_ID;\r\n    button.className = 'debug-panel-toggle-button';\r\n    button.type = 'button';\r\n    button.textContent = 'Debug Panel';\r\n    let lastPointerType = null;\r\n\r\n    const handleToggle = (event) => {\r\n        toggleDebugPanel();\r\n    };\r\n\r\n    button.addEventListener('click', (event) => {\r\n        if (lastPointerType && lastPointerType !== 'mouse') {\r\n            lastPointerType = null;\r\n            return;\r\n        }\r\n        lastPointerType = null;\r\n        handleToggle(event);\r\n    });\r\n\r\n    document.body.appendChild(button);\r\n}\r\n\r\nfunction applyDebugPanelAccess(enabled) {\r\n    debugPanelAccess = !!enabled;\r\n    if (!debugPanelAccess) {\r\n        teardownDebugPanel();\r\n        return;\r\n    }\r\n    createDebugPanelToggleButton();\r\n}\r\n\r\ndocument.addEventListener('keydown', event => {\r\n    if (!debugPanelAccess || isOnMenu()) return;\r\n    if (event.key?.toLowerCase() !== 'c') return;\r\n    if (event.ctrlKey) return;\r\n\r\n    if (getActiveSlot() == null) return;\r\n\r\n    if (event.shiftKey) {\r\n        if (debugPanelOpen) {\r\n            collapseAllDebugCategories();\r\n            closeDebugPanel();\r\n        } else {\r\n            openDebugPanel();\r\n        }\r\n        event.preventDefault();\r\n        return;\r\n    }\r\n\r\n    if (!debugPanelOpen) {\r\n        openDebugPanel();\r\n    } else {\r\n        closeDebugPanel({ preserveExpansionState: true });\r\n    }\r\n\t\r\n    event.preventDefault();\r\n});\r\n\r\ndocument.addEventListener('DOMContentLoaded', () => {\r\n    createDebugPanelToggleButton();\r\n});\r\n\r\nwindow.addEventListener('menu:visibilitychange', onMenuVisibilityChange);\r\n\r\nwindow.addEventListener('saveSlot:change', () => {\r\n    createDebugPanelToggleButton();\r\n    if (debugPanelOpen) {\r\n        buildDebugPanel();\r\n    }\r\n});\r\n\r\nexport function setDebugPanelAccess(enabled) {\r\n    applyDebugPanelAccess(enabled);\r\n}\r\n", "// js/game/mutationSystem.js\r\n\r\nimport { BigNum } from '../util/bigNum.js';\r\nimport { getActiveSlot, watchStorageKey, primeStorageWatcherSnapshot } from '../util/storage.js';\r\nimport { applyStatMultiplierOverride } from '../util/debugPanel.js';\r\nimport { formatNumber } from '../util/numFormat.js';\r\nimport { approxLog10BigNum, bigNumFromLog10 } from '../util/bigNum.js';\r\nimport { syncXpMpHudLayout } from '../ui/hudLayout.js';\r\nimport { refreshCoinMultiplierFromXpLevel } from './xpSystem.js';\r\n\r\nconst KEY_PREFIX = 'ccc:mutation';\r\nconst KEY_UNLOCK = (slot) => `${KEY_PREFIX}:unlocked:${slot}`;\r\nconst KEY_LEVEL = (slot) => `${KEY_PREFIX}:level:${slot}`;\r\nconst KEY_PROGRESS = (slot) => `${KEY_PREFIX}:progress:${slot}`;\r\n\r\nconst BN = BigNum;\r\nconst bnZero = () => BN.fromInt(0);\r\nconst bnOne = () => BN.fromInt(1);\r\n\r\nconst MP_LOG10_BASE = Math.log10(2);\r\nconst CONST_RATIO = (10 - 1) / (Math.pow(1.12, 50) - 1);\r\n\r\nfunction toStorageSafe(value) {\r\n  try { return value?.toStorage?.(); }\r\n  catch { return null; }\r\n}\r\n\r\nconst mutationState = {\r\n  unlocked: false,\r\n  level: bnZero(),\r\n  progress: bnZero(),\r\n  requirement: bnZero(),\r\n  slot: null,\r\n};\r\n\r\nconst hudRefs = {\r\n  container: null,\r\n  bar: null,\r\n  fill: null,\r\n  levelValue: null,\r\n  progress: null,\r\n};\r\n\r\nconst listeners = new Set();\r\nconst watcherCleanups = [];\r\nlet watchersBoundSlot = null;\r\nlet initialized = false;\r\nlet unregisterCoinMultiplierProvider = null;\r\nlet unregisterXpGainMultiplierProvider = null;\r\n\r\nconst mutationGainMultiplierProviders = new Set();\r\nlet externalMutationGainMultiplierProvider = null;\r\n\r\nfunction scheduleCoinMultiplierRefresh() {\r\n  try { refreshCoinMultiplierFromXpLevel(); } catch {}\r\n}\r\n\r\nfunction applyMutationMultipliers(amount) {\r\n  let inc = amount;\r\n  if (!inc.isZero?.()) {\r\n    const providers = mutationGainMultiplierProviders.size > 0\r\n      ? Array.from(mutationGainMultiplierProviders)\r\n      : (typeof externalMutationGainMultiplierProvider === 'function' ? [externalMutationGainMultiplierProvider] : []);\r\n    for (const provider of providers) {\r\n      if (typeof provider !== 'function') continue;\r\n      try {\r\n        const maybe = provider({\r\n          baseGain: inc.clone?.() ?? inc,\r\n          mutationLevel: mutationState.level.clone?.() ?? mutationState.level,\r\n          mutationUnlocked: mutationState.unlocked,\r\n        });\r\n        if (maybe instanceof BN) {\r\n          inc = maybe.clone?.() ?? maybe;\r\n        } else if (maybe != null) {\r\n          inc = BN.fromAny(maybe);\r\n        }\r\n      } catch {}\r\n    }\r\n  }\r\n  return inc;\r\n}\r\n\r\nfunction ensureExternalMultiplierProviders() {\r\n  if (typeof unregisterCoinMultiplierProvider === 'function') {\r\n    try { unregisterCoinMultiplierProvider(); } catch {}\r\n    unregisterCoinMultiplierProvider = null;\r\n  }\r\n  if (typeof unregisterXpGainMultiplierProvider === 'function') {\r\n    try { unregisterXpGainMultiplierProvider(); } catch {}\r\n    unregisterXpGainMultiplierProvider = null;\r\n  }\r\n}\r\n\r\nfunction cloneBigNum(value) {\r\n  if (value instanceof BN) {\r\n    try { return value.clone?.() ?? BN.fromAny(value); }\r\n    catch { return bnZero(); }\r\n  }\r\n  try { return BN.fromAny(value ?? 0); }\r\n  catch { return bnZero(); }\r\n}\r\n\r\nfunction quantizeRequirement(value) {\r\n  if (!value || typeof value !== 'object') return bnZero();\r\n  if (value.isInfinite?.()) return value.clone?.() ?? value;\r\n  const sci = typeof value.toScientific === 'function' ? value.toScientific(18) : '';\r\n  if (!sci || sci === 'Infinity') return value.clone?.() ?? value;\r\n  const match = sci.match(/^(\\d+(?:\\.\\d+)?)e([+-]?\\d+)$/i);\r\n  if (!match) return value.clone?.() ?? value;\r\n  const exp = parseInt(match[2], 10);\r\n  const digits = exp + 1;\r\n  if (digits <= 18) {\r\n    const floored = value.floorToInteger?.() ?? value.clone?.() ?? value;\r\n    const plain = floored.toPlainIntegerString?.();\r\n    if (!plain || plain === 'Infinity') return floored;\r\n    try {\r\n      const quant = (BigInt(plain) / 100n) * 100n;\r\n      if (quant <= 0n) return BN.fromInt(100);\r\n      return BN.fromAny(quant.toString());\r\n    } catch {\r\n      return floored;\r\n    }\r\n  }\r\n  return value.clone?.() ?? value;\r\n}\r\n\r\nfunction levelToNumber(level) {\r\n  if (!level || typeof level !== 'object') return 0;\r\n  if (level.isInfinite?.()) return Number.POSITIVE_INFINITY;\r\n  try {\r\n    const plain = level.toPlainIntegerString?.();\r\n    if (plain && plain !== 'Infinity' && plain.length <= 15) {\r\n      const num = Number(plain);\r\n      if (Number.isFinite(num)) return num;\r\n    }\r\n  } catch {}\r\n  const approxLog = approxLog10BigNum(level);\r\n  if (!Number.isFinite(approxLog)) return Number.POSITIVE_INFINITY;\r\n  if (approxLog > 308) return Number.POSITIVE_INFINITY;\r\n  return Math.pow(10, approxLog);\r\n}\r\n\r\nfunction computeRequirement(levelBn) {\r\n  // Original requirement curve, returning log10(requirement)\r\n  function baseRequirementLog10(baseLevel) {\r\n    const m = Math.max(0, baseLevel + 1);\r\n    const tail = Math.max(0, m - 10);\r\n\r\n    const poly = -0.0022175354763501742 * m * m\r\n      + 0.20449967884058884 * m\r\n      + 2.016778189084622\r\n      + 0.20418426693226513 * Math.pow(tail, 1.6418337930413576);\r\n    if (!Number.isFinite(poly)) {\r\n      return Number.POSITIVE_INFINITY;\r\n    }\r\n\r\n    let factor = 1;\r\n    if (m > 10) {\r\n      const powTerm = Math.pow(1.12, m - 10);\r\n      if (!Number.isFinite(powTerm)) {\r\n        return Number.POSITIVE_INFINITY;\r\n      }\r\n      factor += CONST_RATIO * (powTerm - 1);\r\n      if (!Number.isFinite(factor)) {\r\n        return Number.POSITIVE_INFINITY;\r\n      }\r\n    }\r\n\r\n    const totalLog10 = poly * factor;\r\n    if (!Number.isFinite(totalLog10)) {\r\n      return Number.POSITIVE_INFINITY;\r\n    }\r\n    return totalLog10;\r\n  }\r\n\r\n  const levelNum = levelToNumber(levelBn);\r\n  if (!Number.isFinite(levelNum)) {\r\n    // Infinite / NaN level \u2192 infinite requirement\r\n    return BN.fromAny('Infinity');\r\n  }\r\n\r\n  const baseLevel = Math.max(0, levelNum);\r\n\r\n  // Hard wall: mutation 100+ is impossible\r\n  if (baseLevel >= 100) {\r\n    return BN.fromAny('Infinity');\r\n  }\r\n\r\n  let totalLog10;\r\n\r\n  if (baseLevel <= 9) {\r\n    // 0\u20139: original scaling\r\n    totalLog10 = baseRequirementLog10(baseLevel);\r\n  } else if (baseLevel <= 49) {\r\n    // 10-49: \"Harsher\" Exponential Transition\r\n    //\r\n    // We want to smoothly (but rapidly) transition from:\r\n    //   Level 9: log10(req) \u2248 3.83 (calculated via baseRequirementLog10(9))\r\n    // To:\r\n    //   Level 49: log10(req) = 363,000 (Target set by user)\r\n    //\r\n    // Model: log10(req) = B * R^(baseLevel - 9)\r\n    //\r\n    // B = 3.83\r\n    // R^(49 - 9) = 363000 / 3.83\r\n    // R^40 \u2248 94778.06\r\n    // R = 94778.06 ^ (1/40) \u2248 1.33235...\r\n\r\n    const startVal = baseRequirementLog10(9); // ~3.83\r\n    const endVal = 500000.0000001;\r\n    const steps = 49 - 9; // 40\r\n\r\n    // Safety check for startVal\r\n    const safeStart = Math.max(1, startVal);\r\n\r\n    const ratio = Math.pow(endVal / safeStart, 1 / steps);\r\n    const exponent = baseLevel - 9;\r\n\r\n    totalLog10 = safeStart * Math.pow(ratio, exponent);\r\n  } else {\r\n    // 50\u201399: The New Insanity Zone\r\n    //\r\n    // Targets:\r\n    //   Level 50: 1,000,000 zeros (log10 = 1e6)\r\n    //     => secondExp = log10(1e6) = 6\r\n    //   Level 99: Original target (log10 = 1e303)\r\n    //     => secondExp = log10(1e303) = 303\r\n    //\r\n    // Interpolation: Quadratic on secondExp\r\n    //   x = baseLevel - 49 (ranges from 1 to 50)\r\n    //   L50 (x=1)  => y=6\r\n    //   L99 (x=50) => y=303\r\n    \r\n    const x = baseLevel - 49; // 1..50\r\n    \r\n    // y = A*x^2 + B\r\n    // 6 = A*1 + B\r\n    // 303 = A*2500 + B\r\n    //\r\n    // 303 - 6 = 2499*A\r\n    // 297 = 2499*A\r\n    // A = 297 / 2499\r\n    // B = 6 - A\r\n\r\n    const A = 297 / 2499;\r\n    const B = 6 - A;\r\n    \r\n    const secondExp = A * x * x + B;\r\n    if (!Number.isFinite(secondExp)) {\r\n      return BN.fromAny('Infinity');\r\n    }\r\n\r\n    // log10(requirement) = 10 ^ secondExp, nudged up slightly to avoid hitting exact thresholds\r\n    const baseLog10 = Math.pow(10, secondExp);\r\n    totalLog10 = baseLog10 * 1.00001;\r\n  }\r\n\r\n  if (!Number.isFinite(totalLog10) || totalLog10 <= 0) {\r\n    return BN.fromAny('Infinity');\r\n  }\r\n\r\n  const raw = bigNumFromLog10(totalLog10);\r\n  return quantizeRequirement(raw);\r\n}\r\n\r\nfunction ensureRequirement() {\r\n  const lvl = mutationState.level;\r\n\r\n  const levelIsInf = !!(\r\n    lvl &&\r\n    typeof lvl === 'object' &&\r\n    (lvl.isInfinite?.() || (typeof lvl.isInfinite === 'function' && lvl.isInfinite()))\r\n  );\r\n\r\n  if (levelIsInf) {\r\n    try {\r\n      const inf = BigNum.fromAny('Infinity');\r\n      mutationState.requirement = inf.clone?.() ?? inf;\r\n      mutationState.progress = inf.clone?.() ?? inf;\r\n    } catch {\r\n      if (!mutationState.requirement || typeof mutationState.requirement !== 'object') {\r\n        mutationState.requirement = BigNum.fromInt(0);\r\n      }\r\n      if (!mutationState.progress || typeof mutationState.progress !== 'object') {\r\n        mutationState.progress = BigNum.fromInt(0);\r\n      }\r\n    }\r\n    return;\r\n  }\r\n\r\n  const req = computeRequirement(mutationState.level);\r\n  mutationState.requirement = req;\r\n}\r\n\r\n\r\nfunction progressRatio(progressBn, requirement) {\r\n  if (!requirement || typeof requirement !== 'object') return 0;\r\n  if (!progressBn || typeof progressBn !== 'object') return 0;\r\n\r\n  const reqInf = requirement.isInfinite?.();\r\n  const progInf = progressBn.isInfinite?.();\r\n\r\n  // If both are infinite, treat the bar as \"full\".\r\n  if (reqInf) {\r\n    if (progInf) return 1;\r\n    return 0;\r\n  }\r\n\r\n  const reqZero = requirement.isZero?.();\r\n  if (reqZero) return 0;\r\n\r\n  const progZero = progressBn.isZero?.();\r\n  if (progZero) return 0;\r\n\r\n  const logProg = approxLog10BigNum(progressBn);\r\n  const logReq = approxLog10BigNum(requirement);\r\n  if (!Number.isFinite(logProg) || !Number.isFinite(logReq)) {\r\n    return logProg >= logReq ? 1 : 0;\r\n  }\r\n\r\n  const diff = logProg - logReq;\r\n  const ratio = Math.pow(10, diff);\r\n  if (!Number.isFinite(ratio)) {\r\n    return diff >= 0 ? 1 : 0;\r\n  }\r\n  if (ratio <= 0) return 0;\r\n  if (ratio >= 1) return 1;\r\n  return ratio;\r\n}\r\n\r\nfunction ensureHudRefs() {\r\n  if (hudRefs.container && hudRefs.container.isConnected) return true;\r\n  hudRefs.container = document.querySelector('[data-mp-hud].mp-counter');\r\n  if (!hudRefs.container) return false;\r\n  hudRefs.bar = hudRefs.container.querySelector('.mp-bar');\r\n  hudRefs.fill = hudRefs.container.querySelector('.mp-bar__fill');\r\n  hudRefs.levelValue = hudRefs.container.querySelector('.mp-level-value');\r\n  hudRefs.progress = hudRefs.container.querySelector('[data-mp-progress]');\r\n  return true;\r\n}\r\n\r\nfunction formatBn(bn) {\r\n  try { return formatNumber(bn); }\r\n  catch {\r\n    try { return bn.toPlainIntegerString?.() ?? String(bn); }\r\n    catch { return '0'; }\r\n  }\r\n}\r\n\r\nfunction updateHud() {\r\n  if (!ensureHudRefs()) return;\r\n  const { container, bar, fill, levelValue, progress } = hudRefs;\r\n  if (!container) return;\r\n  if (!mutationState.unlocked) {\r\n    container.setAttribute('hidden', '');\r\n    if (fill) {\r\n      fill.style.setProperty('--mp-fill', '0%');\r\n      fill.style.width = '0%';\r\n    }\r\n    if (levelValue) levelValue.textContent = '0';\r\n    if (progress) {\r\n      const reqHtml = formatBn(mutationState.requirement);\r\n      progress.innerHTML = `0<span class=\"mp-progress-separator\">/</span><span class=\"mp-progress-required\">${reqHtml}</span><span class=\"mp-progress-suffix\">MP</span>`;\r\n    }\r\n    if (bar) {\r\n      bar.setAttribute('aria-valuenow', '0');\r\n      const reqPlain = formatBn(mutationState.requirement).replace(/<[^>]*>/g, '');\r\n      bar.setAttribute('aria-valuetext', `0 / ${reqPlain || '10'} MP`);\r\n    }\r\n    syncXpMpHudLayout();\r\n    return;\r\n  }\r\n\r\n  container.removeAttribute('hidden');\r\n  const req = mutationState.requirement;\r\n  const ratio = progressRatio(mutationState.progress, req);\r\n  const pct = `${(ratio * 100).toFixed(2)}%`;\r\n  if (fill) {\r\n    fill.style.setProperty('--mp-fill', pct);\r\n    fill.style.width = pct;\r\n  }\r\n  if (levelValue) {\r\n    levelValue.innerHTML = formatBn(mutationState.level);\r\n  }\r\n  if (progress) {\r\n    const currentHtml = formatBn(mutationState.progress);\r\n    const reqHtml = formatBn(req);\r\n    progress.innerHTML = `<span class=\"mp-progress-current\">${currentHtml}</span><span class=\"mp-progress-separator\">/</span><span class=\"mp-progress-required\">${reqHtml}</span><span class=\"mp-progress-suffix\">MP</span>`;\r\n  }\r\n  if (bar) {\r\n    bar.setAttribute('aria-valuenow', (ratio * 100).toFixed(2));\r\n    const currPlain = formatBn(mutationState.progress).replace(/<[^>]*>/g, '');\r\n    const reqPlain = formatBn(req).replace(/<[^>]*>/g, '');\r\n    bar.setAttribute('aria-valuetext', `${currPlain} / ${reqPlain} MP`);\r\n  }\r\n  syncXpMpHudLayout();\r\n}\r\n\r\nfunction emitChange(reason = 'update', extraDetail = {}) {\r\n  const snapshot = getMutationState();\r\n  const detail = {\r\n    ...snapshot,\r\n    slot: mutationState.slot ?? getActiveSlot(),\r\n    changeType: reason,\r\n    ...extraDetail,\r\n  };\r\n\r\n  listeners.forEach((cb) => {\r\n    try { cb(snapshot, reason); } catch {}\r\n  });\r\n\r\n  if (typeof window !== 'undefined') {\r\n    try { window.dispatchEvent(new CustomEvent('mutation:change', { detail })); } catch {}\r\n  }\r\n\r\n  return detail;\r\n}\r\n\r\nfunction persistState() {\r\n  let slot = mutationState.slot;\r\n  if (slot == null) {\r\n    slot = getActiveSlot();\r\n    if (slot != null) {\r\n      mutationState.slot = slot;\r\n    }\r\n  }\r\n  if (slot == null) return;\r\n  try { localStorage.setItem(KEY_UNLOCK(slot), mutationState.unlocked ? '1' : '0'); }\r\n  catch {}\r\n  try { localStorage.setItem(KEY_LEVEL(slot), mutationState.level.toStorage()); }\r\n  catch {}\r\n  try { localStorage.setItem(KEY_PROGRESS(slot), mutationState.progress.toStorage()); }\r\n  catch {}\r\n  primeStorageWatcherSnapshot(KEY_UNLOCK(slot));\r\n  primeStorageWatcherSnapshot(KEY_LEVEL(slot));\r\n  primeStorageWatcherSnapshot(KEY_PROGRESS(slot));\r\n\r\n  // If storage writes are being blocked (e.g., via the Debug Panel lock toggle),\r\n  // fall back to the persisted values so in-memory state doesn't keep drifting\r\n  // away from the locked snapshot during gameplay.\r\n  const persisted = (() => {\r\n    let unlocked = mutationState.unlocked;\r\n    let level = mutationState.level;\r\n    let progress = mutationState.progress;\r\n    try { unlocked = localStorage.getItem(KEY_UNLOCK(slot)) === '1'; }\r\n    catch {}\r\n    try {\r\n      const rawLevel = localStorage.getItem(KEY_LEVEL(slot));\r\n      if (rawLevel) level = BN.fromAny(rawLevel);\r\n    } catch {}\r\n    try {\r\n      const rawProgress = localStorage.getItem(KEY_PROGRESS(slot));\r\n      if (rawProgress) progress = BN.fromAny(rawProgress);\r\n    } catch {}\r\n    return { unlocked, level, progress };\r\n  })();\r\n\r\n  const persistedLevelRaw = toStorageSafe(persisted.level);\r\n  const persistedProgressRaw = toStorageSafe(persisted.progress);\r\n  const expectedLevelRaw = toStorageSafe(mutationState.level);\r\n  const expectedProgressRaw = toStorageSafe(mutationState.progress);\r\n\r\n  const unlockMismatch = persisted.unlocked !== mutationState.unlocked;\r\n  const levelMismatch = persistedLevelRaw != null && expectedLevelRaw != null && persistedLevelRaw !== expectedLevelRaw;\r\n  const progressMismatch = persistedProgressRaw != null && expectedProgressRaw != null && persistedProgressRaw !== expectedProgressRaw;\r\n\r\n  if (unlockMismatch || levelMismatch || progressMismatch) {\r\n    applyState(persisted, { skipPersist: true });\r\n  }\r\n}\r\n\r\nfunction isKeyLocked(key) {\r\n  if (typeof window !== 'undefined' && window.__cccLockedStorageKeys) {\r\n    return window.__cccLockedStorageKeys.has(key);\r\n  }\r\n  return false;\r\n}\r\n\r\nfunction normalizeProgress() {\r\n  if (!mutationState.unlocked) return;\r\n\r\n  const slot = mutationState.slot ?? getActiveSlot();\r\n  if (slot != null && isKeyLocked(KEY_LEVEL(slot))) {\r\n    // Level locked: ensure requirement is current but do not consume progress to level up\r\n    ensureRequirement();\r\n    return;\r\n  }\r\n\r\n  ensureRequirement();\r\n  let currentReq = mutationState.requirement;\r\n  if (!currentReq || typeof currentReq !== 'object') return;\r\n\r\n  // If the requirement is infinite, you can keep stacking MP forever,\r\n  // but you'll never spend it to gain more levels.\r\n  if (currentReq.isInfinite?.()) {\r\n    return;\r\n  }\r\n\r\n  let guard = 0;\r\n  const limit = 100000;\r\n\r\n  while (mutationState.progress.cmp?.(currentReq) >= 0 && guard < limit) {\r\n    // Spend MP to gain a level\r\n    mutationState.progress = mutationState.progress.sub(currentReq);\r\n    mutationState.level = mutationState.level.add(bnOne());\r\n\r\n    // Recompute requirement for the new level\r\n    ensureRequirement();\r\n    currentReq = mutationState.requirement;\r\n\r\n    if (!currentReq || typeof currentReq !== 'object') {\r\n      mutationState.progress = bnZero();\r\n      break;\r\n    }\r\n\r\n    // If the requirement becomes infinite while levelling up,\r\n    // stop levelling, but KEEP the leftover progress instead of nuking it.\r\n    if (currentReq.isInfinite?.()) {\r\n      break;\r\n    }\r\n\r\n    guard += 1;\r\n  }\r\n\r\n  // Safety: if we somehow loop too much, just bail and zero progress\r\n  if (guard >= limit) {\r\n    mutationState.progress = bnZero();\r\n  }\r\n}\r\n\r\nfunction applyState(newState, { skipPersist = false } = {}) {\r\n  mutationState.unlocked = !!newState.unlocked;\r\n  mutationState.level = cloneBigNum(newState.level);\r\n  mutationState.progress = cloneBigNum(newState.progress);\r\n  if (!mutationState.unlocked) {\r\n    mutationState.level = bnZero();\r\n    mutationState.progress = bnZero();\r\n  }\r\n  ensureRequirement();\r\n  if (!skipPersist) persistState();\r\n  updateHud();\r\n  emitChange('load');\r\n  scheduleCoinMultiplierRefresh();\r\n}\r\n\r\nfunction readStateFromStorage(slot) {\r\n  const targetSlot = slot ?? getActiveSlot();\r\n  if (targetSlot == null) {\r\n    applyState({ unlocked: false, level: bnZero(), progress: bnZero() }, { skipPersist: true });\r\n    mutationState.slot = null;\r\n    return;\r\n  }\r\n  let unlocked = false;\r\n  let level = bnZero();\r\n  let progress = bnZero();\r\n  try { unlocked = localStorage.getItem(KEY_UNLOCK(targetSlot)) === '1'; }\r\n  catch {}\r\n  try {\r\n    const rawLvl = localStorage.getItem(KEY_LEVEL(targetSlot));\r\n    if (rawLvl) level = BN.fromAny(rawLvl);\r\n  } catch {}\r\n  try {\r\n    const rawProg = localStorage.getItem(KEY_PROGRESS(targetSlot));\r\n    if (rawProg) progress = BN.fromAny(rawProg);\r\n  } catch {}\r\n  applyState({ unlocked, level, progress }, { skipPersist: true });\r\n  mutationState.slot = targetSlot;\r\n}\r\n\r\nfunction cleanupWatchers() {\r\n  while (watcherCleanups.length) {\r\n    const stop = watcherCleanups.pop();\r\n    try { stop?.(); } catch {}\r\n  }\r\n}\r\n\r\nfunction bindStorageWatchers(slot) {\r\n  if (watchersBoundSlot === slot) return;\r\n  cleanupWatchers();\r\n  watchersBoundSlot = slot;\r\n  if (slot == null) return;\r\n  watcherCleanups.push(watchStorageKey(KEY_UNLOCK(slot), {\r\n    onChange(value) {\r\n      const nextUnlocked = value === '1';\r\n      if (mutationState.unlocked !== nextUnlocked) {\r\n        mutationState.unlocked = nextUnlocked;\r\n        if (!nextUnlocked) {\r\n          mutationState.level = bnZero();\r\n          mutationState.progress = bnZero();\r\n        }\r\n        ensureRequirement();\r\n        updateHud();\r\n        emitChange('storage');\r\n        scheduleCoinMultiplierRefresh();\r\n      }\r\n    },\r\n  }));\r\n  watcherCleanups.push(watchStorageKey(KEY_LEVEL(slot), {\r\n    onChange(value) {\r\n      if (!value) return;\r\n      try {\r\n        const next = BN.fromAny(value);\r\n        if (mutationState.level.cmp?.(next) !== 0) {\r\n          mutationState.level = next;\r\n          ensureRequirement();\r\n          updateHud();\r\n          emitChange('storage');\r\n          scheduleCoinMultiplierRefresh();\r\n        }\r\n      } catch {}\r\n    },\r\n  }));\r\n  watcherCleanups.push(watchStorageKey(KEY_PROGRESS(slot), {\r\n    onChange(value) {\r\n      if (!value) return;\r\n      try {\r\n        const next = BN.fromAny(value);\r\n        if (mutationState.progress.cmp?.(next) !== 0) {\r\n          mutationState.progress = next;\r\n          ensureRequirement();\r\n          updateHud();\r\n          emitChange('storage');\r\n        }\r\n      } catch {}\r\n    },\r\n  }));\r\n}\r\n\r\nexport function initMutationSystem({ forceReload = false } = {}) {\r\n  ensureExternalMultiplierProviders();\r\n  if (initialized) {\r\n    const activeSlot = getActiveSlot();\r\n    const slotChanged = activeSlot !== mutationState.slot;\r\n    if (slotChanged || forceReload) {\r\n      readStateFromStorage(activeSlot);\r\n    }\r\n    bindStorageWatchers(activeSlot);\r\n    ensureHudRefs();\r\n    updateHud();\r\n    return getMutationState();\r\n  }\r\n  initialized = true;\r\n  ensureHudRefs();\r\n  const slot = getActiveSlot();\r\n  mutationState.slot = slot;\r\n  readStateFromStorage(slot);\r\n  bindStorageWatchers(slot);\r\n  updateHud();\r\n  scheduleCoinMultiplierRefresh();\r\n  if (typeof window !== 'undefined') {\r\n    window.addEventListener('saveSlot:change', () => {\r\n      const nextSlot = getActiveSlot();\r\n      mutationState.slot = nextSlot;\r\n      readStateFromStorage(nextSlot);\r\n      bindStorageWatchers(nextSlot);\r\n      updateHud();\r\n      scheduleCoinMultiplierRefresh();\r\n      emitChange('slot');\r\n    });\r\n  }\r\n  return getMutationState();\r\n}\r\n\r\nexport function getMutationState() {\r\n  return {\r\n    unlocked: mutationState.unlocked,\r\n    level: cloneBigNum(mutationState.level),\r\n    progress: cloneBigNum(mutationState.progress),\r\n    requirement: cloneBigNum(mutationState.requirement),\r\n  };\r\n}\r\n\r\nexport function isMutationUnlocked() {\r\n  return !!mutationState.unlocked;\r\n}\r\n\r\nexport function unlockMutationSystem() {\r\n  initMutationSystem();\r\n  if (mutationState.unlocked) return false;\r\n  mutationState.unlocked = true;\r\n  ensureRequirement();\r\n  persistState();\r\n  updateHud();\r\n  emitChange('unlock');\r\n  scheduleCoinMultiplierRefresh();\r\n  return true;\r\n}\r\n\r\nexport function setMutationUnlockedForDebug(unlocked) {\r\n  initMutationSystem();\r\n  const nextUnlocked = !!unlocked;\r\n  applyState({\r\n    unlocked: nextUnlocked,\r\n    level: nextUnlocked ? mutationState.level : bnZero(),\r\n    progress: nextUnlocked ? mutationState.progress : bnZero(),\r\n  });\r\n}\r\n\r\nexport function addMutationPower(amount) {\r\n  initMutationSystem();\r\n  const slot = mutationState.slot ?? getActiveSlot();\r\n\r\n  // If Progress is locked, we cannot accumulate MP without causing lag/reverts.\r\n  if (slot != null && isKeyLocked(KEY_PROGRESS(slot))) {\r\n    return getMutationState();\r\n  }\r\n\r\n  if (!mutationState.unlocked) return getMutationState();\r\n\r\n  const levelLocked = slot != null && isKeyLocked(KEY_LEVEL(slot));\r\n\r\n  if (mutationState.level && mutationState.level.isInfinite?.()) {\r\n    const prevLevel = mutationState.level.clone?.() ?? mutationState.level;\r\n    const prevProgress = mutationState.progress.clone?.() ?? mutationState.progress;\r\n\r\n    if (!mutationState.progress?.isInfinite?.()) {\r\n      try { mutationState.progress = BN.fromAny('Infinity'); } catch {}\r\n    }\r\n    if (!mutationState.requirement?.isInfinite?.()) {\r\n      try { mutationState.requirement = BN.fromAny('Infinity'); } catch {}\r\n    }\r\n\r\n    let inc;\r\n    try {\r\n      inc = amount instanceof BN ? amount : BN.fromAny(amount ?? 0);\r\n    } catch {\r\n      inc = bnZero();\r\n    }\r\n\r\n    inc = applyMutationMultipliers(inc);\r\n    inc = applyStatMultiplierOverride('mutation', inc);\r\n\r\n    const detail = emitChange('progress', {\r\n      delta: inc.clone?.() ?? inc,\r\n      levelsGained: bnZero(),\r\n      level: mutationState.level.clone?.() ?? mutationState.level,\r\n      progress: mutationState.progress.clone?.() ?? mutationState.progress,\r\n      requirement: mutationState.requirement.clone?.() ?? mutationState.requirement,\r\n      previousLevel: prevLevel.clone?.() ?? prevLevel,\r\n      previousProgress: prevProgress.clone?.() ?? prevProgress,\r\n    });\r\n\r\n    return detail;\r\n  }\r\n\r\n  let inc;\r\n  try {\r\n    inc = amount instanceof BN ? amount : BN.fromAny(amount ?? 0);\r\n  } catch {\r\n    inc = bnZero();\r\n  }\r\n\r\n  inc = applyMutationMultipliers(inc);\r\n  inc = applyStatMultiplierOverride('mutation', inc);\r\n\r\n  if (inc.isZero?.()) return getMutationState();\r\n\r\n  const incClone = inc.clone?.() ?? inc;\r\n  const prevLevel = mutationState.level.clone?.() ?? mutationState.level;\r\n  const prevProgress = mutationState.progress.clone?.() ?? mutationState.progress;\r\n\r\n  // Add MP\r\n  mutationState.progress = mutationState.progress.add(incClone);\r\n\r\n  // If MP overflows to BigNum Infinity, treat that as reaching mutation Infinity.\r\n  const progInf = mutationState.progress.isInfinite?.();\r\n  if (progInf) {\r\n    \r\n    // Only set Mutation Level to infinity if it's not locked.\r\n    if (!levelLocked) {\r\n        try {\r\n          mutationState.level = BN.fromAny('Infinity');\r\n        } catch {}\r\n    }\r\n\r\n    // Keep progress locked at Infinity once we reach mutation \u221E\r\n    try {\r\n      mutationState.progress = BN.fromAny('Infinity');\r\n    } catch {\r\n      mutationState.progress = bnZero();\r\n    }\r\n\r\n    try {\r\n      mutationState.requirement = BN.fromAny('Infinity');\r\n    } catch {}\r\n  } else {\r\n    // Normal levelling logic (now friendly to \u221E requirements)\r\n    normalizeProgress();\r\n  }\r\n\r\n  persistState();\r\n  updateHud();\r\n\r\n  const levelsGained = mutationState.level.sub(prevLevel);\r\n  if (!levelsGained.isZero?.()) {\r\n    scheduleCoinMultiplierRefresh();\r\n  }\r\n\r\n  const detail = emitChange('progress', {\r\n    delta: incClone.clone?.() ?? incClone,\r\n    levelsGained: levelsGained.clone?.() ?? levelsGained,\r\n    level: mutationState.level.clone?.() ?? mutationState.level,\r\n    progress: mutationState.progress.clone?.() ?? mutationState.progress,\r\n    requirement: mutationState.requirement.clone?.() ?? mutationState.requirement,\r\n    previousLevel: prevLevel.clone?.() ?? prevLevel,\r\n    previousProgress: prevProgress.clone?.() ?? prevProgress,\r\n  });\r\n\r\n  return detail;\r\n}\r\n\r\nexport function broadcastMutationChange(detailOverrides = {}) {\r\n  initMutationSystem();\r\n  const reason = detailOverrides.changeType ?? 'manual';\r\n  return emitChange(reason, detailOverrides);\r\n}\r\n\r\nexport function computeMutationMultiplierForLevel(levelValue) {\r\n  let levelBn;\r\n  if (levelValue instanceof BN) {\r\n    try { levelBn = levelValue.clone?.() ?? levelValue; }\r\n    catch { levelBn = bnZero(); }\r\n  } else if (typeof levelValue === 'bigint') {\r\n    try { levelBn = BigNum.fromAny(levelValue.toString()); }\r\n    catch { levelBn = bnZero(); }\r\n  } else {\r\n    try { levelBn = BigNum.fromAny(levelValue ?? 0); }\r\n    catch { levelBn = bnZero(); }\r\n  }\r\n\r\n  // If the stored mutation level itself is infinite, every multiplier that\r\n  // depends on it becomes infinite as well.\r\n  if (levelBn && levelBn.isInfinite?.()) {\r\n    try { return BN.fromAny('Infinity'); }\r\n    catch { return bnOne(); }\r\n  }\r\n\r\n  const levelNum = levelToNumber(levelBn);\r\n\r\n  // If levelToNumber can't represent this cleanly (NaN / Infinity), also\r\n  // treat that as infinite multiplier.\r\n  if (!Number.isFinite(levelNum)) {\r\n    try { return BN.fromAny('Infinity'); }\r\n    catch { return bnOne(); }\r\n  }\r\n\r\n  if (levelNum <= 0) return bnOne();\r\n\r\n  const log10 = levelNum * MP_LOG10_BASE;\r\n  return bigNumFromLog10(log10);\r\n}\r\n\r\nexport function computeMutationRequirementForLevel(levelValue) {\r\n  let levelBn;\r\n  try { levelBn = levelValue instanceof BN ? levelValue : BN.fromAny(levelValue ?? 0); }\r\n  catch { levelBn = bnZero(); }\r\n  try { return computeRequirement(levelBn); }\r\n  catch { return bnZero(); }\r\n}\r\n\r\nexport function getMutationMultiplier() {\r\n  initMutationSystem();\r\n  if (!mutationState.unlocked) return bnOne();\r\n  try { return computeMutationMultiplierForLevel(mutationState.level); }\r\n  catch { return bnOne(); }\r\n}\r\n\r\nexport function getMutationGainMultiplier() {\r\n  let mult = BigNum.fromInt(1);\r\n  if (mutationGainMultiplierProviders.size > 0 || externalMutationGainMultiplierProvider) {\r\n    const providers = mutationGainMultiplierProviders.size > 0\r\n      ? Array.from(mutationGainMultiplierProviders)\r\n      : (typeof externalMutationGainMultiplierProvider === 'function' ? [externalMutationGainMultiplierProvider] : []);\r\n    for (const provider of providers) {\r\n      if (typeof provider !== 'function') continue;\r\n      try {\r\n        const maybe = provider({\r\n          baseGain: mult.clone?.() ?? mult,\r\n          mutationLevel: mutationState.level.clone?.() ?? mutationState.level,\r\n          mutationUnlocked: mutationState.unlocked,\r\n        });\r\n        if (maybe instanceof BN) {\r\n          mult = maybe.clone?.() ?? maybe;\r\n        } else if (maybe != null) {\r\n          mult = BN.fromAny(maybe);\r\n        }\r\n      } catch {}\r\n    }\r\n  }\r\n  return mult;\r\n}\r\n\r\nexport function getMutationCoinSprite() {\r\n  if (!mutationState.unlocked || mutationState.level.isZero?.()) {\r\n    return 'img/currencies/coin/coin.webp';\r\n  }\r\n\r\n  const levelNum = levelToNumber(mutationState.level);\r\n  if (!Number.isFinite(levelNum)) {\r\n    return 'img/mutations/m25.webp';\r\n  }\r\n  const idx = Math.max(1, Math.min(25, Math.floor(levelNum)));\r\n\r\n  return `img/mutations/m${idx}.webp`;\r\n}\r\n\r\nexport function onMutationChange(callback) {\r\n  if (typeof callback !== 'function') return () => {};\r\n  listeners.add(callback);\r\n  return () => { listeners.delete(callback); };\r\n}\r\n\r\nexport function addExternalMutationGainMultiplierProvider(fn) {\r\n  if (typeof fn !== 'function') return () => {};\r\n  mutationGainMultiplierProviders.add(fn);\r\n  return () => {\r\n    mutationGainMultiplierProviders.delete(fn);\r\n  };\r\n}\r\n\r\nif (typeof window !== 'undefined') {\r\n  window.mutationSystem = window.mutationSystem || {};\r\n  Object.assign(window.mutationSystem, {\r\n    initMutationSystem,\r\n    unlockMutationSystem,\r\n    addMutationPower,\r\n    getMutationState,\r\n    getMutationMultiplier,\r\n    isMutationUnlocked,\r\n    getTotalCumulativeMp,\r\n    addExternalMutationGainMultiplierProvider,\r\n    getMutationGainMultiplier,\r\n  });\r\n}\r\n\r\nexport function getTotalCumulativeMp() {\r\n  initMutationSystem();\r\n  if (!mutationState.unlocked) return bnZero();\r\n  \r\n  if (mutationState.level.isInfinite?.() || mutationState.progress.isInfinite?.()) {\r\n    return BigNum.fromAny('Infinity');\r\n  }\r\n\r\n  const currentLvlNum = levelToNumber(mutationState.level);\r\n  \r\n  // If Mutation Level is > 100, do NOT sum previous tiers. Just use current progress.\r\n  // This is a safety cap to prevent freezing or imbalance for hacked/super-high levels.\r\n  if (Number.isFinite(currentLvlNum) && currentLvlNum > 100) {\r\n    return mutationState.progress.clone?.() ?? mutationState.progress;\r\n  }\r\n\r\n  let total = mutationState.progress.clone?.() ?? mutationState.progress;\r\n  \r\n  if (Number.isFinite(currentLvlNum)) {\r\n    // Normal summing up to the cap\r\n    const limit = currentLvlNum; \r\n    for (let i = 0; i < limit; i++) {\r\n      const req = computeRequirement(BigNum.fromInt(i));\r\n      if (req.isInfinite?.()) {\r\n        return BigNum.fromAny('Infinity');\r\n      }\r\n      total = total.add(req);\r\n    }\r\n  }\r\n\r\n  return total;\r\n}\r\n", "/* it's important that all literal comments in this file do not use the single line variant otherwise it will not compile correctly */\r\nexport const VERTEX_SHADER = `precision highp float;\r\nattribute vec2 position;\r\nvarying vec2 vUv;\r\nvoid main() {\r\n    vUv = position * 0.5 + 0.5;\r\n    gl_Position = vec4(position, 0.0, 1.0);\r\n}`;\r\n\r\n/* --- BACKGROUND SHADER (Water Body) --- */\r\n/* Renders the rolling ocean swells and sun glints. */\r\nexport const BACKGROUND_FRAGMENT_SHADER = `#ifdef GL_FRAGMENT_PRECISION_HIGH\r\nprecision highp float;\r\n#else\r\nprecision mediump float;\r\n#endif\r\n\r\nvarying vec2 vUv;\r\nuniform float uTime;\r\nuniform vec2 uResolution;\r\nuniform vec3 uColorDeep;\r\nuniform vec3 uColorShallow;\r\n\r\nvoid main() {\r\n    /* Wave animation settings */\r\n    float speed = 1.2;\r\n    float time = uTime * speed;\r\n    \r\n    /* Combine sine waves for a more natural look */\r\n    /* vUv.x is 0..1 across the screen width */\r\n    float wave1 = sin(vUv.x * 8.0 - time) * 0.0285;\r\n    float wave2 = sin(vUv.x * 15.0 - time * 0.6) * 0.014;\r\n    float wave = wave1 + wave2;\r\n\r\n    /* Define the shoreline height (baseline) */\r\n    /* vUv.y=0 is bottom of canvas, vUv.y=1 is top */\r\n    /* We want to discard pixels below this threshold */\r\n    float threshold = 0.428 + wave; \r\n\r\n    if (threshold > vUv.y) {\r\n        discard;\r\n    }\r\n\r\n    /* Recalculate gradient based on the new \"bottom\" */\r\n    /* Map vUv.y from [threshold, 1.0] to [0.0, 1.0] */\r\n    float gradientY = clamp((vUv.y - threshold) / (1.0 - threshold), 0.0, 1.0);\r\n    \r\n    vec3 col = mix(uColorShallow, uColorDeep, gradientY);\r\n    \r\n    /* Add a subtle \"foam\" or highlight at the edge */\r\n    float edge = 1.0 - smoothstep(0.0, 0.028, vUv.y - threshold);\r\n    col = mix(col, vec3(1.0, 1.0, 1.0), edge * 0.4);\r\n    \r\n    gl_FragColor = vec4(col, 1.0);\r\n}`;\r\n\r\n/* --- FOREGROUND SHADER (Waves/Surges) --- */\r\n/* Renders the active game waves as Foam/Whitecaps. */\r\nexport const FRAGMENT_SHADER = `#ifdef GL_FRAGMENT_PRECISION_HIGH\r\nprecision highp float;\r\n#else\r\nprecision mediump float;\r\n#endif\r\n\r\nvarying vec2 vUv;\r\nuniform float uTime;\r\nuniform vec2 uResolution;\r\nuniform sampler2D uWaveMap; \r\nuniform vec3 uColorDeep;\r\nuniform vec3 uColorShallow;\r\nuniform vec3 uColorWaveDeep;  \r\nuniform vec3 uColorWave;      \r\n\r\n/* Simple noise for foam breakup */\r\nfloat hash(vec2 p) {\r\n    return fract(sin(dot(p, vec2(127.1, 311.7))) * 43758.5453123);\r\n}\r\nfloat noise(vec2 p) {\r\n    vec2 i = floor(p);\r\n    vec2 f = fract(p);\r\n    vec2 u = f*f*(3.0-2.0*f);\r\n    return mix(mix(hash(i + vec2(0.0,0.0)), hash(i + vec2(1.0,0.0)), u.x),\r\n               mix(hash(i + vec2(0.0,1.0)), hash(i + vec2(1.0,1.0)), u.x), u.y);\r\n}\r\n\r\nvoid main() {\r\n    vec2 uv = vUv;\r\n    \r\n    /* Sample the simulation (physics) */\r\n    /* Wave Logic */\r\n    vec2 waveUV = uv - vec2(0.0, 0.0285);\r\n    float intensity = texture2D(uWaveMap, waveUV).r;\r\n    \r\n    /* Shadow Logic: Look UP for the casting object (Standard drop shadow falls down) */\r\n    float shadowOffset = 8.0 / uResolution.y; \r\n    float shadowIntensity = texture2D(uWaveMap, waveUV + vec2(0.0, shadowOffset)).r;\r\n    \r\n    /* Discard only if BOTH are empty */\r\n    if (0.01 > intensity && 0.01 > shadowIntensity) discard;\r\n    \r\n    /* Directional Noise: Streaky vertical noise for rushing water effect */\r\n    /* Stretch heavily along Y-axis to simulate speed/motion blur */\r\n    float streakyNoise = noise(vec2(uv.x * 60.0, uv.y * 4.0 + uTime * 4.0));\r\n    \r\n    /* Define Zones based on Intensity */\r\n    /* Body (Medium Intensity): Darker/turbulent blue with noise */\r\n    /* Edge (High Intensity): Bright white foam */\r\n    \r\n    float foamThreshold = 0.5;\r\n    float foamMix = smoothstep(foamThreshold, foamThreshold + 0.2, intensity);\r\n    \r\n    /* Base Colors */\r\n    vec3 bodyColor = uColorWaveDeep;\r\n    vec3 foamColor = uColorWave;\r\n    \r\n    /* Mix Colors */\r\n    vec3 finalColor = mix(bodyColor, foamColor, foamMix);\r\n    \r\n    /* Add streaks to the body part */\r\n    if (0.9 > foamMix) {\r\n        finalColor += (streakyNoise - 0.5) * 0.15 * (1.0 - foamMix);\r\n    }\r\n    \r\n    /* Hard Edge & Opacity */\r\n    /* Ensure the front (bottom) remains sharp, back trails off */\r\n    \r\n    /* Calculate Alpha based on Intensity */\r\n    /* High Intensity (Front/Bottom): Alpha 1.0 (Fully Opaque) */\r\n    /* Medium Intensity (Body): Alpha 1.0 (Fully Opaque) */\r\n    /* Low Intensity (Top/Tail): Fades to 0.0 */\r\n    \r\n    float finalAlpha = smoothstep(0.02, 0.15, intensity);\r\n    \r\n    /* Screen Fade */\r\n    /* OLD: float screenFade = smoothstep(0.0, 0.1, uv.y) * (1.0 - smoothstep(0.9, 1.0, uv.y)); */\r\n    \r\n    /* Dynamic Shoreline Fade */\r\n    /* Replicate the wave calculation from BACKGROUND_FRAGMENT_SHADER */\r\n    /* Note: speed must match BACKGROUND_FRAGMENT_SHADER (1.2) */\r\n    float speed = 1.2;\r\n    float time = uTime * speed;\r\n    float wave1 = sin(uv.x * 8.0 - time) * 0.0285;\r\n    float wave2 = sin(uv.x * 15.0 - time * 0.6) * 0.014;\r\n    float wave = wave1 + wave2;\r\n    float threshold = 0.428 + wave;\r\n    \r\n    /* Fade out quickly after exiting the water body (below threshold) */\r\n    /* Fade starts slightly higher than the threshold to soften the transition */\r\n    /* We want full opacity at 'threshold + 0.15' and 0.0 opacity at '0.0' */\r\n    float shoreFade = smoothstep(0.0, threshold + 0.05, uv.y);\r\n    \r\n    float screenFade = shoreFade;\r\n    \r\n    /* --- Composite Shadow & Wave --- */\r\n    float waveAlpha = finalAlpha * screenFade;\r\n    \r\n    /* Shadow Alpha */\r\n    float shadowBaseAlpha = smoothstep(0.02, 0.15, shadowIntensity);\r\n    /* Shadow is weaker (40% opacity) */\r\n    float shadowAlpha = shadowBaseAlpha * 0.4 * screenFade;\r\n    \r\n    /* Mix: Wave over Shadow */\r\n    /* OutAlpha = WaveAlpha + ShadowAlpha * (1 - WaveAlpha) */\r\n    float outAlpha = waveAlpha + shadowAlpha * (1.0 - waveAlpha);\r\n    \r\n    /* OutRGB = WaveRGB * WaveAlpha + ShadowRGB * ShadowAlpha * (1 - WaveAlpha) */\r\n    /* Shadow is black (RGB=0), so second term is 0 */\r\n    vec3 outRGB = finalColor * waveAlpha; \r\n    \r\n    gl_FragColor = vec4(outRGB, outAlpha);\r\n}`;\r\n\r\n/* Wave Sprite Vertex Shader (Standard quad) */\r\nexport const WAVE_VERTEX_SHADER = `attribute vec2 aPosition;\r\nattribute vec2 aUv;\r\nattribute float aAlpha; \r\n\r\nvarying vec2 vUv;\r\nvarying float vAlpha;\r\n\r\nvoid main() {\r\n    vUv = aUv;\r\n    vAlpha = aAlpha;\r\n    gl_Position = vec4(aPosition, 0.0, 1.0);\r\n}`;\r\n\r\n/* --- BRUSH SHADER --- */\r\n/* Spawns a new wave crest. */\r\n/* Shape: Blue Pill with White Leading Edge */\r\nexport const WAVE_BRUSH_FRAGMENT_SHADER = `#ifdef GL_FRAGMENT_PRECISION_HIGH\r\nprecision highp float;\r\n#else\r\nprecision mediump float;\r\n#endif\r\nvarying vec2 vUv;\r\nvarying float vAlpha;\r\n\r\nfloat sdRoundedBox(vec2 p, vec2 b, float r) {\r\n    vec2 q = abs(p) - b;\r\n    return length(max(q, 0.0)) + min(max(q.x, q.y), 0.0) - r;\r\n}\r\n\r\nvoid main() {\r\n    vec2 p = vUv - 0.5;\r\n    \r\n    /* Shape: Rounded Box (Pill) */\r\n    vec2 b = vec2(0.35, 0.15);\r\n    float r = 0.05;\r\n    float d = sdRoundedBox(p, b, r);\r\n    \r\n    float shape = 1.0 - smoothstep(0.0, 0.02, d);\r\n    shape = clamp(shape, 0.0, 1.0);\r\n\r\n    /* Intensity Gradient: White Foam at Bottom (Leading Edge), Blue Body at Top */\r\n    /* vUv.y: 0=Bottom, 1=Top */\r\n    /* We want foam only at the very bottom, rapidly fading to blue body */\r\n    /* Note: Inverted smoothstep (edge0 > edge1) is used here to flip the gradient direction */\r\n    /* Reducing 0.45 to 0.42 shrinks the foam cap height */\r\n    float foam = smoothstep(0.45, 0.24, vUv.y);\r\n    \r\n    /* Body Gradient: Fade out towards the tail */\r\n    /* Starts fading around 0.4 (just after foam ends) and hits 0.0 at the top */\r\n    float bodyFade = smoothstep(0.4, 0.7, vUv.y);\r\n    float bodyBase = mix(0.45, 0.0, bodyFade);\r\n\r\n    /* Map gradient: Bottom=1.0 (Foam), Body=bodyBase */\r\n    float intensity = mix(bodyBase, 1.0, foam);\r\n\r\n    gl_FragColor = vec4(shape * intensity * vAlpha, 0.0, 0.0, 1.0);\r\n}`;\r\n\r\n/* --- SIMULATION SHADER --- */\r\n/* Moves the waves down. */\r\nexport const SIMULATION_FRAGMENT_SHADER = `#ifdef GL_FRAGMENT_PRECISION_HIGH\r\nprecision highp float;\r\n#else\r\nprecision mediump float;\r\n#endif\r\n\r\nuniform sampler2D uLastFrame;\r\nuniform vec2 uResolution;\r\nuniform float uDt;\r\n\r\nvoid main() {\r\n    vec2 uv = gl_FragCoord.xy / uResolution;\r\n    \r\n    /* Flow Downwards */\r\n    /* Speed: 16.0 pixels per frame (at sim res) -> 960.0 pixels per second */\r\n    vec2 flow = vec2(0.0, (685.0 * uDt) / uResolution.y); \r\n    \r\n    vec2 sourceUv = uv + flow;\r\n\r\n    if (sourceUv.y > 1.0) {\r\n        gl_FragColor = vec4(0.0);\r\n        return;\r\n    }\r\n    \r\n    vec4 center = texture2D(uLastFrame, sourceUv);\r\n    \r\n    /* Decay */\r\n    /* Correct decay for variable timestep */\r\n    /* 0.99 per 1/60th second -> pow(0.99, dt * 60.0) */\r\n    float decay = pow(0.99, uDt * 60.0);\r\n    \r\n    gl_FragColor = center * decay;\r\n}`;\r\n", "import {\r\n    VERTEX_SHADER,\r\n    BACKGROUND_FRAGMENT_SHADER,\r\n    FRAGMENT_SHADER,\r\n    WAVE_VERTEX_SHADER,\r\n    WAVE_BRUSH_FRAGMENT_SHADER,\r\n    SIMULATION_FRAGMENT_SHADER\r\n} from './waterShaders.js';\r\n\r\n// --- Colors Extracted from Legacy 2D System ---\r\nconst COLOR_DEEP = [0.2, 0.5, 0.9];          // Deep Royal Blue\r\nconst COLOR_SHALLOW = [0.2, 0.9, 1.0];       // Bright Turquoise\r\n// Updated to Vivid Oceanic Blue Gradient\r\nconst COLOR_WAVE = [1.0, 1.0, 1.0];          // White Foam (Highlights)\r\nconst COLOR_WAVE_DEEP = [0.45, 0.8, 1.0];    // Brighter Blue (Lighter for visibility)\r\n\r\nfunction createShader(gl, type, source) {\r\n    const shader = gl.createShader(type);\r\n    gl.shaderSource(shader, source);\r\n    gl.compileShader(shader);\r\n    if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {\r\n        const log = gl.getShaderInfoLog(shader);\r\n        console.error('Shader compile error:', log);\r\n        console.error('Source start:', source.substring(0, 100));\r\n        gl.deleteShader(shader);\r\n        throw new Error('Shader compile error: ' + log);\r\n    }\r\n    return shader;\r\n}\r\n\r\nfunction createProgram(gl, vsSource, fsSource) {\r\n    const vs = createShader(gl, gl.VERTEX_SHADER, vsSource);\r\n    const fs = createShader(gl, gl.FRAGMENT_SHADER, fsSource);\r\n    if (!vs || !fs) return null;\r\n\r\n    const program = gl.createProgram();\r\n    gl.attachShader(program, vs);\r\n    gl.attachShader(program, fs);\r\n    gl.linkProgram(program);\r\n    if (!gl.getProgramParameter(program, gl.LINK_STATUS)) {\r\n        const log = gl.getProgramInfoLog(program);\r\n        console.error('Program link error:', log);\r\n        throw new Error('Program link error: ' + log);\r\n    }\r\n    return program;\r\n}\r\n\r\nexport class WaterSystem {\r\n    constructor() {\r\n        this.bgCanvas = null;\r\n        this.glBg = null;\r\n\r\n        // Array to hold multiple foreground layers\r\n        this.fgLayers = []; \r\n        /* Each layer object: {\r\n             canvas: HTMLCanvasElement,\r\n             gl: WebGLRenderingContext,\r\n             program: WebGLProgram,\r\n             simProgram: WebGLProgram,\r\n             brushProgram: WebGLProgram,\r\n             quadBuffer: WebGLBuffer,\r\n             brushBuffer: WebGLBuffer,\r\n             readFBO: WebGLFramebuffer,\r\n             writeFBO: WebGLFramebuffer,\r\n             readTexture: WebGLTexture,\r\n             writeTexture: WebGLTexture\r\n           }\r\n        */\r\n\r\n        // Background Context Programs\r\n        this.bgProgram = null;\r\n        this.bgSimProgram = null;\r\n        this.bgBrushProgram = null;\r\n\r\n        this.width = 0;\r\n        this.height = 0;\r\n        \r\n        // Simulation State\r\n        this.simRes = 512;\r\n        \r\n        // BG Sim\r\n        this.bgReadFBO = null;\r\n        this.bgWriteFBO = null;\r\n        this.bgReadTexture = null;\r\n        this.bgWriteTexture = null;\r\n\r\n        // Buffers\r\n        this.quadBufferBg = null;\r\n        this.bgBrushBuffer = null;\r\n\r\n        this._boundResize = null;\r\n    }\r\n\r\n    init(backCanvasId, frontCanvasIds) {\r\n        this.fgLayers = [];\r\n        this.bgCanvas = document.getElementById(backCanvasId);\r\n        \r\n        // Handle array of foreground canvases\r\n        const ids = Array.isArray(frontCanvasIds) ? frontCanvasIds : [frontCanvasIds];\r\n        \r\n        if (!this.bgCanvas) return;\r\n\r\n        // Initialize Background Context\r\n        this.glBg = this.bgCanvas.getContext('webgl', { alpha: true, depth: false }) || \r\n                    this.bgCanvas.getContext('experimental-webgl');\r\n\r\n        if (!this.glBg) {\r\n            console.error('WaterSystem: WebGL not supported for BG');\r\n            return;\r\n        }\r\n\r\n        this.initBgShaders();\r\n        this.initBgBuffers();\r\n        this.initBgSimulation();\r\n\r\n        // Initialize Foreground Layers\r\n        ids.forEach(id => {\r\n            const canvas = document.getElementById(id);\r\n            if (!canvas) return;\r\n            \r\n            canvas.style.display = 'block';\r\n            \r\n            const gl = canvas.getContext('webgl', { alpha: true, depth: false }) || \r\n                       canvas.getContext('experimental-webgl');\r\n            \r\n            if (!gl) {\r\n                console.error(`WaterSystem: WebGL not supported for layer ${id}`);\r\n                return;\r\n            }\r\n\r\n            const layer = {\r\n                canvas: canvas,\r\n                gl: gl,\r\n                program: createProgram(gl, VERTEX_SHADER, FRAGMENT_SHADER),\r\n                simProgram: createProgram(gl, VERTEX_SHADER, SIMULATION_FRAGMENT_SHADER),\r\n                brushProgram: createProgram(gl, WAVE_VERTEX_SHADER, WAVE_BRUSH_FRAGMENT_SHADER),\r\n                quadBuffer: null,\r\n                brushBuffer: null,\r\n                readFBO: null,\r\n                writeFBO: null,\r\n                readTexture: null,\r\n                writeTexture: null\r\n            };\r\n\r\n            // Init Buffers for this layer\r\n            const vertices = new Float32Array([-1, -1, 1, -1, -1, 1, 1, 1]);\r\n            layer.quadBuffer = gl.createBuffer();\r\n            gl.bindBuffer(gl.ARRAY_BUFFER, layer.quadBuffer);\r\n            gl.bufferData(gl.ARRAY_BUFFER, vertices, gl.STATIC_DRAW);\r\n            \r\n            layer.brushBuffer = gl.createBuffer();\r\n\r\n            // Init Sim for this layer\r\n            const simRes = this.createSimResources(gl);\r\n            layer.readFBO = simRes.readFBO;\r\n            layer.writeFBO = simRes.writeFBO;\r\n            layer.readTexture = simRes.readTex;\r\n            layer.writeTexture = simRes.writeTex;\r\n\r\n            this.fgLayers.push(layer);\r\n        });\r\n\r\n        this.resize();\r\n        \r\n        if (!this._boundResize) {\r\n            this._boundResize = () => this.resize();\r\n            window.addEventListener('resize', this._boundResize);\r\n        }\r\n    }\r\n\r\n    initBgShaders() {\r\n        this.bgProgram = createProgram(this.glBg, VERTEX_SHADER, BACKGROUND_FRAGMENT_SHADER);\r\n        this.bgSimProgram = createProgram(this.glBg, VERTEX_SHADER, SIMULATION_FRAGMENT_SHADER);\r\n        this.bgBrushProgram = createProgram(this.glBg, WAVE_VERTEX_SHADER, WAVE_BRUSH_FRAGMENT_SHADER);\r\n    }\r\n\r\n    initBgBuffers() {\r\n        const vertices = new Float32Array([-1, -1, 1, -1, -1, 1, 1, 1]);\r\n        const glBg = this.glBg;\r\n        this.quadBufferBg = glBg.createBuffer();\r\n        glBg.bindBuffer(glBg.ARRAY_BUFFER, this.quadBufferBg);\r\n        glBg.bufferData(glBg.ARRAY_BUFFER, vertices, glBg.STATIC_DRAW);\r\n        this.bgBrushBuffer = glBg.createBuffer();\r\n    }\r\n\r\n    initBgSimulation() {\r\n        const bgRes = this.createSimResources(this.glBg);\r\n        this.bgReadFBO = bgRes.readFBO;\r\n        this.bgWriteFBO = bgRes.writeFBO;\r\n        this.bgReadTexture = bgRes.readTex;\r\n        this.bgWriteTexture = bgRes.writeTex;\r\n    }\r\n\r\n    createSimResources(gl) {\r\n        const w = this.simRes;\r\n        const h = this.simRes;\r\n\r\n        gl.getExtension('OES_texture_float');\r\n        gl.getExtension('OES_texture_float_linear');\r\n\r\n        const createTex = () => {\r\n            const tex = gl.createTexture();\r\n            gl.bindTexture(gl.TEXTURE_2D, tex);\r\n            gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, w, h, 0, gl.RGBA, gl.FLOAT, null);\r\n            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);\r\n            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);\r\n            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\r\n            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\r\n            return tex;\r\n        };\r\n\r\n        const readTex = createTex();\r\n        const writeTex = createTex();\r\n\r\n        const readFBO = gl.createFramebuffer();\r\n        gl.bindFramebuffer(gl.FRAMEBUFFER, readFBO);\r\n        gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, readTex, 0);\r\n\r\n        const writeFBO = gl.createFramebuffer();\r\n        gl.bindFramebuffer(gl.FRAMEBUFFER, writeFBO);\r\n        gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, writeTex, 0);\r\n        \r\n        gl.bindFramebuffer(gl.FRAMEBUFFER, null);\r\n        \r\n        return { readFBO, writeFBO, readTex, writeTex };\r\n    }\r\n\r\n    resize() {\r\n        const dpr = window.devicePixelRatio || 1;\r\n\r\n        if (this.bgCanvas && this.glBg) {\r\n            const rect = this.bgCanvas.getBoundingClientRect();\r\n            this.bgCanvas.width = rect.width * dpr;\r\n            this.bgCanvas.height = rect.height * dpr;\r\n            this.glBg.viewport(0, 0, this.bgCanvas.width, this.bgCanvas.height);\r\n        }\r\n\r\n        // Resize all foreground layers\r\n        if (this.fgLayers.length > 0) {\r\n            const rect = this.fgLayers[0].canvas.getBoundingClientRect(); // Assume all same size\r\n            this.width = rect.width;\r\n            this.height = rect.height;\r\n            \r\n            this.fgLayers.forEach(layer => {\r\n                 const rect = layer.canvas.getBoundingClientRect();\r\n                 layer.canvas.width = rect.width * dpr;\r\n                 layer.canvas.height = rect.height * dpr;\r\n                 layer.gl.viewport(0, 0, layer.canvas.width, layer.canvas.height);\r\n            });\r\n        }\r\n    }\r\n\r\n    applyBrush(gl, program, buffer, fbo, x, y, width, height) {\r\n        gl.useProgram(program);\r\n        gl.bindFramebuffer(gl.FRAMEBUFFER, fbo);\r\n        gl.viewport(0, 0, this.simRes, this.simRes);\r\n\r\n        gl.enable(gl.BLEND);\r\n        gl.blendFunc(gl.ONE, gl.ONE);\r\n\r\n        // Map pixels to WebGL Clip Space\r\n        const ndcX = (x / this.width) * 2 - 1;\r\n        const ndcY = -((y / this.height) * 2 - 1); // Flip Y for WebGL\r\n\r\n        const wX = (width / this.width);\r\n        const wY = (height / this.height);\r\n        \r\n        // Quad vertices: x, y, u, v, alpha\r\n        const data = new Float32Array([\r\n            ndcX - wX, ndcY - wY, 0, 0, 1,\r\n            ndcX + wX, ndcY - wY, 1, 0, 1,\r\n            ndcX - wX, ndcY + wY, 0, 1, 1,\r\n            ndcX + wX, ndcY + wY, 1, 1, 1\r\n        ]);\r\n\r\n        gl.bindBuffer(gl.ARRAY_BUFFER, buffer);\r\n        gl.bufferData(gl.ARRAY_BUFFER, data, gl.DYNAMIC_DRAW);\r\n\r\n        const aPos = gl.getAttribLocation(program, 'aPosition');\r\n        const aUv = gl.getAttribLocation(program, 'aUv');\r\n        const aAlpha = gl.getAttribLocation(program, 'aAlpha');\r\n\r\n        // Stride = 5 floats * 4 bytes = 20\r\n        gl.enableVertexAttribArray(aPos);\r\n        gl.vertexAttribPointer(aPos, 2, gl.FLOAT, false, 20, 0);\r\n\r\n        gl.enableVertexAttribArray(aUv);\r\n        gl.vertexAttribPointer(aUv, 2, gl.FLOAT, false, 20, 8);\r\n\r\n        gl.enableVertexAttribArray(aAlpha);\r\n        gl.vertexAttribPointer(aAlpha, 1, gl.FLOAT, false, 20, 16);\r\n\r\n        gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);\r\n\r\n        gl.disable(gl.BLEND);\r\n        gl.bindFramebuffer(gl.FRAMEBUFFER, null);\r\n    }\r\n\r\n    addWave(x, y, width, height, forceTopLayer = false) {\r\n        if (!this.glBg || this.fgLayers.length === 0) return;\r\n\r\n        // 1. Apply to BG Sim (Always, for water distortion)\r\n        this.applyBrush(\r\n            this.glBg, \r\n            this.bgBrushProgram, \r\n            this.bgBrushBuffer, \r\n            this.bgReadFBO, \r\n            x, y, width, height\r\n        );\r\n\r\n        // 2. Apply to ONE FG Layer (To distribute density)\r\n        // If forceTopLayer is true, use the last layer (highest visual priority).\r\n        // Otherwise, pick a random layer.\r\n        const layerIdx = forceTopLayer \r\n            ? this.fgLayers.length - 1 \r\n            : Math.floor(Math.random() * this.fgLayers.length);\r\n            \r\n        const layer = this.fgLayers[layerIdx];\r\n        \r\n        this.applyBrush(\r\n            layer.gl, \r\n            layer.brushProgram, \r\n            layer.brushBuffer, \r\n            layer.readFBO, \r\n            x, y, width, height\r\n        );\r\n    }\r\n\r\n    runSimStep(gl, program, quadBuffer, readFBO, writeFBO, readTex, writeTex, dt) {\r\n        gl.useProgram(program);\r\n        gl.viewport(0, 0, this.simRes, this.simRes);\r\n        \r\n        // Write to WriteFBO\r\n        gl.bindFramebuffer(gl.FRAMEBUFFER, writeFBO);\r\n        \r\n        // Read from ReadTexture\r\n        gl.activeTexture(gl.TEXTURE0);\r\n        gl.bindTexture(gl.TEXTURE_2D, readTex);\r\n        gl.uniform1i(gl.getUniformLocation(program, 'uLastFrame'), 0);\r\n        gl.uniform2f(gl.getUniformLocation(program, 'uResolution'), this.simRes, this.simRes);\r\n        gl.uniform1f(gl.getUniformLocation(program, 'uDt'), dt); // Variable timestep\r\n\r\n        // Draw Full Screen Quad\r\n        gl.bindBuffer(gl.ARRAY_BUFFER, quadBuffer);\r\n        const aPos = gl.getAttribLocation(program, 'position');\r\n        gl.enableVertexAttribArray(aPos);\r\n        gl.vertexAttribPointer(aPos, 2, gl.FLOAT, false, 0, 0);\r\n        \r\n        gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);\r\n        \r\n        // Return swapped state\r\n        return {\r\n            readFBO: writeFBO,\r\n            writeFBO: readFBO,\r\n            readTex: writeTex,\r\n            writeTex: readTex\r\n        };\r\n    }\r\n\r\n    update(dt) {\r\n        // \"Natural Swell\" Auto Spawning Logic - DISABLED\r\n    }\r\n\r\n    spawnRandomWave() {\r\n        if (!this.width) return;\r\n        \r\n        // Random X Position (0 to Width)\r\n        const x = Math.random() * this.width;\r\n        \r\n        // Spawn at the top\r\n        const y = 0; \r\n        \r\n        const sizePct = 0.3 + Math.random() * 0.2;\r\n        const width = this.width * sizePct;\r\n        const height = width * 0.5; // Aspect ratio approx\r\n        \r\n        this.addWave(x, y, width, height);\r\n    }\r\n\r\n    render(totalTime, dt) {\r\n        if (!this.glBg) return;\r\n        \r\n        // totalTime is in seconds. \r\n        const simTime = totalTime * 2; \r\n\r\n        // --- Hybrid Sub-stepping Logic ---\r\n        // 1. Clamp dt to prevent spiral of death on massive lag (max 0.1s = 10fps)\r\n        const safeDt = Math.min(dt, 0.1);\r\n        \r\n        // 2. Define High-FPS threshold (approx 25fps = 0.04s)\r\n        // If frame time is fast (High FPS), run 1 step with actual dt to preserve smoothness.\r\n        // If frame time is slow (Low FPS/Lag), sub-step with 60hz chunks to preserve stability.\r\n        const FPS_THRESHOLD = 0.04; \r\n        const SUB_STEP = 0.016; // ~60hz\r\n        \r\n        let steps = [];\r\n        \r\n        if (safeDt < FPS_THRESHOLD) {\r\n             steps.push(safeDt);\r\n        } else {\r\n             let remaining = safeDt;\r\n             while (remaining > 0) {\r\n                 let step = Math.min(remaining, SUB_STEP);\r\n                 steps.push(step);\r\n                 remaining -= step;\r\n             }\r\n        }\r\n        \r\n        // --- 1. Simulation Step (BG) ---\r\n        // Run gathered steps\r\n        steps.forEach(stepDt => {\r\n            const bgState = this.runSimStep(\r\n                this.glBg, this.bgSimProgram, this.quadBufferBg,\r\n                this.bgReadFBO, this.bgWriteFBO, this.bgReadTexture, this.bgWriteTexture,\r\n                stepDt\r\n            );\r\n            this.bgReadFBO = bgState.readFBO;\r\n            this.bgWriteFBO = bgState.writeFBO;\r\n            this.bgReadTexture = bgState.readTex;\r\n            this.bgWriteTexture = bgState.writeTex;\r\n        });\r\n\r\n        // --- 2. Simulation Step (FG Layers) ---\r\n        this.fgLayers.forEach(layer => {\r\n            steps.forEach(stepDt => {\r\n                const fgState = this.runSimStep(\r\n                    layer.gl, layer.simProgram, layer.quadBuffer,\r\n                    layer.readFBO, layer.writeFBO, layer.readTexture, layer.writeTexture,\r\n                    stepDt\r\n                );\r\n                layer.readFBO = fgState.readFBO;\r\n                layer.writeFBO = fgState.writeFBO;\r\n                layer.readTexture = fgState.readTex;\r\n                layer.writeTexture = fgState.writeTex;\r\n            });\r\n        });\r\n\r\n        // --- 3. Render Background (Water Body) ---\r\n        const glBg = this.glBg;\r\n        glBg.bindFramebuffer(glBg.FRAMEBUFFER, null);\r\n        glBg.viewport(0, 0, this.bgCanvas.width, this.bgCanvas.height);\r\n        glBg.useProgram(this.bgProgram);\r\n        \r\n        glBg.uniform3fv(glBg.getUniformLocation(this.bgProgram, 'uColorDeep'), COLOR_DEEP);\r\n        glBg.uniform3fv(glBg.getUniformLocation(this.bgProgram, 'uColorShallow'), COLOR_SHALLOW);\r\n        glBg.uniform1f(glBg.getUniformLocation(this.bgProgram, 'uTime'), simTime);\r\n        glBg.uniform2f(glBg.getUniformLocation(this.bgProgram, 'uResolution'), this.bgCanvas.width, this.bgCanvas.height);\r\n\r\n        // Bind BG Sim Texture for distortion\r\n        glBg.activeTexture(glBg.TEXTURE0);\r\n        glBg.bindTexture(glBg.TEXTURE_2D, this.bgReadTexture);\r\n        glBg.uniform1i(glBg.getUniformLocation(this.bgProgram, 'uWaveMap'), 0);\r\n\r\n        glBg.bindBuffer(glBg.ARRAY_BUFFER, this.quadBufferBg);\r\n        const aPosBg = glBg.getAttribLocation(this.bgProgram, 'position');\r\n        glBg.enableVertexAttribArray(aPosBg);\r\n        glBg.vertexAttribPointer(aPosBg, 2, glBg.FLOAT, false, 0, 0);\r\n        \r\n        glBg.drawArrays(glBg.TRIANGLE_STRIP, 0, 4);\r\n\r\n        // --- 4. Render Foreground Layers (Waves/Foam) ---\r\n        this.fgLayers.forEach(layer => {\r\n            const glFg = layer.gl;\r\n            glFg.bindFramebuffer(glFg.FRAMEBUFFER, null); \r\n            glFg.viewport(0, 0, layer.canvas.width, layer.canvas.height);\r\n            glFg.useProgram(layer.program);\r\n            glFg.clearColor(0, 0, 0, 0);\r\n            glFg.clear(glFg.COLOR_BUFFER_BIT);\r\n\r\n            glFg.activeTexture(glFg.TEXTURE0);\r\n            glFg.bindTexture(glFg.TEXTURE_2D, layer.readTexture); // Use FG sim result\r\n            glFg.uniform1i(glFg.getUniformLocation(layer.program, 'uWaveMap'), 0);\r\n            \r\n            glFg.uniform3fv(glFg.getUniformLocation(layer.program, 'uColorShallow'), COLOR_SHALLOW);\r\n            glFg.uniform3fv(glFg.getUniformLocation(layer.program, 'uColorWave'), COLOR_WAVE); \r\n            glFg.uniform3fv(glFg.getUniformLocation(layer.program, 'uColorWaveDeep'), COLOR_WAVE_DEEP);\r\n            glFg.uniform1f(glFg.getUniformLocation(layer.program, 'uTime'), simTime);\r\n            glFg.uniform2f(glFg.getUniformLocation(layer.program, 'uResolution'), layer.canvas.width, layer.canvas.height);\r\n\r\n            glFg.bindBuffer(glFg.ARRAY_BUFFER, layer.quadBuffer);\r\n            const aPosFg = glFg.getAttribLocation(layer.program, 'position');\r\n            glFg.enableVertexAttribArray(aPosFg);\r\n            glFg.vertexAttribPointer(aPosFg, 2, glFg.FLOAT, false, 0, 0);\r\n\r\n            glFg.drawArrays(glFg.TRIANGLE_STRIP, 0, 4);\r\n        });\r\n    }\r\n}\r\n\r\nexport const waterSystem = new WaterSystem();\r\n", "// js/game/spawner.js\r\n\r\nimport { takePreloadedAudio } from '../util/audioCache.js';\r\nimport { getMutationState, onMutationChange } from './mutationSystem.js';\r\nimport { IS_MOBILE } from '../main.js';\r\nimport { isSurgeActive, getTsunamiNerf, getEffectiveTsunamiNerfWithCombo } from './surgeEffects.js';\r\nimport { playAudio } from '../util/audioManager.js';\r\nimport { waterSystem} from './webgl/waterSystem.js';\r\nimport { shouldBlockBigCoins } from '../ui/merchantTabs/resetTab.js';\r\n\r\nlet mutationUnlockedSnapshot = false;\r\nlet mutationLevelSnapshot = 0n;\r\n\r\nconst MAX_ACTIVE_COINS_MOBILE = 2500\r\n\r\n// Cache for coin images (src -> Image)\r\nconst imgCache = new Map();\r\n\r\nfunction updateMutationSnapshot(state) {\r\n  if (!state || typeof state !== 'object') {\r\n    mutationUnlockedSnapshot = false;\r\n    mutationLevelSnapshot = 0n;\r\n    return;\r\n  }\r\n  mutationUnlockedSnapshot = !!state.unlocked;\r\n  try {\r\n    const level = state.level;\r\n    const plain = typeof level?.toPlainIntegerString === 'function'\r\n      ? level.toPlainIntegerString()\r\n      : null;\r\n    mutationLevelSnapshot = plain && plain !== 'Infinity' ? BigInt(plain) : 0n;\r\n  } catch {\r\n    mutationLevelSnapshot = 0n;\r\n  }\r\n}\r\n\r\ntry {\r\n  updateMutationSnapshot(getMutationState());\r\n} catch {\r\n  mutationUnlockedSnapshot = false;\r\n  mutationLevelSnapshot = 0n;\r\n}\r\n\r\ntry {\r\n  onMutationChange((snapshot) => { updateMutationSnapshot(snapshot); });\r\n} catch {}\r\n\r\nfunction easeOutCubic(t) {\r\n  const f = 1 - t;\r\n  return 1 - f * f * f;\r\n}\r\n\r\nconst CUBIC_BEZIER = 'cubic-bezier(0.215, 0.61, 0.355, 1)';\r\n\r\nfunction getImage(src) {\r\n  if (!src) return null;\r\n  let img = imgCache.get(src);\r\n  if (!img) {\r\n    img = new Image();\r\n    img.src = src;\r\n    imgCache.set(src, img);\r\n  }\r\n  return img;\r\n}\r\n\r\n// Surge 2 Constants\r\nconst COIN_SIZES = [40, 55, 80, 125, 200, 320, 512];\r\n// Ratio of radius where lightning originates (to match the inner ridge of the coin art)\r\nconst LIGHTNING_START_RADIUS_RATIO = 0.78;\r\nconst COIN_VALUE_MULTS = [1, 25, 625, 15625, 390625, 9765625, 244140625];\r\n// Probabilities for Size 1 to 6 (Size 0 is fallback) while the Surge 2 milestone is active\r\nconst COIN_CHANCES = [\r\n    0,          // Size 0 (N/A)\r\n    0.1,        // Size 1: 1/10\r\n    0.01,       // Size 2: 1/100\r\n    0.001,      // Size 3: 1/1000\r\n    0.0001,     // Size 4: 1/10000\r\n    0.00001,    // Size 5: 1/100000\r\n    0.000001,    // Size 6: 1/1000000\r\n];\r\nconst COIN_SOUND_SUFFIXES = [\r\n    '', // Size 0 uses default\r\n    '_size1.ogg',\r\n    '_size2.ogg',\r\n    '_size3.ogg',\r\n    '_size4.ogg',\r\n    '_size5.ogg',\r\n    '_size6.ogg'\r\n];\r\n\r\n// Explicit Wave Dimensions (Viewport Width % and approx Height in VW %) for each Coin Size\r\n// \"Manual values\" as requested, starting with ~22vw for Size 0 to match original standard.\r\nconst WAVE_DEFS = [\r\n    { w: 22, h: 12 },  // Size 0 (Standard)\r\n    { w: 28, h: 15 },  // Size 1\r\n    { w: 36, h: 19 },  // Size 2\r\n    { w: 48, h: 25 },  // Size 3\r\n    { w: 64, h: 34 },  // Size 4\r\n    { w: 85, h: 45 },  // Size 5\r\n    { w: 120, h: 65 }, // Size 6\r\n];\r\n\r\nexport function createSpawner({\r\n    playfieldSelector = '.area-cove .playfield',\r\n    waterSelector = '#water-background',\r\n    coinsHost = '.coins-layer',\r\n    coinSrc = 'img/coin/coin.webp',\r\n    coinSize: baseCoinSize = 40, // Renamed to baseCoinSize\r\n    animationDurationMs = 1500,\r\n    surgeLifetimeMs = 1400,\r\n    surgeWidthVw = 22,\r\n    coinsPerSecond = 1,\r\n    perFrameBudget = 24,\r\n    maxActiveCoins = IS_MOBILE ? MAX_ACTIVE_COINS_MOBILE : 10000,\r\n    initialBurst = 1,\r\n    coinTtlMs = 1e99,\r\n    waveSoundSrc = 'sounds/wave_spawn.ogg',\r\n    waveSoundDesktopVolume = 0.45,\r\n    waveSoundMobileVolume  = 0.2,\r\n    waveSoundMinIntervalMs = 160,\r\n    enableDropShadow = false,\r\n} = {}) {\r\n\r\n    let currentCoinSrc = coinSrc;\r\n\r\n    const refs = {\r\n        pf: document.querySelector(playfieldSelector),\r\n        w: document.querySelector(waterSelector),\r\n        c: document.querySelector(coinsHost),\r\n        hud: document.getElementById('hud-bottom'),\r\n    };\r\n\r\n    function validRefs() {\r\n        return !!(refs.pf && refs.w && refs.c);\r\n    }\r\n\r\n    if (!validRefs()) {\r\n        console.warn('[Spawner] Missing required nodes. Check your selectors:', {\r\n            playfieldSelector,\r\n            waterSelector,\r\n            coinsHost\r\n        });\r\n    }\r\n\r\n    // MULTI-LAYER CANVAS SYSTEM\r\n    // We create one canvas per size (0-6).\r\n    // Size 0: z-index 10\r\n    // Size 1: z-index 20\r\n    // ...\r\n    // Size 6: z-index 70\r\n    // Active DOM coins will be interleaved via CSS (11, 21, ..., 71).\r\n    const NUM_LAYERS = 7;\r\n    const canvases = [];\r\n    const contexts = [];\r\n    let canvasDirty = false;\r\n\r\n    if (refs.c) {\r\n        for (let i = 0; i < NUM_LAYERS; i++) {\r\n            const canvas = document.createElement('canvas');\r\n            canvas.style.position = 'absolute';\r\n            canvas.style.inset = '0';\r\n            canvas.style.pointerEvents = 'none';\r\n            // Base z-index for settled coins of this size\r\n            canvas.style.zIndex = `${10 + (i * 10)}`; \r\n            refs.c.appendChild(canvas);\r\n            \r\n            const ctx = canvas.getContext('2d', { alpha: true });\r\n            canvases.push(canvas);\r\n            contexts.push(ctx);\r\n        }\r\n    }\r\n\r\n    let fxCanvas = null;\r\n    let fxCtx = null;\r\n    if (refs.c) {\r\n        fxCanvas = document.createElement('canvas');\r\n        fxCanvas.style.position = 'absolute';\r\n        fxCanvas.style.inset = '0';\r\n        fxCanvas.style.pointerEvents = 'none';\r\n        // FX sits on top of everything\r\n        fxCanvas.style.zIndex = '100'; \r\n        refs.c.appendChild(fxCanvas);\r\n        fxCtx = fxCanvas.getContext('2d', { alpha: true });\r\n    }\r\n\r\n    let deps = {\r\n        collectBatch: null,\r\n        getMagnetUnit: null\r\n    };\r\n\r\n    function setDependencies(d) {\r\n        deps = { ...deps, ...d };\r\n    }\r\n\r\n    let M = {\r\n        pfRect: null,\r\n        wRect: null,\r\n        safeBottom: 0,\r\n        pfW: 0\r\n    };\r\n\r\n    function computeMetrics() {\r\n        if (!validRefs())\r\n            return false;\r\n        const pfRect = refs.pf.getBoundingClientRect();\r\n        const wRect = refs.w.getBoundingClientRect();\r\n        const hudH = refs.hud ? refs.hud.getBoundingClientRect().height : 0;\r\n\r\n        M = {\r\n            pfRect,\r\n            wRect,\r\n            safeBottom: pfRect.height - hudH,\r\n            pfW: pfRect.width\r\n        };\r\n\r\n        const dpr = window.devicePixelRatio || 1;\r\n        \r\n        // Resize all layer canvases\r\n        canvases.forEach((canvas, i) => {\r\n            if (canvas) {\r\n                canvas.width = pfRect.width * dpr;\r\n                canvas.height = pfRect.height * dpr;\r\n                canvas.style.width = pfRect.width + 'px';\r\n                canvas.style.height = pfRect.height + 'px';\r\n                \r\n                const ctx = contexts[i];\r\n                if (ctx) {\r\n                    ctx.setTransform(1, 0, 0, 1, 0, 0);\r\n                    ctx.scale(dpr, dpr);\r\n                    ctx.imageSmoothingEnabled = true;\r\n                    ctx.imageSmoothingQuality = 'high';\r\n                }\r\n            }\r\n        });\r\n        \r\n        // Mark dirty to redraw settled coins on resized canvases\r\n        canvasDirty = true;\r\n\r\n        if (fxCanvas) {\r\n             fxCanvas.width = pfRect.width * dpr;\r\n             fxCanvas.height = pfRect.height * dpr;\r\n             fxCanvas.style.width = pfRect.width + 'px';\r\n             fxCanvas.style.height = pfRect.height + 'px';\r\n             \r\n             if (fxCtx) {\r\n                 fxCtx.setTransform(1, 0, 0, 1, 0, 0);\r\n                 fxCtx.scale(dpr, dpr);\r\n             }\r\n        }\r\n\r\n        return true;\r\n    }\r\n\r\n    computeMetrics();\r\n\r\n    const ro = 'ResizeObserver' in window ? new ResizeObserver(() => computeMetrics()) : null;\r\n    if (ro && refs.pf)\r\n        ro.observe(refs.pf);\r\n    document.addEventListener('visibilitychange', () => {\r\n        if (!document.hidden)\r\n            computeMetrics();\r\n    });\r\n\r\n    const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));\r\n\r\n    const COIN_POOL_MAX = Math.max(2000, maxActiveCoins * 3);\r\n    const COIN_MARGIN = 12;\r\n\r\n    const coinPool = [];\r\n\r\n    const activeCoins = [];\r\n    let garbageCount = 0;\r\n    const newlySettledBuffer = [];\r\n    const dirtyRegions = [];\r\n\r\n    function makeCoin() {\r\n        const el = document.createElement('div');\r\n        el.className = 'coin';\r\n        el.style.position = 'absolute';\r\n        el.style.pointerEvents = 'auto';\r\n        el.style.borderRadius = '50%';\r\n        el.style.willChange = 'transform';\r\n        el.style.contain = 'layout style size';\r\n        \r\n        const inner = document.createElement('img');\r\n        inner.className = 'coin-inner';\r\n        inner.draggable = false;\r\n        inner.alt = '';\r\n        inner.style.width = '100%';\r\n        inner.style.height = '100%';\r\n        inner.src = currentCoinSrc;\r\n        inner.style.objectFit = 'contain';\r\n        inner.style.borderRadius = '50%';\r\n        \r\n        el.appendChild(inner);\r\n\r\n        if (enableDropShadow)\r\n            el.style.filter = 'drop-shadow(0 2px 2px rgba(0,0,0,.35))';\r\n        return el;\r\n    }\r\n    const getCoin = () => (coinPool.length ? coinPool.pop() : makeCoin());\r\n    \r\n    function releaseCoin(el) {\r\n       el.style.transition = '';\r\n       el.style.transform = '';\r\n       el.style.opacity = '1';\r\n       \r\n       el.classList.remove('coin--collected');\r\n       // Remove size classes\r\n       for (let i = 0; i <= 6; i++) {\r\n           el.classList.remove(`coin--size-${i}`);\r\n       }\r\n       el.style.removeProperty('--ccc-start');\r\n\r\n       delete el.dataset.dieAt;\r\n       delete el.dataset.mutationLevel;\r\n       delete el.dataset.collected;\r\n       \r\n       el.style.willChange = 'transform';\r\n       \r\n       if (el.parentNode) el.remove();\r\n       if (coinPool.length < COIN_POOL_MAX) coinPool.push(el);\r\n    }\r\n    \r\n    function removeCoin(coinObj, knownIndex = -1) {\r\n        if (coinObj.isRemoved) return;\r\n        coinObj.isRemoved = true;\r\n        \r\n        let idx = knownIndex;\r\n        if (idx === -1 || activeCoins[idx] !== coinObj) {\r\n            if (coinObj.index !== undefined && activeCoins[coinObj.index] === coinObj) {\r\n                idx = coinObj.index;\r\n            } else {\r\n                idx = activeCoins.indexOf(coinObj);\r\n            }\r\n        }\r\n        if (idx !== -1) {\r\n            activeCoins[idx] = null;\r\n            garbageCount++;\r\n        }\r\n        \r\n        if (coinObj.el) {\r\n            releaseCoin(coinObj.el);\r\n            coinObj.el = null;\r\n        } else {\r\n            // Was on canvas, need redraw\r\n            dirtyRegions.push({\r\n                layer: coinObj.sizeIndex || 0,\r\n                x: coinObj.x,\r\n                y: coinObj.y,\r\n                size: coinObj.size || baseCoinSize\r\n            });\r\n        }\r\n    }\r\n    \r\n    function detachCoin(coinEl) {\r\n        const coinObj = coinEl._coinObj;\r\n        if (coinObj) {\r\n            let idx = -1;\r\n            if (coinObj.index !== undefined && activeCoins[coinObj.index] === coinObj) {\r\n                idx = coinObj.index;\r\n            } else {\r\n                idx = activeCoins.indexOf(coinObj);\r\n            }\r\n\r\n            if (idx !== -1) {\r\n                activeCoins[idx] = null;\r\n                garbageCount++;\r\n            }\r\n            coinEl._coinObj = null;\r\n        }\r\n    }\r\n    \r\n    const waveURL = new URL(waveSoundSrc, document.baseURI).href;\r\n    let waveLastAt = 0;\r\n\r\n    function playWaveOncePerBurst() {\r\n      const now = performance.now();\r\n      if (now - waveLastAt < waveSoundMinIntervalMs) return;\r\n      waveLastAt = now;\r\n      \r\n      const vol = IS_MOBILE ? waveSoundMobileVolume : waveSoundDesktopVolume;\r\n      playAudio(waveURL, { volume: vol, type: 'music' });\r\n    }\r\n\r\n    function planSpawn() {\r\n        if (!validRefs())\r\n            return null;\r\n        if (!M.pfRect || !M.wRect)\r\n            computeMetrics();\r\n\r\n        if (maxActiveCoins !== Infinity && (activeCoins.length - garbageCount) >= maxActiveCoins) {\r\n            let indexToRemove = -1;\r\n            if (isSurgeActive(2)) {\r\n                for (let i = 0; i < activeCoins.length; i++) {\r\n                    const c = activeCoins[i];\r\n                    if (c && c.sizeIndex < 4) {\r\n                        indexToRemove = i;\r\n                        break;\r\n                    }\r\n                }\r\n            } else {\r\n                for (let i = 0; i < activeCoins.length; i++) {\r\n                    if (activeCoins[i]) {\r\n                        indexToRemove = i;\r\n                        break;\r\n                    }\r\n                }\r\n            }\r\n            if (indexToRemove === -1) return null;\r\n            \r\n            const oldest = activeCoins[indexToRemove];\r\n            if (oldest) removeCoin(oldest, indexToRemove);\r\n        }\r\n\r\n        const pfW = M.pfW;\r\n        const waterToPfTop = M.wRect.top - M.pfRect.top;\r\n        const spawnY = Math.max(0, waterToPfTop);\r\n\r\n        // Determine coin size\r\n        let sizeIndex = 0;\r\n        if (isSurgeActive(2)) {\r\n            const r = Math.random();\r\n            for (let i = 6; i >= 1; i--) {\r\n                if (r < COIN_CHANCES[i]) {\r\n                    sizeIndex = i;\r\n                    break;\r\n                }\r\n            }\r\n        }\r\n\r\n        if (sizeIndex >= 4 && shouldBlockBigCoins && shouldBlockBigCoins()) {\r\n            sizeIndex = 3;\r\n        }\r\n\r\n        const size = COIN_SIZES[sizeIndex];\r\n\r\n        // Determine X\r\n        const effectiveMargin = COIN_MARGIN + (sizeIndex >= 3 ? 15 * (sizeIndex - 2) : 0);\r\n        const minX = effectiveMargin;\r\n        const maxX = Math.max(minX, pfW - size - effectiveMargin);\r\n        const spawnX = minX + Math.random() * (maxX - minX);\r\n\r\n        // Plan Coin Trajectory\r\n        const drift = Math.random() * 100 - 50;\r\n        let endX;\r\n        \r\n        if (size >= M.pfW) {\r\n            endX = (M.pfW - size) / 2;\r\n        } else {\r\n             const mx = M.pfW - size - effectiveMargin;\r\n             if (minX >= mx) endX = (M.pfW - size)/2;\r\n             else endX = clamp(spawnX + drift, minX, mx);\r\n        }\r\n        \r\n        // Clamp water height contribution to ~30% of screen to prevent coins going offscreen\r\n        // if the water element is mis-sized or visually overridden.\r\n        const effectiveWaterH = Math.min(M.wRect.height, M.pfRect.height * 0.3);\r\n        const minY = Math.max(effectiveWaterH + 80, 120);\r\n        const maxY = Math.max(minY + 40, M.safeBottom - size - 6);\r\n        const endY = clamp(minY + Math.random() * (maxY - minY), minY, maxY);\r\n        const jitterMs = 0;\r\n        \r\n        const coin = {\r\n            x0: spawnX, y0: spawnY,\r\n            x1: endX, y1: endY,\r\n            jitterMs\r\n        };\r\n\r\n        // Transform coordinates from Playfield Space to Water Canvas Space\r\n        const waterToPfLeft = M.pfRect.left - M.wRect.left;\r\n        \r\n        const def = WAVE_DEFS[sizeIndex];\r\n        const vw = Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0);\r\n        \r\n        // Add random fluctuation (approx +/- 15%)\r\n        const randScale = 0.85 + Math.random() * 0.3;\r\n        \r\n        const waveW = vw * (def.w / 100) * randScale;\r\n        const waveH = vw * (def.h / 100) * randScale;\r\n        \r\n        const waveCenterX = (spawnX + size / 2) + waterToPfLeft;\r\n        \r\n        // waveCenterY needs to be in Water coords\r\n        // spawnY is in Playfield coords. \r\n        // y_water = y_playfield + (pfRect.top - wRect.top)\r\n        // (pfRect.top - wRect.top) is -waterToPfTop\r\n        // We want the wave to be centered roughly on the spawn point so it engulfs the coin.\r\n        const waveCenterY = spawnY - waterToPfTop;\r\n\r\n        return {\r\n            wave: { x: waveCenterX, y: waveCenterY, width: waveW, height: waveH },\r\n            coin,\r\n            sizeIndex\r\n        };\r\n    }\r\n\r\n    function commitBatch(batch) {\r\n      if (!batch.length || !validRefs()) return;\r\n\r\n      const coinsFrag = document.createDocumentFragment();\r\n      \r\n      const newCoins = [];\r\n      const now = performance.now();\r\n      let hasWaves = false;\r\n\r\n      for (const { wave, coin, sizeIndex } of batch) {\r\n        if (wave) {\r\n            hasWaves = true;\r\n            if (waterSystem) {\r\n                // Force top layer for large waves (Size 4, 5, 6)\r\n                const forceTop = sizeIndex >= 4;\r\n                waterSystem.addWave(wave.x, wave.y, wave.width, wave.height, forceTop);\r\n            }\r\n        }\r\n\r\n        const size = COIN_SIZES[sizeIndex];\r\n        let valMult = 1;\r\n        if (isSurgeActive(8)) {\r\n             let nerf = getEffectiveTsunamiNerfWithCombo();\r\n             const base = Math.pow(25, nerf);\r\n             valMult = Math.pow(base, sizeIndex);\r\n        } else {\r\n             valMult = COIN_VALUE_MULTS[sizeIndex];\r\n        }\r\n        const forceDom = sizeIndex >= 4;\r\n\r\n        const el = getCoin();\r\n        el.style.width = `${size}px`;\r\n        el.style.height = `${size}px`;\r\n        el.className = `coin coin--size-${sizeIndex}`; // Add size class\r\n        // Update inner image src\r\n        if (el.firstChild) {\r\n             el.firstChild.src = currentCoinSrc;\r\n        }\r\n        \r\n        el.style.transform = `translate3d(${coin.x0}px, ${coin.y0}px, 0) rotate(-10deg) scale(0.96)`;\r\n        el.style.opacity = '0'; // Hide initially to sync with wave render\r\n\r\n        if (mutationUnlockedSnapshot) {\r\n          el.dataset.mutationLevel = mutationLevelSnapshot.toString();\r\n        } else {\r\n          el.dataset.mutationLevel = '0';\r\n        }\r\n        \r\n        const coinObj = {\r\n            mutationLevel: mutationUnlockedSnapshot ? mutationLevelSnapshot.toString() : '0',\r\n            el,\r\n            src: currentCoinSrc,\r\n            x: coin.x0,\r\n            y: coin.y0,\r\n            rot: -10,\r\n            scale: 0.96,\r\n            startX: coin.x0,\r\n            startY: coin.y0,\r\n            endX: coin.x1,\r\n            endY: coin.y1,\r\n            startTime: now + coin.jitterMs,\r\n            duration: animationDurationMs,\r\n            dieAt: now + coinTtlMs,\r\n            jitterMs: coin.jitterMs,\r\n            isRemoved: false,\r\n            settled: false,\r\n            // Surge 2 properties\r\n            size: size,\r\n            sizeIndex: sizeIndex,\r\n            valueMultiplier: valMult,\r\n            forceDom: forceDom,\r\n            soundSrc: COIN_SOUND_SUFFIXES[sizeIndex] ? `sounds/coin_pickup${COIN_SOUND_SUFFIXES[sizeIndex]}` : null,\r\n            // Pre-calculate trajectory bounds for fast spatial rejection\r\n            // We pad by size to account for the coin's dimensions and rotation\r\n            bMinX: Math.min(coin.x0, coin.x1) - size,\r\n            bMaxX: Math.max(coin.x0, coin.x1) + size,\r\n            bMinY: Math.min(coin.y0, coin.y1) - size,\r\n            bMaxY: Math.max(coin.y0, coin.y1) + size\r\n        };\r\n        \r\n        el._coinObj = coinObj;\r\n        coinObj.index = activeCoins.length;\r\n        activeCoins.push(coinObj);\r\n        newCoins.push(coinObj);\r\n        \r\n        coinsFrag.appendChild(el);\r\n      }\r\n\r\n      refs.c.appendChild(coinsFrag);\r\n\r\n      if (newCoins.length > 0) {\r\n          // Force layout to ensure start position is recorded for transition\r\n          if (newCoins[0].el) void newCoins[0].el.offsetHeight;\r\n\r\n          requestAnimationFrame(() => {\r\n            for (const c of newCoins) {\r\n                if (!c.el) continue;\r\n                c.el.style.transition = `transform ${animationDurationMs}ms ${CUBIC_BEZIER} ${c.jitterMs}ms`;\r\n                c.el.style.transform = `translate3d(${c.endX}px, ${c.endY}px, 0) rotate(0deg) scale(1)`;\r\n                c.el.style.opacity = '1'; // Show after wave renders\r\n            }\r\n          });\r\n      }\r\n\r\n      if (hasWaves) {\r\n          requestAnimationFrame(() => {\r\n             playWaveOncePerBurst();\r\n          });\r\n      }\r\n    }\r\n\r\n    function spawnBurst(n = 1) {\r\n        if (!validRefs())\r\n            return;\r\n        if (!M.pfRect || !M.wRect)\r\n            computeMetrics();\r\n        const batch = [];\r\n        for (let i = 0; i < n; i++) {\r\n            const plan = planSpawn();\r\n            if (plan) {\r\n                batch.push(plan);\r\n            }\r\n        }\r\n        if (batch.length)\r\n            commitBatch(batch);\r\n    }\r\n\r\n    function getCoinState(c, now) {\r\n        if (c.settled || c.isRemoved) {\r\n            return { x: c.x, y: c.y, rot: 0, scale: 1 };\r\n        }\r\n        const elapsed = now - c.startTime;\r\n        if (elapsed < 0) {\r\n            return { x: c.startX, y: c.startY, rot: -10, scale: 0.96 };\r\n        }\r\n        let t = elapsed / c.duration;\r\n        if (t >= 1) {\r\n             return { x: c.endX, y: c.endY, rot: 0, scale: 1 };\r\n        }\r\n        const ease = easeOutCubic(t);\r\n        const x = c.startX + (c.endX - c.startX) * ease;\r\n        const y = c.startY + (c.endY - c.startY) * ease;\r\n        const rot = -10 + (10 * ease);\r\n        const scale = 0.96 + (0.04 * ease);\r\n        return { x, y, rot, scale };\r\n    }\r\n\r\n    function drawSingleSettledCoin(ctx, c) {\r\n        const img = getImage(c.src);\r\n        if (img && img.complete && img.naturalWidth > 0) {\r\n             // Use coin specific size\r\n             const size = c.size || baseCoinSize;\r\n             ctx.drawImage(img, c.x, c.y, size, size);\r\n        }\r\n    }\r\n\r\n    function drawSettledCoins() {\r\n        if (!contexts.length) return;\r\n        \r\n        if (canvasDirty) {\r\n            // Clear all canvases\r\n            contexts.forEach((ctx, i) => {\r\n                if (canvases[i]) {\r\n                    ctx.save();\r\n                    ctx.setTransform(1, 0, 0, 1, 0, 0);\r\n                    ctx.clearRect(0, 0, canvases[i].width, canvases[i].height);\r\n                    ctx.restore();\r\n                    \r\n                    if (enableDropShadow) {\r\n                         ctx.save();\r\n                         ctx.shadowColor = 'rgba(0,0,0,0.35)';\r\n                         ctx.shadowBlur = 2;\r\n                         ctx.shadowOffsetY = 2;\r\n                    }\r\n                }\r\n            });\r\n\r\n            const count = activeCoins.length;\r\n            for (let i = 0; i < count; i++) {\r\n                const c = activeCoins[i]; if (!c) continue;\r\n                if (c && c.settled && !c.isRemoved && !c.el) {\r\n                    const layerIdx = c.sizeIndex || 0;\r\n                    if (contexts[layerIdx]) {\r\n                        drawSingleSettledCoin(contexts[layerIdx], c);\r\n                    }\r\n                }\r\n            }\r\n            \r\n            if (enableDropShadow) {\r\n                contexts.forEach(ctx => ctx.restore());\r\n            }\r\n\r\n            canvasDirty = false;\r\n            newlySettledBuffer.length = 0;\r\n            dirtyRegions.length = 0;\r\n        } else {\r\n            // Partial updates for removed coins\r\n            if (dirtyRegions.length > 0) {\r\n                if (enableDropShadow) {\r\n                     contexts.forEach(ctx => {\r\n                         ctx.save();\r\n                         ctx.shadowColor = 'rgba(0,0,0,0.35)';\r\n                         ctx.shadowBlur = 2;\r\n                         ctx.shadowOffsetY = 2;\r\n                     });\r\n                }\r\n\r\n                const count = activeCoins.length;\r\n                // Process dirty regions\r\n                for (let i = 0; i < dirtyRegions.length; i++) {\r\n                    const r = dirtyRegions[i];\r\n                    const ctx = contexts[r.layer];\r\n                    if (!ctx) continue;\r\n                    \r\n                    // Clear the hole (expanded for shadows/AA)\r\n                    const pad = 8;\r\n                    const cx = r.x - pad;\r\n                    const cy = r.y - pad;\r\n                    const cSize = r.size + (pad * 2);\r\n\r\n                    ctx.save();\r\n                    ctx.beginPath();\r\n                    ctx.rect(cx, cy, cSize, cSize);\r\n                    ctx.clip();\r\n                    ctx.clearRect(cx, cy, cSize, cSize);\r\n                    \r\n                    // Redraw overlapping settled coins\r\n                    // We only check coins on the same layer since layers are separate canvases\r\n                    const minX = cx;\r\n                    const maxX = cx + cSize;\r\n                    const minY = cy;\r\n                    const maxY = cy + cSize;\r\n                    \r\n                    for (let j = 0; j < count; j++) {\r\n                        const c = activeCoins[j];\r\n                        if (!c || !c.settled || c.isRemoved || c.el) continue;\r\n                        if ((c.sizeIndex || 0) !== r.layer) continue;\r\n                        \r\n                        // Simple AABB check\r\n                        const cSize = c.size || baseCoinSize;\r\n                        const cMinX = c.x;\r\n                        const cMaxX = c.x + cSize;\r\n                        const cMinY = c.y;\r\n                        const cMaxY = c.y + cSize;\r\n                        \r\n                        if (cMaxX > minX && cMinX < maxX && cMaxY > minY && cMinY < maxY) {\r\n                             drawSingleSettledCoin(ctx, c);\r\n                        }\r\n                    }\r\n                    ctx.restore();\r\n                }\r\n                \r\n                if (enableDropShadow) {\r\n                     contexts.forEach(ctx => ctx.restore());\r\n                }\r\n                dirtyRegions.length = 0;\r\n            }\r\n\r\n            if (newlySettledBuffer.length > 0) {\r\n                if (enableDropShadow) {\r\n                     contexts.forEach(ctx => {\r\n                         ctx.save();\r\n                     ctx.shadowColor = 'rgba(0,0,0,0.35)';\r\n                     ctx.shadowBlur = 2;\r\n                     ctx.shadowOffsetY = 2;\r\n                 });\r\n            }\r\n\r\n            for (let i = 0; i < newlySettledBuffer.length; i++) {\r\n                const c = newlySettledBuffer[i];\r\n                if (!c.isRemoved && c.settled && !c.el) {\r\n                    const layerIdx = c.sizeIndex || 0;\r\n                    if (contexts[layerIdx]) {\r\n                        drawSingleSettledCoin(contexts[layerIdx], c);\r\n                    }\r\n                }\r\n            }\r\n\r\n            if (enableDropShadow) {\r\n                 contexts.forEach(ctx => ctx.restore());\r\n            }\r\n            newlySettledBuffer.length = 0;\r\n        }\r\n    }\r\n    }\r\n\r\n    let rate = coinsPerSecond;\r\n    let rafId = null;\r\n    let last = performance.now();\r\n    let carry = 0;\r\n    \r\n    function loop(now) {\r\n      if (!M.pfRect || !M.wRect) computeMetrics();\r\n\r\n      let dt = (now - last) / 1000;\r\n      last = now;\r\n      \r\n      if (dt > 0.1) dt = 0.1;\r\n      \r\n      {\r\n          for (let i = activeCoins.length - 1; i >= 0; i--) {\r\n              const c = activeCoins[i]; if (!c) continue;\r\n              if (!c) continue; // Safety check if array was mutated\r\n              \r\n              if (now >= c.dieAt) {\r\n                  removeCoin(c, i);\r\n                  continue;\r\n              }\r\n              \r\n              // NEW: Size 5 Logic (Blue Lightning) moved here\r\n              if (c.sizeIndex === 5 && !c.isRemoved) {\r\n                    if (!c.lastLightningTime) {\r\n                        c.lastLightningTime = now - 1000; \r\n                        c.nextLightningInterval = 0;\r\n                    }\r\n                    if (now - c.lastLightningTime > c.nextLightningInterval) {\r\n                        c.lastLightningTime = now;\r\n                        c.nextLightningInterval = 200 + Math.random() * 100;\r\n                        // Spawn 3 simultaneous bolts\r\n                        for (let k = 0; k < 3; k++) {\r\n                            createBranchingLightning(c, now);\r\n                        }\r\n                    }\r\n              }\r\n\r\n              // Size 6 Logic\r\n              if (c.sizeIndex === 6 && !c.isRemoved) {\r\n                   if (!c.lastLightningTime) {\r\n                      c.lastLightningTime = now - 1000;\r\n                      c.nextLightningInterval = 0;\r\n                  }\r\n                  if (now - c.lastLightningTime > c.nextLightningInterval) {\r\n                      c.lastLightningTime = now;\r\n                      c.nextLightningInterval = 200 + Math.random() * 100;\r\n\r\n                      if (deps.collectBatch) {\r\n                           const s = getCoinState(c, now);\r\n                           const cx = s.x + c.size/2;\r\n                           const cy = s.y + c.size/2;\r\n                           \r\n                           // Identify potential candidates globally (no radius limit)\r\n                           const candidates = [];\r\n                           const minDistSq = (c.size/2) * (c.size/2);\r\n\r\n                           const totalCoins = activeCoins.length;\r\n                           for (let k = 0; k < totalCoins; k++) {\r\n                               const t = activeCoins[k];\r\n                               if (!t) continue;\r\n                               if (t === c || t.isRemoved || t.settled === false) continue;\r\n                               // Only attack size 3 or lower\r\n                               if (t.sizeIndex > 3) continue;\r\n\r\n                               const tx = t.x + (t.size||baseCoinSize)/2;\r\n                               const ty = t.y + (t.size||baseCoinSize)/2;\r\n                               const dx = tx - cx;\r\n                               const dy = ty - cy;\r\n                               \r\n                               // Ensure not overlapping source\r\n                               if (dx*dx + dy*dy > minDistSq) {\r\n                                   candidates.push(t);\r\n                               }\r\n                           }\r\n\r\n                           if (candidates.length > 0) {\r\n                               // Shuffle candidates to pick up to 3 distinct ones\r\n                               for (let k = candidates.length - 1; k > 0; k--) {\r\n                                   const j = Math.floor(Math.random() * (k + 1));\r\n                                   [candidates[k], candidates[j]] = [candidates[j], candidates[k]];\r\n                               }\r\n                               \r\n                               const targets = candidates.slice(0, 3);\r\n                               const itemsToCollect = [];\r\n                               let audioPlayed = false;\r\n\r\n                               for (const target of targets) {\r\n                                   const targetSize = target.size || baseCoinSize;\r\n                                   const tx = target.x + targetSize/2;\r\n                                   const ty = target.y + targetSize/2;\r\n                                   \r\n                                   createTargetedBranchingLightning(c, tx, ty);\r\n                                   addStain(tx, ty, targetSize);\r\n                                   itemsToCollect.push({ coin: target });\r\n                                   \r\n                                   if (!audioPlayed) {\r\n                                       playAudio('sounds/lightning_strike.ogg', { volume: 0.25 });\r\n                                       audioPlayed = true;\r\n                                   }\r\n                               }\r\n                               \r\n                               if (itemsToCollect.length > 0) {\r\n                                   deps.collectBatch(itemsToCollect);\r\n                               }\r\n                           }\r\n                      }\r\n                  }\r\n              }\r\n\r\n              if (c.settled) {\r\n                // OLD Size 5 Logic REMOVED\r\n\r\n                continue;\r\n              }\r\n              \r\n              const elapsed = now - c.startTime;\r\n              if (elapsed < 0) continue;\r\n              \r\n              let t = elapsed / c.duration;\r\n              if (t >= 1) {\r\n                  c.settled = true;\r\n                  c.x = c.endX;\r\n                  c.y = c.endY;\r\n                  c.rot = 0;\r\n                  c.scale = 1;\r\n                  // If forceDom (Size 4+), we keep it as DOM element and do NOT push to canvas buffer\r\n                  if (c.el && !c.forceDom) {\r\n                      releaseCoin(c.el);\r\n                      c.el = null;\r\n                      newlySettledBuffer.push(c);\r\n                  } else if (c.el) {\r\n                      // Ensure final state is set properly for DOM coins\r\n                      c.el.style.transition = 'none';\r\n                      c.el.style.transform = `translate3d(${c.x}px, ${c.y}px, 0) rotate(0deg) scale(1)`;\r\n                  }\r\n                  continue;\r\n              }\r\n              \r\n              // Optimization: We skip updating c.x/y/rot/scale every frame.\r\n              // We calculate them on-demand for hit testing.\r\n              // Visuals are handled by CSS transitions so this is safe.\r\n          }\r\n      }\r\n\r\n      carry += rate * dt;\r\n      let spawnCount = Math.floor(carry);\r\n      \r\n      if (spawnCount > 0) {\r\n          carry -= spawnCount;\r\n          let spawnTarget = Math.min(spawnCount, perFrameBudget);\r\n          \r\n          if (spawnTarget > 0) {\r\n             const t0 = performance.now();\r\n             const batch = [];\r\n             const timeBudgetMs = 5.0;\r\n             \r\n             for (let i = 0; i < spawnTarget; i++) {\r\n                if (performance.now() - t0 > timeBudgetMs) break;\r\n                const plan = planSpawn();\r\n                if (plan) {\r\n                    batch.push(plan);\r\n                }\r\n             }\r\n             if (batch.length) {\r\n                 commitBatch(batch);\r\n             }\r\n          }\r\n      }\r\n\r\n      drawSettledCoins();\r\n      if (garbageCount > 50) {\r\n          let w = 0;\r\n          for (let r = 0; r < activeCoins.length; r++) {\r\n              const c = activeCoins[r];\r\n              if (c !== null) {\r\n                  c.index = w;\r\n                  activeCoins[w++] = c;\r\n              }\r\n          }\r\n          activeCoins.length = w;\r\n          garbageCount = 0;\r\n      }\r\n      drawFx(dt);\r\n\r\n      rafId = requestAnimationFrame(loop);\r\n    }\r\n\r\n    function start() {\r\n      if (rafId) return;\r\n      if (!validRefs()) {\r\n        console.warn('[Spawner] start() called but required nodes are missing.');\r\n        return;\r\n      }\r\n      computeMetrics();\r\n\r\n      if (initialBurst > 0 && rafId === null) {\r\n        spawnBurst(initialBurst);\r\n      }\r\n\r\n      last = performance.now();\r\n      rafId = requestAnimationFrame(loop);\r\n    }\r\n\r\n    function stop() {\r\n        if (!rafId)\r\n            return;\r\n        cancelAnimationFrame(rafId);\r\n        rafId = null;\r\n    }\r\n\r\n    function setRate(n) {\r\n        rate = Math.max(0, Number(n) || 0);\r\n    }\r\n\r\n    function clearBacklog() {\r\n        carry = 0;\r\n        last = performance.now();\r\n    }\r\n\r\n    function clearPlayfield(resetType) {\r\n        const keepBigCoins = isSurgeActive(2) && !!resetType;\r\n        for (let i = activeCoins.length - 1; i >= 0; i--) {\r\n            const c = activeCoins[i]; if (!c) continue;\r\n            if (!c) continue;\r\n            if (keepBigCoins && c.sizeIndex >= 4) {\r\n                 c.mutationLevel = mutationUnlockedSnapshot ? mutationLevelSnapshot.toString() : '0';\r\n                 if (c.el) c.el.dataset.mutationLevel = c.mutationLevel;\r\n                 continue;\r\n            }\r\n            removeCoin(activeCoins[i], i);\r\n        }\r\n        clearBacklog();\r\n    }\r\n\r\n    function setCoinSprite(src) {\r\n      if (!src) return;\r\n      currentCoinSrc = src;\r\n    }\r\n\r\n    function getCoinTransform(el) {\r\n        const c = el._coinObj;\r\n        if (!c) return el.style.transform || 'translate3d(0,0,0)';\r\n        const { x, y, rot, scale } = getCoinState(c, performance.now());\r\n        return `translate3d(${x}px, ${y}px, 0) rotate(${rot}deg) scale(${scale})`;\r\n    }\r\n    \r\n    function ensureCoinVisual(c) {\r\n        if (c.el) return c.el;\r\n        if (c.isRemoved) return null;\r\n        \r\n        const el = getCoin();\r\n        const size = c.size || baseCoinSize;\r\n        el.style.width = `${size}px`;\r\n        el.style.height = `${size}px`;\r\n        el.className = `coin coin--size-${c.sizeIndex || 0}`;\r\n        \r\n        el.style.transition = '';\r\n        el.style.transform = `translate3d(${c.x}px, ${c.y}px, 0) rotate(0deg) scale(1)`;\r\n        \r\n        if (el.firstChild) {\r\n            el.firstChild.src = c.src;\r\n        }\r\n        \r\n        el.style.opacity = '1';\r\n        el.dataset.mutationLevel = c.mutationLevel;\r\n        \r\n        el._coinObj = c;\r\n        c.el = el;\r\n        refs.c.appendChild(el);\r\n        \r\n        dirtyRegions.push({\r\n            layer: c.sizeIndex || 0,\r\n            x: c.x,\r\n            y: c.y,\r\n            size: c.size || baseCoinSize\r\n        });\r\n        \r\n        return el;\r\n    }\r\n\r\n    function findCoinTargetsInRadius(centerX, centerY, radius, useVisualHitbox) {\r\n        let searchRadius = radius;\r\n        if (useVisualHitbox) {\r\n             searchRadius = Math.max(radius, 260);\r\n        }\r\n\r\n        const radiusSq = radius * radius;\r\n        const candidates = [];\r\n        const count = activeCoins.length;\r\n        \r\n        const minX = centerX - searchRadius;\r\n        const maxX = centerX + searchRadius;\r\n        const minY = centerY - searchRadius;\r\n        const maxY = centerY + searchRadius;\r\n\r\n        const now = performance.now();\r\n        \r\n        for (let i = 0; i < count; i++) {\r\n            const c = activeCoins[i]; if (!c) continue;\r\n\r\n            // Fast rejection based on trajectory bounds\r\n            if (c.bMaxX < minX || c.bMinX > maxX || c.bMaxY < minY || c.bMinY > maxY) {\r\n                continue;\r\n            }\r\n\r\n            const size = c.size || baseCoinSize;\r\n            \r\n            let cx, cy;\r\n            \r\n            if (c.settled) {\r\n                cx = c.x + (size / 2);\r\n                cy = c.y + (size / 2);\r\n            } else {\r\n                const s = getCoinState(c, now);\r\n                cx = s.x + (size / 2);\r\n                cy = s.y + (size / 2);\r\n            }\r\n            \r\n            if (cx < minX || cx > maxX) continue;\r\n            if (cy < minY || cy > maxY) continue;\r\n\r\n            const dx = cx - centerX;\r\n            const dy = cy - centerY;\r\n            \r\n            let limitSq = radiusSq;\r\n            if (useVisualHitbox && (c.sizeIndex || 0) > 0) {\r\n                 const r = size / 2;\r\n                 limitSq = r * r;\r\n            }\r\n\r\n            if ((dx*dx + dy*dy) <= limitSq) {\r\n                if (!c.isRemoved) {\r\n                    candidates.push(c);\r\n                }\r\n            }\r\n        }\r\n        return candidates;\r\n    }\r\n\r\n    function findCoinTargetsInPath(x1, y1, x2, y2, radius, useVisualHitbox) {\r\n        let searchRadius = radius;\r\n        if (useVisualHitbox) {\r\n             searchRadius = Math.max(radius, 260);\r\n        }\r\n\r\n        const radiusSq = radius * radius;\r\n        const candidates = [];\r\n        const count = activeCoins.length;\r\n\r\n        const minX = Math.min(x1, x2) - searchRadius;\r\n        const maxX = Math.max(x1, x2) + searchRadius;\r\n        const minY = Math.min(y1, y2) - searchRadius;\r\n        const maxY = Math.max(y1, y2) + searchRadius;\r\n\r\n        const vx = x2 - x1;\r\n        const vy = y2 - y1;\r\n        const lenSq = vx * vx + vy * vy;\r\n        const crossLimit = radiusSq * lenSq;\r\n        const now = performance.now();\r\n\r\n        for (let i = 0; i < count; i++) {\r\n            const c = activeCoins[i]; if (!c) continue;\r\n\r\n            // Fast rejection based on trajectory bounds\r\n            if (c.bMaxX < minX || c.bMinX > maxX || c.bMaxY < minY || c.bMinY > maxY) {\r\n                continue;\r\n            }\r\n\r\n            const size = c.size || baseCoinSize;\r\n            \r\n            let cx, cy;\r\n            if (c.settled) {\r\n                cx = c.x + (size / 2);\r\n                cy = c.y + (size / 2);\r\n            } else {\r\n                const s = getCoinState(c, now);\r\n                cx = s.x + (size / 2);\r\n                cy = s.y + (size / 2);\r\n            }\r\n            \r\n            if (cx < minX || cx > maxX) continue;\r\n            if (cy < minY || cy > maxY) continue;\r\n\r\n            const wx = cx - x1;\r\n            const wy = cy - y1;\r\n            \r\n            const dot = wx * vx + wy * vy;\r\n            \r\n            let limitSq = radiusSq;\r\n            if (useVisualHitbox && (c.sizeIndex || 0) > 0) {\r\n                 const r = size / 2;\r\n                 limitSq = r * r;\r\n            }\r\n\r\n            let hit = false;\r\n            if (dot <= 0) {\r\n                if ((wx * wx + wy * wy) <= limitSq) hit = true;\r\n            } else if (dot >= lenSq) {\r\n                const dx = cx - x2;\r\n                const dy = cy - y2;\r\n                if ((dx * dx + dy * dy) <= limitSq) hit = true;\r\n            } else {\r\n                const cross = wx * vy - wy * vx;\r\n                if (cross * cross <= limitSq * lenSq) hit = true;\r\n            }\r\n            \r\n            if (hit && !c.isRemoved) {\r\n                candidates.push(c);\r\n            }\r\n        }\r\n        return candidates;\r\n    }\r\n\r\n    function removeCoinTarget(c) {\r\n        removeCoin(c);\r\n    }\r\n\r\n    function findCoinsInRadius(centerX, centerY, radius) {\r\n        const radiusSq = radius * radius;\r\n        const candidates = [];\r\n        const count = activeCoins.length;\r\n        \r\n        const minX = centerX - radius;\r\n        const maxX = centerX + radius;\r\n        const minY = centerY - radius;\r\n        const maxY = centerY + radius;\r\n\r\n        const now = performance.now();\r\n        \r\n        for (let i = 0; i < count; i++) {\r\n            const c = activeCoins[i]; if (!c) continue;\r\n\r\n            // Fast rejection based on trajectory bounds\r\n            if (c.bMaxX < minX || c.bMinX > maxX || c.bMaxY < minY || c.bMinY > maxY) {\r\n                continue;\r\n            }\r\n\r\n            const size = c.size || baseCoinSize;\r\n            \r\n            let cx, cy;\r\n            if (c.settled) {\r\n                cx = c.x + (size / 2);\r\n                cy = c.y + (size / 2);\r\n            } else {\r\n                const s = getCoinState(c, now);\r\n                cx = s.x + (size / 2);\r\n                cy = s.y + (size / 2);\r\n            }\r\n            \r\n            if (cx < minX || cx > maxX) continue;\r\n            if (cy < minY || cy > maxY) continue;\r\n\r\n            const dx = cx - centerX;\r\n            const dy = cy - centerY;\r\n            \r\n            if ((dx*dx + dy*dy) <= radiusSq) {\r\n                if (!c.el && !c.isRemoved) {\r\n                     ensureCoinVisual(c);\r\n                }\r\n                if (c.el) candidates.push(c.el);\r\n            }\r\n        }\r\n        return candidates;\r\n    }\r\n\r\n    function findCoinsInPath(x1, y1, x2, y2, radius) {\r\n        const radiusSq = radius * radius;\r\n        const candidates = [];\r\n        const count = activeCoins.length;\r\n\r\n        const minX = Math.min(x1, x2) - radius;\r\n        const maxX = Math.max(x1, x2) + radius;\r\n        const minY = Math.min(y1, y2) - radius;\r\n        const maxY = Math.max(y1, y2) + radius;\r\n\r\n        const vx = x2 - x1;\r\n        const vy = y2 - y1;\r\n        const lenSq = vx * vx + vy * vy;\r\n        const crossLimit = radiusSq * lenSq;\r\n        const now = performance.now();\r\n\r\n        for (let i = 0; i < count; i++) {\r\n            const c = activeCoins[i]; if (!c) continue;\r\n\r\n            // Fast rejection based on trajectory bounds\r\n            if (c.bMaxX < minX || c.bMinX > maxX || c.bMaxY < minY || c.bMinY > maxY) {\r\n                continue;\r\n            }\r\n\r\n            const size = c.size || baseCoinSize;\r\n            \r\n            let cx, cy;\r\n            if (c.settled) {\r\n                cx = c.x + (size / 2);\r\n                cy = c.y + (size / 2);\r\n            } else {\r\n                const s = getCoinState(c, now);\r\n                cx = s.x + (size / 2);\r\n                cy = s.y + (size / 2);\r\n            }\r\n            \r\n            if (cx < minX || cx > maxX) continue;\r\n            if (cy < minY || cy > maxY) continue;\r\n\r\n            const wx = cx - x1;\r\n            const wy = cy - y1;\r\n            \r\n            const dot = wx * vx + wy * vy;\r\n            \r\n            let hit = false;\r\n            if (dot <= 0) {\r\n                if ((wx * wx + wy * wy) <= radiusSq) hit = true;\r\n            } else if (dot >= lenSq) {\r\n                const dx = cx - x2;\r\n                const dy = cy - y2;\r\n                if ((dx * dx + dy * dy) <= radiusSq) hit = true;\r\n            } else {\r\n                const cross = wx * vy - wy * vx;\r\n                if (cross * cross <= crossLimit) hit = true;\r\n            }\r\n            \r\n            if (hit) {\r\n                if (!c.el && !c.isRemoved) {\r\n                     ensureCoinVisual(c);\r\n                }\r\n                if (c.el) candidates.push(c.el);\r\n            }\r\n        }\r\n        return candidates;\r\n    }\r\n\r\n   document.addEventListener('visibilitychange', () => {\r\n    if (!document.hidden) {\r\n      if (typeof window !== 'undefined' && window.__tsunamiActive) return;\r\n      if (!rafId) start();\r\n    }\r\n  });\r\n\r\n    function playEntranceWave() {\r\n        if (!validRefs()) return;\r\n        spawnBurst(1);\r\n    }\r\n\r\n    // --- FX System ---\r\n    const bolts = []; // { x1, y1, x2, y2, age, life, jaggedScale, width }\r\n    const sparks = []; // { x, y, vx, vy, age, life, color }\r\n\r\n    function addBolt(sourceCoin, targetCoin) {\r\n        if (!sourceCoin || !targetCoin) return;\r\n        const sSize = sourceCoin.size || baseCoinSize;\r\n        const tSize = targetCoin.size || baseCoinSize;\r\n        const x1 = sourceCoin.x + sSize/2;\r\n        const y1 = sourceCoin.y + sSize/2;\r\n        const x2 = targetCoin.x + tSize/2;\r\n        const y2 = targetCoin.y + tSize/2;\r\n        \r\n        bolts.push({\r\n            x1, y1, x2, y2,\r\n            age: 0,\r\n            life: 0.15 // seconds\r\n        });\r\n    }\r\n\r\n    function addStain(cx, cy, size) {\r\n        if (!refs.pf) return;\r\n        const st = document.createElement('div');\r\n        st.className = 'coin-stain';\r\n        const d = size * 1.2;\r\n        st.style.width = `${d}px`;\r\n        st.style.height = `${d}px`;\r\n        st.style.left = `${cx - d/2}px`;\r\n        st.style.top = `${cy - d/2}px`;\r\n        refs.pf.appendChild(st);\r\n        \r\n        // Remove after 2.5s\r\n        setTimeout(() => {\r\n            st.style.opacity = '0';\r\n            setTimeout(() => { if(st.parentNode) st.remove(); }, 1000);\r\n        }, 2500);\r\n    }\r\n\r\n    // NEW HELPER\r\n    function createBranchingLightning(coin, now) {\r\n         const angle = Math.random() * Math.PI * 2;\r\n         const r = (coin.size || baseCoinSize) / 2;\r\n         \r\n         const startDist = r * LIGHTNING_START_RADIUS_RATIO;\r\n         const relStartX = Math.cos(angle) * startDist;\r\n         const relStartY = Math.sin(angle) * startDist;\r\n         \r\n         const len = r * (0.7 + Math.random() * 0.6); \r\n         const relEndX = Math.cos(angle) * (startDist + len);\r\n         const relEndY = Math.sin(angle) * (startDist + len);\r\n         \r\n         bolts.push({\r\n             parentCoin: coin,\r\n             relX1: relStartX, relY1: relStartY,\r\n             relX2: relEndX, relY2: relEndY,\r\n             x1: 0, y1: 0, x2: 0, y2: 0, \r\n             age: 0,\r\n             life: 0.2, \r\n             jaggedScale: 20,\r\n             width: 5.0 \r\n         });\r\n         \r\n         const numBranches = 3 + Math.floor(Math.random() * 3); \r\n         for (let i = 0; i < numBranches; i++) {\r\n             const t = 0.3 + Math.random() * 0.5;\r\n             const bSx = relStartX + (relEndX - relStartX) * t;\r\n             const bSy = relStartY + (relEndY - relStartY) * t;\r\n             \r\n             const branchAngle = angle + (Math.random() * 1.2 - 0.6); \r\n             const branchLen = len * (0.4 + Math.random() * 0.4);\r\n             \r\n             const bEx = bSx + Math.cos(branchAngle) * branchLen;\r\n             const bEy = bSy + Math.sin(branchAngle) * branchLen;\r\n             \r\n             bolts.push({\r\n                 parentCoin: coin,\r\n                 relX1: bSx, relY1: bSy,\r\n                 relX2: bEx, relY2: bEy,\r\n                 x1: 0, y1: 0, x2: 0, y2: 0,\r\n                 age: 0,\r\n                 life: 0.2,\r\n                 jaggedScale: 10,\r\n                 width: 2.5\r\n             });\r\n         }\r\n\r\n         playAudio('sounds/lightning_zap.ogg', { volume: 0.25 });\r\n    }\r\n\r\n    function createTargetedBranchingLightning(sourceCoin, targetX, targetY) {\r\n         if (!sourceCoin) return;\r\n         const size = sourceCoin.size || baseCoinSize;\r\n         // Calculate start pos on source coin rim\r\n         // We can use parentCoin support but endX/endY will be absolute.\r\n         // However, we need to know the initial angle to pick the start point on the rim.\r\n         // Since drawFx recalculates startX based on parentCoin, we need relX1 to be fixed.\r\n         \r\n         const now = performance.now();\r\n         const s = getCoinState(sourceCoin, now);\r\n         const cx = s.x + size/2;\r\n         const cy = s.y + size/2;\r\n         \r\n         const dx = targetX - cx;\r\n         const dy = targetY - cy;\r\n         const angle = Math.atan2(dy, dx);\r\n         const dist = Math.sqrt(dx*dx + dy*dy);\r\n         \r\n         const startDist = (size / 2) * LIGHTNING_START_RADIUS_RATIO; \r\n         const relStartX = Math.cos(angle) * startDist;\r\n         const relStartY = Math.sin(angle) * startDist;\r\n         \r\n         // Main bolt\r\n         // Start is relative to parent, End is absolute.\r\n         bolts.push({\r\n             parentCoin: sourceCoin,\r\n             relX1: relStartX, relY1: relStartY,\r\n             x2: targetX, y2: targetY,\r\n             age: 0,\r\n             life: 0.25,\r\n             width: 6,\r\n             jaggedScale: 25\r\n         });\r\n         \r\n         // Branches for visual complexity (\"tons of branches\")\r\n         // We calculate branches in absolute space based on the current snapshot of Main Bolt.\r\n         \r\n         const startX = cx + relStartX;\r\n         const startY = cy + relStartY;\r\n         \r\n         const numBranches = 6 + Math.floor(Math.random() * 5); // Increased for complexity\r\n         for (let i = 0; i < numBranches; i++) {\r\n             const t = 0.1 + Math.random() * 0.8; // Split 10-90% along path\r\n             \r\n             // Interpolate along the straight line for split point\r\n             const splitX = startX + (targetX - startX) * t;\r\n             const splitY = startY + (targetY - startY) * t;\r\n             \r\n             const branchAngle = angle + (Math.random() * 1.6 - 0.8); // deviation\r\n             const branchLen = dist * (0.1 + Math.random() * 0.3); // length relative to total distance\r\n             \r\n             const endBX = splitX + Math.cos(branchAngle) * branchLen;\r\n             const endBY = splitY + Math.sin(branchAngle) * branchLen;\r\n             \r\n             bolts.push({\r\n                 x1: splitX, y1: splitY,\r\n                 x2: endBX, y2: endBY,\r\n                 age: 0,\r\n                 life: 0.25, // match main\r\n                 width: 2.0,\r\n                 jaggedScale: 15\r\n             });\r\n             \r\n             // Occasional sub-branch\r\n             if (Math.random() < 0.4) {\r\n                 const subT = 0.5;\r\n                 const subSx = splitX + (endBX - splitX) * subT;\r\n                 const subSy = splitY + (endBY - splitY) * subT;\r\n                 const subAngle = branchAngle + (Math.random() * 1.0 - 0.5);\r\n                 const subLen = branchLen * 0.5;\r\n                 \r\n                 bolts.push({\r\n                     x1: subSx, y1: subSy,\r\n                     x2: subSx + Math.cos(subAngle) * subLen,\r\n                     y2: subSy + Math.sin(subAngle) * subLen,\r\n                     age: 0,\r\n                     life: 0.25,\r\n                     width: 1.5,\r\n                     jaggedScale: 10\r\n                 });\r\n             }\r\n         }\r\n    }\r\n\r\n    function drawFx(dt) {\r\n        if (!fxCtx || !fxCanvas) return;\r\n        fxCtx.clearRect(0, 0, fxCanvas.width, fxCanvas.height);\r\n        \r\n        const now = performance.now();\r\n\r\n        // Update and draw bolts\r\n        fxCtx.lineCap = 'round';\r\n        fxCtx.lineJoin = 'round';\r\n        for (let i = bolts.length - 1; i >= 0; i--) {\r\n            const b = bolts[i];\r\n            b.age += dt;\r\n            if (b.age >= b.life) {\r\n                bolts.splice(i, 1);\r\n                continue;\r\n            }\r\n\r\n            let startX = b.x1, startY = b.y1;\r\n            let endX = b.x2, endY = b.y2;\r\n\r\n            if (b.parentCoin) {\r\n                 const s = getCoinState(b.parentCoin, now);\r\n                 const cx = s.x + (b.parentCoin.size || baseCoinSize) / 2;\r\n                 const cy = s.y + (b.parentCoin.size || baseCoinSize) / 2;\r\n                 startX = cx + b.relX1;\r\n                 startY = cy + b.relY1;\r\n                 if (b.relX2 !== undefined) {\r\n                     endX = cx + b.relX2;\r\n                     endY = cy + b.relY2;\r\n                 }\r\n            }\r\n            \r\n            const alpha = 1 - (b.age / b.life);\r\n            fxCtx.strokeStyle = `rgba(200, 240, 255, ${alpha})`;\r\n            fxCtx.lineWidth = b.width || 3;\r\n            fxCtx.shadowColor = 'rgba(220, 245, 255, 0.9)';\r\n            fxCtx.shadowBlur = 20;\r\n            \r\n            // Jagged line\r\n            const segments = 6;\r\n            fxCtx.beginPath();\r\n            fxCtx.moveTo(startX, startY);\r\n            \r\n            for (let j = 1; j <= segments; j++) {\r\n                const t = j / segments;\r\n                const tx = startX + (endX - startX) * t;\r\n                const ty = startY + (endY - startY) * t;\r\n                \r\n                if (j === segments) {\r\n                    fxCtx.lineTo(endX, endY);\r\n                } else {\r\n                    const perpX = -(endY - startY);\r\n                    const perpY = (endX - startX);\r\n                    const len = Math.sqrt(perpX*perpX + perpY*perpY);\r\n                    const jaggedness = b.jaggedScale || 40;\r\n                    if (len > 0) {\r\n                        const scale = (Math.random() - 0.5) * jaggedness * (1 - Math.abs(t - 0.5)); // Bulge in middle\r\n                        fxCtx.lineTo(tx + (perpX/len)*scale, ty + (perpY/len)*scale);\r\n                    } else {\r\n                        fxCtx.lineTo(tx, ty);\r\n                    }\r\n                }\r\n            }\r\n            fxCtx.stroke();\r\n            fxCtx.shadowBlur = 0;\r\n        }\r\n\r\n\r\n        // Draw sparks\r\n        for (let i = sparks.length - 1; i >= 0; i--) {\r\n            const s = sparks[i];\r\n            s.age += dt;\r\n            if (s.age >= s.life) {\r\n                sparks.splice(i, 1);\r\n                continue;\r\n            }\r\n            \r\n            s.x += s.vx * dt;\r\n            s.y += s.vy * dt;\r\n            \r\n            const alpha = 1 - (s.age / s.life);\r\n            fxCtx.fillStyle = s.color;\r\n            fxCtx.globalAlpha = alpha;\r\n            fxCtx.beginPath();\r\n            fxCtx.arc(s.x, s.y, s.size, 0, Math.PI * 2);\r\n            fxCtx.fill();\r\n            fxCtx.globalAlpha = 1;\r\n        }\r\n    }\r\n\r\n    return {\r\n        start,\r\n        stop,\r\n        setRate,\r\n        clearBacklog,\r\n        clearPlayfield,\r\n        setCoinSprite,\r\n        getCoinTransform,\r\n        findCoinsInRadius,\r\n        findCoinsInPath,\r\n        findCoinTargetsInRadius,\r\n        findCoinTargetsInPath,\r\n        ensureCoinVisual,\r\n        removeCoinTarget,\r\n        detachCoin,\r\n        recycleCoin: releaseCoin,\r\n        playEntranceWave,\r\n        setDependencies,\r\n        hasBigCoins: () => isSurgeActive(2) && activeCoins.some(c => c && c.sizeIndex >= 4),\r\n    };\r\n}\r\n", "// js/util/saveIntegrity.js\r\n// If a player modifies their save file manually (e.g., console commands, local storage editing, JSON tampering),\r\n// A one-way flag, `hasModifiedSave`, will become true and turn the shop button's color brown,\r\n// Which I like to call the poop-shop of shame.\r\n// Used to detect cheaters.\r\nimport {\r\n  STORAGE_PREFIX,\r\n  getActiveSlot,\r\n  getSlotSignature,\r\n  setSlotSignature,\r\n  markSaveSlotModified,\r\n  getSlotSignatureKey,\r\n  hasModifiedSave,\r\n} from './storage.js';\r\n\r\nconst SIGNATURE_POLL_INTERVAL_MS = 10000;\r\nconst TRUSTED_MUTATION_GRACE_MS = 750;\r\nconst TRUSTED_SWEEP_DELAY_MS = 50;\r\nlet watcherId = null;\r\nlet trustedSweepTimer = null;\r\n\r\nconst trustedSlotsUntil = new Map();\r\n\r\nfunction nowMs() {\r\n  if (typeof performance !== 'undefined' && typeof performance.now === 'function') {\r\n    return performance.now();\r\n  }\r\n  return Date.now();\r\n}\r\n\r\nfunction noteTrustedSlot(slot, ttl = TRUSTED_MUTATION_GRACE_MS) {\r\n  if (!slot || slot <= 0) return;\r\n  trustedSlotsUntil.set(slot, nowMs() + ttl);\r\n}\r\n\r\nfunction slotRecentlyTrusted(slot) {\r\n  if (!slot || slot <= 0) return false;\r\n  const expiry = trustedSlotsUntil.get(slot);\r\n  if (expiry == null) return false;\r\n  if (expiry <= nowMs()) {\r\n    trustedSlotsUntil.delete(slot);\r\n    return false;\r\n  }\r\n  return true;\r\n}\r\n\r\nfunction resetTrustedSlots() {\r\n  trustedSlotsUntil.clear();\r\n}\r\n\r\nfunction hasLocalStorage() {\r\n  try {\r\n    return typeof localStorage !== 'undefined';\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\n// In-memory snapshot of expected localStorage state per slot.\r\n// This lets us detect manual/out-of-band changes while the game is running.\r\nconst expectedStateBySlot = new Map();\r\nlet integrityInternalWriteDepth = 0;\r\n\r\nfunction parseSlotFromKey(key) {\r\n  if (!key) return null;\r\n  const match = /:(\\d+)$/.exec(String(key));\r\n  if (!match) return null;\r\n  const slot = Number.parseInt(match[1], 10);\r\n  return Number.isFinite(slot) && slot > 0 ? slot : null;\r\n}\r\n\r\nfunction rebuildExpectedStateForSlot(slot) {\r\n  const snapshot = new Map();\r\n  if (!hasLocalStorage()) {\r\n    expectedStateBySlot.set(slot, snapshot);\r\n    return snapshot;\r\n  }\r\n  try {\r\n    for (let i = 0; i < localStorage.length; i += 1) {\r\n      const key = localStorage.key(i);\r\n      if (!key || !key.startsWith(STORAGE_PREFIX)) continue;\r\n      const keySlot = parseSlotFromKey(key);\r\n      if (keySlot == null || keySlot !== slot) continue;\r\n      let value = '';\r\n      try {\r\n        value = localStorage.getItem(key) ?? '';\r\n      } catch {\r\n        value = '';\r\n      }\r\n      snapshot.set(key, value);\r\n    }\r\n  } catch {}\r\n  expectedStateBySlot.set(slot, snapshot);\r\n  return snapshot;\r\n}\r\n\r\nfunction ensureExpectedStateForSlot(slot) {\r\n  if (!Number.isFinite(slot) || slot <= 0) return null;\r\n  if (expectedStateBySlot.has(slot)) return expectedStateBySlot.get(slot);\r\n  return rebuildExpectedStateForSlot(slot);\r\n}\r\n\r\nexport function beforeSlotWrite(key) {\r\n  if (!hasLocalStorage()) return;\r\n  if (integrityInternalWriteDepth > 0) return;\r\n\r\n  const strKey = String(key);\r\n  if (!strKey.startsWith(STORAGE_PREFIX)) return;\r\n\r\n  const slot = parseSlotFromKey(strKey);\r\n\r\n  if (slot == null) return;\r\n\r\n  const snapshot = ensureExpectedStateForSlot(slot);\r\n  if (!snapshot) return;\r\n\r\n  try {\r\n    for (const [snapKey, expectedValue] of snapshot.entries()) {\r\n      let actualValue = '';\r\n      try {\r\n        actualValue = localStorage.getItem(snapKey) ?? '';\r\n      } catch {\r\n        actualValue = '';\r\n      }\r\n      if (actualValue !== expectedValue) {\r\n        if (integrityInternalWriteDepth === 0) {\r\n          integrityInternalWriteDepth += 1;\r\n          try {\r\n            markSaveSlotModified(slot);\r\n          } finally {\r\n            integrityInternalWriteDepth -= 1;\r\n          }\r\n        }\r\n        rebuildExpectedStateForSlot(slot);\r\n        return;\r\n      }\r\n    }\r\n  } catch {}\r\n}\r\n\r\nexport function afterSlotWrite(key, value) {\r\n  const strKey = String(key);\r\n  if (!strKey.startsWith(STORAGE_PREFIX)) return;\r\n  const slot = parseSlotFromKey(strKey);\r\n  if (slot == null) return;\r\n\r\n  const snapshot = ensureExpectedStateForSlot(slot) || new Map();\r\n  snapshot.set(strKey, String(value ?? ''));\r\n  expectedStateBySlot.set(slot, snapshot);\r\n}\r\n\r\nfunction computeSignature(entries = []) {\r\n  let hash = 0;\r\n  for (const entry of entries) {\r\n    for (let i = 0; i < entry.length; i += 1) {\r\n      hash = ((hash << 5) - hash + entry.charCodeAt(i)) >>> 0;\r\n    }\r\n    hash = (hash + 0x9e3779b1) >>> 0;\r\n  }\r\n  return `${entries.length}|${hash.toString(16)}`;\r\n}\r\n\r\nfunction collectEntriesBySlot() {\r\n  const map = new Map();\r\n  if (!hasLocalStorage()) return map;\r\n  try {\r\n    for (let i = 0; i < localStorage.length; i += 1) {\r\n      const key = localStorage.key(i);\r\n      if (!key || !key.startsWith(STORAGE_PREFIX)) continue;\r\n      const slotMatch = key.match(/:(\\d+)$/);\r\n      if (!slotMatch) continue;\r\n      const slot = parseInt(slotMatch[1], 10);\r\n      if (!Number.isFinite(slot) || slot <= 0) continue;\r\n      const sigKey = getSlotSignatureKey(slot);\r\n      if (key === sigKey) {\r\n        if (!map.has(slot)) map.set(slot, []);\r\n        continue;\r\n      }\r\n      let value = '';\r\n      try { value = localStorage.getItem(key) ?? ''; }\r\n      catch {}\r\n      if (!map.has(slot)) map.set(slot, []);\r\n      map.get(slot).push(`${key}=${value}`);\r\n    }\r\n  } catch {}\r\n  map.forEach((entries) => entries.sort());\r\n  return map;\r\n}\r\n\r\nfunction getCandidateSlots(entriesBySlot) {\r\n  const slots = new Set();\r\n  if (entriesBySlot) {\r\n    entriesBySlot.forEach((_, slot) => slots.add(slot));\r\n  }\r\n  const active = getActiveSlot();\r\n  if (Number.isFinite(active) && active > 0) slots.add(active);\r\n  if (typeof document !== 'undefined') {\r\n    document.querySelectorAll('.slot-card').forEach((_, idx) => slots.add(idx + 1));\r\n  }\r\n  return [...slots].filter((slot) => Number.isFinite(slot) && slot > 0);\r\n}\r\n\r\nfunction verifySlotIntegrity(slot, entries) {\r\n  if (!slot || slot <= 0) return;\r\n  const list = Array.isArray(entries) ? entries : [];\r\n  const stored = getSlotSignature(slot);\r\n  if (list.length === 0) {\r\n    if (stored) {\r\n      if (!slotRecentlyTrusted(slot)) {\r\n        markSaveSlotModified(slot);\r\n      }\r\n      setSlotSignature(slot, null);\r\n    }\r\n    return;\r\n  }\r\n  const signature = computeSignature(list);\r\n  const mismatch = signature !== stored;\r\n  if (stored && mismatch && !slotRecentlyTrusted(slot)) {\r\n    markSaveSlotModified(slot);\r\n  }\r\n  if (signature !== stored) {\r\n    setSlotSignature(slot, signature);\r\n  }\r\n}\r\n\r\nfunction runIntegrityCheck() {\r\n  if (!hasLocalStorage()) return;\r\n  const entriesBySlot = collectEntriesBySlot();\r\n  const slots = getCandidateSlots(entriesBySlot);\r\n  slots.forEach((slot) => {\r\n    const entries = entriesBySlot.get(slot) ?? [];\r\n    verifySlotIntegrity(slot, entries);\r\n  });\r\n}\r\n\r\nfunction scheduleTrustedMutationSweep() {\r\n  if (trustedSweepTimer != null) return;\r\n  const root = typeof window !== 'undefined' ? window : globalThis;\r\n  trustedSweepTimer = root.setTimeout(() => {\r\n    trustedSweepTimer = null;\r\n    runIntegrityCheck();\r\n  }, TRUSTED_SWEEP_DELAY_MS);\r\n}\r\n\r\nfunction handleStorageMutationEvent(event) {\r\n  const detail = event?.detail;\r\n  if (!detail) return;\r\n  const rawSlot = typeof detail.slot === 'number' ? detail.slot : Number.parseInt(detail.slot, 10);\r\n  const slot = Number.isFinite(rawSlot) ? rawSlot : null;\r\n  if (!Number.isFinite(slot) || slot <= 0) return;\r\n  if (detail.trusted) {\r\n    noteTrustedSlot(slot);\r\n    scheduleTrustedMutationSweep();\r\n    return;\r\n  }\r\n  trustedSlotsUntil.delete(slot);\r\n  runIntegrityCheck();\r\n}\r\n\r\nfunction ensureWatcher() {\r\n  if (typeof window === 'undefined') return;\r\n  if (watcherId != null) return;\r\n  watcherId = window.setInterval(runIntegrityCheck, SIGNATURE_POLL_INTERVAL_MS);\r\n}\r\n\r\nconst POOP_SHOP_BG  = 'linear-gradient(180deg,#a9793d,#7b5534)';\r\nconst POOP_SHOP_FLAG = '1';\r\n\r\nlet poopShopTimer = null;\r\n\r\nfunction getShopButtonElement() {\r\n  if (typeof document === 'undefined') return null;\r\n  return document.querySelector('.hud-bottom .game-btn[data-btn=\"shop\"]');\r\n}\r\n\r\nfunction enforcePoopShopStyle() {\r\n  const btn = getShopButtonElement();\r\n  if (!btn) return;\r\n\r\n  const isModded = hasModifiedSave();\r\n\r\n  if (!isModded) {\r\n    if (btn.dataset.poopShopApplied === POOP_SHOP_FLAG || btn.style.backgroundImage || btn.style.background) {\r\n      btn.style.backgroundImage = '';\r\n      btn.style.background = '';\r\n      delete btn.dataset.poopShopApplied;\r\n    }\r\n    return;\r\n  }\r\n\r\n  const current = btn.style.backgroundImage || btn.style.background;\r\n  if (current !== POOP_SHOP_BG || btn.dataset.poopShopApplied !== POOP_SHOP_FLAG) {\r\n    btn.style.backgroundImage = POOP_SHOP_BG;\r\n    btn.dataset.poopShopApplied = POOP_SHOP_FLAG;\r\n  }\r\n}\r\n\r\nfunction startPoopShopEnforcer() {\r\n  if (typeof window === 'undefined') return;\r\n  if (poopShopTimer != null) return;\r\n\r\n  enforcePoopShopStyle();\r\n  poopShopTimer = window.setInterval(enforcePoopShopStyle, 50);\r\n\r\n  window.addEventListener('saveSlot:change', enforcePoopShopStyle);\r\n  window.addEventListener('saveSlot:modified', (ev) => {\r\n    try {\r\n      const active = getActiveSlot();\r\n      if (ev?.detail?.slot === active) {\r\n        enforcePoopShopStyle();\r\n      }\r\n    } catch {\r\n      enforcePoopShopStyle();\r\n    }\r\n  });\r\n}\r\n\r\nfunction init() {\r\n  if (typeof window === 'undefined') return;\r\n  runIntegrityCheck();\r\n  ensureWatcher();\r\n  startPoopShopEnforcer();\r\n  window.addEventListener('saveSlot:change', () => runIntegrityCheck());\r\n  window.addEventListener('saveIntegrity:storageMutation', handleStorageMutationEvent, { passive: true });\r\n  if (typeof document !== 'undefined') {\r\n    document.addEventListener('visibilitychange', () => {\r\n      if (!document.hidden) {\r\n        resetTrustedSlots();\r\n        runIntegrityCheck();\r\n        enforcePoopShopStyle();\r\n      }\r\n    });\r\n  }\r\n}\r\n\r\ninit();\r\n", "// js/ui/popups.js\r\n\r\nimport { BigNum } from '../util/bigNum.js';\r\nimport { formatNumber } from '../util/numFormat.js';\r\nimport { CURRENCIES, isCurrencyLocked, isStorageKeyLocked, getActiveSlot, getCurrency } from '../util/storage.js';\r\n\r\nconst DEFAULT_DURATION = 6767;\r\n\r\nconst POPUP_ORDER = ['coins', 'xp', 'books', 'gold', 'mp', 'magic', 'gears', 'dna'];\r\n\r\nconst POPUP_META = {\r\n  [CURRENCIES.COINS]: {\r\n    icon: 'img/currencies/coin/coin.webp',\r\n    iconAlt: 'Coin',\r\n  },\r\n  xp: {\r\n    icon: 'img/stats/xp/xp.webp',\r\n    iconAlt: 'XP',\r\n  },\r\n  [CURRENCIES.BOOKS]: {\r\n    icon: 'img/currencies/book/book.webp',\r\n    iconAlt: 'Book',\r\n  },\r\n  [CURRENCIES.GOLD]: {\r\n    icon: 'img/currencies/gold/gold.webp',\r\n    iconAlt: 'Gold',\r\n  },\r\n  mp: {\r\n    icon: 'img/stats/mp/mp.webp',\r\n    iconAlt: 'Mutation Power',\r\n  },\r\n  [CURRENCIES.MAGIC]: {\r\n    icon: 'img/currencies/magic/magic.webp',\r\n    iconAlt: 'Magic',\r\n  },\r\n  [CURRENCIES.GEARS]: {\r\n    icon: 'img/currencies/gear/gear.webp',\r\n    iconAlt: 'Gears',\r\n  },\r\n  [CURRENCIES.DNA]: {\r\n    icon: 'img/currencies/dna/dna.webp',\r\n    iconAlt: 'DNA',\r\n  },\r\n};\r\n\r\nlet container = null;\r\nlet initialized = false;\r\nconst lastKnownAmounts = new Map();\r\nconst activePopups = new Map();\r\n\r\nfunction ensureContainer() {\r\n  if (container) return container;\r\n  container = document.createElement('div');\r\n  container.className = 'currency-popups';\r\n  container.setAttribute('aria-live', 'polite');\r\n  container.setAttribute('aria-atomic', 'false');\r\n  document.body.appendChild(container);\r\n  return container;\r\n}\r\n\r\nfunction bnFromAny(value) {\r\n  if (value == null) return null;\r\n  if (value instanceof BigNum) return value.clone?.() ?? value;\r\n  if (typeof value.clone === 'function' && value.sig != null) {\r\n    try { return value.clone(); } catch {}\r\n  }\r\n  try { return BigNum.fromAny(value); } catch { return null; }\r\n}\r\n\r\nfunction isZero(bn) {\r\n  if (!bn) return true;\r\n  if (typeof bn.isZero === 'function') {\r\n    try { return bn.isZero(); } catch { return false; }\r\n  }\r\n  return false;\r\n}\r\n\r\nfunction updateEntry(entry) {\r\n  if (!entry) return;\r\n  const { amountEl, amount, meta } = entry;\r\n  const formatted = meta.formatAmount ? meta.formatAmount(amount) : formatNumber(amount);\r\n  if (amountEl) amountEl.innerHTML = formatted;\r\n}\r\n\r\nfunction scheduleRemoval(entry, duration = DEFAULT_DURATION) {\r\n  if (!entry) return;\r\n  if (entry.timeoutId) return; // already scheduled; do NOT reset\r\n  entry.timeoutId = window.setTimeout(() => {\r\n    activePopups.delete(entry.type);\r\n    entry.element.classList.remove('is-visible');\r\n    entry.element.classList.add('is-leaving');\r\n    const remove = () => {\r\n      entry.element.removeEventListener('transitionend', remove);\r\n      entry.element.remove();\r\n    };\r\n    entry.element.addEventListener('transitionend', remove, { once: true });\r\n    window.setTimeout(remove, 480);\r\n  }, duration);\r\n}\r\n\r\nfunction createPopupEntry(type, meta, amount) {\r\n  ensureContainer();\r\n  const element = document.createElement('div');\r\n  element.className = 'currency-popup';\r\n  element.setAttribute('role', 'status');\r\n\r\n  const plus = document.createElement('span');\r\n  plus.className = 'currency-popup__plus';\r\n  plus.textContent = '+';\r\n\r\n  const icon = document.createElement('img');\r\n  icon.className = 'currency-popup__icon';\r\n  icon.src = meta.icon;\r\n  icon.alt = meta.iconAlt || '';\r\n\r\n  const text = document.createElement('span');\r\n  text.className = 'currency-popup__text';\r\n\r\n  const amountEl = document.createElement('span');\r\n  amountEl.className = 'currency-popup__amount';\r\n\r\n  text.append(amountEl);\r\n  element.append(plus, icon, text);\r\n  element.dataset.type = type;\r\n\r\n  return {\r\n    type,\r\n    meta,\r\n    element,\r\n    amountEl,\r\n    amount: amount.clone?.() ?? amount,\r\n    timeoutId: null,\r\n  };\r\n}\r\n\r\nfunction showPopup(type, amount, overrides = {}) {\r\n  if (typeof window !== 'undefined' && window.__tsunamiActive) return;\r\n  // Check locks\r\n  const slot = getActiveSlot();\r\n  if (slot != null) {\r\n      if (['xp'].includes(type)) {\r\n          if (isStorageKeyLocked(`ccc:xp:progress:${slot}`)) return;\r\n      } else if (['mp'].includes(type)) {\r\n          if (isStorageKeyLocked(`ccc:mutation:progress:${slot}`)) return;\r\n      } else if (Object.values(CURRENCIES).includes(type)) {\r\n          if (isCurrencyLocked(type, slot)) return;\r\n      }\r\n  }\r\n\r\n  const baseMeta = POPUP_META[type];\r\n  const meta = Object.assign({ duration: DEFAULT_DURATION, accumulate: true }, baseMeta || {}, overrides);\r\n  if (!meta.icon) return;\r\n\r\n  const bnAmount = bnFromAny(amount);\r\n  if (!bnAmount || isZero(bnAmount)) return;\r\n\r\n  const existing = meta.accumulate !== false ? activePopups.get(type) : null;\r\n\r\n  if (existing) {\r\n    // Update the number but DO NOT reset its lifetime or animations.\r\n    existing.amount = existing.amount.add(bnAmount);\r\n    existing.meta = meta;\r\n    updateEntry(existing);\r\n    return;\r\n  }\r\n\r\n  const entry = createPopupEntry(type, meta, bnAmount);\r\n  entry.meta = meta;\r\n  updateEntry(entry);\r\n  activePopups.set(type, entry);\r\n\r\n  const host = ensureContainer();\r\n\r\n  // Insert based on order (coins first, xp second, books last, gears very last)\r\n  const index = POPUP_ORDER.indexOf(type);\r\n  let insertBefore = null;\r\n  \r\n  if (index >= 0) {\r\n    const children = Array.from(host.children);\r\n    for (const child of children) {\r\n      const childType = child.dataset.type;\r\n      const childIndex = POPUP_ORDER.indexOf(childType);\r\n      if (childIndex > index) {\r\n        insertBefore = child;\r\n        break;\r\n      }\r\n    }\r\n  }\r\n\r\n  if (insertBefore) host.insertBefore(entry.element, insertBefore);\r\n  else host.appendChild(entry.element);\r\n\r\n  requestAnimationFrame(() => entry.element.classList.add('is-visible'));\r\n  scheduleRemoval(entry, meta.duration); // scheduled ONCE at creation\r\n}\r\n\r\nfunction getAllCurrencies() {\r\n  const all = {};\r\n  for (const key of Object.values(CURRENCIES)) {\r\n    all[key] = getCurrency(key);\r\n  }\r\n  return all;\r\n}\r\n\r\nfunction syncLastKnown() {\r\n  try {\r\n    const all = getAllCurrencies();\r\n    Object.entries(all).forEach(([key, value]) => {\r\n      const bn = bnFromAny(value) || BigNum.fromInt(0);\r\n      lastKnownAmounts.set(key, bn.clone?.() ?? bn);\r\n    });\r\n    if (!lastKnownAmounts.has('mp')) {\r\n      lastKnownAmounts.set('mp', BigNum.fromInt(0));\r\n    }\r\n  } catch {\r\n    lastKnownAmounts.clear();\r\n  }\r\n}\r\n\r\nfunction clearActivePopups() {\r\n  activePopups.forEach((entry) => {\r\n    if (entry.timeoutId) clearTimeout(entry.timeoutId);\r\n    entry.element.remove();\r\n  });\r\n  activePopups.clear();\r\n}\r\n\r\nfunction handleCurrencyChange(event) {\r\n  const detail = event?.detail;\r\n  if (!detail?.key) return;\r\n  const key = detail.key;\r\n  const current = bnFromAny(detail.value) || BigNum.fromInt(0);\r\n  const prev = lastKnownAmounts.get(key) || BigNum.fromInt(0);\r\n  const zero = BigNum.fromInt(0);\r\n  let delta = null;\r\n  const detailDelta = detail.delta != null ? bnFromAny(detail.delta) : null;\r\n  if (detailDelta && typeof detailDelta.cmp === 'function' && detailDelta.cmp(zero) > 0) {\r\n    delta = detailDelta;\r\n  } else if (typeof current.cmp === 'function' && current.cmp(prev) > 0) {\r\n    delta = current.sub(prev);\r\n  }\r\n  if (delta && !(typeof delta.isZero === 'function' && delta.isZero())) {\r\n    showPopup(key, delta);\r\n  }\r\n  lastKnownAmounts.set(key, current.clone?.() ?? current);\r\n}\r\n\r\nfunction handleXpChange(event) {\r\n  const detail = event?.detail;\r\n  if (!detail) return;\r\n  const xpAdded = bnFromAny(detail.xpAdded);\r\n  if (xpAdded && !isZero(xpAdded)) showPopup('xp', xpAdded);\r\n}\r\n\r\nfunction handleMutationChange(event) {\r\n  const detail = event?.detail;\r\n  if (!detail) return;\r\n  const delta = bnFromAny(detail.delta);\r\n  if (delta && !isZero(delta)) {\r\n    showPopup('mp', delta);\r\n  }\r\n  const nextProgress = bnFromAny(detail.progress);\r\n  if (nextProgress) {\r\n    lastKnownAmounts.set('mp', nextProgress.clone?.() ?? nextProgress);\r\n  }\r\n}\r\n\r\nfunction handleSlotChange() {\r\n  clearActivePopups();\r\n  syncLastKnown();\r\n}\r\n\r\nexport function initPopups() {\r\n  if (initialized) return;\r\n  initialized = true;\r\n  ensureContainer();\r\n  syncLastKnown();\r\n  window.addEventListener('currency:change', handleCurrencyChange);\r\n  window.addEventListener('xp:change', handleXpChange);\r\n  window.addEventListener('mutation:change', handleMutationChange);\r\n  window.addEventListener('saveSlot:change', handleSlotChange);\r\n}\r\n\r\nexport function teardownpopups() {\r\n  if (!initialized) return;\r\n  window.removeEventListener('currency:change', handleCurrencyChange);\r\n  window.removeEventListener('xp:change', handleXpChange);\r\n  window.removeEventListener('mutation:change', handleMutationChange);\r\n  window.removeEventListener('saveSlot:change', handleSlotChange);\r\n  clearActivePopups();\r\n  lastKnownAmounts.clear();\r\n  if (container) container.remove();\r\n  container = null;\r\n  initialized = false;\r\n}\r\n", "// js/util/suspendSafeguard.js\r\n// Improves local storage tracking by supplying helper functions for saveIntegrity.js,\r\n// And also supplies frequent IndexedDB snapshots to back up progress if\r\n// Local storage ever becomes corrupted (safeguard against abrupt page suspensions)\r\nimport { beforeSlotWrite, afterSlotWrite } from './saveIntegrity.js';\r\n\r\nconst STORAGE_PREFIX = 'ccc:';\r\nconst DB_NAME = 'ccc:safety';\r\nconst DB_VERSION = 1;\r\nconst STORE_NAME = 'snapshots';\r\nconst SNAPSHOT_KEY = 'latest';\r\nconst SLOT_SIGNATURE_PREFIX = `${STORAGE_PREFIX}slotSig`;\r\nconst SLOT_MOD_FLAG_PREFIX = `${STORAGE_PREFIX}slotMod`;\r\nconst FLUSH_DEBOUNCE_MS = 1000;\r\n\r\nlet dbPromise = null;\r\nlet flushTimer = null;\r\nlet dirty = false;\r\nlet lastDirtyReason = 'init';\r\nlet installAttempted = false;\r\nlet restoreAttempted = false;\r\nlet pendingImmediateFlush = false;\r\n\r\nfunction canUseIndexedDb() {\r\n  if (typeof indexedDB === 'undefined') return false;\r\n  try {\r\n    return typeof indexedDB.open === 'function';\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\nfunction canUseLocalStorage() {\r\n  if (typeof localStorage === 'undefined') return false;\r\n  try {\r\n    const testKey = `${STORAGE_PREFIX}__test__`;\r\n    localStorage.setItem(testKey, '1');\r\n    localStorage.removeItem(testKey);\r\n    return true;\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\nasync function openDatabase() {\r\n  if (!canUseIndexedDb()) throw new Error('IndexedDB unavailable');\r\n  if (dbPromise) return dbPromise;\r\n\r\n  dbPromise = new Promise((resolve, reject) => {\r\n    let resolved = false;\r\n    try {\r\n      const request = indexedDB.open(DB_NAME, DB_VERSION);\r\n      request.onupgradeneeded = () => {\r\n        try {\r\n          const db = request.result;\r\n          if (!db.objectStoreNames.contains(STORE_NAME)) {\r\n            db.createObjectStore(STORE_NAME);\r\n          }\r\n        } catch (err) {\r\n          console.warn('Failed to upgrade suspend safeguard DB', err);\r\n        }\r\n      };\r\n      request.onsuccess = () => {\r\n        resolved = true;\r\n        const db = request.result;\r\n        db.onversionchange = () => {\r\n          try { db.close(); } catch {}\r\n          dbPromise = null;\r\n        };\r\n        resolve(db);\r\n      };\r\n      request.onerror = () => {\r\n        if (!resolved) {\r\n          reject(request.error || new Error('Failed to open suspend safeguard DB'));\r\n        }\r\n      };\r\n      request.onblocked = () => {\r\n        // Nothing special, but ensure promise settles eventually\r\n      };\r\n    } catch (err) {\r\n      reject(err);\r\n    }\r\n  }).catch((err) => {\r\n    dbPromise = null;\r\n    throw err;\r\n  });\r\n\r\n  return dbPromise;\r\n}\r\n\r\nfunction captureSnapshot() {\r\n  if (!canUseLocalStorage()) return null;\r\n  const data = {};\r\n  let captured = false;\r\n  try {\r\n    for (let i = 0; i < localStorage.length; i++) {\r\n      const key = localStorage.key(i);\r\n      if (!key || !key.startsWith(STORAGE_PREFIX)) continue;\r\n      let value = null;\r\n      try {\r\n        value = localStorage.getItem(key);\r\n      } catch {\r\n        value = null;\r\n      }\r\n      if (value == null) continue;\r\n      data[key] = value;\r\n      captured = true;\r\n    }\r\n  } catch (err) {\r\n    console.warn('Failed to read localStorage for snapshot', err);\r\n    return null;\r\n  }\r\n\r\n  return {\r\n    data,\r\n    savedAt: Date.now(),\r\n    hasData: captured,\r\n  };\r\n}\r\n\r\nasync function putSnapshot(snapshot) {\r\n  try {\r\n    const db = await openDatabase();\r\n    await new Promise((resolve, reject) => {\r\n      let settled = false;\r\n      const tx = db.transaction(STORE_NAME, 'readwrite');\r\n      tx.oncomplete = () => { if (!settled) { settled = true; resolve(true); } };\r\n      tx.onabort = () => { if (!settled) { settled = true; reject(tx.error || new Error('Snapshot transaction aborted')); } };\r\n      tx.onerror = () => { if (!settled) { settled = true; reject(tx.error || new Error('Snapshot transaction error')); } };\r\n      const store = tx.objectStore(STORE_NAME);\r\n      const request = store.put(snapshot, SNAPSHOT_KEY);\r\n      request.onerror = () => {\r\n        if (!settled) {\r\n          settled = true;\r\n          reject(request.error || new Error('Snapshot write failed'));\r\n        }\r\n      };\r\n    });\r\n    return true;\r\n  } catch (err) {\r\n    console.warn('Failed to persist suspend snapshot', err);\r\n    return false;\r\n  }\r\n}\r\n\r\nasync function readSnapshot() {\r\n  try {\r\n    const db = await openDatabase();\r\n    return await new Promise((resolve, reject) => {\r\n      let settled = false;\r\n      const tx = db.transaction(STORE_NAME, 'readonly');\r\n      tx.oncomplete = () => { if (!settled) { settled = true; resolve(null); } };\r\n      tx.onabort = () => { if (!settled) { settled = true; reject(tx.error || new Error('Snapshot read aborted')); } };\r\n      tx.onerror = () => { if (!settled) { settled = true; reject(tx.error || new Error('Snapshot read error')); } };\r\n      const store = tx.objectStore(STORE_NAME);\r\n      const request = store.get(SNAPSHOT_KEY);\r\n      request.onsuccess = () => {\r\n        if (settled) return;\r\n        settled = true;\r\n        resolve(request.result || null);\r\n      };\r\n      request.onerror = () => {\r\n        if (!settled) {\r\n          settled = true;\r\n          reject(request.error || new Error('Snapshot get failed'));\r\n        }\r\n      };\r\n    });\r\n  } catch (err) {\r\n    console.warn('Failed to load suspend snapshot', err);\r\n    return null;\r\n  }\r\n}\r\n\r\nfunction requestPersistentStorage() {\r\n  try {\r\n    if (navigator?.storage?.persist) {\r\n      navigator.storage.persist().catch(() => {});\r\n    }\r\n  } catch {}\r\n}\r\n\r\nfunction captureStackTrace() {\r\n  try {\r\n    throw new Error('ccc-storage-write');\r\n  } catch (err) {\r\n    return err?.stack || '';\r\n  }\r\n}\r\n\r\nfunction parseSlotFromKey(key) {\r\n  if (!key) return null;\r\n  const match = /:(\\d+)$/.exec(String(key));\r\n  if (!match) return null;\r\n  const slot = parseInt(match[1], 10);\r\n  return Number.isFinite(slot) && slot > 0 ? slot : null;\r\n}\r\n\r\nconst DEVTOOLS_CONSOLE_FRAME_RE = /\\bat <anonymous>:\\d+:\\d+\\b/;\r\n\r\nfunction isTrustedStorageStack(stack) {\r\n  if (typeof stack !== 'string' || stack.length === 0) return false;\r\n  \r\n  if (DEVTOOLS_CONSOLE_FRAME_RE.test(stack)) return false;\r\n\r\n  return true;\r\n}\r\n\r\nfunction notifySaveIntegrityOfStorageMutation(key, stack) {\r\n  if (typeof window === 'undefined') return;\r\n  if (!key) return;\r\n  const strKey = String(key);\r\n  if (!strKey.startsWith(STORAGE_PREFIX)) return;\r\n  if (strKey.startsWith(SLOT_SIGNATURE_PREFIX) || strKey.startsWith(SLOT_MOD_FLAG_PREFIX)) return;\r\n  const slot = parseSlotFromKey(strKey);\r\n  if (slot == null) return;\r\n  try {\r\n    const detail = {\r\n      key: strKey,\r\n      slot,\r\n      trusted: isTrustedStorageStack(stack),\r\n    };\r\n    window.dispatchEvent(new CustomEvent('saveIntegrity:storageMutation', { detail }));\r\n  } catch {}\r\n}\r\n\r\nfunction installStorageHooks() {\r\n  if (typeof localStorage === 'undefined') return;\r\n  try {\r\n    const proto = Object.getPrototypeOf(localStorage);\r\n    if (!proto || proto.__cccStoragePatched) return;\r\n\r\n    const originalSet = proto.setItem;\r\n    const originalRemove = proto.removeItem;\r\n    const originalClear = proto.clear;\r\n\r\nif (typeof originalSet === 'function') {\r\n  proto.setItem = function patchedSetItem(key, value) {\r\n    const stack = captureStackTrace();\r\n    const strKey = String(key);\r\n\r\n\tconst isTrackedGameKey =\r\n      this === localStorage &&\r\n      strKey.startsWith(STORAGE_PREFIX);\r\n\r\n\r\n    // Before we write, verify nothing in this slot changed behind our back.\r\n    if (isTrackedGameKey) {\r\n      try {\r\n        beforeSlotWrite(strKey);\r\n      } catch {}\r\n    }\r\n\r\n    let result;\r\n    try {\r\n      result = originalSet.apply(this, arguments);\r\n    } finally {\r\n      try {\r\n        if (isTrackedGameKey) {\r\n          markProgressDirty('setItem');\r\n          // Keep the in-memory expected state in sync with what we just wrote.\r\n          try {\r\n            afterSlotWrite(strKey, value);\r\n          } catch {}\r\n        }\r\n\r\n        // We still want integrity events for game keys, but we've already\r\n        // excluded slotSig/slotMod inside notifySaveIntegrityOfStorageMutation.\r\n        if (this === localStorage && strKey.startsWith(STORAGE_PREFIX)) {\r\n          notifySaveIntegrityOfStorageMutation(strKey, stack);\r\n        }\r\n      } catch {}\r\n    }\r\n    return result;\r\n  };\r\n}\r\n\r\n    if (typeof originalRemove === 'function') {\r\n      proto.removeItem = function patchedRemoveItem(key) {\r\n        const stack = captureStackTrace();\r\n        let result;\r\n        try {\r\n          result = originalRemove.apply(this, arguments);\r\n        } finally {\r\n          try {\r\n            if (this === localStorage && String(key).startsWith(STORAGE_PREFIX)) {\r\n              markProgressDirty('removeItem');\r\n              notifySaveIntegrityOfStorageMutation(key, stack);\r\n            }\r\n          } catch {}\r\n        }\r\n        return result;\r\n      };\r\n    }\r\n\r\n    if (typeof originalClear === 'function') {\r\n      proto.clear = function patchedClear() {\r\n        const stack = captureStackTrace();\r\n        let result;\r\n        try {\r\n          result = originalClear.apply(this, arguments);\r\n        } finally {\r\n          try {\r\n            if (this === localStorage) {\r\n              markProgressDirty('clear');\r\n              notifySaveIntegrityOfStorageMutation(null, stack);\r\n            }\r\n          } catch {}\r\n        }\r\n        return result;\r\n      };\r\n    }\r\n\r\n    Object.defineProperty(proto, '__cccStoragePatched', {\r\n      value: true,\r\n      enumerable: false,\r\n      configurable: false,\r\n      writable: false,\r\n    });\r\n  } catch (err) {\r\n    console.warn('Failed to patch Storage prototype for suspend safeguards', err);\r\n  }\r\n}\r\n\r\nfunction scheduleFlush(reason = 'idle') {\r\n  lastDirtyReason = reason || lastDirtyReason;\r\n  dirty = true;\r\n  if (flushTimer) return;\r\n  flushTimer = setTimeout(() => {\r\n    flushTimer = null;\r\n    if (!dirty) return;\r\n    const reasonToUse = lastDirtyReason;\r\n    dirty = false;\r\n    void flushBackupSnapshot(reasonToUse);\r\n  }, FLUSH_DEBOUNCE_MS);\r\n}\r\n\r\nfunction cancelFlushTimer() {\r\n  if (!flushTimer) return;\r\n  clearTimeout(flushTimer);\r\n  flushTimer = null;\r\n}\r\n\r\nexport function markProgressDirty(reason = 'dirty') {\r\n  try {\r\n    scheduleFlush(reason);\r\n  } catch {}\r\n}\r\n\r\nasync function performFlush(reason = 'manual') {\r\n  if (!canUseLocalStorage() || !canUseIndexedDb()) return false;\r\n  const snapshot = captureSnapshot();\r\n  if (!snapshot) return false;\r\n  snapshot.reason = reason;\r\n  pendingImmediateFlush = false;\r\n  const ok = await putSnapshot(snapshot);\r\n  if (!ok) {\r\n    // Keep dirty flag so another attempt can happen later\r\n    dirty = true;\r\n    scheduleFlush('retry');\r\n  }\r\n  return ok;\r\n}\r\n\r\nexport async function flushBackupSnapshot(reason = 'manual', { immediate = false } = {}) {\r\n  if (!canUseLocalStorage() || !canUseIndexedDb()) return false;\r\n  if (immediate) {\r\n    cancelFlushTimer();\r\n    dirty = false;\r\n    pendingImmediateFlush = true;\r\n    return performFlush(reason);\r\n  }\r\n  dirty = true;\r\n  lastDirtyReason = reason || lastDirtyReason;\r\n  return performFlush(reason);\r\n}\r\n\r\nfunction flushBeforeSuspend(reason) {\r\n  if (!canUseIndexedDb() || !canUseLocalStorage()) return;\r\n  cancelFlushTimer();\r\n  dirty = false;\r\n  pendingImmediateFlush = true;\r\n  void performFlush(reason);\r\n}\r\n\r\nfunction hasAnyPrefixedKeys() {\r\n  if (!canUseLocalStorage()) return false;\r\n  try {\r\n    for (let i = 0; i < localStorage.length; i++) {\r\n      const key = localStorage.key(i);\r\n      if (key && key.startsWith(STORAGE_PREFIX)) return true;\r\n    }\r\n  } catch {}\r\n  return false;\r\n}\r\n\r\nexport async function restoreFromBackupIfNeeded() {\r\n  if (restoreAttempted) return false;\r\n  restoreAttempted = true;\r\n  if (!canUseLocalStorage() || !canUseIndexedDb()) return false;\r\n\r\n  let shouldRestore = false;\r\n  try {\r\n    if (!hasAnyPrefixedKeys()) {\r\n      shouldRestore = true;\r\n    } else {\r\n      const activeSlot = localStorage.getItem(`${STORAGE_PREFIX}saveSlot`);\r\n      if (activeSlot) {\r\n        const coinKey = `${STORAGE_PREFIX}coins:${activeSlot}`;\r\n        if (localStorage.getItem(coinKey) == null) {\r\n          shouldRestore = true;\r\n        }\r\n      }\r\n    }\r\n  } catch {\r\n    shouldRestore = false;\r\n  }\r\n\r\n  if (!shouldRestore) return false;\r\n\r\n  const snapshot = await readSnapshot();\r\n  if (!snapshot?.data) return false;\r\n\r\n  let restored = false;\r\n  try {\r\n    for (const [key, value] of Object.entries(snapshot.data)) {\r\n      if (value == null) continue;\r\n      if (localStorage.getItem(key) === null) {\r\n        localStorage.setItem(key, value);\r\n        restored = true;\r\n      }\r\n    }\r\n  } catch (err) {\r\n    console.warn('Failed to restore snapshot into localStorage', err);\r\n  }\r\n\r\n  if (restored) {\r\n    markProgressDirty('restored');\r\n  }\r\n\r\n  return restored;\r\n}\r\n\r\nexport function installSuspendSafeguards() {\r\n  if (installAttempted) return;\r\n  installAttempted = true;\r\n  if (typeof window === 'undefined') return;\r\n\r\n  requestPersistentStorage();\r\n  installStorageHooks();\r\n\r\n  const onVisibilityChange = () => {\r\n    if (document.hidden) {\r\n      flushBeforeSuspend('visibility-hidden');\r\n    } else {\r\n      markProgressDirty('visibility-visible');\r\n    }\r\n  };\r\n\r\n  try { document.addEventListener('visibilitychange', onVisibilityChange, { passive: true }); } catch {}\r\n  try { window.addEventListener('pagehide', () => flushBeforeSuspend('pagehide'), { capture: true }); } catch {}\r\n  try { window.addEventListener('beforeunload', () => flushBeforeSuspend('beforeunload')); } catch {}\r\n  try { document.addEventListener('freeze', () => flushBeforeSuspend('freeze')); } catch {}\r\n  try { window.addEventListener('pageshow', () => markProgressDirty('pageshow')); } catch {}\r\n  try { window.addEventListener('focus', () => markProgressDirty('focus')); } catch {}\r\n  try { window.addEventListener('storage', (event) => {\r\n    if (!event) return;\r\n    if (event.storageArea !== localStorage) return;\r\n    if (event.key && !String(event.key).startsWith(STORAGE_PREFIX)) return;\r\n    markProgressDirty('storage-event');\r\n  }); } catch {}\r\n\r\n  markProgressDirty('boot');\r\n}\r\n\r\nexport function getSuspendMetadata() {\r\n  return {\r\n    pendingImmediateFlush,\r\n    dirty,\r\n    lastDirtyReason,\r\n  };\r\n}\r\n", "// js/util/globalOverlayEsc.js\r\n\r\nconst PRIORITY_SELECTORS = [\r\n  { sel: '.offline-overlay', btn: '.offline-close-btn' },\r\n  { sel: '.hm-milestones-overlay', btn: '.hm-milestones-close' },\r\n  { sel: '.merchant-firstchat.is-visible', btn: null, yield: true }, // Don't close parent if chat is open; chat handles itself\r\n  { sel: '.upg-overlay.is-open', btn: '.shop-close' }, // Upgrade details modal\r\n  // Automation Shop has both .shop-overlay and .automation-shop-overlay\r\n  { sel: '.merchant-overlay.is-open', btn: '.merchant-close' },\r\n  { sel: '.shop-overlay.is-open', btn: '.shop-close', closeAll: true }, // Main Shop (and others like DNA/Automation)\r\n];\r\n\r\nfunction handleEsc(e) {\r\n  if (e.key !== 'Escape') return;\r\n\r\n  let yields = false;\r\n  let closedAny = false;\r\n\r\n  for (const { sel, btn, yield: shouldYield, closeAll } of PRIORITY_SELECTORS) {\r\n    const candidates = document.querySelectorAll(sel);\r\n    if (candidates.length > 0) {\r\n      if (shouldYield) {\r\n        yields = true;\r\n        // Continue to find others to close\r\n        continue;\r\n      }\r\n\r\n      if (closeAll) {\r\n        // If configured to close all, iterate and close each matching overlay\r\n        candidates.forEach(el => {\r\n          const closeButton = el.querySelector(btn || '.shop-close');\r\n          if (closeButton) {\r\n            closeButton.click();\r\n            closedAny = true;\r\n          }\r\n        });\r\n      } else {\r\n        const topMost = candidates[candidates.length - 1];\r\n        const closeButton = topMost.querySelector(btn || '.shop-close');\r\n\r\n        if (closeButton) {\r\n          closeButton.click();\r\n          closedAny = true;\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  if (closedAny || yields) {\r\n    e.preventDefault();\r\n    // Only stop propagation if we didn't yield to another handler\r\n    if (!yields) {\r\n       e.stopPropagation();\r\n       e.stopImmediatePropagation();\r\n    }\r\n  }\r\n}\r\n\r\nexport function initGlobalOverlayEsc() {\r\n  // Use capture=true to intercept the event before other handlers (if registered later on window/document)\r\n  window.addEventListener('keydown', handleEsc, true);\r\n}\r\n", "export function ensureGameDom(layerCount, startZ) {\r\n  if (document.getElementById('game-root')) return;\r\n\r\n  const main = document.createElement('main');\r\n  main.id = 'game-root';\r\n  main.className = 'area area-cove';\r\n  main.hidden = true;\r\n\r\n  // Generate foreground canvases dynamically\r\n  let waterLayersHtml = '';\r\n  for (let i = 0; i < layerCount; i++) {\r\n    const zIndex = startZ + i;\r\n    waterLayersHtml += `<canvas id=\"water-fg-${i}\" style=\"position: absolute; top: 0; left: 0; width: 100%; height: 35%; pointer-events: none; z-index: ${zIndex};\"></canvas>\\n`;\r\n  }\r\n\r\n  main.innerHTML = `<div class=\"hud-top\"><div class=\"coin-counter\"><img src=\"img/currencies/coin/coin_plus_base.webp\" alt=\"\" class=\"coin-plus\"/><div class=\"coin-bar\"><span class=\"coin-amount\">0</span></div></div><div class=\"xp-counter\" data-xp-hud hidden><img src=\"img/stats/xp/xp_plus_base.webp\" alt=\"\" class=\"xp-plus\"/><div class=\"xp-bar\" role=\"progressbar\" aria-valuemin=\"0\" aria-valuemax=\"100\" aria-valuenow=\"0\" aria-valuetext=\"0 / 10 XP\"><div class=\"xp-bar__fill\" style=\"width: 0%\"></div><div class=\"xp-bar__frame\"><div class=\"xp-bar__level\"> Level<span class=\"xp-level-value\">0</span></div><div class=\"xp-bar__divider\" aria-hidden=\"true\"></div><div class=\"xp-bar__progress\" data-xp-progress> 0<span class=\"xp-progress-separator\">/</span>10<span class=\"xp-progress-suffix\">XP</span></div></div></div></div><div class=\"mp-counter\" data-mp-hud hidden><img src=\"img/stats/mp/mp_plus_base.webp\" alt=\"\" class=\"mp-plus\"/><div class=\"mp-bar\" role=\"progressbar\" aria-valuemin=\"0\" aria-valuemax=\"100\" aria-valuenow=\"0\" aria-valuetext=\"0 / 10 MP\"><div class=\"mp-bar__fill\" style=\"width: 0%\"></div><div class=\"mp-bar__frame\"><div class=\"mp-bar__level\"> Mutation<span class=\"mp-level-value\">0</span></div><div class=\"mp-bar__divider\" aria-hidden=\"true\"></div><div class=\"mp-bar__progress\" data-mp-progress> 0<span class=\"mp-progress-separator\">/</span>10<span class=\"mp-progress-suffix\">MP</span></div></div></div></div></div><section class=\"playfield\" aria-label=\"Starter Cove Sand\"><div class=\"waves\" id=\"waves\"></div><canvas id=\"water-background\" class=\"water-base\" style=\"position: absolute; top: 0; left: 0; width: 100%; height: 35%; pointer-events: none; z-index: 1;\"></canvas><div class=\"coins-layer\" id=\"coins-layer\"></div> ${waterLayersHtml.trim()} </section><nav class=\"hud-bottom\" id=\"hud-bottom\"><button class=\"game-btn btn-help\" data-btn=\"help\"><span>Help</span></button><button class=\"game-btn btn-shop\" data-btn=\"shop\"><span>Shop</span></button><button class=\"game-btn btn-stats\" data-btn=\"stats\"><span>Stats &amp; Settings</span></button><button class=\"game-btn btn-map\" data-btn=\"map\"><span>Map</span></button></nav>`;\r\n\r\n  document.body.appendChild(main);\r\n}\r\n", "\r\nexport const SHOW_FPS = true;\r\n\r\nexport function initFpsTracker() {\r\n  if (!SHOW_FPS) return;\r\n\r\n  const fpsDiv = document.createElement('div');\r\n  fpsDiv.id = 'fps-tracker';\r\n  Object.assign(fpsDiv.style, {\r\n    position: 'fixed',\r\n    top: '0',\r\n    left: '0',\r\n    zIndex: '2147483647',\r\n    background: '#000',\r\n    color: '#fff',\r\n    fontFamily: 'monospace',\r\n    padding: '4px',\r\n    fontSize: '12px',\r\n    pointerEvents: 'none',\r\n  });\r\n  document.body.appendChild(fpsDiv);\r\n\r\n  let frameCount = 0;\r\n  let lastTime = performance.now();\r\n\r\n  function loop(now) {\r\n    frameCount++;\r\n    const elapsed = now - lastTime;\r\n    \r\n    if (elapsed >= 250) {\r\n      const fps = Math.round((frameCount * 1000) / elapsed);\r\n      fpsDiv.textContent = `FPS: ${fps}`;\r\n      frameCount = 0;\r\n      lastTime = now;\r\n    }\r\n    \r\n    requestAnimationFrame(loop);\r\n  }\r\n\r\n  requestAnimationFrame(loop);\r\n}\r\n", "import { NODE_MAP } from '../game/labNodes.js';\r\nimport { playAudio } from '../util/audioManager.js';\r\nimport { isViewingLabTab } from './merchantTabs/dlgTab.js';\r\n\r\nlet container = null;\r\nconst queue = [];\r\nlet isProcessing = false;\r\nlet isPaused = true;\r\n\r\nfunction ensureContainer() {\r\n    if (container) return container;\r\n    container = document.createElement('div');\r\n    container.className = 'notification-container';\r\n    document.body.appendChild(container);\r\n    return container;\r\n}\r\n\r\nexport function unpauseNotifications() {\r\n    isPaused = false;\r\n    processQueue();\r\n}\r\n\r\nasync function processQueue() {\r\n    if (isProcessing || isPaused || queue.length === 0) return;\r\n    isProcessing = true;\r\n\r\n    const { text, iconSrc, duration } = queue.shift();\r\n    \r\n    await displayNotification(text, iconSrc, duration);\r\n    \r\n    isProcessing = false;\r\n    // Process next item if any\r\n    if (queue.length > 0) {\r\n        processQueue();\r\n    }\r\n}\r\n\r\nfunction displayNotification(text, iconSrc, duration) {\r\n    return new Promise((resolve) => {\r\n        const parent = ensureContainer();\r\n        \r\n        const el = document.createElement('div');\r\n        el.className = 'notification';\r\n        \r\n        if (iconSrc) {\r\n            const icon = document.createElement('img');\r\n            icon.src = iconSrc;\r\n            icon.className = 'notification-icon';\r\n            icon.alt = '';\r\n            el.appendChild(icon);\r\n        }\r\n        \r\n        const content = document.createElement('div');\r\n        content.className = 'notification-text';\r\n        content.innerHTML = text; \r\n        el.appendChild(content);\r\n        \r\n        parent.appendChild(el);\r\n        \r\n        playAudio('sounds/notif_ding.ogg', { volume: 0.5 });\r\n        \r\n        // Animate in\r\n        // Use double RAF to ensure transition triggers\r\n        requestAnimationFrame(() => {\r\n            requestAnimationFrame(() => {\r\n                el.classList.add('is-visible');\r\n            });\r\n        });\r\n        \r\n        // Wait for duration\r\n        setTimeout(() => {\r\n            el.classList.remove('is-visible');\r\n            el.classList.add('is-leaving');\r\n            \r\n            const cleanup = () => {\r\n                el.remove();\r\n                resolve();\r\n            };\r\n            \r\n            el.addEventListener('transitionend', cleanup, { once: true });\r\n            \r\n            // Safety timeout in case transitionend doesn't fire\r\n            setTimeout(() => {\r\n                if (el.isConnected) {\r\n                    el.remove();\r\n                    resolve();\r\n                }\r\n            }, 600);\r\n        }, duration);\r\n    });\r\n}\r\n\r\nexport function showNotification(text, iconSrc, duration = 5000) {\r\n    queue.push({ text, iconSrc, duration });\r\n    processQueue();\r\n}\r\n\r\nexport function initNotifications() {\r\n    if (typeof window === 'undefined') return;\r\n    \r\n    window.addEventListener('lab:node:change', (e) => {\r\n        const { id, level } = e.detail || {};\r\n        if (!id || level == null) return;\r\n        \r\n        const node = NODE_MAP.get(id);\r\n        if (!node) return;\r\n        \r\n        // Check max level\r\n        const maxLevel = node.maxLevel;\r\n        if (level < maxLevel) return;\r\n        \r\n        // Check if viewing lab\r\n        if (isViewingLabTab()) return;\r\n        \r\n        // Show notification\r\n        const title = node.title || 'Node';\r\n        showNotification(`${title}<br>Maxed!`, 'img/' + node.icon);\r\n    });\r\n}\r\n", "// js/main.js\r\n\r\nimport { playAudio, setAudioSuspended } from './util/audioManager.js';\r\n\r\nexport const DEBUG_PANEL_ACCESS = true; // I will change this to false for prod so the readme makes sense\r\nexport const IS_MOBILE = (() => {\r\n  if (typeof window === 'undefined') return false;\r\n\r\n  if (typeof window.IS_MOBILE !== 'undefined') {\r\n    return !!window.IS_MOBILE;\r\n  }\r\n\r\n  const detected = (window.matchMedia && window.matchMedia('(pointer: coarse)').matches)\r\n    || ('ontouchstart' in window)\r\n    || (window.navigator && window.navigator.maxTouchPoints > 0);\r\n  window.IS_MOBILE = detected;\r\n  return detected;\r\n})();\r\n\r\nif (IS_MOBILE) {\r\n  document.documentElement.classList.add('is-mobile');\r\n}\r\n\r\nlet initSlots;\r\nlet createSpawner;\r\nlet initCoinPickup;\r\nlet initHudButtons;\r\nlet installGhostTapGuard;\r\nlet initGlobalGhostTap;\r\nlet initGlobalOverlayEsc;\r\nlet bank;\r\nlet getHasOpenedSaveSlot;\r\nlet setHasOpenedSaveSlot;\r\nlet ensureStorageDefaults;\r\nlet ensureMultiplierDefaults;\r\nlet getUpgAreaKey;\r\nlet computeUpgradeEffects;\r\nlet initXpSystem;\r\nlet onUpgradesChanged;\r\nlet registerPreloadedAudio;\r\nlet initPopups;\r\nlet installSuspendSafeguards;\r\nlet restoreSuspendBackup;\r\nlet markProgressDirty;\r\nlet flushBackupSnapshot;\r\nlet initResetSystemGame;\r\nlet initMutationSystem;\r\nlet getMutationCoinSprite;\r\nlet onMutationChangeGame;\r\nlet setDebugPanelAccess;\r\nlet applyStatMultiplierOverride;\r\nlet startGameLoop;\r\nlet registerTick;\r\nlet registerFrame;\r\nlet notifyGameSessionStarted;\r\nlet ensureGameDom;\r\nlet waterSystem;\r\n\r\n// Store unsubscribe functions for water system to avoid duplicate listeners\r\nlet waterTickUnsub = null;\r\nlet waterFrameUnsub = null;\r\n\r\nlet unpauseNotifications = null;\r\nconst pendingPreloadedAudio = [];\r\n\r\nfunction applyPendingSlotWipe() {\r\n  let slotStr;\r\n  try {\r\n    slotStr = localStorage.getItem('ccc:pendingSlotWipe');\r\n  } catch {\r\n    slotStr = null;\r\n  }\r\n  if (!slotStr) return;\r\n\r\n  const slot = Number(slotStr);\r\n  const suffix = `:${slot}`;\r\n  const toRemove = [];\r\n\r\n  try {\r\n    const storage = localStorage;\r\n    for (let i = 0; i < storage.length; i++) {\r\n      const key = storage.key(i);\r\n      if (key && key.startsWith('ccc:') && key.endsWith(suffix)) {\r\n        toRemove.push(key);\r\n      }\r\n    }\r\n\r\n    toRemove.forEach(k => {\r\n      try { localStorage.removeItem(k); } catch {}\r\n    });\r\n\r\n    // Remove the flag so it only executes once\r\n    try { localStorage.removeItem('ccc:pendingSlotWipe'); } catch {}\r\n  } catch {\r\n    try { localStorage.removeItem('ccc:pendingSlotWipe'); } catch {}\r\n  }\r\n}\r\n\r\nfunction disableMobileZoomGestures() {\r\n  if (!IS_MOBILE) return;\r\n\r\n  let lastTouchEnd = 0;\r\n  const TOUCH_DELAY_MS = 350;\r\n\r\n  document.addEventListener('touchend', (event) => {\r\n    const now = performance.now();\r\n    if (now - lastTouchEnd <= TOUCH_DELAY_MS) {\r\n      event.preventDefault();\r\n    }\r\n    lastTouchEnd = now;\r\n  }, { passive: false });\r\n\r\n  document.addEventListener('gesturestart', (event) => {\r\n    event.preventDefault();\r\n  }, { passive: false });\r\n\r\n  document.addEventListener('dblclick', (event) => {\r\n    event.preventDefault();\r\n  }, { passive: false });\r\n}\r\n\r\ndisableMobileZoomGestures();\r\n\r\nexport const AREAS = {\r\n  MENU: 0,\r\n  STARTER_COVE: 1,\r\n};\r\n\r\nlet currentArea = AREAS.MENU;\r\nlet currentMusic = null;\r\nlet spawner = null;\r\nlet cleanupUpgradesListener = null;\r\n\r\n/* ---------------------------\r\n   LOADER UI (immediate black + progress)\r\n----------------------------*/\r\nconst nextFrame = () => new Promise(r => requestAnimationFrame(r));\r\nconst twoFrames = async () => { await nextFrame(); await nextFrame(); };\r\nfunction showLoader(text = 'Loading assets...', onSkip) {\r\n  let root = document.getElementById('boot-loader');\r\n  if (!root) {\r\n    root = document.createElement('div');\r\n    root.id = 'boot-loader';\r\n    root.className = 'loading-screen';\r\n    document.body.appendChild(root);\r\n  }\r\n\r\n  root.innerHTML = '';\r\n  Object.assign(root.style, {\r\n    position: 'fixed',\r\n    inset: '0',\r\n    background: '#000',\r\n    color: '#fff',\r\n    display: 'grid',\r\n    placeItems: 'center',\r\n    zIndex: '2147483647',\r\n    opacity: '1', \r\n    transition: 'opacity 0.4s ease',\r\n  });\r\n\r\n  const wrap = document.createElement('div');\r\n  wrap.style.textAlign = 'center';\r\n  wrap.style.fontFamily = 'system-ui, -apple-system, Segoe UI, Roboto, sans-serif';\r\n\r\n  const label = document.createElement('div');\r\n  label.textContent = text;\r\n  Object.assign(label.style, {\r\n    fontSize: 'clamp(16px, 2.4vw, 22px)',\r\n    letterSpacing: '.04em',\r\n    opacity: '.92',\r\n  });\r\n\r\n  const bar = document.createElement('div');\r\n  Object.assign(bar.style, {\r\n    width: 'min(420px, 70vw)',\r\n    height: '10px',\r\n    background: 'rgba(255,255,255,.15)',\r\n    borderRadius: '999px',\r\n    margin: '12px auto 6px',\r\n    overflow: 'hidden',\r\n  });\r\n\r\n  const fill = document.createElement('div');\r\n  Object.assign(fill.style, {\r\n    width: '0%',\r\n    height: '100%',\r\n    background: '#fff',\r\n    transform: 'translateZ(0)',\r\n    transition: 'width .15s linear',\r\n  });\r\n\r\n  const pct = document.createElement('div');\r\n  pct.textContent = '0%';\r\n  Object.assign(pct.style, { fontSize: '12px', opacity: '.85' });\r\n\r\n  bar.appendChild(fill);\r\n  wrap.append(label, bar, pct);\r\n  root.appendChild(wrap);\r\n\r\n  const stuckMsg = document.createElement('div');\r\n  stuckMsg.textContent = 'If progress bar is stuck, try reloading the page.';\r\n  Object.assign(stuckMsg.style, {\r\n    marginTop: '16px',\r\n    fontSize: '14px',\r\n    opacity: '0',\r\n    transition: 'opacity 0.5s ease',\r\n    color: 'rgba(255,255,255,0.65)',\r\n  });\r\n  wrap.appendChild(stuckMsg);\r\n\r\n  const stuckTimeout = setTimeout(() => {\r\n    if (!root.__done) stuckMsg.style.opacity = '1';\r\n  }, 25000);\r\n\r\n  if (typeof onSkip === 'function') {\r\n    const skipBtn = document.createElement('div');\r\n    skipBtn.textContent = IS_MOBILE\r\n      ? 'Tap here to skip loading now and load assets during gameplay'\r\n      : 'Click here to skip loading now and load assets during gameplay';\r\n    Object.assign(skipBtn.style, {\r\n      marginTop: '24px',\r\n      fontSize: '14px',\r\n      color: '#888',\r\n      textDecoration: 'underline',\r\n      cursor: 'pointer',\r\n      opacity: '0.9',\r\n    });\r\n    skipBtn.addEventListener('click', (e) => {\r\n      e.preventDefault();\r\n      e.stopPropagation();\r\n      if (root.__skipped) return;\r\n      root.__skipped = true;\r\n      if (root.__pct) root.__pct.textContent = 'Loading skipped';\r\n      if (root.__label) root.__label.textContent = 'Loading skipped';\r\n      skipBtn.textContent = 'Loading skipped';\r\n      skipBtn.style.textDecoration = 'none';\r\n      skipBtn.style.cursor = 'default';\r\n      onSkip();\r\n    });\r\n    wrap.appendChild(skipBtn);\r\n  }\r\n\r\n  root.__mountedAt = performance.now();\r\n  root.__done = false;\r\n  root.__wrap = wrap;\r\n  root.__bar = bar;\r\n  root.__fill = fill;\r\n  root.__pct = pct;\r\n  root.__label = label;\r\n  root.__stuckMsg = stuckMsg;\r\n  root.__stuckTimeout = stuckTimeout;\r\n  return root;\r\n}\r\n\r\nfunction setLoaderProgress(loaderEl, fraction) {\r\n  if (!loaderEl || !loaderEl.__fill || !loaderEl.__pct) return;\r\n  if (loaderEl.__skipped) return;\r\n  const f = Math.max(0, Math.min(1, fraction || 0));\r\n  const pct = Math.round(f * 100);\r\n  loaderEl.__fill.style.width = pct + '%';\r\n  loaderEl.__pct.textContent = pct + '%';\r\n}\r\n\r\nfunction finishAndHideLoader(loaderEl, onFadeStart, finishedText, dwellMs = 500) {\r\n  if (!loaderEl || loaderEl.__done) return;\r\n  loaderEl.__done = true;\r\n\r\n  if (loaderEl.__label) {\r\n    if (finishedText) {\r\n      loaderEl.__label.textContent = finishedText;\r\n    } else {\r\n      loaderEl.__label.textContent = loaderEl.__skipped\r\n        ? 'Loading Skipped'\r\n        : 'Finished loading assets';\r\n    }\r\n  }\r\n  loaderEl.offsetHeight;\r\n\r\n  setTimeout(async () => {\r\n    if (typeof onFadeStart === 'function') {\r\n      try { onFadeStart(); } catch (e) { console.error(e); }\r\n    }\r\n    await twoFrames();\r\n    loaderEl.style.opacity = '0';\r\n    const onEnd = () => {\r\n      loaderEl.remove();\r\n      document.documentElement.classList.remove('booting');\r\n    };\r\n    loaderEl.addEventListener('transitionend', onEnd, { once: true });\r\n    setTimeout(onEnd, 450);\r\n  }, dwellMs);\r\n}\r\n\r\n/* ---------------------------\r\n   PRELOADERS\r\n----------------------------*/\r\nasync function warmImage(url) {\r\n  const img = new Image();\r\n  img.src = url;\r\n\r\n  try {\r\n    if (img.decode) await img.decode();\r\n  } catch (_) {\r\n  }\r\n\r\n  await new Promise((resolve) => {\r\n    const ghost = document.createElement('img');\r\n    ghost.src = url;\r\n    ghost.alt = '';\r\n    ghost.style.cssText =\r\n      'position:fixed;left:-9999px;top:-9999px;width:1px;height:1px;opacity:0;pointer-events:none;';\r\n    document.body.appendChild(ghost);\r\n    requestAnimationFrame(() => { ghost.remove(); resolve(); });\r\n  });\r\n}\r\n\r\nfunction preloadImages(sources, onEach) {\r\n  return sources.map(src => new Promise(resolve => {\r\n    const img = new Image();\r\n    const done = () => { try { onEach?.(src); } catch {} resolve(src); };\r\n    img.onload = done;\r\n    img.onerror = done;\r\n    img.src = src;\r\n  }));\r\n}\r\n\r\nfunction preloadAudio(sources, onEach) {\r\n  return sources.map(async url => {\r\n    try {\r\n        const { loadAudio } = await import('./util/audioManager.js');\r\n        await loadAudio(url);\r\n    } catch {}\r\n    try { onEach?.(url); } catch {}\r\n    return url;\r\n  });\r\n}\r\n\r\nfunction preloadFonts(onEach) {\r\n  if (document.fonts && document.fonts.ready) {\r\n    return [document.fonts.ready.then(() => { try { onEach?.('fonts'); } catch {} })];\r\n  }\r\n  return [Promise.resolve().then(() => { try { onEach?.('fonts'); } catch {} })];\r\n}\r\n\r\nasync function preloadAssetsWithProgress({ images = [], audio = [], fonts = true }, onProgress) {\r\n  const total = images.length + audio.length + (fonts ? 1 : 0);\r\n  if (total === 0) { onProgress?.(1); return; }\r\n  let done = 0;\r\n  const bump = () => { done++; onProgress?.(done / total); };\r\n\r\n  const tasks = [\r\n    ...preloadImages(images, bump),\r\n    ...preloadAudio(audio, bump),\r\n    ...(fonts ? preloadFonts(bump) : []),\r\n  ];\r\n\r\n  await Promise.all(tasks.map(p => p.catch(() => null)));\r\n}\r\n\r\n/* ---------------------------\r\n   GAME AREA CONTROL\r\n----------------------------*/\r\nfunction enterArea(areaID) {\r\n  if (currentArea === areaID) return;\r\n\r\n  if (currentMusic) {\r\n    currentMusic.stop();\r\n    currentMusic = null;\r\n  }\r\n\r\n  currentArea = areaID;\r\n\r\n  const menuRoot = document.querySelector('.menu-root');\r\n  switch (areaID) {\r\n    case AREAS.STARTER_COVE: {\r\n      // Defer music until the area is visually painted + a small buffer.\r\n      // We use double-RAF to ensure the browser has completed the paint cycle,\r\n      // plus a 300ms timeout to wait a beat before audio kicks in.\r\n      requestAnimationFrame(() => {\r\n        requestAnimationFrame(() => {\r\n          setTimeout(() => {\r\n            if (currentArea === AREAS.STARTER_COVE) {\r\n              currentMusic = playAudio('sounds/The_Cove.ogg', { loop: true, type: 'music' });\r\n              if (typeof unpauseNotifications === \"function\") unpauseNotifications();\r\n            }\r\n          }, 300);\r\n        });\r\n      });\r\n\r\n      if (menuRoot) {\r\n        menuRoot.style.display = 'none';\r\n      }\r\n      document.body.classList.remove('menu-bg');\r\n\r\n      // Config for water layers\r\n      const FG_LAYER_COUNT = 5;\r\n      const FG_START_Z = 80;\r\n\r\n      if (typeof ensureGameDom === 'function') {\r\n        ensureGameDom(FG_LAYER_COUNT, FG_START_Z);\r\n      }\r\n\r\n      // Initialize Water System\r\n      if (waterSystem) {\r\n        // Generate IDs: ['water-fg-0', 'water-fg-1', ...]\r\n        const fgIds = Array.from({ length: FG_LAYER_COUNT }, (_, i) => `water-fg-${i}`);\r\n        waterSystem.init('water-background', fgIds);\r\n        \r\n        // Unregister old listeners if they exist to prevent leaks\r\n        if (waterTickUnsub) {\r\n            try { waterTickUnsub(); } catch {}\r\n            waterTickUnsub = null;\r\n        }\r\n        if (waterFrameUnsub) {\r\n            try { waterFrameUnsub(); } catch {}\r\n            waterFrameUnsub = null;\r\n        }\r\n        \r\n        // Register update loop (simulation)\r\n        if (typeof registerTick === 'function') {\r\n            waterTickUnsub = registerTick((dt) => waterSystem.update(dt));\r\n        }\r\n        \r\n        // Register render loop (visuals)\r\n        if (typeof registerFrame === 'function') {\r\n            waterFrameUnsub = registerFrame((totalTime, dt) => waterSystem.render(totalTime, dt));\r\n        }\r\n      }\r\n\r\n      const gameRoot = document.getElementById('game-root');\r\n      if (gameRoot) {\r\n        gameRoot.hidden = false;\r\n        if (waterSystem) {\r\n            // Delay resize to ensure DOM layout is updated after unhiding\r\n            requestAnimationFrame(() => waterSystem.resize());\r\n        }\r\n        initHudButtons();\r\n      }\r\n\r\n      if (typeof initResetSystemGame === 'function') {\r\n        try { initResetSystemGame(); } catch {}\r\n      }\r\n\r\n      if (typeof initMutationSystem === 'function') {\r\n        try { initMutationSystem(); } catch {}\r\n      }\r\n\r\n      if (!spawner) {\r\n        spawner = createSpawner({\r\n          coinSrc: 'img/currencies/coin/coin.webp',\r\n          coinSize: 40,\r\n          initialRate: 1,\r\n          surgeLifetimeMs: 1800,\r\n          surgeWidthVw: 22,\r\n          initialBurst: 0,\r\n        });\r\n        window.spawner = spawner;\r\n        const applyMutationSprite = () => {\r\n          if (!spawner || typeof spawner.setCoinSprite !== 'function') return;\r\n          try { spawner.setCoinSprite(getMutationCoinSprite?.()); } catch {}\r\n        };\r\n        applyMutationSprite();\r\n        onMutationChangeGame?.(applyMutationSprite);\r\n        const pickup = initCoinPickup({ spawner });\r\n        if (spawner && typeof spawner.setDependencies === 'function') {\r\n            spawner.setDependencies({\r\n                collectBatch: pickup.collectBatch,\r\n                getMagnetUnit: pickup.getMagnetUnitPx\r\n            });\r\n        }\r\n                const applyUpgradesToSpawner = () => {\r\n                try {\r\n                        const areaKey = getUpgAreaKey();\r\n                        const eff = computeUpgradeEffects(areaKey);\r\n                        if (spawner && eff?.coinsPerSecondMult) {\r\n                          let rate = 1 * eff.coinsPerSecondMult;\r\n                          if (typeof applyStatMultiplierOverride === \"function\") {\r\n                             const override = applyStatMultiplierOverride(\"spawnRate\", rate);\r\n                             try {\r\n                                 if (override && typeof override.toScientific === \"function\") {\r\n                                     rate = Number(override.toScientific(6));\r\n                                 } else {\r\n                                     rate = Number(override);\r\n                                 }\r\n                             } catch {}\r\n                          }\r\n                          if (Number.isFinite(rate)) {\r\n                              spawner.setRate(rate);\r\n                          }\r\n                        }\r\n                  } catch {}\r\n                };\r\n                applyUpgradesToSpawner();\r\n                if (typeof cleanupUpgradesListener === 'function') {\r\n                    try { cleanupUpgradesListener(); } catch {}\r\n                }\r\n                cleanupUpgradesListener = onUpgradesChanged(applyUpgradesToSpawner);\r\n                if (typeof window !== 'undefined') {\r\n                   window.addEventListener('debug:change', applyUpgradesToSpawner);\r\n                }\r\n\r\n      }\r\n      if (typeof initXpSystem === 'function') {\r\n        try { initXpSystem(); } catch {}\r\n      }\r\n      setTimeout(() => {\r\n        if (currentArea === AREAS.STARTER_COVE && spawner) spawner.start();\r\n      }, 300);\r\n      break;\r\n    }\r\n\r\n    case AREAS.MENU: {\r\n      if (menuRoot) {\r\n        menuRoot.style.display = '';\r\n        menuRoot.removeAttribute('aria-hidden');\r\n      }\r\n      const gameRoot = document.getElementById('game-root');\r\n      if (gameRoot) gameRoot.hidden = true;\r\n\r\n      if (spawner) spawner.stop();\r\n      break;\r\n    }\r\n  }\r\n\r\n  try {\r\n    window.dispatchEvent(new CustomEvent('menu:visibilitychange', {\r\n      detail: { visible: areaID === AREAS.MENU },\r\n    }));\r\n  } catch {}\r\n}\r\n\r\n/* ---------------------------\r\n   BOOT FLOW\r\n----------------------------*/\r\ndocument.addEventListener('DOMContentLoaded', async () => {\r\n  let resolveSkip;\r\n  const skipPromise = new Promise(resolve => { resolveSkip = resolve; });\r\n\r\n  const loader = showLoader('Loading assets...', resolveSkip);\r\n\r\n  await nextFrame();\r\n  \r\n  // Initialize audio early\r\n  const { initAudio } = await import('./util/audioManager.js');\r\n  initAudio();\r\n\r\n  const modulePromise = Promise.all([\r\n    import('./util/slots.js'),\r\n    import('./game/spawner.js'),\r\n    import('./game/coinPickup.js'),\r\n    import('./ui/hudButtons.js'),\r\n    import('./util/storage.js'),\r\n    import('./util/saveIntegrity.js'),\r\n    import('./game/upgrades.js'),\r\n    import('./util/audioCache.js'),\r\n    import('./game/xpSystem.js'),\r\n    import('./ui/merchantTabs/resetTab.js'),\r\n    import('./game/mutationSystem.js'),\r\n    import('./ui/popups.js'),\r\n    import('./util/suspendSafeguard.js'),\r\n    import('./util/ghostTapGuard.js'),\r\n    import('./util/globalOverlayEsc.js'),\r\n    import('./util/debugPanel.js'),\r\n    import('./game/gameLoop.js'),\r\n    import('./game/offlinePanel.js'),\r\n    import('./ui/merchantTabs/workshopTab.js'),\r\n    import('./game/automationEffects.js'),\r\n    import('./game/domInit.js'),\r\n    import('./game/surgeEffects.js'),\r\n    import('./game/webgl/waterSystem.js'),\r\n    import('./ui/merchantTabs/labTab.js'),\r\n    import('./util/fpsTracker.js'),\r\n    import('./ui/notifications.js'),\r\n  ]);\r\n\r\n  const ASSET_MANIFEST = {\r\nimages: [\r\n  // ==== img/currencies/book ====\r\n  'img/currencies/book/book.webp',\r\n  'img/currencies/book/book_base.webp',\r\n  'img/currencies/book/book_plus_base.webp',\r\n\r\n  // ==== img/currencies/coin ====\r\n  'img/currencies/coin/coin.webp',\r\n  'img/currencies/coin/coin_base.webp',\r\n  'img/currencies/coin/coin_plus_base.webp',\r\n\r\n  // ==== img/currencies/dna ====\r\n  'img/currencies/dna/dna.webp',\r\n  'img/currencies/dna/dna_base.webp',\r\n  'img/currencies/dna/dna_plus_base.webp',\r\n\r\n  // ==== img/currencies/gear ====\r\n  'img/currencies/gear/gear.webp',\r\n  'img/currencies/gear/gear_base.webp',\r\n  'img/currencies/gear/gear_plus_base.webp',\r\n\r\n  // ==== img/currencies/gold ====\r\n  'img/currencies/gold/gold.webp',\r\n  'img/currencies/gold/gold_base.webp',\r\n  'img/currencies/gold/gold_plus_base.webp',\r\n\r\n  // ==== img/currencies/magic ====\r\n  'img/currencies/magic/magic.webp',\r\n  'img/currencies/magic/magic_base.webp',\r\n  'img/currencies/magic/magic_plus_base.webp',\r\n  \r\n  // ==== img/currencies/wave ====\r\n  'img/currencies/wave/wave.webp',\r\n  'img/currencies/wave/wave_base.webp',\r\n  'img/currencies/wave/wave_plus_base.webp',\r\n\r\n  // ==== img/misc ====\r\n  'img/misc/experiment.webp',\r\n  'img/misc/experiment_plus_base.webp',\r\n  'img/misc/forge.webp',\r\n  'img/misc/forge_plus_base.webp',\r\n  'img/misc/infuse.webp',\r\n  'img/misc/infuse_plus_base.webp',\r\n  'img/misc/infuse_base.webp',\r\n  'img/misc/surge.webp',\r\n  'img/misc/surge_plus_base.webp',\r\n  'img/misc/green_border.webp',\r\n  'img/misc/locked.webp',\r\n  'img/misc/locked_base.webp',\r\n  'img/misc/maxed.webp',\r\n  'img/misc/merchant.webp',\r\n  'img/misc/mysterious.webp',\r\n\r\n  // ==== img/mutations ====\r\n  ...Array.from({ length: 25 }, (_, i) => `img/mutations/m${i + 1}.webp`),\r\n\r\n  // ==== img/sc_upg_icons ====\r\n  'img/sc_upg_icons/book_val1.webp',\r\n  'img/sc_upg_icons/coin_val1.webp',\r\n  'img/sc_upg_icons/coin_val2.webp',\r\n  'img/sc_upg_icons/coin_val3.webp',\r\n  'img/sc_upg_icons/coin_val_dna.webp',\r\n  'img/sc_upg_icons/coin_val_hm1.webp',\r\n  'img/sc_upg_icons/coin_val_hm2.webp',\r\n  'img/sc_upg_icons/coin_val_hm3.webp',\r\n  'img/sc_upg_icons/faster_coins1.webp',\r\n  'img/sc_upg_icons/faster_coins2.webp',\r\n  'img/sc_upg_icons/faster_coins3.webp',\r\n  'img/sc_upg_icons/gold_val_dna.webp',\r\n  'img/sc_upg_icons/magic_val_dna.webp',\r\n  'img/sc_upg_icons/magnet.webp',\r\n  'img/sc_upg_icons/mp_val1.webp',\r\n  'img/sc_upg_icons/mp_val2.webp',\r\n  'img/sc_upg_icons/wave_val_dna.webp',\r\n  'img/sc_upg_icons/xp_val1.webp',\r\n  'img/sc_upg_icons/xp_val2.webp',\r\n  'img/sc_upg_icons/xp_val3.webp',\r\n  'img/sc_upg_icons/xp_val_dna.webp',\r\n  'img/sc_upg_icons/xp_val_hm.webp',\r\n  'img/sc_upg_icons/mp_val_hm.webp',\r\n  'img/sc_upg_icons/effective_auto_collect.webp',\r\n  'img/sc_upg_icons/autobuy_coin.webp',\r\n  'img/sc_upg_icons/autobuy_book.webp',\r\n  'img/sc_upg_icons/autobuy_dna.webp',\r\n  'img/sc_upg_icons/autobuy_gold.webp',\r\n  'img/sc_upg_icons/autobuy_magic.webp',\r\n  'img/sc_upg_icons/autobuy_workshop_level.webp',\r\n  \r\n  // ==== img/lab_icons ====\r\n  'img/lab_icons/tsunami_exponent_buff.webp',\r\n  'img/lab_icons/coin_val0.webp',\r\n  'img/lab_icons/gold_val0.webp',\r\n  'img/lab_icons/magic_val0.webp',\r\n  'img/lab_icons/wave_val0.webp',\r\n  \r\n  // ==== img/stats ====\r\n  'img/stats/mp/mp.webp',\r\n  'img/stats/mp/mp_base.webp',\r\n  'img/stats/mp/mp_plus_base.webp',\r\n  'img/stats/xp/xp.webp',\r\n  'img/stats/xp/xp_base.webp',\r\n  'img/stats/xp/xp_plus_base.webp',\r\n  'img/stats/rp/rp.webp',\r\n  'img/stats/rp/rp_base.webp',\r\n],\r\n    audio: [\r\n      'sounds/coin_pickup.ogg',\r\n      'sounds/wave_spawn.ogg',\r\n      'sounds/merchant_typing.ogg',\r\n      'sounds/purchase_upg.ogg',\r\n\t  'sounds/forge_reset.ogg',\r\n\t  'sounds/infuse_reset.ogg',\r\n\t  'sounds/surge_reset.ogg',\r\n\t  'sounds/experiment_reset.ogg',\r\n\t  'sounds/evolve_upg.ogg',\r\n\t  'sounds/warp.ogg',\r\n\t  'sounds/coin_pickup_size1.ogg',\r\n\t  'sounds/coin_pickup_size2.ogg',\r\n\t  'sounds/coin_pickup_size3.ogg',\r\n\t  'sounds/coin_pickup_size4.ogg',\r\n\t  'sounds/coin_pickup_size5.ogg',\r\n\t  'sounds/coin_pickup_size6.ogg',\r\n\t  'sounds/lightning_strike.ogg',\r\n\t  'sounds/lightning_zap.ogg',\r\n\t  'sounds/The_Cove.ogg',\r\n    'sounds/tsu_storm_ambience.ogg',\r\n    'sounds/tsu_rumble.ogg',\r\n    'sounds/tsu_beacon_spawn.ogg',\r\n    'sounds/tsu_beacon_hum.ogg',\r\n    'sounds/tsu_explosion.ogg',\r\n\t'sounds/notif_ding.ogg',\r\n    ],\r\n    fonts: true,\r\n  };\r\n\r\n  let progress = 0;\r\n  const assetsPromise = preloadAssetsWithProgress(ASSET_MANIFEST, f => {\r\n    progress = f;\r\n    setLoaderProgress(loader, f);\r\n  });\r\n\r\n  const [\r\n    slotsModule,\r\n    spawnerModule,\r\n    coinPickupModule,\r\n    hudButtonsModule,\r\n    storageModule,\r\n    saveIntegrityModule,\r\n    upgradesModule,\r\n    audioCacheModule,\r\n    xpModule,\r\n    resetModule,\r\n    mutationModule,\r\n    popupModule,\r\n    safetyModule,\r\n    guardModule,\r\n    escModule,\r\n    debugPanelModule,\r\n    gameLoopModule,\r\n    offlinePanelModule,\r\n    workshopTabModule,\r\n    automationEffectsModule,\r\n    domInitModule,\r\n    surgeEffectsModule,\r\n    waterSystemModule,\r\n    labTabModule,\r\n    fpsTrackerModule,\r\n    notificationModule,\r\n  ] = await modulePromise;\r\n\r\n  ({ initSlots } = slotsModule);\r\n  ({ createSpawner } = spawnerModule);\r\n  ({ initCoinPickup } = coinPickupModule);\r\n  ({ initHudButtons } = hudButtonsModule);\r\n  ({ bank, getHasOpenedSaveSlot, setHasOpenedSaveSlot, ensureStorageDefaults, notifyGameSessionStarted, ensureMultiplierDefaults } = storageModule);\r\n  void saveIntegrityModule;\r\n  ({ getCurrentAreaKey: getUpgAreaKey, computeUpgradeEffects, onUpgradesChanged } = upgradesModule);\r\n  ({ registerPreloadedAudio } = audioCacheModule);\r\n  ({ initXpSystem } = xpModule);\r\n  ({ initResetSystem: initResetSystemGame } = resetModule);\r\n  ({ initMutationSystem, getMutationCoinSprite, onMutationChange: onMutationChangeGame } = mutationModule);\r\n  ({ initPopups } = popupModule);\r\n  ({ installSuspendSafeguards, restoreFromBackupIfNeeded: restoreSuspendBackup, markProgressDirty, flushBackupSnapshot } = safetyModule);\r\n  ({ installGhostTapGuard, initGlobalGhostTap } = guardModule);\r\n  ({ initGlobalOverlayEsc } = escModule);\r\n  ({ setDebugPanelAccess, applyStatMultiplierOverride } = debugPanelModule);\r\n  ({ startGameLoop, registerTick, registerFrame } = gameLoopModule);\r\n  const { initOfflineTracker, processOfflineProgress } = offlinePanelModule;\r\n  const { initWorkshopSystem } = workshopTabModule;\r\n  const { initAutomationEffects } = automationEffectsModule;\r\n  ({ ensureGameDom } = domInitModule);\r\n  const { initSurgeEffects } = surgeEffectsModule;\r\n  ({ waterSystem } = waterSystemModule);\r\n  const { initLabLogic } = labTabModule;\r\n  const { initFpsTracker } = fpsTrackerModule;\r\n  const { initNotifications, unpauseNotifications: _unpause, showNotification } = notificationModule;\r\n  unpauseNotifications = _unpause;\r\n\r\n  window.bank = bank;\r\n  window.unpauseNotifications = unpauseNotifications;\r\n  window.showNotification = showNotification;\r\n\r\n  // Global Audio Control for Events\r\n  if (typeof window !== 'undefined') {\r\n    window.addEventListener('audio:stopMusic', () => {\r\n        if (currentMusic) {\r\n            try { currentMusic.stop(); } catch {}\r\n            currentMusic = null;\r\n        }\r\n    });\r\n\r\n    window.addEventListener('audio:restartMusic', () => {\r\n        if (currentMusic) {\r\n            try { currentMusic.stop(); } catch {}\r\n            currentMusic = null;\r\n        }\r\n        if (currentArea === AREAS.STARTER_COVE) {\r\n            currentMusic = playAudio('sounds/The_Cove.ogg', { loop: true, type: 'music' });\r\n        }\r\n    });\r\n  }\r\n\r\n  // No longer using pendingPreloadedAudio since audioManager handles buffering internally\r\n\r\n  window.addEventListener('beforeunload', (e) => {\r\n    if (window.spawner && typeof window.spawner.hasBigCoins === 'function' && window.spawner.hasBigCoins()) {\r\n      e.preventDefault();\r\n      e.returnValue = '';\r\n      return '';\r\n    }\r\n  });\r\n  document.addEventListener('visibilitychange', () => {\r\n    const hidden = document.hidden;\r\n    setAudioSuspended(hidden);\r\n    if (currentMusic && currentMusic.element) {\r\n      if (hidden) {\r\n        currentMusic.element.pause();\r\n      } else {\r\n        currentMusic.element.play().catch(() => {});\r\n      }\r\n    }\r\n  });\r\n\r\n\r\n\r\n  installGhostTapGuard?.();\r\n  initGlobalGhostTap?.();\r\n  initGlobalOverlayEsc?.();\r\n  installSuspendSafeguards?.();\r\n  if (typeof setDebugPanelAccess === 'function') {\r\n    setDebugPanelAccess(DEBUG_PANEL_ACCESS);\r\n    window.setDebugPanelAccess = setDebugPanelAccess;\r\n  }\r\n\r\n  try {\r\n    await restoreSuspendBackup?.();\r\n  } catch {}\r\n\r\n  await Promise.race([assetsPromise, skipPromise]);\r\n\r\n  await twoFrames();\r\n  document.documentElement.classList.remove('booting');\r\n\r\n  await nextFrame();\r\n\r\n  finishAndHideLoader(loader);\r\n\r\n  await Promise.all([ // fixes some image preload issue on mobile\r\n    warmImage('img/currencies/coin/coin_plus_base.webp'),\r\n    warmImage('img/stats/xp/xp_plus_base.webp'),\r\n\twarmImage('img/stats/mp/mp_plus_base.webp'),\r\n  ]);\r\n  \r\n  // Ensure we start with no active slot so game loops don't run for a lingering slot ID\r\n  try {\r\n    if (typeof storageModule.clearActiveSlot === 'function') {\r\n      storageModule.clearActiveSlot();\r\n    } else if (storageModule && storageModule.KEYS && storageModule.KEYS.SAVE_SLOT) {\r\n      localStorage.removeItem(storageModule.KEYS.SAVE_SLOT);\r\n    }\r\n  } catch {}\r\n\r\n  startGameLoop();\r\n  initOfflineTracker(() => currentArea === AREAS.STARTER_COVE);\r\n\r\n  try { initWorkshopSystem(); } catch(e) { console.error('Workshop init failed', e); }\r\n  try { initAutomationEffects(); } catch(e) { console.error('Automation init failed', e); }\r\n  try { initSurgeEffects(); } catch(e) { console.error('Surge effects init failed', e); }\r\n  try { initLabLogic(); } catch(e) { console.error('Lab system init failed', e); }\r\n  try { initFpsTracker(); } catch(e) { console.error('FPS tracker init failed', e); }\r\n  \r\n  applyPendingSlotWipe();\r\n  ensureStorageDefaults();\r\n  markProgressDirty?.('ensure-defaults');\r\n  initPopups();\r\n  initNotifications();\r\n\r\n  const titleEl = document.getElementById('panel-title');\r\n  if (getHasOpenedSaveSlot()) {\r\n    document.body.classList.add('has-opened');\r\n    if (titleEl) titleEl.style.opacity = '0';\r\n  } else {\r\n    if (titleEl) titleEl.style.opacity = '1';\r\n  }\r\n\r\n  initSlots(async () => {\r\n    if (currentArea === AREAS.STARTER_COVE) return;\r\n    setHasOpenedSaveSlot(true);\r\n    document.body.classList.add('has-opened');\r\n    if (titleEl) titleEl.style.opacity = '0';\r\n\r\n    const loader = showLoader('Loading game...');\r\n    const stepDelay = () => new Promise(r => setTimeout(r, 120));\r\n\r\n    // Milestone 1: Multipliers\r\n    setLoaderProgress(loader, 0.2);\r\n    await stepDelay();\r\n    ensureMultiplierDefaults();\r\n    \r\n    // Milestone 2: Offline Progress\r\n    setLoaderProgress(loader, 0.4);\r\n    await stepDelay();\r\n    processOfflineProgress();\r\n\r\n    // Milestone 3: Session Start\r\n    setLoaderProgress(loader, 0.65);\r\n    await stepDelay();\r\n    notifyGameSessionStarted?.();\r\n\r\n    // Milestone 4: Finalizing\r\n    setLoaderProgress(loader, 0.9);\r\n    await stepDelay();\r\n    markProgressDirty?.('slot-entered');\r\n\r\n    setLoaderProgress(loader, 1);\r\n\r\n    finishAndHideLoader(loader, () => {\r\n      enterArea(AREAS.STARTER_COVE);\r\n      setTimeout(() => {\r\n        if (window.spawner && typeof window.spawner.playEntranceWave === 'function') {\r\n          window.spawner.playEntranceWave();\r\n        }\r\n      }, 300);\r\n    }, 'Finished loading game', 200);\r\n  });\r\n\r\n  if (typeof window !== 'undefined' && flushBackupSnapshot) {\r\n    try {\r\n      window.cccRequestBackup = () => flushBackupSnapshot('manual', { immediate: true });\r\n    } catch {}\r\n  }\r\n});\r\n", "import './js/main.js';\r\n"],
  "mappings": "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AC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,KAAK,EAAE,CAAC,IAAI,KAAK,EAAE,CAAC,IAAI,KAAK,EAAE,CAAC,IAAI,IAAI,EAC3H,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,KAAK,EAAE,CAAC,IAAI,KAAK,EAAE,CAAC,IAAI,KAAK,EAAE,CAAC,IAAI,IAAI,EAC3H,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,KAAK,EAAE,CAAC,IAAI,KAAK,EAAE,CAAC,IAAI,KAAK,EAAE,CAAC,IAAI,IAAI,EAC3H,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,KAAK,EAAE,CAAC,GAAG,KAAK,EAAE,CAAC,GAAG,KAAK,EAAE,CAAC,GAAG,IAAI,EACxH,CAAC,GAAG,MAAM,EAAE,CAAC,GAAG,MAAM,EAAE,CAAC,GAAG,MAAM,EAAE,CAAC,GAAG,MAAM,EAAE,CAAC,GAAG,MAAM,EAAE,CAAC,GAAG,MAAM,EAAE,CAAC,GAAG,KAAK,EAAE,CAAC,GAAG,KAAK,EAAE,CAAC,GAAG,KAAK,EAAE,CAAC,GAAG,IAAI,EACjH,CAAC,GAAG,MAAM,EAAE,CAAC,GAAG,MAAM,EAAE,CAAC,GAAG,MAAM,EAAE,CAAC,GAAG,MAAM,EAAE,CAAC,GAAG,MAAM,EAAE,CAAC,GAAG,MAAM,EAAE,CAAC,GAAG,KAAK,EAAE,CAAC,GAAG,KAAK,EAAE,CAAC,GAAG,KAAK,EAAE,CAAC,GAAG,IAAI,EACjH,CAAC,GAAG,IAAI,EAAE,CAAC,GAAG,IAAI,EAAE,CAAC,GAAG,IAAI,E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CACA,sCACA,sCACA,sCACA,sCACA,sCACA,sCACA,sCACA,sCACA,sCACA,sCACA,sCACA,sCACA,sCACA,sCACA,sCACA,sCACA,sCACA,sCACA,sCACA,qCACF,CAAC,EAEKC,EAAiB,CACzB,OAAQ,CAEN,gCACA,qCACA,0CAGA,gCACA,qCACA,0CAGA,8BACA,mCACA,wCAGA,gCACA,qCACA,0CAGA,gCACA,qCACA,0CAGA,kCACA,uCACA,4CAGA,gCACA,qCACA,0CAGA,2BACA,qCACA,sBACA,gCACA,uBACA,iCACA,4BACA,sBACA,gCACA,6BACA,uBACA,4BACA,sBACA,yBACA,2BAGA,GAAG,MAAM,KAAK,CAAE,OAAQ,EAAG,EAAG,CAAC5D,EAAGC,KAAM,kBAAkBA,GAAI,CAAC,OAAO,EAGtE,kCACA,kCACA,kCACA,kCACA,qCACA,qCACA,qCACA,qCACA,sCACA,sCACA,sCACA,qCACA,sCACA,+BACA,gCACA,gCACA,qCACA,gCACA,gCACA,gCACA,mCACA,kCACA,kCACA,+CACA,qCACA,qCACA,oCACA,qCACA,sCACA,+CAGA,2CACA,+BACA,+BACA,gCACA,+BAGA,uBACA,4BACA,iCACA,uBACA,4BACA,iCACA,uBACA,2BACF,EACI,MAAO,CACL,yBACA,wBACA,6BACA,0BACH,yBACA,0BACA,yBACA,8BACA,wBACA,kBACA,+BACA,+BACA,+BACA,+BACA,+BACA,+BACA,8BACA,2BACA,sBACC,gCACA,wBACA,8BACA,4BACA,2BACH,uBACG,EACA,MAAO,EACT,EAEI4D,EAAW,EACTC,EAAgBnF,GAA0BiF,EAAgBrG,GAAK,CACnEsG,EAAWtG,EACXH,GAAkBqG,EAAQlG,CAAC,CAC7B,CAAC,EAEK,CACJwG,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,GACAC,GACAC,EACF,EAAI,MAAM7B,GAET,CAAE,UAAA5B,EAAU,EAAIgC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",
  "names": ["audioManager_exports", "__export", "initAudio", "loadAudio", "playAudio", "registerPreloadedBuffer", "setAudioSuspended", "setMusicUnderwater", "getAudioContext", "audioContext", "Ctx", "masterGain", "musicGain", "musicFilter", "warm", "src", "ctx", "url", "buffers", "loadPromises", "promise", "resp", "arrayBuffer", "decoded", "e", "volume", "detune", "playbackRate", "loop", "type", "buffer", "source", "gainNode", "suspended", "underwater", "frequency", "now", "init_audioManager", "__esmMin", "evt", "approxLog10BigNum", "value", "BigNum", "sigNum", "sigLog", "e", "off", "storage", "parts", "sigStr", "expPart", "offsetStr", "caret", "baseExp", "offset", "digits", "head", "expSum", "bigNumFromLog10", "log10Value", "p", "intPart", "frac", "mantissa", "sig", "exp", "log10OnePlusPow10", "exponent", "LN10", "pow", "init_bigNum", "__esmMin", "_BigNum", "base", "ee", "#normalize", "n", "str", "s", "match", "fracPart", "sign", "digitsRaw", "pStr", "eStr", "pp", "baseStr", "offStr", "eNum", "input", "trimmed", "offsetSuffix", "b", "expCmp", "#compareExponent", "aligned", "#alignSig", "diffSig", "#expObj", "aPlain", "bPlain", "diff", "#pow10", "k", "#adjustExponent", "delta", "prev", "next", "applied", "leftover", "#totalExponentBigInt", "other", "a", "#expDiff", "absDiff", "limit", "#offsetAsNumber", "offNum", "#effectiveExponentNumber", "shift", "q", "diffNum", "out", "r", "baseSum", "offsetSum", "scale", "sigQuotient", "expDiffBase", "expDiffOffset", "pBigInt", "totalExpBase", "resultBase", "resultOffset", "thisIsZero", "otherIsZero", "x", "maxScale", "fracRaw", "mult", "numer", "intDigits", "drop", "newSig", "numerBigInt", "nb", "tail", "mant", "offsetNum", "E", "totalExp", "extraZeros", "localeInt", "s", "num", "NF_INT", "addOneDigitString", "str", "carry", "a", "i", "d", "formatExponentString", "rawDigits", "sign", "ds", "n", "E", "exp", "suffix", "SUFFIX_BY_EXP", "intDigits", "decimals", "totalDigits", "head", "intStr", "fracStr", "mantInt", "mantFrac", "formatExponentChain", "expRaw", "topSign", "m", "int", "frac", "sign2", "kDigits", "kGe303", "k", "four", "mant", "sign2Prefix", "mantissaFourDigits", "sci", "mantissa", "rawExp", "formatNumber", "bn", "BigNum", "formatMultForUi", "value", "log10", "approxLog10BigNum", "approx", "SUFFIX_ENTRIES", "init_numFormat", "__esmMin", "init_bigNum", "storage_exports", "__export", "CURRENCIES", "KEYS", "STORAGE_PREFIX", "bank", "clearActiveSlot", "clearAllStorage", "ensureCurrencyDefaults", "ensureMultiplierDefaults", "ensureStorageDefaults", "getActiveSlot", "getCurrency", "getCurrencyMultiplierBN", "getHasOpenedSaveSlot", "getLastSaveTime", "getLastSaveTimeKey", "getSlotModifiedFlagKey", "getSlotSignature", "getSlotSignatureKey", "hasModifiedSave", "isCurrencyLocked", "isStorageKeyLocked", "markSaveSlotModified", "notifyGameSessionStarted", "onCurrencyChange", "peekCurrency", "primeStorageWatcherSnapshot", "setActiveSlot", "setCurrency", "setCurrencyMultiplierBN", "setHasOpenedSaveSlot", "setSlotSignature", "updateLastSaveTime", "watchStorageKey", "normalizeSlotValue", "slot", "n", "slotSignatureKey", "normalized", "SLOT_SIGNATURE_PREFIX", "slotModifiedKey", "SLOT_MODIFIED_PREFIX", "notifyCurrencySubscribers", "detail", "currencyChangeSubscribers", "entry", "handler", "key", "ensureStorageWatcherTimer", "storageWatcherTimer", "storageWatchers", "runStorageWatchers", "STORAGE_WATCH_INTERVAL_MS", "stopStorageWatcherTimerIfIdle", "parseWith", "raw", "valuesEqual", "a", "b", "entries", "parsed", "rawChanged", "valueChanged", "previousValue", "previousRaw", "parse", "equals", "onChange", "emitCurrentValue", "set", "rawValue", "bigNumEquals", "BigNum", "parseBigNumOrZero", "cleanupCurrencyWatchers", "currencyWatcherCleanup", "stop", "bindCurrencyWatchersForSlot", "currencyWatcherBoundSlot", "currencyKey", "storageKey", "value", "meta", "initCurrencyStorageWatchers", "hasEnteredGameSession", "PREFIX", "now", "val", "initHeartbeat", "lastSaveTimeTimer", "_activeSlotCache", "v", "keyFor", "base", "isDebugLocked", "signature", "k", "km", "getMultiplierScaled", "theor", "scaledFromIntBN", "setMultiplierScaled", "delta", "previous", "prev", "zero", "bn", "expectedRaw", "persistedRaw", "effectiveRaw", "effective", "changed", "providedDelta", "source", "bnDelta", "deltaBn", "intBN", "MULT_SCALE", "intFromScaled", "theorBN", "MULT_SCALE_TAG", "payload", "theoreticalBN", "existingRaw", "intBNValue", "sub", "makeCurrencyHandle", "fn", "x", "formatNumber", "amt", "next", "current", "factor", "pct", "amount", "mult", "baseAmount", "inc", "init_storage", "__esmMin", "init_bigNum", "init_numFormat", "_", "prop", "currency", "isDeleteMode", "deleteMode", "setDeleteMode", "on", "btn", "card", "removeAllKeysForSlot", "slot", "re", "toRemove", "i", "k", "initSlotsManager", "initialized", "manageBtn", "grid", "e", "onPointerDownCapture", "onClickCapture", "getActiveSlot", "KEYS", "refreshSlotsView", "init_slotsManager", "__esmMin", "init_storage", "init_slots", "slots_exports", "__export", "initSlots", "refreshSlotsView", "hasSlotData", "slot", "coinsTextFor", "bn", "peekCurrency", "formatNumber", "renderSlotCards", "btn", "idx", "titleEl", "text", "onSelect", "cards", "slotNum", "activate", "ev", "setActiveSlot", "ensureCurrencyDefaults", "ensureMultiplierDefaults", "setHasOpenedSaveSlot", "isDeleteMode", "init_slots", "__esmMin", "init_bigNum", "init_numFormat", "init_slotsManager", "init_storage", "audioCache_exports", "__export", "registerPreloadedAudio", "takePreloadedAudio", "src", "element", "key", "normalize", "cache", "el", "init_audioCache", "__esmMin", "syncXpMpHudLayout", "hud", "xpEl", "mpEl", "xpVisible", "mpVisible", "init_hudLayout", "__esmMin", "xpSystem_exports", "__export", "addExternalCoinMultiplierProvider", "addExternalXpGainMultiplierProvider", "addXp", "broadcastXpChange", "computeCoinMultiplierForXpLevel", "getXpGainMultiplier", "getXpLevelStorageKey", "getXpRequirementForXpLevel", "getXpState", "initXpSystem", "isXpSystemUnlocked", "onXpChange", "refreshCoinMultiplierFromXpLevel", "resetXpProgress", "setExternalBookRewardProvider", "setExternalCoinMultiplierProvider", "setExternalXpGainMultiplierProvider", "unlockXpSystem", "slot", "getActiveSlot", "resolvedSlot", "KEY_XP_LEVEL", "bigNumIsInfinite", "bn", "bigNumIsZero", "bigNumToFiniteNumber", "sci", "match", "mant", "exp", "num", "logBigNumToNumber", "maxLog10Bn", "computeBonusCountBn", "levelBn", "BigNum", "divided", "TEN_DIVISOR_DECIMAL", "floored", "bnOne", "computeLevelLogTerm", "LOG_STEP_DECIMAL", "bigNumPowerOf10", "logBn", "infinityRequirementBn", "integerPart", "fractionalPart", "fractionalNumber", "mantissa", "precision", "scaleFactor", "exponentAdjustment", "sig", "integerPartString", "totalExponent", "eBigInt", "e", "offset", "approximateCoinMultiplierFromBigNum", "totalLog", "approx", "levelTerm", "combined", "enforceXpInfinityInvariant", "levelIsInf", "xpState", "progIsInf", "inf", "requirementBn", "bank", "notifyXpSubscribers", "detail", "xpChangeSubscribers", "entry", "handler", "bnZero", "cloneBigNumSafe", "value", "bigNumEqualsSafe", "a", "b", "cleanupXpStorageWatchers", "xpStorageWatcherCleanups", "stop", "parseBigNumOrZero", "raw", "handleExternalXpStorageChange", "reason", "handlingExternalXpStorage", "xpStorageWatcherSlot", "prev", "ensureStateLoaded", "updateHud", "syncCoinMultiplierWithXpLevel", "current", "unlockedChanged", "levelChanged", "progressChanged", "xpLevelsGained", "xpAdded", "bindXpStorageWatchersForSlot", "watch", "key", "options", "watchStorageKey", "KEY_UNLOCK", "KEY_PROGRESS", "ensureXpStorageWatchers", "xpStorageWatchersInitialized", "stripHtml", "ensureExactRequirementCacheUpTo", "levelBigInt", "target", "EXACT_REQUIREMENT_CACHE_LEVEL", "highestCachedExactLevel", "currentLevel", "currentRequirement", "xpRequirementCache", "nextLevel", "nextRequirement", "approximateRequirementFromLevel", "baseLevel", "baseRequirement", "baseLevelBn", "baseLog", "approxLog10BigNum", "deltaLevel", "targetBonus", "baseBonus", "deltaBonus", "LOG_DECADE_BONUS_DECIMAL", "logNumber", "bigNumFromLog10", "progressRatio", "progressBn", "requirement", "reqIsInf", "logProg", "logReq", "diff", "ratio", "ensureHudRefs", "hudRefs", "xpRequirementForXpLevel", "xpLevelInput", "xpLvlBn", "levelPlain", "targetLevelInfo", "targetLevel", "targetKey", "cachedExact", "approximate", "updateXpRequirement", "resetLockedXpState", "isKeyLocked", "xpLevelBigIntInfo", "xpLevelValue", "plain", "force", "multApi", "levelInfo", "levelIsInfinite", "levelStorageKey", "lastSyncedCoinLevelWasInfinite", "lastSyncedCoinUsedApproximation", "lastSyncedCoinLevel", "lastSyncedCoinApproxKey", "multiplierBn", "EXACT_COIN_LEVEL_LIMIT", "working", "iterations", "i", "levelAdd", "finalMultiplier", "providers", "coinMultiplierProviders", "externalCoinMultiplierProvider", "provider", "maybe", "multIsInf", "lastSlot", "stateLoaded", "unlockedRaw", "persistState", "expected", "persisted", "unlocked", "level", "progress", "rawLevel", "rawProgress", "primeStorageWatcherSnapshot", "handleXpLevelUpRewards", "reward", "externalBookRewardProvider", "syncedLevelInfo", "container", "bar", "fill", "reqHtml", "formatNumber", "reqPlain", "syncXpMpHudLayout", "pct", "currentHtml", "currPlain", "forceReload", "keepUnlock", "wasUnlocked", "amount", "silent", "inc", "xpGainMultiplierProviders", "externalXpGainMultiplierProvider", "applyStatMultiplierOverride", "levelLocked", "progressIsInf", "gainIsInf", "currentProgressLog", "COMBINED_LOG_FACTOR", "reqLog", "logDiff", "estimatedGain", "safeGain", "jumpBn", "bulkReward", "guard", "limit", "syncedLevelAfterAdd", "detailOverrides", "xpLevel", "mult", "levelValue", "xpLevelBn", "fn", "KEY_PREFIX", "LOG_STEP", "LOG_DECADE_BONUS", "init_xpSystem", "__esmMin", "init_bigNum", "init_storage", "init_debugPanel", "init_numFormat", "init_hudLayout", "ghostTapGuard_exports", "__export", "DEFAULT_TIMEOUT_MS", "clearGhostTapTarget", "consumeGhostTapGuard", "initGlobalGhostTap", "installGhostTapGuard", "markGhostTapTarget", "setGhostTapSelector", "shouldSkipGhostTap", "suppressNextGhostTap", "nowMs", "getDocument", "findTapTarget", "node", "ElementCtor", "selector", "el", "ELEMENT_SKIP_PROP", "timeout", "globalTimeout", "now", "delay", "lastMarkedTarget", "gDelay", "target", "until", "GLOBAL_SKIP_PROP", "targetDelay", "current", "onPointerStart", "event", "lastTouchMs", "lastTouchStartMs", "lastTouchDurationMs", "onTouchStart", "onPointerEnd", "onTouchEnd", "onClickCapture", "sinceTouchStart", "longPressMs", "options", "guardInstalled", "doc", "hasPointerEvents", "hasTouchEvents", "TARGET_SELECTOR", "handleInstantClick", "buttonLike", "extraSelector", "DEFAULT_LONG_PRESS_MS", "init_ghostTapGuard", "__esmMin", "MERCHANT_DIALOGUES", "init_merchantDialogues", "__esmMin", "gameLoop_exports", "__export", "RateAccumulator", "pauseGameLoop", "registerFrame", "registerTick", "resumeGameLoop", "startGameLoop", "stopGameLoop", "loop", "timestamp", "now", "paused", "lastTime", "rafId", "dt", "accumulator", "ticksProcessed", "MAX_TICKS_PER_FRAME", "FIXED_STEP", "tickListeners", "listener", "e", "frameListeners", "lastRuntimeCheckReal", "lastRuntimeCheckPerf", "perfDelta", "RUNTIME_CHECK_INTERVAL_MS", "realNow", "realDelta", "markSaveSlotModified", "callback", "TICK_RATE", "init_gameLoop", "__esmMin", "init_storage", "currencyKey", "bankRef", "amountPerSecond", "perTick", "whole", "AUTOMATION_AREA_KEY", "EFFECTIVE_AUTO_COLLECT_ID", "AUTOBUY_COIN_UPGRADES_ID", "AUTOBUY_BOOK_UPGRADES_ID", "AUTOBUY_GOLD_UPGRADES_ID", "AUTOBUY_MAGIC_UPGRADES_ID", "AUTOBUY_WORKSHOP_LEVELS_ID", "AUTOBUY_DNA_UPGRADES_ID", "MASTER_AUTOBUY_IDS", "MYSTERIOUS_ICON", "LOCKED_ICON", "HIDDEN_TITLE", "LOCKED_TITLE", "UPGRADE_DEFINITIONS", "REGISTRY", "init_automationUpgrades", "__esmMin", "init_bigNum", "level", "lvl", "base", "pow", "BigNum", "ctx", "sl", "isUnlocked", "revealText", "u", "addExternalSpawnRateMultiplierProvider", "provider", "externalSpawnRateProviders", "invalidateEffectsCache", "_cachedUpgradeMultipliers", "triggerUpgradesChanged", "listeners", "cb", "refreshCoinMultiplierFromXpLevel", "onUpgradesChanged", "x", "bookValueMultiplierBn", "level", "L", "ensureLevelBigNum", "plain", "lvl", "bigNumFromLog10", "BigNum", "safeIsXpUnlocked", "isXpSystemUnlocked", "syncBookCurrencyMultiplierFromUpgrade", "levelOverride", "multHandle", "bank", "resolvedLevel", "storedLevel", "getLevelNumber", "AREA_KEYS", "UPGRADE_TIES", "multiplier", "calculateUpgradeMultipliers", "areaKey", "upgrades", "getUpgradesForArea", "additionalUpgrades", "dnaUpgrades", "allUpgrades", "acc", "upg", "effectiveArea", "lvlBn", "getLevel", "lvlNum", "levelBigNumToNumber", "baseEffect", "selfMult", "xpMult", "coinMult", "mpMult", "computeHmMultipliers", "safeMultiplyBigNum", "val", "computeUpgradeEffects", "mults", "BASE_CPS", "syncCurrencyMultipliersFromUpgrades", "goldValue", "magicValue", "waveValue", "surgeMult", "getSurgeMagicMultiplier", "finalMagicValue", "getMpValueMultiplierBn", "mpValue", "getMagnetLevel", "magnetRadius", "registerXpUpgradeEffects", "initResetSystem", "addExternalCoinMultiplierProvider", "baseMultiplier", "xpUnlocked", "result", "coinValue", "addExternalXpGainMultiplierProvider", "baseGain", "gain", "xpValue", "addExternalMutationGainMultiplierProvider", "mutationUnlocked", "init_upgradeEffects", "__esmMin", "init_bigNum", "init_storage", "init_resetTab", "init_xpSystem", "init_mutationSystem", "init_upgrades", "init_surgeEffects", "labTab_exports", "__export", "getLabCost", "getLabLevel", "getLabLevelFromCoins", "getLabLevelKey", "getRpMult", "getRpMultBase", "hasVisitedLab", "initLabLogic", "initLabTab", "setLabLevel", "setLabVisited", "updateLabLevel", "updateLabTab", "reloadLabCache", "slot", "getActiveSlot", "_cachedSlot", "_cachedLabLevel", "BigNum", "_cachedLabVisited", "raw", "LAB_LEVEL_KEY", "LAB_VISITED_KEY", "value", "normalized", "bank", "valBn", "level", "lvl", "exponent", "lvlStr", "totalExponent", "e", "coins", "exponentBn", "eVal", "sigNum", "logSig", "logSigInt", "levelBase", "val", "currentLevel", "targetLevel", "registerTick", "tickResearch", "initLabMultipliers", "bigNumIsInfinite", "bn", "bigNumToFiniteNumber", "sci", "match", "mant", "exp", "num", "bigNumPowerOf10", "logBn", "maxLog10Bn", "infinityRequirementBn", "integerPart", "fractionalPart", "fractionalNumber", "mantissa", "precision", "scaleFactor", "exponentAdjustment", "sig", "integerPartString", "eBigInt", "offset", "isSurgeActive", "effectiveNerf", "getEffectiveTsunamiNerf", "multLog10", "base", "log10Base", "applyStatMultiplierOverride", "panel", "labSystem", "LabSystem", "CAM_MAX_COORD", "CAM_MAX_ZOOM", "CAM_MIN_ZOOM", "NODE_IMG_SIZE", "init_labTab", "__esmMin", "init_storage", "init_main", "init_bigNum", "init_numFormat", "init_surgeEffects", "init_gameLoop", "init_debugPanel", "init_labNodes", "init_shopOverlay", "init_upgrades", "container", "applyTextStyle", "el", "fontSize", "strokeWidth", "applyBarStyle", "formatNumber", "lines", "IS_MOBILE", "helpHtml", "label", "entries", "target", "type", "handler", "opts", "b", "rect", "dpr", "now", "dt", "tooFar", "badZoom", "cost", "baseNerf", "getTsunamiNerf", "bonus", "getTsunamiResearchBonus", "i", "p", "speed", "dx", "dy", "len", "node", "ctx", "w", "h", "z", "baseGridSize", "logZoom", "k", "idealWorldUnit", "power", "unit", "drawGrid", "gridUnit", "opacity", "startX", "endX", "x", "sx", "startY", "endY", "y", "sy", "screenUnit", "alpha", "axisY", "axisX", "visibleNodes", "nodePositions", "RESEARCH_NODES", "isResearchNodeVisible", "parentId", "parent", "n", "start", "end", "ex", "ey", "imgSize", "imgScreenSize", "baseScreenSize", "pos", "cx", "cy", "nodeLevel", "getResearchNodeLevel", "isMaxed", "hasBar", "isResearchNodeActive", "img", "req", "getResearchNodeRequirement", "progress", "rp", "getResearchNodeRp", "ratioSci", "barWidth", "barHeight", "barX", "barY", "grad", "text", "metrics", "textY", "MAX_RADIUS", "ringConfigs", "r", "rt", "prog", "ease", "rad", "visibilityBoost", "pAlpha", "px", "py", "particles", "angle", "mx", "my", "wx", "wy", "clickRadius", "id", "sheet", "grabber", "header", "title", "content", "desc", "info", "actions", "active", "setResearchNodeActive", "closeBtn", "setupDragToClose", "statusText", "line", "rpFmt", "reqFmt", "hovering", "delta", "oldZoom", "newZoom", "mouseWorldX", "mouseWorldY", "touches", "dist", "scale", "center", "worldX", "worldY", "automationEffects_exports", "__export", "addExternalEacAmountMultiplierProvider", "addExternalEacMultiplierProvider", "getAutobuyerToggle", "getEacAmountMultiplier", "initAutomationEffects", "setAutobuyerToggle", "setTsunamiBonusProvider", "updateAutomation", "fn", "tsunamiBonusProvider", "provider", "externalEacProviders", "externalEacAmountProviders", "mult", "isSurgeActive", "nerf", "getTsunamiNerf", "bonus", "effective", "val", "ensureCacheSlot", "slot", "cacheSlot", "autobuyerCache", "area", "id", "getActiveSlot", "slotSuffix", "key", "stored", "value", "valStr", "onTick", "dt", "updateAutobuyers", "getGroupedUpgrades", "_groupedUpgradesCache", "upgrades", "getUpgradesForArea", "AREA_KEYS", "groups", "upg", "type", "processAutobuyGroup", "currentLevel", "getLevelNumber", "cap", "performFreeAutobuy", "idStr", "currencyKey", "MASTER_AUTOBUY_IDS", "AUTOMATION_AREA_KEY", "AUTOBUY_WORKSHOP_LEVELS_ID", "workshopTicker", "performFreeGenerationUpgrade", "rate", "EFFECTIVE_AUTO_COLLECT_ID", "accumulator", "interval", "ticks", "collectCount", "triggerPassiveCollect", "registerTick", "newSlot", "init_automationEffects", "__esmMin", "init_gameLoop", "init_upgrades", "init_coinPickup", "init_automationUpgrades", "init_workshopTab", "init_storage", "init_surgeEffects", "reloadExperimentCache", "slot", "getActiveSlot", "_cachedSlot", "_cachedExperimentCompleted", "EXPERIMENT_COMPLETED_KEY", "ensureNodeState", "id", "labState", "BigNum", "loadNodeState", "s", "lvl", "NODE_LEVEL_KEY", "rp", "NODE_RP_KEY", "act", "NODE_ACTIVE_KEY", "disc", "NODE_DISCOVERED_KEY", "reloadLabNodes", "activeNodeId", "RESEARCH_NODES", "n", "saveLabNodes", "getResearchNodeLevel", "setResearchNodeLevel", "level", "isStorageKeyLocked", "getResearchNodeRp", "setResearchNodeRp", "isResearchNodeActive", "setResearchNodeActive", "active", "shouldBeActive", "setResearchNodeDiscovered", "discovered", "isResearchNodeVisible", "node", "NODE_MAP", "parentId", "parent", "getResearchNodeRequirement", "scaleBn", "log10Scale", "approxLog10BigNum", "baseBn", "totalLog10", "bigNumFromLog10", "getTsunamiResearchBonus", "bonus", "level1", "level10", "isExperimentUnlocked", "resetLab", "exceptions", "setLabLevel", "tickResearch", "dt", "mult", "getRpMult", "rpPerTick", "currentRp", "nextRp", "currentLevel", "currentReq", "logRp", "logReq", "jump", "cost", "scaleMinus1", "isLinear", "jumpStr", "rem", "logS", "logSMinus1", "numerator", "approxLevels", "safeJump", "totalLog", "costFactor", "newLevel", "oldLevel", "nextLevel", "getLabCoinMultiplier", "LOG10_2", "getLabXpMultiplier", "getLabGoldMultiplier", "LOG10_3", "getLabMagicMultiplier", "getLabWaveMultiplier", "LOG10_1_1", "getLabSpawnRateBonus", "getLabEacBonus", "initLabMultipliers", "addExternalCoinMultiplierProvider", "baseMultiplier", "labMult", "addExternalXpGainMultiplierProvider", "baseGain", "addExternalSpawnRateMultiplierProvider", "addExternalEacAmountMultiplierProvider", "setTsunamiBonusProvider", "detail", "refreshCoinMultiplierFromXpLevel", "triggerUpgradesChanged", "init_labNodes", "__esmMin", "init_bigNum", "init_storage", "init_labTab", "init_numFormat", "init_xpSystem", "init_upgradeEffects", "init_automationEffects", "formatMultForUi", "resetState", "activeComboValue", "decayCounter", "decayAccumulator", "lastGrowthTime", "onCoinCollected", "isSurge14ActiveFn", "now", "maxVal", "getMaxComboFn", "COMBO_INCREMENT_AMOUNT", "updateCombo", "dt", "DECAY_WINDOW_SEC", "getComboRestorationFactor", "val", "decayFactor", "initComboSystem", "checkFn", "maxComboFn", "init_comboSystem", "__esmMin", "init_storage", "surgeEffects_exports", "__export", "getBookProductionRate", "getComboUiString", "getEffectiveTsunamiNerf", "getEffectiveTsunamiNerfWithCombo", "getSurge15Divisor", "getSurge15Multiplier", "getSurge6WealthMultipliers", "getSurgeMagicMultiplier", "getTsunamiNerf", "getTsunamiNerfKey", "getTsunamiSequenceSeen", "initSurgeEffects", "isSurgeActive", "setTsunamiNerf", "setTsunamiSequenceSeen", "slot", "TSUNAMI_NERF_KEY", "getActiveSlot", "TSUNAMI_SEEN_KEY", "value", "normalized", "tsunamiNerfExponent", "effective", "getTsunamiResearchBonus", "added", "getComboRestorationFactor", "str", "formatMultForUi", "finalStr", "baseEffective", "gap", "val", "key", "isStorageKeyLocked", "updateMultiplier", "n", "cachedSurgeLevel", "applyTsunamiNerf", "bn", "log10", "approxLog10BigNum", "bigNumFromLog10", "level", "getCurrentSurgeLevel", "isReached", "MULTIPLIER", "currentMultiplier", "BigNum", "preview", "dna", "bank", "mult", "amount", "log10Bn", "power", "log10Result", "div", "calc", "residue", "finalLog10", "total", "c", "bookVal", "bookResidue", "b", "g", "m", "cOut", "bOut", "gOut", "mOut", "xpLevelBn", "getXpState", "baseRate", "logValBn", "LOG10_EXP_0_2", "logValNum", "logVal", "onTick", "dt", "updateCombo", "bookRateAccumulator", "RateAccumulator", "perTick", "rateNum", "whole", "log10Rate", "rateMultiplier", "coins", "xpState", "basePending", "computeForgeGoldFromInputs", "pending", "labMult", "getLabGoldMultiplier", "amountToAdd", "cumulativeMp", "getTotalCumulativeMp", "computeInfuseMagicFromInputs", "loadTsunamiNerf", "stored", "compareSurgeLevels", "prev", "curr", "isInfPrev", "isInfCurr", "p", "initComboSystem", "prevLevel", "wasActive", "currLevel", "isActive", "e", "refreshCoinMultiplierFromXpLevel", "syncCurrencyMultipliersFromUpgrades", "addExternalCoinMultiplierProvider", "baseMultiplier", "addExternalXpGainMultiplierProvider", "baseGain", "addExternalMutationGainMultiplierProvider", "wealth", "result", "log10Total", "setExternalBookRewardProvider", "baseReward", "registerTick", "init_surgeEffects", "__esmMin", "init_bigNum", "init_storage", "init_xpSystem", "init_upgradeEffects", "init_mutationSystem", "init_resetTab", "init_gameLoop", "init_labNodes", "init_comboSystem", "init_numFormat", "workshopTab_exports", "__export", "getGearsProductionRate", "getGenerationLevelKey", "getGenerationUpgradeCost", "initWorkshopSystem", "initWorkshopTab", "performFreeGenerationUpgrade", "updateWorkshopTab", "integralLogLin", "x", "k", "term", "INV_LN10", "slot", "loadGenerationLevel", "getActiveSlot", "BigNum", "raw", "saveGenerationLevel", "level", "key", "valStr", "readBack", "calculateWorkshopCostLog", "lvlNum", "str", "GENERATION_UPGRADE_BASE_COST_LOG", "L1", "BASE_MULT_LOG", "CACHE_S1_END_LOG", "u", "L2", "K_LIN", "CACHE_S2_END_LOG", "u2", "v", "u_at_L", "u_at_L2", "s2_continuation", "C3", "LOG_EXP_BASE_S3", "EXP_DIV_S3", "s3_extra", "L3", "CACHE_S3_END_LOG", "v3", "u3", "s2_cont_3", "s3_extra_3", "scalingExp", "EXPLOSION_RATE", "result", "bnLevel", "logCost", "bigNumFromLog10", "getGearsPerSecond", "baseRate", "logBase", "isSurgeActive", "LOG10_4", "LOG10_3", "LOG10_2", "logValue", "logVal", "logExpBn", "logExpVal", "mult", "bank", "buyGenerationUpgrade", "cost", "currentGenerationLevel", "nextLevel", "playPurchaseSfx", "onTick", "hasDoneInfuseReset", "whole", "perTickNum", "wholeNum", "frac", "accumulatorBuffer", "accWhole", "resetWorkshopState", "syncGearDecorations", "container", "entry", "animatedGears", "canvas", "rect", "dpr", "targetWidth", "targetHeight", "MAX_GEAR_DECORATIONS", "targetCount", "gears", "size", "y", "angle", "dx", "GEAR_SPEED", "dy", "rotation", "rotationSpeed", "GEAR_ROTATION_SPEED_BASE", "GEAR_ROTATION_VARIANCE", "buildWorkshopUI", "descText", "IS_MOBILE", "GEAR_HUD_ICON_SRC", "GEAR_ICON_SRC", "COIN_ICON_SRC", "leftCol", "rightCol", "upgradeBtn", "e", "buyMaxGenerationUpgrade", "automationBtn", "openShop", "syncLayout", "statsBtn", "workshopEl", "left", "right", "updateBounds", "col", "g", "ro", "hud", "entries", "startRenderLoop", "stopRenderLoop", "verbEl", "verb", "gearsAmountEl", "gearsRateEl", "upgradeCostEl", "rateBn", "formatNumber", "label", "canAfford", "autoLevel", "getLevelNumber", "AUTOMATION_AREA_KEY", "AUTOBUY_WORKSHOP_LEVELS_ID", "isAutomated", "slotSuffix", "currentIntStr", "lastSyncedLevel", "renderFrameId", "lastRenderTime", "loop", "timestamp", "isAnyMenuScrolling", "dt", "data", "width", "height", "ctx", "gearImage", "cx", "cy", "initialized", "registerTick", "CURRENCIES", "panelEl", "coinsInf", "costInf", "coinsLog", "approxLog10BigNum", "low", "high", "best", "mid", "targetLevelVal", "targetLevel", "currentVal", "startL", "totalCost", "l", "topCost", "LN10", "init_workshopTab", "__esmMin", "init_bigNum", "init_numFormat", "init_storage", "init_gameLoop", "init_shopOverlay", "init_resetTab", "init_upgrades", "init_main", "init_automationUpgrades", "init_surgeEffects", "offlinePanel_exports", "__export", "calculateOfflineRewards", "calculatePreAutomationRewards", "formatTimeCompact", "grantOfflineRewards", "initOfflineTracker", "processOfflineProgress", "showOfflinePanel", "ms", "msBn", "BigNum", "ONE_DAY", "ONE_YEAR", "bnYear", "years", "yearsInMs", "remainingMs", "days", "daysBn", "formatNumber", "s_val", "s", "m", "rs", "h", "rm", "d", "rh", "rewards", "offlineMs", "isPreAutomation", "existing", "overlay", "panel", "header", "subHeader", "contentWrapper", "note", "scrollContainer", "list", "PRIORITY_ORDER", "config", "key", "val", "item", "row", "plus", "icon", "text", "levelCount", "label", "isOne", "displayName", "actions", "closeBtn", "closePanel", "e", "ensureCustomScrollbar", "getSimulatedReq", "node", "level", "log10Scale", "totalLog10", "intPart", "fracPart", "mantissa", "seconds", "slot", "getActiveSlot", "secondsBn", "rpMult", "getRpMult", "totalRp", "activeNodes", "RESEARCH_NODES", "n", "isResearchNodeActive", "researchLevels", "researchProgress", "tempLevel", "getResearchNodeLevel", "tempRp", "getResearchNodeRp", "levelsGained", "maxLevel", "req", "gearsEarned", "getGearsProductionRate", "isCurrencyLocked", "bookRate", "getBookProductionRate", "booksEarned", "isSurgeActive", "log10Rate", "getEffectiveTsunamiNerf", "totalMultiplier", "bigNumFromLog10", "coins", "bank", "xpState", "getXpState", "basePending", "computeForgeGoldFromInputs", "pending", "labMult", "getLabGoldMultiplier", "goldEarned", "cumulativeMp", "getTotalCumulativeMp", "magicEarned", "computeInfuseMagicFromInputs", "autoLevel", "getLevelNumber", "AUTOMATION_AREA_KEY", "EFFECTIVE_AUTO_COLLECT_ID", "multiplier", "totalPassives", "singleReward", "getPassiveCoinReward", "coinsEarned", "xpEarned", "mpEarned", "isStorageKeyLocked", "xpResult", "addXp", "mpResult", "addMutationPower", "idStr", "data", "nodeId", "setResearchNodeLevel", "setResearchNodeRp", "areaKey", "getCurrentAreaKey", "spawnRate", "eff", "computeUpgradeEffects", "applyStatMultiplierOverride", "override", "totalCoins", "lastSave", "getLastSaveTime", "now", "markSaveSlotModified", "diff", "hasDoneInfuseReset", "hasRewards", "checkActiveState", "onReward", "initialized", "pauseGameLoop", "resumeGameLoop", "init_offlinePanel", "__esmMin", "init_storage", "init_workshopTab", "init_resetTab", "init_gameLoop", "init_bigNum", "init_numFormat", "init_shopOverlay", "init_main", "init_upgrades", "init_labTab", "init_labNodes", "init_automationUpgrades", "init_coinPickup", "init_xpSystem", "init_mutationSystem", "init_surgeEffects", "init_debugPanel", "getWarpState", "slot", "charges", "lastCharge", "c", "WARP_CHARGES_KEY", "l", "WARP_LAST_CHARGE_KEY", "saveWarpState", "checkWarpRecharge", "getActiveSlot", "MAX_WARPS", "now", "elapsed", "CHARGE_TIME_MS", "gained", "warpTabPanel", "updateWarpTab", "triggerWarpVisuals", "overlay", "performWarp", "updateTimer", "playAudio", "WARP_SFX_SRC", "rewards", "calculateOfflineRewards", "WARP_DURATION_SEC", "grantOfflineRewards", "showOfflinePanel", "skipRechargeCheck", "counterEl", "timerEl", "nextCharge", "diff", "formatTimeCompact", "btn", "initWarpTab", "panel", "init_warpTab", "__esmMin", "init_storage", "init_offlinePanel", "init_audioManager", "hasMetMerchant", "sk", "MERCHANT_MET_KEY_BASE", "isJeffUnlocked", "JEFF_UNLOCK_KEY_BASE", "setJeffUnlocked", "value", "slot", "getActiveSlot", "key", "normalized", "updateMerchantNameInUI", "getMerchantName", "name", "merchantOverlayEl", "modalName", "bindRapidActivation", "target", "handler", "once", "used", "pointerTriggered", "activePointerId", "run", "event", "shouldSkipGhostTap", "e", "cleanup", "resetPointerTrigger", "onClick", "onPointerDown", "suppressNextGhostTap", "onPointerUp", "onPointerCancel", "onTouchStart", "onTouchEnd", "onTouchCancel", "HAS_POINTER_EVENTS", "HAS_TOUCH_EVENTS", "dialogueStatusRank", "status", "DIALOGUE_STATUS_ORDER", "snapshotLockDisplay", "info", "buildUnlockedDialogueInfo", "meta", "setMerchantTabUnlocked", "unlocked", "def", "MERCHANT_TABS_DEF", "t", "lockedLabel", "merchantTabUnlockState", "btn", "merchantTabs", "selectMerchantTab", "syncForgeTabUnlockState", "isForgeUnlocked", "syncWorkshopTabUnlockState", "hasDoneInfuseReset", "syncWarpTabUnlockState", "hasDoneSurgeReset", "isLabUnlocked", "getTsunamiSequenceSeen", "LAB_UNLOCK_KEY", "syncLabTabUnlockState", "bigNumToSafeInteger", "plain", "parsed", "str", "numeric", "getPlayerProgress", "progress", "isXpSystemUnlocked", "state", "getXpState", "hasDoneForgeReset", "resolveDialogueLock", "rawState", "rawObj", "DEFAULT_MYSTERIOUS_BLURB", "DEFAULT_LOCKED_BLURB", "DEFAULT_LOCK_MESSAGE", "MYSTERIOUS_ICON_SRC", "HIDDEN_DIALOGUE_TITLE", "LOCKED_DIALOGUE_TITLE", "ensureProgressEvents", "progressEventsBound", "onProgressChanged", "detailSlot", "FORGE_COMPLETED_KEY_BASE", "watchStorageKey", "renderDialogueList", "completeDialogueOnce", "id", "loadDlgState", "k", "prev", "saveDlgState", "grantReward", "reward", "bank", "rewardLabel", "MERCHANT_DLG_STATE_KEY_BASE", "s", "payload", "primeStorageWatcherSnapshot", "parseDlgStateRaw", "raw", "cleanupMerchantDlgStateWatcher", "stop", "merchantDlgWatcherCleanup", "handleMerchantDlgStateChange", "_", "bindMerchantDlgStateWatcherForSlot", "merchantDlgWatcherSlot", "storageKey", "ensureMerchantDlgStateWatcher", "merchantDlgWatcherInitialized", "primeTypingSfx", "loadAudio", "TYPING_SFX_SRC", "startTypingSfx", "activeTypingAudio", "playAudio", "IS_MOBILE", "stopTypingSfx", "typeText", "el", "full", "msPerChar", "skipTargets", "resolve", "segments", "currentText", "inTag", "i", "char", "segIndex", "charIndex", "skipping", "armed", "buffer", "__isTypingActive", "skip", "onKey", "targets", "tick", "seg", "openDialogueLockInfo", "lockInfo", "overlay", "cardEl", "nameEl", "messageEl", "closeBtn", "closed", "close", "onEsc", "blockInteraction", "doCloseFromBtn", "openDialogueModal", "scriptId", "hasVisitedLab", "setMusicUnderwater", "MERCHANT_ICON_SRC", "onEscToCancel", "cancelWithoutReward", "textEl", "rowEl", "choicesEl", "ended", "closeModal", "engine", "DialogueEngine", "nodeId", "opt", "claimed", "script", "MERCHANT_DIALOGUES", "injectScrollTimelineStyles", "SCROLL_TIMELINE_STYLES_ID", "style", "ensureMerchantScrollbar", "scroller", "merchantSheetEl", "bar", "thumb", "isTouch", "FADE_SCROLL_MS", "FADE_DRAG_MS", "supportsScrollEnd", "fadeTimer", "useCssTimeline", "timelineName", "lastShadow", "syncScrollShadow", "hasShadow", "updateBounds", "grabber", "header", "actions", "top", "bottom", "lastState", "updateThumb", "scrollHeight", "clientHeight", "scrollTop", "barH", "visibleRatio", "thumbH", "maxScroll", "range", "y", "updateAll", "showBar", "scheduleHide", "delay", "onScroll", "onScrollEnd", "ro", "dragging", "dragStartY", "startScrollTop", "startDrag", "onDragMove", "thH", "scrollMax", "scrollDelta", "endDrag", "rect", "clickY", "targetY", "ensureMerchantOverlay", "content", "tabs", "panelsWrap", "panelDialogue", "panelReset", "panelWorkshop", "panelWarp", "panelLab", "stored", "initResetSystem", "initResetPanel", "updateResetPanel", "initWorkshopTab", "initWarpTab", "initLabTab", "forgeUnlockListenerBound", "handleUnlockChange", "merchantCloseBtn", "firstChat", "initDialogueTab", "merchantEventsBound", "closeMerchant", "onKeydownForMerchant", "onMerchantDragStart", "panel", "list", "handleDialogueCardClick", "card", "ctx", "stateDirty", "seenIds", "DLG_CATALOG", "entryState", "storedStatus", "storedRank", "rank", "snapshot", "isMysterious", "locked", "showComplete", "titleEl", "blurbEl", "rewardEl", "titleText", "blurbText", "iconSrc", "REWARD_ICON_SRC", "amtEl", "amtText", "typeStr", "capText", "rewardLabelText", "text", "ariaLabel", "hint", "againEl", "child", "runFirstMeet", "fc", "MERCHANT_MET_EVENT", "resetFirstChatOverlayState", "openMerchant", "merchantOpen", "activeEl", "merchantLastFocus", "forcedDialogueTab", "pendingKey", "met", "last", "MERCHANT_TAB_KEY_BASE", "num", "requestedIndex", "maxUnlockedIndex", "targetIndex", "closeDelveSpecificOverlays", "clientY", "merchantDrag", "onMerchantDragMove", "onMerchantDragEnd", "onMerchantDragCancel", "dy", "cleanupMerchantDrag", "dt", "updateWarpTab", "runLabIntroDialogue", "updateLabTab", "isViewingLabTab", "unlockMerchantTabs", "keys", "runTsunamiDialogue", "container", "onComplete", "tsunamiControls", "scriptPart1", "blockEsc", "runPart2", "runFinalLine", "textEl2", "choicesEl2", "rowEl2", "cardEl2", "finalScript", "engine2", "runPostTsunamiShopDialogue", "init_dlgTab", "__esmMin", "init_storage", "init_bigNum", "init_merchantDialogues", "init_xpSystem", "init_resetTab", "init_workshopTab", "init_warpTab", "init_labTab", "init_surgeEffects", "init_shopOverlay", "init_ghostTapGuard", "init_main", "init_audioManager", "base", "surgeLevel", "getCurrentSurgeLevel", "isSurge8", "onEnd", "onChoice", "node", "nextNode", "options", "prepare", "unbind", "DNA_AREA_KEY", "MYSTERIOUS_ICON", "HIDDEN_TITLE", "REGISTRY", "init_dnaUpgrades", "__esmMin", "init_numFormat", "level", "total", "formatMultForUi", "ctx", "sl", "isUnlocked", "revealText", "isAnyMenuScrolling", "scrollingElements", "isUpgradeAutomated", "upgDef", "autoId", "COST_TYPE_TO_AUTO_ID", "getLevelNumber", "AUTOMATION_AREA_KEY", "getAutobuyerToggle", "resolveUpgradeId", "upgLike", "rawId", "parsed", "isForgeUnlockUpgrade", "mode", "FORGE_UNLOCK_UPGRADE_ID", "getShopUiData", "areaKey", "defs", "getUpgradesForArea", "upgrades", "def", "lvlBn", "getLevel", "lvlNum", "lockState", "getUpgradeLockState", "icon", "getIconUrl", "title", "desc", "locked", "hmReady", "upgradeUiModel", "normalizeUpgradeIconPath", "getAdapter", "SHOP_ADAPTERS", "blockInteraction", "ms", "IS_MOBILE", "shield", "eat", "e", "ev", "stripTags", "html", "getCurrencyLabel", "type", "amountBn", "isOne", "bn", "BigNum", "playPurchaseSfx", "playAudio", "PURCHASE_SFX_SRC", "MOBILE_PURCHASE_VOLUME", "DESKTOP_PURCHASE_VOLUME", "playEvolveSfx", "vol", "EVOLVE_SFX_SRC", "currencyIconHTML", "CURRENCY_ICON_SRC", "injectScrollTimelineStyles", "SCROLL_TIMELINE_STYLES_ID", "style", "ensureCustomScrollbar", "overlayEl", "sheetEl", "scrollerSelector", "options", "orientation", "isVertical", "scroller", "bar", "thumb", "isTouch", "FADE_SCROLL_MS", "FADE_DRAG_MS", "supportsScrollEnd", "useCssTimeline", "timelineName", "cachedMetrics", "lastShadow", "isScrollTickPending", "scrollTimeout", "updateBounds", "scrollerRect", "sheetRect", "top", "bottom", "left", "right", "updateMetrics", "scrollSize", "clientSize", "barSize", "visibleRatio", "thumbSize", "maxScroll", "range", "hasOverflow", "performScrollUpdate", "scrollPos", "hasShadow", "pos", "showBar", "updateAll", "debounceTimer", "debouncedUpdateAll", "scheduleHide", "delay", "onScroll", "onScrollEnd", "dragging", "dragStartPos", "startScrollPos", "startDrag", "onDragMove", "delta", "newPos", "endDrag", "rect", "clickPos", "newScroll", "levelsRemainingToCap", "upg", "currentLevelBn", "currentLevelNumber", "capBn", "fallback", "capPlain", "lvlPlain", "capNumber", "lvlNumber", "room", "computeAffordableLevels", "currentLevelNumeric", "lvl", "cap", "walletValue", "bank", "walletBn", "isHmType", "maxed", "c0", "c1", "farProbeLevel", "cFar", "remainingBn", "lo", "hi", "mid", "midBn", "count", "evaluateBulkPurchase", "openShop", "shops", "closeShop", "force", "s", "closeDelveSpecificOverlays", "key", "shop", "upgOpen", "currentUpgradeMode", "closeUpgradeMenu", "existing", "updateShopOverlay", "ensureUpgradeOverlay", "upgOverlayEl", "upgSheetEl", "grab", "header", "content", "milestones", "actions", "drag", "onDragStart", "y", "onDragEnd", "dy", "shouldClose", "upgOverlayCleanup", "fn", "openHmMilestoneDialog", "lines", "overlay", "dialog", "list", "line", "li", "text", "closeBtn", "close", "onKeydown", "event", "openUpgradeOverlay", "upgOpenLocal", "adapter", "initialLockState", "initialLocked", "initialMysterious", "isHM", "isEndlessXp", "UPGRADE_TIES", "ensureChild", "parent", "className", "tagName", "targetClasses", "c", "el", "extras", "i", "child", "cls", "makeLine", "d", "initialRender", "rerender", "model", "isHiddenUpgrade", "isUnlockVisible", "evolveReady", "capReached", "level", "capHtml", "formatNumber", "levelHtml", "levelPlain", "autoToggleWrapper", "masterCostType", "MASTER_AUTOBUY_IDS", "isWorkshopMaster", "AUTOBUY_WORKSHOP_LEVELS_ID", "isAutomationMaster", "standardAutobuyId", "COST_TYPE_TO_AUTOBUY_ID", "autobuyLevel", "showAutoToggle", "toggleBtn", "activeSlot", "getActiveSlot", "slotSuffix", "isEnabled", "AREA_KEYS", "DNA_AREA_KEY", "anyEnabled", "u", "childKey", "val", "setAutobuyerToggle", "baseDesc", "info", "cursor", "placeAfterCursor", "descText", "reasonText", "wrap", "children", "iconHTML", "nextPriceBn", "stopBuying", "costs", "costLabel", "costHtml", "lineCost", "lineMilestone", "milestoneCost", "milestoneLabel", "isAutomated", "targetLevelBn", "targetLevelNum", "costAt", "deltaBn", "deltaPlain", "deltaNum", "spent", "milestoneHtml", "haveLabel", "haveHtml", "lineHave", "milestonesContainer", "milestonesRow", "btn", "milestoneBtn", "evolutions", "evolutionOffset", "HM_EVOLUTION_INTERVAL", "a", "b", "m", "milestoneLevelBn", "levelText", "mult", "formatMultForUi", "target", "achieved", "canAffordNext", "ensureButton", "onClick", "index", "disabled", "invoke", "siblings", "evolved", "bought", "unlockMerchantTabs", "fresh", "stale", "staleCheap", "isExcluded", "buyFn", "diffPlain", "walletRaw", "reachable", "plain", "purchase", "onUpdate", "evt", "setupDragToClose", "grabberEl", "isOpenFn", "performCloseFn", "clientY", "cleanupDrag", "dt", "suppressNextGhostTap", "onDragCancel", "BASE_ICON_SRC_BY_COST", "LOCKED_BASE_ICON_SRC", "MAXED_BASE_OVERLAY_SRC", "AUTOMATED_OVERLAY_SRC", "TRANSPARENT_PX", "ShopInstance", "init_shopOverlay", "__esmMin", "init_storage", "init_bigNum", "init_numFormat", "init_main", "init_dlgTab", "init_audioCache", "init_audioManager", "init_upgrades", "init_ghostTapGuard", "init_automationUpgrades", "init_automationEffects", "init_dnaUpgrades", "AUTOBUY_COIN_UPGRADES_ID", "AUTOBUY_BOOK_UPGRADES_ID", "AUTOBUY_GOLD_UPGRADES_ID", "AUTOBUY_MAGIC_UPGRADES_ID", "AUTOBUY_DNA_UPGRADES_ID", "getCurrentAreaKey", "id", "buyOne", "buyMax", "buyCheap", "amount", "buyTowards", "evolveUpgrade", "MERCHANT_MET_EVENT", "targetSlot", "shouldGlow", "hasMetMerchant", "slot", "grid", "seenIds", "tile", "baseImg", "iconImg", "shouldSkipGhostTap", "isExcludedCheap", "lockIcon", "hasMysteriousIcon", "isMysterious", "isPlainLocked", "canPlusBn", "plusBn", "plusHtml", "plusPlain", "hasPlus", "rawCap", "levelNumber", "isSingleLevelCap", "isUnlockUpgrade", "showUnlockableBadge", "showUnlockedBadge", "badgeHtml", "badgePlain", "needsTwoLines", "isTextBadge", "reason", "ariaLabel", "numericLevel", "plainDigits", "isInf", "over999", "tileEl", "baseImgEl", "iconImgEl", "costType", "baseSrc", "rawIcon", "iconSrc", "maxedOverlay", "showMaxed", "targetSrc", "badge", "grabber", "delveBtn", "primeTypingSfx", "openMerchant", "runPostTsunamiShopDialogue", "focusable", "forceClose", "overlayOpen", "hudButtons_exports", "__export", "applyHudLayout", "initHudButtons", "isMapUnlocked", "isShopUnlocked", "lockMap", "lockShop", "unlockMap", "unlockShop", "slotKey", "base", "slot", "getActiveSlot", "isUnlocked", "key", "slotRaw", "ensureUnlockDefaults", "BASE_KEYS", "setUnlocked", "v", "val", "sk", "setButtonVisible", "visible", "el", "updateShopButtonTamperState", "btn", "hasModifiedSave", "phonePortrait", "isCoarse", "isPortrait", "hud", "mapBtn", "isMapVisible", "isPhonePortrait", "desiredNodes", "remainingNodes", "finalOrder", "idx", "frag", "node", "cs", "gap", "cw", "per", "help", "stats", "shop", "ensureMerchantOverlay", "listenersBound", "event", "active", "actionsBound", "activate", "openShop", "onClick", "e", "shouldSkipGhostTap", "init_hudButtons", "__esmMin", "init_shopOverlay", "init_dlgTab", "init_storage", "init_ghostTapGuard", "createCursorTrail", "playfield", "el", "CAPACITY", "PARTICLE_LIFETIME", "INTERPOLATION_STEP", "MAX_SPAWN_PER_FRAME", "PARTICLE_RADIUS", "GLOW_RADIUS", "TEXTURE_SIZE", "CENTER", "STRIDE", "data", "i", "freeSlots", "freeCount", "maxActiveIndex", "canvas", "ctx", "texture", "tCtx", "pointerInside", "lastSpawnX", "lastSpawnY", "rect", "dpr", "destroyed", "rafId", "lastTime", "wasDirty", "lastClearRect", "pointsQueue", "updateBounds", "w", "h", "resize", "baseDpr", "resizeObserver", "spawn", "x", "y", "idx", "offset", "processPoint", "localX", "localY", "budgetRef", "dx", "dy", "dist", "steps", "fraction", "onPointerMove", "e", "loop", "offsetX", "offsetY", "isIn", "events", "ev", "lx", "ly", "onPointerLeave", "now", "dt", "budget", "pt", "lastPt", "activeParticles", "minX", "minY", "maxX", "maxY", "newMaxIndex", "age", "maxAge", "progress", "opacity", "scale", "size", "halfSize", "drawX", "drawY", "drawSize", "right", "bottom", "opts", "onPointerEnter", "onPointerDown", "syncInterval", "init_cursorTrail", "__esmMin", "coinPickup_exports", "__export", "clearPendingGains", "getPassiveCoinReward", "initCoinPickup", "setCoinMultiplier", "triggerPassiveCollect", "updateMutationSnapshot", "state", "mutationUnlockedSnapshot", "mutationLevelIsInfiniteSnapshot", "mutationCurrentLevelStr", "mutationMultiplierCache", "initMutationSnapshot", "mutationUnsub", "getMutationState", "onMutationChange", "snapshot", "x", "COIN_MULTIPLIER", "bank", "refreshMpValueMultiplierCache", "next", "getMpValueMultiplierBn", "BigNum", "mpValueMultiplierBn", "ensureMpValueMultiplierSync", "mpMultiplierListenersBound", "resolveCoinBase", "el", "BASE_COIN_VALUE", "computeMagnetUnitPx", "root", "vw", "vh", "MAGNET_UNIT_RATIO", "createMagnetController", "playfield", "coinsLayer", "coinSelector", "collectFn", "collectBatchFn", "spawner", "indicator", "pointerInside", "hasPointer", "pointerClientX", "pointerClientY", "localX", "localY", "lastLocalX", "lastLocalY", "unitPx", "magnetLevel", "radiusPx", "rafId", "destroyed", "playfieldRect", "syncInterval", "updatePlayfieldRect", "w", "h", "hideIndicator", "updateIndicator", "diameter", "sweepCoins", "radiusWithBuffer", "MAGNET_COLLECTION_BUFFER", "candidates", "items", "i", "c", "item", "t", "coins", "toCollect", "coin", "rect", "coinX", "coinY", "dx", "dy", "cs", "transforms", "runSweep", "ensureSweepLoop", "updatePointerFromEvent", "e", "handlePointerLeave", "resetPointerHistory", "refreshMagnetLevel", "getMagnetLevel", "handleScroll", "handleResize", "forceUpdateAndMove", "handlePointerEnter", "destroy", "pointerOpts", "pendingCoinGain", "pendingXpGain", "pendingMutGain", "calculateCoinValue", "spawnLevelStr", "base", "inc", "applyCoinMultiplier", "xpInc", "cloneBn", "XP_PER_COIN", "mutationMultiplier", "computeMutationMultiplier", "mpGain", "isMutationUnlocked", "coinGain", "xpGain", "count", "totalCoin", "totalXp", "totalMp", "coinsLocked", "isCurrencyLocked", "CURRENCIES", "incIsZero", "coinsVal", "scheduleHudUpdate", "queueCoinGain", "xpEnabled", "isXpSystemUnlocked", "xpIsZero", "queueXpGain", "queueMutationGain", "playfieldSelector", "coinsLayerSelector", "hudAmountSelector", "soundSrc", "storageKey", "disableAnimation", "coinPickup", "pf", "cl", "amt", "magnetController", "cursorTrail", "updateHudFn", "formatted", "formatNumber", "comboStr", "getComboUiString", "fullText", "refreshCoinMultiplierCache", "onCurrencyChange", "onCoinMultiplierChange", "event", "mult", "coinMultiplierBn", "coinMultiplierIsInfinite", "slot", "getActiveSlot", "SHOP_UNLOCK_KEY", "SHOP_PROGRESS_KEY", "legacyP", "legacyU", "p", "unlockShop", "resolvedSrc", "isCoin", "ensureInteractive", "COIN_VOLUME", "IS_MOBILE", "lastAt", "playSound", "src", "now", "playAudio", "animateAndRemove", "opts", "recycle", "start", "complete", "done", "collectBatch", "bestSoundSrc", "maxSizeIndex", "foundSound", "coinObj", "collectedCount", "mutEnabled", "MAX_VISUALS", "visualCount", "mpInc", "mergeGain", "onCoinCollected", "collect", "createCursorTrail", "onDelegatedInteract", "target", "BRUSH_R", "cachedPfRect", "updateCachedRect", "lastBrushLocalX", "lastBrushLocalY", "resetBrushHistory", "brushAt", "y", "OFF", "found", "k", "px", "py", "stack", "pending", "brushScheduled", "scheduleBrush", "setMobileVolume", "v", "rectInterval", "flushPendingGains", "evt", "BN_ONE", "BN_INF", "flushScheduled", "hudUpdateScheduled", "scheduleFlush", "init_coinPickup", "__esmMin", "init_storage", "init_bigNum", "init_numFormat", "init_hudButtons", "init_xpSystem", "init_main", "init_mutationSystem", "init_upgrades", "init_cursorTrail", "init_audioManager", "init_comboSystem", "init_surgeEffects", "value", "current", "gain", "addXp", "mutGain", "addMutationPower", "multHandle", "key", "cached", "levelBn", "multiplier", "computeMutationMultiplierForLevel", "isIdentity", "stored", "getSurge9State", "slot", "val", "SURGE_9_STATE_KEY", "saveSurge9State", "state", "getSurge10State", "SURGE_10_STATE_KEY", "saveSurge10State", "getSurge14State", "SURGE_14_STATE_KEY", "saveSurge14State", "getSurge15State", "SURGE_15_STATE_KEY", "saveSurge15State", "getVisibleMilestones", "currentSurgeLevel", "currentLevel", "isSurge8", "getActiveSlot", "s9State", "newState", "getResearchNodeLevel", "s10State", "newS10State", "s14State", "newS14State", "s15State", "newS15State", "reached", "future", "m", "SURGE_MILESTONES", "milestone", "baseNerf", "getTsunamiNerf", "bonus", "getTsunamiResearchBonus", "nerf", "valStr", "formatMultForUi", "log10", "newVal", "bigNumFromLog10", "formatNumber", "newMult", "newDiv", "multStr", "divStr", "mapped", "getEffectiveTsunamiNerf", "pct", "mult", "getSurge15Multiplier", "div", "getSurge15Divisor", "NERFED_SURGE_MILESTONE_IDS", "init_surgeMilestones", "__esmMin", "init_numFormat", "init_bigNum", "init_surgeEffects", "init_labNodes", "init_storage", "BigNum", "playTsunamiSequence", "container", "durationMs", "onComplete", "options", "ambienceAudio", "rumbleAudio", "humAudio", "explosionAudioTriggered", "playAudio", "bgCanvas", "uiContainer", "styleWrapper", "wrapper", "type", "transformBase", "hasXp", "hasMp", "counter", "coinWrapper", "xpWrapper", "mpWrapper", "fgCanvas", "merchantImg", "merchantLoaded", "e", "width", "height", "props", "sandSpeckles", "cloudBaseY", "generateProps", "sandY", "d3y", "merchW", "merchX", "merchSafeMin", "merchSafeMax", "i", "sx", "sy", "isSafe", "x", "y", "sandH", "limitY", "addProp", "count", "scaleBase", "scaleVar", "xFn", "safe", "attempts", "maxY", "r", "p", "dx", "dy", "perspScale", "scale", "outerTreeCount", "centerTreeCount", "a", "b", "bgCtx", "fgCtx", "resize", "dpr", "startTime", "isRunning", "animationFrameId", "visualsFinished", "SUNNY_PALETTE", "STORM_PALETTE", "beaconsActive", "beacons", "beaconStartTime", "finalFadeActive", "finalFadeStart", "finalFadeDuration", "finalExplosionTriggered", "flashWhite", "waves", "layerCount", "rainParticles", "maxRain", "lerp", "start", "end", "t", "hexToRgb", "hex", "bigint", "lerpColor", "c1", "c2", "rgb1", "rgb2", "g", "createBolt", "segments", "currX", "currY", "segmentHeight", "nextX", "nextY", "drawRoundedRect", "ctx", "radius", "drawPalmTree", "palette", "drawRock", "drawShell", "angle", "drawDunes", "d2y", "s", "spawnBeacon", "forceSize", "sizeMult", "isFinal", "drawBeacons", "intensity", "allowSpawn", "chance", "spawnCount", "k", "grad", "alpha", "loop", "now", "elapsed", "FADE_IN_END", "STORM_START", "STRIKE_TIME", "FADE_OUT_START", "FADE_OUT_DURATION", "IMPACT_START", "stormFactor", "impactFactor", "currentPalette", "shakeX", "shakeY", "shakeMag", "sunY", "merchScale", "merchH", "overlap", "merchY", "prop", "rainIntensity", "rainCount", "wind", "WALL_START_FACTOR", "wallProgress", "wallHeight", "tideRise", "impactRise", "baseWaterY", "wave", "index", "baseColor", "waveAmp", "waveFreq", "speed", "timeOffset", "yOffset", "layerY", "opacity", "fade", "beaconElapsed", "EXPLOSION_TIME", "fadeElapsed", "cleanup", "triggerBeacons", "triggerFinalFade", "showCursor", "hideCursor", "stopHumLoop", "init_tsunamiVisuals", "__esmMin", "init_audioManager", "resetTab_exports", "__export", "canPerformForgeReset", "canPerformInfuseReset", "computeForgeGoldFromInputs", "computeInfuseMagicFromInputs", "computePendingDnaFromInputs", "computePendingForgeGold", "computeSurgeWavesFromInputs", "getCurrentSurgeLevel", "getForgeDebugOverrideState", "getInfuseDebugOverrideState", "getSurgeBarLevelKey", "getSurgeDebugOverrideState", "hasDoneExperimentReset", "hasDoneForgeReset", "hasDoneInfuseReset", "hasDoneSurgeReset", "initResetPanel", "initResetSystem", "isExperimentUnlocked", "isForgeUnlocked", "isInfuseUnlocked", "isSurgeUnlocked", "onForgeUpgradeUnlocked", "onInfuseUpgradeUnlocked", "onSurgeUpgradeUnlocked", "performForgeReset", "performInfuseReset", "performSurgeReset", "recomputePendingMagic", "setExperimentResetCompleted", "setForgeDebugOverride", "setForgeResetCompleted", "setInfuseDebugOverride", "setInfuseResetCompleted", "setInfuseUnlockedForDebug", "setSurgeResetCompleted", "setSurgeUnlockedForDebug", "shouldBlockBigCoins", "updateResetPanel", "shouldWipePlayfield", "resetType", "RESET_WIPE_EXCLUSIONS", "playForgeResetSound", "playAudio", "FORGE_RESET_SOUND_SRC", "playInfuseResetSound", "INFUSE_RESET_SOUND_SRC", "playSurgeResetSound", "SURGE_RESET_SOUND_SRC", "playExperimentResetSound", "EXPERIMENT_RESET_SOUND_SRC", "_shouldBlockBigCoins", "updateBlockBigCoinsStatus", "slot", "ensureResetSlot", "currentWaves", "bank", "bnZero", "barLevel", "getSurgeBarLevel", "pending", "resetState", "potentialLevel", "predictSurgeLevel", "isSurge8", "getTsunamiSequenceSeen", "resetPendingGoldSignature", "pendingGoldInputSignature", "notifyForgeUnlockChange", "getActiveSlot", "notifyInfuseUnlockChange", "notifySurgeUnlockChange", "getPendingGoldWithMultiplier", "multiplierOverride", "labMult", "getLabGoldMultiplier", "val", "mult", "BN", "cleanupWatchers", "watchers", "stop", "ensureValueListeners", "coinChangeUnsub", "onCurrencyChange", "detail", "CURRENCIES", "updateWaveBar", "recomputePendingGold", "recomputePendingWaves", "xpChangeUnsub", "onXpChange", "recomputePendingDna", "levelToNumber", "levelBn", "plain", "num", "approx", "approxLog10BigNum", "getXpLevelBn", "state", "getXpState", "computeForgeGold", "coinsBn", "logCoins", "logScaled", "pow2", "bigNumFromLog10", "levelNum", "levelFactor", "pow14", "bnOne", "floorLog", "pow115", "total", "floored", "computeInfuseMagicBase", "cumulativeMpBn", "logCRatio", "LOG_BASE", "LOG_1_5", "LOG_1_03", "LOG_2", "logMpRatio", "logMp", "term1", "term2", "term3", "totalLog", "computeInfuseMagic", "base", "getLabMagicMultiplier", "result", "xpLevelBn", "goldBn", "magicBn", "mpBn", "computeSurgeWaves", "labLevelBn", "isSurge9Override", "logBaseVal", "logMultiplier", "isSurgeActive", "effectiveNerf", "getEffectiveTsunamiNerf", "log14", "logBaseStr", "labFactor", "xpFactor", "BigNum", "totalLog10", "logVal", "xpLevel", "xpTerm", "logGold", "logMagic", "logSum", "LOG1_1", "logTotal", "baseWaves", "getXpLevelNumber", "value", "FORGE_COMPLETED_KEY", "INFUSE_COMPLETED_KEY", "SURGE_COMPLETED_KEY", "EXPERIMENT_COMPLETED_KEY", "getForgeDebugOverride", "raw", "FORGE_DEBUG_OVERRIDE_KEY", "normalized", "primeStorageWatcherSnapshot", "getInfuseDebugOverride", "INFUSE_DEBUG_OVERRIDE_KEY", "setInfuseUnlocked", "next", "INFUSE_UNLOCK_KEY", "setForgeUnlocked", "FORGE_UNLOCK_KEY", "getSurgeDebugOverride", "SURGE_DEBUG_OVERRIDE_KEY", "setSurgeUnlocked", "SURGE_UNLOCK_KEY", "readPersistentFlags", "ensurePersistentFlagsPrimed", "bindStorageWatchers", "watchersBoundSlot", "watchStorageKey", "getPendingInputSignature", "coins", "level", "coinSig", "levelSig", "force", "signature", "meetsLevelRequirement", "cumulativeMp", "getTotalCumulativeMp", "meetsInfuseRequirement", "gold", "magic", "mp", "labLevel", "getLabLevel", "canAccessForgeTab", "override", "getLevelNumber", "AREA_KEYS", "UPGRADE_TIES", "MIN_FORGE_LEVEL", "mState", "getMutationState", "MIN_INFUSE_MUTATION_LEVEL", "resetUpgrades", "resetGold", "resetMagic", "upgrades", "getUpgradesForArea", "upg", "tieKey", "setLevel", "applyForgeResetEffects", "resetXpProgress", "clearPendingGains", "finalReward", "initMutationSystem", "unlockMutationSystem", "reward", "KEY_LEVEL", "s", "KEY_PROGRESS", "applySurgeResetLogic", "rewardWaves", "playEffects", "skipVisuals", "triggerSurgeWaveAnimation", "performExperimentReset", "resetLab", "startTsunamiSequence", "closeShop", "closeMerchant", "overlay", "setTsunamiSequenceSeen", "coinCounter", "xpCounter", "mpCounter", "visualOptions", "controls", "playTsunamiSequence", "runTsunamiDialogue", "endTsunamiSequence", "tsunamiCleanup", "existing", "wave", "SURGE_BAR_LEVEL_KEY", "isSurgeLevelLocked", "key", "getSafeLog10BigInt", "bn", "totalExp", "sigLog", "calculateSurgeLevelJump", "startLevelBigInt", "wavesBn", "req", "changed", "logCurrentBigInt", "logReqBigInt", "targetLevel", "nextReq", "cost", "safety", "isUpdatingWaveBar", "formatBn", "formatNumber", "generateDnaSvgDataUri", "colors", "paths", "i", "x", "angle", "y1", "y2", "segments", "getPath", "startAngle", "endAngle", "color", "phaseOffset", "d", "t", "y", "overlap", "svg", "buildPanel", "panelEl", "RESET_ICON_SRC", "INFUSE_ICON_SRC", "SURGE_ICON_SRC", "EXPERIMENT_ICON_SRC", "GOLD_ICON_SRC", "MAGIC_ICON_SRC", "WAVES_ICON_SRC", "IS_MOBILE", "DNA_ICON_SRC", "surgeWrapper", "ensureCustomScrollbar", "observer", "entries", "entry", "target", "isVisible", "updateForgeCard", "updateInfuseCard", "updateSurgeCard", "updateExperimentCard", "btn", "lastPointerType", "handleClick", "e", "shouldSkipGhostTap", "card", "scrollContainer", "dnaContainer", "dnaBtn", "dnaBg", "svgUri", "openShop", "syncLayout", "statsBtn", "rect", "w", "h", "ro", "hud", "updateResetButtonContent", "iconSrc", "pendingAmountBn", "disabled", "msg", "targetMode", "currentMode", "amountStr", "amountEl", "iconImg", "goldMult", "el", "expected", "currentLevelBigInt", "pendingWaves", "availableWaves", "pct", "ratio", "rNum", "isInf", "sLevel", "newContent", "predicted", "isIncrease", "pLevel", "visible", "getVisibleMilestones", "existingItems", "m", "isReached", "reachedClass", "desc", "rate", "getBookProductionRate", "mults", "getSurge6WealthMultipliers", "formatMultForUi", "log10Rate", "rateMultiplier", "goldPerSec", "magicPerSec", "isNerfed", "NERFED_SURGE_MILESTONE_IDS", "nerfedClass", "itemEl", "isReachedStr", "descEl", "arrowEl", "shouldHaveArrow", "display", "reachedItems", "lastReached", "allItems", "triggerSurgeBarAnimation", "barFill", "wrapper", "bindGlobalEvents", "surgeCard", "magicMult", "initialized", "isMutationUnlocked", "mutationUnsub", "onMutationChange", "sprite", "getMutationCoinSprite", "nextSlot", "init_resetTab", "__esmMin", "init_bigNum", "init_main", "init_storage", "init_numFormat", "init_xpSystem", "init_upgrades", "init_mutationSystem", "init_ghostTapGuard", "init_coinPickup", "init_surgeMilestones", "init_shopOverlay", "init_audioManager", "init_surgeEffects", "init_labNodes", "init_labTab", "init_dlgTab", "init_tsunamiVisuals", "upgrades_exports", "__export", "AREA_KEYS", "HM_EVOLUTION_INTERVAL", "MAX_LEVEL_DELTA", "REGISTRY", "UPGRADE_TIES", "approxLog10BigNum", "batchUpgradeOperations", "bigNumFromLog10", "buyCheap", "buyMax", "buyOne", "buyTowards", "clearPermanentUpgradeUnlock", "computeDefaultUpgradeCost", "computeHmMultipliers", "computeUpgradeEffects", "costToBuyOne", "ensureLevelBigNum", "estimateFlatBulk", "estimateGeometricBulk", "evaluateBulkPurchase", "evolveUpgrade", "formatMultForUi", "getCurrentAreaKey", "getHmEvolutions", "getHmNextMilestoneLevel", "getIconUrl", "getLevel", "getLevelNumber", "getMagnetLevel", "getMpValueMultiplierBn", "getUpgrade", "getUpgradeLockState", "getUpgradeStorageKey", "getUpgradesForArea", "levelBigNumToNumber", "log10OnePlusPow10", "markUpgradePermanentlyUnlocked", "normalizeBigNum", "normalizeUpgradeIconPath", "normalizedUpgradeLevel", "onUpgradesChanged", "peekNextPrice", "performFreeAutobuy", "safeMultiplyBigNum", "setLevel", "syncBookCurrencyMultiplierFromUpgrade", "upgradeUiModel", "flushDeferredWrites", "deferredWrites", "areaKey", "upgId", "state", "slot", "key", "payload", "primeStorageWatcherSnapshot", "e", "initDeferredFlush", "deferredFlushTimer", "fn", "isBatching", "pendingUpgradeSaves", "saveUpgradeState", "pendingAreaSaves", "stateArr", "saveAreaState", "pendingNotify", "notifyChanged", "hasScaling", "upg", "scaling", "ensureUpgradeScaling", "c0", "BigNum", "c1", "cF", "isInfinityLevelForScaled", "lvlBn", "bn", "log10", "SCALED_INFINITY_LVL_LOG10", "sanitizeStoredLevelValue", "raw", "allowEmpty", "trimmed", "MAX_LEVEL_STORAGE_LENGTH", "expPart", "caret", "expDigits", "shopStatusRank", "status", "SHOP_REVEAL_STATUS_ORDER", "classifyUpgradeStatus", "lockState", "upgradeRevealKey", "normArea", "normalizeAreaKey", "tieKey", "normalizeUpgradeTie", "rawId", "normalizeUpgradeId", "idStr", "upgradeLegacyRevealKey", "migrateUpgradeStateKey", "fromKey", "toKey", "ensureShopRevealState", "getActiveSlot", "slotKey", "shopRevealStateCache", "parsed", "SHOP_REVEAL_STATE_KEY_BASE", "obj", "saveShopRevealState", "ensureShopPermaUnlockState", "shopPermaUnlockStateCache", "SHOP_PERMA_UNLOCK_KEY_BASE", "saveShopPermaUnlockState", "ensureShopPermaMystState", "shopPermaMystStateCache", "SHOP_PERMA_MYST_KEY_BASE", "saveShopPermaMystState", "markUpgradePermanentlyMysterious", "legacyKey", "isUpgradePermanentlyMysterious", "permaState", "revealState", "invalidateUpgradeState", "isUpgradePermanentlyUnlocked", "determineLockState", "ctx", "upgRef", "area", "SPECIAL_LOCK_STATE_TIES", "LOCKED_UPGRADE_ICON_DATA_URL", "currentLevel", "xpUnlocked", "safeIsXpUnlocked", "determineUnlockXpLockState", "safeHasMetMerchant", "revealText", "MYSTERIOUS_UPGRADE_ICON_DATA_URL", "HIDDEN_UPGRADE_TITLE", "xp31", "xpBn", "currentXpLevelBigNum", "hasDoneForgeReset", "LOCKED_UPGRADE_TITLE", "xp101", "hasDoneInfuseReset", "xp201", "INFUSE_PLACEHOLDER_TIES", "tieValue", "isXpAdjacentUpgrade", "XP_MYSTERY_UPGRADE_TIES", "normalizedId", "numericId", "idKey", "areaCandidates", "candidate", "XP_MYSTERY_LEGACY_KEYS", "isXpSystemUnlocked", "MERCHANT_MET_KEY_BASE", "getXpState", "levelValue", "maxSafe", "clamped", "plain", "mergeLockStates", "base", "override", "merged", "keys", "value", "unsigned", "approxDigits", "normalized", "num", "approx", "digits", "lead", "leadNum", "leadLen", "mantissa", "exponent", "shift", "plainLevelDelta", "nextLevelBn", "prevLevelBn", "next", "prev", "nextDigits", "prevDigits", "nextPlain", "prevPlain", "diff", "decimalMultiplierString", "out", "normalizeHmEvolutionCount", "n", "activeEvolutionsForUpgrade", "active", "baseCost", "level", "upgType", "baseBn", "levelNumber", "evolutions", "preset", "resolveDefaultScalingRatio", "ratio", "ratioLog10", "costAtLevelUsingScaling", "hmLevelCapForEvolutions", "cycles", "cap", "capBn", "formatBigNumAsHtml", "formatBigNumAsPlain", "hmMilestoneHits", "levelBn", "milestoneLevel", "delta", "lvl", "interval", "hmMilestoneMultiplier", "multiplier", "hits", "hitCount", "multiply", "b", "result", "i", "factor", "exp", "resolveHmMilestones", "DEFAULT_AREA_KEY", "normalizedArea", "HM_MILESTONES_BY_AREA", "HM_MILESTONES_STARTER_COVE", "f", "applyHmEvolutionMeta", "capFmtHtml", "capFmtText", "milestones", "selfMult", "xpMult", "coinMult", "mpMult", "m", "mult", "target", "totalLog10", "HM_EVOLUTION_LOG10", "evolMult", "hmNextMilestoneLevel", "best", "nextHits", "targetBi", "increment", "tryPreset", "name", "presetName", "presetFn", "DEFAULT_SCALING_PRESETS", "res", "providedScaling", "ratioStr", "pow", "ratioLn", "ratioMinus1", "defaultPreset", "resolved", "baseLog10", "price", "anchor", "step", "logExpMinus1", "x", "negExp", "logSeriesTotal", "startLevel", "count", "LN10", "startLn", "growth", "numerLn", "denomLn", "totalCostBigNum", "targetLevel", "total", "tailCount", "headCount", "headLog", "tailStart", "totalLog", "nextDownPositive", "FLOAT64_VIEW", "INT64_VIEW", "safeDecrementCount", "dec", "countToBigNum", "floored", "str", "calculateBulkPurchase", "walletBn", "maxLevels", "options", "zero", "opts", "fastOnly", "startLevelNum", "maxLevelsNum", "capRoom", "MAX_LEVEL_DELTA_LIMIT", "room", "nextPrice", "remainingToHundred", "limit", "walletLog", "maxLevelInBatch", "maxCostLog", "countBn", "nextStartLevel", "tail", "spent", "newSpent", "nextLevel", "reachedCap", "toUpgradeBigNum", "totalCount", "totalSpent", "firstPrice", "startPriceLog", "hardLimit", "lo", "hi", "spentLog", "doubled", "steps", "mid", "isConstantCost", "secondPrice", "farPrice", "farProbe", "roomBn", "ratioMinus1Log", "approxCount", "EPS", "tuneSteps", "MAX_TUNE_STEPS", "overshoot", "reduced", "safeTimes2", "y", "hiLog", "left", "right", "midLog", "guard", "decremented", "nextCost", "nextLog", "canUseNumericFinal", "finalLevel", "computeBulkMeta", "basePrice", "logBase", "logNext", "ratioLog", "denom", "priceBn", "wPlain", "pPlain", "q", "levelCapToNumber", "wl", "pl", "meta", "priceLog", "numerator", "hiBound", "iter", "nextPriceLog", "fallback", "formatNumber", "safeCloneBigNum", "emitUpgradeLevelChange", "prevLevelNum", "nextLevelNum", "oldBn", "newBn", "nmCostBN", "keyForArea", "resolvedId", "resolveUpgradeIdentifier", "cleanupUpgradeStorageWatchers", "upgradeStorageWatcherCleanup", "stop", "bindUpgradeStorageWatchersForSlot", "migrateLegacyStorage", "arr", "migratedCount", "rec", "loadUpgradeFromStorage", "pending", "deferred", "upgradeTieLookup", "requestedArea", "upgradeCacheKey", "ensureUpgradeState", "upgradeStateCache", "recNeedsSave", "prevLvlStorage", "prevNextCost", "prevNextCostLvl", "hmEvolutions", "clampedStorage", "normalizedLvlStorage", "costLevelStorage", "nextCostStale", "nextCostBn", "infCap", "commitUpgradeState", "inBn", "currentLvlStorage", "computeUpgradeLockStateFor", "xpLevelBn", "xpLevel", "baseState", "isXpAdj", "xpRevealText", "unlockXpVisible", "meetText", "getCurrentSurgeLevel", "isSurgeUnlocked", "targetId", "custom", "revealKey", "permaUnlocked", "permaMystState", "hyphenKey", "needsRevealSave", "needsPermaSave", "needsPermaMystSave", "hiddenState", "isForgePlaceholder", "FORGE_PLACEHOLDER_TIES", "isInfusePlaceholder", "storedStatus", "xpReached31", "xpReached101", "storedRank", "currentStatus", "currentRank", "applyStoredMysterious", "snap", "reasonText", "shouldSave", "normalizedStatus", "isForgePlaceholderForSave", "xpReached31Now", "xpReached101Now", "isUpgradeLocked", "isHmReadyToEvolve", "safeEvol", "lvlNum", "currentNum", "clampToCap", "resetHmEvolutions", "desiredBn", "nextBn", "nextNum", "u", "iconPath", "path", "segments", "seg", "segment", "SHARED_ROOTS", "lower", "rawPrice", "costType", "walletEntry", "bank", "haveRaw", "nextEvol", "walletValue", "wallet", "prevLevel", "prevLevelStorage", "targetLevelBn", "purchased", "plainDelta", "nextStorage", "outcome", "remaining", "maxRoom", "invalidateEffectsCache", "triggerUpgradesChanged", "lvlFmtHtml", "lvlFmtText", "lvlCapBn", "lvlCapFmtHtml", "lvlCapFmtText", "nextPriceFmt", "have", "locked", "displayTitle", "displayDesc", "AUTOMATION_AREA_KEY", "EFFECTIVE_AUTO_COLLECT_ID", "getEacAmountMultiplier", "multStr", "hmMilestones", "effect", "iconUrl", "storageKey", "isStorageKeyLocked", "upgradeKey", "startLvl", "walletHandle", "maxEval", "check", "k", "costOfPrev", "walletRem", "costOfNext", "threshold", "bestK", "currentSpent", "currentK", "lastLvlIdx", "lastCost", "prevSpent", "HM_EVOLUTION_EFFECT_MULT_BN", "BOOK_VALUE_TIE_KEY", "BN", "toBn", "E", "FLOAT64_BUFFER", "init_upgrades", "__esmMin", "init_storage", "init_bigNum", "init_numFormat", "init_xpSystem", "init_mutationSystem", "init_resetTab", "init_surgeEffects", "init_automationUpgrades", "init_automationEffects", "init_dnaUpgrades", "init_upgradeEffects", "DNA_AREA_KEY", "p", "pNum", "pStr", "L", "logL", "logTerm", "xNum", "xStr", "baseNum", "log10b", "LOG10_INFINITY_TRIGGER", "approxLevelLog", "triggerLevelLog", "val", "approxLvl", "evol", "evolThreshold", "evol_after_1m", "base_scaling", "r", "extra_scaling", "softcapStart", "_", "newLevel", "newLevelBn", "unlockXpSystem", "refreshCoinMultiplierFromXpLevel", "onForgeUpgradeUnlocked", "units", "unitsText", "baseMult", "onInfuseUpgradeUnlocked", "onSurgeUpgradeUnlocked", "surgeLevel", "isUnlocked", "label", "registerXpUpgradeEffects", "debugPanel_exports", "__export", "applyAllCurrencyOverridesForActiveSlot", "applyStatMultiplierOverride", "getDebugCurrencyMultiplierOverride", "getDebugStatMultiplierOverride", "setDebugCurrencyMultiplierOverride", "setDebugPanelAccess", "setDebugStatMultiplierOverride", "isOnMenu", "menuRoot", "style", "isGameVisible", "gameRoot", "addDebugPanelCleanup", "fn", "debugPanelCleanups", "createEmptyExpansionState", "captureDebugPanelExpansionState", "panel", "DEBUG_PANEL_ID", "sections", "toggle", "key", "subsections", "applyDebugPanelExpansionState", "debugPanelExpansionState", "content", "cleanupDebugPanelResources", "liveBindings", "registerLiveBinding", "binding", "refreshLiveBindings", "predicate", "setupLiveBindingListeners", "currencyHandler", "event", "slot", "targetSlot", "getActiveSlot", "currencyMultiplierHandler", "xpHandler", "changeType", "unlocked", "mutationHandler", "upgradeHandler", "slotHandler", "unlockHandler", "workshopHandler", "surgeHandler", "tsunamiHandler", "labHandler", "labNodeHandler", "id", "level", "labNodeRpHandler", "rp", "getAreas", "AREA_KEYS", "CURRENCIES", "ensureDebugPanelStyles", "DEBUG_PANEL_STYLE_ID", "existingLink", "marker", "link", "removeDebugPanelToggleButton", "existingButton", "DEBUG_PANEL_TOGGLE_ID", "shouldShowDebugPanelToggleButton", "debugPanelAccess", "IS_MOBILE", "onMenuVisibilityChange", "closeDebugPanel", "createDebugPanelToggleButton", "createSection", "title", "contentId", "contentBuilder", "section", "stateKey", "sectionKeyCounter", "lastPointerType", "handleToggle", "expanded", "createSubsection", "defaultExpanded", "container", "subsectionKeyCounter", "bigNumEquals", "a", "b", "getCurrencyStorageKey", "currencyKey", "resolvedSlot", "KEYS", "getCurrencyValueForSlot", "BigNum", "handle", "bank", "peekCurrency", "applyCurrencyState", "value", "previous", "storageKey", "wasLocked", "isStorageKeyLocked", "unlockStorageKey", "next", "markSaveSlotModified", "setCurrency", "primeStorageWatcherSnapshot", "lockStorageKey", "buildOverrideKey", "getCurrencyOverride", "currencyOverrides", "getCurrencyMultiplierStorageKey", "clearCurrencyMultiplierOverride", "cacheKey", "currencyOverrideBaselines", "getStatOverride", "lockAwareRefresh", "isStatMultiplierLocked", "cached", "statOverrides", "fromStorage", "loadStatMultiplierOverrideFromStorage", "notifyStatMultiplierChange", "statKey", "clearStatMultiplierOverride", "getStatMultiplierStorageKey", "statOverrideBaselines", "getLockedStatOverride", "getStatMultiplierDisplayValue", "gameValue", "getGameStatMultiplier", "getEffectiveStatMultiplierOverride", "STAT_MULTIPLIER_STORAGE_PREFIX", "mult", "getXpGainMultiplier", "valueMult", "getMutationGainMultiplier", "getMutationMultiplier", "eff", "computeUpgradeEffects", "getRpMultBase", "raw", "storeStatMultiplierOverride", "bn", "locked", "setter", "originalSetItem", "applyCurrencyOverrideForSlot", "override", "currencyOverrideApplications", "current", "ensureCurrencyOverrideListener", "currencyListenerAttached", "baseline", "baselineBn", "nextBn", "ratio", "ratioNum", "scaledOverride", "amount", "base", "multiplierForRatio", "numBn", "denomBn", "ensureStorageLockPatch", "storageLockPatched", "originalRemoveItem", "lockedStorageKeys", "toggleStorageLock", "createLockToggle", "onToggle", "button", "refresh", "createCompositeLockToggle", "resolveKeys", "getKeys", "isLocked", "keys", "hasAnyLocked", "anyLocked", "collapseAllDebugCategories", "withTemporaryUnlock", "uniqueKeys", "relock", "formatBigNumForInput", "storage", "pStr", "sigPart", "expPart", "precision", "paddedSig", "parseBigNumInput", "trimmed", "setInputValidity", "input", "valid", "flagDebugUsage", "getActionLogKey", "ACTION_LOG_STORAGE_PREFIX", "getCurrentActionLog", "parsed", "persistActionLog", "entries", "MAX_ACTION_LOG_ENTRIES", "appendActionLogEntry", "entry", "log", "logAction", "message", "now", "updateActionLogDisplay", "actionLogContainer", "actionLog", "msg", "formattedTime", "formattedMessage", "match", "dialogueStateStorageKey", "MERCHANT_DLG_STATE_KEY_BASE", "persistDialogueState", "state", "payload", "loadDialogueState", "grantDialogueReward", "reward", "e", "completeAllDialoguesForDebug", "completed", "DLG_CATALOG", "meta", "prev", "alreadyClaimed", "restoreAllDialoguesForDebug", "restored", "createInputRow", "labelText", "initialValue", "onCommit", "idLabel", "onLockChange", "format", "row", "label", "idSpan", "editing", "pendingValue", "skipBlurCommit", "lockToggle", "setValue", "commitValue", "createUnlockToggleRow", "description", "isUnlocked", "onEnable", "onDisable", "slider", "textContainer", "desc", "toggleRow", "lastKnown", "refreshed", "formatCalculatorResult", "formatNumber", "num", "createCalculatorRow", "inputs", "compute", "controls", "output", "fieldEls", "recompute", "values", "hasError", "config", "el", "result", "inputConfig", "select", "optLabel", "option", "applyXpState", "progress", "getXpState", "zero", "toBnOrNull", "nextLevel", "nextProgress", "levelIsFinite", "progressIsFinite", "unlockXpSystem", "unlockKey", "XP_KEYS", "initXpSystem", "broadcastXpChange", "applyMutationState", "getMutationState", "forgeUnlocked", "forgeOverride", "setMutationUnlockedForDebug", "initMutationSystem", "unlockMutationSystem", "MUTATION_KEYS", "broadcastMutationChange", "buildAreaCurrencies", "area", "areaLabel", "currency", "currencyRow", "latestSlot", "latest", "buildAreaStats", "spawnRateKey", "spawnRateStorageKey", "spawnRateRow", "xp", "mutation", "xpLevelKey", "xpLevelRow", "xpProgressKey", "xpProgressRow", "prevLevel", "prevProgress", "mpLevelKey", "mpLevelRow", "mpProgressKey", "mpProgressRow", "genLevelKey", "getGenerationLevelKey", "currentGenLevel", "genLevelRow", "valNum", "cleanVal", "newVal", "r", "surgeLevelKey", "getSurgeBarLevelKey", "currentSurgeLevel", "surgeLevelRow", "valToStore", "valForDisplay", "displayStr", "prevStr", "isSurge8", "setTsunamiNerf", "getTsunamiSequenceSeen", "setTsunamiSequenceSeen", "eventLevel", "labLevel", "getLabLevel", "labLevelRow", "valBn", "setLabLevel", "getLabLevelKey", "getEffectiveTsunamiNerf", "getTsunamiNerf", "bonus", "getTsunamiResearchBonus", "val", "tsunamiRow", "targetBase", "prevBase", "getTsunamiNerfKey", "n", "buildAreaUpgrades", "upgrades", "getUpgradesForArea", "upg", "getLevel", "getUpgradeStorageKey", "upgradeRow", "setLevel", "buildAreaCurrencyMultipliers", "setAllCurrenciesToInfinity", "inf", "updated", "setAllCurrenciesToZero", "setAllStatsToInfinity", "touched", "xpState", "mutationState", "levelInf", "progInf", "setAllStatsToZero", "getUnlockRowDefinitions", "resetXpProgress", "isShopUnlocked", "unlockShop", "lockShop", "isMapUnlocked", "unlockMap", "lockMap", "isJeffUnlocked", "setJeffUnlocked", "getResearchNodeLevel", "setResearchNodeLevel", "setAllUnlockToggles", "targetState", "toggled", "rowDef", "unlockAllUnlocks", "markUpgradePermanentlyUnlocked", "lockAllUnlockUpgrades", "clearPermanentUpgradeUnlock", "getResetTargetLockKeys", "target", "add", "addCurrencyKeys", "addStatMultiplier", "addStatKeys", "STAT_MULTIPLIERS", "resetCurrencyAndMultiplier", "setCurrencyMultiplierBN", "resetStatsAndMultipliers", "currencyCount", "resetCount", "parts", "buildAreaStatMultipliers", "stat", "buildLabNodesDebug", "RESEARCH_NODES", "node", "nodeContainer", "sub", "levelKey", "NODE_LEVEL_KEY", "levelRow", "rpKey", "NODE_RP_KEY", "rpRow", "getResearchNodeRp", "setResearchNodeRp", "buildAreaCalculators", "coins", "xpLevel", "mp", "gold", "magic", "isSurge9", "getXpRequirementForXpLevel", "computeCoinMultiplierForXpLevel", "mpLevel", "computeMutationRequirementForLevel", "computeMutationMultiplierForLevel", "getGenerationUpgradeCost", "isSurge12", "lvlNum", "effectiveNerf", "multLog10", "logBase", "totalLog", "bigNumFromLog10", "logVal", "baseCost", "mode", "computeDefaultUpgradeCost", "tsunamiExp", "mapped", "pct", "formatMultForUi", "group", "subsection", "calculatorRow", "buildAreasContent", "placeholder", "areaContainer", "areaContent", "currencies", "stats", "multipliers", "currencyMultipliers", "statMultipliers", "automationUpgrades", "dnaUpgrades", "labNodesSection", "calculators", "setAllUpgradesMaxed", "onlyUnlocked", "count", "areas", "targets", "areaKey", "getUpgradeLockState", "batchUpgradeOperations", "targetLevel", "setAllUpgradesZero", "resetAction", "setAutobuyerToggle", "setAllAutomationToggles", "AUTOMATION_AREA_KEY", "lvl", "masterTypes", "MASTER_AUTOBUY_IDS", "automatedCostTypes", "type", "AUTOBUY_WORKSHOP_LEVELS_ID", "buildMiscContent", "buttons", "unlocks", "toggles", "locks", "isResearchNodeActive", "setResearchNodeActive", "WARP_CHARGES_KEY", "MAX_WARPS", "updateWarpTab", "seconds", "rewards", "isPreAutomation", "hasDoneInfuseReset", "calculateOfflineRewards", "calculatePreAutomationRewards", "grantOfflineRewards", "ms", "showOfflinePanel", "buttonGrid", "cfg", "btn", "resetRow", "resetLabel", "resetSelect", "opt", "allCurrenciesOption", "allUnlockedStatsOption", "allUnlockedOption", "allOption", "debugPanelMiscResetSelection", "DEFAULT_MISC_RESET_SELECTION", "resolveResetLockKeys", "resetLockToggle", "resetBtn", "lockKeys", "shouldRelock", "performReset", "logEntry", "actionLogRow", "wipeSlotBtn", "buildUnlocksContent", "rows", "textA", "textB", "buildDebugPanel", "existingPanel", "header", "titleContainer", "closeButtonContainer", "closeButton", "collapseCloseButton", "info", "text", "hideOnMobile", "infoLine", "debugPanelScrollTop", "debugPanelOpen", "openDebugPanel", "preserveExpansionState", "toggleDebugPanel", "teardownDebugPanel", "applyDebugPanelAccess", "enabled", "XP_KEY_PREFIX", "MUTATION_KEY_PREFIX", "init_debugPanel", "__esmMin", "init_bigNum", "init_numFormat", "init_storage", "init_xpSystem", "init_mutationSystem", "init_main", "init_upgrades", "init_hudButtons", "init_dlgTab", "init_workshopTab", "init_resetTab", "init_surgeEffects", "init_automationEffects", "init_automationUpgrades", "init_warpTab", "init_labTab", "init_labNodes", "init_offlinePanel", "mutationSystem_exports", "__export", "addExternalMutationGainMultiplierProvider", "addMutationPower", "broadcastMutationChange", "computeMutationMultiplierForLevel", "computeMutationRequirementForLevel", "getMutationCoinSprite", "getMutationGainMultiplier", "getMutationMultiplier", "getMutationState", "getTotalCumulativeMp", "initMutationSystem", "isMutationUnlocked", "onMutationChange", "setMutationUnlockedForDebug", "unlockMutationSystem", "toStorageSafe", "value", "scheduleCoinMultiplierRefresh", "refreshCoinMultiplierFromXpLevel", "applyMutationMultipliers", "amount", "inc", "providers", "mutationGainMultiplierProviders", "externalMutationGainMultiplierProvider", "provider", "maybe", "mutationState", "BN", "ensureExternalMultiplierProviders", "unregisterCoinMultiplierProvider", "unregisterXpGainMultiplierProvider", "cloneBigNum", "bnZero", "quantizeRequirement", "sci", "match", "floored", "plain", "quant", "levelToNumber", "level", "num", "approxLog", "approxLog10BigNum", "computeRequirement", "levelBn", "baseRequirementLog10", "baseLevel", "m", "tail", "poly", "factor", "powTerm", "CONST_RATIO", "totalLog10", "levelNum", "startVal", "endVal", "steps", "safeStart", "ratio", "exponent", "x", "A", "B", "secondExp", "raw", "bigNumFromLog10", "ensureRequirement", "lvl", "inf", "BigNum", "req", "progressRatio", "progressBn", "requirement", "reqInf", "progInf", "logProg", "logReq", "diff", "ensureHudRefs", "hudRefs", "formatBn", "bn", "formatNumber", "updateHud", "container", "bar", "fill", "levelValue", "progress", "reqHtml", "reqPlain", "syncXpMpHudLayout", "pct", "currentHtml", "currPlain", "emitChange", "reason", "extraDetail", "snapshot", "detail", "getActiveSlot", "listeners", "cb", "persistState", "slot", "KEY_UNLOCK", "KEY_LEVEL", "KEY_PROGRESS", "primeStorageWatcherSnapshot", "persisted", "unlocked", "rawLevel", "rawProgress", "persistedLevelRaw", "persistedProgressRaw", "expectedLevelRaw", "expectedProgressRaw", "unlockMismatch", "levelMismatch", "progressMismatch", "applyState", "isKeyLocked", "key", "normalizeProgress", "currentReq", "guard", "limit", "bnOne", "newState", "skipPersist", "readStateFromStorage", "targetSlot", "rawLvl", "rawProg", "cleanupWatchers", "watcherCleanups", "stop", "bindStorageWatchers", "watchersBoundSlot", "watchStorageKey", "nextUnlocked", "next", "forceReload", "initialized", "activeSlot", "nextSlot", "levelLocked", "prevLevel", "prevProgress", "applyStatMultiplierOverride", "incClone", "levelsGained", "detailOverrides", "log10", "MP_LOG10_BASE", "mult", "callback", "fn", "currentLvlNum", "total", "i", "KEY_PREFIX", "init_mutationSystem", "__esmMin", "init_bigNum", "init_storage", "init_debugPanel", "init_numFormat", "init_hudLayout", "init_xpSystem", "VERTEX_SHADER", "BACKGROUND_FRAGMENT_SHADER", "FRAGMENT_SHADER", "WAVE_VERTEX_SHADER", "WAVE_BRUSH_FRAGMENT_SHADER", "SIMULATION_FRAGMENT_SHADER", "init_waterShaders", "__esmMin", "waterSystem_exports", "__export", "WaterSystem", "waterSystem", "createShader", "gl", "type", "source", "shader", "log", "createProgram", "vsSource", "fsSource", "vs", "fs", "program", "COLOR_DEEP", "COLOR_SHALLOW", "COLOR_WAVE", "COLOR_WAVE_DEEP", "init_waterSystem", "__esmMin", "init_waterShaders", "backCanvasId", "frontCanvasIds", "ids", "id", "canvas", "layer", "VERTEX_SHADER", "FRAGMENT_SHADER", "SIMULATION_FRAGMENT_SHADER", "WAVE_VERTEX_SHADER", "WAVE_BRUSH_FRAGMENT_SHADER", "vertices", "simRes", "BACKGROUND_FRAGMENT_SHADER", "glBg", "bgRes", "w", "h", "createTex", "tex", "readTex", "writeTex", "readFBO", "writeFBO", "dpr", "rect", "buffer", "fbo", "x", "y", "width", "height", "ndcX", "ndcY", "wX", "wY", "data", "aPos", "aUv", "aAlpha", "forceTopLayer", "layerIdx", "quadBuffer", "dt", "sizePct", "totalTime", "simTime", "safeDt", "FPS_THRESHOLD", "SUB_STEP", "steps", "remaining", "step", "stepDt", "bgState", "fgState", "aPosBg", "glFg", "aPosFg", "spawner_exports", "__export", "createSpawner", "updateMutationSnapshot", "state", "mutationUnlockedSnapshot", "mutationLevelSnapshot", "level", "plain", "easeOutCubic", "t", "f", "getImage", "src", "img", "imgCache", "playfieldSelector", "waterSelector", "coinsHost", "coinSrc", "baseCoinSize", "animationDurationMs", "surgeLifetimeMs", "surgeWidthVw", "coinsPerSecond", "perFrameBudget", "maxActiveCoins", "IS_MOBILE", "MAX_ACTIVE_COINS_MOBILE", "initialBurst", "coinTtlMs", "waveSoundSrc", "waveSoundDesktopVolume", "waveSoundMobileVolume", "waveSoundMinIntervalMs", "enableDropShadow", "currentCoinSrc", "refs", "validRefs", "NUM_LAYERS", "canvases", "contexts", "canvasDirty", "i", "canvas", "ctx", "fxCanvas", "fxCtx", "deps", "setDependencies", "d", "M", "computeMetrics", "pfRect", "wRect", "hudH", "dpr", "ro", "clamp", "v", "lo", "hi", "COIN_POOL_MAX", "COIN_MARGIN", "coinPool", "activeCoins", "garbageCount", "newlySettledBuffer", "dirtyRegions", "makeCoin", "el", "inner", "getCoin", "releaseCoin", "removeCoin", "coinObj", "knownIndex", "idx", "detachCoin", "coinEl", "waveURL", "waveLastAt", "playWaveOncePerBurst", "now", "playAudio", "planSpawn", "indexToRemove", "isSurgeActive", "c", "oldest", "pfW", "waterToPfTop", "spawnY", "sizeIndex", "r", "COIN_CHANCES", "shouldBlockBigCoins", "size", "COIN_SIZES", "effectiveMargin", "minX", "maxX", "spawnX", "drift", "endX", "mx", "effectiveWaterH", "minY", "maxY", "endY", "coin", "waterToPfLeft", "def", "WAVE_DEFS", "vw", "randScale", "waveW", "waveH", "waveCenterX", "waveCenterY", "commitBatch", "batch", "coinsFrag", "newCoins", "hasWaves", "wave", "waterSystem", "forceTop", "valMult", "nerf", "getEffectiveTsunamiNerfWithCombo", "base", "COIN_VALUE_MULTS", "forceDom", "COIN_SOUND_SUFFIXES", "CUBIC_BEZIER", "spawnBurst", "n", "plan", "getCoinState", "elapsed", "ease", "x", "y", "rot", "scale", "drawSingleSettledCoin", "drawSettledCoins", "count", "layerIdx", "pad", "cx", "cy", "cSize", "j", "cMinX", "cMaxX", "cMinY", "cMaxY", "rate", "rafId", "last", "carry", "loop", "dt", "k", "createBranchingLightning", "s", "candidates", "minDistSq", "totalCoins", "tx", "ty", "dx", "dy", "targets", "itemsToCollect", "audioPlayed", "target", "targetSize", "createTargetedBranchingLightning", "addStain", "spawnCount", "spawnTarget", "t0", "timeBudgetMs", "w", "drawFx", "start", "stop", "setRate", "clearBacklog", "clearPlayfield", "resetType", "keepBigCoins", "setCoinSprite", "getCoinTransform", "ensureCoinVisual", "findCoinTargetsInRadius", "centerX", "centerY", "radius", "useVisualHitbox", "searchRadius", "radiusSq", "limitSq", "findCoinTargetsInPath", "x1", "y1", "x2", "y2", "vx", "vy", "lenSq", "crossLimit", "wx", "wy", "dot", "hit", "cross", "removeCoinTarget", "findCoinsInRadius", "findCoinsInPath", "playEntranceWave", "bolts", "sparks", "addBolt", "sourceCoin", "targetCoin", "sSize", "tSize", "st", "angle", "startDist", "LIGHTNING_START_RADIUS_RATIO", "relStartX", "relStartY", "len", "relEndX", "relEndY", "numBranches", "bSx", "bSy", "branchAngle", "branchLen", "bEx", "bEy", "targetX", "targetY", "dist", "startX", "startY", "splitX", "splitY", "endBX", "endBY", "subSx", "subSy", "subAngle", "subLen", "b", "alpha", "segments", "perpX", "perpY", "jaggedness", "init_spawner", "__esmMin", "init_audioCache", "init_mutationSystem", "init_main", "init_surgeEffects", "init_audioManager", "init_waterSystem", "init_resetTab", "getMutationState", "onMutationChange", "snapshot", "saveIntegrity_exports", "__export", "afterSlotWrite", "beforeSlotWrite", "nowMs", "noteTrustedSlot", "slot", "ttl", "TRUSTED_MUTATION_GRACE_MS", "trustedSlotsUntil", "slotRecentlyTrusted", "expiry", "resetTrustedSlots", "hasLocalStorage", "parseSlotFromKey", "key", "match", "rebuildExpectedStateForSlot", "snapshot", "expectedStateBySlot", "i", "STORAGE_PREFIX", "keySlot", "value", "ensureExpectedStateForSlot", "integrityInternalWriteDepth", "strKey", "snapKey", "expectedValue", "actualValue", "markSaveSlotModified", "computeSignature", "entries", "hash", "entry", "collectEntriesBySlot", "map", "slotMatch", "sigKey", "getSlotSignatureKey", "getCandidateSlots", "entriesBySlot", "slots", "_", "active", "getActiveSlot", "idx", "verifySlotIntegrity", "list", "stored", "getSlotSignature", "setSlotSignature", "signature", "runIntegrityCheck", "scheduleTrustedMutationSweep", "trustedSweepTimer", "TRUSTED_SWEEP_DELAY_MS", "handleStorageMutationEvent", "event", "detail", "rawSlot", "ensureWatcher", "watcherId", "SIGNATURE_POLL_INTERVAL_MS", "getShopButtonElement", "enforcePoopShopStyle", "btn", "hasModifiedSave", "POOP_SHOP_FLAG", "POOP_SHOP_BG", "startPoopShopEnforcer", "poopShopTimer", "ev", "init", "init_saveIntegrity", "__esmMin", "init_storage", "popups_exports", "__export", "initPopups", "teardownpopups", "ensureContainer", "container", "bnFromAny", "value", "BigNum", "isZero", "bn", "updateEntry", "entry", "amountEl", "amount", "meta", "formatted", "formatNumber", "scheduleRemoval", "duration", "DEFAULT_DURATION", "activePopups", "remove", "createPopupEntry", "type", "element", "plus", "icon", "text", "showPopup", "overrides", "slot", "getActiveSlot", "isStorageKeyLocked", "CURRENCIES", "isCurrencyLocked", "baseMeta", "POPUP_META", "bnAmount", "existing", "host", "index", "POPUP_ORDER", "insertBefore", "children", "child", "childType", "getAllCurrencies", "all", "key", "getCurrency", "syncLastKnown", "lastKnownAmounts", "clearActivePopups", "handleCurrencyChange", "event", "detail", "current", "prev", "zero", "delta", "detailDelta", "handleXpChange", "xpAdded", "handleMutationChange", "nextProgress", "handleSlotChange", "initialized", "init_popups", "__esmMin", "init_bigNum", "init_numFormat", "init_storage", "suspendSafeguard_exports", "__export", "flushBackupSnapshot", "getSuspendMetadata", "installSuspendSafeguards", "markProgressDirty", "restoreFromBackupIfNeeded", "canUseIndexedDb", "canUseLocalStorage", "testKey", "STORAGE_PREFIX", "openDatabase", "dbPromise", "resolve", "reject", "resolved", "request", "DB_NAME", "DB_VERSION", "db", "STORE_NAME", "err", "captureSnapshot", "data", "captured", "i", "key", "value", "putSnapshot", "snapshot", "settled", "tx", "SNAPSHOT_KEY", "readSnapshot", "requestPersistentStorage", "captureStackTrace", "parseSlotFromKey", "match", "slot", "isTrustedStorageStack", "stack", "DEVTOOLS_CONSOLE_FRAME_RE", "notifySaveIntegrityOfStorageMutation", "strKey", "SLOT_SIGNATURE_PREFIX", "SLOT_MOD_FLAG_PREFIX", "detail", "installStorageHooks", "proto", "originalSet", "originalRemove", "originalClear", "isTrackedGameKey", "beforeSlotWrite", "result", "afterSlotWrite", "scheduleFlush", "reason", "lastDirtyReason", "dirty", "flushTimer", "reasonToUse", "FLUSH_DEBOUNCE_MS", "cancelFlushTimer", "performFlush", "pendingImmediateFlush", "ok", "immediate", "flushBeforeSuspend", "hasAnyPrefixedKeys", "restoreAttempted", "shouldRestore", "activeSlot", "coinKey", "restored", "installAttempted", "onVisibilityChange", "event", "init_suspendSafeguard", "__esmMin", "init_saveIntegrity", "globalOverlayEsc_exports", "__export", "initGlobalOverlayEsc", "handleEsc", "yields", "closedAny", "sel", "btn", "shouldYield", "closeAll", "PRIORITY_SELECTORS", "candidates", "el", "closeButton", "init_globalOverlayEsc", "__esmMin", "domInit_exports", "__export", "ensureGameDom", "layerCount", "startZ", "main", "waterLayersHtml", "i", "zIndex", "init_domInit", "__esmMin", "fpsTracker_exports", "__export", "SHOW_FPS", "initFpsTracker", "fpsDiv", "frameCount", "lastTime", "loop", "now", "elapsed", "fps", "init_fpsTracker", "__esmMin", "notifications_exports", "__export", "initNotifications", "showNotification", "unpauseNotifications", "ensureContainer", "container", "isPaused", "processQueue", "isProcessing", "queue", "text", "iconSrc", "duration", "displayNotification", "resolve", "parent", "el", "icon", "content", "playAudio", "cleanup", "id", "level", "node", "NODE_MAP", "maxLevel", "isViewingLabTab", "title", "init_notifications", "__esmMin", "init_labNodes", "init_audioManager", "init_dlgTab", "applyPendingSlotWipe", "slotStr", "suffix", "toRemove", "storage", "key", "k", "disableMobileZoomGestures", "IS_MOBILE", "lastTouchEnd", "TOUCH_DELAY_MS", "event", "now", "showLoader", "text", "onSkip", "root", "wrap", "label", "bar", "fill", "pct", "stuckMsg", "stuckTimeout", "skipBtn", "e", "setLoaderProgress", "loaderEl", "fraction", "f", "finishAndHideLoader", "onFadeStart", "finishedText", "dwellMs", "twoFrames", "onEnd", "warmImage", "url", "img", "resolve", "ghost", "preloadImages", "sources", "onEach", "src", "done", "preloadAudio", "loadAudio", "preloadFonts", "preloadAssetsWithProgress", "images", "audio", "fonts", "onProgress", "total", "bump", "tasks", "p", "enterArea", "areaID", "currentArea", "currentMusic", "menuRoot", "AREAS", "playAudio", "unpauseNotifications", "FG_LAYER_COUNT", "ensureGameDom", "waterSystem", "fgIds", "_", "i", "waterTickUnsub", "waterFrameUnsub", "registerTick", "dt", "registerFrame", "totalTime", "gameRoot", "initHudButtons", "initResetSystemGame", "initMutationSystem", "spawner", "createSpawner", "applyMutationSprite", "getMutationCoinSprite", "onMutationChangeGame", "pickup", "initCoinPickup", "applyUpgradesToSpawner", "areaKey", "getUpgAreaKey", "eff", "computeUpgradeEffects", "rate", "applyStatMultiplierOverride", "override", "cleanupUpgradesListener", "onUpgradesChanged", "initXpSystem", "DEBUG_PANEL_ACCESS", "initSlots", "installGhostTapGuard", "initGlobalGhostTap", "initGlobalOverlayEsc", "bank", "getHasOpenedSaveSlot", "setHasOpenedSaveSlot", "ensureStorageDefaults", "ensureMultiplierDefaults", "registerPreloadedAudio", "initPopups", "installSuspendSafeguards", "restoreSuspendBackup", "markProgressDirty", "flushBackupSnapshot", "setDebugPanelAccess", "startGameLoop", "notifyGameSessionStarted", "nextFrame", "init_main", "__esmMin", "init_audioManager", "detected", "r", "resolveSkip", "skipPromise", "loader", "initAudio", "modulePromise", "ASSET_MANIFEST", "progress", "assetsPromise", "slotsModule", "spawnerModule", "coinPickupModule", "hudButtonsModule", "storageModule", "saveIntegrityModule", "upgradesModule", "audioCacheModule", "xpModule", "resetModule", "mutationModule", "popupModule", "safetyModule", "guardModule", "escModule", "debugPanelModule", "gameLoopModule", "offlinePanelModule", "workshopTabModule", "automationEffectsModule", "domInitModule", "surgeEffectsModule", "waterSystemModule", "labTabModule", "fpsTrackerModule", "notificationModule", "initOfflineTracker", "processOfflineProgress", "initWorkshopSystem", "initAutomationEffects", "initSurgeEffects", "initLabLogic", "initFpsTracker", "initNotifications", "_unpause", "showNotification", "hidden", "setAudioSuspended", "titleEl", "stepDelay", "init_main"]
}
