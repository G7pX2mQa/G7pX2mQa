{
  "version": 3,
  "sources": ["../js/util/bigNum.js", "../js/util/numFormat.js", "../js/util/storage.js", "../js/util/slotsManager.js", "../js/util/slots.js", "../js/util/audioCache.js", "../js/ui/hudLayout.js", "../js/game/xpSystem.js", "../js/ui/merchantDelve/resetTab.js", "../js/game/upgrades.js", "../js/misc/merchantDialogues.js", "../js/util/ghostTapGuard.js", "../js/ui/merchantDelve/dlgTab.js", "../js/ui/shopOverlay.js", "../js/ui/hudButtons.js", "../js/util/debugPanel.js", "../js/game/mutationSystem.js", "../js/game/spawner.js", "../js/game/coinPickup.js", "../js/util/saveIntegrity.js", "../js/ui/popups.js", "../js/util/suspendSafeguard.js", "../js/main.js", "../app.js"],
  "sourcesContent": ["// js/util/bigNum.js\r\nexport class BigNum {\r\n  static DEFAULT_PRECISION = 18;\r\n  static MAX_E = 1.7976931348623157e+308; // Number.MAX_VALUE\r\n  static MAX_PLAIN_DIGITS = 1_000_000;    // safety cap for plain integer strings\r\n\r\n  constructor(sig, e, p = BigNum.DEFAULT_PRECISION) {\r\n    this.p = p | 0;\r\n    this.sig = BigInt(sig);\r\n    this._eOffset = 0n;\r\n\r\n    if (e && typeof e === 'object' && ('base' in e || 'offset' in e || 'inf' in e)) {\r\n      const base = Number(e.base ?? 0);\r\n      const inf = !!e.inf;\r\n      if (inf || !Number.isFinite(base) || base >= BigNum.MAX_E) {\r\n        this.e = BigNum.MAX_E;\r\n        this.inf = true;\r\n        this._eOffset = 0n;\r\n      } else {\r\n        this.e = Math.trunc(base);\r\n        this.inf = false;\r\n        const off = e.offset ?? 0;\r\n        this._eOffset = typeof off === 'bigint' ? off : BigInt(off);\r\n      }\r\n    } else {\r\n      const ee = Number(e);\r\n      if (!Number.isFinite(ee) || ee >= BigNum.MAX_E) {\r\n        this.e = BigNum.MAX_E;\r\n        this.inf = true;\r\n      } else {\r\n        this.e = Math.trunc(ee);\r\n        this.inf = false;\r\n      }\r\n    }\r\n    this.#normalize();\r\n  }\r\n\r\n  // ---------------------- FACTORIES ----------------------\r\n  static zero(p = BigNum.DEFAULT_PRECISION) { return new BigNum(0n, 0, p); }\r\n\r\n  static fromInt(n, p = BigNum.DEFAULT_PRECISION) {\r\n    return new BigNum(BigInt(n), 0, p);\r\n  }\r\n\r\n  static fromScientific(str, p = BigNum.DEFAULT_PRECISION) {\r\n    const s = String(str ?? '').trim();\r\n    if (!s) throw new TypeError('Invalid BigNum input: ' + str);\r\n\r\n    if (/^inf(?:inity)?$/i.test(s)) {\r\n      return new BigNum(1n, BigNum.MAX_E, p);\r\n    }\r\n\r\n    const match = s.match(/^(\\d+)(?:\\.(\\d+))?(?:e([+-]?\\d+))?$/i);\r\n    if (!match) {\r\n      return new BigNum(BigInt(s), 0, p);\r\n    }\r\n\r\n    let [, intPart, fracPart = '', expPart] = match;\r\n    let exponent = expPart ? parseInt(expPart, 10) : 0;\r\n    exponent -= fracPart.length;\r\n\r\n    const digits = (intPart + fracPart).replace(/^0+/, '') || '0';\r\n    const sig = BigInt(digits);\r\n    return new BigNum(sig, exponent, p);\r\n  }\r\n\r\n  static fromStorage(str, p = BigNum.DEFAULT_PRECISION) {\r\n    if (!str) return null;\r\n    if (typeof str !== 'string') str = String(str);\r\n    if (str.startsWith('BN:')) {\r\n      const [, pStr, sigStr, eStr] = str.split(':');\r\n      const pp = parseInt(pStr, 10) || p;\r\n      let baseStr = eStr;\r\n      let offset = 0n;\r\n      const caret = eStr.indexOf('^');\r\n      if (caret >= 0) {\r\n        baseStr = eStr.slice(0, caret);\r\n        const offStr = eStr.slice(caret + 1) || '0';\r\n        try { offset = BigInt(offStr); }\r\n        catch { offset = 0n; }\r\n      }\r\n      let eNum = Number(baseStr);\r\n      if (!Number.isFinite(eNum)) eNum = BigNum.MAX_E;\r\n      return new BigNum(BigInt(sigStr), { base: eNum, offset }, pp);\r\n    }\r\n    return BigNum.fromScientific(str, p);\r\n  }\r\n\r\n  // Accepts: BigNum | \"BN:...\" | scientific string | number | bigint\r\n  static fromAny(input, p = BigNum.DEFAULT_PRECISION) {\r\n    if (input instanceof BigNum) return input;\r\n    if (typeof input === 'string') {\r\n      const trimmed = input.trim();\r\n      if (trimmed.startsWith('BN:')) return BigNum.fromStorage(trimmed, p);\r\n      if (/^inf(?:inity)?$/i.test(trimmed)) return new BigNum(1n, BigNum.MAX_E, p);\r\n      if (/^\\d+(?:\\.\\d+)?(?:e[+-]?\\d+)?$/i.test(trimmed)) return BigNum.fromScientific(trimmed, p);\r\n    }\r\n    if (typeof input === 'number') {\r\n      if (!Number.isFinite(input)) return new BigNum(1n, BigNum.MAX_E, p);\r\n      return BigNum.fromScientific(input.toString(), p);\r\n    }\r\n    if (typeof input === 'bigint') return BigNum.fromInt(input, p);\r\n    throw new TypeError('Unsupported BigNum input: ' + input);\r\n    }\r\n\r\n  // ---------------------- PERSISTENCE ----------------------\r\n  toStorage() {\r\n    if (this.inf) return `BN:${this.p}:${this.sig.toString()}:${BigNum.MAX_E}`;\r\n    const offsetSuffix = this._eOffset !== 0n ? `^${this._eOffset.toString()}` : '';\r\n    return `BN:${this.p}:${this.sig.toString()}:${this.e}${offsetSuffix}`;\r\n  }\r\n\r\n  clone() {\r\n    return new BigNum(this.sig, { base: this.e, offset: this._eOffset, inf: this.inf }, this.p);\r\n  }\r\n\r\n  // ---------------------- STATE QUERIES ----------------------\r\n  isZero() { return !this.inf && this.sig === 0n; }\r\n  isInfinite() { return !!this.inf; }\r\n  isNegative() { return false; }\r\n\r\n  sub(b) {\r\n    b = BigNum.fromAny(b, this.p);\r\n\r\n    if (this.inf) {\r\n      if (b.inf) return BigNum.zero(this.p);\r\n      return this.clone();\r\n    }\r\n    if (b.inf) return BigNum.zero(this.p);\r\n\r\n    if (this.cmp(b) <= 0) return BigNum.zero(this.p);\r\n\r\n    const expCmp = this.#compareExponent(b);\r\n    if (expCmp >= 0) {\r\n      const aligned = expCmp === 0 ? b.sig : this.#alignSig(b);\r\n      const diffSig = this.sig - aligned;\r\n      if (diffSig > 0n) {\r\n        return new BigNum(diffSig, this.#expObj(), this.p);\r\n      }\r\n    }\r\n\r\n    try {\r\n      const aPlain = this.toPlainIntegerString();\r\n      const bPlain = b.toPlainIntegerString();\r\n      if (aPlain === 'Infinity') return this.clone();\r\n      if (bPlain === 'Infinity') return BigNum.zero(this.p);\r\n      const diff = BigInt(aPlain) - BigInt(bPlain);\r\n      if (diff <= 0n) return BigNum.zero(this.p);\r\n      return BigNum.fromInt(diff, this.p);\r\n    } catch {\r\n      return BigNum.zero(this.p);\r\n    }\r\n  }\r\n\r\n  // ---------------------- PRIVATE HELPERS ----------------------\r\n  #pow10(k) { return k <= 0 ? 1n : 10n ** BigInt(k); }\r\n\r\n  #expObj() {\r\n    return { base: this.e, offset: this._eOffset, inf: this.inf };\r\n  }\r\n\r\n  #adjustExponent(delta) {\r\n    if (this.inf || !delta) return;\r\n    const prev = this.e;\r\n    const next = prev + delta;\r\n    this.e = Math.trunc(next);\r\n    const applied = this.e - prev;\r\n    const leftover = BigInt(delta - applied);\r\n    if (leftover) this._eOffset += leftover;\r\n  }\r\n\r\n  #totalExponentBigInt() {\r\n    if (this.inf) return this._eOffset >= 0n ? BigInt(Number.MAX_SAFE_INTEGER) : -BigInt(Number.MAX_SAFE_INTEGER);\r\n    const base = BigInt(Math.trunc(this.e));\r\n    return base + this._eOffset;\r\n  }\r\n\r\n  #compareExponent(other) {\r\n    if (this.inf || other.inf) {\r\n      if (this.inf && other.inf) return 0;\r\n      return this.inf ? 1 : -1;\r\n    }\r\n    const a = this.#totalExponentBigInt();\r\n    const b = other.#totalExponentBigInt();\r\n    if (a > b) return 1;\r\n    if (a < b) return -1;\r\n    return 0;\r\n  }\r\n\r\n  #expDiff(other) {\r\n    if (this.inf || other.inf) {\r\n      if (this.inf && other.inf) return 0n;\r\n      return this.inf ? BigInt(this.p + 3) : -BigInt(this.p + 3);\r\n    }\r\n    const diff = this.#totalExponentBigInt() - other.#totalExponentBigInt();\r\n    const absDiff = diff < 0n ? -diff : diff;\r\n    const limit = BigInt(this.p + 2);\r\n    if (absDiff > limit) {\r\n      return diff > 0n ? BigInt(this.p + 3) : -BigInt(this.p + 3);\r\n    }\r\n    return diff;\r\n  }\r\n\r\n  #offsetAsNumber() {\r\n    if (this._eOffset === 0n) return 0;\r\n    const offNum = Number(this._eOffset);\r\n    if (!Number.isFinite(offNum) || !Number.isSafeInteger(offNum)) {\r\n      return offNum > 0 ? Number.POSITIVE_INFINITY : Number.NEGATIVE_INFINITY;\r\n    }\r\n    return offNum;\r\n  }\r\n\r\n  #effectiveExponentNumber() {\r\n    if (this.inf) return Number.POSITIVE_INFINITY;\r\n    const offset = this.#offsetAsNumber();\r\n    if (!Number.isFinite(offset)) return this.e;\r\n    return this.e + offset;\r\n  }\r\n\r\n  #normalize() {\r\n    if (this.inf) return;\r\n    if (this.sig === 0n) { this.e = 0; return; }\r\n\r\n    let s = this.sig;\r\n    const p = this.p;\r\n    const d = s.toString().length;\r\n    const shift = d - p;\r\n\r\n    if (shift > 0) {\r\n      const base = this.#pow10(shift);\r\n      let q = s / base;\r\n      const r = s % base;\r\n      if (r * 2n >= base) q += 1n; // round half up\r\n      s = q;\r\n      this.#adjustExponent(shift);\r\n      if (this.e >= BigNum.MAX_E) { this.e = BigNum.MAX_E; this.inf = true; return; }\r\n      if (s.toString().length > p) { // carry overflow\r\n        s = s / 10n;\r\n        this.#adjustExponent(1);\r\n        if (this.e >= BigNum.MAX_E) { this.e = BigNum.MAX_E; this.inf = true; return; }\r\n      }\r\n    } else if (shift < 0) {\r\n      const k = -shift;\r\n      s = s * this.#pow10(k);\r\n      this.#adjustExponent(-k);\r\n    }\r\n\r\n    this.sig = s;\r\n  }\r\n\r\n  #alignSig(other) {\r\n    const diff = this.#expDiff(other);\r\n    const absDiff = diff < 0n ? -diff : diff;\r\n    if (absDiff === 0n) return other.sig;\r\n    if (absDiff > BigInt(this.p + 2)) return 0n; // negligible\r\n    const diffNum = Number(absDiff);\r\n    const base = this.#pow10(diffNum);\r\n    let q = other.sig / base;\r\n    const r = other.sig % base;\r\n    if (r * 2n >= base) q += 1n;\r\n    return q;\r\n  }\r\n\r\n  // ---------------------- ARITHMETIC ----------------------\r\n   add(b) {\r\n    b = BigNum.fromAny(b, this.p);\r\n    if (this.inf || b.inf) {\r\n      const out = this.clone(); out.inf = this.inf || b.inf; out.e = BigNum.MAX_E; return out;\r\n    }\r\n    if (this.isZero()) return b.clone();\r\n    if (b.isZero()) return this.clone();\r\n    if (this.#compareExponent(b) >= 0) {\r\n      return new BigNum(this.sig + this.#alignSig(b), this.#expObj(), this.p);\r\n    }\r\n    return b.add(this);\r\n  }\r\n\r\n  iadd(b) { const r = this.add(b); this.sig = r.sig; this.e = r.e; this._eOffset = r._eOffset; this.inf = r.inf; return this; }\r\n\r\n  mulSmall(k) {\r\n    if (k < 0) throw new Error('BigNum only supports non-negative values');\r\n    if (this.inf) return this.clone();\r\n    if (k === 0) return BigNum.zero(this.p);\r\n    if (k === 1) return this.clone();\r\n    const out = new BigNum(this.sig * BigInt(k), this.#expObj(), this.p);\r\n    return out;\r\n  }\r\n\r\n  imulSmall(k) { const r = this.mulSmall(k); this.sig = r.sig; this.e = r.e; this._eOffset = r._eOffset; this.inf = r.inf; return this; }\r\n\r\n  // Multiply by another non-negative integer BigNum (exact).\r\n  mulBigNumInteger(other) {\r\n    const b = BigNum.fromAny(other, this.p);\r\n    if (this.inf || b.inf) {\r\n      const out = this.clone();\r\n      out.inf = this.inf || b.inf;\r\n      out.e = BigNum.MAX_E;\r\n      return out;\r\n    }\r\n    if (this.isZero() || b.isZero()) return BigNum.zero(this.p);\r\n    const baseSum = this.e + b.e;\r\n    const offsetSum = this._eOffset + b._eOffset;\r\n    return new BigNum(this.sig * b.sig, { base: baseSum, offset: offsetSum }, this.p);\r\n  }\r\n\r\n  imulBigNumInteger(other) {\r\n    const r = this.mulBigNumInteger(other);\r\n    this.sig = r.sig; this.e = r.e; this._eOffset = r._eOffset; this.inf = r.inf;\r\n    return this;\r\n  }\r\n\r\n  cmp(b) {\r\n    b = BigNum.fromAny(b, this.p);\r\n    if (this.inf || b.inf) return this.inf === b.inf ? 0 : this.inf ? 1 : -1;\r\n    const thisIsZero = this.isZero();\r\n    const otherIsZero = typeof b.isZero === 'function' ? b.isZero() : false;\r\n    if (thisIsZero || otherIsZero) {\r\n      if (thisIsZero && otherIsZero) return 0;\r\n      return thisIsZero ? -1 : 1;\r\n    }\r\n    const expCmp = this.#compareExponent(b);\r\n    if (expCmp !== 0) return expCmp;\r\n    if (this.sig === b.sig) return 0;\r\n    return this.sig > b.sig ? 1 : -1;\r\n  }\r\n  // ----- Decimal multiply (exact, integer-safe) & flooring -----\r\n\r\n  // Parse decimal like \"2.345\" (or number) into { numer: BigInt, scale: int } with up to maxScale frac digits.\r\n  static _parseDecimalMultiplier(x, maxScale = BigNum.DEFAULT_PRECISION) {\r\n    let s = (typeof x === 'number') ? String(x) : String(x ?? '').trim();\r\n    if (!s || s === '0') return { numer: 0n, scale: 0 };\r\n\r\n    // normalize scientific like \"1e3\" to fixed decimal string\r\n    if (/e/i.test(s)) {\r\n      const n = Number(s);\r\n      if (!Number.isFinite(n) || n < 0) throw new TypeError('Invalid multiplier: ' + s);\r\n      const digits = Math.min(maxScale, 18);\r\n      s = n.toFixed(digits).replace(/\\.?0+$/, ''); // strip trailing zeros\r\n    }\r\n\r\n    if (!/^\\d+(\\.\\d+)?$/.test(s)) throw new TypeError('Invalid multiplier: ' + s);\r\n\r\n    const [intPart, fracRaw = ''] = s.split('.');\r\n    const frac = fracRaw.slice(0, maxScale); // clamp fractional length\r\n    const scale = frac.length;\r\n    const numer = BigInt(intPart + frac);\r\n    return { numer, scale };\r\n  }\r\n\r\n  // Multiply by decimal multiplier given as number/string with up to 18 fractional digits (returns new BigNum).\r\n  mulDecimal(mult, maxScale = BigNum.DEFAULT_PRECISION) {\r\n    if (this.inf || this.isZero()) return this.clone();\r\n    const { numer, scale } = BigNum._parseDecimalMultiplier(mult, maxScale);\r\n    if (numer === 0n) return BigNum.zero(this.p);\r\n    return this.mulScaledInt(numer, scale);\r\n  }\r\n\r\n  // Floor to integer value by dropping fractional digits.\r\n  floorToInteger() {\r\n    if (this.inf) return this.clone();\r\n    if (this.isZero()) return this.clone();\r\n    const exp = this.#effectiveExponentNumber();\r\n    if (!Number.isFinite(exp)) return this.clone();\r\n    const intDigits = exp + this.p; // integer digits in the value\r\n    if (intDigits <= 0) return BigNum.zero(this.p); // < 1\r\n    if (intDigits >= this.p) return this.clone();   // already integral\r\n    const drop = this.p - intDigits;                // digits to truncate\r\n    const base = 10n ** BigInt(drop);\r\n    const newSig = (this.sig / base) * base;        // drop fractional digits\r\n    return new BigNum(newSig, this.#expObj(), this.p);\r\n  }\r\n\r\n  // Convenience: multiply by decimal and floor to integer immediately.\r\n  mulDecimalFloor(mult, maxScale = BigNum.DEFAULT_PRECISION) {\r\n    return this.mulDecimal(mult, maxScale).floorToInteger();\r\n  }\r\n\r\n  mulScaledInt(numerBigInt, scale) {\r\n    if (this.inf || this.isZero()) return this.clone();\r\n    const nb = BigInt(numerBigInt);\r\n    if (nb === 0n) return BigNum.zero(this.p);\r\n    return new BigNum(this.sig * nb, this.e - (scale | 0), this.p);\r\n  }\r\n\r\n  // Same as above but floors to an integer.\r\n  mulScaledIntFloor(numerBigInt, scale) {\r\n    return this.mulScaledInt(numerBigInt, scale).floorToInteger();\r\n  }\r\n\r\n  // ---------------------- FORMATTING ----------------------\r\n  get decExp() {\r\n    if (this.inf) return Number.POSITIVE_INFINITY;\r\n    const exp = this.#effectiveExponentNumber();\r\n    if (!Number.isFinite(exp)) return this.e + (this.p - 1);\r\n    return exp + (this.p - 1);\r\n  }\r\n\r\n  toScientific(digits = 3) {\r\n    if (this.inf) return 'Infinity';\r\n    if (this.isZero()) return '0';\r\n    const s = this.sig.toString().padStart(this.p, '0');\r\n    const head = s[0];\r\n    const tail = s.slice(1, 1 + digits).replace(/0+$/g, '');\r\n    const mant = tail ? `${head}.${tail}` : head;\r\n    const exp = this.#effectiveExponentNumber();\r\n    const E = Number.isFinite(exp) ? (exp + (this.p - 1)) : (this.e + (this.p - 1));\r\n    return `${mant}e${E}`;\r\n  }\r\n\r\n  toPlainIntegerString() {\r\n    if (this.inf) return 'Infinity';\r\n    if (this.isZero()) return '0';\r\n    const exp = this.#effectiveExponentNumber();\r\n    if (!Number.isFinite(exp)) return 'Infinity';\r\n    const intDigits = exp + this.p;\r\n    if (intDigits <= 0) return '0';\r\n    if (intDigits > BigNum.MAX_PLAIN_DIGITS) return 'Infinity';\r\n\r\n    const s = this.sig.toString().padStart(this.p, '0');\r\n    if (intDigits <= this.p) {\r\n      return s.slice(0, intDigits).replace(/^0+/, '') || '0';\r\n    }\r\n\r\n    const extraZeros = intDigits - this.p;\r\n    return (s + '0'.repeat(extraZeros)).replace(/^0+/, '') || '0';\r\n  }\r\n\r\n  toString() {\r\n    return this.toPlainIntegerString();\r\n  }\r\n}\r\n", "// js/util/numFormat.js\r\n// Policy:\r\n//  - < 1e6: plain integer using the user's locale (grouping)\r\n//  - 1e6 .. < 1e303: suffix table (\"M,B,T,Qd,...\") with FOUR visible digits\r\n//  - >= 1e303: scientific, but with a pretty *recursive* exponent\r\n//\r\n// Also prettifies the exponent itself (e.g., 1.000e1,000 / 1.000e1.000Qd / 1.000e1.000e308)\r\n\r\nimport { BigNum } from './bigNum.js';\r\n\r\n// Suffixes copied from CCC (descending exponents).\r\nconst SUFFIX_ENTRIES = [\r\n  [300,'NoNg'],[297,'OcNg'],[294,'SpNg'],[291,'SxNg'],[288,'QnNg'],[285,'QdNg'],[282,'TNg'],[279,'DNg'],[276,'UNg'],[273,'Ng'],\r\n  [270,'NoOg'],[267,'OcOg'],[264,'SpOg'],[261,'SxOg'],[258,'QnOg'],[255,'QdOg'],[252,'TOg'],[249,'DOg'],[246,'UOg'],[243,'Og'],\r\n  [240,'NoSg'],[237,'OcSg'],[234,'SpSg'],[231,'SxSg'],[228,'QnSg'],[225,'QdSg'],[222,'TSg'],[219,'DSg'],[216,'USg'],[213,'Sg'],\r\n  [210,'Nosg'],[207,'Ocsg'],[204,'Spsg'],[201,'Sxsg'],[198,'Qnsg'],[195,'Qdsg'],[192,'Tsg'],[189,'Dsg'],[186,'Usg'],[183,'sg'],\r\n  [180,'NoQg'],[177,'OcQg'],[174,'SpQg'],[171,'SxQg'],[168,'QnQg'],[165,'QdQg'],[162,'TQg'],[159,'DQg'],[156,'UQg'],[153,'Qg'],\r\n  [150,'Noqg'],[147,'Ocqg'],[144,'Spqg'],[141,'Sxqg'],[138,'Qnqg'],[135,'Qdqg'],[132,'Tqg'],[129,'Dqg'],[126,'Uqg'],[123,'qg'],\r\n  [120,'NoTg'],[117,'OcTg'],[114,'SpTg'],[111,'SxTg'],[108,'QnTg'],[105,'QdTg'],[102,'TTg'],[99,'DTg'],[96,'UTg'],[93,'Tg'],\r\n  [90,'NoVt'],[87,'OcVt'],[84,'SpVt'],[81,'SxVt'],[78,'QnVt'],[75,'QdVt'],[72,'TVt'],[69,'DVt'],[66,'UVt'],[63,'Vt'],\r\n  [60,'NoDe'],[57,'OcDe'],[54,'SpDe'],[51,'SxDe'],[48,'QnDe'],[45,'QdDe'],[42,'TDe'],[39,'DDe'],[36,'UDe'],[33,'De'],\r\n  [30,'No'],[27,'Oc'],[24,'Sp'],[21,'Sx'],[18,'Qn'],[15,'Qd'],[12,'T'],[9,'B'],[6,'M']\r\n];\r\nconst SUFFIX_BY_EXP = new Map(SUFFIX_ENTRIES);\r\n\r\nconst NF_INT = new Intl.NumberFormat(undefined, { maximumFractionDigits: 0, useGrouping: true });\r\nfunction localeInt(s) {\r\n  const num = Number(s);\r\n\r\n  // Safari throws a RangeError when formatting non-finite values via Intl.NumberFormat;\r\n  // treat them as plain strings instead so the UI doesn't silently break on mobile.\r\n  if (!Number.isFinite(num)) return String(s);\r\n\r\n  try { return NF_INT.format(num); }\r\n  catch { return String(s); }\r\n}\r\n\r\n// --- add 1 to a decimal digit-string (for rounding) ---\r\nfunction addOneDigitString(str){\r\n  let carry = 1, a = str.split('');\r\n  for (let i = a.length - 1; i >= 0 && carry; i--) {\r\n    let d = a[i].charCodeAt(0) - 48 + carry;\r\n    carry = d >= 10 ? 1 : 0;\r\n    a[i] = String.fromCharCode(48 + (d % 10));\r\n  }\r\n  if (carry) a.unshift('1');\r\n  return a.join('');\r\n}\r\n\r\nfunction formatExponentString(rawDigits, sign = '') {\r\n  let ds = (rawDigits || '').replace(/^0+/, '') || '0';\r\n\r\n  if (ds.length < 4) return sign + localeInt(ds);          // < 1,000\r\n  if (ds.length <= 7) {                                     // 1,000 .. 1,000,000\r\n    const n = Number(ds);\r\n    if (Number.isFinite(n) && n <= 1_000_000) return sign + NF_INT.format(n);\r\n  }\r\n\r\n  const E = ds.length - 1;\r\n\r\n  if (E <= 300) {\r\n    const exp = Math.floor(E / 3) * 3;\r\n    const suffix = SUFFIX_BY_EXP.get(exp) || '';\r\n    const d = E - exp;              // 0..2\r\n    const intDigits = d + 1;        // 1..3\r\n    const decimals = 4 - intDigits; // to keep FOUR visible digits\r\n    const totalDigits = intDigits + decimals;\r\n\r\n    if (ds.length < totalDigits + 1) ds += '0'.repeat(totalDigits + 1 - ds.length);\r\n    let head = ds.slice(0, totalDigits);\r\n    const nextDigit = ds.charCodeAt(totalDigits) || 48;\r\n    if (nextDigit >= 53) head = addOneDigitString(head);\r\n\r\n    let intStr, fracStr;\r\n    if (head.length > totalDigits) { intStr = head.slice(0, intDigits + 1); fracStr = '0'.repeat(decimals); }\r\n    else { intStr = head.slice(0, intDigits); fracStr = head.slice(intDigits); }\r\n\r\n    return sign + `${intStr}${decimals ? '.' + fracStr : ''}${suffix}`;\r\n  }\r\n\r\n  // Beyond our table: show scientific-within-exponent with FOUR-digit mantissa\r\n  const totalDigits = 4; // 1 integer + 3 decimals\r\n  if (ds.length < totalDigits + 1) ds += '0'.repeat(totalDigits + 1 - ds.length);\r\n  let head = ds.slice(0, totalDigits);\r\n  const nextDigit = ds.charCodeAt(totalDigits) || 48;\r\n  if (nextDigit >= 53) head = addOneDigitString(head);\r\n\r\n  const mantInt  = head.slice(0, 1);\r\n  const mantFrac = head.slice(1);\r\n  return sign + `${mantInt}.${mantFrac}e` + formatExponentString(String(E));\r\n}\r\n\r\nfunction formatPowerOf10Exponent(kDigits, sign = '') {\r\n  // Fast path to detect k \u2265 303 without bigints\r\n  let ge303 = false, k = 0;\r\n  if (kDigits.length > 3) ge303 = true;\r\n  else { k = parseInt(kDigits || '0', 10) || 0; ge303 = (k >= 303); }\r\n\r\n  if (ge303) {\r\n    // Scientific inside exponent; pretty-format k itself (locale + suffix rules)\r\n    return sign + '1.000e' + formatExponentString(kDigits);\r\n  }\r\n\r\n  // 0..302 \u2192 suffix tier plus remainder-driven mantissa\r\n  const exp = Math.floor(k / 3) * 3;          // 0,3,6,...,300\r\n  const suffix = SUFFIX_BY_EXP.get(exp) || '';\r\n\r\n  const remainder = k - exp;                   // 0,1,2\r\n  // FOUR visible digits before the suffix:\r\n  //  r=0 \u2192 \"1.000\", r=1 \u2192 \"10.00\", r=2 \u2192 \"100.0\"\r\n  const intPart   = (remainder === 0) ? '1' : (remainder === 1) ? '10' : '100';\r\n  const decimals  = 4 - (remainder + 1);      // 3,2,1\r\n  const fracPart  = decimals ? ('.' + '0'.repeat(decimals)) : '';\r\n\r\n  return sign + intPart + fracPart + suffix;\r\n}\r\n\r\nfunction formatExponentChain(expRaw) {\r\n  expRaw = String(expRaw).trim();\r\n\r\n  // Optional leading sign on the whole exponent; suppress '+'\r\n  let topSign = '';\r\n  if (expRaw[0] === '+' || expRaw[0] === '-') {\r\n    topSign = (expRaw[0] === '-') ? '-' : '';\r\n    expRaw = expRaw.slice(1);\r\n  }\r\n\r\n  // Case A: pure digits (e.g., \"...e305\") \u2192 delegate to our big-int pretty printer\r\n  if (/^\\d+$/.test(expRaw)) return topSign + formatExponentString(expRaw);\r\n\r\n  // Case B: scientific inside the exponent: \"m e \u00B1 k\"\r\n  const m = expRaw.match(/^(\\d+)(?:\\.(\\d+))?e([+-]?)(\\d+)$/i);\r\n  if (!m) return topSign + expRaw; // unknown form \u2192 keep as-is\r\n\r\n  const [, int, frac = '', sign2, kDigits] = m;\r\n\r\n  // Is k >= 303? (length check avoids unsafe parse)\r\n  let kGe303 = false, k = 0;\r\n  if (kDigits.length > 3) kGe303 = true;\r\n  else { k = parseInt(kDigits || '0', 10) || 0; kGe303 = (k >= 303); }\r\n\r\n  // First, compute a FOUR-digit mantissa from m (rounded)\r\n  // We'll shift the decimal by (k % 3) for suffix-tiers.\r\n  let ds = (int + frac).replace(/^0+/, '') || '0';\r\n  if (ds.length < 5) ds += '0'.repeat(5 - ds.length);\r\n  let four = ds.slice(0, 4);\r\n  const next = ds.charCodeAt(4) || 48;\r\n  if (next >= 53) four = addOneDigitString(four); // handle rounding carry later\r\n\r\n  if (kGe303) {\r\n    // Beyond our suffix table inside the exponent \u2192 scientific-of-exponent\r\n    // Keep the (rounded) exponent mantissa (\"3.617\") and pretty-format k itself.\r\n    const mant = four.slice(0,1) + '.' + four.slice(1);\r\n    const sign2Prefix = (sign2 === '-') ? '-' : '';\r\n    return topSign + mant + 'e' + formatExponentString(kDigits, sign2Prefix);\r\n  }\r\n\r\n  // Within our suffix table: choose suffix and place the decimal based on remainder\r\n  const exp = Math.floor(k / 3) * 3;          // 0,3,6,...,300\r\n  const suffix = SUFFIX_BY_EXP.get(exp) || '';\r\n  const remainder = k - exp;                   // 0,1,2\r\n\r\n  // Shift decimal: r=0 \u2192 \"1.234\", r=1 \u2192 \"12.34\", r=2 \u2192 \"123.4\"\r\n  const intDigits = remainder + 1;             // 1..3\r\n  const decimals  = 4 - intDigits;             // 3..1\r\n  let intStr, fracStr;\r\n  if (four.length > 4) { // carry overflow \u2192 one extra int digit, pad decimals with zeros\r\n    intStr = four.slice(0, intDigits + 1);\r\n    fracStr = '0'.repeat(decimals);\r\n  } else {\r\n    intStr = four.slice(0, intDigits);\r\n    fracStr = four.slice(intDigits);\r\n  }\r\n\r\n  const sign2Prefix = (sign2 === '-') ? '-' : '';\r\n  return topSign + sign2Prefix + intStr + (decimals ? ('.' + fracStr) : '') + suffix;\r\n}\r\n\r\n /* Ensures the mantissa is always  4 digits */\r\nfunction mantissaFourDigits(sci) {\r\n  const i = sci.toLowerCase().indexOf('e');\r\n  if (i < 0) return sci;\r\n\r\n  // --- Normalize mantissa to exactly 4 significant digits (1.xxx) with rounding ---\r\n  const rawMant = sci.slice(0, i);           // e.g., \"3.2\", \"12.34\" (should be 1.x form from toScientific)\r\n  // Build digit string (no dot)\r\n  let ds = rawMant.replace('.', '');\r\n  if (!/^\\d+$/.test(ds)) return sci;         // safety: if parsing failed, bail out\r\n\r\n  // Pad to at least 5 digits (4 kept + 1 for rounding)\r\n  if (ds.length < 5) ds += '0'.repeat(5 - ds.length);\r\n\r\n  // First 4 digits are kept (rounded by the 5th)\r\n  let head = ds.slice(0, 4);\r\n  const next = ds.charCodeAt(4) || 48;       // '0' if missing\r\n  if (next >= 53) head = addOneDigitString(head);\r\n\r\n  // If carry overflow happened (e.g., 9.999 -> 10.00), re-normalize to 1.xxx by shifting\r\n  if (head.length > 4) head = head.slice(0, 4); // head is now \"1000\" after carry; that still prints as \"1.000\" below\r\n\r\n  const mantissa = head.slice(0,1) + '.' + head.slice(1); // \"1.234\" style with trailing zeros preserved\r\n\r\n  // --- Pretty-format the exponent tail (can be \"305\" or \"1e+100\" etc.) ---\r\n  const rawExp = sci.slice(i + 1);\r\n  return mantissa + 'e' + formatExponentChain(rawExp);\r\n}\r\n\r\n// Public API\r\nexport function formatNumber(bn){\r\n  if (!(bn instanceof BigNum)) return String(bn);\r\n  if (bn.isInfinite && bn.isInfinite()) return '<span class=\"infinity-symbol\">\u221E</span>';\r\n  if (bn.isZero()) return '0';\r\n\r\n  const E = bn.decExp ?? (bn.e + (bn.p - 1)); // decimal exponent\r\n\r\n  // Scientific for >= 1e303 (but pretty-print the exponent chain)\r\n  if (E >= 303) {\r\n    return mantissaFourDigits(bn.toScientific(3));\r\n  }\r\n\r\n  // Plain integers < 1e6 \u2192 locale grouping\r\n  if (E < 6) {\r\n    return localeInt(bn.toPlainIntegerString());\r\n  }\r\n\r\n  // Suffix formatting using the legacy table\r\n  const exp = Math.floor(E / 3) * 3;\r\n  const suffix = SUFFIX_BY_EXP.get(exp);\r\n  if (!suffix) return mantissaFourDigits(bn.toScientific(3));\r\n\r\n  const d = E - exp;                 // 0..2\r\n  const intDigits = d + 1;           // 1..3\r\n  const decimals  = 4 - intDigits;   // make FOUR visible digits\r\n  const totalDigits = intDigits + decimals;\r\n\r\n  let s = bn.sig.toString().padStart(bn.p, '0');\r\n  if (s.length < totalDigits + 1) s += '0'.repeat(totalDigits + 1 - s.length);\r\n\r\n  let head = s.slice(0, totalDigits);\r\n  const nextDigit = s.charCodeAt(totalDigits) || 48;\r\n  if (nextDigit >= 53) head = addOneDigitString(head);\r\n\r\n  let intStr, fracStr;\r\n  if (head.length > totalDigits) { intStr = head.slice(0, intDigits + 1); fracStr = '0'.repeat(decimals); }\r\n  else { intStr = head.slice(0, intDigits); fracStr = head.slice(intDigits); }\r\n\r\n  return `${intStr}${decimals ? '.' + fracStr : ''}${suffix}`;\r\n}\r\n", "// js/util/storage.js\r\nimport { BigNum } from '../util/bigNum.js';\r\nimport { formatNumber } from '../util/numFormat.js';\r\n\r\nconst PREFIX = 'ccc:';\r\nexport const STORAGE_PREFIX = PREFIX;\r\n\r\nconst SLOT_SIGNATURE_PREFIX = `${PREFIX}slotSig`;\r\nconst SLOT_MODIFIED_PREFIX = `${PREFIX}slotMod`;\r\n\r\nconst MULT_SCALE = 18;\r\nconst MULT_SCALE_TAG = 'XM:';\r\n\r\nconst STORAGE_WATCH_INTERVAL_MS = 140;\r\n\r\nconst storageWatchers = new Map();\r\nlet storageWatcherTimer = null;\r\n\r\nconst currencyChangeSubscribers = new Set();\r\n\r\nfunction normalizeSlotValue(slot) {\r\n  const n = parseInt(slot, 10);\r\n  return Number.isFinite(n) && n > 0 ? n : null;\r\n}\r\n\r\nfunction slotSignatureKey(slot) {\r\n  const normalized = normalizeSlotValue(slot);\r\n  if (normalized == null) return null;\r\n  return `${SLOT_SIGNATURE_PREFIX}:${normalized}`;\r\n}\r\n\r\nfunction slotModifiedKey(slot) {\r\n  const normalized = normalizeSlotValue(slot);\r\n  if (normalized == null) return null;\r\n  return `${SLOT_MODIFIED_PREFIX}:${normalized}`;\r\n}\r\n\r\nfunction notifyCurrencySubscribers(detail = {}) {\r\n  if (currencyChangeSubscribers.size === 0) return;\r\n  currencyChangeSubscribers.forEach((entry) => {\r\n    if (!entry || typeof entry.handler !== 'function') return;\r\n    if (entry.key && detail.key && entry.key !== detail.key) return;\r\n    if (entry.slot != null && detail.slot != null && entry.slot !== detail.slot) return;\r\n    try { entry.handler(detail); }\r\n    catch {}\r\n  });\r\n}\r\n\r\nexport function onCurrencyChange(handler, { key = null, slot = null } = {}) {\r\n  if (typeof handler !== 'function') {\r\n    return () => {};\r\n  }\r\n  const entry = {\r\n    handler,\r\n    key: key ?? null,\r\n    slot: slot ?? null,\r\n  };\r\n  currencyChangeSubscribers.add(entry);\r\n  return () => {\r\n    currencyChangeSubscribers.delete(entry);\r\n  };\r\n}\r\n\r\nfunction ensureStorageWatcherTimer() {\r\n  if (storageWatcherTimer != null || storageWatchers.size === 0) return;\r\n  const root = typeof window !== 'undefined' ? window : globalThis;\r\n  storageWatcherTimer = root.setInterval(runStorageWatchers, STORAGE_WATCH_INTERVAL_MS);\r\n}\r\n\r\nfunction stopStorageWatcherTimerIfIdle() {\r\n  if (storageWatchers.size !== 0 || storageWatcherTimer == null) return;\r\n  const root = typeof window !== 'undefined' ? window : globalThis;\r\n  root.clearInterval(storageWatcherTimer);\r\n  storageWatcherTimer = null;\r\n}\r\n\r\nfunction parseWith(entry, raw) {\r\n  if (!entry || typeof entry.parse !== 'function') return raw;\r\n  try {\r\n    return entry.parse(raw);\r\n  } catch {\r\n    return raw;\r\n  }\r\n}\r\n\r\nfunction valuesEqual(entry, a, b) {\r\n  if (!entry || typeof entry.equals !== 'function') {\r\n    return Object.is(a, b);\r\n  }\r\n  try {\r\n    return entry.equals(a, b);\r\n  } catch {\r\n    return Object.is(a, b);\r\n  }\r\n}\r\n\r\nfunction runStorageWatchers() {\r\n  if (storageWatchers.size === 0) {\r\n    stopStorageWatcherTimerIfIdle();\r\n    return;\r\n  }\r\n  storageWatchers.forEach((entries, key) => {\r\n    if (!entries || entries.size === 0) return;\r\n    let raw;\r\n    try {\r\n      raw = localStorage.getItem(key);\r\n    } catch {\r\n      raw = null;\r\n    }\r\n    entries.forEach((entry) => {\r\n      if (!entry) return;\r\n      const parsed = parseWith(entry, raw);\r\n      if (!entry.initialized) {\r\n        entry.lastRaw = raw;\r\n        entry.lastValue = parsed;\r\n        entry.initialized = true;\r\n        if (entry.emitCurrentValue) {\r\n          try {\r\n            entry.onChange?.(parsed, {\r\n              key,\r\n              raw,\r\n              previous: undefined,\r\n              previousRaw: undefined,\r\n              initial: true,\r\n              rawChanged: true,\r\n              valueChanged: true,\r\n            });\r\n          } catch {}\r\n        }\r\n        return;\r\n      }\r\n      const rawChanged = raw !== entry.lastRaw;\r\n      const valueChanged = !valuesEqual(entry, entry.lastValue, parsed);\r\n      if (!rawChanged && !valueChanged) return;\r\n      const previousValue = entry.lastValue;\r\n      const previousRaw = entry.lastRaw;\r\n      entry.lastRaw = raw;\r\n      entry.lastValue = parsed;\r\n      try {\r\n        entry.onChange?.(parsed, {\r\n          key,\r\n          raw,\r\n          previous: previousValue,\r\n          previousRaw,\r\n          rawChanged,\r\n          valueChanged,\r\n        });\r\n      } catch {}\r\n    });\r\n  });\r\n}\r\n\r\nexport function watchStorageKey(key, {\r\n  parse,\r\n  equals,\r\n  onChange,\r\n  emitCurrentValue = false,\r\n} = {}) {\r\n  if (!key || typeof localStorage === 'undefined') {\r\n    return () => {};\r\n  }\r\n  const entry = {\r\n    parse,\r\n    equals,\r\n    onChange,\r\n    emitCurrentValue,\r\n    lastRaw: undefined,\r\n    lastValue: undefined,\r\n    initialized: false,\r\n  };\r\n  let set = storageWatchers.get(key);\r\n  if (!set) {\r\n    set = new Set();\r\n    storageWatchers.set(key, set);\r\n  }\r\n  set.add(entry);\r\n  ensureStorageWatcherTimer();\r\n  return () => {\r\n    const entries = storageWatchers.get(key);\r\n    if (!entries) return;\r\n    entries.delete(entry);\r\n    if (entries.size === 0) {\r\n      storageWatchers.delete(key);\r\n      stopStorageWatcherTimerIfIdle();\r\n    }\r\n  };\r\n}\r\n\r\nexport function primeStorageWatcherSnapshot(key, rawValue) {\r\n  if (!key) return;\r\n  const entries = storageWatchers.get(key);\r\n  if (!entries || entries.size === 0) return;\r\n  let raw = rawValue;\r\n  if (raw === undefined) {\r\n    try {\r\n      raw = localStorage.getItem(key);\r\n    } catch {\r\n      raw = null;\r\n    }\r\n  }\r\n  entries.forEach((entry) => {\r\n    if (!entry) return;\r\n    entry.lastRaw = raw;\r\n    entry.lastValue = parseWith(entry, raw);\r\n    entry.initialized = true;\r\n  });\r\n}\r\n\r\nfunction bigNumEquals(a, b) {\r\n  if (a === b) return true;\r\n  if (a == null || b == null) return a == null && b == null;\r\n  if (a instanceof BigNum && typeof a.cmp === 'function') {\r\n    try { return a.cmp(b) === 0; } catch {}\r\n  }\r\n  if (b instanceof BigNum && typeof b.cmp === 'function') {\r\n    try { return b.cmp(a) === 0; } catch {}\r\n  }\r\n  if (typeof a?.cmp === 'function') {\r\n    try { return a.cmp(b) === 0; } catch {}\r\n  }\r\n  if (typeof b?.cmp === 'function') {\r\n    try { return b.cmp(a) === 0; } catch {}\r\n  }\r\n  try {\r\n    return Object.is(String(a), String(b));\r\n  } catch {\r\n    return Object.is(a, b);\r\n  }\r\n}\r\n\r\nfunction parseBigNumOrZero(raw) {\r\n  if (raw == null) return BigNum.fromInt(0);\r\n  try {\r\n    return BigNum.fromAny(raw);\r\n  } catch {\r\n    return BigNum.fromInt(0);\r\n  }\r\n}\r\n\r\nconst currencyWatcherCleanup = new Map();\r\nlet currencyWatcherBoundSlot = null;\r\n\r\nfunction cleanupCurrencyWatchers() {\r\n  currencyWatcherCleanup.forEach((stop) => {\r\n    try { stop?.(); } catch {}\r\n  });\r\n  currencyWatcherCleanup.clear();\r\n}\r\n\r\nfunction bindCurrencyWatchersForSlot(slot) {\r\n  if (slot === currencyWatcherBoundSlot) return;\r\n  cleanupCurrencyWatchers();\r\n  currencyWatcherBoundSlot = slot ?? null;\r\n  if (slot == null) return;\r\n  for (const currencyKey of Object.values(CURRENCIES)) {\r\n    const storageKey = `${KEYS.CURRENCY[currencyKey]}:${slot}`;\r\n    const stop = watchStorageKey(storageKey, {\r\n      parse: parseBigNumOrZero,\r\n      equals: bigNumEquals,\r\n      onChange: (value, meta) => {\r\n        if (!meta?.valueChanged) return;\r\n        if (typeof window === 'undefined') return;\r\n        const detail = { key: currencyKey, value, slot };\r\n        notifyCurrencySubscribers(detail);\r\n        try {\r\n          window.dispatchEvent(new CustomEvent('currency:change', { detail }));\r\n        } catch {}\r\n      },\r\n    });\r\n    currencyWatcherCleanup.set(storageKey, stop);\r\n  }\r\n}\r\n\r\nfunction initCurrencyStorageWatchers() {\r\n  if (typeof window === 'undefined') return;\r\n  bindCurrencyWatchersForSlot(getActiveSlot());\r\n  window.addEventListener('saveSlot:change', () => {\r\n    bindCurrencyWatchersForSlot(getActiveSlot());\r\n  });\r\n}\r\n\r\n// -------------------- KEYS --------------------\r\nexport const KEYS = {\r\n  HAS_OPENED_SAVE_SLOT: `${PREFIX}hasOpenedSaveSlot`,\r\n  SAVE_SLOT:            `${PREFIX}saveSlot`,\r\n  CURRENCY:   {},\r\n  MULTIPLIER: {},\r\n};\r\n\r\n// -------------------- CURRENCIES --------------------\r\nexport const CURRENCIES = {\r\n  COINS: 'coins',\r\n  BOOKS: 'books',\r\n  GOLD: 'gold',\r\n};\r\n\r\nexport function getActiveSlot() {\r\n  const raw = localStorage.getItem(KEYS.SAVE_SLOT);\r\n  const n = parseInt(raw, 10);\r\n  return Number.isFinite(n) && n > 0 ? n : null;\r\n}\r\nexport function setActiveSlot(n) {\r\n  const v = Math.max(1, parseInt(n, 10) || 1);\r\n  localStorage.setItem(KEYS.SAVE_SLOT, String(v));\r\n  try {\r\n    window.dispatchEvent(new CustomEvent('saveSlot:change', { detail: { slot: v } }));\r\n  } catch {}\r\n}\r\n\r\nfunction keyFor(base, slot = getActiveSlot()) {\r\n  if (slot == null) return null;\r\n  return `${base}:${slot}`;\r\n}\r\n\r\nfunction isDebugLocked(key) {\r\n  try {\r\n    const lockedKeys = globalThis?.__cccLockedStorageKeys;\r\n    return lockedKeys?.has?.(key) ?? false;\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\nexport function getSlotSignatureKey(slot = getActiveSlot()) {\r\n  return slotSignatureKey(slot);\r\n}\r\n\r\nexport function getSlotModifiedFlagKey(slot = getActiveSlot()) {\r\n  return slotModifiedKey(slot);\r\n}\r\n\r\nexport function getSlotSignature(slot = getActiveSlot()) {\r\n  if (typeof localStorage === 'undefined') return null;\r\n  const key = slotSignatureKey(slot);\r\n  if (!key) return null;\r\n  try { return localStorage.getItem(key); }\r\n  catch { return null; }\r\n}\r\n\r\nexport function setSlotSignature(slot, signature) {\r\n  if (typeof localStorage === 'undefined') return;\r\n  const key = slotSignatureKey(slot);\r\n  if (!key) return;\r\n  try {\r\n    if (signature == null) {\r\n      localStorage.removeItem(key);\r\n    } else {\r\n      localStorage.setItem(key, String(signature));\r\n    }\r\n  } catch {}\r\n}\r\n\r\nexport function hasModifiedSave(slot = getActiveSlot()) {\r\n  if (typeof localStorage === 'undefined') return false;\r\n  const key = slotModifiedKey(slot);\r\n  if (!key) return false;\r\n  try { return localStorage.getItem(key) === '1'; }\r\n  catch { return false; }\r\n}\r\n\r\nexport function markSaveSlotModified(slot = getActiveSlot()) {\r\n  if (typeof localStorage === 'undefined') return;\r\n  const normalized = normalizeSlotValue(slot);\r\n  if (normalized == null) return;\r\n  if (hasModifiedSave(normalized)) return;\r\n  const key = slotModifiedKey(normalized);\r\n  if (!key) return;\r\n  try {\r\n    localStorage.setItem(key, '1');\r\n  } catch { return; }\r\n  try {\r\n    window.dispatchEvent(new CustomEvent('saveSlot:modified', { detail: { slot: normalized } }));\r\n  } catch {}\r\n}\r\n\r\n\r\nfor (const key of Object.values(CURRENCIES)) {\r\n  KEYS.CURRENCY[key]   = `${PREFIX}${key}`;\r\n  KEYS.MULTIPLIER[key] = `${PREFIX}mult:${key}`; // one key only\r\n}\r\n\r\ninitCurrencyStorageWatchers();\r\n\r\n// -------------------- SAVE-SLOT HELPERS --------------------\r\nexport function getHasOpenedSaveSlot() {\r\n  return localStorage.getItem(KEYS.HAS_OPENED_SAVE_SLOT) === 'true';\r\n}\r\nexport function setHasOpenedSaveSlot(value) {\r\n  localStorage.setItem(KEYS.HAS_OPENED_SAVE_SLOT, value ? 'true' : 'false');\r\n}\r\n\r\n// -------------------- DEFAULTS --------------------\r\nexport function ensureStorageDefaults() {\r\n  if (localStorage.getItem(KEYS.HAS_OPENED_SAVE_SLOT) === null) {\r\n    setHasOpenedSaveSlot(false);\r\n  }\r\n}\r\n\r\nexport function ensureCurrencyDefaults() {\r\n  const slot = getActiveSlot();\r\n  if (slot == null) return; // only seed AFTER a slot is chosen\r\n  for (const key of Object.values(CURRENCIES)) {\r\n    const k = `${KEYS.CURRENCY[key]}:${slot}`;\r\n    if (!localStorage.getItem(k)) localStorage.setItem(k, '0');\r\n  }\r\n}\r\n\r\nexport function ensureMultiplierDefaults() {\r\n  const slot = getActiveSlot();\r\n  if (slot == null) return; // only seed AFTER a slot is chosen\r\n  for (const key of Object.values(CURRENCIES)) {\r\n    const km = `${KEYS.MULTIPLIER[key]}:${slot}`;\r\n    if (!localStorage.getItem(km)) {\r\n      const theor = scaledFromIntBN(BigNum.fromInt(1));\r\n      setMultiplierScaled(key, theor);\r\n    } else {\r\n      getMultiplierScaled(key);\r\n    }\r\n  }\r\n}\r\n\r\n// -------------------- AMOUNTS (BN) --------------------\r\nexport function getCurrency(key) {\r\n  const k = keyFor(KEYS.CURRENCY[key]);\r\n  if (!k) return BigNum.fromInt(0);\r\n  const raw = localStorage.getItem(k);\r\n  if (!raw) return BigNum.fromInt(0);\r\n  try { return BigNum.fromAny(raw); } catch { return BigNum.fromInt(0); }\r\n}\r\n\r\nexport function setCurrency(key, value, { delta = null, previous = null } = {}) {\r\n  const slot = getActiveSlot();\r\n  const k = keyFor(KEYS.CURRENCY[key], slot);\r\n  const prev = previous ?? getCurrency(key);\r\n  if (!k) return prev;\r\n  if (isCurrencyLocked(key, slot)) {\r\n    let deltaBn = null;\r\n    if (delta) {\r\n      try {\r\n        deltaBn = delta instanceof BigNum ? delta.clone?.() ?? delta : BigNum.fromAny(delta);\r\n      } catch { deltaBn = null; }\r\n    }\r\n    const detail = { key, value: prev, slot, delta: deltaBn ?? undefined };\r\n    notifyCurrencySubscribers(detail);\r\n    try { window.dispatchEvent(new CustomEvent('currency:change', { detail })); } catch {}\r\n    return prev;\r\n  } // Respect debug-panel storage locks\r\n\r\n  let bn;\r\n  try { bn = BigNum.fromAny(value); }\r\n  catch { bn = BigNum.fromInt(0); }\r\n  if (bn.isNegative?.()) bn = BigNum.fromInt(0);\r\n\r\n  const expectedRaw = bn.toStorage();\r\n\r\n  try { localStorage.setItem(k, expectedRaw); }\r\n  catch {}\r\n\r\n  let persistedRaw = null;\r\n  try { persistedRaw = localStorage.getItem(k); }\r\n  catch {}\r\n\r\n  const effectiveRaw = persistedRaw ?? expectedRaw;\r\n  let effective = bn;\r\n  try {\r\n    if (persistedRaw != null) {\r\n      effective = BigNum.fromAny(persistedRaw);\r\n      if (effective.isNegative?.()) effective = BigNum.fromInt(0);\r\n    }\r\n  } catch {}\r\n\r\n  primeStorageWatcherSnapshot(k, effectiveRaw);\r\n\r\n  const changed = !bigNumEquals(prev, effective);\r\n  if (changed) {\r\n    let deltaBn = null;\r\n    try { deltaBn = effective.sub?.(prev); }\r\n    catch {}\r\n    if (!deltaBn && delta) {\r\n      try { deltaBn = delta instanceof BigNum ? delta : BigNum.fromAny(delta); }\r\n      catch { deltaBn = null; }\r\n    }\r\n    const detail = { key, value: effective, slot, delta: deltaBn ?? undefined };\r\n    notifyCurrencySubscribers(detail);\r\n    try { window.dispatchEvent(new CustomEvent('currency:change', { detail })); } catch {}\r\n  }\r\n\r\n  return effective;\r\n}\r\n\r\nfunction scaledFromIntBN(intBN) {\r\n  return intBN.mulScaledIntFloor(1n, -MULT_SCALE);\r\n}\r\n\r\n// theoretical (\u00D710^MULT_SCALE) \u2192 integer BN multiplier (floor), min 1\r\nfunction intFromScaled(theorBN) {\r\n  const bn = BigNum.fromAny(theorBN);\r\n  if (bn.isInfinite()) return bn.clone();\r\n  const scaled = bn.mulScaledIntFloor(1n, MULT_SCALE);\r\n  if (scaled.isZero()) return BigNum.fromInt(1);\r\n  return scaled;\r\n}\r\n\r\nfunction getMultiplierScaled(key) {\r\n  const k = keyFor(KEYS.MULTIPLIER[key]);\r\n  if (!k) return scaledFromIntBN(BigNum.fromInt(1));\r\n  const raw = localStorage.getItem(k);\r\n  if (!raw || !raw.startsWith(MULT_SCALE_TAG)) {\r\n    const theor = scaledFromIntBN(BigNum.fromInt(1));\r\n    setMultiplierScaled(key, theor);\r\n    return theor;\r\n  }\r\n  const payload = raw.slice(MULT_SCALE_TAG.length);\r\n  try { return BigNum.fromAny(payload); } catch {\r\n    const theor = scaledFromIntBN(BigNum.fromInt(1));\r\n    setMultiplierScaled(key, theor);\r\n    return theor;\r\n  }\r\n}\r\n\r\nfunction setMultiplierScaled(key, theoreticalBN, slot = getActiveSlot()) {\r\n  const k = keyFor(KEYS.MULTIPLIER[key], slot);\r\n  if (!k) return;\r\n  if (isCurrencyLocked(key, slot)) return; // Respect debug-panel storage locks\r\n  let prev = scaledFromIntBN(BigNum.fromInt(1));\r\n  const existingRaw = localStorage.getItem(k);\r\n  if (existingRaw?.startsWith?.(MULT_SCALE_TAG)) {\r\n    try {\r\n      prev = BigNum.fromAny(existingRaw.slice(MULT_SCALE_TAG.length));\r\n    } catch {}\r\n  }\r\n  const bn = BigNum.fromAny(theoreticalBN);\r\n  const raw = MULT_SCALE_TAG + bn.toStorage();\r\n  try { localStorage.setItem(k, raw); }\r\n  catch {}\r\n\r\n  let persistedRaw = null;\r\n  try { persistedRaw = localStorage.getItem(k); }\r\n  catch {}\r\n\r\n  const effectiveRaw = persistedRaw ?? raw;\r\n  let effective = bn;\r\n  try {\r\n    const payload = effectiveRaw?.startsWith?.(MULT_SCALE_TAG)\r\n      ? effectiveRaw.slice(MULT_SCALE_TAG.length)\r\n      : null;\r\n    if (payload != null) effective = BigNum.fromAny(payload);\r\n  } catch {}\r\n  // Keep any live storage watchers (and save-integrity snapshots) aligned with the\r\n  // freshly-written multiplier so follow-up writes don't look like manual tampering.\r\n  try { primeStorageWatcherSnapshot(k, effectiveRaw); } catch {}\r\n  if (!bigNumEquals(prev, effective)) {\r\n    try {\r\n      window.dispatchEvent(new CustomEvent('currency:multiplier', {\r\n        detail: { key, mult: intFromScaled(effective), slot }\r\n      }));\r\n    } catch {}\r\n  }\r\n}\r\n\r\nexport function getCurrencyMultiplierBN(key) {\r\n  return intFromScaled(getMultiplierScaled(key));\r\n}\r\n\r\nexport function isCurrencyLocked(key, slot = getActiveSlot()) {\r\n  const k = keyFor(KEYS.CURRENCY[key], slot);\r\n  return isDebugLocked(k);\r\n}\r\n\r\n// public set integer BN multiplier (stored as scaled theoretical)\r\nexport function setCurrencyMultiplierBN(key, intBNValue) {\r\n  const v = BigNum.fromAny(intBNValue);\r\n  const theor = scaledFromIntBN(v);\r\n  setMultiplierScaled(key, theor, getActiveSlot());\r\n  return v;\r\n}\r\n\r\nexport function peekCurrency(slot, key) {\r\n  const raw = localStorage.getItem(`${KEYS.CURRENCY[key]}:${slot}`);\r\n  if (!raw) return BigNum.fromInt(0);\r\n  try { return BigNum.fromAny(raw); } catch { return BigNum.fromInt(0); }\r\n}\r\n\r\n// -------------------- UTILITIES --------------------\r\nexport function clearAllStorage() {\r\n  Object.values(KEYS).forEach((v) => {\r\n    if (typeof v === 'string') {\r\n      localStorage.removeItem(v);\r\n    } else if (typeof v === 'object') {\r\n      Object.values(v).forEach((sub) => localStorage.removeItem(sub));\r\n    }\r\n  });\r\n}\r\n\r\n// -------------------- BANK FACADE --------------------\r\nfunction makeCurrencyHandle(key) {\r\n  // callable preview: bank.coins(\"1e3\")\r\n  const fn = (x) => {\r\n    try {\r\n      const bn = BigNum.fromAny(x);\r\n      return typeof formatNumber === 'function' ? formatNumber(bn) : bn.toString();\r\n    } catch {\r\n      return 'NaN';\r\n    }\r\n  };\r\n\r\n  Object.defineProperty(fn, 'value', {\r\n    get() { return getCurrency(key); }\r\n  });\r\n\r\n  fn.toString = function toString() {\r\n    return this.value.toString();\r\n  };\r\n\r\n  // amount mutations\r\n  fn.add = function add(x) {\r\n    const amt  = BigNum.fromAny(x);\r\n    const next = this.value.add(amt);\r\n    const effective = setCurrency(key, next, { delta: amt, previous: this.value });\r\n    return effective;\r\n  };\r\n\r\nfn.sub = function sub(x) {\r\n  const amt = BigNum.fromAny(x);\r\n  const cur = this.value;\r\n\r\n  let next = cur.sub(amt);\r\n  if (next.isNegative?.()) next = BigNum.fromInt(0);\r\n\r\n  setCurrency(key, next);\r\n  return next;\r\n};\r\n\r\n  fn.set = function set(x) {\r\n    const val = BigNum.fromAny(x);\r\n    let delta = null;\r\n    let current;\r\n    try {\r\n      current = this.value;\r\n      if (current && typeof current.sub === 'function') {\r\n        delta = val.sub(current);\r\n      }\r\n    } catch {}\r\n    const effective = setCurrency(key, val, { delta, previous: current });\r\n    return effective;\r\n  };\r\n\r\n  fn.fmt = function fmt(x) {\r\n    const bn = BigNum.fromAny(x);\r\n    return typeof formatNumber === 'function' ? formatNumber(bn) : bn.toString();\r\n  };\r\n\r\n  // multiplier API (single-key theoretical + floor)\r\n  fn.mult = {\r\n    get() {\r\n      return getCurrencyMultiplierBN(key);\r\n    },\r\n    set(x) {\r\n      return setCurrencyMultiplierBN(key, x);\r\n    },\r\n    multiplyByInt(x) {\r\n      const factor = BigNum.fromAny(x).floorToInteger();\r\n      let theor = getMultiplierScaled(key).mulBigNumInteger(factor);\r\n      if (theor.isZero()) theor = scaledFromIntBN(BigNum.fromInt(1));\r\n      setMultiplierScaled(key, theor);\r\n      return intFromScaled(theor);\r\n    },\r\n    multiplyByDecimal(x) {\r\n      // parse \"1.2\" \u2192 { numer, scale }\r\n      let parsed;\r\n      try { parsed = BigNum._parseDecimalMultiplier(String(x), MULT_SCALE); }\r\n      catch { parsed = { numer: 1n, scale: 0 }; }\r\n      let theor = getMultiplierScaled(key).mulScaledIntFloor(parsed.numer, parsed.scale);\r\n      if (theor.isZero()) theor = scaledFromIntBN(BigNum.fromInt(1));\r\n      setMultiplierScaled(key, theor);\r\n      const next = intFromScaled(theor);\r\n      return next.isZero() ? BigNum.fromInt(1) : next;\r\n    },\r\n    multiplyByPercent(pct) {\r\n      const factor = (Number(pct) / 100) + 1;\r\n      return this.multiplyByDecimal(String(factor));\r\n    },\r\n    applyTo(amount) {\r\n      const mult = this.get();\r\n      if (mult.isInfinite()) {\r\n        return BigNum.fromAny('Infinity');\r\n      }\r\n      const amt = BigNum.fromAny(amount, mult.p);\r\n      if (amt.isZero() || mult.isZero()) return amt.clone();\r\n      return amt.mulBigNumInteger(mult);\r\n    }\r\n  };\r\n\r\n  fn.addWithMultiplier = function addWithMultiplier(baseAmount) {\r\n    const inc = fn.mult.applyTo(baseAmount);\r\n    return fn.add(inc);\r\n  };\r\n\r\n  return fn;\r\n}\r\n\r\nexport const bank = new Proxy({}, {\r\n  get(_, prop) {\r\n    if (Object.values(CURRENCIES).includes(prop)) return makeCurrencyHandle(prop);\r\n    if (typeof prop === 'string' && CURRENCIES[prop.toUpperCase?.()]) {\r\n      return makeCurrencyHandle(CURRENCIES[prop.toUpperCase()]);\r\n    }\r\n    return undefined;\r\n  }\r\n});\r\n\r\nif (typeof window !== 'undefined') {\r\n  window.bank = bank;\r\n  window.coins = bank.coins;\r\n  window.books = bank.books;\r\n}\r\n", "// js/util/slotsManager.js\r\nimport { KEYS, getActiveSlot } from './storage.js';\r\nimport { refreshSlotsView } from './slots.js';\r\n\r\nlet deleteMode = false;\r\nlet initialized = false;\r\n\r\nexport function isDeleteMode() { return deleteMode; }\r\n\r\nfunction setDeleteMode(on) {\r\n  deleteMode = !!on;\r\n  document.body.classList.toggle('slots-delete-mode', deleteMode);\r\n\r\n  const btn = document.getElementById('manage-saves');\r\n  if (btn) btn.textContent = deleteMode ? 'Done' : 'Manage save slots';\r\n\r\n  document.querySelectorAll('.slot-card').forEach((card) => {\r\n    card.classList.toggle('is-deleting', deleteMode);\r\n    card.setAttribute('aria-pressed', deleteMode ? 'true' : 'false');\r\n  });\r\n}\r\n\r\nfunction removeAllKeysForSlot(slot) {\r\n  const re = new RegExp(`^ccc:.*:${slot}$`);\r\n  const toRemove = [];\r\n  for (let i = 0; i < localStorage.length; i++) {\r\n    const k = localStorage.key(i);\r\n    if (re.test(k)) toRemove.push(k);\r\n  }\r\n  toRemove.forEach((k) => localStorage.removeItem(k));\r\n}\r\n\r\nexport function initSlotsManager() {\r\n  if (initialized) return;\r\n  initialized = true;\r\n\r\n  const manageBtn = document.getElementById('manage-saves');\r\n  const grid = document.querySelector('.slots-grid');\r\n  if (!manageBtn || !grid) return;\r\n\r\n  manageBtn.addEventListener('click', (e) => {\r\n    e.preventDefault();\r\n    setDeleteMode(!deleteMode);\r\n  });\r\n\r\n  window.addEventListener('keydown', (e) => {\r\n    if (deleteMode && e.key === 'Escape') setDeleteMode(false);\r\n  });\r\n\r\n  // Capture early to block the regular slot click handler\r\n  const onPointerDownCapture = (e) => {\r\n    if (!deleteMode) return;\r\n    const card = e.target.closest('.slot-card');\r\n    if (!card) return;\r\n    e.preventDefault();\r\n    e.stopPropagation();\r\n  };\r\n\r\n  const onClickCapture = (e) => {\r\n    if (!deleteMode) return;\r\n    const card = e.target.closest('.slot-card');\r\n    if (!card) return;\r\n\r\n    e.preventDefault();\r\n    e.stopPropagation();\r\n\r\n    // Figure out slot number\r\n    let slot = parseInt(card.dataset.slot, 10);\r\n    if (!Number.isFinite(slot) || slot <= 0) {\r\n      const cards = Array.from(document.querySelectorAll('.slot-card'));\r\n      slot = cards.indexOf(card) + 1;\r\n    }\r\n\r\n    // Only delete if slot has data\r\n    const hasData = localStorage.getItem(`ccc:coins:${slot}`) !== null;\r\n    if (!hasData) {\r\n      alert(`Slot ${slot} has no save data.`);\r\n      return;\r\n    }\r\n\r\n    if (!confirm(`Delete save data in Slot ${slot}? This cannot be undone.`)) return;\r\n\r\n    removeAllKeysForSlot(slot);\r\n\r\n    if (getActiveSlot() === slot) {\r\n      try { localStorage.removeItem(KEYS.SAVE_SLOT); } catch {}\r\n    }\r\n\r\n    refreshSlotsView();\r\n    setDeleteMode(false);\r\n  };\r\n\r\n  grid.addEventListener('pointerdown', onPointerDownCapture, true); // capture\r\n  grid.addEventListener('click', onClickCapture, true);             // capture\r\n\r\n  setDeleteMode(false);\r\n}\r\n\r\n// Auto-init in case nothing imports us explicitly\r\ndocument.addEventListener('DOMContentLoaded', () => {\r\n  try { initSlotsManager(); } catch {}\r\n});\r\n", "import { BigNum } from './bigNum.js';\r\nimport './slotsManager.js';\r\nimport {\r\n  setHasOpenedSaveSlot,\r\n  ensureCurrencyDefaults,\r\n  ensureMultiplierDefaults,\r\n  setActiveSlot,\r\n  peekCurrency,\r\n} from './storage.js';\r\n\r\n// A slot is considered \"used\" once it has a coins key at all (even if 0)\r\nfunction hasSlotData(slot) {\r\n  return localStorage.getItem(`ccc:coins:${slot}`) !== null;\r\n}\r\n\r\nfunction coinsTextFor(slot) {\r\n  if (!hasSlotData(slot)) return 'No save data';\r\n  try {\r\n    const bn = peekCurrency(slot, 'coins'); // BigNum\r\n    return `Coins: ${bn.toString()}`;\r\n  } catch {\r\n    return 'Coins: 0';\r\n  }\r\n}\r\n\r\nfunction renderSlotCards() {\r\n  const cards = document.querySelectorAll('.slot-card');\r\n  cards.forEach((btn, idx) => {\r\n    const slot = idx + 1;\r\n    const titleEl = btn.querySelector('.slot-title');\r\n\r\n    if (titleEl) titleEl.textContent = coinsTextFor(slot);\r\n\r\n    btn.dataset.slot = String(slot);\r\n  });\r\n}\r\n\r\nexport function initSlots(onSelect) {\r\n  const cards = document.querySelectorAll('.slot-card');\r\n\r\n  // Initial paint\r\n  renderSlotCards();\r\n\r\n  cards.forEach((btn, idx) => {\r\n    const slotNum = idx + 1;\r\n    btn.addEventListener('click', (ev) => {\r\n      ev.preventDefault();\r\n\r\n      // Switch to this slot and seed its defaults the first time it\u2019s opened\r\n      setActiveSlot(slotNum);\r\n      ensureCurrencyDefaults();\r\n      ensureMultiplierDefaults();\r\n\r\n      setHasOpenedSaveSlot(true);\r\n      if (typeof onSelect === 'function') onSelect(slotNum, ev);\r\n\r\n      // Repaint card titles after seeding\r\n      renderSlotCards();\r\n    });\r\n  });\r\n}\r\n\r\nexport function refreshSlotsView() { renderSlotCards(); }\r\n", "// js/util/audioCache.js\r\n\r\nconst cache = new Map();\r\n\r\nconst normalize = (src) => {\r\n  try {\r\n    return new URL(src, document.baseURI).href;\r\n  } catch (_) {\r\n    return src;\r\n  }\r\n};\r\n\r\nexport function registerPreloadedAudio(src, element) {\r\n  const key = normalize(src);\r\n  if (!key || !element) return;\r\n  element.pause?.();\r\n  try { element.currentTime = 0; } catch (_) {}\r\n  cache.set(key, element);\r\n}\r\n\r\nexport function takePreloadedAudio(src) {\r\n  const key = normalize(src);\r\n  if (!cache.has(key)) return null;\r\n  const el = cache.get(key);\r\n  cache.delete(key);\r\n  return el;\r\n}", "// js/ui/hudLayout.js\r\n\r\nexport function syncXpMpHudLayout() {\r\n  if (typeof document === 'undefined') return;\r\n  const hud = document.querySelector('.hud-top');\r\n  if (!hud) return;\r\n\r\n  const xpEl = document.querySelector('[data-xp-hud]');\r\n  const mpEl = document.querySelector('[data-mp-hud]');\r\n  const xpVisible = !!(xpEl && !xpEl.hasAttribute('hidden'));\r\n  const mpVisible = !!(mpEl && !mpEl.hasAttribute('hidden'));\r\n\r\n  hud.classList.toggle('hud-top--xp-only', xpVisible && !mpVisible);\r\n  hud.classList.toggle('hud-top--xp-mp', xpVisible && mpVisible);\r\n\r\n  if (!xpVisible && !mpVisible) {\r\n    hud.classList.remove('hud-top--xp-only', 'hud-top--xp-mp');\r\n  }\r\n}", "// js/game/xpSystem.js\r\n\r\nimport { BigNum } from '../util/bigNum.js';\r\nimport { bank, getActiveSlot, watchStorageKey, primeStorageWatcherSnapshot } from '../util/storage.js';\r\nimport { applyStatMultiplierOverride } from '../util/debugPanel.js';\r\nimport { formatNumber } from '../util/numFormat.js';\r\nimport { syncXpMpHudLayout } from '../ui/hudLayout.js';\r\n\r\nconst KEY_PREFIX = 'ccc:xp';\r\nconst KEY_UNLOCK = (slot) => `${KEY_PREFIX}:unlocked:${slot}`;\r\nconst KEY_XP_LEVEL = (slot) => `${KEY_PREFIX}:level:${slot}`;\r\nconst KEY_PROGRESS = (slot) => `${KEY_PREFIX}:progress:${slot}`;\r\n\r\nexport function getXpLevelStorageKey(slot = getActiveSlot()) {\r\n  const resolvedSlot = slot ?? getActiveSlot();\r\n  return resolvedSlot == null ? null : KEY_XP_LEVEL(resolvedSlot);\r\n}\r\n\r\nlet lastSlot = null;\r\nlet stateLoaded = false;\r\nlet requirementBn = BigNum.fromInt(10);\r\nconst xpRequirementCache = new Map();\r\nxpRequirementCache.set('0', requirementBn);\r\nlet highestCachedExactLevel = 0n;\r\nconst infinityRequirementBn = BigNum.fromAny('Infinity');\r\n\r\nlet lastSyncedCoinLevel = null;\r\nlet lastSyncedCoinLevelWasInfinite = false;\r\nlet lastSyncedCoinUsedApproximation = false;\r\nlet lastSyncedCoinApproxKey = null;\r\nlet externalCoinMultiplierProvider = null;\r\nlet externalXpGainMultiplierProvider = null;\r\nconst coinMultiplierProviders = new Set();\r\nconst xpGainMultiplierProviders = new Set();\r\nlet externalBookRewardProvider = null;\r\n\r\nconst EXACT_REQUIREMENT_CACHE_LEVEL = 5000n;\r\nconst LOG_STEP = Math.log10(11 / 10);\r\nconst LOG_DECADE_BONUS = Math.log10(5 / 2);\r\nconst EXACT_COIN_LEVEL_LIMIT = 200n;\r\nconst LOG_STEP_DECIMAL = '0.04139268515822507';\r\nconst LOG_DECADE_BONUS_DECIMAL = '0.3979400086720376';\r\nconst TEN_DIVISOR_DECIMAL = '0.1';\r\nconst maxLog10Bn = BigNum.fromScientific(String(BigNum.MAX_E));\r\n\r\nfunction bigIntToFloatApprox(value) {\r\n  if (value === 0n) return 0;\r\n  const str = value.toString();\r\n  const len = str.length;\r\n  const headDigits = Math.min(len, 15);\r\n  const head = Number(str.slice(0, headDigits));\r\n  const exponent = len - headDigits;\r\n  if (!Number.isFinite(head)) return Number.POSITIVE_INFINITY;\r\n  const scaled = head * Math.pow(10, exponent);\r\n  return Number.isFinite(scaled) ? scaled : Number.POSITIVE_INFINITY;\r\n}\r\n\r\nfunction bigNumIsInfinite(bn) {\r\n  return !!(bn && typeof bn === 'object' && (bn.isInfinite?.() || (typeof bn.isInfinite === 'function' && bn.isInfinite())));\r\n}\r\n\r\nfunction bigNumIsZero(bn) {\r\n  return !bn || typeof bn !== 'object' || (bn.isZero?.() || (typeof bn.isZero === 'function' && bn.isZero()));\r\n}\r\n\r\nfunction bigNumToFiniteNumber(bn) {\r\n  if (!bn || typeof bn !== 'object') return 0;\r\n  if (bigNumIsInfinite(bn)) return Number.POSITIVE_INFINITY;\r\n  const sci = typeof bn.toScientific === 'function' ? bn.toScientific(18) : String(bn);\r\n  if (!sci || sci === 'Infinity') return Number.POSITIVE_INFINITY;\r\n  const match = sci.match(/^([0-9]+(?:\\.[0-9]+)?)e([+-]?\\d+)$/i);\r\n  if (match) {\r\n    const mant = parseFloat(match[1]);\r\n    const exp = parseInt(match[2], 10);\r\n    if (!Number.isFinite(mant) || !Number.isFinite(exp)) return Number.POSITIVE_INFINITY;\r\n    if (exp >= 309) return Number.POSITIVE_INFINITY;\r\n    return mant * Math.pow(10, exp);\r\n  }\r\n  const num = Number(sci);\r\n  return Number.isFinite(num) ? num : Number.POSITIVE_INFINITY;\r\n}\r\n\r\nfunction logBigNumToNumber(bn) {\r\n  if (!bn || typeof bn !== 'object') return 0;\r\n  if (bigNumIsInfinite(bn)) return Number.POSITIVE_INFINITY;\r\n  if (typeof bn.cmp === 'function' && bn.cmp(maxLog10Bn) >= 0) {\r\n    return Number.POSITIVE_INFINITY;\r\n  }\r\n  return bigNumToFiniteNumber(bn);\r\n}\r\n\r\nfunction computeBonusCountBn(levelBn) {\r\n  if (!levelBn || typeof levelBn !== 'object') return BigNum.fromInt(0);\r\n  const divided = levelBn.mulDecimal(TEN_DIVISOR_DECIMAL, 1);\r\n  const floored = divided.floorToInteger();\r\n  if (typeof divided.cmp === 'function' && divided.cmp(floored) === 0) {\r\n    if (floored.isZero?.() || (typeof floored.isZero === 'function' && floored.isZero())) {\r\n      return floored;\r\n    }\r\n    return floored.sub?.(bnOne()) ?? BigNum.fromInt(0);\r\n  }\r\n  return floored;\r\n}\r\n\r\nfunction computeLevelLogTerm(levelBn) {\r\n  if (!levelBn || typeof levelBn !== 'object') return BigNum.fromInt(0);\r\n  return levelBn.mulDecimal(LOG_STEP_DECIMAL, 18);\r\n}\r\n\r\nfunction computeBonusLogTerm(levelBn) {\r\n  const bonusCount = computeBonusCountBn(levelBn);\r\n  if (bigNumIsZero(bonusCount)) return null;\r\n  return bonusCount.mulDecimal(LOG_DECADE_BONUS_DECIMAL, 18);\r\n}\r\n\r\nfunction approximateCoinMultiplierFromBigNum(levelBn) {\r\n  if (!levelBn || typeof levelBn !== 'object') {\r\n    return infinityRequirementBn.clone?.() ?? infinityRequirementBn;\r\n  }\r\n  const levelLog = computeLevelLogTerm(levelBn);\r\n  let totalLog = levelLog;\r\n  const bonusLog = computeBonusLogTerm(levelBn);\r\n  if (bonusLog) {\r\n    totalLog = totalLog.add?.(bonusLog) ?? totalLog;\r\n  }\r\n  const logNumber = logBigNumToNumber(totalLog);\r\n  if (!Number.isFinite(logNumber)) {\r\n    return infinityRequirementBn.clone?.() ?? infinityRequirementBn;\r\n  }\r\n  const approx = bigNumFromLog10(logNumber);\r\n  const approxIsInf = approx.isInfinite?.() || (typeof approx.isInfinite === 'function' && approx.isInfinite());\r\n  if (approxIsInf) {\r\n    return infinityRequirementBn.clone?.() ?? infinityRequirementBn;\r\n  }\r\n  const levelTerm = levelBn.clone?.() ?? (() => {\r\n    try { return BigNum.fromAny(levelBn ?? 0); }\r\n    catch { return BigNum.fromInt(0); }\r\n  })();\r\n  let combined = approx.clone?.() ?? approx;\r\n  if (typeof combined.add === 'function') {\r\n    combined = combined.add(levelTerm);\r\n  } else if (typeof levelTerm.add === 'function') {\r\n    combined = levelTerm.add(combined);\r\n  }\r\n  return combined;\r\n}\r\n\r\nconst xpState = {\r\n  unlocked: false,\r\n  xpLevel: BigNum.fromInt(0),\r\n  progress: BigNum.fromInt(0),\r\n};\r\n\r\nfunction enforceXpInfinityInvariant() {\r\n  const levelIsInf = bigNumIsInfinite(xpState.xpLevel);\r\n  const progIsInf = bigNumIsInfinite(xpState.progress);\r\n  if (!levelIsInf && !progIsInf) return false;\r\n\r\n  const inf = infinityRequirementBn.clone?.() ?? infinityRequirementBn;\r\n  xpState.xpLevel = inf.clone?.() ?? inf;\r\n  xpState.progress = inf.clone?.() ?? inf;\r\n  requirementBn = inf.clone?.() ?? inf;\r\n\r\n  if (bank?.books) {\r\n    try {\r\n      if (typeof bank.books.set === 'function') {\r\n        bank.books.set(inf.clone?.() ?? inf);\r\n      } else if (typeof bank.books.add === 'function') {\r\n        bank.books.add(inf.clone?.() ?? inf);\r\n      }\r\n    } catch {\r\n    }\r\n  }\r\n  \r\n  return true;\r\n}\r\n\r\n\r\nconst xpChangeSubscribers = new Set();\r\n\r\nfunction notifyXpSubscribers(detail = {}) {\r\n  if (xpChangeSubscribers.size === 0) return;\r\n  xpChangeSubscribers.forEach((entry) => {\r\n    if (!entry || typeof entry.handler !== 'function') return;\r\n    if (entry.slot != null && detail.slot != null && entry.slot !== detail.slot) return;\r\n    try { entry.handler(detail); }\r\n    catch {}\r\n  });\r\n}\r\n\r\nexport function onXpChange(handler, { slot = null } = {}) {\r\n  if (typeof handler !== 'function') {\r\n    return () => {};\r\n  }\r\n  const entry = { handler, slot: slot ?? null };\r\n  xpChangeSubscribers.add(entry);\r\n  return () => {\r\n    xpChangeSubscribers.delete(entry);\r\n  };\r\n}\r\n\r\nconst hudRefs = {\r\n  container: null,\r\n  bar: null,\r\n  fill: null,\r\n  xpLevelValue: null,\r\n  progress: null,\r\n};\r\n\r\nfunction bnZero() {\r\n  return BigNum.fromInt(0);\r\n}\r\n\r\nfunction bnOne() {\r\n  return BigNum.fromInt(1);\r\n}\r\n\r\nconst xpStorageWatcherCleanups = [];\r\nlet xpStorageWatchersInitialized = false;\r\nlet xpStorageWatcherSlot = null;\r\nlet handlingExternalXpStorage = false;\r\n\r\nfunction cloneBigNumSafe(value) {\r\n  if (!value) return bnZero();\r\n  if (typeof value.clone === 'function') {\r\n    try { return value.clone(); } catch {}\r\n  }\r\n  try { return BigNum.fromAny(value); } catch { return bnZero(); }\r\n}\r\n\r\nfunction bigNumEqualsSafe(a, b) {\r\n  if (a === b) return true;\r\n  if (a == null || b == null) return a == null && b == null;\r\n  if (typeof a?.cmp === 'function') {\r\n    try { return a.cmp(b) === 0; } catch {}\r\n  }\r\n  if (typeof b?.cmp === 'function') {\r\n    try { return b.cmp(a) === 0; } catch {}\r\n  }\r\n  try { return Object.is(String(a), String(b)); }\r\n  catch { return false; }\r\n}\r\n\r\nfunction cleanupXpStorageWatchers() {\r\n  while (xpStorageWatcherCleanups.length > 0) {\r\n    const stop = xpStorageWatcherCleanups.pop();\r\n    try { stop?.(); } catch {}\r\n  }\r\n}\r\n\r\nfunction parseBigNumOrZero(raw) {\r\n  if (raw == null) return bnZero();\r\n  try { return BigNum.fromAny(raw); }\r\n  catch { return bnZero(); }\r\n}\r\n\r\nfunction handleExternalXpStorageChange(reason) {\r\n  if (handlingExternalXpStorage) return;\r\n  handlingExternalXpStorage = true;\r\n  try {\r\n    const slot = xpStorageWatcherSlot ?? getActiveSlot();\r\n    const prev = {\r\n      unlocked: xpState.unlocked,\r\n      xpLevel: cloneBigNumSafe(xpState.xpLevel),\r\n      progress: cloneBigNumSafe(xpState.progress),\r\n      requirement: cloneBigNumSafe(requirementBn),\r\n    };\r\n    ensureStateLoaded(true);\r\n    updateHud();\r\n    syncCoinMultiplierWithXpLevel(true);\r\n    const current = {\r\n      unlocked: xpState.unlocked,\r\n      xpLevel: cloneBigNumSafe(xpState.xpLevel),\r\n      progress: cloneBigNumSafe(xpState.progress),\r\n      requirement: cloneBigNumSafe(requirementBn),\r\n    };\r\n    const unlockedChanged = prev.unlocked !== current.unlocked;\r\n    const levelChanged = !bigNumEqualsSafe(prev.xpLevel, current.xpLevel);\r\n    const progressChanged = !bigNumEqualsSafe(prev.progress, current.progress);\r\n    if (!unlockedChanged && !levelChanged && !progressChanged) {\r\n      return;\r\n    }\r\n    let xpLevelsGained = bnZero();\r\n    if (levelChanged) {\r\n      try { xpLevelsGained = current.xpLevel.sub?.(prev.xpLevel) ?? bnZero(); }\r\n      catch { xpLevelsGained = bnZero(); }\r\n    }\r\n    let xpAdded = null;\r\n    if (!levelChanged && progressChanged) {\r\n      try { xpAdded = current.progress.sub?.(prev.progress) ?? null; }\r\n      catch { xpAdded = null; }\r\n    }\r\n    if (typeof window !== 'undefined' || xpChangeSubscribers.size > 0) {\r\n      const detail = {\r\n        unlocked: current.unlocked,\r\n        xpLevelsGained: xpLevelsGained?.clone?.() ?? xpLevelsGained,\r\n        xpAdded: xpAdded?.clone?.() ?? xpAdded,\r\n        xpLevel: current.xpLevel?.clone?.() ?? current.xpLevel,\r\n        progress: current.progress?.clone?.() ?? current.progress,\r\n        requirement: current.requirement?.clone?.() ?? current.requirement,\r\n        source: 'storage',\r\n        changeType: reason,\r\n        slot,\r\n      };\r\n      notifyXpSubscribers(detail);\r\n      if (typeof window !== 'undefined') {\r\n        try { window.dispatchEvent(new CustomEvent('xp:change', { detail })); } catch {}\r\n      }\r\n    }\r\n  } finally {\r\n    handlingExternalXpStorage = false;\r\n  }\r\n}\r\n\r\nfunction bindXpStorageWatchersForSlot(slot) {\r\n  if (slot === xpStorageWatcherSlot) return;\r\n  cleanupXpStorageWatchers();\r\n  xpStorageWatcherSlot = slot ?? null;\r\n  if (slot == null) return;\r\n  const watch = (key, options) => {\r\n    const stop = watchStorageKey(key, options);\r\n    if (typeof stop === 'function') {\r\n      xpStorageWatcherCleanups.push(stop);\r\n    }\r\n  };\r\n  watch(KEY_UNLOCK(slot), {\r\n    parse: (raw) => raw === '1',\r\n    equals: (a, b) => a === b,\r\n    onChange: () => handleExternalXpStorageChange('unlock'),\r\n  });\r\n  watch(KEY_XP_LEVEL(slot), {\r\n    parse: parseBigNumOrZero,\r\n    equals: bigNumEqualsSafe,\r\n    onChange: () => handleExternalXpStorageChange('xpLevel'),\r\n  });\r\n  watch(KEY_PROGRESS(slot), {\r\n    parse: parseBigNumOrZero,\r\n    equals: bigNumEqualsSafe,\r\n    onChange: () => handleExternalXpStorageChange('progress'),\r\n  });\r\n}\r\n\r\nfunction ensureXpStorageWatchers() {\r\n  if (xpStorageWatchersInitialized) {\r\n    bindXpStorageWatchersForSlot(getActiveSlot());\r\n    return;\r\n  }\r\n  xpStorageWatchersInitialized = true;\r\n  bindXpStorageWatchersForSlot(getActiveSlot());\r\n  if (typeof window !== 'undefined') {\r\n    window.addEventListener('saveSlot:change', () => {\r\n      bindXpStorageWatchersForSlot(getActiveSlot());\r\n      ensureStateLoaded(true);\r\n      updateHud();\r\n      syncCoinMultiplierWithXpLevel(true);\r\n    });\r\n  }\r\n}\r\n\r\nfunction stripHtml(value) {\r\n  if (typeof value !== 'string') return '';\r\n  return value.replace(/<[^>]*>/g, '');\r\n}\r\n\r\nfunction approxLog10(bn) {\r\n  if (!bn || typeof bn !== 'object') return Number.NEGATIVE_INFINITY;\r\n  if (bn.isInfinite?.() || (typeof bn.isInfinite === 'function' && bn.isInfinite())) {\r\n    return Number.POSITIVE_INFINITY;\r\n  }\r\n  if (bn.isZero?.() || (typeof bn.isZero === 'function' && bn.isZero())) {\r\n    return Number.NEGATIVE_INFINITY;\r\n  }\r\n\r\n  // Prefer the BigNum internal representation so we can handle chained-exponent\r\n  // values (e.g. 1e8.11e21) without going through lossy string parsing.\r\n  const sig = bn.sig;\r\n  const expBase = typeof bn.e === 'number' ? bn.e : Number(bn.e ?? 0);\r\n  const expOffset = typeof bn._eOffset === 'bigint'\r\n    ? bigIntToFloatApprox(bn._eOffset)\r\n    : Number(bn._eOffset ?? 0);\r\n\r\n  if (!Number.isFinite(expBase)) {\r\n    return expBase > 0 ? Number.POSITIVE_INFINITY : Number.NEGATIVE_INFINITY;\r\n  }\r\n  if (!Number.isFinite(expOffset)) {\r\n    return expOffset > 0 ? Number.POSITIVE_INFINITY : Number.NEGATIVE_INFINITY;\r\n  }\r\n\r\n  const totalExponent = expBase + expOffset;\r\n  if (!Number.isFinite(totalExponent)) {\r\n    return totalExponent > 0 ? Number.POSITIVE_INFINITY : Number.NEGATIVE_INFINITY;\r\n  }\r\n\r\n  let mantissaLog = 0;\r\n  if (typeof sig === 'bigint') {\r\n    const sigStr = sig.toString();\r\n    const trimmed = sigStr.replace(/^0+/, '');\r\n    if (!trimmed) return Number.NEGATIVE_INFINITY;\r\n    const digits = trimmed.length;\r\n    const headDigits = Math.min(digits, 15);\r\n    const headSlice = trimmed.slice(0, headDigits);\r\n    const head = Number.parseFloat(headSlice);\r\n    if (Number.isFinite(head) && head > 0) {\r\n      mantissaLog = Math.log10(head) + (digits - headDigits);\r\n    } else {\r\n      mantissaLog = digits - 1;\r\n    }\r\n  } else {\r\n    try {\r\n      const sci = typeof bn.toScientific === 'function' ? bn.toScientific(12) : String(bn);\r\n      if (!sci || sci === '0') return Number.NEGATIVE_INFINITY;\r\n      if (sci === 'Infinity') return Number.POSITIVE_INFINITY;\r\n      const match = sci.match(/^([0-9]+(?:\\.[0-9]+)?)e([+-]?\\d+)$/i);\r\n      if (match) {\r\n        const mant = parseFloat(match[1]);\r\n        const exp = parseInt(match[2], 10) || 0;\r\n        if (!(mant > 0) || !Number.isFinite(mant)) return Number.NEGATIVE_INFINITY;\r\n        mantissaLog = Math.log10(mant) + exp;\r\n      } else {\r\n        const num = Number(sci);\r\n        if (!Number.isFinite(num) || num <= 0) return Number.NEGATIVE_INFINITY;\r\n        mantissaLog = Math.log10(num);\r\n      }\r\n    } catch {\r\n      return Number.NEGATIVE_INFINITY;\r\n    }\r\n  }\r\n\r\n  return totalExponent + mantissaLog;\r\n}\r\n\r\nfunction bonusMultipliersCount(levelBigInt) {\r\n  if (levelBigInt <= 1n) return 0n;\r\n  return (levelBigInt - 1n) / 10n;\r\n}\r\n\r\nfunction ensureExactRequirementCacheUpTo(levelBigInt) {\r\n  const target = levelBigInt < EXACT_REQUIREMENT_CACHE_LEVEL ? levelBigInt : EXACT_REQUIREMENT_CACHE_LEVEL;\r\n  if (target <= highestCachedExactLevel) return;\r\n\r\n  let currentLevel = highestCachedExactLevel;\r\n  let currentRequirement = xpRequirementCache.get(currentLevel.toString());\r\n  if (!currentRequirement) {\r\n    currentRequirement = BigNum.fromInt(10);\r\n    xpRequirementCache.set(currentLevel.toString(), currentRequirement);\r\n  }\r\n\r\n  while (currentLevel < target) {\r\n    const nextLevel = currentLevel + 1n;\r\n    let nextRequirement = currentRequirement.mulScaledIntFloor(11n, 1);\r\n    if (nextLevel > 1n && ((nextLevel - 1n) % 10n === 0n)) {\r\n      nextRequirement = nextRequirement.mulScaledIntFloor(25n, 1);\r\n    }\r\n    xpRequirementCache.set(nextLevel.toString(), nextRequirement);\r\n    currentRequirement = nextRequirement;\r\n    currentLevel = nextLevel;\r\n    const isInfinite = currentRequirement.isInfinite?.() || (typeof currentRequirement.isInfinite === 'function' && currentRequirement.isInfinite());\r\n    if (isInfinite) {\r\n      highestCachedExactLevel = currentLevel;\r\n      return;\r\n    }\r\n  }\r\n\r\n  highestCachedExactLevel = currentLevel;\r\n}\r\n\r\nfunction bigNumFromLog10(log10Value) {\r\n  if (!Number.isFinite(log10Value) || log10Value >= BigNum.MAX_E) {\r\n    return infinityRequirementBn.clone?.() ?? infinityRequirementBn;\r\n  }\r\n\r\n  let exponent = Math.floor(log10Value);\r\n  let fractional = log10Value - exponent;\r\n  if (!Number.isFinite(fractional)) {\r\n    fractional = 0;\r\n  }\r\n\r\n  let mantissa = Math.pow(10, fractional);\r\n  if (!Number.isFinite(mantissa) || mantissa <= 0) {\r\n    mantissa = 1;\r\n  }\r\n\r\n  if (mantissa >= 10) {\r\n    mantissa /= 10;\r\n    exponent += 1;\r\n  }\r\n\r\n  let exponentStr;\r\n  try {\r\n    exponentStr = Number.isFinite(exponent)\r\n      ? exponent.toLocaleString('en', { useGrouping: false })\r\n      : String(exponent);\r\n  } catch {\r\n    exponentStr = String(exponent);\r\n  }\r\n\r\n  const sci = `${mantissa.toPrecision(18)}e${exponentStr}`;\r\n  try {\r\n    return BigNum.fromScientific(sci).floorToInteger();\r\n  } catch {\r\n    return infinityRequirementBn.clone?.() ?? infinityRequirementBn;\r\n  }\r\n}\r\n\r\nfunction approximateRequirementFromLevel(levelBn) {\r\n  const baseLevel = highestCachedExactLevel > 0n ? highestCachedExactLevel : 0n;\r\n  const baseRequirement = xpRequirementCache.get(baseLevel.toString());\r\n  if (!baseRequirement || bigNumIsInfinite(baseRequirement)) {\r\n    return infinityRequirementBn.clone?.() ?? infinityRequirementBn;\r\n  }\r\n\r\n  const baseLevelBn = BigNum.fromAny(baseLevel.toString());\r\n  const baseLog = approxLog10(baseRequirement);\r\n  let totalLog = BigNum.fromInt(0);\r\n  if (Number.isFinite(baseLog) && baseLog > 0) {\r\n    try {\r\n      totalLog = BigNum.fromScientific(baseLog.toString());\r\n    } catch {\r\n      totalLog = BigNum.fromInt(0);\r\n    }\r\n  }\r\n\r\n  const deltaLevel = levelBn.sub?.(baseLevelBn) ?? BigNum.fromInt(0);\r\n  if (!bigNumIsZero(deltaLevel)) {\r\n    totalLog = totalLog.add?.(deltaLevel.mulDecimal(LOG_STEP_DECIMAL, 18)) ?? totalLog;\r\n  }\r\n\r\n  const targetBonus = computeBonusCountBn(levelBn);\r\n  const baseBonus = computeBonusCountBn(baseLevelBn);\r\n  const deltaBonus = targetBonus.sub?.(baseBonus) ?? BigNum.fromInt(0);\r\n  if (!bigNumIsZero(deltaBonus)) {\r\n    totalLog = totalLog.add?.(deltaBonus.mulDecimal(LOG_DECADE_BONUS_DECIMAL, 18)) ?? totalLog;\r\n  }\r\n\r\n  const logNumber = logBigNumToNumber(totalLog);\r\n  if (!Number.isFinite(logNumber)) {\r\n    return infinityRequirementBn.clone?.() ?? infinityRequirementBn;\r\n  }\r\n\r\n  return bigNumFromLog10(logNumber);\r\n}\r\n\r\nfunction progressRatio(progressBn, requirement) {\r\n  if (!requirement || typeof requirement !== 'object') return 0;\r\n  if (!progressBn || typeof progressBn !== 'object') return 0;\r\n\r\n  const reqIsInf = bigNumIsInfinite(requirement);\r\n  const progIsInf = bigNumIsInfinite(progressBn);\r\n\r\n  // If both are infinite, treat as a full bar.\r\n  if (reqIsInf) {\r\n    return progIsInf ? 1 : 0;\r\n  }\r\n\r\n  const reqIsZero = bigNumIsZero(requirement);\r\n  if (reqIsZero) return 0;\r\n\r\n  const progIsZero = bigNumIsZero(progressBn);\r\n  if (progIsZero) return 0;\r\n\r\n  const logProg = approxLog10(progressBn);\r\n  const logReq  = approxLog10(requirement);\r\n  if (!Number.isFinite(logProg) || !Number.isFinite(logReq)) {\r\n    return logProg >= logReq ? 1 : 0;\r\n  }\r\n  const diff = logProg - logReq;\r\n  const ratio = Math.pow(10, diff);\r\n  if (!Number.isFinite(ratio)) {\r\n    return diff >= 0 ? 1 : 0;\r\n  }\r\n  if (ratio <= 0) return 0;\r\n  if (ratio >= 1) return 1;\r\n  return ratio;\r\n}\r\n\r\nfunction ensureHudRefs() {\r\n  if (hudRefs.container && hudRefs.container.isConnected) return true;\r\n  hudRefs.container = document.querySelector('.xp-counter[data-xp-hud]');\r\n  if (!hudRefs.container) return false;\r\n  hudRefs.bar = hudRefs.container.querySelector('.xp-bar');\r\n  hudRefs.fill = hudRefs.container.querySelector('.xp-bar__fill');\r\n  hudRefs.xpLevelValue = hudRefs.container.querySelector('.xp-level-value');\r\n  hudRefs.progress = hudRefs.container.querySelector('[data-xp-progress]');\r\n  return true;\r\n}\r\n\r\nfunction xpRequirementForXpLevel(xpLevelInput) {\r\n  let xpLvlBn;\r\n  try {\r\n    xpLvlBn = xpLevelInput instanceof BigNum\r\n      ? (xpLevelInput.clone?.() ?? xpLevelInput)\r\n      : BigNum.fromAny(xpLevelInput ?? 0);\r\n  } catch {\r\n    xpLvlBn = BigNum.fromInt(0);\r\n  }\r\n\r\n  const lvlIsInf = xpLvlBn.isInfinite?.() || (typeof xpLvlBn.isInfinite === 'function' && xpLvlBn.isInfinite());\r\n  if (lvlIsInf) {\r\n    return BigNum.fromAny('Infinity');\r\n  }\r\n\r\n  let levelPlain = '0';\r\n  try {\r\n    levelPlain = xpLvlBn.toPlainIntegerString?.() ?? xpLvlBn.toString?.() ?? '0';\r\n  } catch {\r\n    levelPlain = '0';\r\n  }\r\n\r\n  let targetLevelInfo = { bigInt: null, finite: true };\r\n  if (levelPlain && levelPlain !== 'Infinity') {\r\n    try {\r\n      targetLevelInfo = { bigInt: BigInt(levelPlain), finite: true };\r\n    } catch {\r\n      targetLevelInfo = { bigInt: null, finite: true };\r\n    }\r\n  } else {\r\n    targetLevelInfo = { bigInt: null, finite: true };\r\n  }\r\n\r\n  const targetLevel = targetLevelInfo.bigInt ?? 0n;\r\n\r\n  if (targetLevelInfo.bigInt != null && targetLevel <= 0n) {\r\n    const baseRequirement = xpRequirementCache.get('0');\r\n    return baseRequirement.clone?.() ?? baseRequirement;\r\n  }\r\n\r\n  if (targetLevelInfo.bigInt != null) {\r\n    ensureExactRequirementCacheUpTo(targetLevel);\r\n    const targetKey = targetLevel.toString();\r\n    const cachedExact = xpRequirementCache.get(targetKey);\r\n    if (cachedExact) {\r\n      return cachedExact.clone?.() ?? cachedExact;\r\n    }\r\n  }\r\n\r\n  const approximate = approximateRequirementFromLevel(xpLvlBn);\r\n  const approxIsInf = approximate.isInfinite?.() || (typeof approximate.isInfinite === 'function' && approximate.isInfinite());\r\n  if (approxIsInf) {\r\n    return infinityRequirementBn.clone?.() ?? infinityRequirementBn;\r\n  }\r\n\r\n  if (targetLevelInfo.bigInt != null) {\r\n    xpRequirementCache.set(targetLevelInfo.bigInt.toString(), approximate);\r\n  }\r\n  return approximate.clone?.() ?? approximate;\r\n}\r\n\r\nfunction updateXpRequirement() {\r\n  requirementBn = xpRequirementForXpLevel(xpState.xpLevel);\r\n}\r\n\r\nfunction resetLockedXpState() {\r\n  xpState.xpLevel = bnZero();\r\n  xpState.progress = bnZero();\r\n  updateXpRequirement();\r\n  syncCoinMultiplierWithXpLevel(true);\r\n}\r\n\r\nfunction normalizeProgress(applyRewards = false) {\r\n  // If either level or progress is already \u221E, enforce the invariant and bail.\r\n  if (enforceXpInfinityInvariant()) {\r\n    return;\r\n  }\r\n\r\n  updateXpRequirement();\r\n\r\n  // If the requirement is infinite, there is nothing meaningful to normalize.\r\n  if (bigNumIsInfinite(requirementBn)) {\r\n    return;\r\n  }\r\n\r\n  let guard = 0;\r\n  const limit = 10000;\r\n  while (xpState.progress.cmp?.(requirementBn) >= 0 && guard < limit) {\r\n    try { xpState.progress = xpState.progress.sub(requirementBn); }\r\n    catch { xpState.progress = bnZero(); }\r\n\r\n    try { xpState.xpLevel = xpState.xpLevel.add(bnOne()); }\r\n    catch { xpState.xpLevel = bnZero(); }\r\n\r\n    if (applyRewards) handleXpLevelUpRewards();\r\n    updateXpRequirement();\r\n\r\n    if (bigNumIsInfinite(requirementBn)) {\r\n      break;\r\n    }\r\n    guard += 1;\r\n  }\r\n\r\n  if (guard >= limit) {\r\n    xpState.progress = bnZero();\r\n  }\r\n}\r\n\r\nfunction xpLevelBigIntInfo(xpLevelValue) {\r\n  if (!xpLevelValue || typeof xpLevelValue !== 'object') {\r\n    return { bigInt: 0n, finite: false };\r\n  }\r\n  const levelIsInfinite = xpLevelValue.isInfinite?.() || (typeof xpLevelValue.isInfinite === 'function' && xpLevelValue.isInfinite());\r\n  if (levelIsInfinite) {\r\n    return { bigInt: null, finite: false };\r\n  }\r\n  let plain = '0';\r\n  try {\r\n    plain = xpLevelValue.toPlainIntegerString?.() ?? xpLevelValue.toString?.() ?? '0';\r\n  } catch {\r\n    plain = '0';\r\n  }\r\n  if (!plain || plain === 'Infinity') {\r\n    return { bigInt: null, finite: true };\r\n  }\r\n  try {\r\n    return { bigInt: BigInt(plain), finite: true };\r\n  } catch {\r\n    return { bigInt: null, finite: true };\r\n  }\r\n}\r\n\r\nfunction syncCoinMultiplierWithXpLevel(force = false) {\r\n  const multApi = bank?.coins?.mult;\r\n  if (!multApi || typeof multApi.set !== 'function' || typeof multApi.multiplyByDecimal !== 'function') {\r\n    return;\r\n  }\r\n\r\n  const levelInfo = xpLevelBigIntInfo(xpState.xpLevel);\r\n  const levelBigInt = levelInfo.bigInt;\r\n  const levelIsInfinite = !levelInfo.finite;\r\n  const levelStorageKey = typeof xpState.xpLevel?.toStorage === 'function' ? xpState.xpLevel.toStorage() : null;\r\n\r\n  if (!force) {\r\n    if (levelIsInfinite && lastSyncedCoinLevelWasInfinite) {\r\n      return;\r\n    }\r\n    if (!levelIsInfinite && levelBigInt != null && !lastSyncedCoinLevelWasInfinite && !lastSyncedCoinUsedApproximation && lastSyncedCoinLevel != null && levelBigInt === lastSyncedCoinLevel) {\r\n      return;\r\n    }\r\n    if (!levelIsInfinite && levelBigInt == null && lastSyncedCoinUsedApproximation && levelStorageKey && lastSyncedCoinApproxKey && levelStorageKey === lastSyncedCoinApproxKey) {\r\n      return;\r\n    }\r\n  }\r\n\r\n  if (levelIsInfinite) {\r\n    try { multApi.set(infinityRequirementBn); } catch {}\r\n    lastSyncedCoinLevel = null;\r\n    lastSyncedCoinLevelWasInfinite = true;\r\n    lastSyncedCoinUsedApproximation = false;\r\n    lastSyncedCoinApproxKey = null;\r\n    return;\r\n  }\r\n\r\n  let multiplierBn;\r\n  if (levelBigInt != null && levelBigInt <= EXACT_COIN_LEVEL_LIMIT) {\r\n    let working = BigNum.fromInt(1);\r\n    const iterations = Number(levelBigInt);\r\n    for (let i = 0; i < iterations; i += 1) {\r\n      working = working.mulDecimal('1.1', 18);\r\n    }\r\n    let levelAdd;\r\n    try { levelAdd = BigNum.fromAny(levelBigInt.toString()); }\r\n    catch { levelAdd = BigNum.fromInt(iterations); }\r\n    if (typeof working.add === 'function') {\r\n      working = working.add(levelAdd);\r\n    } else if (typeof levelAdd.add === 'function') {\r\n      working = levelAdd.add(working);\r\n    }\r\n    multiplierBn = working.clone?.() ?? working;\r\n  } else {\r\n    multiplierBn = approximateCoinMultiplierFromBigNum(xpState.xpLevel);\r\n  }\r\n\r\n  let finalMultiplier = multiplierBn.clone?.() ?? multiplierBn;\r\n  const providers = coinMultiplierProviders.size > 0\r\n    ? Array.from(coinMultiplierProviders)\r\n    : (typeof externalCoinMultiplierProvider === 'function' ? [externalCoinMultiplierProvider] : []);\r\n  for (const provider of providers) {\r\n    if (typeof provider !== 'function') continue;\r\n    try {\r\n      const maybe = provider({\r\n        baseMultiplier: finalMultiplier.clone?.() ?? finalMultiplier,\r\n        xpLevel: xpState.xpLevel.clone?.() ?? xpState.xpLevel,\r\n        xpUnlocked: xpState.unlocked,\r\n      });\r\n      if (maybe instanceof BigNum) {\r\n        finalMultiplier = maybe.clone?.() ?? maybe;\r\n      } else if (maybe != null) {\r\n        finalMultiplier = BigNum.fromAny(maybe);\r\n      }\r\n    } catch {}\r\n  }\r\n\r\n  const multIsInf = finalMultiplier.isInfinite?.() || (typeof finalMultiplier.isInfinite === 'function' && finalMultiplier.isInfinite());\r\n  try { multApi.set(finalMultiplier.clone?.() ?? finalMultiplier); } catch {}\r\n  if (multIsInf) {\r\n    lastSyncedCoinLevel = null;\r\n    lastSyncedCoinLevelWasInfinite = true;\r\n    lastSyncedCoinUsedApproximation = false;\r\n    lastSyncedCoinApproxKey = null;\r\n  } else if (levelBigInt != null && levelBigInt <= EXACT_COIN_LEVEL_LIMIT) {\r\n    lastSyncedCoinLevel = levelBigInt;\r\n    lastSyncedCoinLevelWasInfinite = false;\r\n    lastSyncedCoinUsedApproximation = false;\r\n    lastSyncedCoinApproxKey = null;\r\n  } else {\r\n    lastSyncedCoinLevel = null;\r\n    lastSyncedCoinLevelWasInfinite = false;\r\n    lastSyncedCoinUsedApproximation = true;\r\n    lastSyncedCoinApproxKey = levelStorageKey;\r\n  }\r\n}\r\n\r\nfunction ensureStateLoaded(force = false) {\r\n  const slot = getActiveSlot();\r\n  if (slot == null) {\r\n    lastSlot = null;\r\n    stateLoaded = false;\r\n    xpState.unlocked = false;\r\n    resetLockedXpState();\r\n    return xpState;\r\n  }\r\n  if (!force && stateLoaded && slot === lastSlot) return xpState;\r\n  lastSlot = slot;\r\n  stateLoaded = true;\r\n  try {\r\n    const unlockedRaw = localStorage.getItem(KEY_UNLOCK(slot));\r\n    xpState.unlocked = unlockedRaw === '1';\r\n  } catch {\r\n    xpState.unlocked = false;\r\n  }\r\n  try {\r\n    xpState.xpLevel = BigNum.fromAny(localStorage.getItem(KEY_XP_LEVEL(slot)) ?? '0');\r\n  } catch {\r\n    xpState.xpLevel = bnZero();\r\n  }\r\n  try {\r\n    xpState.progress = BigNum.fromAny(localStorage.getItem(KEY_PROGRESS(slot)) ?? '0');\r\n  } catch {\r\n    xpState.progress = bnZero();\r\n  }\r\n  if (!xpState.unlocked) {\r\n    resetLockedXpState();\r\n    return xpState;\r\n  }\r\n\r\n  enforceXpInfinityInvariant();\r\n\r\n  updateXpRequirement();\r\n  syncCoinMultiplierWithXpLevel(true);\r\n  ensureXpStorageWatchers();\r\n  return xpState;\r\n}\r\n\r\nfunction persistState() {\r\n  const slot = getActiveSlot();\r\n  if (slot == null) return;\r\n\r\n  const expected = {\r\n    unlocked: xpState.unlocked ? '1' : '0',\r\n    level: xpState.xpLevel.toStorage(),\r\n    progress: xpState.progress.toStorage(),\r\n  };\r\n\r\n  try { localStorage.setItem(KEY_UNLOCK(slot), expected.unlocked); }\r\n  catch {}\r\n  try { localStorage.setItem(KEY_XP_LEVEL(slot), expected.level); }\r\n  catch {}\r\n  try { localStorage.setItem(KEY_PROGRESS(slot), expected.progress); }\r\n  catch {}\r\n\r\n  const persisted = (() => {\r\n    let unlocked = xpState.unlocked;\r\n    let level = xpState.xpLevel;\r\n    let progress = xpState.progress;\r\n    try { unlocked = localStorage.getItem(KEY_UNLOCK(slot)) === '1'; }\r\n    catch {}\r\n    try {\r\n      const rawLevel = localStorage.getItem(KEY_XP_LEVEL(slot));\r\n      if (rawLevel) level = BigNum.fromAny(rawLevel);\r\n    } catch {}\r\n    try {\r\n      const rawProgress = localStorage.getItem(KEY_PROGRESS(slot));\r\n      if (rawProgress) progress = BigNum.fromAny(rawProgress);\r\n    } catch {}\r\n    return { unlocked, level, progress };\r\n  })();\r\n\r\n  primeStorageWatcherSnapshot(KEY_UNLOCK(slot), persisted.unlocked ? '1' : '0');\r\n  primeStorageWatcherSnapshot(KEY_XP_LEVEL(slot), persisted.level?.toStorage?.() ?? expected.level);\r\n  primeStorageWatcherSnapshot(KEY_PROGRESS(slot), persisted.progress?.toStorage?.() ?? expected.progress);\r\n\r\n  const mismatch =\r\n    persisted.unlocked !== xpState.unlocked ||\r\n    (persisted.level?.toStorage?.() ?? null) !== expected.level ||\r\n    (persisted.progress?.toStorage?.() ?? null) !== expected.progress;\r\n\r\n  if (mismatch) {\r\n    xpState.unlocked = persisted.unlocked;\r\n    xpState.xpLevel = persisted.level;\r\n    xpState.progress = persisted.progress;\r\n    updateXpRequirement();\r\n    syncCoinMultiplierWithXpLevel(true);\r\n    updateHud();\r\n  }\r\n}\r\n\r\nfunction handleXpLevelUpRewards() {\r\n  syncCoinMultiplierWithXpLevel(true);\r\n\r\n  let reward = bnOne();\r\n  if (typeof externalBookRewardProvider === 'function') {\r\n    try {\r\n      const maybe = externalBookRewardProvider({\r\n        baseReward: reward.clone?.() ?? reward,\r\n        xpLevel: xpState.xpLevel.clone?.() ?? xpState.xpLevel,\r\n        xpUnlocked: xpState.unlocked,\r\n      });\r\n      if (maybe instanceof BigNum) {\r\n        reward = maybe.clone?.() ?? maybe;\r\n      } else if (maybe != null) {\r\n        reward = BigNum.fromAny(maybe);\r\n      }\r\n    } catch {}\r\n  }\r\n\r\n  try {\r\n    if (bank?.books?.addWithMultiplier) {\r\n      bank.books.addWithMultiplier(reward);\r\n    } else if (bank?.books?.add) {\r\n      bank.books.add(reward);\r\n    }\r\n  } catch {}\r\n  const syncedLevelInfo = xpLevelBigIntInfo(xpState.xpLevel);\r\n  if (!syncedLevelInfo.finite) {\r\n    lastSyncedCoinLevel = null;\r\n    lastSyncedCoinLevelWasInfinite = true;\r\n    lastSyncedCoinUsedApproximation = false;\r\n    lastSyncedCoinApproxKey = null;\r\n  } else if (syncedLevelInfo.bigInt != null) {\r\n    lastSyncedCoinLevel = syncedLevelInfo.bigInt;\r\n    lastSyncedCoinLevelWasInfinite = false;\r\n    lastSyncedCoinUsedApproximation = false;\r\n    lastSyncedCoinApproxKey = null;\r\n  } else {\r\n    lastSyncedCoinLevel = null;\r\n    lastSyncedCoinLevelWasInfinite = false;\r\n    lastSyncedCoinUsedApproximation = true;\r\n    lastSyncedCoinApproxKey = typeof xpState.xpLevel?.toStorage === 'function' ? xpState.xpLevel.toStorage() : null;\r\n  }\r\n}\r\n\r\nfunction updateHud() {\r\n  if (!ensureHudRefs()) return;\r\n  const { container, bar, fill, xpLevelValue, progress } = hudRefs;\r\n  if (!container) return;\r\n  if (!xpState.unlocked) {\r\n    container.setAttribute('hidden', '');\r\n    if (fill) {\r\n      fill.style.setProperty('--xp-fill', '0%');\r\n      fill.style.width = '0%';\r\n    }\r\n    if (xpLevelValue) xpLevelValue.textContent = '0';\r\n    if (progress) {\r\n      const reqHtml = formatNumber(requirementBn);\r\n      progress.innerHTML = `<span class=\"xp-progress-current\">0</span><span class=\"xp-progress-separator\">/</span><span class=\"xp-progress-required\">${reqHtml}</span><span class=\"xp-progress-suffix\">XP</span>`;\r\n    }\r\n    if (bar) {\r\n      bar.setAttribute('aria-valuenow', '0');\r\n      const reqPlain = stripHtml(formatNumber(requirementBn));\r\n      bar.setAttribute('aria-valuetext', `0 / ${reqPlain || '10'} XP`);\r\n    }\r\n    syncXpMpHudLayout();\r\n    return;\r\n  }\r\n\r\n  container.removeAttribute('hidden');\r\n  const requirement = requirementBn;\r\n  const ratio = progressRatio(xpState.progress, requirement);\r\n  const pct = `${(ratio * 100).toFixed(2)}%`;\r\n  if (fill) {\r\n    fill.style.setProperty('--xp-fill', pct);\r\n    fill.style.width = pct;\r\n  }\r\n  if (xpLevelValue) {\r\n    xpLevelValue.innerHTML = formatNumber(xpState.xpLevel);\r\n  }\r\n  if (progress) {\r\n    const currentHtml = formatNumber(xpState.progress);\r\n    const reqHtml = formatNumber(requirement);\r\n    progress.innerHTML = `<span class=\"xp-progress-current\">${currentHtml}</span><span class=\"xp-progress-separator\">/</span><span class=\"xp-progress-required\">${reqHtml}</span><span class=\"xp-progress-suffix\">XP</span>`;\r\n  }\r\n  if (bar) {\r\n    bar.setAttribute('aria-valuenow', (ratio * 100).toFixed(2));\r\n    const currPlain = stripHtml(formatNumber(xpState.progress));\r\n    const reqPlain = stripHtml(formatNumber(requirement));\r\n    bar.setAttribute('aria-valuetext', `${currPlain} / ${reqPlain} XP`);\r\n  }\r\n  syncXpMpHudLayout();\r\n}\r\n\r\nexport function initXpSystem({ forceReload = false } = {}) {\r\n  ensureHudRefs();\r\n  ensureStateLoaded(forceReload);\r\n  updateXpRequirement();\r\n  updateHud();\r\n  ensureXpStorageWatchers();\r\n  return getXpState();\r\n}\r\n\r\nexport function unlockXpSystem() {\r\n  ensureStateLoaded();\r\n  if (xpState.unlocked) {\r\n    updateHud();\r\n    return false;\r\n  }\r\n  resetLockedXpState();\r\n  xpState.unlocked = true;\r\n  persistState();\r\n  updateHud();\r\n  syncCoinMultiplierWithXpLevel(true);\r\n  try {\r\n    window.dispatchEvent(new CustomEvent('xp:unlock', { detail: getXpState() }));\r\n  } catch {}\r\n  return true;\r\n}\r\n\r\nexport function resetXpProgress({ keepUnlock = true } = {}) {\r\n  ensureStateLoaded();\r\n  const wasUnlocked = xpState.unlocked;\r\n  resetLockedXpState();\r\n  xpState.unlocked = keepUnlock ? (wasUnlocked || xpState.unlocked) : false;\r\n  persistState();\r\n  updateHud();\r\n  syncCoinMultiplierWithXpLevel(true);\r\n  return getXpState();\r\n}\r\n\r\nexport function addXp(amount, { silent = false } = {}) {\r\n  ensureStateLoaded();\r\n  const slot = lastSlot ?? getActiveSlot();\r\n  if (!xpState.unlocked) {\r\n    return {\r\n      unlocked: false,\r\n      xpLevelsGained: bnZero(),\r\n      xpAdded: bnZero(),\r\n      xpLevel: xpState.xpLevel,\r\n      requirement: requirementBn\r\n    };\r\n  }\r\n\r\n  let inc;\r\n  try {\r\n    if (amount instanceof BigNum) {\r\n      inc = amount.clone?.() ?? BigNum.fromAny(amount ?? 0);\r\n    } else {\r\n      inc = BigNum.fromAny(amount ?? 0);\r\n    }\r\n  } catch {\r\n    inc = bnZero();\r\n  }\r\n\r\n  // External XP gain multipliers\r\n  if (!inc.isZero?.()) {\r\n    const providers = xpGainMultiplierProviders.size > 0\r\n      ? Array.from(xpGainMultiplierProviders)\r\n      : (typeof externalXpGainMultiplierProvider === 'function' ? [externalXpGainMultiplierProvider] : []);\r\n    for (const provider of providers) {\r\n      if (typeof provider !== 'function') continue;\r\n      try {\r\n        const maybe = provider({\r\n          baseGain: inc.clone?.() ?? inc,\r\n          xpLevel: xpState.xpLevel.clone?.() ?? xpState.xpLevel,\r\n          xpUnlocked: xpState.unlocked,\r\n        });\r\n        if (maybe instanceof BigNum) {\r\n          inc = maybe.clone?.() ?? maybe;\r\n        } else if (maybe != null) {\r\n          inc = BigNum.fromAny(maybe);\r\n        }\r\n      } catch {}\r\n    }\r\n  }\r\n\r\n  inc = applyStatMultiplierOverride('xp', inc);\r\n\r\n  if (inc.isZero?.() || (typeof inc.isZero === 'function' && inc.isZero())) {\r\n    updateHud();\r\n    return {\r\n      unlocked: true,\r\n      xpLevelsGained: bnZero(),\r\n      xpAdded: inc,\r\n      xpLevel: xpState.xpLevel,\r\n      requirement: requirementBn\r\n    };\r\n  }\r\n\r\n  // Apply gain\r\n  xpState.progress = xpState.progress.add(inc);\r\n  updateXpRequirement();\r\n\r\n  // If the gain, the current progress, or the current level is infinite,\r\n  // snap the entire XP system (level, progress, requirement, and coin multiplier) to \u221E.\r\n  const progressIsInf = xpState.progress?.isInfinite?.()\r\n    || (typeof xpState.progress?.isInfinite === 'function' && xpState.progress.isInfinite());\r\n  const levelIsInf = xpState.xpLevel?.isInfinite?.()\r\n    || (typeof xpState.xpLevel?.isInfinite === 'function' && xpState.xpLevel.isInfinite());\r\n  const gainIsInf = inc?.isInfinite?.()\r\n    || (typeof inc?.isInfinite === 'function' && inc.isInfinite());\r\n\r\n  if (progressIsInf || levelIsInf || gainIsInf) {\r\n    const inf = infinityRequirementBn.clone?.() ?? infinityRequirementBn;\r\n\r\n    xpState.xpLevel = inf.clone?.() ?? inf;\r\n    xpState.progress = inf.clone?.() ?? inf;\r\n    requirementBn = inf.clone?.() ?? inf;\r\n\r\n    // NEW: also enforce the Books = \u221E rule\r\n    enforceXpInfinityInvariant();\r\n\r\n    persistState();\r\n    updateHud();\r\n    // Make sure the coin multiplier from XP is also locked to \u221E.\r\n    syncCoinMultiplierWithXpLevel(true);\r\n\r\n    const detail = {\r\n      unlocked: true,\r\n      xpLevelsGained: bnZero(),\r\n      xpAdded: inc.clone?.() ?? inc,\r\n      xpLevel: xpState.xpLevel.clone?.() ?? xpState.xpLevel,\r\n      progress: xpState.progress.clone?.() ?? xpState.progress,\r\n      requirement: requirementBn.clone?.() ?? requirementBn,\r\n      slot,\r\n    };\r\n    notifyXpSubscribers(detail);\r\n    if (!silent && typeof window !== 'undefined') {\r\n      try { window.dispatchEvent(new CustomEvent('xp:change', { detail })); } catch {}\r\n    }\r\n    return detail;\r\n  }\r\n\r\n  // Normal finite-path level up loop\r\n  let xpLevelsGained = bnZero();\r\n  let guard = 0;\r\n  const limit = 100000;\r\n  while (xpState.progress.cmp?.(requirementBn) >= 0 && guard < limit) {\r\n    xpState.progress = xpState.progress.sub(requirementBn);\r\n    xpState.xpLevel = xpState.xpLevel.add(bnOne());\r\n    xpLevelsGained = xpLevelsGained.add(bnOne());\r\n    handleXpLevelUpRewards();\r\n    updateXpRequirement();\r\n    const reqIsInf = requirementBn.isInfinite?.()\r\n      || (typeof requirementBn.isInfinite === 'function' && requirementBn.isInfinite());\r\n    if (reqIsInf) {\r\n      break;\r\n    }\r\n    guard += 1;\r\n  }\r\n  if (guard >= limit) {\r\n    // Only clamp finite progress if we truly hit the guard.\r\n    xpState.progress = bnZero();\r\n  }\r\n\r\n  persistState();\r\n  updateHud();\r\n\r\n  // Maintain sync flags\r\n  const syncedLevelAfterAdd = xpLevelBigIntInfo(xpState.xpLevel);\r\n  if (!syncedLevelAfterAdd.finite) {\r\n    lastSyncedCoinLevel = null;\r\n    lastSyncedCoinLevelWasInfinite = true;\r\n    lastSyncedCoinUsedApproximation = false;\r\n    lastSyncedCoinApproxKey = null;\r\n  } else if (syncedLevelAfterAdd.bigInt != null) {\r\n    lastSyncedCoinLevel = syncedLevelAfterAdd.bigInt;\r\n    lastSyncedCoinLevelWasInfinite = false;\r\n    lastSyncedCoinUsedApproximation = false;\r\n    lastSyncedCoinApproxKey = null;\r\n  } else {\r\n    lastSyncedCoinLevel = null;\r\n    lastSyncedCoinLevelWasInfinite = false;\r\n    lastSyncedCoinUsedApproximation = true;\r\n    lastSyncedCoinApproxKey = typeof xpState.xpLevel?.toStorage === 'function'\r\n      ? xpState.xpLevel.toStorage()\r\n      : null;\r\n  }\r\n\r\n  const detail = {\r\n    unlocked: true,\r\n    xpLevelsGained: xpLevelsGained.clone?.() ?? xpLevelsGained,\r\n    xpAdded: inc.clone?.() ?? inc,\r\n    xpLevel: xpState.xpLevel.clone?.() ?? xpState.xpLevel,\r\n    progress: xpState.progress.clone?.() ?? xpState.progress,\r\n    requirement: requirementBn.clone?.() ?? requirementBn,\r\n    slot,\r\n  };\r\n  notifyXpSubscribers(detail);\r\n  if (!silent && typeof window !== 'undefined') {\r\n    try { window.dispatchEvent(new CustomEvent('xp:change', { detail })); } catch {}\r\n  }\r\n  return detail;\r\n}\r\n\r\nexport function getXpState() {\r\n  ensureStateLoaded();\r\n  return {\r\n    unlocked: xpState.unlocked,\r\n    xpLevel: xpState.xpLevel.clone?.() ?? xpState.xpLevel,\r\n    progress: xpState.progress.clone?.() ?? xpState.progress,\r\n    requirement: requirementBn.clone?.() ?? requirementBn,\r\n  };\r\n}\r\n\r\nexport function broadcastXpChange(detailOverrides = {}) {\r\n  ensureStateLoaded();\r\n  const slot = lastSlot ?? getActiveSlot();\r\n  const detail = {\r\n    ...getXpState(),\r\n    slot,\r\n    ...detailOverrides,\r\n  };\r\n\r\n  notifyXpSubscribers(detail);\r\n  if (typeof window !== 'undefined') {\r\n    try { window.dispatchEvent(new CustomEvent('xp:change', { detail })); } catch {}\r\n  }\r\n\r\n  return detail;\r\n}\r\n\r\nexport function isXpSystemUnlocked() {\r\n  ensureStateLoaded();\r\n  return !!xpState.unlocked;\r\n}\r\n\r\nexport function getXpRequirementForXpLevel(xpLevel) {\r\n  return xpRequirementForXpLevel(xpLevel);\r\n}\r\n\r\nexport function computeCoinMultiplierForXpLevel(levelValue) {\r\n  let xpLevelBn;\r\n  try {\r\n    xpLevelBn = levelValue instanceof BigNum ? levelValue : BigNum.fromAny(levelValue ?? 0);\r\n  } catch {\r\n    xpLevelBn = BigNum.fromInt(0);\r\n  }\r\n\r\n  const levelInfo = xpLevelBigIntInfo(xpLevelBn);\r\n  const levelBigInt = levelInfo.bigInt;\r\n  const levelIsInfinite = !levelInfo.finite;\r\n\r\n  if (levelIsInfinite) {\r\n    return infinityRequirementBn.clone?.() ?? infinityRequirementBn;\r\n  }\r\n\r\n  let multiplierBn;\r\n  if (levelBigInt != null && levelBigInt <= EXACT_COIN_LEVEL_LIMIT) {\r\n    let working = BigNum.fromInt(1);\r\n    const iterations = Number(levelBigInt);\r\n    for (let i = 0; i < iterations; i += 1) {\r\n      working = working.mulDecimal('1.1', 18);\r\n    }\r\n    let levelAdd;\r\n    try { levelAdd = BigNum.fromAny(levelBigInt.toString()); }\r\n    catch { levelAdd = BigNum.fromInt(iterations); }\r\n    if (typeof working.add === 'function') {\r\n      working = working.add(levelAdd);\r\n    } else if (typeof levelAdd.add === 'function') {\r\n      working = levelAdd.add(working);\r\n    }\r\n    multiplierBn = working.clone?.() ?? working;\r\n  } else {\r\n    multiplierBn = approximateCoinMultiplierFromBigNum(xpLevelBn);\r\n  }\r\n\r\n  let finalMultiplier = multiplierBn.clone?.() ?? multiplierBn;\r\n  const providers = coinMultiplierProviders.size > 0\r\n    ? Array.from(coinMultiplierProviders)\r\n    : (typeof externalCoinMultiplierProvider === 'function' ? [externalCoinMultiplierProvider] : []);\r\n  for (const provider of providers) {\r\n    if (typeof provider !== 'function') continue;\r\n    try {\r\n      const maybe = provider({\r\n        baseMultiplier: finalMultiplier.clone?.() ?? finalMultiplier,\r\n        xpLevel: xpLevelBn.clone?.() ?? xpLevelBn,\r\n        xpUnlocked: !!xpState.unlocked,\r\n      });\r\n      if (maybe instanceof BigNum) {\r\n        finalMultiplier = maybe.clone?.() ?? maybe;\r\n      } else if (maybe != null) {\r\n        finalMultiplier = BigNum.fromAny(maybe);\r\n      }\r\n    } catch {}\r\n  }\r\n\r\n  return finalMultiplier.clone?.() ?? finalMultiplier;\r\n}\r\n\r\nexport function setExternalCoinMultiplierProvider(fn) {\r\n  externalCoinMultiplierProvider = typeof fn === 'function' ? fn : null;\r\n  coinMultiplierProviders.clear();\r\n  if (externalCoinMultiplierProvider) {\r\n    coinMultiplierProviders.add(externalCoinMultiplierProvider);\r\n  }\r\n  ensureStateLoaded();\r\n  syncCoinMultiplierWithXpLevel(true);\r\n}\r\n\r\nexport function refreshCoinMultiplierFromXpLevel() {\r\n  ensureStateLoaded();\r\n  syncCoinMultiplierWithXpLevel(true);\r\n}\r\n\r\nexport function setExternalXpGainMultiplierProvider(fn) {\r\n  externalXpGainMultiplierProvider = typeof fn === 'function' ? fn : null;\r\n  xpGainMultiplierProviders.clear();\r\n  if (externalXpGainMultiplierProvider) {\r\n    xpGainMultiplierProviders.add(externalXpGainMultiplierProvider);\r\n  }\r\n}\r\n\r\nexport function addExternalCoinMultiplierProvider(fn) {\r\n  if (typeof fn !== 'function') return () => {};\r\n  coinMultiplierProviders.add(fn);\r\n  ensureStateLoaded();\r\n  syncCoinMultiplierWithXpLevel(true);\r\n  return () => {\r\n    coinMultiplierProviders.delete(fn);\r\n    ensureStateLoaded();\r\n    syncCoinMultiplierWithXpLevel(true);\r\n  };\r\n}\r\n\r\nexport function addExternalXpGainMultiplierProvider(fn) {\r\n  if (typeof fn !== 'function') return () => {};\r\n  xpGainMultiplierProviders.add(fn);\r\n  ensureStateLoaded();\r\n  return () => {\r\n    xpGainMultiplierProviders.delete(fn);\r\n  };\r\n}\r\n\r\nexport function setExternalBookRewardProvider(fn) {\r\n  externalBookRewardProvider = typeof fn === 'function' ? fn : null;\r\n}\r\n\r\nif (typeof window !== 'undefined') {\r\n  window.xpSystem = window.xpSystem || {};\r\n  Object.assign(window.xpSystem, {\r\n    initXpSystem,\r\n    unlockXpSystem,\r\n    addXp,\r\n    getXpState,\r\n    isXpSystemUnlocked,\r\n    getXpRequirementForXpLevel,\r\n    setExternalCoinMultiplierProvider,\r\n    addExternalCoinMultiplierProvider,\r\n    refreshCoinMultiplierFromXpLevel,\r\n    setExternalXpGainMultiplierProvider,\r\n    addExternalXpGainMultiplierProvider,\r\n    setExternalBookRewardProvider,\r\n    resetXpProgress,\r\n  });\r\n}\r\n", "// js/ui/merchantDelve/resetTab.js\r\nimport { BigNum } from '../../util/bigNum.js';\r\nimport {\r\n  bank,\r\n  getActiveSlot,\r\n  watchStorageKey,\r\n  primeStorageWatcherSnapshot,\r\n  onCurrencyChange,\r\n  CURRENCIES,\r\n} from '../../util/storage.js';\r\nimport { formatNumber } from '../../util/numFormat.js';\r\nimport {\r\n  getXpState,\r\n  resetXpProgress,\r\n  onXpChange,\r\n} from '../../game/xpSystem.js';\r\nimport {\r\n  AREA_KEYS,\r\n  UPGRADE_TIES,\r\n  getUpgradesForArea,\r\n  getLevelNumber,\r\n  setLevel,\r\n  approxLog10BigNum,\r\n  bigNumFromLog10,\r\n} from '../../game/upgrades.js';\r\nimport {\r\n  initMutationSystem,\r\n  unlockMutationSystem,\r\n  isMutationUnlocked,\r\n  getMutationCoinSprite,\r\n  onMutationChange,\r\n} from '../../game/mutationSystem.js';\r\n\r\nconst BN = BigNum;\r\nconst bnZero = () => BN.fromInt(0);\r\nconst bnOne = () => BN.fromInt(1);\r\n\r\nconst GOLD_ICON_SRC = 'img/currencies/gold/gold.png';\r\nconst RESET_ICON_SRC = 'img/misc/forge.png';\r\nconst FORGE_RESET_SOUND_SRC = 'sounds/forge_reset.mp3';\r\n\r\nlet forgeResetAudio = null;\r\nfunction playForgeResetSound() {\r\n  try {\r\n    if (!forgeResetAudio) {\r\n      forgeResetAudio = new Audio(FORGE_RESET_SOUND_SRC);\r\n    } else {\r\n      forgeResetAudio.currentTime = 0;\r\n    }\r\n    forgeResetAudio.play().catch(() => {});\r\n  } catch {}\r\n}\r\n\r\nconst FORGE_UNLOCK_KEY = (slot) => `ccc:reset:forge:${slot}`;\r\nconst FORGE_COMPLETED_KEY = (slot) => `ccc:reset:forge:completed:${slot}`;\r\nconst FORGE_DEBUG_OVERRIDE_KEY = (slot) => `ccc:debug:forgeUnlocked:${slot}`;\r\n\r\nconst MIN_FORGE_LEVEL = BN.fromInt(31);\r\n\r\nconst resetState = {\r\n  slot: null,\r\n  forgeUnlocked: false,\r\n  hasDoneForgeReset: false,\r\n  pendingGold: bnZero(),\r\n  panel: null,\r\n  pendingEl: null,\r\n  requirementEl: null,\r\n  actionBtn: null,\r\n  statusEl: null,\r\n  layerButtons: {},\r\n  flagsPrimed: false,\r\n};\r\n\r\nconst watchers = [];\r\nlet watchersBoundSlot = null;\r\nlet initialized = false;\r\nlet mutationUnsub = null;\r\nlet pendingGoldInputSignature = null;\r\nlet coinChangeUnsub = null;\r\nlet xpChangeUnsub = null;\r\n\r\nfunction resetPendingGoldSignature() {\r\n  pendingGoldInputSignature = null;\r\n}\r\n\r\nfunction getPendingGoldWithMultiplier() {\r\n  try {\r\n    return bank.gold?.mult?.applyTo?.(resetState.pendingGold) ?? resetState.pendingGold;\r\n  } catch {\r\n    return resetState.pendingGold;\r\n  }\r\n}\r\n\r\nfunction cleanupWatchers() {\r\n  while (watchers.length) {\r\n    const stop = watchers.pop();\r\n    try { stop?.(); } catch {}\r\n  }\r\n}\r\n\r\nfunction ensureValueListeners() {\r\n  if (!coinChangeUnsub && typeof onCurrencyChange === 'function') {\r\n    coinChangeUnsub = onCurrencyChange((detail = {}) => {\r\n      if (detail?.key && detail.key !== CURRENCIES.COINS) return;\r\n      if (detail?.slot != null && resetState.slot != null && detail.slot !== resetState.slot) return;\r\n      recomputePendingGold();\r\n    });\r\n  }\r\n  if (!xpChangeUnsub && typeof onXpChange === 'function') {\r\n    xpChangeUnsub = onXpChange((detail = {}) => {\r\n      if (detail?.slot != null && resetState.slot != null && detail.slot !== resetState.slot) return;\r\n      recomputePendingGold();\r\n      updateResetPanel();\r\n    });\r\n  }\r\n}\r\n\r\nfunction levelToNumber(levelBn) {\r\n  if (!levelBn || typeof levelBn !== 'object') return 0;\r\n  if (levelBn.isInfinite?.()) return Number.POSITIVE_INFINITY;\r\n  try {\r\n    const plain = levelBn.toPlainIntegerString?.();\r\n    if (plain && plain !== 'Infinity' && plain.length <= 15) {\r\n      const num = Number(plain);\r\n      if (Number.isFinite(num)) return num;\r\n    }\r\n  } catch {}\r\n  const approx = approxLog10BigNum(levelBn);\r\n  if (!Number.isFinite(approx)) return Number.POSITIVE_INFINITY;\r\n  if (approx > 308) return Number.POSITIVE_INFINITY;\r\n  return Math.pow(10, approx);\r\n}\r\n\r\nfunction getXpLevelBn() {\r\n  try {\r\n    const state = getXpState();\r\n    if (state && state.xpLevel) return state.xpLevel;\r\n  } catch {}\r\n  return bnZero();\r\n}\r\n\r\nfunction computeForgeGold(coinsBn, levelBn) {\r\n  if (!coinsBn || typeof coinsBn !== 'object') return bnZero();\r\n  if (coinsBn.isZero?.()) return bnZero();\r\n  const logCoins = approxLog10BigNum(coinsBn);\r\n  if (!Number.isFinite(logCoins)) {\r\n    return logCoins > 0 ? BN.fromAny('Infinity') : bnZero();\r\n  }\r\n  const logScaled = logCoins - 5;\r\n  if (!Number.isFinite(logScaled)) return bnZero();\r\n  const pow2 = bigNumFromLog10(logScaled * Math.log10(2));\r\n  const levelNum = Math.max(0, levelToNumber(levelBn));\r\n  const levelFactor = Math.max(0, (levelNum - 30) / 5);\r\n  const pow14 = levelFactor <= 0\r\n    ? bnOne()\r\n    : bigNumFromLog10(levelFactor * Math.log10(1.4));\r\n  const floorLog = Math.floor(logScaled);\r\n  const pow115 = floorLog <= 0\r\n    ? bnOne()\r\n    : bigNumFromLog10(floorLog * Math.log10(1.15));\r\n  let total = BN.fromInt(10);\r\n  total = total.mulBigNumInteger(pow2);\r\n  total = total.mulBigNumInteger(pow14);\r\n  total = total.mulBigNumInteger(pow115);\r\n  const floored = total.floorToInteger();\r\n  return floored.isZero?.() ? bnZero() : floored;\r\n}\r\n\r\nexport function computeForgeGoldFromInputs(coinsBn, levelBn) {\r\n  return computeForgeGold(coinsBn, levelBn);\r\n}\r\n\r\nfunction getXpLevelNumber() {\r\n  return Math.max(0, levelToNumber(getXpLevelBn()));\r\n}\r\n\r\nfunction ensureResetSlot() {\r\n  if (resetState.slot != null) return resetState.slot;\r\n  const slot = getActiveSlot();\r\n  resetState.slot = slot;\r\n  return slot;\r\n}\r\n\r\nexport function setForgeResetCompleted(value) {\r\n  const slot = ensureResetSlot();\r\n  if (slot == null) return;\r\n  resetState.hasDoneForgeReset = !!value;\r\n  try { localStorage.setItem(FORGE_COMPLETED_KEY(slot), resetState.hasDoneForgeReset ? '1' : '0'); }\r\n  catch {}\r\n  primeStorageWatcherSnapshot(FORGE_COMPLETED_KEY(slot));\r\n}\r\n\r\nfunction getForgeDebugOverride(slot = getActiveSlot()) {\r\n  if (slot == null) return null;\r\n  try {\r\n    const raw = localStorage.getItem(FORGE_DEBUG_OVERRIDE_KEY(slot));\r\n    if (raw === '1') return true;\r\n    if (raw === '0') return false;\r\n  } catch {}\r\n  return null;\r\n}\r\n\r\nexport function getForgeDebugOverrideState(slot = getActiveSlot()) {\r\n  return getForgeDebugOverride(slot);\r\n}\r\n\r\nexport function setForgeDebugOverride(value, slot = getActiveSlot()) {\r\n  if (slot == null) return;\r\n  if (value == null) {\r\n    try { localStorage.removeItem(FORGE_DEBUG_OVERRIDE_KEY(slot)); } catch {}\r\n    primeStorageWatcherSnapshot(FORGE_DEBUG_OVERRIDE_KEY(slot));\r\n    return;\r\n  }\r\n  const normalized = !!value;\r\n  try { localStorage.setItem(FORGE_DEBUG_OVERRIDE_KEY(slot), normalized ? '1' : '0'); }\r\n  catch {}\r\n  primeStorageWatcherSnapshot(FORGE_DEBUG_OVERRIDE_KEY(slot));\r\n}\r\n\r\nfunction setForgeUnlocked(value) {\r\n  const slot = ensureResetSlot();\r\n  if (slot == null) return;\r\n  resetState.forgeUnlocked = !!value;\r\n  try { localStorage.setItem(FORGE_UNLOCK_KEY(slot), resetState.forgeUnlocked ? '1' : '0'); }\r\n  catch {}\r\n  primeStorageWatcherSnapshot(FORGE_UNLOCK_KEY(slot));\r\n}\r\n\r\nfunction readPersistentFlags(slot) {\r\n  if (slot == null) {\r\n    resetState.forgeUnlocked = false;\r\n    resetState.hasDoneForgeReset = false;\r\n    resetState.flagsPrimed = false;\r\n    return;\r\n  }\r\n  try {\r\n    resetState.forgeUnlocked = localStorage.getItem(FORGE_UNLOCK_KEY(slot)) === '1';\r\n  } catch {\r\n    resetState.forgeUnlocked = false;\r\n  }\r\n  try {\r\n    resetState.hasDoneForgeReset = localStorage.getItem(FORGE_COMPLETED_KEY(slot)) === '1';\r\n  } catch {\r\n    resetState.hasDoneForgeReset = false;\r\n  }\r\n  resetState.flagsPrimed = true;\r\n}\r\n\r\nfunction ensurePersistentFlagsPrimed() {\r\n  const slot = getActiveSlot();\r\n  if (slot == null) {\r\n    resetState.flagsPrimed = false;\r\n    return;\r\n  }\r\n  if (resetState.slot !== slot) {\r\n    resetState.slot = slot;\r\n    resetPendingGoldSignature();\r\n    resetState.flagsPrimed = false;\r\n  }\r\n  if (!resetState.flagsPrimed) {\r\n    readPersistentFlags(slot);\r\n  }\r\n}\r\n\r\nfunction bindStorageWatchers(slot) {\r\n  if (watchersBoundSlot === slot) return;\r\n  cleanupWatchers();\r\n  watchersBoundSlot = slot;\r\n  if (slot == null) return;\r\n  watchers.push(watchStorageKey(FORGE_UNLOCK_KEY(slot), {\r\n    onChange(value) {\r\n      const next = value === '1';\r\n      if (resetState.forgeUnlocked !== next) {\r\n        resetState.forgeUnlocked = next;\r\n        updateResetPanel();\r\n      }\r\n    },\r\n  }));\r\n  watchers.push(watchStorageKey(FORGE_COMPLETED_KEY(slot), {\r\n    onChange(value) {\r\n      const next = value === '1';\r\n      if (resetState.hasDoneForgeReset !== next) {\r\n        resetState.hasDoneForgeReset = next;\r\n        updateResetPanel();\r\n      }\r\n    },\r\n  }));\r\n}\r\n\r\nfunction getPendingInputSignature(coins, level) {\r\n  const coinSig = coins?.toStorage?.()\r\n    ?? coins?.toString?.()\r\n    ?? String(coins ?? '');\r\n  const levelSig = level?.toStorage?.()\r\n    ?? level?.toString?.()\r\n    ?? String(level ?? '');\r\n  return `${coinSig}|${levelSig}`;\r\n}\r\n\r\nfunction recomputePendingGold(force = false) {\r\n  const coins = bank.coins?.value ?? bnZero();\r\n  const level = getXpLevelBn();\r\n  const signature = getPendingInputSignature(coins, level);\r\n  if (!force && pendingGoldInputSignature === signature) {\r\n    return;\r\n  }\r\n  pendingGoldInputSignature = signature;\r\n\r\n  if (!meetsLevelRequirement()) {\r\n    resetState.pendingGold = bnZero();\r\n  } else {\r\n    resetState.pendingGold = computeForgeGold(coins, level);\r\n  }\r\n\r\n  updateResetPanel();\r\n}\r\n\r\n\r\nfunction canAccessForgeTab() {\r\n  const override = getForgeDebugOverride();\r\n  if (override != null) return !!override;\r\n  return resetState.forgeUnlocked || getLevelNumber(AREA_KEYS.STARTER_COVE, UPGRADE_TIES.UNLOCK_FORGE) >= 1;\r\n}\r\n\r\nfunction meetsLevelRequirement() {\r\n  try {\r\n    const levelBn = getXpLevelBn();\r\n    if (levelBn && typeof levelBn.cmp === 'function') {\r\n      return levelBn.cmp(MIN_FORGE_LEVEL) >= 0;\r\n    }\r\n  } catch {}\r\n  return false;\r\n}\r\n\r\nexport function isForgeUnlocked() {\r\n  ensurePersistentFlagsPrimed();\r\n  const override = getForgeDebugOverride();\r\n  if (override != null) return !!override;\r\n  return !!resetState.forgeUnlocked || canAccessForgeTab();\r\n}\r\n\r\nexport function hasDoneForgeReset() {\r\n  ensurePersistentFlagsPrimed();\r\n  return !!resetState.hasDoneForgeReset;\r\n}\r\n\r\n\r\nexport function computePendingForgeGold() {\r\n  recomputePendingGold();\r\n  return resetState.pendingGold.clone?.() ?? resetState.pendingGold;\r\n}\r\n\r\nexport function canPerformForgeReset() {\r\n  if (!isForgeUnlocked()) return false;\r\n  if (!meetsLevelRequirement()) return false;\r\n  if (resetState.pendingGold.isZero?.()) return false;\r\n  const coins = bank.coins?.value;\r\n  if (!coins || coins.isZero?.()) return false;\r\n  return true;\r\n}\r\n\r\nfunction resetUpgrades() {\r\n  const upgrades = getUpgradesForArea(AREA_KEYS.STARTER_COVE);\r\n  for (const upg of upgrades) {\r\n    if (!upg) continue;\r\n    const tieKey = upg.tieKey || upg.tie;\r\n    if (tieKey === UPGRADE_TIES.UNLOCK_XP || tieKey === UPGRADE_TIES.UNLOCK_FORGE) continue;\r\n    if (upg.costType === 'gold') continue;\r\n    setLevel(AREA_KEYS.STARTER_COVE, upg.id, 0, true, { resetHmEvolutions: true });\r\n  }\r\n}\r\n\r\nexport function performForgeReset() {\r\n  if (!canPerformForgeReset()) return false;\r\n  const reward = resetState.pendingGold.clone?.() ?? resetState.pendingGold;\r\n  try {\r\n    const withMultiplier = bank.gold?.mult?.applyTo?.(reward) ?? reward;\r\n    if (bank.gold?.add) {\r\n      bank.gold.add(withMultiplier);\r\n    }\r\n  } catch {}\r\n  try { bank.coins.set(0); } catch {}\r\n  try { bank.books.set(0); } catch {}\r\n  try { resetXpProgress({ keepUnlock: true }); } catch {}\r\n  resetUpgrades();\r\n  recomputePendingGold();\r\n  setForgeUnlocked(true);\r\n  if (!resetState.hasDoneForgeReset) {\r\n    setForgeResetCompleted(true);\r\n  }\r\n  initMutationSystem();\r\n  unlockMutationSystem();\r\n  updateResetPanel();\r\n  return true;\r\n}\r\n\r\nfunction formatBn(value) {\r\n  try { return formatNumber(value); }\r\n  catch { return value?.toString?.() ?? '0'; }\r\n}\r\n\r\nfunction setLayerActive(layer) {\r\n  for (const key in resetState.layerButtons) {\r\n    resetState.layerButtons[key].classList.toggle('is-active', key === layer);\r\n  }\r\n}\r\n\r\nfunction buildPanel(panelEl) {\r\n  panelEl.innerHTML = `<div class=\"merchant-reset\"><aside class=\"merchant-reset__sidebar\"><button type=\"button\" class=\"merchant-reset__layer is-active\" data-reset-layer=\"forge\"><img src=\"${RESET_ICON_SRC}\" alt=\"\"><span>Forge</span></button></aside><div class=\"merchant-reset__main\"><div class=\"merchant-reset__layout\"><header class=\"merchant-reset__header\"><div class=\"merchant-reset__titles\"><h3>Forge</h3></div></header><div class=\"merchant-reset__content\"><div class=\"merchant-reset__titles\"><p> Resets Coins, Books, XP, Coin upgrades, and Book upgrades for Gold<br> Increase pending Gold amount by increasing Coins and XP Level<br> The button below shows how much Gold you will get upon reset </p></div><div class=\"merchant-reset__status\" data-reset-status></div></div><div class=\"merchant-reset__actions\"><button type=\"button\" class=\"merchant-reset__action\" data-reset-action><span class=\"merchant-reset__action-plus\">+</span><span class=\"merchant-reset__action-icon\"><img src=\"${GOLD_ICON_SRC}\" alt=\"\"></span><span class=\"merchant-reset__action-amount\" data-reset-pending>0</span></button></div></div></div></div>`;\r\n  resetState.panel = panelEl;\r\n  resetState.pendingEl = panelEl.querySelector('[data-reset-pending]');\r\n  resetState.statusEl = panelEl.querySelector('[data-reset-status]');\r\n  resetState.actionBtn = panelEl.querySelector('[data-reset-action]');\r\n  resetState.mainEl = panelEl.querySelector('.merchant-reset__main');\r\n  resetState.layerButtons = {\r\n    forge: panelEl.querySelector('[data-reset-layer=\"forge\"]'),\r\n  };\r\n  Object.entries(resetState.layerButtons).forEach(([key, btn]) => {\r\n    if (!btn) return;\r\n    btn.addEventListener('click', () => {\r\n      setLayerActive(key);\r\n      updateResetPanel();\r\n    });\r\n  });\r\n  if (resetState.actionBtn) {\r\n  resetState.actionBtn.addEventListener('click', () => {\r\n    if (performForgeReset()) {\r\n      playForgeResetSound();\r\n      updateResetPanel();\r\n    }\r\n  });\r\n}\r\n  updateResetPanel();\r\n}\r\n\r\nexport function initResetPanel(panelEl) {\r\n  if (!panelEl || panelEl.__resetInit) return;\r\n  panelEl.__resetInit = true;\r\n  buildPanel(panelEl);\r\n}\r\n\r\nfunction updatePendingDisplay() {\r\n  if (!resetState.actionBtn) return;\r\n  const amountEl = resetState.actionBtn.querySelector('[data-reset-pending]');\r\n  if (amountEl) {\r\n    amountEl.innerHTML = formatBn(getPendingGoldWithMultiplier());\r\n  }\r\n}\r\n\r\nfunction updateStatusDisplay() {\r\n  if (!resetState.statusEl) return;\r\n  const el = resetState.statusEl;\r\n  el.innerHTML = '';\r\n\r\n  // Make sure we know if the player has already forged\r\n  ensurePersistentFlagsPrimed();\r\n  resetState.mainEl?.classList.toggle('is-forge-complete', !!resetState.hasDoneForgeReset);\r\n  if (resetState.hasDoneForgeReset) {\r\n    return; // no extra text after the first Forge\r\n  }\r\n\r\n  el.innerHTML = `<span style=\"color:#02e815; text-shadow: 0 3px 6px rgba(0,0,0,0.55);\"> Forging for the first time will unlock <span style=\"color:#ffb347; text-shadow: 0 3px 6px rgba(0,0,0,0.55); \">Mutations</span> and a new Merchant dialogue<br> Mutated Coins will yield more Coin and XP value than normal </span>`;\r\n}\r\n\r\nfunction updateActionState() {\r\n  if (!resetState.actionBtn) return;\r\n\r\n  const btn = resetState.actionBtn;\r\n\r\n  // Requirement failures redirect message to the button itself:\r\n  if (!isForgeUnlocked()) {\r\n    btn.disabled = true;\r\n    btn.innerHTML = '<span class=\"merchant-reset__req-msg\">Unlock the Forge upgrade to access resets</span>';\r\n    return;\r\n  }\r\n\r\n  if (!meetsLevelRequirement()) {\r\n    btn.disabled = true;\r\n    btn.innerHTML = '<span class=\"merchant-reset__req-msg\">Reach XP Level 31 to perform a Forge reset</span>';\r\n    return;\r\n  }\r\n\r\n  if (resetState.pendingGold.isZero?.()) {\r\n    btn.disabled = true;\r\n    btn.innerHTML = '<span class=\"merchant-reset__req-msg\">Collect more coins to earn Gold from a Forge reset</span>';\r\n    return;\r\n  }\r\n\r\n  // When requirements are met: restore the normal + icon amount layout\r\n  btn.disabled = false;\r\n  btn.innerHTML = `<span class=\"merchant-reset__action-plus\">+</span><span class=\"merchant-reset__action-icon\"><img src=\"${GOLD_ICON_SRC}\" alt=\"\"></span><span class=\"merchant-reset__action-amount\" data-reset-pending>${formatBn(getPendingGoldWithMultiplier())}</span>`;\r\n}\r\n\r\nexport function updateResetPanel() {\r\n  if (!resetState.panel) return;\r\n  updatePendingDisplay();\r\n  updateStatusDisplay();\r\n  updateActionState();\r\n}\r\n\r\nexport function onForgeUpgradeUnlocked() {\r\n  initResetSystem();\r\n  setForgeUnlocked(true);\r\n  updateResetPanel();\r\n}\r\n\r\nfunction bindGlobalEvents() {\r\n  if (typeof window === 'undefined') return;\r\n  window.addEventListener('currency:change', (e) => {\r\n    if (e.detail?.key === 'coins') {\r\n      recomputePendingGold();\r\n    }\r\n  });\r\n  window.addEventListener('currency:multiplier', (e) => {\r\n    const detail = e?.detail;\r\n    if (!detail || detail.key !== CURRENCIES.GOLD) return;\r\n    if (detail.slot != null && resetState.slot != null && detail.slot !== resetState.slot) return;\r\n    updateResetPanel();\r\n  });\r\n  window.addEventListener('xp:change', () => {\r\n    recomputePendingGold();\r\n    updateResetPanel();\r\n  });\r\n  window.addEventListener('debug:change', (e) => {\r\n    if (e?.detail?.slot != null && resetState.slot != null && e.detail.slot !== resetState.slot) return;\r\n    resetPendingGoldSignature();\r\n    recomputePendingGold(true);\r\n    updateResetPanel();\r\n  });\r\n}\r\n\r\nexport function initResetSystem() {\r\n  if (initialized) {\r\n    resetState.slot = getActiveSlot();\r\n    resetPendingGoldSignature();\r\n    ensureValueListeners();\r\n    recomputePendingGold(true);\r\n    return;\r\n  }\r\n  initialized = true;\r\n  initMutationSystem();\r\n  const slot = getActiveSlot();\r\n  resetState.slot = slot;\r\n  resetPendingGoldSignature();\r\n  readPersistentFlags(slot);\r\n  if (resetState.hasDoneForgeReset && !isMutationUnlocked()) {\r\n    try { unlockMutationSystem(); } catch {}\r\n  }\r\n  if (!resetState.forgeUnlocked && canAccessForgeTab()) {\r\n    setForgeUnlocked(true);\r\n  }\r\n  bindStorageWatchers(slot);\r\n  ensureValueListeners();\r\n  bindGlobalEvents();\r\n  recomputePendingGold(true);\r\n  if (mutationUnsub) {\r\n    try { mutationUnsub(); } catch {}\r\n    mutationUnsub = null;\r\n  }\r\n  mutationUnsub = onMutationChange(() => {\r\n    const sprite = getMutationCoinSprite();\r\n    if (typeof window !== 'undefined' && window.spawner && typeof window.spawner.setCoinSprite === 'function') {\r\n      try { window.spawner.setCoinSprite(sprite); } catch {}\r\n    }\r\n  });\r\n  if (typeof window !== 'undefined') {\r\n    window.addEventListener('saveSlot:change', () => {\r\n      const nextSlot = getActiveSlot();\r\n      resetState.slot = nextSlot;\r\n      resetPendingGoldSignature();\r\n      readPersistentFlags(nextSlot);\r\n      if (resetState.hasDoneForgeReset && !isMutationUnlocked()) {\r\n        try { unlockMutationSystem(); } catch {}\r\n      }\r\n      if (!resetState.forgeUnlocked && canAccessForgeTab()) {\r\n        setForgeUnlocked(true);\r\n      }\r\n      bindStorageWatchers(nextSlot);\r\n      ensureValueListeners();\r\n      recomputePendingGold(true);\r\n      updateResetPanel();\r\n    });\r\n  }\r\n}\r\n\r\nif (typeof window !== 'undefined') {\r\n  window.resetSystem = window.resetSystem || {};\r\n  Object.assign(window.resetSystem, {\r\n    initResetSystem,\r\n    performForgeReset,\r\n    computePendingForgeGold,\r\n  });\r\n}\r\n", "// js/game/upgrades.js\r\nimport { bank, getActiveSlot, watchStorageKey, primeStorageWatcherSnapshot } from '../util/storage.js';\r\nimport { BigNum } from '../util/bigNum.js';\r\nimport { formatNumber } from '../util/numFormat.js';\r\nimport {\r\n  unlockXpSystem,\r\n  isXpSystemUnlocked,\r\n  getXpState,\r\n  addExternalCoinMultiplierProvider,\r\n  setExternalBookRewardProvider,\r\n  addExternalXpGainMultiplierProvider,\r\n  refreshCoinMultiplierFromXpLevel,\r\n} from './xpSystem.js';\r\nimport { getMutationMultiplier } from './mutationSystem.js';\r\nimport {\r\n  initResetSystem,\r\n  onForgeUpgradeUnlocked,\r\n  isForgeUnlocked,\r\n  hasDoneForgeReset,\r\n} from '../ui/merchantDelve/resetTab.js';\r\n\r\nexport const MAX_LEVEL_DELTA = BigNum.fromAny('Infinity');\r\n\r\nexport const HM_EVOLUTION_INTERVAL = 1000;\r\nconst HM_EVOLUTION_EFFECT_MULT_BN = BigNum.fromInt(1000);\r\nconst DEFAULT_AREA_KEY = '';\r\n\r\nfunction hasScaling(upg) {\r\n  try {\r\n    const scaling = ensureUpgradeScaling(upg);\r\n    if (!scaling) return false;\r\n    if (scaling.ratioMinus1 > 0) return true;\r\n\r\n    const c0 = BigNum.fromAny(upg.costAtLevel?.(0) ?? 0);\r\n    const c1 = BigNum.fromAny(upg.costAtLevel?.(1) ?? 0);\r\n    const cF = BigNum.fromAny(upg.costAtLevel?.(32) ?? 0);\r\n    return !(c0.cmp(c1) === 0 && c0.cmp(cF) === 0);\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\nconst SCALED_INFINITY_LVL_LOG10 = 308;\r\nfunction isInfinityLevelForScaled(upg, lvlBn) {\r\n  if (!hasScaling(upg)) return false;\r\n  try {\r\n    const bn = lvlBn?.clone ? lvlBn : BigNum.fromAny(lvlBn ?? 0);\r\n    if (bn.isInfinite?.()) return true;\r\n    const log10 = approxLog10BigNum(bn);\r\n    return Number.isFinite(log10) && log10 >= SCALED_INFINITY_LVL_LOG10;\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\nexport function approxLog10BigNum(value) {\r\n  if (!(value instanceof BigNum)) {\r\n    try {\r\n      value = BigNum.fromAny(value ?? 0);\r\n    } catch {\r\n      return Number.NEGATIVE_INFINITY;\r\n    }\r\n  }\r\n  if (!value) return Number.NEGATIVE_INFINITY;\r\n  if (value.isZero?.()) return Number.NEGATIVE_INFINITY;\r\n  if (value.isInfinite?.()) return Number.POSITIVE_INFINITY;\r\n  let storage;\r\n  try {\r\n    storage = value.toStorage();\r\n  } catch {\r\n    return Number.NEGATIVE_INFINITY;\r\n  }\r\n  const parts = storage.split(':');\r\n  const sigStr = parts[2] ?? '0';\r\n  let expPart = parts[3] ?? '0';\r\n  let offsetStr = '0';\r\n  const caret = expPart.indexOf('^');\r\n  if (caret >= 0) {\r\n    offsetStr = expPart.slice(caret + 1) || '0';\r\n    expPart = expPart.slice(0, caret) || '0';\r\n  }\r\n  const baseExp = Number(expPart || '0');\r\n  const offset = Number(offsetStr || '0');\r\n  const sigNum = Number(sigStr || '0');\r\n  if (!Number.isFinite(sigNum) || sigNum <= 0) return Number.NEGATIVE_INFINITY;\r\n  const expSum = (Number.isFinite(baseExp) ? baseExp : 0) + (Number.isFinite(offset) ? offset : 0);\r\n  return Math.log10(sigNum) + expSum;\r\n}\r\n\r\nexport function bigNumFromLog10(log10Value) {\r\n  if (!Number.isFinite(log10Value)) {\r\n    return log10Value > 0 ? BigNum.fromAny('Infinity') : BigNum.fromInt(0);\r\n  }\r\n  \r\n  if (log10Value <= -1e12) return BigNum.fromInt(0);\r\n  const p = BigNum.DEFAULT_PRECISION;\r\n  let intPart = Math.floor(log10Value);\r\n  let frac = log10Value - intPart;\r\n  if (frac < 0) {\r\n    frac += 1;\r\n    intPart -= 1;\r\n  }\r\n  const mantissa = Math.pow(10, frac + (p - 1));\r\n  const sig = BigInt(Math.max(1, Math.round(mantissa)));\r\n  const exp = intPart - (p - 1);\r\n  return new BigNum(sig, exp, p);\r\n}\r\n\r\nexport const UPGRADE_TIES = {\r\n  FASTER_COINS: 'coin_1',\r\n  UNLOCK_XP: 'none_1',\r\n  FASTER_COINS_II: 'book_1',\r\n  COIN_VALUE_I: 'book_2',\r\n  BOOK_VALUE_I: 'book_3',\r\n  XP_VALUE_I: 'coin_2',\r\n  UNLOCK_FORGE: 'none_2',\r\n  COIN_VALUE_II: 'gold_1',\r\n  XP_VALUE_II: 'gold_2',\r\n  MP_VALUE_I: 'gold_3',\r\n  MAGNET: 'gold_4',\r\n  ENDLESS_XP: 'coin_3',\r\n};\r\n\r\nconst LOCKED_UPGRADE_ICON_DATA_URL = 'img/misc/locked.png';\r\nconst MYSTERIOUS_UPGRADE_ICON_DATA_URL = 'img/misc/mysterious.png';\r\nconst HIDDEN_UPGRADE_TITLE = 'Hidden Upgrade';\r\nconst LOCKED_UPGRADE_TITLE = 'Locked Upgrade';\r\nconst FORGE_PLACEHOLDER_TIES = new Set([\r\n  UPGRADE_TIES.COIN_VALUE_II,\r\n  UPGRADE_TIES.XP_VALUE_II,\r\n  UPGRADE_TIES.MP_VALUE_I,\r\n  UPGRADE_TIES.MAGNET,\r\n  UPGRADE_TIES.ENDLESS_XP,\r\n]);\r\nconst SPECIAL_LOCK_STATE_TIES = new Set([\r\n  UPGRADE_TIES.UNLOCK_XP,\r\n  UPGRADE_TIES.UNLOCK_FORGE,\r\n  ...FORGE_PLACEHOLDER_TIES,\r\n]);\r\nconst XP_MYSTERY_UPGRADE_TIES = new Set([\r\n  UPGRADE_TIES.FASTER_COINS_II,\r\n  UPGRADE_TIES.COIN_VALUE_I,\r\n  UPGRADE_TIES.BOOK_VALUE_I,\r\n  UPGRADE_TIES.XP_VALUE_I,\r\n]);\r\nconst XP_MYSTERY_LEGACY_KEYS = new Set([\r\n  'starter_cove:3',\r\n  'starter_cove:4',\r\n  'starter_cove:5',\r\n  'starter_cove:6',\r\n]);\r\nconst MERCHANT_MET_KEY_BASE = 'ccc:merchantMet';\r\nconst SHOP_REVEAL_STATE_KEY_BASE = 'ccc:shop:reveals';\r\nconst SHOP_PERMA_UNLOCK_KEY_BASE = 'ccc:shop:permaUnlocks';\r\nconst SHOP_PERMA_MYST_KEY_BASE   = 'ccc:shop:permaMyst';\r\nconst SHOP_REVEAL_STATUS_ORDER = { locked: 0, mysterious: 1, unlocked: 2 };\r\nconst shopRevealStateCache = new Map();\r\nconst shopPermaUnlockStateCache = new Map();\r\nconst shopPermaMystStateCache   = new Map();\r\nconst upgradeTieLookup = new Map();\r\nconst BOOK_VALUE_TIE_KEY = normalizeUpgradeTie(UPGRADE_TIES.BOOK_VALUE_I);\r\n\r\nconst BN = BigNum;\r\nconst toBn = (x) => BN.fromAny(x ?? 0);\r\n\r\nfunction effectBN(fn) {\r\n  return (level) => {\r\n    const L = toBn(level);\r\n    let out;\r\n    try { out = fn({ L, BN }); } catch { out = 1; }\r\n    if (out instanceof BN) return out;\r\n    const n = Number(out);\r\n    if (Number.isFinite(n)) return n;\r\n    try { return BN.fromAny(out ?? 1); } catch { return BN.fromInt(1); }\r\n  };\r\n}\r\n\r\nconst E = {\r\n  addPctPerLevel(p) {\r\n    const pNum = Number(p);\r\n    const pStr = String(pNum);\r\n    return (level) => {\r\n      const L = toBn(level);\r\n      try {\r\n        const plain = L.toPlainIntegerString?.();\r\n        if (plain && plain !== 'Infinity' && plain.length <= 15) {\r\n          const lvl = Math.max(0, Number(plain));\r\n          return 1 + pNum * lvl;\r\n        }\r\n      } catch {}\r\n      try { return BN.fromInt(1).add(L.mulDecimal(pStr)); }\r\ncatch {\r\n  const logL = approxLog10BigNum(L);\r\n  if (Number.isFinite(logL)) {\r\n    const logTerm = logL + Math.log10(Math.abs(pNum || 0));\r\n    return bigNumFromLog10(logTerm);\r\n  }\r\n  return BigNum.fromAny('Infinity');\r\n}\r\n\r\n    };\r\n  },\r\n\r\n  addFlatPerLevel(x) {\r\n    const xNum = Number(x);\r\n    const xStr = String(xNum);\r\n    return (level) => {\r\n      const L = toBn(level);\r\n      try {\r\n        const plain = L.toPlainIntegerString?.();\r\n        if (plain && plain !== 'Infinity' && plain.length <= 15) {\r\n          const lvl = Math.max(0, Number(plain));\r\n          return 1 + xNum * lvl;\r\n        }\r\n      } catch {}\r\n      try { return BN.fromInt(1).add(L.mulDecimal(xStr)); } catch { return 1; }\r\n    };\r\n  },\r\n  \r\n  powPerLevel(base) {\r\n  const baseNum = Number(base);\r\n  const b = Number.isFinite(baseNum) ? baseNum : Number(toBn(base).toScientific(6));\r\n  const log10b = Math.log10(b);\r\n\r\n  return (level) => {\r\n    const L = toBn(level);\r\n\r\n    try {\r\n      const plain = L.toPlainIntegerString?.();\r\n      if (plain && plain !== 'Infinity' && plain.length <= 7) {\r\n        const lvl = Math.max(0, Number(plain));\r\n        const log10 = log10b * lvl;\r\n\r\n        if (log10 < 308) {\r\n          const val = Math.pow(b, lvl);\r\n          if (Number.isFinite(val)) return val;\r\n        }\r\n        return bigNumFromLog10(log10);\r\n      }\r\n    } catch {}\r\n\t\r\n      try {\r\n      const approxLvl = levelBigNumToNumber(L);\r\n      const log10 = log10b * approxLvl;\r\n      return bigNumFromLog10(log10);\r\n      } catch {\r\n      return BigNum.fromInt(1);\r\n      }\r\n    };\r\n  }\r\n};\r\n\r\nfunction shopStatusRank(status) {\r\n  return SHOP_REVEAL_STATUS_ORDER[status] ?? 0;\r\n}\r\n\r\nfunction classifyUpgradeStatus(lockState) {\r\n  if (!lockState || lockState.locked === false) return 'unlocked';\r\n  if (lockState.hidden) return 'mysterious';\r\n  return 'locked';\r\n}\r\n\r\nfunction upgradeRevealKey(areaKey, upg) {\r\n  const normArea = normalizeAreaKey(areaKey || upg?.area);\r\n  if (!normArea) return null;\r\n  const tieKey = normalizeUpgradeTie(upg?.tie ?? upg?.tieKey);\r\n  if (tieKey) {\r\n    return `${normArea}:${tieKey}`;\r\n  }\r\n  const rawId = normalizeUpgradeId(upg?.id);\r\n  let idStr = '';\r\n  if (typeof rawId === 'number') {\r\n    if (!Number.isFinite(rawId)) return null;\r\n    idStr = String(Math.trunc(rawId));\r\n  } else if (typeof rawId === 'string') {\r\n    const trimmed = rawId.trim();\r\n    if (!trimmed) return null;\r\n    idStr = trimmed;\r\n  } else {\r\n    return null;\r\n  }\r\n  return `${normArea}:${idStr}`;\r\n}\r\n\r\nfunction upgradeLegacyRevealKey(areaKey, upg) {\r\n  const normArea = normalizeAreaKey(areaKey || upg?.area);\r\n  if (!normArea) return null;\r\n  const rawId = normalizeUpgradeId(upg?.id);\r\n  if (rawId == null) return null;\r\n  if (typeof rawId === 'number') {\r\n    if (!Number.isFinite(rawId)) return null;\r\n    return `${normArea}:${Math.trunc(rawId)}`;\r\n  }\r\n  const trimmed = String(rawId).trim();\r\n  return trimmed ? `${normArea}:${trimmed}` : null;\r\n}\r\n\r\nfunction migrateUpgradeStateKey(state, fromKey, toKey) {\r\n  if (!state || !state.upgrades || typeof state.upgrades !== 'object') return false;\r\n  if (!fromKey || !toKey || fromKey === toKey) return false;\r\n  if (state.upgrades[toKey]) return false;\r\n  if (!state.upgrades[fromKey]) return false;\r\n  state.upgrades[toKey] = state.upgrades[fromKey];\r\n  delete state.upgrades[fromKey];\r\n  return true;\r\n}\r\n\r\nfunction ensureShopRevealState(slot = getActiveSlot()) {\r\n  const slotKey = String(slot ?? 'default');\r\n  if (shopRevealStateCache.has(slotKey)) {\r\n    return shopRevealStateCache.get(slotKey);\r\n  }\r\n\r\n  let parsed = { upgrades: {} };\r\n  if (typeof localStorage !== 'undefined') {\r\n    try {\r\n      const raw = localStorage.getItem(`${SHOP_REVEAL_STATE_KEY_BASE}:${slotKey}`);\r\n      if (raw) {\r\n        const obj = JSON.parse(raw);\r\n        if (obj && typeof obj === 'object') {\r\n          const upgrades = (obj.upgrades && typeof obj.upgrades === 'object') ? obj.upgrades : {};\r\n          parsed = { upgrades };\r\n        }\r\n      }\r\n    } catch {}\r\n  }\r\n\r\n  if (!parsed || typeof parsed !== 'object') parsed = { upgrades: {} };\r\n  if (!parsed.upgrades || typeof parsed.upgrades !== 'object') parsed.upgrades = {};\r\n\r\n  shopRevealStateCache.set(slotKey, parsed);\r\n  return parsed;\r\n}\r\n\r\nfunction saveShopRevealState(state, slot = getActiveSlot()) {\r\n  const slotKey = String(slot ?? 'default');\r\n  if (!state || typeof state !== 'object') {\r\n    state = { upgrades: {} };\r\n  }\r\n  if (!state.upgrades || typeof state.upgrades !== 'object') {\r\n    state.upgrades = {};\r\n  }\r\n  shopRevealStateCache.set(slotKey, state);\r\n  if (typeof localStorage === 'undefined') return;\r\n  try {\r\n    localStorage.setItem(`${SHOP_REVEAL_STATE_KEY_BASE}:${slotKey}`, JSON.stringify(state));\r\n  } catch {}\r\n}\r\n\r\nfunction ensureShopPermaUnlockState(slot = getActiveSlot()) {\r\n  const slotKey = String(slot ?? 'default');\r\n  if (shopPermaUnlockStateCache.has(slotKey)) {\r\n    return shopPermaUnlockStateCache.get(slotKey);\r\n  }\r\n\r\n  let parsed = { upgrades: {} };\r\n  if (typeof localStorage !== 'undefined') {\r\n    try {\r\n      const raw = localStorage.getItem(`${SHOP_PERMA_UNLOCK_KEY_BASE}:${slotKey}`);\r\n      if (raw) {\r\n        const obj = JSON.parse(raw);\r\n        if (obj && typeof obj === 'object') {\r\n          const upgrades = (obj.upgrades && typeof obj.upgrades === 'object') ? obj.upgrades : {};\r\n          parsed = { upgrades };\r\n        }\r\n      }\r\n    } catch {}\r\n  }\r\n\r\n  if (!parsed || typeof parsed !== 'object') parsed = { upgrades: {} };\r\n  if (!parsed.upgrades || typeof parsed.upgrades !== 'object') parsed.upgrades = {};\r\n\r\n  shopPermaUnlockStateCache.set(slotKey, parsed);\r\n  return parsed;\r\n}\r\n\r\nfunction saveShopPermaUnlockState(state, slot = getActiveSlot()) {\r\n  const slotKey = String(slot ?? 'default');\r\n  if (!state || typeof state !== 'object') {\r\n    state = { upgrades: {} };\r\n  }\r\n  if (!state.upgrades || typeof state.upgrades !== 'object') {\r\n    state.upgrades = {};\r\n  }\r\n  shopPermaUnlockStateCache.set(slotKey, state);\r\n  if (typeof localStorage === 'undefined') return;\r\n  try {\r\n    localStorage.setItem(`${SHOP_PERMA_UNLOCK_KEY_BASE}:${slotKey}`, JSON.stringify(state));\r\n  } catch {}\r\n}\r\n\r\nfunction ensureShopPermaMystState(slot = getActiveSlot()) {\r\n  const slotKey = String(slot ?? 'default');\r\n  if (shopPermaMystStateCache.has(slotKey)) {\r\n    return shopPermaMystStateCache.get(slotKey);\r\n  }\r\n  let parsed = { upgrades: {} };\r\n  if (typeof localStorage !== 'undefined') {\r\n    try {\r\n      const raw = localStorage.getItem(`${SHOP_PERMA_MYST_KEY_BASE}:${slotKey}`);\r\n      if (raw) {\r\n        const obj = JSON.parse(raw);\r\n        if (obj && typeof obj === 'object') {\r\n          const upgrades = (obj.upgrades && typeof obj.upgrades === 'object') ? obj.upgrades : {};\r\n          parsed = { upgrades };\r\n        }\r\n      }\r\n    } catch {}\r\n  }\r\n  if (!parsed || typeof parsed !== 'object') parsed = { upgrades: {} };\r\n  if (!parsed.upgrades || typeof parsed.upgrades !== 'object') parsed.upgrades = {};\r\n  shopPermaMystStateCache.set(slotKey, parsed);\r\n  return parsed;\r\n}\r\n\r\nfunction saveShopPermaMystState(state, slot = getActiveSlot()) {\r\n  const slotKey = String(slot ?? 'default');\r\n  if (!state || typeof state !== 'object') state = { upgrades: {} };\r\n  if (!state.upgrades || typeof state.upgrades !== 'object') state.upgrades = {};\r\n  shopPermaMystStateCache.set(slotKey, state);\r\n  if (typeof localStorage === 'undefined') return;\r\n  try {\r\n    localStorage.setItem(`${SHOP_PERMA_MYST_KEY_BASE}:${slotKey}`, JSON.stringify(state));\r\n  } catch {}\r\n}\r\n\r\nfunction markUpgradePermanentlyMysterious(areaKey, upg, slot = getActiveSlot()) {\r\n  const key = upgradeRevealKey(areaKey, upg);\r\n  if (!key) return;\r\n  const legacyKey = upgradeLegacyRevealKey(areaKey, upg);\r\n  const state = ensureShopPermaMystState(slot);\r\n  if (state.upgrades[key]) return;\r\n  state.upgrades[key] = true;\r\n  if (legacyKey && state.upgrades[legacyKey]) {\r\n    delete state.upgrades[legacyKey];\r\n  }\r\n  saveShopPermaMystState(state, slot);\r\n}\r\n\r\nfunction isUpgradePermanentlyMysterious(areaKey, upg, slot = getActiveSlot()) {\r\n  const key = upgradeRevealKey(areaKey, upg);\r\n  if (!key) return false;\r\n  const legacyKey = upgradeLegacyRevealKey(areaKey, upg);\r\n  const state = ensureShopPermaMystState(slot);\r\n  if (state.upgrades[key]) return true;\r\n  if (legacyKey && state.upgrades[legacyKey]) {\r\n    state.upgrades[key] = state.upgrades[legacyKey];\r\n    delete state.upgrades[legacyKey];\r\n    saveShopPermaMystState(state, slot);\r\n    return true;\r\n  }\r\n  return false;\r\n}\r\n\r\nexport function markUpgradePermanentlyUnlocked(areaKey, upg, slot = getActiveSlot()) {\r\n  const key = upgradeRevealKey(areaKey, upg);\r\n  if (!key) return;\r\n  const legacyKey = upgradeLegacyRevealKey(areaKey, upg);\r\n  const state = ensureShopPermaUnlockState(slot);\r\n  if (state.upgrades[key]) return;\r\n  state.upgrades[key] = true;\r\n  if (legacyKey && state.upgrades[legacyKey]) {\r\n    delete state.upgrades[legacyKey];\r\n  }\r\n  saveShopPermaUnlockState(state, slot);\r\n}\r\n\r\nexport function clearPermanentUpgradeUnlock(areaKey, upg, slot = getActiveSlot()) {\r\n  const key = upgradeRevealKey(areaKey, upg);\r\n  if (!key) return;\r\n\r\n  const permaState = ensureShopPermaUnlockState(slot);\r\n  if (permaState.upgrades[key]) {\r\n    delete permaState.upgrades[key];\r\n    saveShopPermaUnlockState(permaState, slot);\r\n  }\r\n\r\n  const revealState = ensureShopRevealState(slot);\r\n  if (!revealState.upgrades[key] || revealState.upgrades[key].status !== 'locked') {\r\n    revealState.upgrades[key] = { status: 'locked' };\r\n    saveShopRevealState(revealState, slot);\r\n  }\r\n\r\n  const upgId = typeof upg?.id !== 'undefined' ? upg.id : upg;\r\n  if (upgId != null) {\r\n    invalidateUpgradeState(areaKey, upgId, slot);\r\n  }\r\n  notifyChanged();\r\n}\r\n\r\nfunction isUpgradePermanentlyUnlocked(areaKey, upg, slot = getActiveSlot()) {\r\n  const key = upgradeRevealKey(areaKey, upg);\r\n  if (!key) return false;\r\n  const legacyKey = upgradeLegacyRevealKey(areaKey, upg);\r\n  const state = ensureShopPermaUnlockState(slot);\r\n  if (state.upgrades[key]) return true;\r\n  if (legacyKey && state.upgrades[legacyKey]) {\r\n    state.upgrades[key] = state.upgrades[legacyKey];\r\n    delete state.upgrades[legacyKey];\r\n    saveShopPermaUnlockState(state, slot);\r\n    return true;\r\n  }\r\n  return false;\r\n}\r\n\r\nfunction determineLockState(ctx) {\r\n  // Be robust if called unbound or without ctx.upg\r\n  const upgRef = (ctx && ctx.upg) ? ctx.upg : (this && typeof this === 'object' ? this : null);\r\n  const tieKey = normalizeUpgradeTie(upgRef?.tie ?? upgRef?.tieKey);\r\n  const area = ctx?.areaKey || AREA_KEYS.STARTER_COVE;\r\n\r\n  if (!tieKey || !SPECIAL_LOCK_STATE_TIES.has(tieKey)) {\r\n    return { locked: true, iconOverride: LOCKED_UPGRADE_ICON_DATA_URL, useLockedBase: true };\r\n  }\r\n\r\n  // If any level has already been bought, it\u2019s unlocked.\r\n  let currentLevel = 0;\r\n  try {\r\n    currentLevel = (upgRef && typeof upgRef.id !== 'undefined') ? getLevelNumber(area, upgRef.id) : 0;\r\n  } catch {}\r\n  if (currentLevel >= 1) {\r\n    return { locked: false, hidden: false, useLockedBase: false };\r\n  }\r\n\r\n  // XPs unlocked?\r\n  let xpUnlocked = false;\r\n  try {\r\n    xpUnlocked = (ctx && typeof ctx.xpUnlocked !== 'undefined')\r\n      ? !!ctx.xpUnlocked\r\n      : safeIsXpUnlocked();\r\n  } catch {}\r\n\r\n  function determineUnlockXpLockState() {\r\n    if (safeHasMetMerchant()) {\r\n      // Merchant met -> upgrade is fully visible and purchasable\r\n      return {\r\n        locked: false,\r\n        hidden: false,\r\n        hideCost: false,\r\n        hideEffect: false,\r\n        useLockedBase: false,\r\n      };\r\n    }\r\n\r\n    // Merchant not met -> mysterious placeholder\r\n    const revealText = 'Explore the Delve menu to reveal this upgrade';\r\n    return {\r\n      locked: true,\r\n      iconOverride: MYSTERIOUS_UPGRADE_ICON_DATA_URL,\r\n      titleOverride: HIDDEN_UPGRADE_TITLE,\r\n      descOverride: revealText,\r\n      reason: revealText,\r\n      hidden: true,\r\n      hideCost: true,\r\n      hideEffect: true,\r\n      useLockedBase: true,\r\n    };\r\n  }\r\n\r\n  // ==== Unlock XP ====\r\n  if (tieKey === UPGRADE_TIES.UNLOCK_XP) {\r\n    return determineUnlockXpLockState();\r\n  }\r\n\r\n  // ==== Unlock Forge ====\r\n  if (tieKey === UPGRADE_TIES.UNLOCK_FORGE) {\r\n    // No XP system -> LOCKED padlock\r\n    if (!xpUnlocked) {\r\n      return { locked: true, iconOverride: LOCKED_UPGRADE_ICON_DATA_URL, useLockedBase: true };\r\n    }\r\n    // Before 31 -> show same requirement text as mysterious, but without generic \"hidden\" line\r\n    let xp31 = false;\r\n    try { const xpBn = currentXpLevelBigNum(); xp31 = levelBigNumToNumber(xpBn) >= 31; } catch {}\r\n    if (!xp31) {\r\n      const revealText = (upgRef?.revealRequirement) || 'Reach XP Level 31 to reveal this upgrade';\r\n      return {\r\n        locked: true,\r\n        iconOverride: MYSTERIOUS_UPGRADE_ICON_DATA_URL,\r\n        hidden: true,\r\n        hideCost: true, hideEffect: true, useLockedBase: true,\r\n        titleOverride: HIDDEN_UPGRADE_TITLE,\r\n        descOverride: revealText,\r\n        reason: revealText,\r\n      };\r\n    }\r\n    // XP \u2265 31 -> visible/unlocked\r\n    return { locked: false };\r\n  }\r\n\r\n  if (hasDoneForgeReset() || isUpgradePermanentlyUnlocked(area, upgRef)) {\r\n    try { markUpgradePermanentlyUnlocked(area, upgRef); } catch {}\r\n    return { locked: false, hidden: false, useLockedBase: false };\r\n  }\r\n\r\n  // No XP system -> LOCKED padlock\r\n  if (!xpUnlocked) {\r\n    return { locked: true, iconOverride: LOCKED_UPGRADE_ICON_DATA_URL, useLockedBase: true };\r\n  }\r\n\r\n  if (isUpgradePermanentlyMysterious(area, upgRef)) {\r\n    const revealText = 'Do a Forge reset to reveal this upgrade';\r\n    return {\r\n      locked: true,\r\n      iconOverride: MYSTERIOUS_UPGRADE_ICON_DATA_URL,\r\n      hidden: true, hideCost: true, hideEffect: true, useLockedBase: true,\r\n      titleOverride: HIDDEN_UPGRADE_TITLE,\r\n      descOverride: revealText,\r\n      reason: revealText,\r\n    };\r\n  }\r\n\r\n  // Compute XP \u2265 31 once (for the *first-time* reveal/burn)\r\n  let xp31 = false;\r\n  try { const xpBn = currentXpLevelBigNum(); xp31 = levelBigNumToNumber(xpBn) >= 31; } catch {}\r\n\r\n// Before 31 -> hard LOCKED (not mysterious, not clickable)\r\nif (!xp31) {\r\n  const revealText = 'Do a Forge reset to reveal this upgrade';\r\n  return {\r\n    locked: true,\r\n    iconOverride: LOCKED_UPGRADE_ICON_DATA_URL,\r\n    useLockedBase: true,\r\n    titleOverride: LOCKED_UPGRADE_TITLE,\r\n    descOverride: revealText,\r\n    reason: revealText,\r\n    hidden: false,\r\n    hideCost: false,\r\n    hideEffect: false,\r\n  };\r\n}\r\n\r\n  // First time hitting 31 -> burn perma-mysterious and show MYSTERIOUS\r\n  try { markUpgradePermanentlyMysterious(area, upgRef); } catch {}\r\n  return {\r\n    locked: true,\r\n    iconOverride: MYSTERIOUS_UPGRADE_ICON_DATA_URL,\r\n    hidden: true, hideCost: true, hideEffect: true, useLockedBase: true,\r\n  };\r\n}\r\n\r\nfunction snapshotUpgradeLockState(lockState) {\r\n  if (!lockState || typeof lockState !== 'object') return null;\r\n  const snapshot = {};\r\n  const keys = [\r\n    'iconOverride',\r\n    'titleOverride',\r\n    'descOverride',\r\n    'reason',\r\n    'hideCost',\r\n    'hideEffect',\r\n    'hidden',\r\n    'useLockedBase',\r\n  ];\r\n  for (const key of keys) {\r\n    if (lockState[key] !== undefined) snapshot[key] = lockState[key];\r\n  }\r\n  return snapshot;\r\n}\r\n\r\nfunction normalizeAreaKey(areaKey) {\r\n  if (typeof areaKey === 'string') {\r\n    const trimmed = areaKey.trim();\r\n    if (trimmed) {\r\n      return trimmed.toLowerCase().replace(/[^a-z0-9]+/g, '_');\r\n    }\r\n  }\r\n  return '';\r\n}\r\n\r\nfunction normalizeUpgradeTie(tieValue) {\r\n  if (typeof tieValue === 'string') {\r\n    const trimmed = tieValue.trim();\r\n    if (trimmed) {\r\n      return trimmed.toLowerCase().replace(/[^a-z0-9]+/g, '_');\r\n    }\r\n  }\r\n  return '';\r\n}\r\n\r\n\r\nfunction isXpAdjacentUpgrade(areaKey, upg) {\r\n  const tieKey = normalizeUpgradeTie(upg?.tie ?? upg?.tieKey);\r\n  if (tieKey && XP_MYSTERY_UPGRADE_TIES.has(tieKey)) {\r\n    return true;\r\n  }\r\n  const normalizedId = normalizeUpgradeId(upg?.id);\r\n  const numericId = typeof normalizedId === 'number'\r\n    ? normalizedId\r\n    : Number.parseInt(normalizedId, 10);\r\n  const idKey = Number.isFinite(numericId)\r\n    ? String(numericId)\r\n    : (normalizedId != null ? String(normalizedId) : '');\r\n  if (!idKey) return false;\r\n\r\n  const areaCandidates = [];\r\n  if (areaKey != null) areaCandidates.push(areaKey);\r\n  if (upg?.area != null) areaCandidates.push(upg.area);\r\n\r\n  for (const candidate of areaCandidates) {\r\n    const normArea = normalizeAreaKey(candidate);\r\n    if (!normArea) continue;\r\n    if (XP_MYSTERY_LEGACY_KEYS.has(`${normArea}:${idKey}`)) {\r\n      return true;\r\n    }\r\n  }\r\n\r\n  return false;\r\n}\r\n\r\nfunction safeIsXpUnlocked() {\r\n  try {\r\n    return !!isXpSystemUnlocked();\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\nfunction safeHasMetMerchant(slot = getActiveSlot()) {\r\n  const slotKey = String(slot ?? 'default');\r\n  if (typeof localStorage === 'undefined') return false;\r\n  try {\r\n    return localStorage.getItem(`${MERCHANT_MET_KEY_BASE}:${slotKey}`) === '1';\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\nfunction currentXpLevelBigNum() {\r\n  try {\r\n    const state = typeof getXpState === 'function' ? getXpState() : null;\r\n    if (state?.xpLevel instanceof BigNum) {\r\n      return state.xpLevel.clone?.() ?? state.xpLevel;\r\n    }\r\n    if (state?.xpLevel != null) {\r\n      return BigNum.fromAny(state.xpLevel);\r\n    }\r\n  } catch {}\r\n  return BigNum.fromInt(0);\r\n}\r\n\r\nfunction bookValueMultiplierBn(level) {\r\n  const L = ensureLevelBigNum(level);\r\n  try {\r\n    const plain = L.toPlainIntegerString?.();\r\n    if (plain && plain !== 'Infinity' && plain.length <= 15) {\r\n      const lvl = Math.max(0, Number(plain));\r\n      return bigNumFromLog10(lvl * Math.log10(2)).floorToInteger();\r\n    }\r\n  } catch {}\r\n\r\n  return BigNum.fromAny('Infinity');\r\n}\r\n\r\nfunction normalizedUpgradeLevel(levelValue) {\r\n  if (typeof levelValue === 'number' && Number.isFinite(levelValue)) {\r\n    return Math.max(0, Math.floor(levelValue));\r\n  }\r\n  if (typeof levelValue === 'bigint') {\r\n    if (levelValue < 0n) return 0;\r\n    const maxSafe = BigInt(Number.MAX_SAFE_INTEGER);\r\n    const clamped = levelValue > maxSafe ? maxSafe : levelValue;\r\n    return Number(clamped);\r\n  }\r\n  if (levelValue instanceof BigNum) {\r\n    try {\r\n      const plain = levelValue.toPlainIntegerString?.();\r\n      if (plain && plain !== 'Infinity') {\r\n        const parsed = Number.parseInt(plain, 10);\r\n        if (Number.isFinite(parsed)) {\r\n          return Math.max(0, parsed);\r\n        }\r\n      }\r\n    } catch {}\r\n  }\r\n  return 0;\r\n}\r\n\r\nfunction hundredPercentPerLevelMultiplier(levelValue) {\r\n  const lvl = normalizedUpgradeLevel(levelValue);\r\n  if (lvl <= 0) {\r\n    return BigNum.fromInt(1);\r\n  }\r\n  try {\r\n    const asBigInt = BigInt(lvl) + 1n;\r\n    return BigNum.fromAny(asBigInt.toString());\r\n  } catch {\r\n    try {\r\n      return BigNum.fromAny(String(lvl + 1));\r\n    } catch {\r\n      return BigNum.fromInt(1);\r\n    }\r\n  }\r\n}\r\n\r\nfunction mergeLockStates(base, override) {\r\n  const merged = Object.assign({ locked: false }, base || {});\r\n  if (!override || typeof override !== 'object') return merged;\r\n  const keys = [\r\n    'locked',\r\n    'iconOverride',\r\n    'titleOverride',\r\n    'descOverride',\r\n    'reason',\r\n    'hideCost',\r\n    'hideEffect',\r\n    'hidden',\r\n    'useLockedBase',\r\n  ];\r\n  for (const key of keys) {\r\n    if (override[key] !== undefined) merged[key] = override[key];\r\n  }\r\n  return merged;\r\n}\r\n\r\nfunction normalizeUpgradeId(upgId) {\r\n  if (typeof upgId === 'number') {\r\n    if (!Number.isFinite(upgId)) return upgId;\r\n    return Math.trunc(upgId);\r\n  }\r\n  if (typeof upgId === 'string') {\r\n    const trimmed = upgId.trim();\r\n    if (!trimmed) return trimmed;\r\n    if (/^[+-]?\\d+$/.test(trimmed)) {\r\n      const parsed = Number.parseInt(trimmed, 10);\r\n      if (Number.isFinite(parsed)) return parsed;\r\n    }\r\n    return trimmed;\r\n  }\r\n  return upgId;\r\n}\r\n\r\nfunction ensureLevelBigNum(value) {\r\n  try {\r\n    const bn = value instanceof BigNum ? value : BigNum.fromAny(value ?? 0);\r\n    if (bn.isInfinite?.()) return bn.clone?.() ?? bn;\r\n    const plain = bn.toPlainIntegerString?.();\r\n    if (plain === 'Infinity') return BigNum.fromAny('Infinity');\r\n    if (!plain) return BigNum.fromInt(0);\r\n    const normalized = plain.replace(/^0+(?=\\d)/, '');\r\n    if (!normalized) return BigNum.fromInt(0);\r\n    return BigNum.fromAny(normalized);\r\n  } catch {\r\n    const num = Math.max(0, Math.floor(Number(value) || 0));\r\n    return BigNum.fromInt(num);\r\n  }\r\n}\r\n\r\nfunction levelBigNumToNumber(value) {\r\n  let bn;\r\n  try {\r\n    bn = value instanceof BigNum ? value : BigNum.fromAny(value ?? 0);\r\n  } catch {\r\n    return 0;\r\n  }\r\n\r\n  if (bn.isInfinite?.()) {\r\n    return Number.POSITIVE_INFINITY;\r\n  }\r\n\r\n  try {\r\n    const plain = bn.toPlainIntegerString?.();\r\n    if (!plain || plain === 'Infinity') {\r\n      return plain === 'Infinity' ? Number.MAX_VALUE : 0;\r\n    }\r\n\r\n    const digits = plain.replace(/^0+/, '');\r\n    if (!digits) return 0;\r\n\r\n    if (digits.length <= 15) {\r\n      const num = Number(digits);\r\n      return Number.isFinite(num) ? num : 0;\r\n    }\r\n\r\n    const lead = digits.slice(0, 15);\r\n    const leadNum = Number(lead);\r\n    const leadLen = lead.length;\r\n    if (!Number.isFinite(leadNum) || leadNum <= 0) return 0;\r\n\r\n    let mantissa = leadNum / Math.pow(10, leadLen - 1);\r\n    let exponent = digits.length - 1;\r\n\r\n    if (mantissa <= 0 || !Number.isFinite(mantissa)) return 0;\r\n\r\n    if (mantissa >= 10) {\r\n      const shift = Math.floor(Math.log10(mantissa));\r\n      if (Number.isFinite(shift) && shift > 0) {\r\n        mantissa /= Math.pow(10, shift);\r\n        exponent += shift;\r\n      }\r\n    } else if (mantissa < 1) {\r\n      const shift = Math.ceil(Math.log10(1 / mantissa));\r\n      if (Number.isFinite(shift) && shift > 0) {\r\n        mantissa *= Math.pow(10, shift);\r\n        exponent -= shift;\r\n      }\r\n    }\r\n\r\n    if (exponent > 308) {\r\n      return Number.MAX_VALUE;\r\n    }\r\n    if (exponent < -324) {\r\n      return 0;\r\n    }\r\n\r\n    const approx = mantissa * Math.pow(10, exponent);\r\n    if (!Number.isFinite(approx)) {\r\n      return exponent > 0 ? Number.MAX_VALUE : 0;\r\n    }\r\n    return approx;\r\n  } catch {\r\n    const approx = approxLog10BigNum(bn);\r\n    if (!Number.isFinite(approx)) return Number.MAX_VALUE;\r\n    if (approx > 308) return Number.MAX_VALUE;\r\n    if (approx < -324) return 0;\r\n    const value = Math.pow(10, approx);\r\n    return Number.isFinite(value) ? value : Number.MAX_VALUE;\r\n  }\r\n}\r\n\r\nconst LN10 = Math.log(10);\r\n\r\nfunction plainLevelDelta(nextLevelBn, prevLevelBn) {\r\n  const next = ensureLevelBigNum(nextLevelBn);\r\n  const prev = ensureLevelBigNum(prevLevelBn);\r\n\r\n  if (next.isInfinite?.()) {\r\n    return prev.isInfinite?.() ? BigNum.fromInt(0) : BigNum.fromAny('Infinity');\r\n  }\r\n  if (prev.isInfinite?.()) {\r\n    return BigNum.fromInt(0);\r\n  }\r\n\r\n  try {\r\n    const nextPlain = next.toPlainIntegerString?.();\r\n    const prevPlain = prev.toPlainIntegerString?.();\r\n    if (!nextPlain || !prevPlain) return BigNum.fromInt(0);\r\n    if (nextPlain === 'Infinity') return BigNum.fromAny('Infinity');\r\n    if (prevPlain === 'Infinity') return BigNum.fromInt(0);\r\n    if (nextPlain === prevPlain) return BigNum.fromInt(0);\r\n    const diff = BigInt(nextPlain) - BigInt(prevPlain);\r\n    if (diff <= 0n) return BigNum.fromInt(0);\r\n    return BigNum.fromAny(diff.toString());\r\n  } catch {\r\n    return BigNum.fromInt(0);\r\n  }\r\n}\r\n\r\nfunction decimalMultiplierString(value) {\r\n  if (!Number.isFinite(value) || value <= 0) return '1';\r\n  let out = value.toFixed(12);\r\n  out = out.replace(/0+$/, '');\r\n  if (out.endsWith('.')) out += '0';\r\n  return out;\r\n}\r\n\r\nexport function computeDefaultUpgradeCost(baseCost, level, upgType = 'NM') {\r\n  let baseBn;\r\n  try { baseBn = BigNum.fromAny(baseCost ?? 0); }\r\n  catch { baseBn = BigNum.fromInt(0); }\r\n\r\n  let levelNumber = 0;\r\n  try {\r\n    if (level instanceof BigNum) {\r\n      const plain = level.toPlainIntegerString?.();\r\n      if (plain && plain !== 'Infinity') {\r\n        levelNumber = Number.parseInt(plain, 10);\r\n      }\r\n    } else {\r\n      levelNumber = Number(level) || 0;\r\n    }\r\n  } catch {\r\n    levelNumber = 0;\r\n  }\r\n\r\n  const upg = { upgType, numUpgEvolutions: 0 };\r\n  if (`${upgType ?? ''}`.toUpperCase() === 'HM') {\r\n    const evolutions = Math.max(0, Math.floor(levelNumber / HM_EVOLUTION_INTERVAL));\r\n    if (Number.isFinite(evolutions)) {\r\n      upg.numUpgEvolutions = evolutions;\r\n    }\r\n  }\r\n\r\n  const preset = resolveDefaultScalingRatio(upg);\r\n  const ratio = Number.isFinite(preset?.ratio) ? preset.ratio : 1;\r\n  const scaling = {\r\n    baseBn,\r\n    baseLog10: approxLog10BigNum(baseBn),\r\n    ratio,\r\n    ratioMinus1: Math.max(0, ratio - 1),\r\n    ratioLog10: Math.log10(Math.max(ratio, 1)),\r\n    ratioLn: Math.log(Math.max(ratio, 1)),\r\n    ratioStr: decimalMultiplierString(Math.max(ratio, 1)),\r\n    defaultPreset: preset?.preset,\r\n  };\r\n\r\n  upg.scaling = scaling;\r\n\r\n  return costAtLevelUsingScaling(upg, levelNumber);\r\n}\r\n\r\nconst DEFAULT_SCALING_PRESETS = {\r\n  STANDARD(upg) {\r\n    const upgType = `${upg?.upgType ?? ''}`.toUpperCase();\r\n    if (upgType === 'HM') {\r\n      const evol = activeEvolutionsForUpgrade(upg);\r\n      return 1.50 + (0.10 * evol);\r\n    }\r\n    return 1.20;\r\n  },\r\n  HM(upg) {\r\n    return DEFAULT_SCALING_PRESETS.STANDARD(upg);\r\n  },\r\n  NM() {\r\n    return 1.20;\r\n  },\r\n};\r\n\r\nfunction normalizeHmEvolutionCount(value) {\r\n  const n = Number(value);\r\n  if (Number.isFinite(n) && n > 0) return Math.max(0, Math.floor(n));\r\n  return 0;\r\n}\r\n\r\nfunction activeEvolutionsForUpgrade(upg) {\r\n  if (!upg) return 0;\r\n  const active = Number(upg.activeEvolutions);\r\n  if (Number.isFinite(active) && active >= 0) return active;\r\n  return normalizeHmEvolutionCount(upg.numUpgEvolutions);\r\n}\r\n\r\nfunction hmLevelCapForEvolutions(evolutions) {\r\n  const cycles = normalizeHmEvolutionCount(evolutions);\r\n  const cap = HM_EVOLUTION_INTERVAL * (cycles + 1);\r\n  const capBn = BigNum.fromAny(cap);\r\n  return {\r\n    cap,\r\n    capBn,\r\n    capFmtHtml: formatBigNumAsHtml(capBn),\r\n    capFmtText: formatBigNumAsPlain(capBn),\r\n  };\r\n}\r\n\r\nfunction hmMilestoneHits(levelBn, milestoneLevel) {\r\n  if (!levelBn || typeof milestoneLevel !== 'number') return 0;\r\n  try {\r\n    const plain = levelBn.toPlainIntegerString?.();\r\n    if (!plain || plain === 'Infinity') return 0;\r\n    const lvl = BigInt(plain);\r\n    const base = BigInt(Math.max(0, Math.floor(milestoneLevel)));\r\n    const interval = BigInt(HM_EVOLUTION_INTERVAL);\r\n    if (lvl < base) return 0;\r\n    const delta = lvl - base;\r\n    const cycles = delta / interval;\r\n    return Number(cycles + 1n);\r\n  } catch {\r\n    const approx = levelBigNumToNumber(levelBn);\r\n    if (!Number.isFinite(approx) || approx < milestoneLevel) return 0;\r\n    const delta = approx - milestoneLevel;\r\n    return Math.max(0, Math.floor(delta / HM_EVOLUTION_INTERVAL) + 1);\r\n  }\r\n}\r\n\r\nfunction hmMilestoneMultiplier(multiplier, hits) {\r\n  if (!(hits > 0)) return BigNum.fromInt(1);\r\n  let out;\r\n  try { out = BigNum.fromAny(multiplier ?? 1); }\r\n  catch { out = BigNum.fromInt(1); }\r\n  let result = out.clone?.() ?? out;\r\n  for (let i = 1; i < hits; i += 1) {\r\n    try { result = result.mulBigNumInteger(out); }\r\n    catch {\r\n      try { result = result.mulDecimal(String(out), 18); }\r\n      catch { return BigNum.fromAny('Infinity'); }\r\n    }\r\n  }\r\n  return result;\r\n}\r\n\r\nfunction resolveHmMilestones(upg, areaKey = DEFAULT_AREA_KEY) {\r\n  const milestones = upg?.hmMilestones;\r\n  if (Array.isArray(milestones)) return milestones;\r\n  if (!milestones || typeof milestones !== 'object') return [];\r\n\r\n  const normalizedArea = normalizeAreaKey(areaKey || upg?.area || DEFAULT_AREA_KEY);\r\n\r\n  if (normalizedArea) {\r\n    if (Array.isArray(milestones[normalizedArea])) return milestones[normalizedArea];\r\n    if (Array.isArray(milestones[areaKey])) return milestones[areaKey];\r\n  }\r\n\r\n  if (Array.isArray(milestones.default)) return milestones.default;\r\n  return [];\r\n}\r\n\r\nfunction safeMultiplyBigNum(base, factor) {\r\n  let out = base instanceof BigNum ? base : BigNum.fromAny(base ?? 1);\r\n  let f = factor instanceof BigNum ? factor : null;\r\n  if (!f) {\r\n    try { f = BigNum.fromAny(factor ?? 1); }\r\n    catch { return out; }\r\n  }\r\n  try { return out.mulBigNumInteger(f); }\r\n  catch {}\r\n  try { return out.mulDecimal(f.toScientific?.(12) ?? String(factor ?? '1'), 18); }\r\n  catch {}\r\n  return out;\r\n}\r\n\r\nfunction applyHmEvolutionMeta(upg, evolutions = 0) {\r\n  if (!upg || upg.upgType !== 'HM') return;\r\n  delete upg.scaling;\r\n  const { cap, capBn, capFmtHtml, capFmtText } = hmLevelCapForEvolutions(evolutions);\r\n  upg.activeEvolutions = evolutions;\r\n  upg.lvlCap = cap;\r\n  upg.lvlCapBn = capBn;\r\n  upg.lvlCapFmtHtml = capFmtHtml;\r\n  upg.lvlCapFmtText = capFmtText;\r\n}\r\n\r\nfunction computeHmMultipliers(upg, levelBn, areaKey = DEFAULT_AREA_KEY) {\r\n  if (!upg || upg.upgType !== 'HM') {\r\n    return {\r\n      selfMult: BigNum.fromInt(1),\r\n      xpMult: BigNum.fromInt(1),\r\n      coinMult: BigNum.fromInt(1),\r\n      mpMult: BigNum.fromInt(1),\r\n    };\r\n  }\r\n\r\n  const milestones = resolveHmMilestones(upg, areaKey);\r\n  let selfMult = BigNum.fromInt(1);\r\n  let xpMult = BigNum.fromInt(1);\r\n  let coinMult = BigNum.fromInt(1);\r\n  let mpMult = BigNum.fromInt(1);\r\n\r\n  for (const m of milestones) {\r\n    const hits = hmMilestoneHits(levelBn, Number(m?.level ?? m?.lvl ?? 0));\r\n    if (!(hits > 0)) continue;\r\n    const mult = hmMilestoneMultiplier(m.multiplier ?? m.mult ?? m.value ?? 1, hits);\r\n    const target = `${m.target ?? m.type ?? 'self'}`.toLowerCase();\r\n    if (target === 'xp') {\r\n      xpMult = safeMultiplyBigNum(xpMult, mult);\r\n    } else if (target === 'coin' || target === 'coins') {\r\n      coinMult = safeMultiplyBigNum(coinMult, mult);\r\n    } else if (target === 'mp') {\r\n      mpMult = safeMultiplyBigNum(mpMult, mult);\r\n    } else {\r\n      selfMult = safeMultiplyBigNum(selfMult, mult);\r\n    }\r\n  }\r\n\r\n  const evolutions = activeEvolutionsForUpgrade(upg);\r\n  for (let i = 0; i < evolutions; i += 1) {\r\n    selfMult = safeMultiplyBigNum(selfMult, HM_EVOLUTION_EFFECT_MULT_BN);\r\n  }\r\n\r\n  return { selfMult, xpMult, coinMult, mpMult };\r\n}\r\n\r\nfunction hmNextMilestoneLevel(upg, levelBn, areaKey = DEFAULT_AREA_KEY) {\r\n  if (!upg || upg.upgType !== 'HM') return null;\r\n  if (levelBn?.isInfinite?.()) return BigNum.fromAny('Infinity');\r\n  const milestones = resolveHmMilestones(upg, areaKey);\r\n  if (!milestones.length) return null;\r\n\r\n  let best = null;\r\n  for (const m of milestones) {\r\n    const lvl = Math.max(0, Math.floor(Number(m?.level ?? m?.lvl ?? 0)));\r\n    const hits = hmMilestoneHits(levelBn, lvl);\r\n    let candidate = null;\r\n    try {\r\n      const base = BigInt(lvl);\r\n      const nextHits = BigInt(Math.max(0, hits));\r\n      const targetBi = base + (BigInt(HM_EVOLUTION_INTERVAL) * nextHits);\r\n      if (targetBi > 0n) {\r\n        candidate = BigNum.fromAny(targetBi.toString());\r\n      }\r\n    } catch {}\r\n    if (!candidate) {\r\n      const increment = BigNum.fromAny(HM_EVOLUTION_INTERVAL * Math.max(0, hits));\r\n      try { candidate = increment.add(BigNum.fromAny(lvl)); }\r\n      catch { candidate = BigNum.fromAny(lvl + HM_EVOLUTION_INTERVAL * hits); }\r\n    }\r\n    if (!candidate) continue;\r\n    if (levelBn?.cmp?.(candidate) >= 0) {\r\n      try { candidate = candidate.add(BigNum.fromAny(HM_EVOLUTION_INTERVAL)); }\r\n      catch {}\r\n    }\r\n    if (!best || best.cmp(candidate) > 0) {\r\n      best = candidate;\r\n    }\r\n  }\r\n  return best;\r\n}\r\n\r\nfunction resolveDefaultScalingRatio(upg) {\r\n  if (!upg) return null;\r\n\r\n  const tryPreset = (name) => {\r\n    const presetName = `${name ?? ''}`.toUpperCase();\r\n    if (!presetName) return null;\r\n    const presetFn = DEFAULT_SCALING_PRESETS[presetName];\r\n    if (typeof presetFn !== 'function') return null;\r\n    const ratio = presetFn(upg);\r\n    if (!Number.isFinite(ratio) || ratio <= 0) return null;\r\n    return { ratio, preset: presetName };\r\n  };\r\n\r\n  return (\r\n    tryPreset(upg.scalingPreset)\r\n    || tryPreset(upg.upgType)\r\n    || tryPreset('STANDARD')\r\n  );\r\n}\r\n\r\nfunction ensureUpgradeScaling(upg) {\r\n  if (!upg) return null;\r\n  if (upg.scaling && upg.scaling.baseBn) return upg.scaling;\r\n  try {\r\n    const baseBn = BigNum.fromAny(upg.baseCost ?? upg.baseCostBn ?? 0);\r\n\r\n    const providedScaling = upg.scaling ?? {};\r\n    let ratio = Number(providedScaling.ratio);\r\n    if (!(ratio > 0) || !Number.isFinite(ratio)) ratio = null;\r\n\r\n    let ratioStr = typeof providedScaling.ratioStr === 'string'\r\n      ? providedScaling.ratioStr.trim()\r\n      : '';\r\n    if (!ratio && ratioStr) {\r\n      const parsed = Number(ratioStr);\r\n      if (Number.isFinite(parsed) && parsed > 0) {\r\n        ratio = parsed;\r\n      }\r\n    }\r\n\r\n    let ratioLog10 = Number(providedScaling.ratioLog10);\r\n    if (!Number.isFinite(ratioLog10)) ratioLog10 = null;\r\n    if (!ratio && ratioLog10 != null) {\r\n      const pow = Math.pow(10, ratioLog10);\r\n      if (Number.isFinite(pow) && pow > 0) ratio = pow;\r\n    }\r\n\r\n    let ratioLn = Number(providedScaling.ratioLn);\r\n    if (!Number.isFinite(ratioLn)) ratioLn = null;\r\n    if (!ratio && ratioLn != null) {\r\n      const exp = Math.exp(ratioLn);\r\n      if (Number.isFinite(exp) && exp > 0) ratio = exp;\r\n    }\r\n\r\n    if (!ratio) {\r\n      const ratioMinus1 = Number(providedScaling.ratioMinus1);\r\n      if (Number.isFinite(ratioMinus1) && ratioMinus1 > 0) {\r\n        ratio = ratioMinus1 + 1;\r\n      }\r\n    }\r\n\r\n    let defaultPreset = null;\r\n    if (!ratio) {\r\n      const resolved = resolveDefaultScalingRatio(upg);\r\n      if (resolved) {\r\n        ratio = resolved.ratio;\r\n        defaultPreset = resolved.preset;\r\n      }\r\n    }\r\n\r\n    if (!(ratio > 1)) {\r\n      ratio = 1;\r\n      ratioStr = '1';\r\n      ratioLog10 = 0;\r\n      ratioLn = 0;\r\n      var ratioMinus1 = 0;\r\n    } else {\r\n      ratio = Number(ratio);\r\n      ratioStr = decimalMultiplierString(ratio);\r\n      ratioLog10 = Math.log10(ratio);\r\n      ratioLn = Math.log(ratio);\r\n      var ratioMinus1 = Math.max(1e-12, ratio - 1);\r\n    }\r\n\r\n    const baseLog10 = approxLog10BigNum(baseBn);\r\n\r\n    const scaling = Object.assign({}, providedScaling, {\r\n      baseBn,\r\n      baseLog10,\r\n      ratio,\r\n      ratioMinus1,\r\n      ratioLog10,\r\n      ratioLn,\r\n      ratioStr,\r\n      defaultPreset: defaultPreset ?? providedScaling.defaultPreset,\r\n    });\r\n\r\n    // Expose the in-progress scaling so recursive cost checks can use it\r\n    upg.scaling = scaling;\r\n\r\n    try {\r\n      const c0 = BigNum.fromAny(upg.costAtLevel?.(0) ?? 0);\r\n      const c1 = BigNum.fromAny(upg.costAtLevel?.(1) ?? 0);\r\n      const cF = BigNum.fromAny(upg.costAtLevel?.(32) ?? 0);\r\n      if (c0.cmp(c1) === 0 && c0.cmp(cF) === 0) {\r\n        scaling.ratio = 1;\r\n        scaling.ratioMinus1 = 0;\r\n        scaling.ratioLog10 = 0;\r\n        scaling.ratioLn = 0;\r\n        scaling.ratioStr = '1';\r\n      }\r\n    } catch {}\r\n\r\n    return scaling;\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\nfunction costAtLevelUsingScaling(upg, level) {\r\n  const scaling = ensureUpgradeScaling(upg);\r\n  if (!scaling) return BigNum.fromInt(0);\r\n  const lvl = Math.max(0, Math.floor(Number(level) || 0));\r\n  if (lvl === 0) return BigNum.fromAny(scaling.baseBn);\r\n\r\n  // Approach A (robust & simple): multiply without flooring, floor once at end\r\n  if (lvl <= 100) {\r\n    let price = BigNum.fromAny(scaling.baseBn);\r\n    for (let i = 0; i < lvl; i += 1) {\r\n      // precise decimal multiply (no truncation each step)\r\n      price = price.mulDecimal(scaling.ratioStr);\r\n    }\r\n    return price.floorToInteger();\r\n  }\r\n\r\n  // Existing mid-range anchor + tail (kept as-is)\r\n  if (lvl < 10000) {\r\n    const anchor = Math.max(0, lvl - 10);\r\n    let price = bigNumFromLog10(scaling.baseLog10 + anchor * scaling.ratioLog10);\r\n    for (let step = anchor; step < lvl; step += 1) {\r\n      price = price.mulDecimal(scaling.ratioStr);\r\n    }\r\n    return price.floorToInteger();\r\n  }\r\n\r\n  // Very large levels: closed form via logs\r\n  return bigNumFromLog10(scaling.baseLog10 + lvl * scaling.ratioLog10).floorToInteger();\r\n}\r\n\r\n\r\nfunction logExpMinus1(x) {\r\n  if (!Number.isFinite(x)) return x;\r\n  if (x < 1e-6) {\r\n    return Math.log(Math.expm1(x));\r\n  }\r\n  if (x < 50) {\r\n    return Math.log(Math.expm1(x));\r\n  }\r\n  const negExp = Math.exp(-x);\r\n  return x + Math.log1p(-negExp);\r\n}\r\n\r\nfunction logSeriesTotal(upg, startLevel, count) {\r\n  if (!(count > 0)) return Number.NEGATIVE_INFINITY;\r\n  const scaling = ensureUpgradeScaling(upg);\r\n  if (!scaling) return Number.NEGATIVE_INFINITY;\r\n  if (!(scaling.ratioMinus1 > 0) || !Number.isFinite(scaling.ratioLn)) {\r\n    return Number.POSITIVE_INFINITY;\r\n  }\r\n\r\n  const startLn = (scaling.baseLog10 * LN10) + (startLevel * scaling.ratioLn);\r\n  const growth = scaling.ratioLn * count;\r\n  const numerLn = logExpMinus1(growth);\r\n  if (!Number.isFinite(numerLn)) return Number.POSITIVE_INFINITY;\r\n  const denomLn = Math.log(scaling.ratioMinus1);\r\n  const totalLn = startLn + numerLn - denomLn;\r\n  return totalLn / LN10;\r\n}\r\n\r\nfunction totalCostBigNum(upg, startLevel, count) {\r\n  if (!(count > 0)) return BigNum.fromInt(0);\r\n  const scaling = ensureUpgradeScaling(upg);\r\n  if (!scaling) return BigNum.fromInt(0);\r\n  const targetLevel = startLevel + count;\r\n\r\n  if (targetLevel <= 100) {\r\n    let price = BigNum.fromAny(upg.costAtLevel(startLevel));\r\n    let total = BigNum.fromInt(0);\r\n    for (let i = 0; i < count; i += 1) {\r\n      total = total.add(price);\r\n      if (i + 1 < count) price = price.mulDecimalFloor(scaling.ratioStr);\r\n    }\r\n    return total;\r\n  }\r\n\r\n  if (targetLevel < 10000) {\r\n    const tailCount = Math.min(10, count);\r\n    const headCount = count - tailCount;\r\n    let total = BigNum.fromInt(0);\r\n    if (headCount > 0) {\r\n      const headLog = logSeriesTotal(upg, startLevel, headCount);\r\n      total = total.add(bigNumFromLog10(headLog));\r\n    }\r\n    if (tailCount > 0) {\r\n      const tailStart = startLevel + headCount;\r\n      let price = BigNum.fromAny(upg.costAtLevel(tailStart));\r\n      for (let i = 0; i < tailCount; i += 1) {\r\n        total = total.add(price);\r\n        if (i + 1 < tailCount) price = price.mulDecimalFloor(scaling.ratioStr);\r\n      }\r\n    }\r\n    return total;\r\n  }\r\n\r\n  const totalLog = logSeriesTotal(upg, startLevel, count);\r\n  return bigNumFromLog10(totalLog);\r\n}\r\n\r\nfunction log10OnePlusPow10(exponent) {\r\n  if (!Number.isFinite(exponent)) {\r\n    if (exponent > 0) return exponent;\r\n    if (exponent === 0) return Math.log10(2);\r\n    return 0;\r\n  }\r\n  if (exponent > 308) return exponent;\r\n  if (exponent < -20) {\r\n    const pow = Math.pow(10, exponent);\r\n    return pow / LN10;\r\n  }\r\n  const pow = Math.pow(10, exponent);\r\n  if (!Number.isFinite(pow)) return exponent > 0 ? exponent : 0;\r\n  return Math.log1p(pow) / LN10;\r\n}\r\n\r\nconst MAX_LEVEL_DELTA_LIMIT = (() => {\r\n  try {\r\n    const approx = levelBigNumToNumber(MAX_LEVEL_DELTA);\r\n    if (!Number.isFinite(approx)) return Number.POSITIVE_INFINITY;\r\n    if (approx <= 0) return 0;\r\n    return Math.floor(approx);\r\n  } catch {\r\n    return Number.MAX_SAFE_INTEGER;\r\n  }\r\n})();\r\n\r\nconst FLOAT64_BUFFER = new ArrayBuffer(8);\r\nconst FLOAT64_VIEW = new Float64Array(FLOAT64_BUFFER);\r\nconst INT64_VIEW = new BigInt64Array(FLOAT64_BUFFER);\r\n\r\nfunction nextDownPositive(value) {\r\n  if (!(value > 0) || !Number.isFinite(value)) return value;\r\n  FLOAT64_VIEW[0] = value;\r\n  if (FLOAT64_VIEW[0] <= 0) return 0;\r\n  INT64_VIEW[0] -= 1n;\r\n  const next = FLOAT64_VIEW[0];\r\n  return next > 0 ? next : 0;\r\n}\r\n\r\nfunction nextUpPositive(value) {\r\n  if (!(value >= 0) || !Number.isFinite(value)) return value;\r\n  FLOAT64_VIEW[0] = value;\r\n  INT64_VIEW[0] += 1n;\r\n  const next = FLOAT64_VIEW[0];\r\n  return next > value ? next : value;\r\n}\r\n\r\nfunction safeDecrementCount(value) {\r\n  if (!(value > 0)) return 0;\r\n  const dec = Math.floor(value - 1);\r\n  if (dec < value) return dec;\r\n  const next = nextDownPositive(value);\r\n  if (next < value) return next;\r\n  return value > 1 ? value / 2 : 0;\r\n}\r\n\r\nfunction countToBigNum(count) {\r\n  if (!(count > 0) || !Number.isFinite(count)) return BigNum.fromInt(0);\r\n  const floored = Math.floor(count);\r\n  if (!(floored > 0)) return BigNum.fromInt(0);\r\n  if (floored <= Number.MAX_SAFE_INTEGER) {\r\n    return BigNum.fromInt(floored);\r\n  }\r\n  let str;\r\n  try {\r\n    str = floored.toLocaleString('fullwide', { useGrouping: false, maximumFractionDigits: 0 });\r\n  } catch {\r\n    str = floored.toString();\r\n  }\r\n  if (!str || !/\\d/.test(str)) return BigNum.fromInt(0);\r\n  return BigNum.fromAny(str);\r\n}\r\n\r\nfunction calculateBulkPurchase(upg, startLevel, walletBn, maxLevels = MAX_LEVEL_DELTA, options = {}) {\r\n  const scaling = ensureUpgradeScaling(upg);\r\n  const zero = BigNum.fromInt(0);\r\n  const opts = options || {};\r\n  const fastOnly = !!opts.fastOnly;\r\n  walletBn = walletBn instanceof BigNum ? walletBn : BigNum.fromAny(walletBn ?? 0);\r\n  if (!scaling) {\r\n    return { count: zero, spent: zero, nextPrice: zero, numericCount: 0 };\r\n  }\r\n\r\n  const startLevelNum = Math.max(0, Math.floor(levelBigNumToNumber(startLevel)));\r\n\r\n  const cap = Number.isFinite(upg.lvlCap)\r\n    ? Math.max(0, Math.floor(upg.lvlCap))\r\n    : Number.POSITIVE_INFINITY;\r\n  const maxLevelsNum = typeof maxLevels === 'number'\r\n    ? maxLevels\r\n    : levelBigNumToNumber(maxLevels);\r\n  const capRoom = Number.isFinite(cap)\r\n    ? Math.max(0, cap - startLevelNum)\r\n    : MAX_LEVEL_DELTA_LIMIT;\r\n  let room = Number.isFinite(maxLevelsNum)\r\n    ? Math.max(0, Math.floor(maxLevelsNum))\r\n    : MAX_LEVEL_DELTA_LIMIT;\r\n  room = Math.min(room, MAX_LEVEL_DELTA_LIMIT, capRoom);\r\n  if (!(room > 0)) {\r\n    const nextPrice = capRoom <= 0 ? zero : BigNum.fromAny(upg.costAtLevel(startLevelNum));\r\n    return { count: zero, spent: zero, nextPrice, numericCount: 0 };\r\n  }\r\n\r\n  // For small levels we can cheaply compute an exact floored progression, which\r\n  // avoids undercounting caused by geometric approximations that ignore per-step\r\n  // flooring (e.g., costs like 3 \u2192 3 \u2192 4 instead of 3 \u2192 3.6 \u2192 4.32).\r\n  const remainingToHundred = 100 - startLevelNum;\r\n  if (Number.isFinite(startLevelNum) && remainingToHundred > 0) {\r\n    const limit = Math.min(room, remainingToHundred);\r\n    let price = BigNum.fromAny(upg.costAtLevel(startLevelNum));\r\n    let spent = zero;\r\n    let count = 0;\r\n\r\n    while (count < limit) {\r\n      // Use the exact per-level cost function (with its own flooring logic)\r\n      // instead of multiplying by ratio, so we don't drift when costs change\r\n      // non-geometrically around low levels.\r\n      price = BigNum.fromAny(upg.costAtLevel(startLevelNum + count));\r\n      const newSpent = spent.add(price);\r\n      if (newSpent.cmp(walletBn) > 0) break;\r\n      spent = newSpent;\r\n      count += 1;\r\n    }\r\n\r\n    const nextLevel = startLevelNum + count;\r\n    const reachedCap = Number.isFinite(cap) && nextLevel >= cap;\r\n    const countBn = countToBigNum(count);\r\n\r\n    if (count < limit || reachedCap || room <= count) {\r\n      const nextPrice = reachedCap\r\n        ? zero\r\n        : BigNum.fromAny(upg.costAtLevel(nextLevel));\r\n      return { count: countBn, spent, nextPrice, numericCount: count };\r\n    }\r\n\r\n    const nextStartLevel = (() => {\r\n      try { return toUpgradeBigNum(startLevel ?? startLevelNum, startLevelNum).add(countBn); }\r\n      catch { return startLevelNum + count; }\r\n    })();\r\n    const tail = calculateBulkPurchase(\r\n      upg,\r\n      nextStartLevel,\r\n      walletBn.sub(spent),\r\n      room - count,\r\n      options,\r\n    );\r\n\r\n    const tailCount = tail?.count instanceof BigNum ? tail.count : countToBigNum(tail?.numericCount ?? 0);\r\n    const totalCount = countBn.add(tailCount);\r\n    const totalSpent = (tail?.spent ?? zero).add(spent);\r\n\r\n    return {\r\n      count: totalCount,\r\n      spent: totalSpent,\r\n      nextPrice: tail?.nextPrice ?? zero,\r\n      numericCount: count + (tail?.numericCount ?? 0),\r\n    };\r\n  }\r\n\r\nlet walletLog = approxLog10BigNum(walletBn);\r\n\r\nconst ratioLog10 = scaling.ratioLog10;\r\nconst ratioMinus1 = scaling.ratioMinus1;\r\nconst firstPrice = BigNum.fromAny(upg.costAtLevel(startLevelNum));\r\n\r\n\r\nconst startPriceLog = scaling.baseLog10 + (startLevelNum * ratioLog10);\r\n\r\n// Fallback: if walletLog isn't finite *or* magnitudes are so huge that\r\n// double-precision subtraction will be meaningless, do a pure-BigNum search.\r\nconst needBnSearch =\r\n  (ratioMinus1 > 0) && (\r\n    !Number.isFinite(walletLog) ||\r\n    (Math.abs(walletLog) > 1e6 && Math.abs(startPriceLog) > 1e6)\r\n  );\r\n\r\nif (needBnSearch) {\r\n  // Quick \"can't even buy 1\" check\r\n  const firstPrice = BigNum.fromAny(upg.costAtLevel(startLevelNum));\r\n  if (walletBn.cmp(firstPrice) < 0) {\r\n    return { count: zero, spent: zero, nextPrice: firstPrice, numericCount: 0 };\r\n  }\r\n\r\n  // Bound the affordable count using only BigNum compares\r\n  const hardLimit = Number.isFinite(room) ? Math.max(1, Math.floor(room)) : Number.MAX_VALUE;\r\n  let lo = 1;\r\n  let hi = 1;\r\n\r\nwhile (hi < hardLimit) {\r\n  const spentLog = logSeriesTotal(upg, startLevelNum, hi);\r\n  const spentBn  = bigNumFromLog10(spentLog);\r\n  if (spentBn.cmp(walletBn) <= 0) {\r\n    const doubled = hi * 2;\r\n    if (!Number.isFinite(doubled) || doubled <= hi) { hi = hardLimit; break; }\r\n    lo = hi;\r\n    hi = Math.min(doubled, hardLimit);\r\n  } else {\r\n    break;\r\n  }\r\n}\r\n\r\n  let steps = 0;\r\n  while (lo < hi && steps < 256) {\r\n    const mid = Math.max(lo + 1, Math.floor((lo + hi + 1) / 2));\r\n    const spentLog = logSeriesTotal(upg, startLevelNum, mid);\r\n    const spentBn  = bigNumFromLog10(spentLog);\r\n    if (spentBn.cmp(walletBn) <= 0) {\r\n      lo = mid;\r\n    } else {\r\n      hi = mid - 1;\r\n    }\r\n    steps++;\r\n  }\r\n\r\n  const count = Math.max(1, lo);\r\n  const countBn = countToBigNum(count);\r\n\r\n  // In fastOnly mode we can skip exact 'spent'; otherwise compute precisely.\r\n  let spent = zero;\r\n  let nextPrice = zero;\r\n  if (!fastOnly) {\r\n    spent = totalCostBigNum(upg, startLevelNum, count);\r\n    if (Number.isFinite(cap)) {\r\n      const capRoom = Math.max(0, Math.floor(cap - Math.min(startLevelNum, cap)));\r\n      if (count >= capRoom) {\r\n        nextPrice = zero;\r\n      } else {\r\n        nextPrice = bigNumFromLog10(startPriceLog + count * ratioLog10);\r\n      }\r\n    } else {\r\n      nextPrice = bigNumFromLog10(startPriceLog + count * ratioLog10);\r\n    }\r\n  }\r\n\r\n  return {\r\n    count: countBn,\r\n    spent,\r\n    nextPrice,\r\n    numericCount: count,\r\n  };\r\n}\r\n\r\n  if (walletBn.cmp(firstPrice) < 0) {\r\n    return { count: zero, spent: zero, nextPrice: firstPrice, numericCount: 0 };\r\n  }\r\n\r\nlet isConstantCost = false;\r\nlet secondPrice = null, farPrice = null;\r\n\r\ntry { secondPrice = BigNum.fromAny(upg.costAtLevel(startLevelNum + 1)); } catch {}\r\ntry {\r\n  const farProbe = Math.min(\r\n    Number.isFinite(cap) ? Math.max(startLevelNum + 1, Math.floor(cap)) : startLevelNum + 32,\r\n    startLevelNum + 32\r\n  );\r\n  farPrice = BigNum.fromAny(upg.costAtLevel(farProbe));\r\n} catch {}\r\nif (!isConstantCost && !(scaling.ratioMinus1 > 0)) {\r\n  isConstantCost = true;\r\n}\r\n\r\nif (secondPrice && farPrice) {\r\n  isConstantCost =\r\n    secondPrice.cmp(firstPrice) === 0 &&\r\n    farPrice.cmp(firstPrice) === 0;\r\n}\r\n\r\nif (!isConstantCost && !(scaling.ratioMinus1 > 0)) {\r\n  isConstantCost = true;\r\n}\r\n\r\n  const limit = Number.isFinite(room)\r\n    ? Math.max(0, Math.floor(room))\r\n    : Number.MAX_VALUE;\r\n\r\n  if (isConstantCost) {\r\n  const capBn = toUpgradeBigNum(upg.lvlCapBn ?? 'Infinity', 'Infinity');\r\n  const lvlBn = toUpgradeBigNum(startLevel ?? 0, 0);\r\n  const roomBn = capBn.isInfinite?.()\r\n    ? BigNum.fromAny('Infinity')\r\n    : capBn.sub(lvlBn).floorToInteger();\r\n\r\n  const { count, countBn, spent, nextPrice } = estimateFlatBulk(\r\n    firstPrice,\r\n    walletBn,\r\n    roomBn\r\n  );\r\n\r\n  return {\r\n    count: countBn,\r\n    spent,\r\n    nextPrice,\r\n    numericCount: count,\r\n  };\r\n}\r\n\r\nif (!(ratioLog10 > 0) || !(ratioMinus1 > 0)) {\r\n  const capBn = toUpgradeBigNum(upg.lvlCapBn ?? 'Infinity', 'Infinity');\r\n  const lvlBn = toUpgradeBigNum(startLevel ?? 0, 0);\r\n  const roomBn = capBn.isInfinite?.()\r\n    ? BigNum.fromAny('Infinity')\r\n    : capBn.sub(lvlBn).floorToInteger();\r\n\r\n  const { count, countBn, spent, nextPrice } =\r\n    estimateFlatBulk(firstPrice, walletBn, roomBn);\r\n\r\n  return { count: countBn, spent, nextPrice, numericCount: count };\r\n}\r\n\r\n  const ratioMinus1Log = Math.log10(ratioMinus1);\r\n  if (!Number.isFinite(ratioMinus1Log)) {\r\n    return { count: zero, spent: zero, nextPrice: firstPrice, numericCount: 0 };\r\n  }\r\n\r\n  const logTarget = log10OnePlusPow10(walletLog + ratioMinus1Log - startPriceLog);\r\n  let approxCount = logTarget / ratioLog10;\r\n  if (!Number.isFinite(approxCount) || approxCount < 0) approxCount = 0;\r\n\r\n  let count = Math.floor(Math.min(limit, approxCount));\r\n  if (!Number.isFinite(count)) count = limit;\r\n  if (count <= 0) count = 1;\r\n\r\n  const EPS = 1e-7;\r\n  let spentLog = logSeriesTotal(upg, startLevelNum, count);\r\n  let tuneSteps = 0;\r\n  const MAX_TUNE_STEPS = 2048;\r\n\r\n  while (count > 0 && (!Number.isFinite(spentLog) || spentLog > walletLog + EPS) && tuneSteps < MAX_TUNE_STEPS) {\r\n    const overshoot = Number.isFinite(spentLog)\r\n      ? Math.max(1, Math.ceil((spentLog - walletLog) / Math.max(ratioLog10, 1e-12)))\r\n      : Math.max(1, Math.floor(count / 2));\r\n    const reduced = Math.max(0, Math.floor(count - overshoot));\r\n    if (reduced < count) {\r\n      count = reduced;\r\n    } else {\r\n      const next = nextDownPositive(count);\r\n      if (!(next < count)) break;\r\n      count = next;\r\n    }\r\n    spentLog = count > 0 ? logSeriesTotal(upg, startLevelNum, count) : Number.NEGATIVE_INFINITY;\r\n    tuneSteps += 1;\r\n  }\r\n\r\n  if (count <= 0 || !Number.isFinite(count)) {\r\n    if (walletBn.cmp(firstPrice) >= 0) {\r\n      count = 1;\r\n      spentLog = approxLog10BigNum(firstPrice);\r\n    } else {\r\n      return { count: zero, spent: zero, nextPrice: firstPrice, numericCount: 0 };\r\n    }\r\n  }\r\n\r\n  if (count < limit) {\r\n  const safeTimes2 = (x) => {\r\n    const y = x * 2;\r\n    return Number.isFinite(y) ? y : Number.MAX_VALUE;\r\n  };\r\n\r\n  let lo = count;\r\n  let hi = Math.min(limit, Math.max(count + 1, safeTimes2(count)));\r\n  let hiLog = logSeriesTotal(upg, startLevelNum, hi);\r\n\r\n  while (lo < hi && Number.isFinite(hiLog) && hiLog <= walletLog + EPS && hi < limit) {\r\n    lo = hi;\r\n    hi = Math.min(limit, safeTimes2(hi));\r\n    hiLog = logSeriesTotal(upg, startLevelNum, hi);\r\n  }\r\n\r\n  let left = lo, right = hi;\r\n  for (let i = 0; i < 256 && left < right; i += 1) {\r\n    const mid = Math.floor((left + right + 1) / 2);\r\n    const midLog = logSeriesTotal(upg, startLevelNum, mid);\r\n    if (Number.isFinite(midLog) && midLog <= walletLog + EPS) {\r\n      left = mid;\r\n      spentLog = midLog;\r\n    } else {\r\n      right = mid - 1;\r\n    }\r\n  }\r\n  count = left;\r\n}\r\n\r\n  let spent = null;\r\n  if (!fastOnly) {\r\n    spent = totalCostBigNum(upg, startLevelNum, count);\r\n    let guard = 0;\r\n    while (spent.cmp(walletBn) > 0 && count > 0 && guard < MAX_TUNE_STEPS) {\r\n      const decremented = safeDecrementCount(count);\r\n      if (!(decremented < count)) break;\r\n      count = decremented;\r\n      spent = totalCostBigNum(upg, startLevelNum, count);\r\n      guard += 1;\r\n    }\r\n    if (count <= 0) {\r\n      return { count: zero, spent: zero, nextPrice: firstPrice, numericCount: 0 };\r\n    }\r\n\r\n    if (count < limit && guard < MAX_TUNE_STEPS) {\r\n      while (count < limit && guard < MAX_TUNE_STEPS) {\r\n        const nextLevel = startLevelNum + count;\r\n        let nextCost;\r\n\r\n        try {\r\n          if (Number.isFinite(nextLevel) && nextLevel < Number.MAX_SAFE_INTEGER / 2) {\r\n            nextCost = BigNum.fromAny(upg.costAtLevel(nextLevel));\r\n          } else {\r\n            const nextLog = startPriceLog + (count * ratioLog10);\r\n            nextCost = bigNumFromLog10(nextLog).floorToInteger();\r\n          }\r\n        } catch {\r\n          break;\r\n        }\r\n\r\n        const newSpent = spent.add(nextCost);\r\n        if (newSpent.cmp(walletBn) > 0) {\r\n          break;\r\n        }\r\n\r\n        spent = newSpent;\r\n        count += 1;\r\n        guard += 1;\r\n      }\r\n    }\r\n  }\r\n\r\nlet nextPrice = zero;\r\n\r\nconst canUseNumericFinal =\r\n  !fastOnly &&\r\n  Number.isFinite(startLevelNum) &&\r\n  Number.isFinite(count) &&\r\n  startLevelNum < Number.MAX_SAFE_INTEGER / 2 &&\r\n  count < Number.MAX_SAFE_INTEGER / 2;\r\n\r\nif (!fastOnly) {\r\n  if (Number.isFinite(cap)) {\r\n    const capRoom = Math.max(0, Math.floor(cap - Math.min(startLevelNum, cap)));\r\n    if (count >= capRoom) {\r\n      nextPrice = zero;\r\n    } else if (canUseNumericFinal) {\r\n      const finalLevel = Math.floor(startLevelNum + count);\r\n      nextPrice = BigNum.fromAny(upg.costAtLevel(finalLevel));\r\n    } else {\r\n      // Fallback: compute via logs to avoid unsafe integer math\r\n      const nextLog = startPriceLog + count * ratioLog10;\r\n      nextPrice = bigNumFromLog10(nextLog);\r\n    }\r\n  } else {\r\n    if (canUseNumericFinal) {\r\n      const finalLevel = Math.floor(startLevelNum + count);\r\n      nextPrice = BigNum.fromAny(upg.costAtLevel(finalLevel));\r\n    } else {\r\n      const nextLog = startPriceLog + count * ratioLog10;\r\n      nextPrice = bigNumFromLog10(nextLog);\r\n    }\r\n  }\r\n}\r\n\r\n  const countBn = countToBigNum(count);\r\n  return {\r\n    count: countBn,\r\n    spent,\r\n    nextPrice,\r\n    numericCount: count,\r\n  };\r\n}\r\n\r\nfunction computeBulkMeta(upg) {\r\n  try {\r\n    const basePrice = BigNum.fromAny(upg.costAtLevel(0));\r\n    const nextPrice = BigNum.fromAny(\r\n      typeof upg.nextCostAfter === 'function'\r\n        ? upg.nextCostAfter(basePrice, 1)\r\n        : upg.costAtLevel(1)\r\n    );\r\n    const logBase = approxLog10BigNum(basePrice);\r\n    const logNext = approxLog10BigNum(nextPrice);\r\n    if (!Number.isFinite(logBase) || !Number.isFinite(logNext)) return null;\r\n    const ratioLog = logNext - logBase;\r\n    if (!Number.isFinite(ratioLog) || ratioLog <= 0) return null;\r\n    const ratio = Math.pow(10, ratioLog);\r\n    if (!Number.isFinite(ratio) || ratio <= 1) return null;\r\n    const denom = ratio - 1;\r\n    if (!(denom > 0) || !Number.isFinite(denom)) return null;\r\n    return {\r\n      ratio,\r\n      ratioLog,\r\n      logDenom: Math.log10(denom),\r\n    };\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\nexport function estimateFlatBulk(priceBn, walletBn, roomBn) {\r\n  // Guardrails\r\n  if (!(priceBn instanceof BigNum)) priceBn = BigNum.fromAny(priceBn ?? 0);\r\n  if (!(walletBn instanceof BigNum)) walletBn = BigNum.fromAny(walletBn ?? 0);\r\n  if (!(roomBn instanceof BigNum)) roomBn = BigNum.fromAny(roomBn ?? 0);\r\n  if (priceBn.isZero?.()) return { count: 0 };\r\n  if (walletBn.isZero?.()) return { count: 0 };\r\n\r\nconst wPlain = walletBn.toPlainIntegerString?.();\r\nconst pPlain = priceBn.toPlainIntegerString?.();\r\nif (wPlain && wPlain !== 'Infinity' && pPlain && pPlain !== 'Infinity') {\r\n  const q = BigInt(wPlain) / BigInt(pPlain);\r\n  let countBn = BigNum.fromAny(q.toString());\r\n  if (!roomBn.isInfinite?.() && countBn.cmp(roomBn) > 0) countBn = roomBn;\r\n  const spent = priceBn.mulBigNumInteger(countBn);\r\n  return { count: levelCapToNumber(countBn), countBn, spent, nextPrice: priceBn };\r\n}\r\n\r\nconst wl = approxLog10BigNum(walletBn);\r\nconst pl = approxLog10BigNum(priceBn);\r\nif (!Number.isFinite(wl) || !Number.isFinite(pl) || wl < pl) return { count: 0 };\r\nlet countBn = bigNumFromLog10(wl - pl).floorToInteger();\r\n  \r\n  if (!roomBn.isInfinite?.() && countBn.cmp(roomBn) > 0) countBn = roomBn;\r\n  \r\n  const spent = priceBn.mulBigNumInteger(countBn);\r\n  const nextPrice = priceBn;\r\n  \r\n  return { count: levelCapToNumber(countBn), countBn, spent, nextPrice };\r\n}\r\n\r\nexport function estimateGeometricBulk(priceBn, walletBn, meta, maxLevels) {\r\n  if (!meta || maxLevels <= 0) return { count: 0 };\r\n  const walletLog = approxLog10BigNum(walletBn);\r\n  const priceLog = approxLog10BigNum(priceBn);\r\n  if (!Number.isFinite(walletLog) || !Number.isFinite(priceLog)) return { count: 0 };\r\n  if (walletLog < priceLog) return { count: 0 };\r\n\r\n  const numerator = walletLog - priceLog + meta.logDenom;\r\n  if (!Number.isFinite(numerator) || numerator <= 0) return { count: 0 };\r\n\r\n  let hi = Math.floor(numerator / meta.ratioLog);\r\n  if (!Number.isFinite(hi) || hi <= 0) return { count: 0 };\r\n  hi = Math.min(hi, maxLevels);\r\n  if (hi <= 0) return { count: 0 };\r\n\r\n  let lo = 0;\r\n  let hiBound = hi;\r\n  for (let iter = 0; iter < 64 && lo < hiBound; iter += 1) {\r\n    const mid = Math.max(0, Math.floor((lo + hiBound + 1) / 2));\r\n    const spentLog = priceLog + mid * meta.ratioLog - meta.logDenom;\r\n    if (spentLog <= walletLog) {\r\n      lo = mid;\r\n    } else {\r\n      hiBound = mid - 1;\r\n    }\r\n  }\r\n\r\n  const best = Math.min(lo, maxLevels);\r\n  if (best <= 0) return { count: 0 };\r\n  const spentLog = priceLog + best * meta.ratioLog - meta.logDenom;\r\n  if (spentLog > walletLog) return { count: 0 };\r\n  const nextPriceLog = priceLog + best * meta.ratioLog;\r\n  const spent = bigNumFromLog10(spentLog);\r\n  const nextPrice = bigNumFromLog10(nextPriceLog);\r\n  return {\r\n    count: best,\r\n    spent,\r\n    nextPrice,\r\n    spentLog,\r\n    nextPriceLog,\r\n  };\r\n}\r\n\r\nfunction toUpgradeBigNum(value, fallback) {\r\n  try {\r\n    return BigNum.fromAny(value ?? fallback ?? 0);\r\n  } catch {\r\n    return BigNum.fromAny(fallback ?? 0);\r\n  }\r\n}\r\n\r\nfunction levelCapToNumber(bn) {\r\n  if (!(bn instanceof BigNum)) return Infinity;\r\n  if (bn.isInfinite?.()) return Infinity;\r\n  try {\r\n    const plain = bn.toPlainIntegerString();\r\n    if (plain === 'Infinity') return Infinity;\r\n    if (!plain) return 0;\r\n    if (plain.length > 15) return Number.MAX_SAFE_INTEGER;\r\n    const num = Number(plain);\r\n    if (!Number.isFinite(num)) return Number.MAX_SAFE_INTEGER;\r\n    return Math.max(0, Math.floor(num));\r\n  } catch {\r\n    return Number.MAX_SAFE_INTEGER;\r\n  }\r\n}\r\n\r\nfunction formatBigNumAsHtml(bn) {\r\n  return formatNumber(bn instanceof BigNum ? bn : BigNum.fromAny(bn ?? 0));\r\n}\r\n\r\nexport function formatMultForUi(value) {\r\n  try {\r\n    if (value && (value instanceof BigNum || value.toPlainIntegerString)) {\r\n      const log10 = approxLog10BigNum(value);\r\n      if (Number.isFinite(log10) && log10 < 3) {\r\n        const approx = Math.pow(10, log10);\r\n        return String(approx.toFixed(3))\r\n          .replace(/\\.0+$/, '')\r\n          .replace(/(\\.\\d*?)0+$/, '$1');\r\n      }\r\n      return formatNumber(value);\r\n    }\r\n\r\n    const n = Number(value) || 0;\r\n    if (Math.abs(n) < 1000) {\r\n      return String(n.toFixed(3))\r\n        .replace(/\\.0+$/, '')\r\n        .replace(/(\\.\\d*?)0+$/, '$1');\r\n    }\r\n    return formatNumber(n);\r\n  } catch {\r\n    return '1';\r\n  }\r\n}\r\n\r\n\r\nfunction formatBigNumAsPlain(bn) {\r\n  return formatBigNumAsHtml(bn).replace(/<[^>]*>/g, '');\r\n}\r\n\r\nfunction safeCloneBigNum(value) {\r\n  if (value instanceof BigNum) {\r\n    try { return value.clone?.() ?? BigNum.fromAny(value); }\r\n    catch { return BigNum.fromInt(0); }\r\n  }\r\n  try {\r\n    return BigNum.fromAny(value ?? 0);\r\n  } catch {\r\n    return BigNum.fromInt(0);\r\n  }\r\n}\r\n\r\nfunction emitUpgradeLevelChange(upg, prevLevelNum, prevLevelBn, nextLevelNum, nextLevelBn) {\r\n  if (!upg || typeof upg.onLevelChange !== 'function') return;\r\n\r\n  const oldBn = safeCloneBigNum(prevLevelBn ?? prevLevelNum ?? 0);\r\n  const newBn = safeCloneBigNum(nextLevelBn ?? nextLevelNum ?? 0);\r\n  const payload = {\r\n    upgrade: upg,\r\n    oldLevel: Number.isFinite(prevLevelNum)\r\n      ? prevLevelNum\r\n      : levelBigNumToNumber(oldBn),\r\n    newLevel: Number.isFinite(nextLevelNum)\r\n      ? nextLevelNum\r\n      : levelBigNumToNumber(newBn),\r\n    oldLevelBn: oldBn,\r\n    newLevelBn: newBn,\r\n  };\r\n\r\n  try {\r\n    upg.onLevelChange(payload);\r\n  } catch {}\r\n}\r\n\r\nfunction nmCostBN(upg, level) {\r\n  return costAtLevelUsingScaling(upg, level);\r\n}\r\n\r\nexport const AREA_KEYS = {\r\n  STARTER_COVE: 'starter_cove',\r\n};\r\n\r\nfunction syncBookCurrencyMultiplierFromUpgrade(levelOverride) {\r\n  const multHandle = bank?.books?.mult;\r\n  if (!multHandle || typeof multHandle.set !== 'function') return;\r\n\r\n  let resolvedLevel = 0;\r\n  const xpUnlocked = safeIsXpUnlocked();\r\n  if (xpUnlocked) {\r\n    if (Number.isFinite(levelOverride)) {\r\n      resolvedLevel = Math.max(0, Math.floor(levelOverride));\r\n    } else {\r\n      const storedLevel = getLevelNumber(AREA_KEYS.STARTER_COVE, UPGRADE_TIES.BOOK_VALUE_I);\r\n      resolvedLevel = Math.max(0, Number.isFinite(storedLevel) ? storedLevel : 0);\r\n    }\r\n  }\r\n\r\n  let multiplier;\r\n  try {\r\n    multiplier = bookValueMultiplierBn(resolvedLevel);\r\n  } catch {\r\n    multiplier = BigNum.fromInt(1);\r\n  }\r\n\r\n  try {\r\n    multHandle.set(multiplier.clone?.() ?? multiplier);\r\n  } catch {}\r\n}\r\n\r\n/**\r\n * upgType:\r\n *  - \"NM\" = No Milestones\r\n *  - \"HM\" = Has Milestones\r\n *\r\n * Optional field:\r\n *  - scaling: Manually change the multiplicative scaling ratio of an upgrade; not necessary for upgrades that have no scaling\r\n */\r\nconst REGISTRY = [\r\n  {\r\n    area: AREA_KEYS.STARTER_COVE,\r\n    id: 1,\r\n    tie: UPGRADE_TIES.FASTER_COINS,\r\n    title: \"Faster Coins\",\r\n    desc: \"Increases coin spawn rate by +10% per level\",\r\n    lvlCap: 10,\r\n    baseCost: 10,\r\n    costType: \"coins\",\r\n    upgType: \"NM\",\r\n    icon: \"sc_upgrade_icons/faster_coins.png\",\r\n    costAtLevel(level) { return nmCostBN(this, level); },\r\n    nextCostAfter(_, nextLevel) { return nmCostBN(this, nextLevel); },\r\n    effectSummary(level) {\r\n      const mult = this.effectMultiplier(level);\r\n      return `Coin spawn rate bonus: ${formatMultForUi(mult)}x`;\r\n    },\r\n    effectMultiplier: E.addPctPerLevel(0.10),\r\n  },\r\n  {\r\n    area: AREA_KEYS.STARTER_COVE,\r\n    id: 2,\r\n    tie: UPGRADE_TIES.UNLOCK_XP,\r\n    title: \"Unlock XP\",\r\n    desc: \"Unlocks the XP system and a new Merchant dialogue\\nXP system: Collect Coins for XP to level up and gain Books\\nEach XP Level also boosts Coin value by a decent amount\",\r\n    lvlCap: 1,\r\n    upgType: \"NM\",\r\n    icon: \"stats/xp/xp.png\",\r\n    baseIconOverride: \"img/stats/xp/xp_base.png\",\r\n    unlockUpgrade: true,\r\n    costAtLevel() { return BigNum.fromInt(0); },\r\n    nextCostAfter() { return BigNum.fromInt(0); },\r\n    computeLockState: determineLockState,\r\n    effectSummary() { return \"\"; },\r\n    onLevelChange({ newLevel, newLevelBn }) {\r\n      const reached = Number.isFinite(newLevel)\r\n        ? newLevel >= 1\r\n        : (newLevelBn?.cmp?.(BigNum.fromInt(1)) ?? -1) >= 0;\r\n      if (reached) { try { unlockXpSystem(); } catch {} }\r\n    },\r\n  },\r\n  {\r\n    area: AREA_KEYS.STARTER_COVE,\r\n    id: 3,\r\n    tie: UPGRADE_TIES.FASTER_COINS_II,\r\n    title: \"Faster Coins II\",\r\n    desc: \"Increases Coin spawn rate by +10% per level\",\r\n    lvlCap: 15,\r\n    baseCost: 1,\r\n    costType: \"books\",\r\n    upgType: \"NM\",\r\n    icon: \"sc_upgrade_icons/faster_coins2.png\",\r\n    requiresUnlockXp: true,\r\n    costAtLevel() { return this.baseCostBn?.clone?.() ?? BigNum.fromInt(1); },\r\n    nextCostAfter() { return this.costAtLevel(); },\r\n    effectSummary(level) {\r\n      const mult = this.effectMultiplier(level);\r\n      return `Coin spawn rate bonus: ${formatMultForUi(mult)}x`;\r\n    },\r\n    effectMultiplier: E.addPctPerLevel(0.10),\r\n  },\r\n  {\r\n    area: AREA_KEYS.STARTER_COVE,\r\n    id: 4,\r\n    tie: UPGRADE_TIES.COIN_VALUE_I,\r\n    title: \"Coin Value\",\r\n    desc: \"Increases Coin value by +50% per level\",\r\n    lvlCap: 100,\r\n    baseCost: 1,\r\n    costType: \"books\",\r\n    upgType: \"NM\",\r\n    icon: \"sc_upgrade_icons/coin_val1.png\",\r\n    requiresUnlockXp: true,\r\n    costAtLevel() { return this.baseCostBn?.clone?.() ?? BigNum.fromInt(1); },\r\n    nextCostAfter() { return this.costAtLevel(); },\r\n    effectSummary(level) {\r\n      const mult = this.effectMultiplier(level);\r\n      return `Coin value bonus: ${formatMultForUi(mult)}x`;\r\n    },\r\n    effectMultiplier: E.addPctPerLevel(0.50),\r\n    onLevelChange() { try { refreshCoinMultiplierFromXpLevel(); } catch {} },\r\n  },\r\n  {\r\n    area: AREA_KEYS.STARTER_COVE,\r\n    id: 5,\r\n    tie: UPGRADE_TIES.BOOK_VALUE_I,\r\n    title: \"Book Value\",\r\n    desc: \"Doubles Books gained when increasing XP Level\",\r\n    lvlCap: 1,\r\n    baseCost: 10,\r\n    costType: \"books\",\r\n    upgType: \"NM\",\r\n    icon: \"sc_upgrade_icons/book_val1.png\",\r\n    requiresUnlockXp: true,\r\n    costAtLevel() { return this.baseCostBn?.clone?.() ?? BigNum.fromInt(1); },\r\n    nextCostAfter() { return this.costAtLevel(); },\r\n    effectSummary(level) {\r\n      const mult = bookValueMultiplierBn(level);\r\n      return `Book value bonus: ${formatMultForUi(mult)}x`;\r\n    },\r\n    onLevelChange({ newLevel }) { syncBookCurrencyMultiplierFromUpgrade(newLevel); },\r\n  },\r\n  {\r\n    area: AREA_KEYS.STARTER_COVE,\r\n    id: 6,\r\n    tie: UPGRADE_TIES.XP_VALUE_I,\r\n    title: \"XP Value\",\r\n    desc: \"Increases XP value by +200% per level\",\r\n    lvlCap: 10,\r\n    baseCost: 1000,\r\n    costType: \"coins\",\r\n    upgType: \"NM\",\r\n    icon: \"sc_upgrade_icons/xp_val1.png\",\r\n    requiresUnlockXp: true,\r\n    costAtLevel(level) { return nmCostBN(this, level); },\r\n    nextCostAfter(_, nextLevel) { return nmCostBN(this, nextLevel); },\r\n    effectSummary(level) {\r\n      const mult = this.effectMultiplier(level);\r\n      return `XP value bonus: ${formatMultForUi(mult)}x`;\r\n    },\r\n    effectMultiplier: E.addFlatPerLevel(2),\r\n  },\r\n  {\r\n    area: AREA_KEYS.STARTER_COVE,\r\n    id: 7,\r\n    tie: UPGRADE_TIES.UNLOCK_FORGE,\r\n    title: \"Unlock Forge\",\r\n    desc: \"Unlocks the Reset tab and the Forge reset in the Delve menu\",\r\n    lvlCap: 1,\r\n    upgType: \"NM\",\r\n    icon: \"misc/forge.png\",\r\n    baseIconOverride: \"img/stats/mp/mp_base.png\",\r\n    requiresUnlockXp: true,\r\n    revealRequirement: 'Reach XP Level 31 to reveal this upgrade',\r\n    unlockUpgrade: true,\r\n    costAtLevel() { return BigNum.fromInt(0); },\r\n    nextCostAfter() { return BigNum.fromInt(0); },\r\n    computeLockState: determineLockState,\r\n    onLevelChange({ newLevel }) {\r\n      if ((newLevel ?? 0) >= 1) {\r\n        try { onForgeUpgradeUnlocked(); } catch {}\r\n      }\r\n    },\r\n  },\r\n  {\r\n    area: AREA_KEYS.STARTER_COVE,\r\n    id: 8,\r\n    tie: UPGRADE_TIES.COIN_VALUE_II,\r\n    title: \"Coin Value II\",\r\n    desc: \"Increases Coin value by +100% per level\",\r\n    lvlCap: 100,\r\n    baseCost: 1,\r\n    costType: \"gold\",\r\n    upgType: \"NM\",\r\n    icon: \"sc_upgrade_icons/coin_val2.png\",\r\n    requiresUnlockXp: true,\r\n    costAtLevel(level) { return nmCostBN(this, level); },\r\n    nextCostAfter(_, nextLevel) { return nmCostBN(this, nextLevel); },\r\n    computeLockState: determineLockState,\r\n    effectSummary(level) {\r\n      const mult = this.effectMultiplier(level);\r\n      return `Coin value bonus: ${formatMultForUi(mult)}x`;\r\n    },\r\n    effectMultiplier: E.addPctPerLevel(1),\r\n    onLevelChange() { try { refreshCoinMultiplierFromXpLevel(); } catch {} },\r\n  },\r\n  {\r\n    area: AREA_KEYS.STARTER_COVE,\r\n    id: 9,\r\n    tie: UPGRADE_TIES.XP_VALUE_II,\r\n    title: \"XP Value II\",\r\n    desc: \"Increases XP value by +100% per level\",\r\n    lvlCap: 100,\r\n    baseCost: 3,\r\n    costType: \"gold\",\r\n    upgType: \"NM\",\r\n    icon: \"sc_upgrade_icons/xp_val2.png\",\r\n    requiresUnlockXp: true,\r\n    costAtLevel(level) { return nmCostBN(this, level); },\r\n    nextCostAfter(_, nextLevel) { return nmCostBN(this, nextLevel); },\r\n    computeLockState: determineLockState,\r\n    effectSummary(level) {\r\n      const mult = this.effectMultiplier(level);\r\n      return `XP value bonus: ${formatMultForUi(mult)}x`;\r\n    },\r\n    effectMultiplier: E.addPctPerLevel(1),\r\n  },\r\n  {\r\n    area: AREA_KEYS.STARTER_COVE,\r\n    id: 10,\r\n    tie: UPGRADE_TIES.MP_VALUE_I,\r\n    title: \"MP Value\",\r\n    desc: \"Increases MP value by +100% per level\",\r\n    lvlCap: 100,\r\n    baseCost: 25,\r\n    costType: \"gold\",\r\n    upgType: \"NM\",\r\n    icon: \"sc_upgrade_icons/mp_val1.png\",\r\n    requiresUnlockXp: true,\r\n    costAtLevel(level) { return nmCostBN(this, level); },\r\n    nextCostAfter(_, nextLevel) { return nmCostBN(this, nextLevel); },\r\n    computeLockState: determineLockState,\r\n    effectSummary(level) {\r\n      const mult = this.effectMultiplier(level);\r\n      return `MP value bonus: ${formatMultForUi(mult)}x`;\r\n    },\r\n    effectMultiplier: E.addPctPerLevel(1),\r\n  },\r\n  {\r\n    area: AREA_KEYS.STARTER_COVE,\r\n    id: 11,\r\n    tie: UPGRADE_TIES.MAGNET,\r\n    title: \"Magnet\",\r\n    desc: \"Increases Magnet radius by +1 Unit per level\\nMagnet: Increases the distance from which you can collect Coins\",\r\n    lvlCap: 10,\r\n    baseCost: 100,\r\n    costType: \"gold\",\r\n    upgType: \"NM\",\r\n    icon: \"sc_upgrade_icons/magnet.png\",\r\n    requiresUnlockXp: true,\r\n    scaling: { ratio: 2 },\r\n    costAtLevel(level) { return nmCostBN(this, level); },\r\n    nextCostAfter(_, nextLevel) { return nmCostBN(this, nextLevel); },\r\n    computeLockState: determineLockState,\r\n    effectSummary(level) {\r\n      const units = normalizedUpgradeLevel(level); // zero-based (+0 units at level 0)\r\n      const unitsText = formatMultForUi(units);\r\n      const suffix = (unitsText === '1') ? 'Unit' : 'Units';\r\n      return `Magnet radius: ${unitsText} ${suffix}`;\r\n    },\r\n    effectMultiplier: E.addPctPerLevel(1),\r\n  },\r\n  {\r\n    area: AREA_KEYS.STARTER_COVE,\r\n    id: 12,\r\n    tie: UPGRADE_TIES.ENDLESS_XP,\r\n    title: \"Endless XP\",\r\n    desc: \"The first Milestone-type upgrade\\nMilestones: Reach a certain upgrade level for powerful buffs\\nMultiplies XP value by 1.1x per level\",\r\n    lvlCap: HM_EVOLUTION_INTERVAL,\r\n    baseCost: 1_000_000,\r\n    costType: \"coins\",\r\n    upgType: \"HM\",\r\n    icon: \"sc_upg_icons/xp_val_hm.png\",\r\n    requiresUnlockXp: true,\r\n    scalingPreset: 'HM',\r\n    hmMilestones: [\r\n      { level: 10, multiplier: 1.5, target: 'self' },\r\n      { level: 25, multiplier: 2, target: 'self' },\r\n      { level: 50, multiplier: 5, target: 'mp' },\r\n      { level: 100, multiplier: 10, target: 'xp' },\r\n      { level: 200, multiplier: 15, target: 'coin' },\r\n      { level: 400, multiplier: 25, target: 'self' },\r\n      { level: 800, multiplier: 100, target: 'self' },\r\n    ],\r\n    costAtLevel(level) { return costAtLevelUsingScaling(this, level); },\r\n    nextCostAfter(_, nextLevel) { return costAtLevelUsingScaling(this, nextLevel); },\r\n    computeLockState: determineLockState,\r\n    effectSummary(level) {\r\n      const lvlBn = ensureLevelBigNum(level);\r\n      let baseMult;\r\n      try { baseMult = this.effectMultiplier(lvlBn); }\r\n      catch { baseMult = 1; }\r\n      const { selfMult } = computeHmMultipliers(this, lvlBn, this.area);\r\n      const total = safeMultiplyBigNum(baseMult, selfMult);\r\n      return `XP value bonus: ${formatMultForUi(total)}x`;\r\n    },\r\n    effectMultiplier: E.powPerLevel(1.1),\r\n  },\r\n];\r\n\r\nfor (const upg of REGISTRY) {\r\n  const tieKey = normalizeUpgradeTie(upg.tie ?? upg.tieKey);\r\n  upg.tieKey = tieKey;\r\n  if (tieKey && !upgradeTieLookup.has(tieKey)) {\r\n    upgradeTieLookup.set(tieKey, upg);\r\n  }\r\n  upg.baseCost = toUpgradeBigNum(upg.baseCost ?? 0, 0);\r\n  upg.baseCostBn = upg.baseCost;\r\n  upg.numUpgEvolutions = normalizeHmEvolutionCount(upg.numUpgEvolutions);\r\n  if (upg.upgType === 'HM') {\r\n    applyHmEvolutionMeta(upg, upg.numUpgEvolutions);\r\n  } else {\r\n    upg.lvlCapBn = toUpgradeBigNum(upg.lvlCap ?? Infinity, Infinity);\r\n    upg.lvlCap = levelCapToNumber(upg.lvlCapBn);\r\n    upg.lvlCapFmtHtml = formatBigNumAsHtml(upg.lvlCapBn);\r\n    upg.lvlCapFmtText = formatBigNumAsPlain(upg.lvlCapBn);\r\n  }\r\n\r\n  const isSingleLevelCap = Number.isFinite(upg.lvlCap) && Math.max(0, Math.floor(upg.lvlCap)) === 1;\r\n  const isBookValueUpgrade = tieKey === BOOK_VALUE_TIE_KEY;\r\n  if (isSingleLevelCap && !isBookValueUpgrade) {\r\n    upg.unlockUpgrade = true;\r\n    upg.baseCost = BigNum.fromInt(0);\r\n    upg.baseCostBn = upg.baseCost;\r\n    upg.costAtLevel = () => BigNum.fromInt(0);\r\n    upg.nextCostAfter = () => BigNum.fromInt(0);\r\n  }\r\n\r\n  upg.bulkMeta = computeBulkMeta(upg);\r\n  ensureUpgradeScaling(upg);\r\n}\r\n\r\nconst areaStatePayloadCache = new Map(); // key \u2192 last serialized payload\r\nconst areaStateMemoryCache = new Map(); // key \u2192 last parsed array reference\r\nconst upgradeStateCache = new Map(); // key \u2192 { areaKey, upgId, upg, rec, arr, lvl, nextCostBn }\r\nconst areaUpgradeOrderCache = new Map();\r\n\r\nfunction getAreaUpgradeOrder(areaKey) {\r\n  const normalizedArea = normalizeAreaKey(areaKey);\r\n  if (!normalizedArea) return null;\r\n\r\n  if (areaUpgradeOrderCache.has(normalizedArea)) {\r\n    return areaUpgradeOrderCache.get(normalizedArea);\r\n  }\r\n\r\n  const order = new Map();\r\n  let rank = 0;\r\n  for (const upg of REGISTRY) {\r\n    if (normalizeAreaKey(upg?.area) !== normalizedArea) continue;\r\n    const normalizedId = normalizeUpgradeId(upg?.id);\r\n    if (normalizedId == null || order.has(normalizedId)) continue;\r\n    order.set(normalizedId, rank);\r\n    rank += 1;\r\n  }\r\n\r\n  areaUpgradeOrderCache.set(normalizedArea, order);\r\n  return order;\r\n}\r\n\r\nfunction normalizeAreaStateRecordOrder(areaKey, arr) {\r\n  if (!Array.isArray(arr) || arr.length <= 1) return false;\r\n  const order = getAreaUpgradeOrder(areaKey);\r\n  if (!(order?.size)) return false;\r\n\r\n  const baseRank = order.size;\r\n  const entries = arr.map((rec, idx) => {\r\n    const normalizedId = normalizeUpgradeId(rec?.id);\r\n    const rank = order.has(normalizedId)\r\n      ? order.get(normalizedId)\r\n      : baseRank + idx;\r\n    return { rec, rank, idx };\r\n  });\r\n\r\n  let needsSort = false;\r\n  for (let i = 1; i < entries.length; i += 1) {\r\n    const prev = entries[i - 1];\r\n    const curr = entries[i];\r\n    if (curr.rank < prev.rank || (curr.rank === prev.rank && curr.idx < prev.idx)) {\r\n      needsSort = true;\r\n      break;\r\n    }\r\n  }\r\n\r\n  if (!needsSort) return false;\r\n\r\n  entries.sort((a, b) => (a.rank - b.rank) || (a.idx - b.idx));\r\n  arr.length = 0;\r\n  for (const entry of entries) arr.push(entry.rec);\r\n  return true;\r\n}\r\n\r\nfunction parseUpgradeStateArray(raw) {\r\n  if (typeof raw !== 'string' || !raw) return null;\r\n  try {\r\n    const parsed = JSON.parse(raw);\r\n    return Array.isArray(parsed) ? parsed : null;\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\nfunction readStateFromAvailableStorage(key, options = {}) {\r\n  const {\r\n    includeLocal = true,\r\n  } = options || {};\r\n\r\n  const result = {\r\n    data: null,\r\n    raw: null,\r\n    storageChecked: false,\r\n    storageFound: false,\r\n    checkedLocal: false,\r\n    foundLocal: false,\r\n    sourceType: null,\r\n  };\r\n\r\n  if (!key) return result;\r\n\r\n  const storages = [];\r\n  try {\r\n    if (includeLocal && typeof localStorage !== 'undefined') {\r\n      storages.push({ storage: localStorage, type: 'local' });\r\n      result.storageChecked = true;\r\n      result.checkedLocal = true;\r\n    }\r\n  } catch {}\r\n\r\n  for (const entry of storages) {\r\n    const { storage, type } = entry || {};\r\n    const getItem = storage?.getItem;\r\n    if (typeof getItem !== 'function') continue;\r\n    let raw;\r\n    try { raw = getItem.call(storage, key); }\r\n    catch { raw = null; }\r\n    if (raw != null) {\r\n      result.storageFound = true;\r\n      if (type === 'local') result.foundLocal = true;\r\n    }\r\n    const parsed = parseUpgradeStateArray(raw);\r\n    if (parsed) {\r\n      const payload = typeof raw === 'string' && raw ? raw : (() => {\r\n        try { return JSON.stringify(parsed); } catch { return null; }\r\n      })();\r\n      result.data = parsed;\r\n      result.raw = payload;\r\n      result.sourceType = type;\r\n      return result;\r\n    }\r\n  }\r\n\r\n  return result;\r\n}\r\n\r\nfunction cacheAreaState(key, arr, raw) {\r\n  if (!key) return;\r\n  if (Array.isArray(arr)) {\r\n    areaStateMemoryCache.set(key, arr);\r\n  }\r\n  if (typeof raw === 'string') {\r\n    areaStatePayloadCache.set(key, raw);\r\n  }\r\n}\r\n\r\nfunction clearCachedAreaState(storageKey) {\r\n  if (!storageKey) return;\r\n  areaStateMemoryCache.delete(storageKey);\r\n  areaStatePayloadCache.delete(storageKey);\r\n}\r\n\r\nfunction clearCachedUpgradeStates(areaKey, slot) {\r\n  const slotKey = slot == null ? 'null' : String(slot);\r\n  const prefix = `${slotKey}:${areaKey}:`;\r\n  for (const key of upgradeStateCache.keys()) {\r\n    if (key.startsWith(prefix)) {\r\n      upgradeStateCache.delete(key);\r\n    }\r\n  }\r\n}\r\n\r\nfunction keyForArea(areaKey, slot = getActiveSlot()) {\r\n  if (slot == null) return null;\r\n  return `ccc:upgrades:${areaKey}:${slot}`;\r\n}\r\n\r\nconst upgradeStorageWatcherCleanup = new Map();\r\nlet upgradeStorageWatcherBoundSlot = null;\r\n\r\nfunction cleanupUpgradeStorageWatchers() {\r\n  upgradeStorageWatcherCleanup.forEach((stop) => {\r\n    try { stop?.(); } catch {}\r\n  });\r\n  upgradeStorageWatcherCleanup.clear();\r\n}\r\n\r\nfunction handleUpgradeStorageChange(areaKey, slot, storageKey, rawPayload, meta = {}) {\r\n  if (!storageKey) return;\r\n  const { rawChanged, valueChanged } = meta;\r\n  if (!rawChanged && !valueChanged) return;\r\n\r\n  try {\r\n    if (typeof rawPayload === 'string') {\r\n      const arr = parseUpgradeStateArray(rawPayload);\r\n      if (arr) {\r\n        cacheAreaState(storageKey, arr, rawPayload);\r\n      } else {\r\n        clearCachedAreaState(storageKey);\r\n      }\r\n    } else {\r\n      clearCachedAreaState(storageKey);\r\n    }\r\n  } catch {\r\n    clearCachedAreaState(storageKey);\r\n  }\r\n\r\n  clearCachedUpgradeStates(areaKey, slot);\r\n  notifyChanged();\r\n}\r\n\r\nfunction bindUpgradeStorageWatchersForSlot(slot) {\r\n  if (slot === upgradeStorageWatcherBoundSlot) return;\r\n  cleanupUpgradeStorageWatchers();\r\n  upgradeStorageWatcherBoundSlot = slot ?? null;\r\n  if (slot == null) return;\r\n\r\n  for (const areaKey of Object.values(AREA_KEYS)) {\r\n    const storageKey = keyForArea(areaKey, slot);\r\n    if (!storageKey) continue;\r\n    const stop = watchStorageKey(storageKey, {\r\n      parse: (raw) => (typeof raw === 'string' ? raw : null),\r\n      onChange: (rawPayload, meta) => {\r\n        if (!meta?.rawChanged && !meta?.valueChanged) return;\r\n        handleUpgradeStorageChange(areaKey, slot, storageKey, rawPayload, meta);\r\n      },\r\n    });\r\n    upgradeStorageWatcherCleanup.set(storageKey, stop);\r\n  }\r\n}\r\n\r\nif (typeof window !== 'undefined') {\r\n  bindUpgradeStorageWatchersForSlot(getActiveSlot());\r\n  window.addEventListener('saveSlot:change', () => {\r\n    bindUpgradeStorageWatchersForSlot(getActiveSlot());\r\n  });\r\n}\r\n\r\nfunction loadAreaState(areaKey, slot = getActiveSlot(), options = {}) {\r\n  const { forceReload = false } = options || {};\r\n  const storageKey = keyForArea(areaKey, slot);\r\n  if (!storageKey) return [];\r\n\r\n  const backupKey = `${storageKey}:backup`;\r\n  const primary = readStateFromAvailableStorage(storageKey, {\r\n    includeLocal: true,\r\n  });\r\n  const backup = readStateFromAvailableStorage(backupKey, {\r\n    includeLocal: true,\r\n  });\r\n\r\n  if (primary.storageChecked && !primary.storageFound && backup.data) {\r\n    try {\r\n      if (typeof localStorage !== 'undefined') {\r\n        localStorage.removeItem(backupKey);\r\n      }\r\n    } catch {}\r\n\r\n    clearCachedAreaState(storageKey);\r\n    clearCachedUpgradeStates(areaKey, slot);\r\n    return [];\r\n  }\r\n  \r\n  if (primary.data) {\r\n    const normalized = normalizeAreaStateRecordOrder(areaKey, primary.data);\r\n    if (normalized) {\r\n      saveAreaState(areaKey, primary.data, slot);\r\n    } else {\r\n      cacheAreaState(storageKey, primary.data, primary.raw);\r\n    }\r\n    if (backup.storageFound) {\r\n      try {\r\n        if (typeof localStorage !== 'undefined') {\r\n          localStorage.removeItem(backupKey);\r\n        }\r\n      } catch {}\r\n    }\r\n    return primary.data;\r\n  }\r\n\r\n  if (backup.data) {\r\n    const normalized = normalizeAreaStateRecordOrder(areaKey, backup.data);\r\n    if (normalized) {\r\n      saveAreaState(areaKey, backup.data, slot);\r\n    } else {\r\n      cacheAreaState(storageKey, backup.data, backup.raw);\r\n    }\r\n    try {\r\n      if (typeof localStorage !== 'undefined') {\r\n        const backupPayload = backup.raw ?? JSON.stringify(backup.data);\r\n        localStorage.setItem(storageKey, backupPayload);\r\n        localStorage.removeItem(backupKey);\r\n      }\r\n    } catch {}\r\n    return backup.data;\r\n  }\r\n\r\n  try {\r\n    if (typeof localStorage !== 'undefined') {\r\n      localStorage.removeItem(backupKey);\r\n    }\r\n  } catch {}\r\n\r\n  const storagesChecked = primary.storageChecked || backup.storageChecked;\r\n  const storageHadValue = primary.storageFound || backup.storageFound;\r\n\r\n  if (!forceReload && !storagesChecked) {\r\n    const cached = areaStateMemoryCache.get(storageKey);\r\n    if (Array.isArray(cached)) {\r\n      normalizeAreaStateRecordOrder(areaKey, cached);\r\n      return cached;\r\n    }\r\n\r\n    const cachedPayload = areaStatePayloadCache.get(storageKey);\r\n    const parsed = parseUpgradeStateArray(cachedPayload);\r\n    if (parsed) {\r\n      const normalized = normalizeAreaStateRecordOrder(areaKey, parsed);\r\n      if (normalized) {\r\n        saveAreaState(areaKey, parsed, slot);\r\n      } else {\r\n        cacheAreaState(storageKey, parsed, cachedPayload);\r\n      }\r\n      return parsed;\r\n    }\r\n  }\r\n\r\n  if (!storageHadValue) {\r\n    clearCachedAreaState(storageKey);\r\n    clearCachedUpgradeStates(areaKey, slot);\r\n  }\r\n\r\n  return [];\r\n}\r\n\r\nfunction saveAreaState(areaKey, stateArr, slot = getActiveSlot()) {\r\n  const storageKey = keyForArea(areaKey, slot);\r\n  if (!storageKey) return;\r\n\r\n  const arr = Array.isArray(stateArr) ? stateArr : [];\r\n  normalizeAreaStateRecordOrder(areaKey, arr);\r\n  let payload = null;\r\n  try {\r\n    payload = JSON.stringify(arr);\r\n  } catch {\r\n    try { payload = JSON.stringify([]); }\r\n    catch { payload = '[]'; }\r\n  }\r\n\r\n  cacheAreaState(storageKey, arr, payload);\r\n\r\n  try {\r\n    if (typeof localStorage !== 'undefined') {\r\n      localStorage.setItem(storageKey, payload);\r\n      try { primeStorageWatcherSnapshot(storageKey, payload); } catch {}\r\n    }\r\n  } catch {}\r\n\r\n  try {\r\n    const verify = localStorage.getItem(storageKey);\r\n    if (verify !== payload) {\r\n      localStorage.setItem(storageKey, payload);\r\n      try { primeStorageWatcherSnapshot(storageKey, payload); } catch {}\r\n    }\r\n  } catch {}\r\n\r\n  try {\r\n    if (typeof localStorage !== 'undefined') {\r\n      localStorage.removeItem(`${storageKey}:backup`);\r\n    }\r\n  } catch {}\r\n}\r\n\r\nfunction resolveUpgradeIdentifier(areaKey, upgId) {\r\n  if (upgId && typeof upgId === 'object' && typeof upgId.id !== 'undefined') {\r\n    return normalizeUpgradeId(upgId.id);\r\n  }\r\n  const normalized = normalizeUpgradeId(upgId);\r\n  if (typeof normalized === 'number' || normalized == null) {\r\n    return normalized;\r\n  }\r\n  if (typeof normalized === 'string') {\r\n    const tieKey = normalizeUpgradeTie(normalized);\r\n    if (tieKey) {\r\n      const upg = upgradeTieLookup.get(tieKey);\r\n      if (upg) {\r\n        const requestedArea = normalizeAreaKey(areaKey);\r\n        if (!requestedArea || normalizeAreaKey(upg.area) === requestedArea) {\r\n          return normalizeUpgradeId(upg.id);\r\n        }\r\n      }\r\n    }\r\n  }\r\n  return normalized;\r\n}\r\n\r\nfunction upgradeCacheKey(areaKey, upgId, slot = getActiveSlot()) {\r\n  const slotKey = slot == null ? 'null' : String(slot);\r\n  const resolvedId = resolveUpgradeIdentifier(areaKey, upgId);\r\n  return `${slotKey}:${areaKey}:${normalizeUpgradeId(resolvedId)}`;\r\n}\r\n\r\nfunction ensureUpgradeState(areaKey, upgId) {\r\n  const resolvedId = resolveUpgradeIdentifier(areaKey, upgId);\r\n  const normalizedId = normalizeUpgradeId(resolvedId);\r\n  const slot = getActiveSlot();\r\n  const key = upgradeCacheKey(areaKey, normalizedId, slot);\r\n  let state = upgradeStateCache.get(key);\r\n  if (state) return state;\r\n\r\n  const upg = getUpgrade(areaKey, normalizedId);\r\n  const arr = loadAreaState(areaKey, slot);\r\n  let rec = arr.find(u => u && normalizeUpgradeId(u.id) === normalizedId);\r\n  let recNeedsSave = false;\r\n  if (!rec) {\r\n    rec = { id: normalizedId, lvl: BigNum.fromInt(0).toStorage() };\r\n    if (upg) {\r\n      try {\r\n        rec.nextCost = BigNum.fromAny(upg.costAtLevel(0)).toStorage();\r\n      } catch {\r\n        rec.nextCost = BigNum.fromInt(0).toStorage();\r\n      }\r\n    }\r\n    rec.nextCostLvl = rec.lvl;\r\n    arr.push(rec);\r\n    saveAreaState(areaKey, arr, slot);\r\n  } else if (rec.id !== normalizedId) {\r\n    rec.id = normalizedId;\r\n    recNeedsSave = true;\r\n  }\r\n\r\n  let hmEvolutions = 0;\r\n  if (upg?.upgType === 'HM') {\r\n    hmEvolutions = normalizeHmEvolutionCount(\r\n      rec.hmEvolutions ?? rec.evolutions ?? rec.evol ?? upg.numUpgEvolutions\r\n    );\r\n    applyHmEvolutionMeta(upg, hmEvolutions);\r\n  }\r\n\r\n  const lvlBn = ensureLevelBigNum(rec.lvl);\r\n  let lvl = levelBigNumToNumber(lvlBn);\r\ntry {\r\n  const capBn = upg?.lvlCapBn ?? BigNum.fromAny('Infinity');\r\n  if (!(capBn.isInfinite?.()) && lvlBn.cmp(capBn) > 0) {\r\n    const clamped = capBn.clone?.() ?? capBn;\r\n    lvl = levelBigNumToNumber(clamped);\r\n    const clampedStorage = clamped.toStorage();\r\n    rec.lvl = clampedStorage;\r\n    rec.nextCost = BigNum.fromInt(0).toStorage();\r\n    rec.nextCostLvl = clampedStorage;\r\n    saveAreaState(areaKey, arr, slot);\r\n  }\r\n} catch {}\r\n\r\n  let normalizedLvlStorage = null;\r\n  try {\r\n    normalizedLvlStorage = lvlBn?.toStorage?.() ?? ensureLevelBigNum(lvl).toStorage();\r\n  } catch {}\r\n  if (normalizedLvlStorage && rec.lvl !== normalizedLvlStorage) {\r\n    rec.lvl = normalizedLvlStorage;\r\n    recNeedsSave = true;\r\n  }\r\n\r\n  const costLevelStorage = typeof rec.nextCostLvl === 'string' ? rec.nextCostLvl : null;\r\n  let nextCostStale = !costLevelStorage || costLevelStorage !== normalizedLvlStorage;\r\n\r\n  let nextCostBn = null;\r\n  if (!nextCostStale && rec.nextCost != null) {\r\n    try {\r\n      nextCostBn = BigNum.fromAny(rec.nextCost);\r\n    } catch {\r\n      nextCostBn = null;\r\n      nextCostStale = true;\r\n    }\r\n  }\r\n\r\n  if (!nextCostBn || nextCostStale) {\r\n    if (upg) {\r\n      try {\r\n        nextCostBn = BigNum.fromAny(upg.costAtLevel(lvl));\r\n      } catch {\r\n        nextCostBn = BigNum.fromInt(0);\r\n      }\r\n    } else {\r\n      nextCostBn = BigNum.fromInt(0);\r\n    }\r\n    try {\r\n      rec.nextCost = nextCostBn.toStorage();\r\n      if (normalizedLvlStorage) {\r\n        rec.nextCostLvl = normalizedLvlStorage;\r\n      } else {\r\n        delete rec.nextCostLvl;\r\n      }\r\n      recNeedsSave = true;\r\n    } catch {}\r\n  }\r\n\r\n  if (recNeedsSave) {\r\n    try { saveAreaState(areaKey, arr, slot); }\r\n    catch {}\r\n  }\r\n\r\n  if (upg?.upgType === 'HM' && lvlBn?.isInfinite?.()) {\r\n    if (!upg.lvlCapBn?.isInfinite?.()) {\r\n      const infCap = BigNum.fromAny('Infinity');\r\n      upg.lvlCapBn = infCap;\r\n      upg.lvlCap = Number.POSITIVE_INFINITY;\r\n      upg.lvlCapFmtHtml = formatBigNumAsHtml(infCap);\r\n      upg.lvlCapFmtText = formatBigNumAsPlain(infCap);\r\n    }\r\n  }\r\n\r\n  state = { areaKey, upgId: normalizedId, upg, rec, arr, lvl, lvlBn, nextCostBn, slot, hmEvolutions };\r\n  upgradeStateCache.set(key, state);\r\n  return state;\r\n}\r\n\r\nfunction commitUpgradeState(state) {\r\n  if (!state) return;\r\n  const { areaKey } = state;\r\n  const slot = state.slot ?? getActiveSlot();\r\n  if (!areaKey || slot == null) return;\r\n\r\n  const normalizedId = normalizeUpgradeId(state.upgId ?? state.rec?.id);\r\n  let arr = loadAreaState(areaKey, slot, { forceReload: true });\r\n  if (!Array.isArray(arr)) arr = [];\r\n\r\n  let rec = arr.find(u => u && normalizeUpgradeId(u.id) === normalizedId);\r\n  if (!rec) {\r\n    rec = { id: normalizedId };\r\n    arr.push(rec);\r\n  } else if (rec.id !== normalizedId) {\r\n    rec.id = normalizedId;\r\n  }\r\n\r\ntry {\r\n  const capBn = state.upg?.lvlCapBn ?? BigNum.fromAny('Infinity');\r\n  let inBn = state.lvlBn?.clone?.() ?? ensureLevelBigNum(state.lvlBn ?? state.lvl);\r\n  if (!(capBn.isInfinite?.()) && inBn.cmp(capBn) > 0) {\r\n    inBn = capBn.clone?.() ?? capBn;\r\n    state.lvlBn = inBn;\r\n    state.lvl = levelBigNumToNumber(inBn);\r\n  }\r\n} catch {}\r\n\r\n  try {\r\n    rec.lvl = state.lvlBn?.toStorage?.() ?? ensureLevelBigNum(state.lvlBn ?? state.lvl).toStorage();\r\n  } catch {\r\n    rec.lvl = ensureLevelBigNum(state.lvl ?? 0).toStorage();\r\n  }\r\n  const currentLvlStorage = rec.lvl;\r\n\r\n  if (state.nextCostBn != null) {\r\n    try {\r\n      rec.nextCost = BigNum.fromAny(state.nextCostBn).toStorage();\r\n    } catch {\r\n      try { rec.nextCost = BigNum.fromAny(state.nextCostBn ?? 0).toStorage(); }\r\n      catch { rec.nextCost = BigNum.fromInt(0).toStorage(); }\r\n    }\r\n    rec.nextCostLvl = currentLvlStorage;\r\n  } else {\r\n    delete rec.nextCostLvl;\r\n  }\r\n\r\n  if (state.hmEvolutions != null) {\r\n    rec.hmEvolutions = normalizeHmEvolutionCount(state.hmEvolutions);\r\n  }\r\n\r\n  saveAreaState(areaKey, arr, slot);\r\n  state.rec = rec;\r\n  state.arr = arr;\r\n  state.slot = slot;\r\n}\r\n\r\nfunction invalidateUpgradeState(areaKey, upgId, slot = getActiveSlot()) {\r\n  upgradeStateCache.delete(upgradeCacheKey(areaKey, upgId, slot));\r\n}\r\n\r\nexport function getLevelNumber(areaKey, upgId) {\r\n  return ensureUpgradeState(areaKey, upgId).lvl;\r\n}\r\n\r\nexport function getHmEvolutions(areaKey, upgId) {\r\n  return ensureUpgradeState(areaKey, upgId).hmEvolutions ?? 0;\r\n}\r\n\r\nexport function getMpValueMultiplierBn() {\r\n  let mult = hundredPercentPerLevelMultiplier(\r\n    getLevelNumber(AREA_KEYS.STARTER_COVE, UPGRADE_TIES.MP_VALUE_I)\r\n  );\r\n  try {\r\n    const hmUpg = getUpgrade(AREA_KEYS.STARTER_COVE, UPGRADE_TIES.ENDLESS_XP);\r\n    const hmLvl = getLevel(AREA_KEYS.STARTER_COVE, UPGRADE_TIES.ENDLESS_XP);\r\n    const { mpMult } = computeHmMultipliers(hmUpg, hmLvl, AREA_KEYS.STARTER_COVE);\r\n    mult = safeMultiplyBigNum(mult, mpMult);\r\n  } catch {}\r\n  return mult;\r\n}\r\n\r\nexport function getMagnetLevel() {\r\n  const lvl = getLevelNumber(AREA_KEYS.STARTER_COVE, UPGRADE_TIES.MAGNET);\r\n  if (!Number.isFinite(lvl)) {\r\n    return 0;\r\n  }\r\n  return Math.max(0, Math.floor(lvl));\r\n}\r\n\r\nfunction computeUpgradeLockStateFor(areaKey, upg) {\r\n  if (!upg) return { locked: false };\r\n\r\n  const xpUnlocked = safeIsXpUnlocked();\r\n  const xpLevelBn = xpUnlocked ? currentXpLevelBigNum() : BigNum.fromInt(0);\r\n  const xpLevel = xpUnlocked ? levelBigNumToNumber(xpLevelBn) : 0;\r\n\r\n  let baseState = { locked: false };\r\nif (upg.requiresUnlockXp && !xpUnlocked) {\r\n  const isXpAdj = isXpAdjacentUpgrade(areaKey, upg);\r\n  const xpRevealText = 'Unlock the XP system to reveal this upgrade';\r\n  const unlockXpVisible = safeHasMetMerchant();\r\n\r\n  if (isXpAdj) {\r\n    if (!unlockXpVisible) {\r\n      const meetText = 'Meet the Merchant to reveal \"Unlock XP\"';\r\n      baseState = {\r\n        locked: true,\r\n        iconOverride: LOCKED_UPGRADE_ICON_DATA_URL,\r\n        titleOverride: LOCKED_UPGRADE_TITLE,\r\n        descOverride: meetText,\r\n        reason: meetText,\r\n        hidden: false,\r\n        hideCost: false,\r\n        hideEffect: false,\r\n        useLockedBase: true,\r\n      };\r\n    } else {\r\n      baseState = {\r\n        locked: true,\r\n        iconOverride: MYSTERIOUS_UPGRADE_ICON_DATA_URL,\r\n        titleOverride: HIDDEN_UPGRADE_TITLE,\r\n        descOverride: xpRevealText,\r\n        reason: xpRevealText,\r\n        hidden: true,\r\n        hideCost: true,\r\n        hideEffect: true,\r\n        useLockedBase: true,\r\n      };\r\n    }\r\n  } else {\r\n    baseState = {\r\n      locked: true,\r\n      iconOverride: LOCKED_UPGRADE_ICON_DATA_URL,\r\n      titleOverride: LOCKED_UPGRADE_TITLE,\r\n      descOverride: xpRevealText,\r\n      reason: 'Purchase \"Unlock XP\" to reveal this upgrade',\r\n      hidden: false,\r\n      hideCost: false,\r\n      hideEffect: false,\r\n      useLockedBase: true,\r\n    };\r\n  }\r\n}\r\n\r\n  let state = mergeLockStates({ locked: false }, baseState);\r\n  if (typeof upg.computeLockState === 'function') {\r\n    try {\r\n      const ctx = {\r\n        areaKey,\r\n        upg,\r\n        xpUnlocked,\r\n        xpLevelBn,\r\n        xpLevel,\r\n        baseLocked: state.locked,\r\n        getUpgradeLevel(targetId) { return getLevelNumber(areaKey, targetId); },\r\n      };\r\n      const custom = upg.computeLockState(ctx);\r\n      state = mergeLockStates(state, custom);\r\n    } catch {}\r\n  }\r\n\r\n  const slot = getActiveSlot();\r\n  const revealKey = upgradeRevealKey(areaKey, upg);\r\n  const permaUnlocked = revealKey ? isUpgradePermanentlyUnlocked(areaKey, upg, slot) : false;\r\n  if (revealKey) {\r\n    const revealState = ensureShopRevealState(slot);\r\n    const permaState  = ensureShopPermaUnlockState(slot);\r\n    const permaMystState = ensureShopPermaMystState(slot);\r\n    const hyphenKey   = revealKey.replace(/_/g, '-');\r\n    const legacyKey   = upgradeLegacyRevealKey(areaKey, upg);\r\n\r\n    let needsRevealSave = false;\r\n    if (migrateUpgradeStateKey(revealState, hyphenKey, revealKey)) {\r\n      needsRevealSave = true;\r\n    }\r\n    if (legacyKey && migrateUpgradeStateKey(revealState, legacyKey, revealKey)) {\r\n      needsRevealSave = true;\r\n    }\r\n    if (needsRevealSave) {\r\n      saveShopRevealState(revealState, slot);\r\n    }\r\n\r\n    let needsPermaSave = false;\r\n    if (migrateUpgradeStateKey(permaState, hyphenKey, revealKey)) {\r\n      needsPermaSave = true;\r\n    }\r\n    if (legacyKey && migrateUpgradeStateKey(permaState, legacyKey, revealKey)) {\r\n      needsPermaSave = true;\r\n    }\r\n    if (needsPermaSave) {\r\n      saveShopPermaUnlockState(permaState, slot);\r\n    }\r\n\r\n    let needsPermaMystSave = false;\r\n    if (migrateUpgradeStateKey(permaMystState, hyphenKey, revealKey)) {\r\n      needsPermaMystSave = true;\r\n    }\r\n    if (legacyKey && migrateUpgradeStateKey(permaMystState, legacyKey, revealKey)) {\r\n      needsPermaMystSave = true;\r\n    }\r\n    if (needsPermaMystSave) {\r\n      saveShopPermaMystState(permaMystState, slot);\r\n    }\r\n  }\r\n\r\n  if (state.locked) {\r\n    const hiddenState = !!state.hidden;\r\n    if (!state.iconOverride) state.iconOverride = LOCKED_UPGRADE_ICON_DATA_URL;\r\n\r\n    if (hiddenState) {\r\n      if (!state.titleOverride) state.titleOverride = HIDDEN_UPGRADE_TITLE;\r\n    } else if (!state.titleOverride || state.titleOverride === HIDDEN_UPGRADE_TITLE) {\r\n      state.titleOverride = LOCKED_UPGRADE_TITLE;\r\n    }\r\n\r\n    if (state.useLockedBase == null) state.useLockedBase = true;\r\n    if (!state.reason && upg?.revealRequirement) state.reason = upg.revealRequirement;\r\n\r\n    if (!state.descOverride) {\r\n      if (state.reason) {\r\n        state.descOverride = `${state.reason}`;\r\n      } else if (upg?.revealRequirement) {\r\n        state.descOverride = upg.revealRequirement;\r\n      } else if (hiddenState) {\r\n        state.descOverride = 'This upgrade is currently hidden.';\r\n      }\r\n    }\r\n  } else {\r\n    state.hidden = false;\r\n    state.hideCost = false;\r\n    state.hideEffect = false;\r\n    state.useLockedBase = false;\r\n    if (state.iconOverride === LOCKED_UPGRADE_ICON_DATA_URL ||\r\n        state.iconOverride === MYSTERIOUS_UPGRADE_ICON_DATA_URL) {\r\n      delete state.iconOverride;\r\n    }\r\n    if (state.titleOverride === HIDDEN_UPGRADE_TITLE ||\r\n        state.titleOverride === LOCKED_UPGRADE_TITLE) {\r\n      delete state.titleOverride;\r\n    }\r\n    delete state.descOverride;\r\n    delete state.reason;\r\n  }\r\n\r\n  if (state.locked && upg.requiresUnlockXp && !xpUnlocked && !state.iconOverride) {\r\n    state.iconOverride = LOCKED_UPGRADE_ICON_DATA_URL;\r\n  }\r\n\r\n  if (revealKey) {\r\n    const revealState = ensureShopRevealState(slot);\r\n    const rec = revealState.upgrades[revealKey] || {};\r\n    const tieKey = normalizeUpgradeTie(upg?.tie ?? upg?.tieKey);\r\n    const isForgePlaceholder = tieKey && FORGE_PLACEHOLDER_TIES.has(tieKey);\r\n\r\n    let storedStatus = rec.status || 'locked';\r\n\r\n    if (isUpgradePermanentlyUnlocked(areaKey, upg, slot)) {\r\n      storedStatus = 'unlocked';\r\n    } else if (\r\n      isUpgradePermanentlyMysterious(areaKey, upg, slot) &&\r\n      storedStatus === 'locked'\r\n    ) {\r\n      let xpReached31 = false;\r\n      try { xpReached31 = levelBigNumToNumber(currentXpLevelBigNum()) >= 31; } catch {}\r\n\r\n      storedStatus = (isForgePlaceholder && !xpReached31) ? 'locked' : 'mysterious';\r\n    }\r\n\r\n    let storedRank = shopStatusRank(storedStatus);\r\n\r\n    let currentStatus = classifyUpgradeStatus(state);\r\n    let currentRank = shopStatusRank(currentStatus);\r\n\r\n    const applyStoredMysterious = () => {\r\n      state.locked = true;\r\n\r\n      const snap = rec.snapshot;\r\n      if (snap && typeof snap === 'object') {\r\n        state = mergeLockStates(state, snap);\r\n      }\r\n\r\n      state.iconOverride  = MYSTERIOUS_UPGRADE_ICON_DATA_URL;\r\n      state.titleOverride = HIDDEN_UPGRADE_TITLE;\r\n\r\n      const reasonText =\r\n        upg?.revealRequirement ||\r\n        state.reason ||\r\n        state.descOverride ||\r\n        'This upgrade is currently hidden.';\r\n      state.descOverride = reasonText;\r\n      if (!state.reason && upg?.revealRequirement) state.reason = upg.revealRequirement;\r\n\r\n      state.hidden      = true;\r\n      state.hideCost    = true;\r\n      state.hideEffect  = true;\r\n      state.useLockedBase = true;\r\n    };\r\n\r\n    if (storedRank > currentRank) {\r\n      if (storedStatus === 'unlocked') {\r\n        state.locked = false;\r\n        state.hidden = false;\r\n        state.hideCost = false;\r\n        state.hideEffect = false;\r\n        state.useLockedBase = false;\r\n      } else if (storedStatus === 'mysterious') {\r\n        applyStoredMysterious();\r\n      }\r\n      currentStatus = classifyUpgradeStatus(state);\r\n      currentRank = shopStatusRank(currentStatus);\r\n    }\r\n\r\n    let shouldSave = false;\r\n    let normalizedStatus = (rec && typeof rec === 'object' && typeof rec.status === 'string')\r\n      ? rec.status\r\n      : 'locked';\r\n\r\n    const isForgePlaceholderForSave = isForgePlaceholder;\r\n\r\n    let xpReached31Now = false;\r\n    try { xpReached31Now = levelBigNumToNumber(currentXpLevelBigNum()) >= 31; } catch {}\r\n\r\n    if (isForgePlaceholderForSave && !xpReached31Now && normalizedStatus === 'mysterious') {\r\n      normalizedStatus = 'locked';\r\n    }\r\n\r\n    if (!rec || typeof rec !== 'object' || Object.keys(rec).length !== 1 || rec.status !== normalizedStatus) {\r\n      revealState.upgrades[revealKey] = { status: normalizedStatus };\r\n      shouldSave = true;\r\n    }\r\n\r\n    if (currentRank > storedRank) {\r\n      rec.status = currentStatus;\r\n      revealState.upgrades[revealKey] = { status: rec.status };\r\n      shouldSave = true;\r\n\r\n      storedStatus = currentStatus;\r\n      storedRank   = currentRank;\r\n\r\n      if (currentStatus === 'unlocked') {\r\n        markUpgradePermanentlyUnlocked(areaKey, upg, slot);\r\n      } else if (currentStatus === 'mysterious') {\r\n        let xpReached31 = false;\r\n        try { xpReached31 = levelBigNumToNumber(currentXpLevelBigNum()) >= 31; } catch {}\r\n\r\n        if (!isForgePlaceholder || xpReached31) {\r\n          markUpgradePermanentlyMysterious(areaKey, upg, slot);\r\n        }\r\n      }\r\n    }\r\n\r\n    if (storedStatus === 'unlocked') {\r\n      state.locked = false;\r\n      state.hidden = false;\r\n      state.hideCost = false;\r\n      state.hideEffect = false;\r\n      state.useLockedBase = false;\r\n\r\n      if (state.iconOverride === LOCKED_UPGRADE_ICON_DATA_URL ||\r\n          state.iconOverride === MYSTERIOUS_UPGRADE_ICON_DATA_URL) {\r\n        delete state.iconOverride;\r\n      }\r\n      if (state.titleOverride === HIDDEN_UPGRADE_TITLE ||\r\n          state.titleOverride === LOCKED_UPGRADE_TITLE) {\r\n        delete state.titleOverride;\r\n      }\r\n      delete state.descOverride;\r\n      delete state.reason;\r\n\r\n      if (rec.status !== 'unlocked') {\r\n        revealState.upgrades[revealKey] = { status: 'unlocked' };\r\n        shouldSave = true;\r\n      }\r\n      markUpgradePermanentlyUnlocked(areaKey, upg, slot);\r\n\r\n    } else if (storedStatus === 'mysterious' && currentStatus !== 'mysterious') {\r\n      applyStoredMysterious();\r\n      currentStatus = classifyUpgradeStatus(state);\r\n      currentRank = shopStatusRank(currentStatus);\r\n    }\r\n\r\n    if (shouldSave) saveShopRevealState(revealState, slot);\r\n  }\r\n  \r\n  return state;\r\n}\r\n\r\nfunction isUpgradeLocked(areaKey, upg) {\r\n  return !!computeUpgradeLockStateFor(areaKey, upg).locked;\r\n}\r\n\r\nfunction isHmReadyToEvolve(upg, lvlBn, evolutions = null) {\r\n  if (!upg || upg.upgType !== 'HM') return false;\r\n\r\n  // Once an HM upgrade reaches BN Infinity, treat it as permanently maxed\r\n  // and suppress further evolutions so the UI can show the maxed frame.\r\n  if (lvlBn?.isInfinite?.()) return false;\r\n  const safeEvol = Number.isFinite(evolutions)\r\n    ? evolutions\r\n    : activeEvolutionsForUpgrade(upg);\r\n  const { capBn, cap } = hmLevelCapForEvolutions(safeEvol);\r\n  try { return lvlBn?.cmp?.(capBn) >= 0; }\r\n  catch {}\r\n  const lvlNum = levelBigNumToNumber(lvlBn);\r\n  return Number.isFinite(lvlNum) && lvlNum >= cap;\r\n}\r\n\r\nexport function getLevel(areaKey, upgId) {\r\n  const state = ensureUpgradeState(areaKey, upgId);\r\n  if (state.lvlBn?.clone) return state.lvlBn.clone();\r\n  return ensureLevelBigNum(state.lvl ?? 0);\r\n}\r\n\r\nexport function peekNextPrice(areaKey, upgId) {\r\n  const state = ensureUpgradeState(areaKey, upgId);\r\n  const upg = state.upg;\r\n  if (!upg) return BigNum.fromInt(0);\r\n\r\n  if (state.nextCostBn && !state.nextCostBn.isZero?.()) {\r\n    return state.nextCostBn.clone?.() ?? BigNum.fromAny(state.nextCostBn);\r\n  }\r\n\r\n  const lvlBn  = state.lvlBn ?? ensureLevelBigNum(state.lvl ?? 0);\r\n  const nextBn = lvlBn.add(BigNum.fromInt(1));\r\n  const nextNum = levelBigNumToNumber(nextBn);\r\n  try {\r\n    return BigNum.fromAny(upg.costAtLevel(nextNum));\r\n  } catch {\r\n    return BigNum.fromInt(0);\r\n  }\r\n}\r\n\r\n\r\nexport function setLevel(areaKey, upgId, lvl, clampToCap = true, options = {}) {\r\n  const state = ensureUpgradeState(areaKey, upgId);\r\n  const upg = state.upg;\r\n  const { resetHmEvolutions = false } = options ?? {};\r\n\r\n  if (resetHmEvolutions && upg?.upgType === 'HM') {\r\n    state.hmEvolutions = 0;\r\n    applyHmEvolutionMeta(upg, 0);\r\n  }\r\n  const cap = upg?.lvlCap ?? Infinity;\r\n  const prevLevelNum = state.lvl;\r\n  const prevLevelBn = safeCloneBigNum(state.lvlBn ?? ensureLevelBigNum(state.lvl ?? 0));\r\n  let desiredBn = ensureLevelBigNum(lvl);\r\n  if (desiredBn.isInfinite?.()) {\r\n    desiredBn = BigNum.fromAny('Infinity');\r\n  }\r\n   let nextBn = desiredBn;\r\n  try {\r\n    if (upg && isInfinityLevelForScaled(upg, nextBn)) {\r\n      nextBn = BigNum.fromAny('Infinity');\r\n    }\r\n  } catch {}\r\n  if (clampToCap && Number.isFinite(cap)) {\r\n    const capBn = ensureLevelBigNum(cap);\r\n    if (nextBn.cmp(capBn) > 0) nextBn = capBn;\r\n  }\r\n  if (clampToCap && Number.isFinite(cap)) {\r\n    const capBn = ensureLevelBigNum(cap);\r\n    if (nextBn.cmp(capBn) > 0) nextBn = capBn;\r\n  }\r\n\r\n  if (state.lvlBn?.cmp && state.lvlBn.cmp(nextBn) === 0) return state.lvl;\r\n  const nextNum = levelBigNumToNumber(nextBn);\r\n\r\n  if (!upg) {\r\n    state.lvl = nextNum;\r\n    state.lvlBn = nextBn;\r\n    state.nextCostBn = BigNum.fromInt(0);\r\n    commitUpgradeState(state);\r\n    invalidateUpgradeState(areaKey, upgId);\r\n    notifyChanged();\r\n    return state.lvl;\r\n  }\r\n\r\n  state.lvl = nextNum;\r\n  state.lvlBn = nextBn;\r\n  try {\r\n    state.nextCostBn = BigNum.fromAny(upg.costAtLevel(nextNum));\r\n  } catch {\r\n    state.nextCostBn = BigNum.fromInt(0);\r\n  }\r\n\r\n  commitUpgradeState(state);\r\n  invalidateUpgradeState(areaKey, upgId);\r\n  emitUpgradeLevelChange(upg, prevLevelNum, prevLevelBn, state.lvl, state.lvlBn);\r\n  notifyChanged();\r\n  return state.lvl;\r\n}\r\n\r\n/* ---------------------------- Registry helpers ---------------------------- */\r\n\r\nexport function getUpgradesForArea(areaKey) {\r\n  return REGISTRY.filter(u => u.area === areaKey);\r\n}\r\n\r\nexport function getUpgrade(areaKey, upgId) {\r\n  const normalizedArea = normalizeAreaKey(areaKey);\r\n  const normalizedId = normalizeUpgradeId(upgId);\r\n  const tieKey = (typeof normalizedId === 'string')\r\n    ? normalizeUpgradeTie(normalizedId)\r\n    : normalizeUpgradeTie(upgId);\r\n  return REGISTRY.find((u) => {\r\n    if (normalizedArea && normalizeAreaKey(u.area) !== normalizedArea) return false;\r\n    if (normalizeUpgradeId(u.id) === normalizedId) return true;\r\n    if (tieKey && u.tieKey === tieKey) return true;\r\n    return false;\r\n  }) || null;\r\n}\r\n\r\nexport function getUpgradeLockState(areaKey, upgId) {\r\n  const upg = typeof upgId === 'object' && upgId ? upgId : getUpgrade(areaKey, upgId);\r\n  return computeUpgradeLockStateFor(areaKey, upg);\r\n}\r\n\r\nfunction normalizeUpgradeIconPath(iconPath) {\r\n  const raw = String(iconPath ?? '').trim();\r\n  if (!raw) return '';\r\n\r\n  if (/^(?:https?:|data:|blob:)/i.test(raw)) return raw;\r\n  if (raw.startsWith('//')) return raw;\r\n\r\n  const replaceSlashes = (value) => value.replace(/\\\\+/g, '/');\r\n  let path = replaceSlashes(raw);\r\n\r\n  if (path.startsWith('/')) {\r\n    return path.replace(/\\/{2,}/g, '/');\r\n  }\r\n\r\n  path = path.replace(/^\\.\\/+/u, '');\r\n  while (path.startsWith('../')) {\r\n    path = path.slice(3);\r\n  }\r\n\r\n  const segments = path\r\n    .split('/')\r\n    .map(seg => seg.trim())\r\n    .filter(seg => seg && seg !== '.');\r\n\r\n  if (!segments.length) return '';\r\n\r\n  const normalized = [];\r\n  for (const segment of segments) {\r\n    if (segment === '..') {\r\n      normalized.pop();\r\n      continue;\r\n    }\r\n    normalized.push(segment);\r\n  }\r\n\r\n  if (!normalized.length) return '';\r\n\r\n  const SHARED_ROOTS = new Set(['stats', 'currencies', 'misc']);\r\n\r\n  for (let i = 0; i < normalized.length; i += 1) {\r\n    const lower = normalized[i].toLowerCase();\r\n    if (lower === 'img') {\r\n      normalized.splice(i, 1);\r\n      i -= 1;\r\n      continue;\r\n    }\r\n\r\n    if (lower === 'sc_upgrade_icons' || lower === 'sc_upg_icons') {\r\n      normalized[i] = 'sc_upg_icons';\r\n      while (normalized[i + 1] && /^(?:sc_upgrade_icons|sc_upg_icons)$/i.test(normalized[i + 1])) {\r\n        normalized.splice(i + 1, 1);\r\n      }\r\n    }\r\n  }\r\n\r\n  if (!normalized.length) return '';\r\n\r\n  if (\r\n    normalized.length > 1\r\n    && normalized[0].toLowerCase() === 'sc_upg_icons'\r\n    && SHARED_ROOTS.has(normalized[1].toLowerCase())\r\n  ) {\r\n    normalized.shift();\r\n  }\r\n\r\n  if (normalized.length === 1) {\r\n    normalized.unshift('sc_upg_icons');\r\n  }\r\n\r\n  const result = normalized.join('/');\r\n  if (!result) return '';\r\n\r\n  return `img/${result}`;\r\n}\r\n\r\nexport function getIconUrl(upg) {\r\n  if (!upg) return '';\r\n  return normalizeUpgradeIconPath(upg.icon);\r\n}\r\n\r\n/* ------------------------------ Cost helpers ------------------------------ */\r\n\r\nfunction sumNextNLevelsCost(upg, currentLevel, n) {\r\n  let total = 0;\r\n  for (let i = 0; i < n; i++) {\r\n    total += upg.costAtLevel(currentLevel + i);\r\n  }\r\n  return total;\r\n}\r\n\r\nexport function costToBuyOne(areaKey, upgId) {\r\n  const upg = getUpgrade(areaKey, upgId);\r\n  const lvlBn = getLevel(areaKey, upgId);\r\n  const lvl = levelBigNumToNumber(lvlBn);\r\n  if (!upg) return 0;\r\n  if (lvl >= upg.lvlCap) return 0;\r\n  return upg.costAtLevel(lvl);\r\n}\r\n\r\nexport function buyOne(areaKey, upgId) {\r\n  const state = ensureUpgradeState(areaKey, upgId);\r\n  const upg = state.upg;\r\n  if (!upg) return { bought: 0, spent: 0 };\r\n\r\n  if (isUpgradeLocked(areaKey, upg)) {\r\n    return { bought: 0, spent: 0 };\r\n  }\r\n\r\n  const lvlNum = state.lvl;\r\n  const lvlBn = state.lvlBn ?? ensureLevelBigNum(lvlNum);\r\n  const prevLevelBn = safeCloneBigNum(lvlBn);\r\n\r\n  if (lvlNum >= upg.lvlCap) return { bought: 0, spent: 0 };\r\n\r\n  if (isInfinityLevelForScaled(upg, lvlBn)) {\r\n    state.lvlBn = BigNum.fromAny('Infinity');\r\n    state.lvl = levelBigNumToNumber(state.lvlBn);\r\n    state.nextCostBn = BigNum.fromAny('Infinity');\r\n    commitUpgradeState(state);\r\n    invalidateUpgradeState(areaKey, upgId);\r\n    notifyChanged();\r\n    return { bought: 0, spent: 0 };\r\n  }\r\n\r\n  const rawPrice = state.nextCostBn ?? BigNum.fromAny(upg.costAtLevel(lvlNum));\r\n  const priceBn = rawPrice instanceof BigNum\r\n    ? rawPrice\r\n    : BigNum.fromAny(rawPrice ?? 0);\r\n\r\n  const costType = upg.costType;\r\n  const walletEntry = costType ? bank[costType] : null;\r\n\r\n  let spent = BigNum.fromInt(0);\r\n\r\n  if (walletEntry && !priceBn.isZero?.()) {\r\n    const haveRaw = walletEntry.value;\r\n    const have = haveRaw instanceof BigNum\r\n      ? haveRaw\r\n      : BigNum.fromAny(haveRaw ?? 0);\r\n\r\n    if (have.cmp(priceBn) < 0) {\r\n      return { bought: 0, spent: 0 };\r\n    }\r\n\r\n    spent = priceBn.clone?.() ?? BigNum.fromAny(priceBn);\r\n    walletEntry.sub(spent);\r\n  } else {\r\n    if (!priceBn.isZero?.()) {\r\n      return { bought: 0, spent: 0 };\r\n    }\r\n    spent = BigNum.fromInt(0);\r\n  }\r\n\r\n  const nextLevelBn = lvlBn.add(BigNum.fromInt(1));\r\n  state.lvlBn = nextLevelBn;\r\n  state.lvl = levelBigNumToNumber(nextLevelBn);\r\n  state.nextCostBn = BigNum.fromAny(\r\n    typeof upg.nextCostAfter === 'function'\r\n      ? upg.nextCostAfter(spent, state.lvl)\r\n      : upg.costAtLevel(state.lvl)\r\n  );\r\n\r\n  commitUpgradeState(state);\r\n  invalidateUpgradeState(areaKey, upgId);\r\n  emitUpgradeLevelChange(upg, lvlNum, prevLevelBn, state.lvl, state.lvlBn);\r\n  notifyChanged();\r\n\r\n  return { bought: 1, spent };\r\n}\r\n\r\nexport function evolveUpgrade(areaKey, upgId) {\r\n  const state = ensureUpgradeState(areaKey, upgId);\r\n  const upg = state.upg;\r\n  if (!upg || upg.upgType !== 'HM') return { evolved: false };\r\n\r\n  const lvlBn = state.lvlBn ?? ensureLevelBigNum(state.lvl);\r\n  if (!isHmReadyToEvolve(upg, lvlBn, state.hmEvolutions)) {\r\n    return { evolved: false };\r\n  }\r\n\r\n  const nextEvol = normalizeHmEvolutionCount(state.hmEvolutions) + 1;\r\n  state.hmEvolutions = nextEvol;\r\n  applyHmEvolutionMeta(upg, nextEvol);\r\n\r\n  try { state.nextCostBn = BigNum.fromAny(upg.costAtLevel(state.lvl)); }\r\n  catch { state.nextCostBn = BigNum.fromAny('Infinity'); }\r\n\r\n  commitUpgradeState(state);\r\n  invalidateUpgradeState(areaKey, upgId);\r\n  emitUpgradeLevelChange(upg, state.lvl, lvlBn, state.lvl, lvlBn);\r\n  notifyChanged();\r\n\r\n  return { evolved: true };\r\n}\r\n\r\nexport function buyMax(areaKey, upgId) {\r\n  const state = ensureUpgradeState(areaKey, upgId);\r\n  const upg = state.upg;\r\n  if (!upg) return { bought: 0, spent: BigNum.fromInt(0) };\r\n\r\n  if (isUpgradeLocked(areaKey, upg)) {\r\n    return { bought: BigNum.fromInt(0), spent: BigNum.fromInt(0) };\r\n  }\r\n\r\n  const lvlNum = state.lvl;\r\n  const lvlBn = state.lvlBn ?? ensureLevelBigNum(lvlNum);\r\n  const cap = Number.isFinite(upg.lvlCap)\r\n    ? Math.max(0, Math.floor(upg.lvlCap))\r\n    : Infinity;\r\n  if (Number.isFinite(cap) && lvlNum >= cap) return { bought: 0, spent: BigNum.fromInt(0) };\r\n\r\n  const walletHandle = bank[upg.costType];\r\n  const walletValue = walletHandle?.value;\r\n  const wallet = walletValue instanceof BigNum\r\n    ? walletValue.clone?.() ?? BigNum.fromAny(walletValue)\r\n    : BigNum.fromAny(walletValue ?? 0);\r\n\r\n  if (upg.unlockUpgrade) {\r\n    const nextCost = state.nextCostBn?.clone?.() ?? BigNum.fromInt(0);\r\n    if (nextCost.isZero?.()) {\r\n      return buyOne(areaKey, upgId);\r\n    }\r\n  }\r\n\r\n  if (wallet.isZero?.()) return { bought: BigNum.fromInt(0), spent: BigNum.fromInt(0) };\r\n\r\n  if (wallet.isInfinite?.()) {\r\n    const prevLevel = lvlBn.clone?.() ?? ensureLevelBigNum(lvlBn);\r\n    const prevLevelNum = levelBigNumToNumber(prevLevel);\r\n    const prevLevelStorage = prevLevel.toStorage?.();\r\n    let targetLevelBn;\r\n\r\n    if (upg.upgType === 'HM') {\r\n      targetLevelBn = BigNum.fromAny('Infinity');\r\n\r\n      if (!upg.lvlCapBn?.isInfinite?.()) {\r\n        const infCap = BigNum.fromAny('Infinity');\r\n        upg.lvlCapBn = infCap;\r\n        upg.lvlCap = Number.POSITIVE_INFINITY;\r\n        upg.lvlCapFmtHtml = formatBigNumAsHtml(infCap);\r\n        upg.lvlCapFmtText = formatBigNumAsPlain(infCap);\r\n      }\r\n    } else {\r\n      const capBn = upg.lvlCapBn?.clone?.() ?? toUpgradeBigNum(upg.lvlCap ?? Infinity, Infinity);\r\n      targetLevelBn = capBn?.clone?.() ?? capBn;\r\n    }\r\n\r\n    let purchased = targetLevelBn.sub(prevLevel);\r\n    if (purchased.isZero?.()) {\r\n      const plainDelta = plainLevelDelta(targetLevelBn, prevLevel);\r\n      if (!plainDelta.isZero?.()) {\r\n        purchased = plainDelta;\r\n      }\r\n    }\r\n    if (purchased.isZero?.()) {\r\n      const nextStorage = targetLevelBn.toStorage?.();\r\n      if (prevLevelStorage && nextStorage && prevLevelStorage !== nextStorage) {\r\n        if (targetLevelBn.isInfinite?.()) {\r\n          try { purchased = BigNum.fromAny('Infinity'); }\r\n          catch { purchased = BigNum.fromInt(1); }\r\n        } else {\r\n          purchased = BigNum.fromInt(1);\r\n        }\r\n      }\r\n    }\r\n    state.lvlBn = targetLevelBn.clone?.() ?? targetLevelBn;\r\n    if (upg.upgType === 'NM' && Number.isFinite(upg.lvlCap)) {\r\n      state.lvl = upg.lvlCap;\r\n    } else {\r\n      state.lvl = levelBigNumToNumber(state.lvlBn);\r\n    }\r\n    state.nextCostBn = BigNum.fromAny('Infinity');\r\n\r\n    bank[upg.costType].set(wallet);\r\n\r\n    commitUpgradeState(state);\r\n    invalidateUpgradeState(areaKey, upgId);\r\n    emitUpgradeLevelChange(\r\n      upg,\r\n      prevLevelNum,\r\n      prevLevel,\r\n      state.lvl,\r\n      state.lvlBn,\r\n    );\r\n    notifyChanged();\r\n\r\n    return { bought: purchased, spent: BigNum.fromInt(0) };\r\n  }\r\n\r\n  const nextCost = state.nextCostBn?.clone?.() ?? BigNum.fromAny(upg.costAtLevel(lvlNum));\r\n  if (wallet.cmp(nextCost) < 0) {\r\n    return { bought: BigNum.fromInt(0), spent: BigNum.fromInt(0) };\r\n  }\r\n\r\n  const room = Number.isFinite(cap) ? Math.max(0, cap - lvlNum) : MAX_LEVEL_DELTA;\r\n  if (!(room > 0)) {\r\n    return { bought: BigNum.fromInt(0), spent: BigNum.fromInt(0) };\r\n  }\r\n\r\n  const outcome = calculateBulkPurchase(upg, lvlBn, wallet, room);\r\n  const countBn = outcome.count instanceof BigNum\r\n    ? outcome.count\r\n    : BigNum.fromAny(outcome.count ?? 0);\r\n  if (countBn.isZero?.()) {\r\n    return { bought: BigNum.fromInt(0), spent: BigNum.fromInt(0) };\r\n  }\r\n\r\n  const spent = outcome.spent ?? BigNum.fromInt(0);\r\n  const remaining = wallet.sub(spent);\r\n  bank[upg.costType].set(remaining);\r\n\r\n  const nextLevelBn = lvlBn.add(countBn);\r\n  state.lvlBn = nextLevelBn;\r\n  state.lvl = levelBigNumToNumber(nextLevelBn);\r\n  if (outcome.nextPrice) {\r\n    state.nextCostBn = outcome.nextPrice;\r\n  } else if (Number.isFinite(state.lvl)) {\r\n    state.nextCostBn = BigNum.fromAny(upg.costAtLevel(state.lvl));\r\n  } else {\r\n    state.nextCostBn = BigNum.fromAny('Infinity');\r\n  }\r\n  commitUpgradeState(state);\r\n  invalidateUpgradeState(areaKey, upgId);\r\n  emitUpgradeLevelChange(upg, lvlNum, lvlBn, state.lvl, state.lvlBn);\r\n  notifyChanged();\r\n\r\n  return { bought: countBn, spent };\r\n}\r\n\r\nexport function buyTowards(areaKey, upgId, maxLevels) {\r\n  const state = ensureUpgradeState(areaKey, upgId);\r\n  const upg = state.upg;\r\n  if (!upg) return { bought: 0, spent: BigNum.fromInt(0) };\r\n\r\n  if (isUpgradeLocked(areaKey, upg)) {\r\n    return { bought: BigNum.fromInt(0), spent: BigNum.fromInt(0) };\r\n  }\r\n\r\n  const lvlNum = state.lvl;\r\n  const lvlBn = state.lvlBn ?? ensureLevelBigNum(lvlNum);\r\n  const cap = Number.isFinite(upg.lvlCap)\r\n    ? Math.max(0, Math.floor(upg.lvlCap))\r\n    : Infinity;\r\n  if (Number.isFinite(cap) && lvlNum >= cap) return { bought: 0, spent: BigNum.fromInt(0) };\r\n\r\n  const walletHandle = bank[upg.costType];\r\n  const walletValue = walletHandle?.value;\r\n  const wallet = walletValue instanceof BigNum\r\n    ? walletValue.clone?.() ?? BigNum.fromAny(walletValue)\r\n    : BigNum.fromAny(walletValue ?? 0);\r\n\r\n  if (wallet.isZero?.()) return { bought: BigNum.fromInt(0), spent: BigNum.fromInt(0) };\r\n\r\n  const capRoom = Number.isFinite(cap) ? Math.max(0, cap - lvlNum) : undefined;\r\n  const maxRoom = Number.isFinite(maxLevels)\r\n    ? Math.max(0, Math.floor(maxLevels))\r\n    : (maxLevels instanceof BigNum ? levelBigNumToNumber(maxLevels) : undefined);\r\n  const room = Number.isFinite(capRoom)\r\n    ? (Number.isFinite(maxRoom) ? Math.min(capRoom, maxRoom) : capRoom)\r\n    : maxRoom;\r\n\r\n  const outcome = calculateBulkPurchase(upg, lvlBn, wallet, room);\r\n  const countBn = outcome.count instanceof BigNum\r\n    ? outcome.count\r\n    : BigNum.fromAny(outcome.count ?? 0);\r\n  if (countBn.isZero?.()) {\r\n    return { bought: BigNum.fromInt(0), spent: BigNum.fromInt(0) };\r\n  }\r\n\r\n  const spent = outcome.spent ?? BigNum.fromInt(0);\r\n  const remaining = wallet.sub(spent);\r\n  bank[upg.costType].set(remaining);\r\n\r\n  const nextLevelBn = lvlBn.add(countBn);\r\n  state.lvlBn = nextLevelBn;\r\n  state.lvl = levelBigNumToNumber(nextLevelBn);\r\n  if (outcome.nextPrice) {\r\n    state.nextCostBn = outcome.nextPrice;\r\n  } else if (Number.isFinite(state.lvl)) {\r\n    state.nextCostBn = BigNum.fromAny(upg.costAtLevel(state.lvl));\r\n  } else {\r\n    state.nextCostBn = BigNum.fromAny('Infinity');\r\n  }\r\n  commitUpgradeState(state);\r\n  invalidateUpgradeState(areaKey, upgId);\r\n  emitUpgradeLevelChange(upg, lvlNum, lvlBn, state.lvl, state.lvlBn);\r\n  notifyChanged();\r\n\r\n  return { bought: countBn, spent };\r\n}\r\n\r\nexport function evaluateBulkPurchase(upg, startLevel, walletBn, maxLevels = MAX_LEVEL_DELTA, options = {}) {\r\n  const wallet = walletBn instanceof BigNum ? walletBn : BigNum.fromAny(walletBn ?? 0);\r\n  const outcome = calculateBulkPurchase(upg, startLevel, wallet, maxLevels, options);\r\n  return {\r\n    count: outcome.count,\r\n    spent: outcome.spent ?? BigNum.fromInt(0),\r\n    nextPrice: outcome.nextPrice ?? BigNum.fromInt(0),\r\n    numericCount: outcome.numericCount ?? 0,\r\n  };\r\n}\r\n\r\n/* ------------------------------ Effects wiring ---------------------------- */\r\n\r\nconst BASE_CPS = 1;\r\n\r\nexport function computeUpgradeEffects(areaKey) {\r\n  const ups = getUpgradesForArea(areaKey);\r\n  let cpsMult = 1.0;\r\n  let coinValueMultBn = BigNum.fromInt(1);\r\n  let xpGainMultBn = BigNum.fromInt(1);\r\n  let bookRewardMultBn = BigNum.fromInt(1);\r\n\r\n  for (const u of ups) {\r\n    const lvlBn = getLevel(areaKey, u.id);\r\n    const lvlNum = levelBigNumToNumber(lvlBn);\r\n    const tieKey = u.tieKey || normalizeUpgradeTie(u.tie);\r\n    if (tieKey === UPGRADE_TIES.FASTER_COINS) {\r\n      // Faster Coins\r\n      cpsMult *= u.effectMultiplier(lvlNum);\r\n    } else if (tieKey === UPGRADE_TIES.FASTER_COINS_II) {\r\n      cpsMult *= u.effectMultiplier(lvlNum);\r\n    } else if (tieKey === UPGRADE_TIES.COIN_VALUE_I) {\r\n      const lvl = Math.max(0, Number.isFinite(lvlNum) ? lvlNum : 0);\r\n      if (lvl > 0) {\r\n        const factor = 1 + (0.5 * lvl);\r\n        let str = factor.toFixed(6);\r\n        str = str.replace(/\\.0+$/, '').replace(/(\\.\\d*?)0+$/, '$1');\r\n        coinValueMultBn = coinValueMultBn.mulDecimal(str, 18);\r\n      }\r\n    } else if (tieKey === UPGRADE_TIES.COIN_VALUE_II) {\r\n      const lvl = normalizedUpgradeLevel(lvlNum);\r\n      if (lvl > 0) {\r\n        try {\r\n          const bonus = hundredPercentPerLevelMultiplier(lvl);\r\n          coinValueMultBn = coinValueMultBn.mulBigNumInteger(bonus);\r\n        } catch {}\r\n      }\r\n    } else if (tieKey === UPGRADE_TIES.BOOK_VALUE_I) {\r\n      bookRewardMultBn = bookValueMultiplierBn(lvlNum);\r\n    } else if (tieKey === UPGRADE_TIES.XP_VALUE_I) {\r\n      const lvl = Math.max(0, Number.isFinite(lvlNum) ? lvlNum : 0);\r\n      xpGainMultBn = BigNum.fromAny(1 + lvl * 2);\r\n    } else if (tieKey === UPGRADE_TIES.XP_VALUE_II) {\r\n      const lvl = normalizedUpgradeLevel(lvlNum);\r\n      if (lvl > 0) {\r\n        try {\r\n          const bonus = hundredPercentPerLevelMultiplier(lvl);\r\n          xpGainMultBn = xpGainMultBn.mulBigNumInteger(bonus);\r\n        } catch {}\r\n      }\r\n    }\r\n    // future upgrades here...\r\n  }\r\n\r\n  return {\r\n    coinsPerSecondMult: cpsMult,\r\n    coinsPerSecondAbsolute: BASE_CPS * cpsMult,\r\n    coinValueMultiplier: coinValueMultBn,\r\n    xpGainMultiplier: xpGainMultBn,\r\n    bookRewardMultiplier: bookRewardMultBn,\r\n  };\r\n}\r\n\r\nfunction registerXpUpgradeEffects() {\r\n  try { initResetSystem(); } catch {}\r\n\r\n  // ----- Coin value (Coin Value I + Coin Value II) -----\r\n  try {\r\n    addExternalCoinMultiplierProvider(({ baseMultiplier, xpUnlocked }) => {\r\n      if (!xpUnlocked) return baseMultiplier;\r\n\r\n      let result;\r\n      try {\r\n        result = baseMultiplier instanceof BigNum\r\n          ? baseMultiplier.clone?.() ?? baseMultiplier\r\n          : BigNum.fromAny(baseMultiplier ?? 0);\r\n      } catch {\r\n        result = BigNum.fromInt(0);\r\n      }\r\n\r\n      // Coin Value I: +50% per level\r\n      try {\r\n        const lvl1 = getLevelNumber(AREA_KEYS.STARTER_COVE, UPGRADE_TIES.COIN_VALUE_I);\r\n        const safeLvl1 = Math.max(0, Number.isFinite(lvl1) ? lvl1 : 0);\r\n        if (safeLvl1 > 0) {\r\n          let str = (1 + 0.5 * safeLvl1).toFixed(6);\r\n          str = str.replace(/\\.0+$/, '').replace(/(\\.\\d*?)0+$/, '$1');\r\n          try {\r\n            result = result.mulDecimal(str, 18);\r\n          } catch {}\r\n        }\r\n      } catch {}\r\n\r\n      // Coin Value II (gold_0): +100% per level (independent of I)\r\n      try {\r\n        const lvl2 = normalizedUpgradeLevel(\r\n          getLevelNumber(AREA_KEYS.STARTER_COVE, UPGRADE_TIES.COIN_VALUE_II)\r\n        );\r\n        if (lvl2 > 0) {\r\n          const bonus = hundredPercentPerLevelMultiplier(lvl2);\r\n          try {\r\n            result = result.mulBigNumInteger(bonus);\r\n          } catch {}\r\n        }\r\n      } catch {}\r\n\r\n      // Endless XP (HM): milestone bonuses to coin value\r\n      try {\r\n        const hmUpg = getUpgrade(AREA_KEYS.STARTER_COVE, UPGRADE_TIES.ENDLESS_XP);\r\n        const hmLvl = getLevel(AREA_KEYS.STARTER_COVE, UPGRADE_TIES.ENDLESS_XP);\r\n        const { coinMult } = computeHmMultipliers(hmUpg, hmLvl, AREA_KEYS.STARTER_COVE);\r\n        result = safeMultiplyBigNum(result, coinMult);\r\n      } catch {}\r\n\r\n      return result;\r\n    });\r\n  } catch {}\r\n\r\n  // ----- XP value (XP Value I + XP Value II) -----\r\n  try {\r\n    addExternalXpGainMultiplierProvider(({ baseGain, xpUnlocked }) => {\r\n      if (!xpUnlocked) return baseGain;\r\n\r\n      let gain;\r\n      try {\r\n        gain = baseGain instanceof BigNum\r\n          ? baseGain.clone?.() ?? baseGain\r\n          : BigNum.fromAny(baseGain ?? 0);\r\n      } catch {\r\n        gain = BigNum.fromInt(0);\r\n      }\r\n\r\n      // XP Value I: +200% per level (1 + 2*lvl)\r\n      try {\r\n        const lvl1 = getLevelNumber(AREA_KEYS.STARTER_COVE, UPGRADE_TIES.XP_VALUE_I);\r\n        const safeLvl1 = Math.max(0, Number.isFinite(lvl1) ? lvl1 : 0);\r\n        if (safeLvl1 > 0) {\r\n          try {\r\n            gain = gain.mulBigNumInteger(BigNum.fromAny(1 + safeLvl1 * 2));\r\n          } catch {}\r\n        }\r\n      } catch {}\r\n\r\n      // XP Value II (gold_1): +100% per level (independent of I)\r\n      try {\r\n        const lvl2 = normalizedUpgradeLevel(\r\n          getLevelNumber(AREA_KEYS.STARTER_COVE, UPGRADE_TIES.XP_VALUE_II)\r\n        );\r\n        if (lvl2 > 0) {\r\n          const bonus = hundredPercentPerLevelMultiplier(lvl2);\r\n          try {\r\n            gain = gain.mulBigNumInteger(bonus);\r\n          } catch {}\r\n        }\r\n      } catch {}\r\n\r\n      // Endless XP (HM): core effect + milestones\r\n      try {\r\n        const hmUpg = getUpgrade(AREA_KEYS.STARTER_COVE, UPGRADE_TIES.ENDLESS_XP);\r\n        const hmLvl = getLevel(AREA_KEYS.STARTER_COVE, UPGRADE_TIES.ENDLESS_XP);\r\n        let base = 1;\r\n        try { base = hmUpg?.effectMultiplier?.(hmLvl) ?? 1; } catch {}\r\n        const { selfMult, xpMult } = computeHmMultipliers(hmUpg, hmLvl, AREA_KEYS.STARTER_COVE);\r\n        gain = safeMultiplyBigNum(gain, safeMultiplyBigNum(base, selfMult));\r\n        gain = safeMultiplyBigNum(gain, xpMult);\r\n      } catch {}\r\n\r\n      return gain;\r\n    });\r\n  } catch {}\r\n\r\n  try {\r\n    setExternalBookRewardProvider(({ baseReward, xpUnlocked }) => {\r\n      if (!xpUnlocked) return baseReward;\r\n\r\n      try {\r\n        return baseReward instanceof BigNum\r\n          ? baseReward.clone?.() ?? baseReward\r\n          : BigNum.fromAny(baseReward ?? 0);\r\n      } catch {\r\n        return BigNum.fromInt(0);\r\n      }\r\n    });\r\n  } catch {}\r\n\r\n  syncBookCurrencyMultiplierFromUpgrade();\r\n  if (typeof window !== 'undefined') {\r\n    window.addEventListener('saveSlot:change', () => {\r\n      try { syncBookCurrencyMultiplierFromUpgrade(); } catch {}\r\n      try { refreshCoinMultiplierFromXpLevel(); } catch {}\r\n    });\r\n  }\r\n}\r\n\r\nregisterXpUpgradeEffects();\r\n\r\nlet listeners = [];\r\nexport function onUpgradesChanged(cb) {\r\n  if (typeof cb === 'function') listeners.push(cb);\r\n  return () => { listeners = listeners.filter(x => x !== cb); };\r\n}\r\nfunction notifyChanged() {\r\n  try { listeners.forEach(cb => cb()); } catch {}\r\n  try { document.dispatchEvent(new CustomEvent('ccc:upgrades:changed')); } catch {}\r\n  try { refreshCoinMultiplierFromXpLevel(); } catch {}\r\n}\r\n\r\n/* ----------------------- Area detection (DOM mapping) ---------------------- */\r\n\r\nexport function getCurrentAreaKey() {\r\n  const gameRoot = document.getElementById('game-root');\r\n  if (gameRoot?.classList?.contains('area-cove')) return AREA_KEYS.STARTER_COVE;\r\n  return AREA_KEYS.STARTER_COVE;\r\n}\r\n\r\n/* ------------------------------ UI helpers -------------------------------- */\r\n\r\nexport function upgradeUiModel(areaKey, upgId) {\r\n  const upg = getUpgrade(areaKey, upgId);\r\n  if (!upg) return null;\r\n  const lvlBn = getLevel(areaKey, upgId);\r\n  const lvl = levelBigNumToNumber(lvlBn);\r\n  const lvlFmtHtml = formatBigNumAsHtml(lvlBn);\r\n  const lvlFmtText = formatBigNumAsPlain(lvlBn);\r\n  const lvlCapBn = upg.lvlCapBn ?? toUpgradeBigNum(upg.lvlCap ?? Infinity, Infinity);\r\n  const lvlCapFmtHtml = upg.lvlCapFmtHtml ?? formatBigNumAsHtml(lvlCapBn);\r\n  const lvlCapFmtText = upg.lvlCapFmtText ?? formatBigNumAsPlain(lvlCapBn);\r\n  const nextPrice = lvl < upg.lvlCap ? peekNextPrice(areaKey, upgId) : BigNum.fromInt(0);\r\n  const nextPriceFmt = formatBigNumAsHtml(nextPrice);\r\n  const haveRaw = bank[upg.costType]?.value;\r\n  const have = haveRaw instanceof BigNum\r\n    ? haveRaw\r\n    : BigNum.fromAny(haveRaw ?? 0);\r\n  const lockState = getUpgradeLockState(areaKey, upgId);\r\n  const locked = !!lockState.locked;\r\n  const displayTitle = lockState.titleOverride ?? upg.title;\r\n  const displayDesc = lockState.descOverride ?? upg.desc;\r\n  const hmMilestones = resolveHmMilestones(upg, areaKey);\r\n  let effect = '';\r\n  if (typeof upg.effectSummary === 'function' && !(locked && lockState.hideEffect)) {\r\n    effect = upg.effectSummary(lvl);\r\n    if (typeof effect === 'string') effect = effect.trim();\r\n  }\r\n  const iconUrl = lockState.iconOverride ?? getIconUrl(upg);\r\n  return {\r\n    upg,\r\n    lvl,\r\n    lvlBn,\r\n    lvlFmtHtml,\r\n    lvlFmtText,\r\n    lvlCapBn,\r\n    lvlCapFmtHtml,\r\n    lvlCapFmtText,\r\n    nextPrice,\r\n    nextPriceFmt,\r\n    have,\r\n    haveFmt: bank[upg.costType]?.fmt(have) ?? String(have),\r\n    effect,\r\n    iconUrl,\r\n    lockState,\r\n    locked,\r\n    areaKey,\r\n    hmMilestones,\r\n    displayTitle,\r\n    displayDesc,\r\n    unlockUpgrade: !!upg.unlockUpgrade,\r\n    hmEvolutions: upg.upgType === 'HM' ? getHmEvolutions(areaKey, upgId) : 0,\r\n    hmReadyToEvolve: upg.upgType === 'HM' ? isHmReadyToEvolve(upg, lvlBn, getHmEvolutions(areaKey, upgId)) : false,\r\n    hmNextMilestone: upg.upgType === 'HM' ? hmNextMilestoneLevel(upg, lvlBn, areaKey) : null,\r\n  };\r\n}\r\n\r\nexport function getHmNextMilestoneLevel(areaKey, upgId) {\r\n  const upg = getUpgrade(areaKey, upgId);\r\n  if (!upg || upg.upgType !== 'HM') return null;\r\n  const lvlBn = getLevel(areaKey, upgId);\r\n  return hmNextMilestoneLevel(upg, lvlBn, areaKey);\r\n}\r\n\r\nexport function normalizeBigNum(value) {\r\n  return bigNumFromLog10(approxLog10BigNum(value ?? 0));\r\n}\r\n", "export const MERCHANT_DIALOGUES = {\r\n  0: {\r\n    start: 'n0',\r\n    nodes: {\r\n      n0: { type: 'line', say: 'So you want to delve deeper within my shop, do you?', next: 'c1' },\r\n\r\n      r_who: { type: 'line', say: 'I am the Merchant.', next: 'c2' },\r\n      r_where: { type: 'line', say: 'The cove.',          next: 'c2' },\r\n      r_confused: { type: 'line', say: 'Okay.',                next: 'c2' },\r\n\r\n      c1: { type: 'choice', options: [\r\n        { label: 'Who are you?', to: 'r_who' },\r\n        { label: 'Where am I?', to: 'r_where' },\r\n        { label: 'I just clicked on this green button and now I\u2019m confused.', to: 'r_confused' },\r\n      ]},\r\n\r\n      c2: { type: 'choice', options: [\r\n        { label: 'What?', to: 'r2_what' }, \r\n        { label: 'That\u2019s not helpful.', to: 'r2_okay' }, \r\n        { label: 'Okay.', to: 'r2_okay' }, \r\n      ]},\r\n\r\n      r2_what: { type: 'line', say: 'What?', next: 'c3' },\r\n      r2_okay:   { type: 'line', say: 'Okay.',   next: 'c3' },\r\n\r\n      c3: { type: 'choice', options: [\r\n        { label: 'What?', to: 'r2_what' },\r\n        { label: 'That\u2019s not helpful.', to: 'r2_okay' },\r\n        { label: 'Goodbye.', to: 'end' },\r\n      ]},\r\n    }\r\n  },\r\n\r\n  1: {\r\n    start: 'n0',\r\n    nodes: {\r\n      n0: { type: 'line', say: 'Hello again.', next: 'c0' },\r\n\r\n      c0: { type: 'choice', options: [\r\n        { label: 'You never answered my questions.', to: 'm1a' },\r\n        { label: 'Hello.', to: 'm1b' },\r\n        { label: 'I am still very confused.', to: 'm1c' },\r\n      ]},\r\n\r\n      m1a: { type: 'line', say: 'Yes I did.', next: 'c1a' },\r\n      m1b: { type: 'line', say: 'Hello.',    next: 'c1b' },\r\n      m1c: { type: 'line', say: 'Okay.',       next: 'c1c' },\r\n\r\n      c1a: { type: 'choice', options: [\r\n        { label: 'No you didn\u2019t.', to: 'm1a' },\r\n        { label: 'Liar.',          to: 'm2a' },\r\n        { label: 'Okay I guess you\u2019re right.', to: 'm2b' },\r\n      ]},\r\n\r\n      c1b: { type: 'choice', options: [\r\n        { label: 'You never answered my questions.', to: 'm1a' },\r\n        { label: 'That does not help.',              to: 'm1c' },\r\n        { label: 'Okay.',                              to: 'm2b' },\r\n      ]},\r\n\r\n      c1c: { type: 'choice', options: [\r\n        { label: 'Yes.',  to: 'm2a' },\r\n        { label: 'Hmm\u2026',  to: 'm1c' },\r\n        { label: 'Okay.',   to: 'm2b' },\r\n      ]},\r\n\r\n      m2a: { type: 'line', say: 'No.', next: 'c1c' },\r\n      m2b: { type: 'line', say: 'Would you like some Coins? Free of charge. You look like you could use some right now.', next: 'c2a' },\r\n\r\n      c2a: { type: 'choice', options: [\r\n        { label: 'What?',                to: 'm3a' },\r\n        { label: 'No.',        to: 'm3b' },\r\n        { label: 'Give me the coins now.', to: 'end' },\r\n      ]},\r\n\r\n      m3a: { type: 'line', say: 'What?', next: 'c2a' },\r\n      m3b: { type: 'line', say: 'Okay, no Coins for you then.', next: 'c2b' },\r\n\r\n      c2b: { type: 'choice', options: [\r\n        { label: 'No wait, actually I want the coins. Give them to me now.', to: 'end' },\r\n        { label: 'On second thought, maybe I do want the coins. Give them to me now.', to: 'end' },\r\n        { label: 'Okay, bye, I don\u2019t need your filthy coins anyway.', to: 'end_nr' },\r\n      ]},\r\n    }\r\n  },\r\n  2: {\r\n    start: 'n0',\r\n    nodes: {\r\n      n0: { type: 'line', say: 'I see you\u2019ve unlocked the XP system.', next: 'c0' },\r\n\r\n      c0: { type: 'choice', options: [\r\n        { label: 'What does it do?',      to: 'm1a' },\r\n        { label: 'What does that mean?',  to: 'm1b' },\r\n        { label: 'Yes I did that.',       to: 'm1c' },\r\n      ]},\r\n\r\n      m1a: { type: 'line', say: 'The XP system is a powerful ancient mechanism, designed to allow rapid influx of coin-collecting power. Increasing your XP Level grants you Books infused with my power, capable of great things.', next: 'c1a' },\r\n      m1b: { type: 'line', say: 'It means you can grow passively stronger by collecting coins.', next: 'c1b' },\r\n      m1c: { type: 'line', say: 'And do you know how the XP system works?', next: 'c1c' },\r\n\r\n      c1a: { type: 'choice', options: [\r\n        { label: 'This XP system, by whom was it designed, exactly?', to: 'm2b' },\r\n        { label: 'What does that mean?',                               to: 'm1b' },\r\n        { label: 'Okay.',                                              to: 'm2a' },\r\n      ]},\r\n      c1b: { type: 'choice', options: [\r\n        { label: 'Can you explain in more detail?', to: 'm1a' },\r\n        { label: 'Why?',                           to: 'm2c' },\r\n        { label: 'Okay.',                          to: 'm2a' },\r\n      ]},\r\n      c1c: { type: 'choice', options: [\r\n        { label: 'I have no idea.',              to: 'm1a' },\r\n        { label: 'I don\u2019t know the full details.', to: 'm1a' },\r\n        { label: 'Yes.',                         to: 'm2a' },\r\n      ]},\r\n\r\n      m2a: { type: 'line', say: 'Would you like some Books, free of charge? They will help you accelerate your coin-collecting power.', next: 'c2a' },\r\n      m2b: { type: 'line', say: 'I dunno.', next: 'c2b' },\r\n      m2c: { type: 'line', say: 'Because I dunno.', next: 'c2c' },\r\n      m2d: { type: 'line', say: 'What?',    next: 'c2c' },\r\n      m2e: { type: 'line', say: 'I\u2019ve already told you, so you can increase your coin-collecting power.', next: 'c2d' },\r\n      m2f: { type: 'line', say: 'Are you sure you don\u2019t want free Books?', next: 'c3a' },\r\n\r\n      c2a: { type: 'choice', options: [\r\n        { label: 'No.',                               to: 'm2f' },\r\n        { label: 'Why are you giving me all this free stuff?', to: 'm2e' },\r\n        { label: 'Yeah, sure.',                       to: 'end' },\r\n      ]},\r\n      c2b: { type: 'choice', options: [\r\n        { label: 'What?', to: 'm2d' },\r\n        { label: 'Why not?',  to: 'm2c' },\r\n        { label: '\u2026',     to: 'm2a' },\r\n      ]},\r\n      c2c: { type: 'choice', options: [\r\n        { label: '\u2026', to: 'm2a' },\r\n        { label: '\u2026', to: 'm2a' },\r\n        { label: '\u2026', to: 'm2a' },\r\n      ]},\r\n      c2d: { type: 'choice', options: [\r\n        { label: 'But why does that matter?',   to: 'm3a' },\r\n        { label: 'But what does that mean?',    to: 'm3a' },\r\n        { label: '\u2026',                           to: 'm3a' },\r\n      ]},\r\n\r\n      m3a: { type: 'line', say: 'If you want free Books, then don\u2019t ask further questions.', next: 'c3a' },\r\n\r\n      c3a: { type: 'choice', options: [\r\n        { label: 'Okay, actually give me the free stuff.',        to: 'end' },\r\n        { label: 'Okay fine, I\u2019ll take those books off your hands.', to: 'end' },\r\n        { label: 'I don\u2019t need your charity.',                    to: 'end_nr' },\r\n      ]},\r\n    }\r\n  },\r\n  3: {\r\n    start: 'n0',\r\n    nodes: {\r\n      n0: { type: 'line', say: 'Level 999. I hoped to see it one day. Placeholder admiration intensifies.', next: 'c0' },\r\n\r\n      c0: { type: 'choice', options: [\r\n        { label: 'Was it worth it?', to: 'q0' },\r\n        { label: 'What happens next?', to: 'q1' },\r\n        { label: 'I need a break.', to: 'end' },\r\n      ]},\r\n\r\n      q0: { type: 'line', say: 'Only you can decide that. But the data you gathered will fuel upcoming secrets.', next: 'c1' },\r\n      q1: { type: 'line', say: 'Beyond this? More systems, more bargains, and more reasons to climb. Placeholder, of course.', next: 'c1' },\r\n\r\n      c1: { type: 'choice', options: [\r\n        { label: 'Where are the rewards?', to: 'q2' },\r\n        { label: 'I\u2019ll keep going.', to: 'end' },\r\n        { label: 'I need another hint.', to: 'q3' },\r\n      ]},\r\n\r\n      q2: { type: 'line', say: 'For now, take pride. The tangible prizes arrive in a future update.', next: 'c1' },\r\n      q3: { type: 'line', say: 'Watch the Merchant tab. New dialogues will appear at milestones beyond this.', next: 'c1' },\r\n    }\r\n  },\r\n};\r\n", "// js/util/ghostTapGuard.js\r\n// Fixes issue with buttons on mobile that prevents them from being spam clicked\r\n// It's important that this is applied to every clickable button in the game\r\n\r\nconst DEFAULT_TIMEOUT_MS = 0;\r\nconst ELEMENT_SKIP_PROP = Symbol('ccc:ghostTap:skipUntil');\r\nconst GLOBAL_SKIP_PROP = '__cccGhostTapSkipUntil';\r\nconst TARGET_SELECTOR = '[data-ghost-tap-target], button, [role=\"button\"], [data-btn], .game-btn, .btn, .slot-card, a[href], input, select, textarea, summary';\r\nconst DEFAULT_LONG_PRESS_MS = 80;\r\n\r\nlet guardInstalled = false;\r\nlet selector = TARGET_SELECTOR;\r\nlet hasPointerEvents = false;\r\nlet hasTouchEvents = false;\r\nlet lastMarkedTarget = null;\r\nlet lastTouchMs = 0;\r\nlet lastTouchStartMs = 0;\r\nlet lastTouchDurationMs = 0;\r\nlet longPressMs = DEFAULT_LONG_PRESS_MS;\r\n\r\nfunction nowMs() {\r\n  if (typeof performance !== 'undefined' && typeof performance.now === 'function') {\r\n    return performance.now();\r\n  }\r\n  return Date.now();\r\n}\r\n\r\nfunction getDocument() {\r\n  if (typeof document === 'undefined') return null;\r\n  return document;\r\n}\r\n\r\nfunction findTapTarget(node) {\r\n  const doc = getDocument();\r\n  if (!doc) return null;\r\n  const ElementCtor = typeof Element !== 'undefined' ? Element : null;\r\n  if (!node || !ElementCtor) return null;\r\n  if (!(node instanceof ElementCtor)) {\r\n    node = node.parentElement;\r\n  }\r\n  if (!node || !node.closest) return null;\r\n  return node.closest(selector);\r\n}\r\n\r\nfunction clearGhostTapTarget(el) {\r\n  if (!el) return;\r\n  el[ELEMENT_SKIP_PROP] = 0;\r\n}\r\n\r\nfunction markGhostTapTarget(el, timeout = DEFAULT_TIMEOUT_MS) {\r\n  if (!el) return;\r\n  const now = nowMs();\r\n  const delay = Number.isFinite(timeout) ? Math.max(0, Number(timeout)) : DEFAULT_TIMEOUT_MS;\r\n  if (delay > 0) {\r\n    el[ELEMENT_SKIP_PROP] = now + delay;\r\n  } else {\r\n    el[ELEMENT_SKIP_PROP] = 0;\r\n  }\r\n  lastMarkedTarget = el;\r\n  if (delay > 0) suppressNextGhostTap(delay);\r\n}\r\n\r\nfunction consumeGhostTapGuard(target) {\r\n  if (typeof window === 'undefined') return false;\r\n  const until = window[GLOBAL_SKIP_PROP];\r\n  if (typeof until !== 'number') return false;\r\n\r\n  const now = nowMs();\r\n  if (now <= until) {\r\n    window[GLOBAL_SKIP_PROP] = null;\r\n    if (target && lastMarkedTarget && target === lastMarkedTarget) {\r\n      return false;\r\n    }\r\n    return true;\r\n  }\r\n\r\n  window[GLOBAL_SKIP_PROP] = null;\r\n  return false;\r\n}\r\n\r\nfunction shouldSkipGhostTap(el) {\r\n  if (!el) return false;\r\n  const until = Number(el[ELEMENT_SKIP_PROP] || 0);\r\n  if (!Number.isFinite(until) || until <= 0) return false;\r\n  const now = nowMs();\r\n  if (now <= until) {\r\n    if (lastMarkedTarget && el === lastMarkedTarget) {\r\n      clearGhostTapTarget(el);\r\n      return false;\r\n    }\r\n    clearGhostTapTarget(el);\r\n    return true;\r\n  }\r\n  clearGhostTapTarget(el);\r\n  return false;\r\n}\r\n\r\nfunction suppressNextGhostTap(timeout = DEFAULT_TIMEOUT_MS) {\r\n  if (typeof window === 'undefined') return;\r\n  const now = nowMs();\r\n  const targetDelay = Math.max(0, Number.isFinite(timeout) ? timeout : DEFAULT_TIMEOUT_MS);\r\n  if (targetDelay <= 0) {\r\n    window[GLOBAL_SKIP_PROP] = null;\r\n    return;\r\n  }\r\n  const target = now + targetDelay;\r\n  const current = typeof window[GLOBAL_SKIP_PROP] === 'number'\r\n    ? window[GLOBAL_SKIP_PROP]\r\n    : 0;\r\n  window[GLOBAL_SKIP_PROP] = Math.max(current, target);\r\n}\r\n\r\nfunction onPointerStart(event) {\r\n  if (event.pointerType === 'mouse') return;\r\n  if (typeof event.button === 'number' && event.button !== 0) return;\r\n  lastTouchMs = lastTouchStartMs = nowMs();\r\n  lastTouchDurationMs = 0;\r\n  const target = findTapTarget(event.target);\r\n  if (!target) return;\r\n  if (consumeGhostTapGuard(target)) {\r\n    clearGhostTapTarget(target);\r\n    event.preventDefault();\r\n    event.stopImmediatePropagation();\r\n  }\r\n}\r\n\r\nfunction onTouchStart(event) {\r\n  lastTouchMs = lastTouchStartMs = nowMs();\r\n  lastTouchDurationMs = 0;\r\n  const target = findTapTarget(event.target);\r\n  if (!target) return;\r\n  if (consumeGhostTapGuard(target)) {\r\n    clearGhostTapTarget(target);\r\n    event.preventDefault();\r\n    event.stopImmediatePropagation();\r\n  }\r\n}\r\n\r\nfunction onPointerEnd(event) {\r\n  if (event.pointerType === 'mouse') return;\r\n  if (typeof event.button === 'number' && event.button !== 0) return;\r\n  const now = nowMs();\r\n  if (lastTouchStartMs > 0) {\r\n    lastTouchDurationMs = now - lastTouchStartMs;\r\n  }\r\n  lastTouchMs = now;\r\n}\r\n\r\nfunction onTouchEnd() {\r\n  const now = nowMs();\r\n  if (lastTouchStartMs > 0) {\r\n    lastTouchDurationMs = now - lastTouchStartMs;\r\n  }\r\n  lastTouchMs = now;\r\n}\r\n\r\nfunction onClickCapture(event) {\r\n  const now = nowMs();\r\n  const sinceTouchStart = lastTouchStartMs > 0 ? now - lastTouchStartMs : -1;\r\n  if (sinceTouchStart < 0) return;\r\n\r\n  const target = findTapTarget(event.target);\r\n  if (!target) return;\r\n\r\n  const effectiveDuration = lastTouchDurationMs || sinceTouchStart;\r\n\r\n  if (effectiveDuration >= longPressMs) {\r\n    clearGhostTapTarget(target);\r\n    lastTouchDurationMs = 0;\r\n    event.preventDefault();\r\n    event.stopImmediatePropagation();\r\n    return;\r\n  }\r\n  if (consumeGhostTapGuard(target)) {\r\n    clearGhostTapTarget(target);\r\n    lastTouchDurationMs = 0;\r\n    event.preventDefault();\r\n    event.stopImmediatePropagation();\r\n  }\r\n  lastTouchDurationMs = 0;\r\n}\r\n\r\n\r\nexport function installGhostTapGuard(options = {}) {\r\n  if (guardInstalled) return;\r\n  const doc = getDocument();\r\n  if (!doc || typeof window === 'undefined') return;\r\n\r\n  guardInstalled = true;\r\n  hasPointerEvents = 'PointerEvent' in window;\r\n  hasTouchEvents = !hasPointerEvents && 'ontouchstart' in window;\r\n  if (options.selector) {\r\n    selector = `${options.selector}, ${TARGET_SELECTOR}`;\r\n  }\r\n\r\n  if (Number.isFinite(options.longPressMs) && options.longPressMs >= 0) {\r\n    longPressMs = options.longPressMs;\r\n  }\r\n\r\n  doc.addEventListener('click', onClickCapture, true);\r\n\r\n  if (hasPointerEvents) {\r\n    doc.addEventListener('pointerdown', onPointerStart, { capture: true, passive: false });\r\n    doc.addEventListener('pointerup', onPointerEnd, { capture: true, passive: true });\r\n  } else if (hasTouchEvents) {\r\n    doc.addEventListener('touchstart', onTouchStart, { capture: true, passive: false });\r\n    doc.addEventListener('touchend', onTouchEnd, { capture: true, passive: true });\r\n  }\r\n}\r\n\r\nexport {\r\n  clearGhostTapTarget,\r\n  markGhostTapTarget,\r\n  shouldSkipGhostTap,\r\n  suppressNextGhostTap,\r\n  consumeGhostTapGuard,\r\n  DEFAULT_TIMEOUT_MS as GHOST_TAP_TIMEOUT_MS,\r\n};\r\n\r\nexport function setGhostTapSelector(extraSelector) {\r\n  if (!extraSelector) return;\r\n  selector = `${extraSelector}, ${TARGET_SELECTOR}`;\r\n}\r\n", "// js/ui/merchantDelve/dlgTab.js\r\nimport {\r\n  bank,\r\n  getActiveSlot,\r\n  watchStorageKey,\r\n  primeStorageWatcherSnapshot,\r\n} from '../../util/storage.js';\r\nimport { BigNum } from '../../util/bigNum.js';\r\nimport { MERCHANT_DIALOGUES } from '../../misc/merchantDialogues.js';\r\nimport { getXpState, isXpSystemUnlocked } from '../../game/xpSystem.js';\r\nimport { initResetPanel, initResetSystem, updateResetPanel, isForgeUnlocked, hasDoneForgeReset } from './resetTab.js';\r\nimport { blockInteraction } from '../shopOverlay.js';\r\nimport {\r\n  markGhostTapTarget,\r\n  shouldSkipGhostTap,\r\n  suppressNextGhostTap,\r\n} from '../../util/ghostTapGuard.js';\r\nimport { IS_MOBILE } from '../../main.js';\r\n\r\nfunction nowMs() {\r\n  if (typeof performance !== 'undefined' && typeof performance.now === 'function') {\r\n    return performance.now();\r\n  }\r\n  return Date.now();\r\n}\r\n\r\nconst MERCHANT_ICON_SRC = 'img/misc/merchant.png';\r\nconst MERCHANT_MET_KEY_BASE  = 'ccc:merchantMet';\r\nconst MERCHANT_TAB_KEY_BASE  = 'ccc:merchantTab';\r\nexport const MERCHANT_DLG_STATE_KEY_BASE = 'ccc:merchant:dlgState';\r\nexport const MERCHANT_MET_EVENT = 'ccc:merchant:met';\r\nconst sk = (base) => `${base}:${getActiveSlot()}`;\r\n\r\nexport function hasMetMerchant() {\r\n  try {\r\n    return localStorage.getItem(sk(MERCHANT_MET_KEY_BASE)) === '1';\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\nconst MERCHANT_TABS_DEF = [\r\n  { key: 'dialogue',  label: 'Dialogue', unlocked: true },\r\n  { key: 'reset',     label: 'Reset',    unlocked: false, lockedLabel: '???' },\r\n  { key: 'minigames', label: '???',      unlocked: false },\r\n];\r\n\r\nconst merchantTabUnlockState = new Map([\r\n  ['dialogue', true],\r\n  ['reset', false],\r\n  ['minigames', false],\r\n]);\r\n\r\nconst REWARD_ICON_SRC = {\r\n  coins: 'img/currencies/coin/coin.png',\r\n  books: 'img/currencies/book/book.png',\r\n};\r\n\r\nconst MYSTERIOUS_ICON_SRC = 'img/misc/mysterious.png';\r\nconst HIDDEN_DIALOGUE_TITLE = 'Hidden Dialogue';\r\nconst LOCKED_DIALOGUE_TITLE = 'Locked Dialogue';\r\nconst DEFAULT_MYSTERIOUS_BLURB = 'Hidden Dialogue';\r\nconst DEFAULT_LOCKED_BLURB = 'Locked';\r\nconst DEFAULT_LOCK_MESSAGE = 'Locked Dialogue';\r\nconst DIALOGUE_STATUS_ORDER = { locked: 0, mysterious: 1, unlocked: 2 };\r\nconst FORGE_COMPLETED_KEY_BASE = 'ccc:reset:forge:completed';\r\n\r\nconst HAS_POINTER_EVENTS = typeof window !== 'undefined' && 'PointerEvent' in window;\r\nconst HAS_TOUCH_EVENTS = !HAS_POINTER_EVENTS && typeof window !== 'undefined' && 'ontouchstart' in window;\r\n\r\nfunction bindRapidActivation(target, handler, { once = false } = {}) {\r\n  if (!target || typeof handler !== 'function') return () => {};\r\n  let used = false;\r\n  let pointerTriggered = false;\r\n  let activePointerId = null;\r\n\r\nconst run = (event) => {\r\n  if (once && used) return;\r\n  if (event?.type === 'click' && shouldSkipGhostTap(target)) {\r\n    event.preventDefault?.();\r\n    return;\r\n  }\r\n  markGhostTapTarget(target);\r\n  used = once ? true : used;\r\n  Promise.resolve(handler(event)).catch(() => {});\r\n  if (once) cleanup();\r\n};\r\n\r\n  const resetPointerTrigger = () => {\r\n    pointerTriggered = false;\r\n    activePointerId = null;\r\n  };\r\n\r\n  const onClick = (event) => {\r\n    if (pointerTriggered) {\r\n      resetPointerTrigger();\r\n      return;\r\n    }\r\n    run(event);\r\n  };\r\n\r\nconst onPointerDown = (event) => {\r\n  if (event.pointerType === 'mouse') return;\r\n  if (typeof event.button === 'number' && event.button !== 0) return;\r\n  pointerTriggered = true;\r\n  activePointerId = typeof event.pointerId === 'number' ? event.pointerId : null;\r\n  suppressNextGhostTap(160);\r\n};\r\n\r\n  const onPointerUp = (event) => {\r\n    if (!pointerTriggered) return;\r\n    if (activePointerId != null && typeof event.pointerId === 'number' && event.pointerId !== activePointerId) {\r\n      return;\r\n    }\r\n    resetPointerTrigger();\r\n    run(event);\r\n  };\r\n\r\n  const onPointerCancel = () => {\r\n    if (!pointerTriggered) return;\r\n    resetPointerTrigger();\r\n  };\r\n\r\nconst onTouchStart = (event) => {\r\n  pointerTriggered = true;\r\n  suppressNextGhostTap(160);\r\n};\r\n\r\n  const onTouchEnd = (event) => {\r\n    if (!pointerTriggered) return;\r\n    resetPointerTrigger();\r\n    run(event);\r\n  };\r\n\r\n  const onTouchCancel = () => {\r\n    if (!pointerTriggered) return;\r\n    resetPointerTrigger();\r\n  };\r\n\r\n  const cleanup = () => {\r\n    target.removeEventListener('click', onClick);\r\n    if (HAS_POINTER_EVENTS) {\r\n      target.removeEventListener('pointerdown', onPointerDown);\r\n      window.removeEventListener('pointerup', onPointerUp);\r\n      window.removeEventListener('pointercancel', onPointerCancel);\r\n    } else if (HAS_TOUCH_EVENTS) {\r\n      target.removeEventListener('touchstart', onTouchStart);\r\n      window.removeEventListener('touchend', onTouchEnd);\r\n      window.removeEventListener('touchcancel', onTouchCancel);\r\n    }\r\n  };\r\n\r\n  target.addEventListener('click', onClick);\r\n  if (HAS_POINTER_EVENTS) {\r\n    target.addEventListener('pointerdown', onPointerDown, { passive: false });\r\n    window.addEventListener('pointerup', onPointerUp, { passive: false });\r\n    window.addEventListener('pointercancel', onPointerCancel, { passive: false });\r\n  } else if (HAS_TOUCH_EVENTS) {\r\n    target.addEventListener('touchstart', onTouchStart, { passive: false });\r\n    window.addEventListener('touchend', onTouchEnd, { passive: false });\r\n    window.addEventListener('touchcancel', onTouchCancel, { passive: false });\r\n  }\r\n\r\n  return cleanup;\r\n}\r\n\r\nfunction dialogueStatusRank(status) {\r\n  return DIALOGUE_STATUS_ORDER[status] ?? 0;\r\n}\r\n\r\nfunction snapshotLockDisplay(info) {\r\n  if (!info || typeof info !== 'object') return null;\r\n  return {\r\n    title: info.title ?? null,\r\n    blurb: info.blurb ?? null,\r\n    tooltip: info.tooltip ?? null,\r\n    message: info.message ?? null,\r\n    icon: info.icon ?? null,\r\n    headerTitle: info.headerTitle ?? null,\r\n    ariaLabel: info.ariaLabel ?? null,\r\n  };\r\n}\r\n\r\nfunction buildUnlockedDialogueInfo(meta) {\r\n  return {\r\n    status: 'unlocked',\r\n    unlocked: true,\r\n    title: meta.title,\r\n    blurb: meta.blurb,\r\n    tooltip: '',\r\n    message: '',\r\n    icon: null,\r\n    headerTitle: null,\r\n    ariaLabel: meta.title || 'Merchant dialogue',\r\n  };\r\n}\r\n\r\nlet progressEventsBound = false;\r\nlet merchantDlgWatcherInitialized = false;\r\nlet merchantDlgWatcherSlot = null;\r\nlet merchantDlgWatcherCleanup = null;\r\n\r\nfunction bigNumToSafeInteger(value) {\r\n  if (value && typeof value === 'object') {\r\n    if (typeof value.toPlainIntegerString === 'function') {\r\n      try {\r\n        const plain = value.toPlainIntegerString();\r\n        if (plain != null) {\r\n          const parsed = Number.parseInt(plain, 10);\r\n          if (Number.isFinite(parsed)) return parsed;\r\n        }\r\n      } catch {}\r\n    }\r\n    if (typeof value.toString === 'function') {\r\n      try {\r\n        const str = value.toString();\r\n        if (str != null) {\r\n          const parsed = Number.parseInt(str, 10);\r\n          if (Number.isFinite(parsed)) return parsed;\r\n        }\r\n      } catch {}\r\n    }\r\n  }\r\n\r\n  const numeric = Number(value);\r\n  if (!Number.isFinite(numeric)) return 0;\r\n  if (numeric <= 0) return 0;\r\n  return Math.floor(numeric);\r\n}\r\n\r\nfunction getPlayerProgress() {\r\n  const progress = {\r\n    xpUnlocked: false,\r\n    xpLevel: 0,\r\n    hasForgeReset: false,\r\n  };\r\n\r\n  try {\r\n    progress.xpUnlocked = typeof isXpSystemUnlocked === 'function' && isXpSystemUnlocked();\r\n  } catch {\r\n    progress.xpUnlocked = false;\r\n  }\r\n\r\n  if (progress.xpUnlocked) {\r\n    try {\r\n      const state = typeof getXpState === 'function' ? getXpState() : null;\r\n      if (state && typeof state === 'object') {\r\n        progress.xpLevel = bigNumToSafeInteger(state.xpLevel);\r\n      }\r\n    } catch {\r\n      progress.xpLevel = 0;\r\n    }\r\n  }\r\n  \r\n  try {\r\n    progress.hasForgeReset = typeof hasDoneForgeReset === 'function' && hasDoneForgeReset();\r\n  } catch {\r\n    progress.hasForgeReset = false;\r\n  }\r\n  \r\n  return progress;\r\n}\r\n\r\nfunction resolveDialogueLock(meta, progress) {\r\n  let rawState;\r\n  try {\r\n    rawState = typeof meta.unlock === 'function' ? meta.unlock(progress) : true;\r\n  } catch {\r\n    rawState = false;\r\n  }\r\n\r\n  const rawObj = (rawState && typeof rawState === 'object') ? rawState : null;\r\n  let status = 'locked';\r\n\r\n  if (rawState === true) {\r\n    status = 'unlocked';\r\n  } else if (rawObj) {\r\n    const normalized = String(rawObj.status ?? '').toLowerCase();\r\n    if (normalized === 'unlocked' || rawObj.unlocked === true) {\r\n      status = 'unlocked';\r\n    } else if (normalized === 'mysterious') {\r\n      status = 'mysterious';\r\n    } else {\r\n      status = 'locked';\r\n    }\r\n  } else if (rawState === false || rawState == null) {\r\n    status = 'locked';\r\n  }\r\n\r\n  const info = {\r\n    status,\r\n    unlocked: status === 'unlocked',\r\n    title: status === 'unlocked' ? meta.title : '???',\r\n    blurb: status === 'unlocked'\r\n      ? meta.blurb\r\n      : (status === 'mysterious' ? DEFAULT_MYSTERIOUS_BLURB : DEFAULT_LOCKED_BLURB),\r\n    tooltip: '',\r\n    message: '',\r\n    icon: null,\r\n    headerTitle: null,\r\n    ariaLabel: '',\r\n  };\r\n\r\n  if (status === 'unlocked') {\r\n    info.ariaLabel = meta.title || 'Merchant dialogue';\r\n    return info;\r\n  }\r\n\r\ninfo.title = rawObj?.title ?? '???'\r\ninfo.blurb = rawObj?.requirement\r\n  ?? rawObj?.message\r\n  ?? rawObj?.tooltip\r\n  ?? (status === 'mysterious' ? DEFAULT_MYSTERIOUS_BLURB : DEFAULT_LOCKED_BLURB)\r\ninfo.tooltip = rawObj?.tooltip\r\n  ?? (status === 'locked' ? 'Locked Dialogue' : 'Hidden Dialogue');\r\n\r\ninfo.message = rawObj?.message ?? (status === 'mysterious' ? DEFAULT_LOCK_MESSAGE : '');\r\ninfo.icon = rawObj?.icon ?? (status === 'mysterious' ? MYSTERIOUS_ICON_SRC : null);\r\ninfo.headerTitle = rawObj?.headerTitle ?? (status === 'mysterious' ? HIDDEN_DIALOGUE_TITLE : LOCKED_DIALOGUE_TITLE);\r\ninfo.ariaLabel = rawObj?.ariaLabel ?? (status === 'mysterious'\r\n  ? 'Hidden merchant dialogue'\r\n  : 'Locked merchant dialogue');\r\n\r\n\r\n  return info;\r\n}\r\n\r\nfunction ensureProgressEvents() {\r\n  if (progressEventsBound) return;\r\n  progressEventsBound = true;\r\n\r\n  const handler = onProgressChanged;\r\n\r\n  if (typeof window !== 'undefined') {\r\n    window.addEventListener('xp:change', handler);\r\n    window.addEventListener('xp:unlock', handler);\r\n  }\r\n\r\n  document.addEventListener('ccc:upgrades:changed', handler);\r\n\r\n  const slot = getActiveSlot();\r\n  if (slot != null) {\r\n    const key = `${FORGE_COMPLETED_KEY_BASE}:${slot}`;\r\n    watchStorageKey(key, { onChange: handler });\r\n  }\r\n}\r\n\r\nfunction onProgressChanged() {\r\n  renderDialogueList();\r\n}\r\n\r\nfunction completeDialogueOnce(id, meta) {\r\n  const state = loadDlgState();\r\n  const k = String(id);\r\n  const prev = state[k] || {};\r\n\r\n  if (meta.once && prev.claimed) return false;\r\n\r\n  prev.claimed = true;\r\n  state[k] = prev;\r\n  saveDlgState(state);\r\n\r\n  grantReward(meta.reward);\r\n  return true;\r\n}\r\n\r\n\r\nfunction grantReward(reward) {\r\n  if (!reward) return;\r\n  if (reward.type === 'coins') {\r\n    try { bank.coins.add(reward.amount); } catch (e) {\r\n      console.warn('Failed to grant coin reward:', reward, e);\r\n    }\r\n    return;\r\n  }\r\n  if (reward.type === 'books') {\r\n    try {\r\n      bank.books.addWithMultiplier?.(reward.amount) ?? bank.books.add(reward.amount);\r\n    } catch (e) {\r\n      console.warn('Failed to grant book reward:', reward, e);\r\n    }\r\n    return;\r\n  }\r\n  try { window.dispatchEvent(new CustomEvent('merchantReward', { detail: reward })); } catch {}\r\n}\r\n\r\nfunction rewardLabel(reward) {\r\n  if (!reward) return '';\r\n  if (reward.type === 'coins') return `Reward: ${reward.amount} coins`;\r\n  if (reward.type === 'books') return `Reward: ${reward.amount} Books`;\r\n  return 'Reward available';\r\n}\r\n\r\nexport const DLG_CATALOG = {\r\n  1: {\r\n    title: 'A Generous Gift',\r\n    blurb: 'The Merchant is feeling extra nice today',\r\n    scriptId: 1,\r\n    reward: { type: 'coins', amount: 100 },\r\n    unlock: (progress) => true,\r\n    once: true,\r\n  },\r\n  2: {\r\n    title: 'A New Experience',\r\n    blurb: 'Discuss the XP system with the Merchant',\r\n    scriptId: 2,\r\n    reward: { type: 'books', amount: 5 },\r\n    once: true,\r\n    unlock: (progress) => {\r\n      if (!progress?.xpUnlocked) {\r\n        return {\r\n          status: 'mysterious',\r\n          requirement: 'Unlock the XP system to reveal this dialogue',\r\n          message: 'Unlock the XP system to reveal this dialogue',\r\n          icon: MYSTERIOUS_ICON_SRC,\r\n          headerTitle: HIDDEN_DIALOGUE_TITLE,\r\n          ariaLabel: 'Hidden merchant dialogue. Unlock the XP system to reveal this dialogue',\r\n        };\r\n      }\r\n      return true;\r\n    },\r\n  },\r\n  3: {\r\n    title: 'Edge of Mastery',\r\n    blurb: 'Placeholder musings earned through the Forge.',\r\n    scriptId: 3,\r\n    unlock: (progress) => {\r\n      if (progress?.hasForgeReset) {\r\n        return true;\r\n      }\r\n      if (!progress?.xpUnlocked || (progress?.xpLevel ?? 0) < 31) {\r\n        return {\r\n          status: 'locked',\r\n          title: '???',\r\n          blurb: DEFAULT_LOCKED_BLURB,\r\n          tooltip: 'Locked Dialogue',\r\n          ariaLabel: 'Locked Dialogue.',\r\n        };\r\n      }\r\n      return {\r\n        status: 'mysterious',\r\n        requirement: 'Do a Forge reset to reveal this dialogue',\r\n        message: 'Do a Forge reset to reveal this dialogue',\r\n        icon: MYSTERIOUS_ICON_SRC,\r\n        headerTitle: HIDDEN_DIALOGUE_TITLE,\r\n        ariaLabel: 'Hidden merchant dialogue. Do a Forge reset to reveal this dialogue',\r\n      };\r\n    },\r\n    once: false,\r\n  },\r\n};\r\n\r\nexport function loadDlgState() {\r\n  try { return JSON.parse(localStorage.getItem(sk(MERCHANT_DLG_STATE_KEY_BASE)) || '{}'); } catch { return {}; }\r\n}\r\n\r\nexport function saveDlgState(s) {\r\n  const key = sk(MERCHANT_DLG_STATE_KEY_BASE);\r\n  try {\r\n    const payload = JSON.stringify(s);\r\n    localStorage.setItem(key, payload);\r\n    try { primeStorageWatcherSnapshot(key, payload); } catch {}\r\n  } catch {}\r\n}\r\n\r\nfunction parseDlgStateRaw(raw) {\r\n  if (!raw) return {};\r\n  try { return JSON.parse(raw); } catch { return {}; }\r\n}\r\n\r\nfunction cleanupMerchantDlgStateWatcher() {\r\n  const stop = merchantDlgWatcherCleanup;\r\n  merchantDlgWatcherCleanup = null;\r\n  if (typeof stop === 'function') {\r\n    try { stop(); } catch {}\r\n  }\r\n}\r\n\r\nfunction handleMerchantDlgStateChange(_, meta = {}) {\r\n  if (!meta?.rawChanged) return;\r\n  renderDialogueList();\r\n}\r\n\r\nfunction bindMerchantDlgStateWatcherForSlot(slot) {\r\n  if (slot === merchantDlgWatcherSlot) return;\r\n  cleanupMerchantDlgStateWatcher();\r\n  merchantDlgWatcherSlot = slot ?? null;\r\n  if (slot == null) {\r\n    renderDialogueList();\r\n    return;\r\n  }\r\n  const storageKey = `${MERCHANT_DLG_STATE_KEY_BASE}:${slot}`;\r\n  merchantDlgWatcherCleanup = watchStorageKey(storageKey, {\r\n    parse: parseDlgStateRaw,\r\n    onChange: handleMerchantDlgStateChange,\r\n  });\r\n  try { primeStorageWatcherSnapshot(storageKey); } catch {}\r\n  renderDialogueList();\r\n}\r\n\r\nfunction ensureMerchantDlgStateWatcher() {\r\n  if (merchantDlgWatcherInitialized) {\r\n    bindMerchantDlgStateWatcherForSlot(getActiveSlot());\r\n    return;\r\n  }\r\n  merchantDlgWatcherInitialized = true;\r\n  bindMerchantDlgStateWatcherForSlot(getActiveSlot());\r\n  if (typeof window !== 'undefined') {\r\n    window.addEventListener('saveSlot:change', () => {\r\n      bindMerchantDlgStateWatcherForSlot(getActiveSlot());\r\n    });\r\n  }\r\n}\r\n\r\nensureMerchantDlgStateWatcher();\r\n\r\n// ----- Module state -----\r\nlet merchantOverlayEl = null;\r\nlet merchantSheetEl   = null;\r\nlet merchantCloseBtn  = null;\r\nlet merchantOpen      = false;\r\nlet merchantDrag      = null;\r\nlet merchantLastFocus = null;\r\nlet merchantEventsBound = false;\r\nlet merchantTabs = { buttons: {}, panels: {}, tablist: null };\r\n\r\n// ========================= Typing SFX (WebAudio, zero-latency, mobile volume) =========================\r\nconst TYPING_SFX_SOURCE = ['sounds/merchant_typing.mp3']; // ensure this asset exists\r\n\r\nlet __audioCtx = null;\r\nlet __typingGain = null;\r\nlet __typingBuffer = null;     // decoded buffer (once)\r\nlet __bufferLoadPromise = null;\r\n\r\nlet __typingSfx = null;        // fallback <audio> element\r\nlet __typingSource = null;     // MediaElementSource (once)\r\nlet __bufferSource = null;     // current BufferSource (recreated each start)\r\n\r\nlet __typingSfxPrimed = false;\r\nlet __isTypingActive  = false;\r\n\r\nfunction ensureAudioCtx() {\r\n  if (!__audioCtx) {\r\n    const Ctx = window.AudioContext || window.webkitAudioContext;\r\n    __audioCtx = new Ctx();\r\n  }\r\n  if (!__typingGain) {\r\n    __typingGain = __audioCtx.createGain();\r\n    __typingGain.gain.value = IS_MOBILE ? 0.15 : 0.3;  // mobile quieter\r\n    __typingGain.connect(__audioCtx.destination);\r\n  }\r\n}\r\n\r\nfunction pickSupportedSrc() { return TYPING_SFX_SOURCE[0]; }\r\n\r\nasync function loadTypingBuffer() {\r\n  ensureAudioCtx();\r\n  if (__typingBuffer) return __typingBuffer;\r\n  if (__bufferLoadPromise) return __bufferLoadPromise;\r\n\r\n  const url = pickSupportedSrc();\r\n  __bufferLoadPromise = (async () => {\r\n    const res = await fetch(url, { cache: 'force-cache' });\r\n    const arr = await res.arrayBuffer();\r\n    return await __audioCtx.decodeAudioData(arr);\r\n  })()\r\n  .then(buf => (__typingBuffer = buf))\r\n  .catch(err => { console.warn('Typing SFX decode failed:', err); __bufferLoadPromise = null; });\r\n\r\n  return __bufferLoadPromise;\r\n}\r\n\r\nfunction ensureTypingAudioElement() {\r\n  if (__typingSfx) return __typingSfx;\r\n  const a = new Audio();\r\n  a.loop = true;\r\n  a.preload = 'auto';\r\n  a.muted = false;\r\n  a.volume = 1.0; // iOS ignores this; gain node controls volume\r\n\r\n  const url = pickSupportedSrc();\r\n  a.src = url;\r\n\r\n  __typingSfx = a;\r\n  return a;\r\n}\r\n\r\nfunction ensureElementGraph() {\r\n  ensureAudioCtx();\r\n  ensureTypingAudioElement();\r\n  if (!__typingSource) {\r\n    __typingSource = __audioCtx.createMediaElementSource(__typingSfx);\r\n    __typingSource.connect(__typingGain);\r\n  }\r\n}\r\n\r\nexport function setTypingGainForDevice() {\r\n  if (!__typingGain) return;\r\n  __typingGain.gain.value = IS_MOBILE ? 0.15 : 0.3;\r\n}\r\n\r\n// Prime from a user gesture \u2014 silent, no AbortError spam\r\nexport function primeTypingSfx() {\r\n  if (__typingSfxPrimed) return;\r\n  __typingSfxPrimed = true;\r\n\r\n  ensureAudioCtx();\r\n  __audioCtx.resume().catch(()=>{});\r\n\r\n  // Kick off buffer decode early\r\n  loadTypingBuffer();\r\n\r\n  // Satisfy autoplay policies silently via element path\r\n  const a = ensureTypingAudioElement();\r\n  ensureElementGraph();\r\n\r\n  const prevLoop = a.loop;\r\n  const prevMuted = a.muted;\r\n  a.loop = false;\r\n  a.muted = true;\r\n\r\n  a.play()\r\n    .then(() => { a.pause(); a.currentTime = 0; })\r\n    .catch((err) => {\r\n      if (err.name !== 'AbortError') {\r\n        console.warn('Typing SFX prime error:', err);\r\n        __typingSfxPrimed = false;\r\n      }\r\n    })\r\n    .finally(() => { a.loop = prevLoop; a.muted = prevMuted; });\r\n}\r\n\r\nasync function startTypingSfx() {\r\n  ensureAudioCtx();\r\n  await __audioCtx.resume().catch(()=>{});\r\n\r\n  await loadTypingBuffer();\r\n\r\n  // Prefer zero-latency buffer path\r\n  if (__isTypingActive && __typingBuffer) {\r\n    if (__bufferSource) {\r\n      try { __bufferSource.stop(0); } catch {}\r\n      try { __bufferSource.disconnect(); } catch {}\r\n      __bufferSource = null;\r\n    }\r\n    __bufferSource = __audioCtx.createBufferSource();\r\n    __bufferSource.buffer = __typingBuffer;\r\n    __bufferSource.loop = true;\r\n    __bufferSource.connect(__typingGain);\r\n    __bufferSource.start(0);\r\n    return;\r\n  }\r\n\r\n  // Fallback element path (rare first-line race)\r\n  ensureElementGraph();\r\n  if (__isTypingActive && __typingSfx) {\r\n    __typingSfx.currentTime = 0;\r\n    try { await __typingSfx.play(); }\r\n    catch {\r\n      const once = () => { if (__isTypingActive) __typingSfx.play().catch(()=>{}); document.removeEventListener('click', once); };\r\n      document.addEventListener('click', once, { once: true });\r\n    }\r\n  }\r\n}\r\n\r\nfunction stopTypingSfx() {\r\n  if (__bufferSource) {\r\n    try { __bufferSource.stop(0); } catch {}\r\n    try { __bufferSource.disconnect(); } catch {}\r\n    __bufferSource = null;\r\n  }\r\n  if (__typingSfx) {\r\n    __typingSfx.pause();\r\n    __typingSfx.currentTime = 0;\r\n  }\r\n}\r\n\r\n// Keep gain correct if device/orientation changes\r\nwindow.matchMedia?.('(any-pointer: coarse)')?.addEventListener?.('change', setTypingGainForDevice);\r\nwindow.addEventListener('orientationchange', setTypingGainForDevice);\r\n\r\n// ========================= Typewriter =========================\r\nfunction typeText(el, full, msPerChar = 22, skipTargets = []) {\r\n  return new Promise((resolve) => {\r\n    let i = 0, skipping = false;\r\n    let armed = false;\r\n\r\n    __isTypingActive = true;\r\n    startTypingSfx();\r\n\r\n    const skip = (e) => { if (!armed) return; e.preventDefault(); skipping = true; };\r\n    const onKey = (e) => { if (!armed) return; if (e.key === 'Enter' || e.key === ' ') skipping = true; };\r\n\r\n    const targets = skipTargets.length ? skipTargets : [el];\r\n\r\n    requestAnimationFrame(() => {\r\n      armed = true;\r\n      targets.forEach(t => t.addEventListener('click', skip, { once: true }));\r\n      document.addEventListener('keydown', onKey, { once: true });\r\n    });\r\n\r\n    el.classList.add('is-typing');\r\n    el.textContent = '';\r\n\r\n    const cleanup = () => {\r\n      targets.forEach(t => t.removeEventListener('click', skip));\r\n      document.removeEventListener('keydown', onKey);\r\n      el.classList.remove('is-typing');\r\n      stopTypingSfx();\r\n      __isTypingActive = false;\r\n    };\r\n\r\n    const tick = () => {\r\n      if (skipping) { el.textContent = full; cleanup(); resolve(); return; }\r\n      el.textContent = full.slice(0, i++);\r\n      if (i <= full.length) setTimeout(tick, msPerChar);\r\n      else { cleanup(); resolve(); }\r\n    };\r\n    tick();\r\n  });\r\n}\r\n\r\n// ========================= DialogueEngine =========================\r\nclass DialogueEngine {\r\n  constructor({ textEl, choicesEl, skipTargets, onEnd }) {\r\n    this.textEl = textEl;\r\n    this.choicesEl = choicesEl;\r\n    this.skipTargets = skipTargets;\r\n    this.onEnd = onEnd || (() => {});\r\n    this.nodes = {};\r\n    this.current = null;\r\n\r\n    this.deferNextChoices = false;\r\n    this._reservedH = 0;\r\n  }\r\n\r\n  load(script) {\r\n    this.nodes = script.nodes || {};\r\n    this.startId = script.start;\r\n  }\r\n\r\n  async start() {\r\n    if (!this.startId) return;\r\n    await this.goto(this.startId);\r\n  }\r\n\r\n  async goto(id) {\r\n    const node = this.nodes[id];\r\n    if (!node) return;\r\n    this.current = id;\r\n\r\n    if (node.type === 'line') {\r\n      const nextNode = this.nodes[node.next];\r\n\r\n      // Pre-render next choices invisibly to reserve height (unless deferring)\r\n      if (!this.deferNextChoices && nextNode && nextNode.type === 'choice') {\r\n        this._renderChoices(nextNode.options || [], true);\r\n      } else {\r\n        this._hideChoices();\r\n      }\r\n\r\n      await typeText(this.textEl, node.say, node.msPerChar ?? 22, this.skipTargets);\r\n\r\n      if (nextNode && nextNode.type === 'choice') {\r\n        this.current = node.next;\r\n\r\n        if (this.deferNextChoices) {\r\n          this.deferNextChoices = false;\r\n          this._renderChoices(nextNode.options || [], false); // build & reveal now\r\n          this.choicesEl.style.minHeight = '';\r\n          return;\r\n        }\r\n\r\n        this._revealPreparedChoices();\r\n        return;\r\n      }\r\n\r\n      this.choicesEl.style.minHeight = '';\r\n      if (node.next === 'end' || node.end === true) return this.onEnd();\r\n      if (node.next) return this.goto(node.next);\r\n      return;\r\n    }\r\n\r\n    if (node.type === 'choice') {\r\n      this._renderChoices(node.options || [], false);\r\n    }\r\n  }\r\n\r\n  _hideChoices() {\r\n    this.choicesEl.classList.remove('is-visible');\r\n    this._applyInlineChoiceHide();\r\n  }\r\n\r\n  _renderChoices(options, prepare = false) {\r\n    this.choicesEl.innerHTML = '';\r\n    for (const opt of options) {\r\n      const btn = document.createElement('button');\r\n      btn.type = 'button';\r\n      btn.className = 'choice';\r\n      btn.textContent = opt.label;\r\n      bindRapidActivation(btn, async (event) => {\r\n        event?.stopPropagation?.();\r\n        this._reservedH = this.choicesEl.offsetHeight | 0;\r\n        this.choicesEl.style.minHeight = this._reservedH + 'px';\r\n        this._hideChoices();\r\n        this.choicesEl.innerHTML = '';\r\n\r\n        this.deferNextChoices = true;\r\n\r\n        if (opt.to === 'end') {\r\n          return this.onEnd({ noReward: false });\r\n        }\r\n        if (opt.to === 'end_nr') {\r\n          return this.onEnd({ noReward: true });\r\n        }\r\n\r\n        await this.goto(opt.to);\r\n      }, { once: true });\r\n      this.choicesEl.appendChild(btn);\r\n    }\r\n\r\n    if (prepare) {\r\n      this.choicesEl.classList.remove('is-visible');\r\n      this._applyInlineChoiceHide();\r\n      return;\r\n    }\r\n    this._clearInlineChoiceHide();\r\n    requestAnimationFrame(() => this.choicesEl.classList.add('is-visible'));\r\n  }\r\n\r\n  _revealPreparedChoices() {\r\n    this._clearInlineChoiceHide();\r\n    requestAnimationFrame(() => this.choicesEl.classList.add('is-visible'));\r\n  }\r\n\r\n  _applyInlineChoiceHide() {\r\n    this.choicesEl.style.opacity = '0';\r\n    this.choicesEl.style.transform = 'translateY(6px)';\r\n    this.choicesEl.style.pointerEvents = 'none';\r\n  }\r\n\r\n  _clearInlineChoiceHide() {\r\n    this.choicesEl.style.opacity = '';\r\n    this.choicesEl.style.transform = '';\r\n    this.choicesEl.style.pointerEvents = '';\r\n  }\r\n}\r\n\r\nfunction openDialogueLockInfo(lockInfo = {}) {\r\n  if (!merchantOverlayEl) return;\r\n\r\n  primeTypingSfx();\r\n\r\n  const overlay = document.createElement('div');\r\n  overlay.className = 'merchant-firstchat merchant-lockinfo';\r\n  overlay.setAttribute('data-dismissible', '1');\r\n  overlay.innerHTML = `<div class=\"merchant-firstchat__card\" role=\"dialog\" aria-label=\"${lockInfo.ariaLabel || HIDDEN_DIALOGUE_TITLE}\"><div class=\"merchant-firstchat__header\"><div class=\"name\"></div><div class=\"rule\" aria-hidden=\"true\"></div></div><div class=\"merchant-firstchat__row merchant-lockinfo__row\"><img class=\"merchant-firstchat__icon\" src=\"${lockInfo.icon || MYSTERIOUS_ICON_SRC}\" alt=\"\"><div class=\"merchant-firstchat__text merchant-lockinfo__message\"></div></div><div class=\"merchant-firstchat__actions merchant-lockinfo__actions\"><button type=\"button\" class=\"merchant-firstchat__continue merchant-lockinfo__close\">Close</button></div></div>`;\r\n\r\n  merchantOverlayEl.appendChild(overlay);\r\n\r\n  const cardEl = overlay.querySelector('.merchant-firstchat__card');\r\n  const nameEl = overlay.querySelector('.merchant-firstchat__header .name');\r\n  const messageEl = overlay.querySelector('.merchant-lockinfo__message');\r\n  const closeBtn = overlay.querySelector('.merchant-lockinfo__close');\r\n\r\n  nameEl.textContent = lockInfo.headerTitle || HIDDEN_DIALOGUE_TITLE;\r\n  messageEl.textContent = lockInfo.message || DEFAULT_LOCK_MESSAGE;\r\n\r\n  requestAnimationFrame(() => overlay.classList.add('is-visible'));\r\n  merchantOverlayEl.classList.add('firstchat-active');\r\n\r\n  let closed = false;\r\n\r\n  const close = () => {\r\n    if (closed) return;\r\n    closed = true;\r\n    overlay.classList.remove('is-visible');\r\n    merchantOverlayEl.classList.remove('firstchat-active');\r\n    stopTypingSfx();\r\n    __isTypingActive = false;\r\n    document.removeEventListener('keydown', onEsc, true);\r\n    setTimeout(() => overlay.remove(), 160);\r\n  };\r\n\r\n  const onEsc = (e) => {\r\n    if (e.key !== 'Escape') return;\r\n    e.preventDefault();\r\n    close();\r\n  };\r\n\r\n  document.addEventListener('keydown', onEsc, true);\r\n\r\noverlay.addEventListener('pointerdown', (e) => {\r\n  if (!cardEl.contains(e.target)) {\r\n    // Don\u2019t arm global ghost guard for background taps \u2014 just shield briefly\r\n    e.preventDefault();\r\n    blockInteraction(160);\r\n    close();\r\n  }\r\n});\r\n\r\nconst doCloseFromBtn = (e) => {\r\n  if (!e || e.pointerType !== 'mouse') blockInteraction(160);\r\n  close();\r\n};\r\n\r\n  bindRapidActivation(closeBtn, () => { doCloseFromBtn(); }, { once: true });\r\n\r\n  closeBtn.focus?.();\r\n}\r\n\r\nfunction openDialogueModal(id, meta) {\r\n  primeTypingSfx();\r\n\r\n  const overlay = document.createElement('div');\r\n  overlay.className = 'merchant-firstchat';\r\n  overlay.setAttribute('data-dismissible', '1');\r\n  overlay.innerHTML = `<div class=\"merchant-firstchat__card\" role=\"dialog\" aria-label=\"${meta.title}\"><div class=\"merchant-firstchat__header\"><div class=\"name\">Merchant</div><div class=\"rule\" aria-hidden=\"true\"></div></div><div class=\"merchant-firstchat__row\"><img class=\"merchant-firstchat__icon\" src=\"${MERCHANT_ICON_SRC}\" alt=\"\"><div class=\"merchant-firstchat__text\">\u2026</div></div><div class=\"merchant-firstchat__choices\"></div></div>`;\r\n  merchantOverlayEl.appendChild(overlay);\r\nconst onEscToCancel = (e) => {\r\n  if (e.key !== 'Escape') return;\r\n  if (!overlay.isConnected) return;\r\n  cancelWithoutReward();\r\n};\r\n\r\ndocument.addEventListener('keydown', onEscToCancel, { capture: true });\r\n\r\n\r\n  // fade/blur in (same behavior as first meet)\r\n  requestAnimationFrame(() => overlay.classList.add('is-visible'));\r\n  merchantOverlayEl.classList.add('firstchat-active');\r\n\r\n  // local refs\r\n  const textEl    = overlay.querySelector('.merchant-firstchat__text');\r\n  const rowEl     = overlay.querySelector('.merchant-firstchat__row');\r\n  const cardEl    = overlay.querySelector('.merchant-firstchat__card');\r\n  const choicesEl = overlay.querySelector('.merchant-firstchat__choices');\r\n\r\n  let ended = false;\r\n\r\n  // Close helpers \u2014 end (with reward) vs cancel (no reward)\r\n  const closeModal = () => {\r\n\tdocument.removeEventListener('keydown', onEscToCancel, { capture: true });\r\n    overlay.classList.remove('is-visible');\r\n    merchantOverlayEl.classList.remove('firstchat-active');\r\n    stopTypingSfx();\r\n    __isTypingActive = false;\r\n    // small delay to let fade finish\r\n    setTimeout(() => overlay.remove(), 160);\r\n  };\r\n\r\n  const cancelWithoutReward = () => {\r\n    if (ended) return;\r\n    ended = true;\r\n    closeModal();               // no reward\r\n    renderDialogueList();       // refresh UI state\r\n  };\r\n\r\noverlay.addEventListener('pointerdown', (e) => {\r\n  if (!cardEl.contains(e.target)) {\r\n    e.preventDefault();\r\n    if (e.pointerType !== 'mouse') blockInteraction(160);\r\n    cancelWithoutReward();\r\n  }\r\n});\r\n\r\nconst engine = new DialogueEngine({\r\n  textEl,\r\n  choicesEl,\r\n  skipTargets: [textEl, rowEl, cardEl],\r\n  onEnd: (info) => {\r\n    if (ended) return;\r\n    ended = true;\r\n\r\n    if (info && info.noReward) {\r\n      closeModal();\r\n      renderDialogueList();\r\n      return;\r\n    }\r\n\r\n    completeDialogueOnce(id, meta);\r\n    closeModal();\r\n    renderDialogueList();\r\n  }\r\n});\r\n\r\n  const state = loadDlgState();\r\n  const claimed = !!state[id]?.claimed;\r\n\r\n  const script = structuredClone(MERCHANT_DIALOGUES[meta.scriptId]);\r\n\r\n  if (claimed && script.nodes.m2b && script.nodes.c2a && meta.scriptId === 1) {\r\n    script.nodes.m2b.say = 'I\\'ve already given you Coins, goodbye.';\r\n    script.nodes.c2a.options = [\r\n      { label: 'Goodbye.', to: 'end_nr' },\r\n      { label: 'Goodbye.', to: 'end_nr' },\r\n      { label: 'Goodbye.', to: 'end_nr' },\r\n    ];\r\n  }\r\n\r\n  if (claimed && meta.scriptId === 2 && script.nodes.m2a) {\r\n    script.nodes.m2a.say = 'I\\'ve already given you Books, goodbye.';\r\n\tif (script.nodes.c2a) {\r\n      script.nodes.c2a.options = [\r\n        { label: 'Goodbye.', to: 'end_nr' },\r\n        { label: 'Goodbye.', to: 'end_nr' },\r\n        { label: 'Goodbye.', to: 'end_nr' },\r\n      ];\r\n    }\r\n  }\r\n\r\n  engine.load(script);\r\n  engine.start();\r\n}\r\n\r\n// ========================= Merchant Overlay (Delve) =========================\r\nfunction ensureMerchantScrollbar() {\r\n  const scroller = merchantOverlayEl?.querySelector('.merchant-content');\r\n  if (!scroller || scroller.__customScroll) return;\r\n  if (!merchantSheetEl) return;\r\n\r\n  const bar = document.createElement('div');\r\n  bar.className = 'merchant-scrollbar';\r\n  const thumb = document.createElement('div');\r\n  thumb.className = 'merchant-scrollbar__thumb';\r\n  bar.appendChild(thumb);\r\n  merchantSheetEl.appendChild(bar);\r\n\r\n  const isTouch = window.matchMedia?.('(hover: none) and (pointer: coarse)')?.matches;\r\n  const FADE_SCROLL_MS = 150;\r\n  const FADE_DRAG_MS = 120;\r\n  const supportsScrollEnd = 'onscrollend' in window;\r\n  let fadeTimer = null;\r\n\r\n  const syncScrollShadow = () => {\r\n    const hasShadow = (scroller.scrollTop || 0) > 0;\r\n    merchantSheetEl?.classList.toggle('has-scroll-shadow', hasShadow);\r\n  };\r\n\r\n  const updateBounds = () => {\r\n    const grabber = merchantOverlayEl.querySelector('.merchant-grabber');\r\n    const header  = merchantOverlayEl.querySelector('.merchant-header');\r\n    const actions = merchantOverlayEl.querySelector('.merchant-actions');\r\n\r\n    const top = ((grabber?.offsetHeight || 0) + (header?.offsetHeight || 0)) | 0;\r\n    const bottom = (actions?.offsetHeight || 0) | 0;\r\n\r\n    bar.style.top = top + 'px';\r\n    bar.style.bottom = bottom + 'px';\r\n  };\r\n\r\n  const updateThumb = () => {\r\n    const { scrollHeight, clientHeight, scrollTop } = scroller;\r\n    const barH = bar.clientHeight || 1;\r\n\r\n    const visibleRatio = clientHeight / Math.max(1, scrollHeight);\r\n    const thumbH = Math.max(28, Math.round(barH * visibleRatio));\r\n\r\n    const maxScroll = Math.max(1, scrollHeight - clientHeight);\r\n    const range = Math.max(0, barH - thumbH);\r\n    const y = Math.round((scrollTop / maxScroll) * range);\r\n\r\n    thumb.style.height = thumbH + 'px';\r\n    thumb.style.transform = `translateY(${y}px)`;\r\n\r\n    bar.style.display = (scrollHeight <= clientHeight + 1) ? 'none' : '';\r\n  };\r\n\r\n  const updateAll = () => {\r\n    updateBounds();\r\n    updateThumb();\r\n    syncScrollShadow();\r\n  };\r\n\r\n  const showBar = () => {\r\n    if (!isTouch) return;\r\n    merchantSheetEl.classList.add('is-scrolling');\r\n    if (fadeTimer) clearTimeout(fadeTimer);\r\n  };\r\n\r\n  const scheduleHide = (delay) => {\r\n    if (!isTouch) return;\r\n    if (fadeTimer) clearTimeout(fadeTimer);\r\n    fadeTimer = setTimeout(() => {\r\n      merchantSheetEl.classList.remove('is-scrolling');\r\n    }, delay);\r\n  };\r\n\r\n  const onScroll = () => {\r\n    updateThumb();\r\n    syncScrollShadow();\r\n    if (isTouch) showBar();\r\n    if (!supportsScrollEnd) scheduleHide(FADE_SCROLL_MS);\r\n  };\r\n\r\n  const onScrollEnd = () => scheduleHide(FADE_SCROLL_MS);\r\n\r\n  scroller.addEventListener('scroll', onScroll, { passive: true });\r\n  if (supportsScrollEnd) {\r\n    scroller.addEventListener('scrollend', onScrollEnd, { passive: true });\r\n  }\r\n\r\n  const ro = new ResizeObserver(updateAll);\r\n  ro.observe(scroller);\r\n  window.addEventListener('resize', updateAll);\r\n  requestAnimationFrame(updateAll);\r\n\r\n  // ----- Drag thumb to scroll -----\r\n  let dragging = false;\r\n  let dragStartY = 0;\r\n  let startScrollTop = 0;\r\n\r\n  const startDrag = (e) => {\r\n    dragging = true;\r\n    dragStartY = e.clientY;\r\n    startScrollTop = scroller.scrollTop;\r\n    thumb.classList.add('dragging');\r\n    showBar();\r\n    try { thumb.setPointerCapture(e.pointerId); } catch {}\r\n    e.preventDefault();\r\n  };\r\n\r\n  const onDragMove = (e) => {\r\n    if (!dragging) return;\r\n    const barH = bar.clientHeight || 1;\r\n    const thH = thumb.clientHeight || 1;\r\n    const range = Math.max(1, barH - thH);\r\n    const scrollMax = Math.max(1, scroller.scrollHeight - scroller.clientHeight);\r\n    const deltaY = e.clientY - dragStartY;\r\n    const scrollDelta = (deltaY / range) * scrollMax;\r\n    scroller.scrollTop = startScrollTop + scrollDelta;\r\n  };\r\n\r\n  const endDrag = (e) => {\r\n    if (!dragging) return;\r\n    dragging = false;\r\n    thumb.classList.remove('dragging');\r\n    scheduleHide(FADE_DRAG_MS);\r\n    try { thumb.releasePointerCapture(e.pointerId); } catch {}\r\n  };\r\n\r\n  thumb.addEventListener('pointerdown', startDrag);\r\n  window.addEventListener('pointermove', onDragMove, { passive: true });\r\n  window.addEventListener('pointerup', endDrag);\r\n  window.addEventListener('pointercancel', endDrag);\r\n\r\n  // Click track to jump\r\n  bar.addEventListener('pointerdown', (e) => {\r\n    if (e.target === thumb) return;\r\n    const rect = bar.getBoundingClientRect();\r\n    const clickY = e.clientY - rect.top;\r\n\r\n    const barH = bar.clientHeight || 1;\r\n    const thH = thumb.clientHeight || 1;\r\n    const range = Math.max(0, barH - thH);\r\n    const targetY = Math.max(0, Math.min(clickY - thH / 2, range));\r\n\r\n    const scrollMax = Math.max(1, scroller.scrollHeight - scroller.clientHeight);\r\n    scroller.scrollTop = (targetY / Math.max(1, range)) * scrollMax;\r\n\r\n    showBar();\r\n    scheduleHide(FADE_SCROLL_MS);\r\n  });\r\n\r\n  // mark so we don't double-init\r\n  scroller.__customScroll = { bar, thumb, ro, updateAll };\r\n}\r\n\r\nfunction ensureMerchantOverlay() {\r\n  if (merchantOverlayEl) return;\r\n\r\n  merchantOverlayEl = document.createElement('div');\r\n  merchantOverlayEl.className = 'merchant-overlay';\r\n  merchantOverlayEl.id = 'merchant-overlay';\r\n  merchantOverlayEl.setAttribute('inert', '');\r\n\r\n  merchantSheetEl = document.createElement('div');\r\n  merchantSheetEl.className = 'merchant-sheet';\r\n  merchantSheetEl.setAttribute('role', 'dialog');\r\n  merchantSheetEl.setAttribute('aria-modal', 'false');\r\n  merchantSheetEl.setAttribute('aria-label', 'Merchant');\r\n\r\n  const grabber = document.createElement('div');\r\n  grabber.className = 'merchant-grabber';\r\n  grabber.innerHTML = `<div class=\"grab-handle\" aria-hidden=\"true\"></div>`;\r\n\r\n  const header = document.createElement('header');\r\n  header.className = 'merchant-header';\r\n  header.innerHTML = `<div class=\"merchant-title\">Merchant</div><div class=\"merchant-line\" aria-hidden=\"true\"></div>`;\r\n\r\n  const content = document.createElement('div');\r\n  content.className = 'merchant-content';\r\n\r\n  const tabs = document.createElement('div');\r\n  tabs.className = 'merchant-tabs';\r\n  tabs.setAttribute('role', 'tablist');\r\n\r\n  const panelsWrap = document.createElement('div');\r\n  panelsWrap.className = 'merchant-panels';\r\n\r\n  const panelDialogue = document.createElement('section');\r\n  panelDialogue.className = 'merchant-panel is-active';\r\n  panelDialogue.id = 'merchant-panel-dialogue';\r\n\r\n  const panelReset = document.createElement('section');\r\n  panelReset.className = 'merchant-panel';\r\n  panelReset.id = 'merchant-panel-reset';\r\n\r\n  const panelMinigames = document.createElement('section');\r\n  panelMinigames.className = 'merchant-panel';\r\n  panelMinigames.id = 'merchant-panel-minigames';\r\n\r\n  const resetUnlocked = (() => {\r\n    try { return !!isForgeUnlocked?.(); }\r\n    catch { return false; }\r\n  })();\r\n  merchantTabUnlockState.set('reset', resetUnlocked);\r\n\r\n  MERCHANT_TABS_DEF.forEach(def => {\r\n    if (def.key === 'dialogue') merchantTabUnlockState.set('dialogue', true);\r\n    const stored = merchantTabUnlockState.get(def.key);\r\n    const unlocked = stored != null ? stored : !!def.unlocked;\r\n    const btn = document.createElement('button');\r\n    btn.type = 'button';\r\n    btn.className = 'merchant-tab';\r\n    btn.dataset.tab = def.key;\r\n    const lockedLabel = def.lockedLabel || '???';\r\n    btn.textContent = unlocked ? def.label : lockedLabel;\r\n      if (!unlocked) {\r\n        btn.classList.add('is-locked');\r\n        btn.disabled = true;\r\n        btn.title = '???';\r\n      } else {\r\n      btn.title = def.label || 'Tab';\r\n    }\r\n    def.unlocked = unlocked;\r\n    merchantTabUnlockState.set(def.key, unlocked);\r\n    bindRapidActivation(btn, (event) => {\r\n      if (btn.disabled) {\r\n        event?.preventDefault?.();\r\n        return;\r\n      }\r\n      selectMerchantTab(def.key);\r\n    });\r\n\r\n    tabs.appendChild(btn);\r\n    merchantTabs.buttons[def.key] = btn;\r\n  });\r\n\r\n  merchantTabs.panels['dialogue']  = panelDialogue;\r\n  merchantTabs.panels['reset']     = panelReset;\r\n  merchantTabs.panels['minigames'] = panelMinigames;\r\n  merchantTabs.tablist = tabs;\r\n\r\n  panelsWrap.append(panelDialogue, panelReset, panelMinigames);\r\n  content.append(tabs, panelsWrap);\r\n\r\n  try { initResetSystem(); } catch {}\r\n  try { initResetPanel(panelReset); } catch {}\r\n  try { updateResetPanel(); } catch {}\r\n  try {\r\n    if (isForgeUnlocked?.()) {\r\n      unlockMerchantTabs(['reset']);\r\n    }\r\n  } catch {}\r\n\r\n    const actions = document.createElement('div');\r\n    actions.className = 'merchant-actions';\r\n    const closeBtn = document.createElement('button');\r\n    closeBtn.type = 'button';\r\n    closeBtn.className = 'merchant-close';\r\n    closeBtn.textContent = 'Close';\r\n    merchantCloseBtn = closeBtn;\r\n    actions.appendChild(closeBtn);\r\n\r\n  // First-time chat overlay\r\n  const firstChat = document.createElement('div');\r\n  firstChat.className = 'merchant-firstchat merchant-firstchat--initial';\r\n  firstChat.innerHTML = `<div class=\"merchant-firstchat__card\" role=\"dialog\" aria-label=\"First chat\"><div class=\"merchant-firstchat__header\"><div class=\"name\">Merchant</div><div class=\"rule\" aria-hidden=\"true\"></div></div><div class=\"merchant-firstchat__row\"><img class=\"merchant-firstchat__icon\" src=\"${MERCHANT_ICON_SRC}\" alt=\"\"><div class=\"merchant-firstchat__text\" id=\"merchant-first-line\">\u2026</div></div><div class=\"merchant-firstchat__choices\" id=\"merchant-first-choices\"></div></div>`;\r\n\r\n  merchantSheetEl.append(grabber, header, content, actions, firstChat);\r\n  merchantOverlayEl.appendChild(merchantSheetEl);\r\n  document.body.appendChild(merchantOverlayEl);\r\n  initDialogueTab();\r\n  ensureMerchantScrollbar();\r\n\r\n  if (!merchantEventsBound) {\r\n    merchantEventsBound = true;\r\n\r\n    const onCloseClick = () => { closeMerchant(); };\r\n\r\n    bindRapidActivation(closeBtn, onCloseClick, { once: false });\r\n    document.addEventListener('keydown', onKeydownForMerchant);\r\n    grabber.addEventListener('pointerdown', onMerchantDragStart);\r\n    grabber.addEventListener('touchstart', (e) => e.preventDefault(), { passive: false });\r\n\r\n    // Allow priming via any pointer in the overlay (mobile-safe)\r\n    merchantOverlayEl.addEventListener('pointerdown', primeTypingSfx, { once: true });\r\n  }\r\n}\r\n\r\n// Called once when Merchant overlay is created\r\nfunction initDialogueTab() {\r\n  const panel = document.getElementById('merchant-panel-dialogue');\r\n  if (!panel || panel.__dlgInit) return;\r\n  panel.__dlgInit = true;\r\n\r\n  const list = document.createElement('div');\r\n  list.className = 'merchant-dialogue-list';\r\n  panel.appendChild(list);\r\n\r\n  panel.__dlgList = list;\r\n  ensureProgressEvents();\r\n  renderDialogueList();\r\n}\r\n\r\nfunction renderDialogueList() {\r\n  const panel = document.getElementById('merchant-panel-dialogue');\r\n  if (!panel) return;\r\n\r\n  const list = panel.__dlgList;\r\n  if (!list) return;\r\n\r\n  const progress = getPlayerProgress();\r\n  const state = loadDlgState();\r\n  let stateDirty = false;\r\n\r\n  list.innerHTML = '';\r\n\r\n  Object.entries(DLG_CATALOG).forEach(([id, meta]) => {\r\n    const entryState = state[id] || {};\r\n    const storedStatus = entryState.status || 'locked';\r\n    const storedRank = dialogueStatusRank(storedStatus);\r\n\r\n    let lockInfo = resolveDialogueLock(meta, progress);\r\n    let status = lockInfo.status;\r\n    let rank = dialogueStatusRank(status);\r\n\r\n    if (rank > storedRank) {\r\n      entryState.status = status;\r\n      if (status === 'mysterious') {\r\n        entryState.lockSnapshot = snapshotLockDisplay(lockInfo);\r\n      } else if (status === 'unlocked') {\r\n        delete entryState.lockSnapshot;\r\n      }\r\n      state[id] = entryState;\r\n      stateDirty = true;\r\n    } else if (rank < storedRank) {\r\n      if (storedStatus === 'unlocked') {\r\n        lockInfo = buildUnlockedDialogueInfo(meta);\r\n        status = 'unlocked';\r\n        rank = dialogueStatusRank(status);\r\n      } else if (storedStatus === 'mysterious') {\r\n        const snapshot = entryState.lockSnapshot || snapshotLockDisplay(lockInfo) || {};\r\n        lockInfo = {\r\n          status: 'mysterious',\r\n          unlocked: false,\r\n          title: snapshot.title ?? lockInfo.title ?? '???',\r\n          blurb: snapshot.blurb ?? lockInfo.blurb ?? DEFAULT_MYSTERIOUS_BLURB,\r\n          tooltip: snapshot.tooltip ?? lockInfo.tooltip ?? 'Hidden Dialogue',\r\n          message: snapshot.message ?? lockInfo.message ?? DEFAULT_LOCK_MESSAGE,\r\n          icon: snapshot.icon ?? lockInfo.icon ?? MYSTERIOUS_ICON_SRC,\r\n          headerTitle: snapshot.headerTitle ?? lockInfo.headerTitle ?? HIDDEN_DIALOGUE_TITLE,\r\n          ariaLabel: snapshot.ariaLabel ?? lockInfo.ariaLabel ?? 'Hidden merchant dialogue',\r\n        };\r\n        status = 'mysterious';\r\n        rank = dialogueStatusRank(status);\r\n      }\r\n    }\r\n\r\n    const unlocked = status === 'unlocked';\r\n    const isMysterious = status === 'mysterious';\r\n    const locked = status === 'locked';\r\n    const claimed = !!entryState.claimed;\r\n    const showComplete = unlocked && !!(meta.once && claimed);\r\n\r\n    const card = document.createElement('button');\r\n    card.type = 'button';\r\n    card.className = 'dlg-card';\r\n    card.dataset.dlgStatus = status;\r\n    card.disabled = !!locked;\r\n\r\n    if (locked) {\r\n      card.classList.add('is-locked');\r\n      card.setAttribute('aria-disabled', 'true');\r\n      card.setAttribute('tabindex', '-1');\r\n    } else {\r\n      card.removeAttribute('aria-disabled');\r\n      card.removeAttribute('tabindex');\r\n    }\r\n\r\n    if (isMysterious) {\r\n      card.classList.add('is-mysterious');\r\n    }\r\n\r\n    const title = document.createElement('div');\r\n    title.className = 'dlg-title';\r\n    title.textContent = unlocked ? meta.title : (lockInfo.title ?? '???');\r\n\r\n    const blurb = document.createElement('div');\r\n    blurb.className = 'dlg-blurb';\r\n    blurb.textContent = unlocked ? meta.blurb : (lockInfo.blurb ?? '');\r\n\r\n    const reward = document.createElement('div');\r\n    reward.className = 'dlg-reward';\r\n\r\n    const iconSrc = REWARD_ICON_SRC[meta.reward?.type];\r\n\r\n    if (iconSrc) {\r\n        reward.classList.add('has-reward');\r\n\r\n        reward.innerHTML = `<span class=\"reward-label\">Reward:</span><span class=\"reward-chunk\" style=\"--reward-icon: url('${iconSrc}')\"><span class=\"reward-icon\" aria-hidden=\"true\"></span><span class=\"amt\">${meta.reward.amount}</span></span>`;\r\n\t\r\n        reward.setAttribute(\r\n            'aria-label',\r\n\t\t\t`Reward: ${meta.reward.amount} ${meta.reward.type}`);\r\n    } else if (meta.reward) {\r\n        reward.textContent = rewardLabel(meta.reward);\r\n    } else {\r\n        reward.textContent = '';\r\n    }\r\n\r\n    const ariaLabel = unlocked\r\n      ? `${meta.title}${showComplete ? ' (completed)' : ''}`\r\n      : (lockInfo.ariaLabel || (isMysterious ? 'Hidden merchant dialogue' : 'Locked merchant dialogue'));\r\n    card.setAttribute('aria-label', ariaLabel);\r\n\r\n    if (lockInfo.tooltip) {\r\n      card.title = lockInfo.tooltip;\r\n    } else if (unlocked) {\r\n      card.title = 'Left-click: Start Dialogue';\r\n    } else {\r\n      card.removeAttribute('title');\r\n    }\r\n\r\n    card.append(title, blurb, reward);\r\n\r\n    if (showComplete) {\r\n      card.classList.add('is-complete');\r\n      const again = document.createElement('div');\r\n      again.className = 'dlg-again';\r\n      again.textContent = 'Ask Again?';\r\n      card.classList.add('has-again');\r\n      card.append(again);\r\n    }\r\n\r\n    list.appendChild(card);\r\n\r\n    const handleCardClick = (event) => {\r\n      if (card.classList.contains('is-locked') && !isMysterious) {\r\n        event?.preventDefault?.();\r\n        return;\r\n      }\r\n      if (unlocked) {\r\n        openDialogueModal(id, meta);\r\n      } else if (isMysterious) {\r\n        openDialogueLockInfo(lockInfo);\r\n      }\r\n    };\r\n\r\n    if (unlocked || isMysterious) {\r\n      bindRapidActivation(card, handleCardClick);\r\n    }\r\n  });\r\n\r\n  if (stateDirty) {\r\n    saveDlgState(state);\r\n  }\r\n}\r\n\r\n// Runs a conversation inside the Dialogue tab (not the first-time overlay)\r\nfunction startConversation(id, meta) {\r\n  const panel = document.getElementById('merchant-panel-dialogue');\r\n  if (!panel) return;\r\n\r\n  const textEl = panel.querySelector('.merchant-text');     // from your bubble\r\n  const bubble = panel.querySelector('.merchant-bubble');\r\n  const row = panel;                                        // big tap target\r\n  let choicesEl = panel.querySelector('.merchant-choices');\r\n\r\n  // Ensure blank + hide choices before typing\r\n  choicesEl.classList.remove('is-visible');\r\n  choicesEl.innerHTML = '';\r\n\r\n  const engine = new DialogueEngine({\r\n    textEl,\r\n    choicesEl,\r\n    skipTargets: [textEl, row, bubble],\r\n    onEnd: (info) => {\r\n\t  if (info && info.noReward) {\r\n        textEl.textContent = '\u2026';\r\n        renderDialogueList();\r\n        return;\r\n      }\r\n      completeDialogueOnce(id, meta);\r\n\ttextEl.textContent = '\u2026';\r\n\trenderDialogueList();\r\n\t}\r\n  });\r\n\r\n  const script = MERCHANT_DIALOGUES[meta.scriptId];\r\n  engine.load(script);\r\n  engine.start();\r\n}\r\n\r\nfunction runFirstMeet() {\r\n  const fc = merchantOverlayEl.querySelector('.merchant-firstchat');\r\n  const textEl = fc.querySelector('#merchant-first-line');\r\n  const rowEl  = fc.querySelector('.merchant-firstchat__row');\r\n  const cardEl = fc.querySelector('.merchant-firstchat__card');\r\n  const choicesEl = fc.querySelector('#merchant-first-choices');\r\n\r\n  const engine = new DialogueEngine({\r\n    textEl,\r\n    choicesEl,\r\n    skipTargets: [textEl, rowEl, cardEl],\r\n    onEnd: () => {\r\n      try { localStorage.setItem(sk(MERCHANT_MET_KEY_BASE), '1'); } catch {}\r\n      try { window.dispatchEvent(new Event(MERCHANT_MET_EVENT)); } catch {}\r\n      fc.classList.remove('is-visible');\r\n      merchantOverlayEl.classList.remove('firstchat-active');\r\n    }\r\n  });\r\n\r\n  engine.load(MERCHANT_DIALOGUES[0]);\r\n  engine.start();\r\n}\r\n\r\nfunction resetFirstChatOverlayState() {\r\n  if (!merchantOverlayEl) return;\r\n  const fc = merchantOverlayEl.querySelector('.merchant-firstchat--initial');\r\n  if (!fc) return;\r\n\r\n  fc.classList.remove('is-visible');\r\n\r\n  const textEl = fc.querySelector('#merchant-first-line');\r\n  if (textEl) {\r\n    textEl.classList.remove('is-typing');\r\n    textEl.textContent = '\u2026';\r\n  }\r\n\r\n  const choicesEl = fc.querySelector('#merchant-first-choices');\r\n  if (choicesEl) {\r\n    choicesEl.classList.remove('is-visible');\r\n    choicesEl.style.opacity = '0';\r\n    choicesEl.style.transform = 'translateY(6px)';\r\n    choicesEl.style.pointerEvents = 'none';\r\n    choicesEl.style.minHeight = '';\r\n    choicesEl.innerHTML = '';\r\n  }\r\n\r\n  merchantOverlayEl.classList.remove('firstchat-active');\r\n}\r\n\r\nexport function openMerchant() {\r\n  ensureMerchantOverlay();\r\n  if (merchantOpen) return;\r\n\r\n  const activeEl = document.activeElement;\r\n  if (activeEl instanceof HTMLElement && !merchantOverlayEl.contains(activeEl)) {\r\n    merchantLastFocus = activeEl;\r\n  } else {\r\n    merchantLastFocus = null;\r\n  }\r\n  merchantOpen = true;\r\n\r\n  // Check whether this is the very first time we\u2019re meeting the Merchant\r\n  let met = false;\r\n  try {\r\n    met = localStorage.getItem(sk(MERCHANT_MET_KEY_BASE)) === '1';\r\n  } catch {\r\n    met = false;\r\n  }\r\n\r\n  // For the very first chat, pin the sheet in place (no slide-up animation)\r\n  if (!met) {\r\n    merchantOverlayEl.classList.add('firstchat-instant');\r\n  }\r\n\r\n  // Reset transform and transition\r\n  merchantSheetEl.style.transition = 'none';\r\n  merchantSheetEl.style.transform = '';\r\n  merchantOverlayEl.removeAttribute('inert');\r\n\r\n  // Animate in next frame\r\n  void merchantSheetEl.offsetHeight;\r\n  requestAnimationFrame(() => {\r\n    // Only restore the sheet transition for normal opens\r\n    if (!merchantOverlayEl.classList.contains('firstchat-instant')) {\r\n      merchantSheetEl.style.transition = '';\r\n    }\r\n\r\n    merchantOverlayEl.classList.add('is-open');\r\n    blockInteraction(140);\r\n\r\n    if (merchantCloseBtn && typeof merchantCloseBtn.focus === 'function') {\r\n      try { merchantCloseBtn.focus({ preventScroll: true }); } catch {}\r\n    }\r\n\r\n    // Restore last tab\r\n    let last = 'dialogue';\r\n    try { last = localStorage.getItem(sk(MERCHANT_TAB_KEY_BASE)) || 'dialogue'; } catch {}\r\n    selectMerchantTab(last);\r\n\r\n    // Ensure no orphaned audio\r\n    stopTypingSfx();\r\n\r\n    // First-time chat\r\n    if (!met) {\r\n      const fc = merchantOverlayEl.querySelector('.merchant-firstchat');\r\n      fc?.classList.add('is-visible');\r\n      merchantOverlayEl.classList.add('firstchat-active');\r\n      runFirstMeet();\r\n    }\r\n  });\r\n}\r\n\r\nexport function closeMerchant() {\r\n  if (!merchantOpen) return;\r\n  \r\n  if (IS_MOBILE) {\r\n    try { suppressNextGhostTap(100); } catch {}\r\n    try { blockInteraction(80); } catch {}\r\n  }\r\n\r\n  merchantOpen = false;\r\n  merchantSheetEl.style.transition = '';\r\n  merchantSheetEl.style.transform = '';\r\n  merchantOverlayEl.classList.remove('is-open');\r\n  merchantOverlayEl.classList.remove('firstchat-instant');\r\n  resetFirstChatOverlayState();\r\n\r\n  const activeEl = document.activeElement;\r\n  if (activeEl && merchantOverlayEl.contains(activeEl)) {\r\n    let target = merchantLastFocus;\r\n    if (!target || !target.isConnected) {\r\n      target = document.querySelector('[data-btn=\"shop\"], .btn-shop');\r\n    }\r\n    if (target && typeof target.focus === 'function') {\r\n      try { target.focus({ preventScroll: true }); } catch {}\r\n    }\r\n  }\r\n\r\n  merchantOverlayEl.setAttribute('inert', '');\r\n  merchantLastFocus = null;\r\n  stopTypingSfx();\r\n  __isTypingActive = false;\r\n}\r\n\r\nfunction onKeydownForMerchant(e) {\r\n  if (!merchantOpen) return;\r\n  if (e.key === 'Escape') {\r\n    e.preventDefault();\r\n    closeMerchant();\r\n  }\r\n}\r\n\r\n// Drag to dismiss\r\nfunction onMerchantDragStart(e) {\r\n  if (!merchantOpen) return;\r\n\r\n  const clientY = typeof e.clientY === 'number'\r\n    ? e.clientY\r\n    : (e.touches && e.touches[0] ? e.touches[0].clientY : 0);\r\n\r\n  merchantDrag = {\r\n    startY: clientY,\r\n    lastY: clientY,\r\n    startT: performance.now(),\r\n    moved: 0,\r\n    canceled: false,\r\n  };\r\n\r\n  merchantSheetEl.style.transition = 'none';\r\n\r\n  window.addEventListener('pointermove', onMerchantDragMove, { passive: true });\r\n  window.addEventListener('pointerup', onMerchantDragEnd);\r\n  window.addEventListener('pointercancel', onMerchantDragCancel);\r\n}\r\n\r\nfunction onMerchantDragMove(e) {\r\n  if (!merchantDrag || merchantDrag.canceled) return;\r\n  const y = e.clientY;\r\n  if (typeof y !== 'number') return;\r\n  const dy = Math.max(0, y - merchantDrag.startY);\r\n  merchantDrag.lastY = y;\r\n  merchantDrag.moved = dy;\r\n  merchantSheetEl.style.transform = `translateY(${dy}px)`;\r\n}\r\n\r\nfunction onMerchantDragEnd() {\r\n  if (!merchantDrag || merchantDrag.canceled) { cleanupMerchantDrag(); return; }\r\n  const dt = Math.max(1, performance.now() - merchantDrag.startT);\r\n  const dy = merchantDrag.moved;\r\n  const velocity = dy / dt;\r\n  const shouldClose = (velocity > 0.55 && dy > 40) || dy > 140;\r\n\r\n  if (shouldClose) {\r\n    suppressNextGhostTap(160);\r\n    merchantSheetEl.style.transition = 'transform 140ms ease-out';\r\n    merchantSheetEl.style.transform = 'translateY(100%)';\r\n    setTimeout(() => { closeMerchant(); }, 150);\r\n  } else {\r\n    merchantSheetEl.style.transition = 'transform 180ms ease';\r\n    merchantSheetEl.style.transform = 'translateY(0)';\r\n  }\r\n  cleanupMerchantDrag();\r\n}\r\n\r\nfunction onMerchantDragCancel() {\r\n  if (!merchantDrag) return;\r\n  merchantDrag.canceled = true;\r\n  merchantSheetEl.style.transition = 'transform 180ms ease';\r\n  merchantSheetEl.style.transform = 'translateY(0)';\r\n  cleanupMerchantDrag();\r\n}\r\n\r\nfunction cleanupMerchantDrag() {\r\n  window.removeEventListener('pointermove', onMerchantDragMove);\r\n  window.removeEventListener('pointerup', onMerchantDragEnd);\r\n  window.removeEventListener('pointercancel', onMerchantDragCancel);\r\n  merchantDrag = null;\r\n}\r\n\r\nfunction selectMerchantTab(key) {\r\n  const def = MERCHANT_TABS_DEF.find(t => t.key === key);\r\n  const unlocked = merchantTabUnlockState.get(key);\r\n  if (!def || !unlocked) key = 'dialogue';\r\n\r\n  for (const k in merchantTabs.buttons) {\r\n    merchantTabs.buttons[k].classList.toggle('is-active', k === key);\r\n  }\r\n  for (const k in merchantTabs.panels) {\r\n    merchantTabs.panels[k].classList.toggle('is-active', k === key);\r\n  }\r\n  try { localStorage.setItem(sk(MERCHANT_TAB_KEY_BASE), key); } catch {}\r\n}\r\n\r\nexport function unlockMerchantTabs(keys = []) {\r\n  keys.forEach(key => {\r\n    const def = MERCHANT_TABS_DEF.find(t => t.key === key);\r\n    if (!def) return;\r\n    merchantTabUnlockState.set(key, true);\r\n    def.unlocked = true;\r\n    const btn = merchantTabs.buttons[key];\r\n    if (btn) {\r\n      btn.disabled = false;\r\n      btn.classList.remove('is-locked');\r\n      btn.textContent = def.label;\r\n      btn.title = def.label || 'Tab';\r\n    }\r\n  });\r\n}\r\n\r\n// Expose for other modules that may build UI later\r\nexport { ensureMerchantOverlay };\r\n", "// js/ui/shopOverlay.js\r\n\r\nimport { bank, getActiveSlot } from '../util/storage.js';\r\nimport { BigNum } from '../util/bigNum.js';\r\nimport { formatNumber } from '../util/numFormat.js';\r\nimport { IS_MOBILE } from '../main.js';\r\nimport { openMerchant,\r\n    ensureMerchantOverlay,\r\n    primeTypingSfx,\r\n    unlockMerchantTabs,\r\n    hasMetMerchant,\r\n    MERCHANT_MET_EVENT\r\n} from './merchantDelve/dlgTab.js';\r\nimport { takePreloadedAudio } from '../util/audioCache.js';\r\nimport {\r\n  AREA_KEYS,\r\n  UPGRADE_TIES,\r\n  getCurrentAreaKey,\r\n  getUpgradesForArea,\r\n  getLevel,\r\n  getLevelNumber,\r\n  getIconUrl,\r\n  formatMultForUi,\r\n  upgradeUiModel,\r\n  buyOne,\r\n  buyMax,\r\n  buyTowards,\r\n  evaluateBulkPurchase,\r\n  getUpgradeLockState,\r\n  evolveUpgrade,\r\n  HM_EVOLUTION_INTERVAL,\r\n} from '../game/upgrades.js';\r\nimport {\r\n  markGhostTapTarget,\r\n  shouldSkipGhostTap,\r\n  suppressNextGhostTap,\r\n} from '../util/ghostTapGuard.js';\r\n\r\n\r\nlet shopOverlayEl = null;\r\nlet shopSheetEl = null;\r\nlet shopOpen = false;\r\nlet drag = null;\r\nlet eventsBound = false;\r\nlet delveBtnEl = null;\r\nlet updateDelveGlow = null;\r\nlet shopCloseTimer = null;\r\nlet __shopOpenStamp = 0;\r\nlet __shopPostOpenPointer = false;\r\n\r\nif (typeof window !== 'undefined') {\r\n  window.addEventListener('debug:change', (e) => {\r\n    const activeSlot = typeof getActiveSlot === 'function' ? getActiveSlot() : null;\r\n    const targetSlot = e?.detail?.slot ?? activeSlot;\r\n    if (activeSlot != null && targetSlot != null && activeSlot !== targetSlot) return;\r\n    updateShopOverlay(true);\r\n  });\r\n}\r\n\r\nconst ICON_DIR = 'img/';\r\nconst BASE_ICON_SRC_BY_COST = {\r\n  coins: 'img/currencies/coin/coin_base.png',\r\n  books: 'img/currencies/book/book_base.png',\r\n  gold: 'img/currencies/gold/gold_base.png',\r\n};\r\nconst LOCKED_BASE_ICON_SRC = 'img/misc/locked_base.png';\r\nconst MAXED_BASE_OVERLAY_SRC = 'img/misc/maxed.png';\r\nconst CURRENCY_ICON_SRC = {\r\n  coins: 'img/currencies/coin/coin.png',\r\n  books: 'img/currencies/book/book.png',\r\n  gold: 'img/currencies/gold/gold.png',\r\n};\r\n\r\nconst FORGE_UNLOCK_UPGRADE_ID = 7;\r\n\r\nfunction resolveUpgradeId(upgLike) {\r\n  if (!upgLike) return null;\r\n  const rawId = typeof upgLike.id !== 'undefined' ? upgLike.id : upgLike;\r\n  if (typeof rawId === 'number') {\r\n    return Number.isFinite(rawId) ? Math.trunc(rawId) : null;\r\n  }\r\n  if (typeof rawId === 'string') {\r\n    const parsed = Number.parseInt(rawId.trim(), 10);\r\n    return Number.isFinite(parsed) ? parsed : null;\r\n  }\r\n  return null;\r\n}\r\n\r\nfunction isForgeUnlockUpgrade(upgLike) {\r\n  return resolveUpgradeId(upgLike) === FORGE_UNLOCK_UPGRADE_ID;\r\n}\r\n\r\nexport function blockInteraction(ms = 140) {\r\n  if (!IS_MOBILE) return;\r\n\r\n  let shield = document.getElementById('ccc-tap-shield');\r\n  if (!shield) {\r\n    shield = document.createElement('div');\r\n    shield.id = 'ccc-tap-shield';\r\n    Object.assign(shield.style, {\r\n      position: 'fixed', inset: '0', zIndex: '2147483647',\r\n      pointerEvents: 'auto', background: 'transparent'\r\n    });\r\n    const eat = (e) => { e.stopPropagation(); e.preventDefault(); };\r\n    ['pointerdown','pointerup','click','touchstart','touchend','mousedown','mouseup']\r\n      .forEach(ev => shield.addEventListener(ev, eat, { capture: true, passive: false }));\r\n  }\r\n  document.body.appendChild(shield);\r\n  clearTimeout(shield.__t);\r\n  shield.__t = setTimeout(() => shield.remove(), ms);\r\n}\r\n\r\nfunction openHmMilestoneDialog(lines) {\r\n  const existing = document.querySelector('.hm-milestones-overlay');\r\n  if (existing) existing.remove();\r\n\r\n  const overlay = document.createElement('div');\r\n  overlay.className = 'hm-milestones-overlay';\r\n  overlay.setAttribute('role', 'dialog');\r\n  overlay.setAttribute('aria-modal', 'true');\r\n  overlay.setAttribute('aria-label', 'Milestones');\r\n\r\n  const dialog = document.createElement('div');\r\n  dialog.className = 'hm-milestones-dialog';\r\n\r\n  const title = document.createElement('h3');\r\n  title.className = 'hm-milestones-title';\r\n  title.textContent = 'Milestones';\r\n\r\n  const list = document.createElement('ul');\r\n  list.className = 'hm-milestones-list';\r\n  for (const line of lines) {\r\n    const li = document.createElement('li');\r\n    const text = document.createElement('span');\r\n    text.className = 'hm-milestone-text';\r\n\r\n    if (line && typeof line === 'object') {\r\n      text.textContent = line.text ?? '';\r\n      if (line.achieved) li.classList.add('hm-milestone-achieved');\r\n    } else {\r\n      text.textContent = line;\r\n    }\r\n\r\n    li.appendChild(text);\r\n    list.appendChild(li);\r\n  }\r\n\r\n  const closeBtn = document.createElement('button');\r\n  closeBtn.type = 'button';\r\n  closeBtn.className = 'hm-milestones-close';\r\n  closeBtn.textContent = 'Close';\r\n\r\n  const close = () => {\r\n    overlay.remove();\r\n    document.removeEventListener('keydown', onKeydown);\r\n  };\r\n\r\n  const onKeydown = (event) => {\r\n    if (event.key === 'Escape') {\r\n      event.preventDefault();\r\n      close();\r\n    }\r\n  };\r\n\r\n  overlay.addEventListener('click', (event) => {\r\n    if (event.target === overlay) close();\r\n  });\r\n  closeBtn.addEventListener('click', close);\r\n  document.addEventListener('keydown', onKeydown);\r\n\r\n  dialog.appendChild(title);\r\n  dialog.appendChild(list);\r\n  dialog.appendChild(closeBtn);\r\n  overlay.appendChild(dialog);\r\n  document.body.appendChild(overlay);\r\n\r\n  if (typeof closeBtn.focus === 'function') {\r\n    closeBtn.focus({ preventScroll: true });\r\n  }\r\n}\r\n\r\nfunction stripTags(html) {\r\n  return String(html ?? '').replace(/<[^>]*>/g, '');\r\n}\r\n\r\nconst PURCHASE_SFX_SRC = 'sounds/purchase_upg.mp3';\r\nconst EVOLVE_SFX_SRC = 'sounds/evolve_upg.mp3';\r\nconst MOBILE_PURCHASE_VOLUME = 0.12;\r\nconst DESKTOP_PURCHASE_VOLUME = 0.3;\r\n\r\nfunction createSfxPlayer({ src, mobileVolume, desktopVolume }) {\r\n  let base = null;\r\n  let ac = null;\r\n  let gain = null;\r\n  let buffer = null;\r\n  let bufferPromise = null;\r\n  let bufferPromiseHandled = false;\r\n  let pendingPlays = 0;\r\n\r\n  function ensureBase() {\r\n    if (base) return base;\r\n\r\n    const preloaded = takePreloadedAudio(src);\r\n    const el = preloaded || new Audio(src);\r\n    el.preload = 'auto';\r\n    el.playsInline = true;\r\n    el.crossOrigin = 'anonymous';\r\n    el.load?.();\r\n    base = el;\r\n    return base;\r\n  }\r\n\r\n  function ensureWebAudio() {\r\n    if (!IS_MOBILE) return false;\r\n    const baseAudio = ensureBase();\r\n    if (!baseAudio) return false;\r\n\r\n    if (!('AudioContext' in window || 'webkitAudioContext' in window)) {\r\n      return false;\r\n    }\r\n\r\n    try {\r\n      ac = ac || new (window.AudioContext || window.webkitAudioContext)();\r\n    } catch (_) {\r\n      ac = null;\r\n      return false;\r\n    }\r\n\r\n    if (!ac) return false;\r\n\r\n    if (ac.state === 'suspended') {\r\n      try { ac.resume(); } catch (_) {}\r\n    }\r\n\r\n    if (!gain) {\r\n      gain = ac.createGain();\r\n      gain.connect(ac.destination);\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  function ensureBuffer() {\r\n    if (!ac) return null;\r\n    if (buffer) return buffer;\r\n    if (bufferPromise) return null;\r\n\r\n    const srcUrl = ensureBase()?.currentSrc || src;\r\n\r\n    try {\r\n      bufferPromise = fetch(srcUrl)\r\n        .then((resp) => (resp.ok ? resp.arrayBuffer() : Promise.reject(resp.status)))\r\n        .then((buf) => new Promise((resolve, reject) => {\r\n          let settled = false;\r\n          const onOk = (decoded) => {\r\n            if (settled) return;\r\n            settled = true;\r\n            resolve(decoded);\r\n          };\r\n          const onErr = (err) => {\r\n            if (settled) return;\r\n            settled = true;\r\n            reject(err);\r\n          };\r\n          const ret = ac.decodeAudioData(buf, onOk, onErr);\r\n          if (ret && typeof ret.then === 'function') {\r\n            ret.then(onOk, onErr);\r\n          }\r\n        }))\r\n        .then((decoded) => {\r\n          buffer = decoded;\r\n          bufferPromise = null;\r\n          bufferPromiseHandled = false;\r\n          return decoded;\r\n        })\r\n        .catch(() => {\r\n          bufferPromise = null;\r\n          bufferPromiseHandled = false;\r\n          return null;\r\n        });\r\n      bufferPromiseHandled = false;\r\n    } catch (_) {\r\n      bufferPromise = null;\r\n      bufferPromiseHandled = false;\r\n    }\r\n\r\n    return buffer || null;\r\n  }\r\n\r\n  function playMobileFallback() {\r\n    const baseAudio = ensureBase();\r\n    if (!baseAudio) return;\r\n\r\n    baseAudio.muted = false;\r\n    baseAudio.volume = mobileVolume;\r\n    try { baseAudio.currentTime = 0; } catch (_) {}\r\n    baseAudio.play().catch(() => {});\r\n  }\r\n\r\n  function playMobileWebAudio() {\r\n    if (!ensureWebAudio()) return false;\r\n\r\n    if (!ac || !gain) return false;\r\n\r\n    const playBuffer = (decoded) => {\r\n      if (!decoded) return false;\r\n      try {\r\n        const node = ac.createBufferSource();\r\n        node.buffer = decoded;\r\n        node.connect(gain);\r\n\r\n        const t = ac.currentTime;\r\n        try {\r\n          gain.gain.setValueAtTime(mobileVolume, t);\r\n        } catch (_) {\r\n          gain.gain.value = mobileVolume;\r\n        }\r\n\r\n        node.start();\r\n        return true;\r\n      } catch (_) {\r\n        return false;\r\n      }\r\n    };\r\n\r\n    if (buffer) {\r\n      return playBuffer(buffer);\r\n    }\r\n\r\n    pendingPlays += 1;\r\n\r\n    if (!bufferPromise) {\r\n      ensureBuffer();\r\n    }\r\n\r\n    if (!bufferPromise) {\r\n      const plays = Math.max(1, pendingPlays);\r\n      pendingPlays = 0;\r\n      for (let i = 0; i < plays; i += 1) {\r\n        playMobileFallback();\r\n      }\r\n      return true;\r\n    }\r\n\r\n    if (bufferPromise && !bufferPromiseHandled) {\r\n      bufferPromiseHandled = true;\r\n      bufferPromise.then((decoded) => {\r\n        const plays = Math.max(1, pendingPlays);\r\n        pendingPlays = 0;\r\n\r\n        if (!decoded) {\r\n          for (let i = 0; i < plays; i += 1) {\r\n            playMobileFallback();\r\n          }\r\n          return;\r\n        }\r\n\r\n        for (let i = 0; i < plays; i += 1) {\r\n          if (!playBuffer(decoded)) {\r\n            playMobileFallback();\r\n            break;\r\n          }\r\n        }\r\n      });\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  function playDesktop() {\r\n    const baseAudio = ensureBase();\r\n    if (!baseAudio) return;\r\n\r\n    baseAudio.volume = desktopVolume;\r\n    const a = baseAudio.cloneNode();\r\n    a.volume = desktopVolume;\r\n    a.play().catch(() => {});\r\n  }\r\n\r\n  return {\r\n    play() {\r\n      try {\r\n        if (IS_MOBILE) {\r\n          if (playMobileWebAudio()) return;\r\n          playMobileFallback();\r\n          return;\r\n        }\r\n\r\n        playDesktop();\r\n      } catch {}\r\n    },\r\n  };\r\n}\r\n\r\nconst purchaseSfx = createSfxPlayer({\r\n  src: PURCHASE_SFX_SRC,\r\n  mobileVolume: MOBILE_PURCHASE_VOLUME,\r\n  desktopVolume: DESKTOP_PURCHASE_VOLUME,\r\n});\r\n\r\nconst evolveSfx = createSfxPlayer({\r\n  src: EVOLVE_SFX_SRC,\r\n  mobileVolume: MOBILE_PURCHASE_VOLUME * 2,\r\n  desktopVolume: DESKTOP_PURCHASE_VOLUME * 2,\r\n});\r\n\r\nfunction playPurchaseSfx() {\r\n  purchaseSfx.play();\r\n}\r\n\r\nfunction playEvolveSfx() {\r\n  evolveSfx.play();\r\n}\r\n\r\nfunction currencyIconHTML(type) {\r\n  const src = CURRENCY_ICON_SRC[type] || CURRENCY_ICON_SRC.coins;\r\n  return `<img alt=\"\" src=\"${src}\" class=\"coin-ico\">`;\r\n}\r\n\r\n\r\n// 1\u00D71 transparent PNG (fallback when an icon is missing)\r\nconst TRANSPARENT_PX =\r\n  'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAwMCAO3x0S8AAAAASUVORK5CYII=';\r\n\r\n// Upgrades registry (minimal for now)\r\nlet upgrades = {};\r\n\r\n// ---------- Custom Scrollbar ----------\r\nfunction ensureCustomScrollbar() {\r\n  const scroller = shopOverlayEl?.querySelector('.shop-scroller');\r\n  if (!scroller || scroller.__customScroll) return;\r\n\r\n  const bar = document.createElement('div');\r\n  bar.className = 'shop-scrollbar';\r\n  const thumb = document.createElement('div');\r\n  thumb.className = 'shop-scrollbar__thumb';\r\n  bar.appendChild(thumb);\r\n  shopSheetEl.appendChild(bar);\r\n\r\n  scroller.__customScroll = { bar, thumb };\r\n\r\n  const isTouch = window.matchMedia('(hover: none) and (pointer: coarse)').matches;\r\n  const FADE_SCROLL_MS = 150;\r\n  const FADE_DRAG_MS = 120;\r\n  const supportsScrollEnd = 'onscrollend' in window;\r\n\r\n  const syncScrollShadow = () => {\r\n    const hasShadow = (scroller.scrollTop || 0) > 0;\r\n    shopSheetEl?.classList.toggle('has-scroll-shadow', hasShadow);\r\n  };\r\n\r\n\r\n  const updateBounds = () => {\r\n    const grab = shopOverlayEl.querySelector('.shop-grabber');\r\n    const header = shopOverlayEl.querySelector('.shop-header');\r\n    const actions = shopOverlayEl.querySelector('.shop-actions');\r\n\r\n    const top = ((grab?.offsetHeight || 0) + (header?.offsetHeight || 0)) | 0;\r\n    const bottom = (actions?.offsetHeight || 0) | 0;\r\n\r\n    bar.style.top = top + 'px';\r\n    bar.style.bottom = bottom + 'px';\r\n  };\r\n\r\n  const updateThumb = () => {\r\n    const { scrollHeight, clientHeight, scrollTop } = scroller;\r\n    const barH = bar.clientHeight;\r\n    const visibleRatio = clientHeight / Math.max(1, scrollHeight);\r\n    const thumbH = Math.max(28, Math.round(barH * visibleRatio));\r\n\r\n    const maxScroll = Math.max(1, scrollHeight - clientHeight);\r\n    const range = Math.max(0, barH - thumbH);\r\n    const y = Math.round((scrollTop / maxScroll) * range);\r\n\r\n    thumb.style.height = thumbH + 'px';\r\n    thumb.style.transform = `translateY(${y}px)`;\r\n    bar.style.display = (scrollHeight <= clientHeight + 1) ? 'none' : '';\r\n  };\r\n\r\n  const updateAll = () => {\r\n    updateBounds();\r\n    updateThumb();\r\n    syncScrollShadow();\r\n  };\r\n\r\n  const showBar = () => {\r\n    if (!isTouch) return;\r\n    shopSheetEl.classList.add('is-scrolling');\r\n    clearTimeout(scroller.__fadeTimer);\r\n  };\r\n  const scheduleHide = (delay) => {\r\n    if (!isTouch) return;\r\n    clearTimeout(scroller.__fadeTimer);\r\n    scroller.__fadeTimer = setTimeout(() => {\r\n      shopSheetEl.classList.remove('is-scrolling');\r\n    }, delay);\r\n  };\r\n\r\n  const onScroll = () => {\r\n    updateThumb();\r\n    syncScrollShadow();\r\n    if (isTouch) showBar();\r\n    if (!supportsScrollEnd) scheduleHide(FADE_SCROLL_MS);\r\n  };\r\n\r\n  const onScrollEnd = () => scheduleHide(FADE_SCROLL_MS);\r\n\r\n  scroller.addEventListener('scroll', onScroll, { passive: true });\r\n  if (supportsScrollEnd) {\r\n    scroller.addEventListener('scrollend', onScrollEnd, { passive: true });\r\n  }\r\n\r\n  const ro = new ResizeObserver(updateAll);\r\n  ro.observe(scroller);\r\n  window.addEventListener('resize', updateAll);\r\n  requestAnimationFrame(updateAll);\r\n\r\n  // --- Drag to scroll ---\r\n  let dragging = false;\r\n  let dragStartY = 0;\r\n  let startScrollTop = 0;\r\n\r\n  const startDrag = (e) => {\r\n    dragging = true;\r\n    dragStartY = e.clientY;\r\n    startScrollTop = scroller.scrollTop;\r\n    thumb.classList.add('dragging');\r\n    showBar();\r\n    try { thumb.setPointerCapture(e.pointerId); } catch {}\r\n    e.preventDefault();\r\n  };\r\n\r\n  const onDragMove = (e) => {\r\n    if (!dragging) return;\r\n    const barH = bar.clientHeight;\r\n    const thH = thumb.clientHeight;\r\n    const range = Math.max(1, barH - thH);\r\n    const scrollMax = Math.max(1, scroller.scrollHeight - scroller.clientHeight);\r\n    const deltaY = e.clientY - dragStartY;\r\n    const scrollDelta = (deltaY / range) * scrollMax;\r\n    scroller.scrollTop = startScrollTop + scrollDelta;\r\n  };\r\n\r\n  const endDrag = (e) => {\r\n    if (!dragging) return;\r\n    dragging = false;\r\n    thumb.classList.remove('dragging');\r\n    scheduleHide(FADE_DRAG_MS);\r\n    try { thumb.releasePointerCapture(e.pointerId); } catch {}\r\n  };\r\n\r\n  thumb.addEventListener('pointerdown', startDrag);\r\n  window.addEventListener('pointermove', onDragMove, { passive: true });\r\n  window.addEventListener('pointerup', endDrag);\r\n  window.addEventListener('pointercancel', endDrag);\r\n\r\n  // --- Click track to jump ---\r\n  bar.addEventListener('pointerdown', (e) => {\r\n    if (e.target === thumb) return;\r\n    const rect = bar.getBoundingClientRect();\r\n    const clickY = e.clientY - rect.top;\r\n\r\n    const barH = bar.clientHeight;\r\n    const thH = thumb.clientHeight;\r\n    const range = Math.max(0, barH - thH);\r\n    const targetY = Math.max(0, Math.min(clickY - thH / 2, range));\r\n\r\n    const scrollMax = Math.max(1, scroller.scrollHeight - scroller.clientHeight);\r\n    scroller.scrollTop = (targetY / Math.max(1, range)) * scrollMax;\r\n\r\n    showBar();\r\n    scheduleHide(FADE_SCROLL_MS);\r\n  });\r\n}\r\n\r\n// ---------- Upgrades ----------\r\nfunction buildUpgradesData() {\r\n  const areaKey = getCurrentAreaKey();\r\n  const defs = getUpgradesForArea(areaKey);\r\n  upgrades = {}; // reset\r\n  for (const def of defs) {\r\n    const lvlBn = getLevel(areaKey, def.id);\r\n    const lvlNum = getLevelNumber(areaKey, def.id);\r\n    const lockState = getUpgradeLockState(areaKey, def.id);\r\n    const icon = lockState.iconOverride ?? getIconUrl(def);\r\n    const title = lockState.titleOverride ?? def.title;\r\n    const desc = lockState.descOverride ?? def.desc;\r\n    const locked = !!lockState.locked;\r\n    const hmReady = (def.upgType === 'HM')\r\n      ? !!upgradeUiModel(areaKey, def.id)?.hmReadyToEvolve\r\n      : false;\r\n    upgrades[def.id] = {\r\n      id: def.id,\r\n      icon,\r\n      title,\r\n      desc,\r\n      level: lvlBn,\r\n      levelNumeric: lvlNum,\r\n      area: def.area,\r\n      meta: def,\r\n      locked,\r\n      lockState,\r\n      useLockedBase: !!lockState.useLockedBase || locked,\r\n      baseIconOverride: def.baseIconOverride || lockState.baseIconOverride || null,\r\n      hmReady,\r\n    };\r\n  }\r\n}\r\n\r\nfunction levelsRemainingToCap(upg, currentLevelBn, currentLevelNumber) {\r\n  if (!upg) return BigNum.fromInt(0);\r\n\r\n  const capBn = upg.lvlCapBn?.clone?.() ?? (Number.isFinite(upg.lvlCap)\r\n    ? BigNum.fromAny(upg.lvlCap)\r\n    : null);\r\n\r\n  if (!capBn) return BigNum.fromInt(0);\r\n  if (capBn.isInfinite?.()) return BigNum.fromAny('Infinity');\r\n\r\n  let lvlBn;\r\n  try {\r\n    lvlBn = currentLevelBn instanceof BigNum\r\n      ? currentLevelBn\r\n      : BigNum.fromAny(currentLevelBn ?? currentLevelNumber ?? 0);\r\n  } catch {\r\n    const fallback = Math.max(0, Math.floor(Number(currentLevelNumber) || 0));\r\n    lvlBn = BigNum.fromInt(fallback);\r\n  }\r\n\r\n  if (lvlBn.isInfinite?.()) return BigNum.fromInt(0);\r\n\r\n  try {\r\n    const capPlain = capBn.toPlainIntegerString?.();\r\n    const lvlPlain = lvlBn.toPlainIntegerString?.();\r\n    if (capPlain === 'Infinity') return BigNum.fromAny('Infinity');\r\n    if (capPlain && lvlPlain && capPlain !== 'Infinity' && lvlPlain !== 'Infinity') {\r\n      const capInt = BigInt(capPlain);\r\n      const lvlInt = BigInt(lvlPlain);\r\n      const delta = capInt - lvlInt;\r\n      if (delta > 0n) {\r\n        return BigNum.fromAny(delta.toString());\r\n      }\r\n      return BigNum.fromInt(0);\r\n    }\r\n  } catch {}\r\n\r\n  const capNumber = Number.isFinite(upg.lvlCap)\r\n    ? Math.max(0, Math.floor(upg.lvlCap))\r\n    : Infinity;\r\n  if (!Number.isFinite(capNumber)) return BigNum.fromAny('Infinity');\r\n\r\n  const lvlNumber = Math.max(0, Math.floor(Number(currentLevelNumber) || 0));\r\n  const room = Math.max(0, capNumber - lvlNumber);\r\n  if (room > 0) {\r\n    try { return BigNum.fromAny(room); }\r\n    catch { return BigNum.fromInt(room | 0); }\r\n  }\r\n\r\n  return BigNum.fromInt(0);\r\n}\r\n\r\nfunction computeAffordableLevels(upg, currentLevelNumeric, currentLevelBn) {\r\n  let lvlBn;\r\n  try {\r\n    lvlBn = currentLevelBn instanceof BigNum\r\n      ? currentLevelBn\r\n      : BigNum.fromAny(currentLevelBn ?? currentLevelNumeric ?? 0);\r\n  } catch {\r\n    const fallback = Math.max(0, Math.floor(Number(currentLevelNumeric) || 0));\r\n    lvlBn = BigNum.fromInt(fallback);\r\n  }\r\n  if (lvlBn.isInfinite?.()) return BigNum.fromInt(0);\r\n\r\n  const lvl = Math.max(0, Math.floor(Number(currentLevelNumeric) || 0));\r\n  const cap = Number.isFinite(upg.lvlCap)\r\n    ? Math.max(0, Math.floor(upg.lvlCap))\r\n    : Infinity;\r\n\r\n  const walletEntry = bank[upg.costType];\r\n  const walletValue = walletEntry?.value;\r\n  const walletBn = walletValue instanceof BigNum\r\n    ? walletValue\r\n    : BigNum.fromAny(walletValue ?? 0);\r\n  if (walletBn.isZero?.()) return BigNum.fromInt(0);\r\n\r\n  if (walletBn.isInfinite?.()) {\r\n    const isHmType = upg?.upgType === 'HM';\r\n    const maxed = Number.isFinite(cap) && lvl >= cap;\r\n    if ((isHmType && !maxed) || !Number.isFinite(cap)) {\r\n      return BigNum.fromAny('Infinity');\r\n    }\r\n    return levelsRemainingToCap(upg, lvlBn, currentLevelNumeric);\r\n  }\r\n\r\n  if (Number.isFinite(cap) && lvl >= cap) return BigNum.fromInt(0);\r\n\r\n  try {\r\n    const nextLvlNum = levelBigNumToNumber(lvlBn.add(BigNum.fromInt(1)));\r\n    const c0 = BigNum.fromAny(upg.costAtLevel(lvl));\r\n    const c1 = BigNum.fromAny(upg.costAtLevel(nextLvlNum));\r\n\r\n    const farProbeLevel = Math.min(\r\n      Number.isFinite(cap) ? cap : lvl + 32,\r\n      lvl + 32\r\n    );\r\n    const cFar = BigNum.fromAny(upg.costAtLevel(farProbeLevel));\r\n\r\n    const isTrulyFlat = c0.cmp(c1) === 0 && c0.cmp(cFar) === 0;\r\n\r\n    if (isTrulyFlat) {\r\n      const remainingBn = levelsRemainingToCap(upg, lvlBn, lvl);\r\n      const room = Number.isFinite(upg.lvlCap)\r\n        ? Math.min(\r\n            Math.max(0, Math.floor(levelBigNumToNumber(remainingBn))),\r\n            Number.MAX_SAFE_INTEGER - 2\r\n          )\r\n        : Number.MAX_SAFE_INTEGER;\r\n\r\n      let lo = 0;\r\n      let hi = Math.max(0, room);\r\n      while (lo < hi) {\r\n        const mid = Math.floor((lo + hi + 1) / 2);\r\n        const midBn = BigNum.fromInt(mid);\r\n        const total = typeof c0.mulBigNumInteger === 'function'\r\n          ? c0.mulBigNumInteger(midBn)\r\n          : BigNum.fromAny(c0 ?? 0).mulBigNumInteger(midBn);\r\n        if (total.cmp(walletBn) <= 0) lo = mid;\r\n        else hi = mid - 1;\r\n      }\r\n      return BigNum.fromInt(lo);\r\n    }\r\n\r\n    const room = Number.isFinite(cap) ? Math.max(0, cap - lvl) : undefined;\r\n    const { count } = evaluateBulkPurchase(upg, lvlBn, walletBn, room, { fastOnly: true });\r\n    return count ?? BigNum.fromInt(0);\r\n    } catch {\r\n  }\r\n\r\n  const room = Number.isFinite(cap) ? Math.max(0, cap - lvl) : undefined;\r\n  const { count } = evaluateBulkPurchase(upg, lvlBn, walletBn, room, { fastOnly: true });\r\n  return count ?? BigNum.fromInt(0);\r\n}\r\n\r\nfunction renderShopGrid() {\r\n  const grid = shopOverlayEl?.querySelector('#shop-grid');\r\n  if (!grid) return;\r\n  grid.innerHTML = '';\r\n\r\n  for (const key in upgrades) {\r\n    const upg = upgrades[key];\r\n\r\n    const btn = document.createElement('button');\r\n    btn.className = 'shop-upgrade';\r\n    btn.setAttribute('data-upgid', upg.id);\r\n    btn.type = 'button';\r\n    btn.setAttribute('role', 'gridcell');\r\n    btn.dataset.upgId = String(upg.id);\r\n\r\n    const locked = !!upg.locked;\r\n    const lockIcon = upg.lockState?.iconOverride;\r\n    const hasMysteriousIcon = typeof lockIcon === 'string' && lockIcon.includes('mysterious');\r\n    const isMysterious = locked && (upg.lockState?.hidden || hasMysteriousIcon);\r\n    const isPlainLocked = locked && !isMysterious;\r\n\r\n    btn.classList.toggle('is-locked', locked);\r\n    btn.classList.toggle('is-locked-plain', isPlainLocked);\r\n    btn.disabled = isPlainLocked;\r\n    if (isPlainLocked) {\r\n      btn.setAttribute('aria-disabled', 'true');\r\n      btn.setAttribute('tabindex', '-1');\r\n    } else {\r\n      btn.removeAttribute('aria-disabled');\r\n      btn.removeAttribute('tabindex');\r\n    }\r\n    btn.dataset.locked = locked ? '1' : '0';\r\n    btn.dataset.lockedPlain = isPlainLocked ? '1' : '0';\r\n    btn.dataset.mysterious = isMysterious ? '1' : '0';\r\n\r\n    const isHM = upg.meta?.upgType === 'HM';\r\n    const evolveReady = isHM && upg.hmReady;\r\n    const levelIsInfinite = isHM && upg.level?.isInfinite?.();\r\n    btn.classList.toggle('hm-evolve-ready', evolveReady);\r\n\r\n    const canPlusBn = locked\r\n      ? BigNum.fromInt(0)\r\n      : computeAffordableLevels(upg.meta, upg.levelNumeric, upg.level);\r\n    const plusBn = canPlusBn instanceof BigNum ? canPlusBn : BigNum.fromAny(canPlusBn);\r\n    const levelHtml = formatNumber(upg.level);\r\n    const levelPlain = stripTags(levelHtml);\r\n    const plusHtml = formatNumber(plusBn);\r\n    const plusPlain = stripTags(plusHtml);\r\n    const hasPlus = !plusBn.isZero?.();\r\n    const rawCap = Number.isFinite(upg.lvlCap)\r\n      ? upg.lvlCap\r\n      : (Number.isFinite(upg.meta?.lvlCap) ? upg.meta.lvlCap : Infinity);\r\n    const capNumber = Number.isFinite(rawCap)\r\n      ? Math.max(0, Math.floor(rawCap))\r\n      : Infinity;\r\n    const levelDigits = Number.parseFloat(String(levelPlain || '').replace(/,/g, ''));\r\n    const levelNumber = Number.isFinite(upg.levelNumeric)\r\n      ? upg.levelNumeric\r\n      : (Number.isFinite(levelDigits) ? levelDigits : NaN);\r\n    const hasFiniteCap = Number.isFinite(capNumber);\r\n    const capReached = evolveReady\r\n      ? false\r\n      : (levelIsInfinite\r\n        ? true\r\n        : (hasFiniteCap && Number.isFinite(levelNumber)\r\n          ? levelNumber >= capNumber\r\n          : false));\r\n    const isBookValueUpgrade = upg.meta?.tie === UPGRADE_TIES.BOOK_VALUE_I;\r\n    const isSingleLevelCap = hasFiniteCap && capNumber === 1;\r\n    const isUnlockUpgrade = !!upg.meta?.unlockUpgrade || (isSingleLevelCap && !isBookValueUpgrade);\r\n    const showUnlockableBadge = !locked && isUnlockUpgrade && !capReached;\r\n    const showUnlockedBadge = !locked && isUnlockUpgrade && !showUnlockableBadge && capReached;\r\n    let badgeHtml;\r\n    let badgePlain;\r\n        let needsTwoLines = false;\r\n    if (locked) {\r\n      badgeHtml = '';\r\n      badgePlain = '';\r\n      const reason = isMysterious ? (upg.lockState?.reason || '').trim() : '';\r\n      const ariaLabel = reason\r\n        ? `${upg.title} (Locked, ${reason})`\r\n        : `${upg.title} (Locked)`;\r\n      btn.setAttribute('aria-label', ariaLabel);\r\n    } else {\r\n  if (showUnlockableBadge || showUnlockedBadge) {\r\n    badgeHtml = showUnlockableBadge ? 'Unlockable' : 'Unlocked';\r\n    badgePlain = badgeHtml;\r\n    btn.setAttribute('aria-label', `${upg.title}, ${badgePlain}`);\r\n  } else {\r\n    const numericLevel = Number.isFinite(upg.levelNumeric) ? upg.levelNumeric : NaN;\r\n    const plainDigits  = String(levelPlain || '').replace(/,/g, '');\r\n    const isInf        = /\u221E|Infinity/i.test(plainDigits);\r\n    const over999      = Number.isFinite(numericLevel)\r\n      ? numericLevel >= 1000\r\n      : (isInf || /^\\d{4,}$/.test(plainDigits));\r\n\r\n    needsTwoLines = hasPlus && over999;\r\n\r\n    if (needsTwoLines) {\r\n      const lvlSpan  = `<span class=\"badge-lvl\">${levelHtml}</span>`;\r\n      const plusSpan = `<span class=\"badge-plus\">(+${plusHtml})</span>`;\r\n      badgeHtml  = `${lvlSpan}${plusSpan}`;\r\n      badgePlain = `${levelPlain} (+${plusPlain})`;\r\n    } else {\r\n      badgeHtml  = hasPlus ? `${levelHtml} (+${plusHtml})` : levelHtml;\r\n      badgePlain = hasPlus ? `${levelPlain} (+${plusPlain})` : levelPlain;\r\n    }\r\n    btn.setAttribute('aria-label', `${upg.title}, level ${badgePlain}`);\r\n  }\r\n}\r\n\r\n        if (locked) {\r\n          btn.title = isMysterious ? 'Hidden Upgrade' : 'Locked Upgrade';\r\n        } else if (upg.meta?.unlockUpgrade) {\r\n          btn.title = 'Left-click: Details \u2022 Right-click: Unlock';\r\n        } else {\r\n          btn.title = 'Left-click: Details \u2022 Right-click: Buy Max';\r\n        }\r\n\r\n    const tile = document.createElement('div');\r\n    tile.className = 'shop-tile';\r\n\r\n    const baseImg = document.createElement('img');\r\n    baseImg.className = 'base';\r\n    const costType = upg.meta?.costType || 'coins';\r\n    const useLockedBase = upg.useLockedBase || locked;\r\n    const fallbackBaseSrc = BASE_ICON_SRC_BY_COST[costType] || BASE_ICON_SRC_BY_COST.coins;\r\n    const resolvedBaseSrc = upg.baseIconOverride || fallbackBaseSrc;\r\n    baseImg.src = useLockedBase\r\n      ? LOCKED_BASE_ICON_SRC\r\n      : resolvedBaseSrc;\r\n    baseImg.alt = '';\r\n\r\n    const iconImg = document.createElement('img');\r\n    iconImg.className = 'icon';\r\n    iconImg.src = upg.icon || TRANSPARENT_PX;\r\n    iconImg.alt = '';\r\n    iconImg.addEventListener('error', () => { iconImg.src = TRANSPARENT_PX; });\r\n\r\n    btn.addEventListener('click', (event) => {\r\n      if (btn.disabled || isPlainLocked) {\r\n        event.preventDefault();\r\n        event.stopImmediatePropagation();\r\n        return;\r\n      }\r\n      if (shouldSkipGhostTap(btn)) {\r\n        event.preventDefault();\r\n        event.stopImmediatePropagation();\r\n        return;\r\n      }\r\n      markGhostTapTarget(btn);\r\n      openUpgradeOverlay(upg.meta);\r\n    });\r\n\r\n    btn.addEventListener('pointerdown', (event) => {\r\n      if (btn.disabled || isPlainLocked) {\r\n        event.preventDefault();\r\n        event.stopPropagation();\r\n        event.stopImmediatePropagation?.();\r\n        return;\r\n      }\r\n      if (event.pointerType !== 'mouse') {\r\n        markGhostTapTarget(btn);\r\n      }\r\n    });\r\n\r\n    btn.addEventListener('contextmenu', (e) => {\r\n      if (IS_MOBILE) return;\r\n      if (locked) return;\r\n      e.preventDefault();\r\n      e.stopPropagation();\r\n      const areaKey = getCurrentAreaKey();\r\n      const { bought } = buyMax(areaKey, upg.id);\r\n      const boughtBn = bought instanceof BigNum ? bought : BigNum.fromAny(bought ?? 0);\r\n      if (!boughtBn.isZero?.()) {\r\n        playPurchaseSfx();\r\n        if (isForgeUnlockUpgrade(upg.meta)) {\r\n          try { unlockMerchantTabs(['reset']); } catch {}\r\n        }\r\n        updateShopOverlay();\r\n      }\r\n    });\r\n\r\n    tile.appendChild(baseImg);\r\n    if (!locked && capReached) {\r\n      const maxedOverlay = document.createElement('img');\r\n      maxedOverlay.className = 'maxed-overlay';\r\n      maxedOverlay.src = MAXED_BASE_OVERLAY_SRC;\r\n      maxedOverlay.alt = '';\r\n      tile.appendChild(maxedOverlay);\r\n    }\r\n    tile.appendChild(iconImg);\r\n\r\n    if (!locked) {\r\n      const badge = document.createElement('span');\r\n      badge.className = 'level-badge';\r\n      if (needsTwoLines) badge.classList.add('two-line');\r\n\r\n      if (badgeHtml === badgePlain) {\r\n        badge.textContent = badgeHtml;\r\n      } else {\r\n        badge.innerHTML = badgeHtml;\r\n      }\r\n      if (hasPlus || showUnlockableBadge) badge.classList.add('can-buy');\r\n      if (capReached) badge.classList.add('is-maxed');\r\n      tile.appendChild(badge);\r\n    }\r\n    btn.appendChild(tile);\r\n    grid.appendChild(btn);\r\n  }\r\n}\r\n\r\n// ---------- Overlay ----------\r\nfunction ensureShopOverlay() {\r\n  if (shopOverlayEl) return;\r\n\r\n  shopOverlayEl = document.createElement('div');\r\n  shopOverlayEl.className = 'shop-overlay';\r\n  shopOverlayEl.id = 'shop-overlay';\r\n\r\n  shopSheetEl = document.createElement('div');\r\n  shopSheetEl.className = 'shop-sheet';\r\n  shopSheetEl.setAttribute('role', 'dialog');\r\n  shopSheetEl.setAttribute('aria-modal', 'false');\r\n  shopSheetEl.setAttribute('aria-label', 'Shop');\r\n\r\n  const grabber = document.createElement('div');\r\n  grabber.className = 'shop-grabber';\r\n  grabber.innerHTML = `<div class=\"grab-handle\" aria-hidden=\"true\"></div>`;\r\n\r\n  const content = document.createElement('div');\r\n  content.className = 'shop-content';\r\n\r\n  const header = document.createElement('header');\r\n  header.className = 'shop-header';\r\n  header.innerHTML = `<div class=\"shop-title\">Shop</div><div class=\"shop-line\" aria-hidden=\"true\"></div>`;\r\n\r\n  const grid = document.createElement('div');\r\n  grid.className = 'shop-grid';\r\n  grid.id = 'shop-grid';\r\n  grid.setAttribute('role', 'grid');\r\n  grid.setAttribute('aria-label', 'Shop Upgrades');\r\n\r\n  const scroller = document.createElement('div');\r\n  scroller.className = 'shop-scroller';\r\n  scroller.appendChild(grid);\r\n\r\n  content.append(header, scroller);\r\n  ensureCustomScrollbar();\r\n\r\n  const actions = document.createElement('div');\r\n  actions.className = 'shop-actions';\r\n\r\n  const closeBtn = document.createElement('button');\r\n  closeBtn.type = 'button';\r\n  closeBtn.className = 'shop-close';\r\n  closeBtn.textContent = 'Close';\r\n  \r\n  const delveBtn = document.createElement('button');\r\n  delveBtn.type = 'button';\r\n  delveBtn.className = 'shop-delve';\r\n  delveBtn.textContent = 'Delve';\r\n\r\n  const openDelveOverlay = () => {\r\n    if (shouldSkipGhostTap(delveBtn)) return;\r\n    markGhostTapTarget(delveBtn);\r\n    primeTypingSfx();\r\n    openMerchant();\r\n  };\r\n\r\n  delveBtn.addEventListener('click', openDelveOverlay);\r\n\r\n  delveBtnEl = delveBtn;\r\n  updateDelveGlow = () => {\r\n    if (!delveBtnEl) return;\r\n    const met = hasMetMerchant();\r\n    delveBtnEl.classList.toggle('is-new', !met);\r\n  };\r\n  updateDelveGlow();\r\n\r\n  actions.appendChild(closeBtn);\r\n  actions.append(delveBtn);\r\n\r\n  shopSheetEl.append(grabber, content, actions);\r\n  shopOverlayEl.appendChild(shopSheetEl);\r\n  document.body.appendChild(shopOverlayEl);\r\n\r\nshopOverlayEl.addEventListener('pointerdown', (e) => {\r\n  if (e.pointerType === 'mouse') return;\r\n  __shopPostOpenPointer = true;\r\n}, { capture: true, passive: true });\r\n\r\nshopOverlayEl.addEventListener('touchstart', () => {\r\n  __shopPostOpenPointer = true;\r\n}, { capture: true, passive: true });\r\n\r\nshopOverlayEl.addEventListener('click', (e) => {\r\n  if (!IS_MOBILE) return;\r\n  if (!__shopPostOpenPointer) {\r\n    e.preventDefault();\r\n    e.stopImmediatePropagation();\r\n    return;\r\n  }\r\n}, { capture: true });\r\n\r\n  updateShopOverlay(true);\r\n\r\n\r\n  if (!eventsBound) {\r\n    eventsBound = true;\r\n\r\nfunction onCloseClick(e) {\r\n  if (IS_MOBILE) {\r\n    blockInteraction(80);\r\n  }\r\n  closeShop();\r\n}\r\n\r\ncloseBtn.addEventListener('click', onCloseClick, { passive: true });\r\n\r\nconst hasPointerEvents = typeof window !== 'undefined' && 'PointerEvent' in window;\r\nif (hasPointerEvents) {\r\n  closeBtn.addEventListener('pointerdown', (e) => {\r\n    if (e.pointerType === 'mouse') return;\r\n    if (typeof e.button === 'number' && e.button !== 0) return;\r\n    // Keep marking for safety, but no global suppression\r\n    markGhostTapTarget(closeBtn);\r\n    blockInteraction(80);\r\n    closeShop();\r\n    e.preventDefault();\r\n  }, { passive: false });\r\n} else {\r\n  closeBtn.addEventListener('touchstart', (e) => {\r\n    markGhostTapTarget(closeBtn);\r\n    blockInteraction(80);\r\n    closeShop();\r\n    e.preventDefault();\r\n  }, { passive: false });\r\n}\r\n\t\r\n    const onDelvePointerDown = (e) => {\r\n      if (e.pointerType === 'mouse') return;\r\n      if (typeof e.button === 'number' && e.button !== 0) return;\r\n      markGhostTapTarget(delveBtn);\r\n      primeTypingSfx();\r\n      openMerchant();\r\n      e.preventDefault();\r\n    };\r\n\r\n    const onDelveTouchStart = (e) => {\r\n      markGhostTapTarget(delveBtn);\r\n      primeTypingSfx();\r\n      openMerchant();\r\n      e.preventDefault();\r\n    };\r\n\r\n    if (hasPointerEvents) {\r\n      delveBtn.addEventListener('pointerdown', onDelvePointerDown, { passive: false });\r\n    } else {\r\n      delveBtn.addEventListener('touchstart', onDelveTouchStart, { passive: false });\r\n    }\r\n\r\n    document.addEventListener('keydown', onKeydownForShop);\r\n    grabber.addEventListener('pointerdown', onDragStart);\r\n    grabber.addEventListener('touchstart', (e) => e.preventDefault(), { passive: false });\r\n\r\n    let _shopBadgeTimer = null;\r\n      const scheduleShopRerender = () => {\r\n        if (!shopOpen) return;\r\n        clearTimeout(_shopBadgeTimer);\r\n        _shopBadgeTimer = setTimeout(() => {\r\n          updateShopOverlay();\r\n        }, 60);\r\n      };\r\n\r\n      window.addEventListener('currency:change', scheduleShopRerender);\r\n      window.addEventListener('xp:change', scheduleShopRerender);\r\n      window.addEventListener('xp:unlock', scheduleShopRerender);\r\n\r\n    const onUpgradesChanged = () => {\r\n      if (!shopOpen) return;\r\n      updateShopOverlay();\r\n    };\r\n\r\n    document.addEventListener('ccc:upgrades:changed', onUpgradesChanged);\r\n\r\n    window.addEventListener(MERCHANT_MET_EVENT, () => {\r\n      if (typeof updateDelveGlow === 'function') updateDelveGlow();\r\n      if (shopOpen) updateShopOverlay();\r\n    });\r\n  }\r\n}\r\n\r\n// --- Upgrade Fullscreen Overlay ---\r\nlet upgOverlayEl = null;\r\nlet upgSheetEl = null;\r\nlet upgOpen = false;\r\nlet upgOverlayCleanup = null;\r\n\r\nfunction ensureUpgradeOverlay() {\r\n  if (upgOverlayEl) return;\r\n  upgOverlayEl = document.createElement('div');\r\n  upgOverlayEl.className = 'upg-overlay';\r\n\r\n  upgSheetEl = document.createElement('div');\r\n  upgSheetEl.className = 'upg-sheet';\r\n  upgSheetEl.setAttribute('role', 'dialog');\r\n  upgSheetEl.setAttribute('aria-modal', 'false');\r\n  upgSheetEl.setAttribute('aria-label', 'Upgrade');\r\n\r\n  const grab = document.createElement('div');\r\n  grab.className = 'upg-grabber';\r\n  grab.innerHTML = `<div class=\"grab-handle\" aria-hidden=\"true\"></div>`;\r\n\r\n  const header = document.createElement('header');\r\n  header.className = 'upg-header';\r\n\r\n  const content = document.createElement('div');\r\n  content.className = 'upg-content';\r\n\r\n  const actions = document.createElement('div');\r\n  actions.className = 'upg-actions';\r\n\r\n  upgSheetEl.append(grab, header, content, actions);\r\n  upgOverlayEl.appendChild(upgSheetEl);\r\n  document.body.appendChild(upgOverlayEl);\r\n\r\nupgOverlayEl.addEventListener('pointerdown', (e) => {\r\n  if (!IS_MOBILE) return;\r\n  if (e.pointerType === 'mouse') return;\r\n  if (e.target === upgOverlayEl) {\r\n    e.preventDefault();\r\n    e.stopPropagation();\r\n  }\r\n}, true);\r\n\r\nupgOverlayEl.addEventListener('click', (e) => {\r\n  if (!IS_MOBILE) return;\r\n  if (e.target === upgOverlayEl) {\r\n    e.preventDefault();\r\n    e.stopImmediatePropagation();\r\n  }\r\n}, true);\r\n\r\n  let drag = null;\r\n  function onDragStart(e) {\r\n    if (!upgOpen) return;\r\n    const y = typeof e.clientY === 'number' ? e.clientY : (e.touches?.[0]?.clientY || 0);\r\n    drag = { startY: y, lastY: y, moved: 0 };\r\n    upgSheetEl.style.transition = 'none';\r\n    window.addEventListener('pointermove', onDragMove);\r\n    window.addEventListener('pointerup', onDragEnd);\r\n    window.addEventListener('pointercancel', onDragEnd);\r\n  }\r\n  function onDragMove(e) {\r\n    if (!drag) return;\r\n    const y = e.clientY;\r\n    if (typeof y !== 'number') return;\r\n    const dy = Math.max(0, y - drag.startY);\r\n    drag.lastY = y;\r\n    drag.moved = dy;\r\n    upgSheetEl.style.transform = `translateY(${dy}px)`;\r\n  }\r\n  function onDragEnd(e) {\r\n    if (!drag) return;\r\n    const shouldClose = drag.moved > 140;\r\n    upgSheetEl.style.transition = 'transform 160ms ease';\r\n    upgSheetEl.style.transform = shouldClose ? 'translateY(100%)' : 'translateY(0)';\r\n    if (shouldClose) {\r\n      if (IS_MOBILE && (!e || e.pointerType !== 'mouse')) {\r\n        try { blockInteraction(120); } catch {}\r\n      }\r\n      setTimeout(closeUpgradeMenu, 160);\r\n    }\r\n    drag = null;\r\n    window.removeEventListener('pointermove', onDragMove);\r\n    window.removeEventListener('pointerup', onDragEnd);\r\n    window.removeEventListener('pointercancel', onDragEnd);\r\n  }\r\n  grab.addEventListener('pointerdown', onDragStart, { passive: true });\r\n}\r\n\r\nfunction closeUpgradeMenu() {\r\n  if (IS_MOBILE) {\r\n    try { blockInteraction(160); } catch {}\r\n  }\r\n\r\n  if (typeof upgOverlayCleanup === 'function') {\r\n    const fn = upgOverlayCleanup;\r\n    upgOverlayCleanup = null;\r\n    try { fn(); } catch {}\r\n  }\r\n\r\n  upgOpen = false;\r\n  if (!upgOverlayEl || !upgSheetEl) return;\r\n  upgSheetEl.style.transition = '';\r\n  upgSheetEl.style.transform = '';\r\n  upgOverlayEl.classList.remove('is-open');\r\n  upgOverlayEl.style.pointerEvents = 'none';\r\n}\r\n\r\nfunction formatMult(value) {\r\n  if (value instanceof BigNum) return `${formatNumber(value)}x`;\r\n\r\n  const asNum = Number(value);\r\n  if (Number.isFinite(asNum)) {\r\n    return formatFourDigitsFloorNumber(asNum) + 'x';\r\n  }\r\n\r\n  try {\r\n    const bn = BigNum.fromAny(value);\r\n    return `${formatNumber(bn)}x`;\r\n  } catch {\r\n    return '0x';\r\n  }\r\n}\r\n\r\nfunction formatFourDigitsFloorNumber(v) {\r\n  const abs = Math.abs(v);\r\n\r\n  if (abs >= 10000) {\r\n    return formatNumber(BigNum.fromAny(v));\r\n  }\r\n\r\n  const intDigits = abs >= 1 ? Math.floor(abs).toString().length : 0;\r\n  const decimals = Math.max(0, 4 - intDigits);\r\n\r\n  const groupThousands = (s) => {\r\n    let sign = '';\r\n    if (s.startsWith('-')) { sign = '-'; s = s.slice(1); }\r\n    return sign + s.replace(/\\B(?=(\\d{3})+(?!\\d))/g, ',');\r\n  };\r\n\r\n  if (decimals === 0) {\r\n    const floored = (v >= 0) ? Math.floor(v) : Math.ceil(v);\r\n    let s = String(floored);\r\n    if (Math.abs(floored) >= 1000) s = groupThousands(s);\r\n    return s;\r\n  }\r\n\r\n  const factor = Math.pow(10, decimals);\r\n  const floored = (v >= 0)\r\n    ? Math.floor(v * factor) / factor\r\n    : Math.ceil(v * factor) / factor;\r\n\r\n  let s = floored.toFixed(decimals);\r\n  let [i, f = ''] = s.split('.');\r\n  if (Math.abs(floored) >= 1000) i = groupThousands(i);\r\n  f = f.replace(/0+$/, '');\r\n  return f ? `${i}.${f}` : i;\r\n}\r\n\r\nexport function openUpgradeOverlay(upgDef) {\r\n  ensureUpgradeOverlay();\r\n  upgOpen = true;\r\n  let upgOpenLocal = true;\r\n\r\n  const areaKey = getCurrentAreaKey();\r\n  const initialLockState = getUpgradeLockState(areaKey, upgDef.id) || {};\r\n  const initialLocked = !!initialLockState.locked;\r\n  const initialMysterious = initialLocked && (\r\n    initialLockState.hidden ||\r\n    initialLockState.hideEffect ||\r\n    initialLockState.hideCost ||\r\n    (typeof initialLockState.iconOverride === 'string' &&\r\n      initialLockState.iconOverride.includes('mysterious'))\r\n  );\r\n  if (initialLocked && !initialMysterious) {\r\n    upgOpen = false;\r\n    return;\r\n  }\r\n\r\n  const isHM = (upgDef.upgType === 'HM');\r\n  const isEndlessXp = (upgDef.tie === UPGRADE_TIES.ENDLESS_XP);\r\n  const ui = () => upgradeUiModel(areaKey, upgDef.id);\r\n\r\n  // small helpers\r\n  const spacer = (h) => { const s = document.createElement('div'); s.style.height = h; return s; };\r\n  const makeLine = (html) => { const d = document.createElement('div'); d.className = 'upg-line'; d.innerHTML = html; return d; };\r\n\r\n    function recenterUnlockOverlayIfNeeded(model) {\r\n    const content = upgSheetEl.querySelector('.upg-content');\r\n    if (!content) return;\r\n\r\n    // Check current lock state so we can skip hidden/mysterious sheets\r\n    const lockState = model?.lockState || getUpgradeLockState(areaKey, upgDef.id) || {};\r\n    const isHiddenUpgrade = !!(\r\n      lockState.hidden ||\r\n      lockState.hideEffect ||\r\n      lockState.hideCost\r\n    );\r\n\r\n    // Only do special layout for *visible* unlock-type upgrades.\r\n    // Hidden upgrades should use the normal hidden layout.\r\n    if (!model || !model.unlockUpgrade || isHiddenUpgrade) {\r\n      content.style.marginTop = '';\r\n      return;\r\n    }\r\n\r\n    const header  = upgSheetEl.querySelector('.upg-header');\r\n    const actions = upgSheetEl.querySelector('.upg-actions');\r\n    if (!header || !actions) return;\r\n\r\n    // Reset first so measurements are clean\r\n    content.style.marginTop = '';\r\n\r\n    const headerRect  = header.getBoundingClientRect();\r\n    const actionsRect = actions.getBoundingClientRect();\r\n    const contentRect = content.getBoundingClientRect();\r\n\r\n    const available = actionsRect.top - headerRect.bottom;\r\n    const freeSpace = available - contentRect.height;\r\n    if (freeSpace <= 0) return;\r\n\r\n    const BIAS = 0.42;\r\n    const topOffset = freeSpace * BIAS;\r\n\r\n    content.style.marginTop = `${topOffset}px`;\r\n  }\r\n\r\n  const rerender = () => {\r\n    const model = ui();\r\n    if (!model) return;\r\n\r\n    const lockState = model.lockState || getUpgradeLockState(areaKey, upgDef.id);\r\n    const locked = !!lockState?.locked;\r\n    const isHiddenUpgrade = locked && (\r\n      lockState?.hidden || lockState?.hideEffect || lockState?.hideCost\r\n    );\r\n    const lockHidden = locked && isHiddenUpgrade;\r\n\r\n    const isUnlockVisible = !!model.unlockUpgrade && !lockHidden;\r\n\r\n    upgSheetEl.classList.toggle('is-locked-hidden', lockHidden);\r\n\r\n    const header = upgSheetEl.querySelector('.upg-header');\r\n    header.innerHTML = '';\r\n\r\n    const title = document.createElement('div');\r\n    title.className = 'upg-title';\r\n    title.textContent = model.displayTitle || model.upg.title;\r\n\r\n    const evolveReady = !!model.hmReadyToEvolve;\r\n    const capReached = evolveReady\r\n      ? false\r\n      : (model.lvlBn?.isInfinite?.()\r\n        ? true\r\n        : (Number.isFinite(model.upg.lvlCap)\r\n          ? model.lvl >= model.upg.lvlCap\r\n          : false));\r\n    const level = document.createElement('div');\r\n    level.className = 'upg-level';\r\n    const capHtml = model.lvlCapFmtHtml ?? model.upg.lvlCapFmtHtml ?? formatNumber(model.lvlCapBn);\r\n    const capPlain = model.lvlCapFmtText ?? model.upg.lvlCapFmtText ?? stripTags(capHtml);\r\n    const levelHtml = evolveReady\r\n      ? `Level ${model.lvlFmtHtml} / ${capHtml} (EVOLVE READY)`\r\n      : (capReached\r\n        ? `Level ${model.lvlFmtHtml} / ${capHtml} (MAXED)`\r\n        : `Level ${model.lvlFmtHtml} / ${capHtml}`);\r\n    const levelPlain = evolveReady\r\n      ? `Level ${model.lvlFmtText} / ${capPlain} (EVOLVE READY)`\r\n      : (capReached\r\n        ? `Level ${model.lvlFmtText} / ${capPlain} (MAXED)`\r\n        : `Level ${model.lvlFmtText} / ${capPlain}`);\r\n    level.innerHTML = levelHtml;\r\n    level.setAttribute('aria-label', levelPlain);\r\n    if (isHiddenUpgrade) {\r\n      level.hidden = true;\r\n    } else {\r\n      level.hidden = false;\r\n      level.removeAttribute('aria-hidden');\r\n    }\r\n\r\n    upgSheetEl.classList.toggle('is-maxed', capReached);\r\n    upgSheetEl.classList.toggle('hm-evolve-ready', evolveReady);\r\n    upgSheetEl.classList.toggle('is-unlock-upgrade', isUnlockVisible);\r\n    header.append(title, level);\r\n\r\n    const content = upgSheetEl.querySelector('.upg-content');\r\n    content.innerHTML = '';\r\n    content.scrollTop = 0;\r\n    upgSheetEl.classList.toggle('is-hm-upgrade', isHM);\r\n    upgSheetEl.classList.toggle('is-endless-xp', isEndlessXp);\r\n\r\n    const desc = document.createElement('div');\r\n    desc.className = 'upg-desc centered';\r\n    if (lockHidden) desc.classList.add('lock-desc');\r\n    const baseDesc = (model.displayDesc || model.upg.desc || '').trim();\r\n    if (evolveReady) {\r\n      desc.classList.add('hm-evolve-note');\r\n      desc.textContent = 'Evolve this upgrade to multiply its effect by 1000x';\r\n    } else if (baseDesc) {\r\n      desc.textContent = baseDesc;\r\n    } else {\r\n      desc.hidden = true;\r\n    }\r\n    content.appendChild(desc);\r\n\r\n    const info = document.createElement('div');\r\n    info.className = 'upg-info';\r\n\r\n    info.appendChild(spacer('12px'));\r\n    if (locked && lockState?.reason && !isHiddenUpgrade) {\r\n      const descText = (model.displayDesc || '').trim();\r\n      const reasonText = String(lockState.reason ?? '').trim();\r\n      const isDuplicateNote = descText && descText === reasonText;\r\n      if (!isDuplicateNote) {\r\n        const note = document.createElement('div');\r\n        note.className = 'upg-line lock-note';\r\n        note.textContent = lockState.reason;\r\n        info.appendChild(note);\r\n        info.appendChild(spacer('12px'));\r\n      }\r\n    }\r\n    if (model.effect && !(locked && lockState?.hideEffect)) {\r\n      const effectText = model.effect;\r\n      info.appendChild(makeLine(`<span class=\"bonus-line\">${effectText}</span>`));\r\n      info.appendChild(spacer('12px'));\r\n    }\r\n\r\n    // dynamic currency icon based on costType\r\n    const iconHTML    = currencyIconHTML(model.upg.costType);\r\n    const nextPriceBn = model.nextPrice instanceof BigNum\r\n      ? model.nextPrice\r\n      : BigNum.fromAny(model.nextPrice || 0);\r\n\r\n    // costs only if not capped and not an unlock-type\r\n    const stopBuying = capReached || evolveReady;\r\n    if (!model.unlockUpgrade && !stopBuying && (!locked || !lockState?.hideCost)) {\r\n      const costs = document.createElement('div');\r\n      costs.className = 'upg-costs';\r\n\r\n      const lineCost = document.createElement('div');\r\n      lineCost.className = 'upg-line';\r\n      lineCost.innerHTML = `Cost: ${iconHTML} ${bank[model.upg.costType].fmt(nextPriceBn)}`;\r\n      costs.appendChild(lineCost);\r\n\r\n      if (isHM) {\r\n        const lineMilestone = document.createElement('div');\r\n        lineMilestone.className = 'upg-line';\r\n        let milestoneCost = '\u2014';\r\n        try {\r\n          if (model.hmNextMilestone && model.hmNextMilestone.cmp(model.lvlBn) > 0) {\r\n            const deltaBn = model.hmNextMilestone.sub(model.lvlBn);\r\n            const deltaPlain = deltaBn.toPlainIntegerString?.();\r\n            const deltaNum = Math.max(\r\n              0,\r\n              Math.floor(Number(deltaPlain && deltaPlain !== 'Infinity' ? deltaPlain : Number(deltaBn.toString() || 0)))\r\n            );\r\n            const { spent } = evaluateBulkPurchase(\r\n              model.upg,\r\n              model.lvlBn,\r\n              BigNum.fromAny('Infinity'),\r\n              deltaNum,\r\n            );\r\n            milestoneCost = bank[model.upg.costType].fmt(spent);\r\n          }\r\n        } catch {}\r\n        lineMilestone.innerHTML = `Cost to next milestone: ${iconHTML} ${milestoneCost}`;\r\n        costs.appendChild(lineMilestone);\r\n      }\r\n\r\n      const lineHave = document.createElement('div');\r\n      lineHave.className = 'upg-line';\r\n      lineHave.innerHTML = `You have: ${iconHTML} ${bank[model.upg.costType].fmt(model.have)}`;\r\n      costs.appendChild(lineHave);\r\n\r\n      info.appendChild(costs);\r\n    }\r\n\r\n    content.appendChild(info);\r\n\r\n    if (isHM) {\r\n      const milestonesRow = document.createElement('div');\r\n      milestonesRow.className = 'hm-view-milestones-row';\r\n      const viewMilestonesBtn = document.createElement('button');\r\n      viewMilestonesBtn.type = 'button';\r\n      viewMilestonesBtn.className = 'shop-delve hm-view-milestones';\r\n      viewMilestonesBtn.textContent = 'View Milestones';\r\n      viewMilestonesBtn.addEventListener('click', () => {\r\n        const milestones = Array.isArray(model.hmMilestones) ? model.hmMilestones : [];\r\n        if (!milestones.length) return;\r\n        const evolutions = Math.max(0, Math.floor(Number(model.hmEvolutions ?? 0)));\r\n        const evolutionOffset = (() => {\r\n          try { return BigInt(HM_EVOLUTION_INTERVAL) * BigInt(evolutions); }\r\n          catch { return 0n; }\r\n        })();\r\n        const formatMilestoneLevel = (levelBn) => {\r\n          if (model.lvlBn?.isInfinite?.()) return 'Infinity';\r\n          try {\r\n            const plain = levelBn?.toPlainIntegerString?.();\r\n            if (plain && plain !== 'Infinity') {\r\n              if (plain.length <= 15) {\r\n                const asNum = Number(plain);\r\n                if (Number.isFinite(asNum)) return asNum.toLocaleString();\r\n              }\r\n              return plain.replace(/\\B(?=(\\d{3})+(?!\\d))/g, ',');\r\n            }\r\n          } catch {}\r\n          return formatNumber(levelBn);\r\n        };\r\n        const lines = milestones\r\n          .sort((a, b) => (Number(a?.level ?? 0) - Number(b?.level ?? 0)))\r\n          .map((m) => {\r\n            const lvl = Math.max(0, Math.floor(Number(m?.level ?? 0)));\r\n            const milestoneLevelBn = (() => {\r\n              if (model.lvlBn?.isInfinite?.()) return BigNum.fromAny('Infinity');\r\n              try { return BigNum.fromAny((BigInt(lvl) + evolutionOffset).toString()); }\r\n              catch { return BigNum.fromAny(lvl + (HM_EVOLUTION_INTERVAL * evolutions)); }\r\n            })();\r\n            const milestonePlain = milestoneLevelBn?.toPlainIntegerString?.();\r\n            const levelText = formatMilestoneLevel(milestoneLevelBn);\r\n            const mult = formatMultForUi(m?.multiplier ?? m?.mult ?? m?.value ?? 1);\r\n            const target = `${m?.target ?? m?.type ?? 'self'}`.toLowerCase();\r\n            const achieved = (() => {\r\n              if (model.lvlBn?.isInfinite?.()) return true;\r\n              try { return model.lvlBn?.cmp?.(milestoneLevelBn) >= 0; }\r\n              catch {}\r\n              if (Number.isFinite(model.lvl) && milestonePlain && milestonePlain !== 'Infinity') {\r\n                const approxTarget = Number(milestonePlain);\r\n                if (Number.isFinite(approxTarget)) return model.lvl >= approxTarget;\r\n              }\r\n              return false;\r\n            })();\r\n            if (target === 'xp') return { text: `Level ${levelText}: Multiplies XP value by ${mult}x`, achieved };\r\n            if (target === 'coin' || target === 'coins') return { text: `Level ${levelText}: Multiplies Coin value by ${mult}x`, achieved };\r\n            if (target === 'mp') return { text: `Level ${levelText}: Multiplies MP value by ${mult}x`, achieved };\r\n            return { text: `Level ${levelText}: Multiplies this upgrade\u2019s effect by ${mult}x`, achieved };\r\n          });\r\n        openHmMilestoneDialog(lines);\r\n      });\r\n      milestonesRow.appendChild(viewMilestonesBtn);\r\n      content.appendChild(milestonesRow);\r\n    }\r\n\r\n    // ---------- actions ----------\r\n    const actions = upgSheetEl.querySelector('.upg-actions');\r\n    actions.innerHTML = '';\r\n\t\r\n    const closeBtn = document.createElement('button');\r\n    closeBtn.type = 'button';\r\n    closeBtn.className = 'shop-close';\r\n    closeBtn.textContent = 'Close';\r\n    closeBtn.addEventListener('click', () => { upgOpenLocal = false; closeUpgradeMenu(); });\r\n\r\n    if ('PointerEvent' in window) {\r\n      closeBtn.addEventListener('pointerdown', (e) => {\r\n        if (e.pointerType === 'mouse') return;\r\n        if (typeof e.button === 'number' && e.button !== 0) return;\r\n        markGhostTapTarget(closeBtn);\r\n        suppressNextGhostTap(320);\r\n        blockInteraction(160);\r\n        upgOpenLocal = false;\r\n        closeUpgradeMenu();\r\n        e.preventDefault();\r\n      }, { passive: false });\r\n    } else {\r\n      closeBtn.addEventListener('touchstart', (e) => {\r\n        markGhostTapTarget(closeBtn);\r\n        suppressNextGhostTap(320);\r\n        blockInteraction(160);\r\n        upgOpenLocal = false;\r\n        closeUpgradeMenu();\r\n        e.preventDefault();\r\n      }, { passive: false });\r\n    }\r\n\t\r\n    if (locked) {\r\n      actions.append(closeBtn);\r\n      closeBtn.focus();\r\n    } else if (capReached) {\r\n      actions.append(closeBtn);\r\n      closeBtn.focus();\r\n    } else {\r\n      const canAffordNext = model.have.cmp(nextPriceBn) >= 0;\r\n\r\n      if (evolveReady) {\r\n        const evolveBtn = document.createElement('button');\r\n        evolveBtn.type = 'button';\r\n        evolveBtn.className = 'shop-delve hm-evolve-btn';\r\n        evolveBtn.textContent = 'Evolve';\r\n        evolveBtn.addEventListener('click', () => {\r\n          const { evolved } = evolveUpgrade(areaKey, upgDef.id);\r\n          if (!evolved) return;\r\n          playEvolveSfx();\r\n          updateShopOverlay();\r\n          rerender();\r\n        });\r\n        actions.append(closeBtn, evolveBtn);\r\n        evolveBtn.focus();\r\n        recenterUnlockOverlayIfNeeded(model);\r\n        return;\r\n      }\r\n\r\n      if (model.unlockUpgrade) {\r\n        const unlockBtn = document.createElement('button');\r\n        unlockBtn.type = 'button';\r\n        unlockBtn.className = 'shop-delve';\r\n        unlockBtn.textContent = 'Unlock';\r\n        unlockBtn.disabled = !canAffordNext;\r\n        unlockBtn.addEventListener('click', () => {\r\n          const { bought } = buyOne(areaKey, upgDef.id);\r\n          const boughtBn = bought instanceof BigNum ? bought : BigNum.fromAny(bought ?? 0);\r\n          if (!boughtBn.isZero?.()) {\r\n            playPurchaseSfx();\r\n            if (isForgeUnlockUpgrade(upgDef)) {\r\n              try { unlockMerchantTabs(['reset']); } catch {}\r\n            }\r\n            updateShopOverlay();\r\n            rerender();\r\n          }\r\n        });\r\n\t\t\r\n        actions.append(closeBtn, unlockBtn);\r\n        (canAffordNext ? unlockBtn : closeBtn).focus();\r\n        recenterUnlockOverlayIfNeeded(model);\r\n        return;\r\n      }\r\n\r\n      const buyBtn = document.createElement('button');\r\n      buyBtn.type = 'button';\r\n      buyBtn.className = 'shop-delve';\r\n      buyBtn.textContent = 'Buy';\r\n      buyBtn.disabled = !canAffordNext;\r\n\r\n      // Core buy logic shared by pointer/touch and click fallback\r\n      const performBuy = () => {\r\n        const fresh = upgradeUiModel(areaKey, upgDef.id);\r\n        const priceNow = fresh.nextPrice instanceof BigNum\r\n          ? fresh.nextPrice\r\n          : BigNum.fromAny(fresh.nextPrice || 0);\r\n        if (fresh.have.cmp(priceNow) < 0) return;\r\n\r\n        const { bought } = buyOne(areaKey, upgDef.id);\r\n        const boughtBn = bought instanceof BigNum ? bought : BigNum.fromAny(bought ?? 0);\r\n        if (boughtBn.isZero?.()) return;\r\n\r\n        playPurchaseSfx();\r\n        updateShopOverlay();\r\n        rerender();\r\n      };\r\n\r\n      // Mobile: drive purchase off pointer/touch so Safari's click\r\n      // cancellation doesn't limit how fast you can spam the button.\r\n      if ('PointerEvent' in window) {\r\n        buyBtn.addEventListener('pointerdown', (event) => {\r\n          // Ignore mouse here; desktop uses the click handler below\r\n          if (event.pointerType === 'mouse') return;\r\n          if (typeof event.button === 'number' && event.button !== 0) return;\r\n\r\n          if (typeof markGhostTapTarget === 'function') {\r\n            // Small window: eats ghost taps that land elsewhere,\r\n            // but repeated taps on this button are still allowed\r\n            markGhostTapTarget(buyBtn, 160);\r\n          }\r\n\r\n          performBuy();\r\n          event.preventDefault();\r\n        }, { passive: false });\r\n      } else {\r\n        // Older touch-only browsers\r\n        buyBtn.addEventListener('touchstart', (event) => {\r\n          if (typeof markGhostTapTarget === 'function') {\r\n            markGhostTapTarget(buyBtn, 160);\r\n          }\r\n\r\n          performBuy();\r\n          event.preventDefault();\r\n        }, { passive: false });\r\n      }\r\n\r\n      // Desktop / non-touch fallback \u2013 simple click is fine here.\r\n      buyBtn.addEventListener('click', (event) => {\r\n        // On mobile we already handled the tap in pointer/touch handler\r\n        if (IS_MOBILE) return;\r\n\r\n        if (typeof markGhostTapTarget === 'function') {\r\n          markGhostTapTarget(buyBtn, 160);\r\n        }\r\n\r\n        performBuy();\r\n      });\r\n\r\n\r\n      const buyMaxBtn = document.createElement('button');\r\n      buyMaxBtn.type = 'button';\r\n      buyMaxBtn.className = 'shop-delve';\r\n      buyMaxBtn.textContent = 'Buy Max';\r\n      buyMaxBtn.disabled = !canAffordNext;\r\n      const performBuyMax = () => {\r\n        if (buyMaxBtn.disabled) return;\r\n        const fresh = upgradeUiModel(areaKey, upgDef.id);\r\n        if (fresh.have.cmp(BigNum.fromInt(1)) < 0) return;\r\n        const { bought } = buyMax(areaKey, upgDef.id);\r\n        const boughtBn = bought instanceof BigNum ? bought : BigNum.fromAny(bought ?? 0);\r\n        if (!boughtBn.isZero?.()) {\r\n          playPurchaseSfx();\r\n          updateShopOverlay();\r\n          rerender();\r\n        }\r\n      };\r\n\r\n      if ('PointerEvent' in window) {\r\n        buyMaxBtn.addEventListener('pointerdown', (event) => {\r\n          if (event.pointerType === 'mouse') return;\r\n          if (typeof event.button === 'number' && event.button !== 0) return;\r\n\r\n          if (typeof markGhostTapTarget === 'function') {\r\n            markGhostTapTarget(buyMaxBtn, 160);\r\n          }\r\n\r\n          performBuyMax();\r\n          event.preventDefault();\r\n        }, { passive: false });\r\n      } else {\r\n        buyMaxBtn.addEventListener('touchstart', (event) => {\r\n          if (typeof markGhostTapTarget === 'function') {\r\n            markGhostTapTarget(buyMaxBtn, 160);\r\n          }\r\n\r\n          performBuyMax();\r\n          event.preventDefault();\r\n        }, { passive: false });\r\n      }\r\n\r\n      buyMaxBtn.addEventListener('click', (event) => {\r\n        if (IS_MOBILE) return;\r\n\r\n        if (typeof markGhostTapTarget === 'function') {\r\n          markGhostTapTarget(buyMaxBtn, 160);\r\n        }\r\n\r\n        performBuyMax();\r\n      });\r\n\r\n      actions.append(closeBtn, buyBtn, buyMaxBtn);\r\n\r\n      // Only HM gets Buy Next\r\n      if (isHM) {\r\n        const buyNextBtn = document.createElement('button');\r\n        buyNextBtn.type = 'button';\r\n        buyNextBtn.className = 'shop-delve';\r\n        buyNextBtn.textContent = 'Buy Next';\r\n        buyNextBtn.disabled = model.have.cmp(BigNum.fromInt(1)) < 0;\r\n        const performBuyNext = () => {\r\n          if (buyNextBtn.disabled) return;\r\n          const fresh = upgradeUiModel(areaKey, upgDef.id);\r\n          if (fresh.hmReadyToEvolve) return;\r\n          const target = fresh.hmNextMilestone;\r\n          if (!target || !fresh.lvlBn || target.cmp(fresh.lvlBn) <= 0) {\r\n            const { bought } = buyMax(areaKey, upgDef.id);\r\n            const boughtBn = bought instanceof BigNum ? bought : BigNum.fromAny(bought ?? 0);\r\n            if (!boughtBn.isZero?.()) {\r\n              playPurchaseSfx();\r\n              updateShopOverlay();\r\n              rerender();\r\n            }\r\n            return;\r\n          }\r\n\r\n          let deltaNum = 0;\r\n          try {\r\n            const diffPlain = target.sub(fresh.lvlBn).toPlainIntegerString?.();\r\n            if (diffPlain && diffPlain !== 'Infinity') deltaNum = Number(diffPlain);\r\n            else deltaNum = Number(target.sub(fresh.lvlBn).toString());\r\n          } catch {}\r\n          deltaNum = Math.max(0, Math.floor(deltaNum));\r\n\r\n          const walletRaw = bank[fresh.upg.costType]?.value;\r\n          const walletBn = walletRaw instanceof BigNum\r\n            ? walletRaw\r\n            : BigNum.fromAny(walletRaw ?? 0);\r\n          const evalResult = evaluateBulkPurchase(fresh.upg, fresh.lvlBn, walletBn, deltaNum);\r\n          const count = evalResult.count;\r\n          let reachable = false;\r\n          try {\r\n            const plain = count?.toPlainIntegerString?.();\r\n            if (plain && plain !== 'Infinity') reachable = Number(plain) >= deltaNum;\r\n            else reachable = Number(count ?? 0) >= deltaNum;\r\n          } catch {}\r\n\r\n          const purchase = reachable\r\n            ? buyTowards(areaKey, upgDef.id, deltaNum)\r\n            : buyMax(areaKey, upgDef.id);\r\n          const boughtBn = purchase.bought instanceof BigNum\r\n            ? purchase.bought\r\n            : BigNum.fromAny(purchase.bought ?? 0);\r\n          if (!boughtBn.isZero?.()) {\r\n            playPurchaseSfx();\r\n            updateShopOverlay();\r\n            rerender();\r\n          }\r\n        };\r\n\r\n        if ('PointerEvent' in window) {\r\n          buyNextBtn.addEventListener('pointerdown', (event) => {\r\n            if (event.pointerType === 'mouse') return;\r\n            if (typeof event.button === 'number' && event.button !== 0) return;\r\n\r\n            if (typeof markGhostTapTarget === 'function') {\r\n              markGhostTapTarget(buyNextBtn, 160);\r\n            }\r\n\r\n            performBuyNext();\r\n            event.preventDefault();\r\n          }, { passive: false });\r\n        } else {\r\n          buyNextBtn.addEventListener('touchstart', (event) => {\r\n            if (typeof markGhostTapTarget === 'function') {\r\n              markGhostTapTarget(buyNextBtn, 160);\r\n            }\r\n\r\n            performBuyNext();\r\n            event.preventDefault();\r\n          }, { passive: false });\r\n        }\r\n\r\n        buyNextBtn.addEventListener('click', (event) => {\r\n          if (IS_MOBILE) return;\r\n\r\n          if (typeof markGhostTapTarget === 'function') {\r\n            markGhostTapTarget(buyNextBtn, 160);\r\n          }\r\n\r\n          performBuyNext();\r\n        });\r\n        actions.appendChild(buyNextBtn);\r\n      }\r\n\r\n      (canAffordNext ? buyBtn : closeBtn).focus();\r\n    }\r\n\t\r\n\trecenterUnlockOverlayIfNeeded(model);\r\n  };\r\n\r\n  const onCurrencyChange = () => {\r\n    if (!upgOpenLocal) return;\r\n    rerender();\r\n  };\r\n\r\n  const onUpgradesChanged = () => {\r\n    if (!upgOpenLocal) return;\r\n    rerender();\r\n  };\r\n\r\n    window.addEventListener('currency:change', onCurrencyChange);\r\n    window.addEventListener('xp:change', onCurrencyChange);\r\n    window.addEventListener('xp:unlock', onCurrencyChange);\r\n    document.addEventListener('ccc:upgrades:changed', onUpgradesChanged);\r\n\r\n  // open + animate\r\n  rerender();\r\n  upgOverlayEl.classList.add('is-open');\r\n  upgOverlayEl.style.pointerEvents = 'auto';\r\n  blockInteraction(140);\r\n  upgSheetEl.style.transition = 'none';\r\n  upgSheetEl.style.transform = 'translateY(100%)';\r\n  void upgSheetEl.offsetHeight;\r\n  requestAnimationFrame(() => {\r\n    upgSheetEl.style.transition = '';\r\n    upgSheetEl.style.transform = '';\r\n  });\r\n\r\n  // ESC to close\r\n  const onKey = (e) => {\r\n    if (!upgOpenLocal) return;\r\n    if (e.key === 'Escape') {\r\n      e.preventDefault();\r\n      upgOpenLocal = false;\r\n      closeUpgradeMenu();\r\n    }\r\n  };\r\n  window.addEventListener('keydown', onKey, true);\r\n\r\n  upgOverlayCleanup = () => {\r\n    upgOpenLocal = false;\r\n      window.removeEventListener('currency:change', onCurrencyChange);\r\n      window.removeEventListener('xp:change', onCurrencyChange);\r\n      window.removeEventListener('xp:unlock', onCurrencyChange);\r\n\t  document.removeEventListener('ccc:upgrades:changed', onUpgradesChanged);\r\n      window.removeEventListener('keydown', onKey, true);\r\n  };\r\n}\r\n\r\n// ---------- Controls ----------\r\nfunction onKeydownForShop(e) {\r\n  if (!shopOpen) return;\r\n  if (e.key === 'Escape') {\r\n    e.preventDefault();\r\n    closeShop();\r\n  }\r\n}\r\n\r\nexport function openShop() {\r\n  ensureShopOverlay();\r\n\r\n  if (shopCloseTimer) {\r\n    clearTimeout(shopCloseTimer);\r\n    shopCloseTimer = null;\r\n  }\r\n\r\n  if (typeof updateDelveGlow === 'function') updateDelveGlow();\r\n  updateShopOverlay(true);\r\n\r\n  if (shopOpen) return;\r\n\r\n  shopOpen = true;\r\n  shopSheetEl.style.transition = 'none';\r\n  shopSheetEl.style.transform = '';\r\n  shopOverlayEl.style.pointerEvents = 'auto';\r\n\r\n  void shopSheetEl.offsetHeight;\r\nrequestAnimationFrame(() => {\r\nshopSheetEl.style.transition = '';\r\nshopOverlayEl.classList.add('is-open');\r\n\r\n__shopOpenStamp = performance.now(); // harmless to keep\r\n__shopPostOpenPointer = false;\r\n\r\n// Optional now; can keep or delete\r\nif (IS_MOBILE) {\r\n  try {\r\n    setTimeout(() => suppressNextGhostTap(240), 120);\r\n  } catch {}\r\n}\r\n\r\n  blockInteraction(10);\r\n  ensureCustomScrollbar();\r\n  const focusable =\r\n    shopOverlayEl.querySelector('#shop-grid .shop-upgrade') ||\r\n    shopOverlayEl.querySelector('#shop-grid');\r\n  if (focusable) focusable.focus();\r\n});\r\n}\r\n\r\nexport function closeShop(force = false) {\r\n  const forceClose = force === true;\r\n  const overlayOpen = shopOverlayEl?.classList?.contains('is-open');\r\n\r\n  if (!forceClose && !shopOpen && !overlayOpen) {\r\n    if (shopCloseTimer) {\r\n      clearTimeout(shopCloseTimer);\r\n      shopCloseTimer = null;\r\n    }\r\n    return;\r\n  }\r\n\r\n  if (shopCloseTimer) {\r\n    clearTimeout(shopCloseTimer);\r\n    shopCloseTimer = null;\r\n  }\r\n\r\n  shopOpen = false;\r\n  if (shopSheetEl) {\r\n    shopSheetEl.style.transition = '';\r\n    shopSheetEl.style.transform = '';\r\n  }\r\n  shopOverlayEl.classList.remove('is-open');\r\n  shopOverlayEl.style.pointerEvents = 'none';\r\n  __shopPostOpenPointer = false;\r\n}\r\n\r\n// ---------- Drag ----------\r\nfunction onDragStart(e) {\r\n  if (!shopOpen) return;\r\n\r\n  const clientY = typeof e.clientY === 'number'\r\n    ? e.clientY\r\n    : (e.touches && e.touches[0] ? e.touches[0].clientY : 0);\r\n\r\n  drag = { startY: clientY, lastY: clientY, startT: performance.now(), moved: 0, canceled: false };\r\n  shopSheetEl.style.transition = 'none';\r\n\r\n  window.addEventListener('pointermove', onDragMove);\r\n  window.addEventListener('pointerup', onDragEnd);\r\n  window.addEventListener('pointercancel', onDragCancel);\r\n}\r\n\r\nfunction onDragMove(e) {\r\n  if (!drag || drag.canceled) return;\r\n  const y = e.clientY;\r\n  if (typeof y !== 'number') return;\r\n\r\n  const dy = Math.max(0, y - drag.startY);\r\n  drag.lastY = y;\r\n  drag.moved = dy;\r\n  shopSheetEl.style.transform = `translateY(${dy}px)`;\r\n}\r\n\r\nfunction onDragEnd() {\r\n  if (!drag || drag.canceled) return cleanupDrag();\r\n\r\n  const dt = Math.max(1, performance.now() - drag.startT);\r\n  const dy = drag.moved;\r\n  const velocity = dy / dt;\r\n  const shouldClose = (velocity > 0.55 && dy > 40) || dy > 140;\r\n\r\n  if (shouldClose) {\r\n    suppressNextGhostTap(100);\r\n    blockInteraction(80);\r\n    shopSheetEl.style.transition = 'transform 140ms ease-out';\r\n    shopSheetEl.style.transform = 'translateY(100%)';\r\n    shopOpen = false;\r\n\r\n    shopCloseTimer = setTimeout(() => {\r\n      shopCloseTimer = null;\r\n      closeShop(true);\r\n    }, 150);\r\n  } else {\r\n    shopSheetEl.style.transition = 'transform 180ms ease';\r\n    shopSheetEl.style.transform = 'translateY(0)';\r\n  }\r\n\r\n  cleanupDrag();\r\n}\r\n\r\nfunction onDragCancel() {\r\n  if (!drag) return;\r\n  drag.canceled = true;\r\n  shopSheetEl.style.transition = 'transform 180ms ease';\r\n  shopSheetEl.style.transform = 'translateY(0)';\r\n  cleanupDrag();\r\n}\r\n\r\nfunction cleanupDrag() {\r\n  window.removeEventListener('pointermove', onDragMove);\r\n  window.removeEventListener('pointerup', onDragEnd);\r\n  window.removeEventListener('pointercancel', onDragCancel);\r\n  drag = null;\r\n}\r\n\r\nexport function updateShopOverlay(force = false) {\r\n  if (!force && !shopOpen) return;\r\n  buildUpgradesData();\r\n  renderShopGrid();\r\n}\r\n\r\nexport function setUpgradeCount() { updateShopOverlay(true); }\r\n\r\nexport function getUpgrades() { return upgrades; }\r\n", "// js/ui/hudButtons.js\r\n\r\nimport { openShop } from './shopOverlay.js';\r\nimport { getActiveSlot, hasModifiedSave } from '../util/storage.js';\r\nimport {\r\n  markGhostTapTarget,\r\n  shouldSkipGhostTap,\r\n} from '../util/ghostTapGuard.js';\r\n\r\nconst BASE_KEYS = {\r\n  SHOP: 'ccc:unlock:shop',\r\n  MAP:  'ccc:unlock:map',\r\n};\r\n\r\nfunction slotKey(base) {\r\n  const slot = getActiveSlot();\r\n  return slot == null ? base : `${base}:${slot}`;\r\n}\r\n\r\nfunction isUnlocked(base) {\r\n  const key = slotKey(base);\r\n  const slotRaw = localStorage.getItem(key);\r\n  if (slotRaw != null) return slotRaw === '1';\r\n  return localStorage.getItem(base) === '1';\r\n}\r\n\r\nexport function isShopUnlocked() {\r\n  ensureUnlockDefaults();\r\n  return isUnlocked(BASE_KEYS.SHOP);\r\n}\r\n\r\nexport function isMapUnlocked() {\r\n  ensureUnlockDefaults();\r\n  return isUnlocked(BASE_KEYS.MAP);\r\n}\r\n\r\nfunction setUnlocked(base, v) {\r\n  const val = v ? '1' : '0';\r\n  const key = slotKey(base);\r\n  localStorage.setItem(key, val);\r\n  if (key !== base && localStorage.getItem(base) != null) {\r\n    localStorage.setItem(base, val);\r\n  }\r\n  try {\r\n    window.dispatchEvent(new CustomEvent('unlock:change', {\r\n      detail: { key: base, slot: getActiveSlot() },\r\n    }));\r\n  } catch {}\r\n}\r\n\r\nfunction ensureUnlockDefaults() {\r\n  for (const key of Object.values(BASE_KEYS)) {\r\n    const sk = slotKey(key);\r\n    const hasSlot = localStorage.getItem(sk) != null;\r\n    if (!hasSlot) localStorage.setItem(sk, '0');\r\n  }\r\n}\r\n\r\nfunction setButtonVisible(key, visible) {\r\n  const el = document.querySelector(`.hud-bottom [data-btn=\"${key}\"]`);\r\n  if (el) el.hidden = !visible;\r\n}\r\n\r\nfunction updateShopButtonTamperState() {\r\n  const btn = document.querySelector('.hud-bottom [data-btn=\"shop\"]');\r\n  if (!btn) return;\r\n  btn.classList.toggle('btn-shop--modified', hasModifiedSave());\r\n}\r\n\r\nfunction phonePortrait() {\r\n  const isCoarse = window.matchMedia('(pointer: coarse)').matches;\r\n  const isPortrait = window.innerHeight >= window.innerWidth;\r\n  return isCoarse && isPortrait;\r\n}\r\n\r\nlet listenersBound = false;\r\nlet actionsBound = false;\r\n\r\n// ===============================\r\n// HUD layout\r\n// ===============================\r\nexport function applyHudLayout() {\r\n  const hud = document.querySelector('.hud-bottom');\r\n  if (!hud) return;\r\n\r\n  const mapBtn = hud.querySelector('[data-btn=\"map\"]');\r\n  const isMapVisible = !!(mapBtn && !mapBtn.hidden);\r\n  const isPhonePortrait = phonePortrait();\r\n  const baseOrder = ['help', 'shop', 'stats', 'map'];\r\n  const mobileMapOrder = ['help', 'stats', 'shop', 'map'];\r\n\r\n  const desiredOrder = isPhonePortrait && isMapVisible ? mobileMapOrder : baseOrder;\r\n\r\n  const desiredNodes = desiredOrder\r\n    .map(key => hud.querySelector(`.game-btn[data-btn=\"${key}\"]`))\r\n    .filter(Boolean);\r\n  const remainingNodes = [...hud.children].filter(el => !desiredNodes.includes(el));\r\n  const finalOrder = [...desiredNodes, ...remainingNodes];\r\n\r\n  const needsReorder = finalOrder.length && finalOrder.some((el, idx) => hud.children[idx] !== el);\r\n  if (needsReorder) {\r\n    const frag = document.createDocumentFragment();\r\n    finalOrder.forEach(node => frag.appendChild(node));\r\n    hud.appendChild(frag);\r\n  }\r\n\r\n  const all = [...hud.querySelectorAll('.game-btn')];\r\n  const visible = all.filter(el => !el.hidden);\r\n\r\n  // Reset previous hints\r\n  hud.classList.remove('is-2','is-3','is-4');\r\n  visible.forEach(el => {\r\n    el.style.gridColumn = '';\r\n    el.style.gridRow = '';\r\n    el.classList.remove('span-2');\r\n    el.style.order = '';\r\n  });\r\n  hud.style.gridTemplateColumns = '';\r\n  hud.classList.add(`is-${visible.length}`);\r\n\r\n  // Desktop centering\r\n  if (!isPhonePortrait) {\r\n    const cs  = getComputedStyle(hud);\r\n    const gap = parseFloat(cs.columnGap || cs.gap || '0') || 0;\r\n    const cw  = hud.clientWidth;\r\n    const per = Math.max(180, Math.floor((cw - 3 * gap) / 4));\r\n\r\n    if (visible.length === 2) {\r\n      hud.style.gridTemplateColumns = `1fr ${per}px ${per}px 1fr`;\r\n      visible[0].style.gridColumn = '2';\r\n      visible[1].style.gridColumn = '3';\r\n      return;\r\n    }\r\n    if (visible.length === 3) {\r\n      hud.style.gridTemplateColumns = `1fr ${per}px ${per}px ${per}px 1fr`;\r\n      visible[0].style.gridColumn = '2';\r\n      visible[1].style.gridColumn = '3';\r\n      visible[2].style.gridColumn = '4';\r\n      return;\r\n    }\r\n  }\r\n\r\n  // Mobile portrait (2\u00D72): Help & Stats top; Shop full width bottom\r\n  if (isPhonePortrait && visible.length === 3) {\r\n    const help  = hud.querySelector('[data-btn=\"help\"]:not([hidden])');\r\n    const stats = hud.querySelector('[data-btn=\"stats\"]:not([hidden])');\r\n    const shop  = hud.querySelector('[data-btn=\"shop\"]:not([hidden])');\r\n\r\n    if (help && stats && shop) {\r\n      help.style.gridColumn  = '1'; help.style.gridRow  = '1';\r\n      stats.style.gridColumn = '2'; stats.style.gridRow = '1';\r\n      shop.style.gridColumn  = '1 / -1'; shop.style.gridRow = '2';\r\n    }\r\n  }\r\n}\r\n\r\nexport function initHudButtons() {\r\n  ensureUnlockDefaults();\r\n\r\n  // Always-on buttons\r\n  setButtonVisible('help',  true);\r\n  setButtonVisible('stats', true);\r\n\r\n  setButtonVisible('shop', isUnlocked(BASE_KEYS.SHOP));\r\n  setButtonVisible('map',  isUnlocked(BASE_KEYS.MAP));\r\n  updateShopButtonTamperState();\r\n\r\n  applyHudLayout();\r\n\r\n  if (!listenersBound) {\r\n    listenersBound = true;\r\n    window.addEventListener('resize', applyHudLayout);\r\n    window.addEventListener('orientationchange', applyHudLayout);\r\n    window.addEventListener('saveSlot:change', () => {\r\n      setButtonVisible('shop', isUnlocked(BASE_KEYS.SHOP));\r\n      setButtonVisible('map',  isUnlocked(BASE_KEYS.MAP));\r\n      updateShopButtonTamperState();\r\n      applyHudLayout();\r\n    });\r\n    window.addEventListener('saveSlot:modified', (event) => {\r\n      const active = getActiveSlot();\r\n      const slot = event?.detail?.slot;\r\n      if (slot != null && active != null && slot !== active) return;\r\n      updateShopButtonTamperState();\r\n    });\r\n  }\r\n\r\n  // Bind actions once (click \u2192 open shop)\r\n  if (!actionsBound) {\r\n    actionsBound = true;\r\n    const hud = document.querySelector('.hud-bottom');\r\n    if (hud) {\r\n      const activate = (btn) => {\r\n        if (!btn) return;\r\n        const key = btn.getAttribute('data-btn');\r\n        if (key === 'shop') {\r\n          openShop();\r\n        }\r\n        // future: help/settings/map can import their own modules, too\r\n      };\r\n\r\n      const onClick = (e) => {\r\n        const btn = e.target.closest('.game-btn');\r\n        if (!btn) return;\r\n        const key = btn.getAttribute('data-btn');\r\n        if (key !== 'shop') return;\r\n        if (shouldSkipGhostTap(btn)) return;\r\n        markGhostTapTarget(btn);\r\n        activate(btn);\r\n      };\r\n\r\n      const hasPointerEvents = typeof window !== 'undefined' && 'PointerEvent' in window;\r\n\t  \r\n      const onPointerDown = (e) => {\r\n        if (e.pointerType === 'mouse') return;\r\n        if (typeof e.button === 'number' && e.button !== 0) return;\r\n        const btn = e.target.closest('.game-btn');\r\n        if (!btn) return;\r\n        const key = btn.getAttribute('data-btn');\r\n        if (key !== 'shop') return;\r\n        markGhostTapTarget(btn);\r\n        activate(btn);\r\n        e.preventDefault();\r\n      };\r\n\r\n      const onTouchStart = (e) => {\r\n        const btn = e.target.closest('.game-btn');\r\n        if (!btn) return;\r\n        const key = btn.getAttribute('data-btn');\r\n        if (key !== 'shop') return;\r\n        markGhostTapTarget(btn);\r\n        activate(btn);\r\n        e.preventDefault();\r\n      };\r\n\r\n      hud.addEventListener('click', onClick, { passive: true });\r\n      if (hasPointerEvents) {\r\n        hud.addEventListener('pointerdown', onPointerDown, { passive: false });\r\n      } else {\r\n        hud.addEventListener('touchstart', onTouchStart, { passive: false });\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n// Convenience helpers (write both keys)\r\nexport function unlockShop() { setUnlocked(BASE_KEYS.SHOP, true);  setButtonVisible('shop', true); applyHudLayout(); }\r\nexport function unlockMap()  { setUnlocked(BASE_KEYS.MAP,  true);  setButtonVisible('map',  true); applyHudLayout(); }\r\nexport function lockShop()   { setUnlocked(BASE_KEYS.SHOP, false); setButtonVisible('shop', false); applyHudLayout(); }\r\nexport function lockMap()    { setUnlocked(BASE_KEYS.MAP,  false); setButtonVisible('map',  false); applyHudLayout(); }\r\n", "// js/util/debugPanel.js\r\n// Using a debug panel is much faster and more convenient than\r\n// Editing local storage every time I want to change something.\r\n\r\nimport { BigNum } from './bigNum.js';\r\nimport { formatNumber } from './numFormat.js';\r\nimport {\r\n    bank,\r\n    CURRENCIES,\r\n    KEYS,\r\n    getActiveSlot,\r\n    markSaveSlotModified,\r\n    peekCurrency,\r\n    primeStorageWatcherSnapshot,\r\n    setCurrency,\r\n    setCurrencyMultiplierBN,\r\n} from './storage.js';\r\nimport { broadcastXpChange, computeCoinMultiplierForXpLevel, getXpRequirementForXpLevel, getXpState, initXpSystem, resetXpProgress, unlockXpSystem } from '../game/xpSystem.js';\r\nimport { broadcastMutationChange, computeMutationMultiplierForLevel, computeMutationRequirementForLevel, getMutationMultiplier, getMutationState, initMutationSystem, setMutationUnlockedForDebug, unlockMutationSystem } from '../game/mutationSystem.js';\r\nimport { IS_MOBILE } from '../main.js';\r\nimport {\r\n    AREA_KEYS,\r\n    computeDefaultUpgradeCost,\r\n    computeUpgradeEffects,\r\n    getLevel,\r\n    getMpValueMultiplierBn,\r\n    getUpgradesForArea,\r\n    markUpgradePermanentlyUnlocked,\r\n    clearPermanentUpgradeUnlock,\r\n    setLevel,\r\n} from '../game/upgrades.js';\r\nimport { computeForgeGoldFromInputs, getForgeDebugOverrideState, hasDoneForgeReset, isForgeUnlocked, setForgeDebugOverride, setForgeResetCompleted, updateResetPanel } from '../ui/merchantDelve/resetTab.js';\r\nimport { isMapUnlocked, isShopUnlocked, lockMap, lockShop, unlockMap, unlockShop } from '../ui/hudButtons.js';\r\nimport { DLG_CATALOG, MERCHANT_DLG_STATE_KEY_BASE } from '../ui/merchantDelve/dlgTab.js';\r\nimport { markGhostTapTarget, shouldSkipGhostTap } from './ghostTapGuard.js';\r\n\r\nconst DEBUG_PANEL_STYLE_ID = 'debug-panel-style';\r\nconst DEBUG_PANEL_ID = 'debug-panel';\r\nconst DEBUG_PANEL_TOGGLE_ID = 'debug-panel-toggle';\r\nlet debugPanelOpen = false;\r\nlet debugPanelAccess = false;\r\nlet debugPanelCleanups = [];\r\nlet debugPanelExpansionState = createEmptyExpansionState();\r\nlet debugPanelScrollTop = 0;\r\nlet sectionKeyCounter = 0;\r\nlet subsectionKeyCounter = 0;\r\nconst liveBindings = [];\r\nlet actionLogContainer = null;\r\n\r\nconst currencyOverrides = new Map();\r\nconst currencyOverrideBaselines = new Map();\r\nconst currencyOverrideApplications = new Set();\r\nconst statOverrides = new Map();\r\nconst statOverrideBaselines = new Map();\r\nconst lockedStorageKeys = new Set();\r\nif (typeof window !== 'undefined') {\r\n    window.__cccLockedStorageKeys = lockedStorageKeys;\r\n}\r\nlet storageLockPatched = false;\r\nlet originalSetItem = null;\r\nlet originalRemoveItem = null;\r\n\r\nconst STAT_MULTIPLIER_STORAGE_PREFIX = 'ccc:debug:stat-mult';\r\nconst ACTION_LOG_STORAGE_PREFIX = 'ccc:actionLog';\r\nconst MAX_ACTION_LOG_ENTRIES = 100;\r\n\r\nfunction isOnMenu() {\r\n    const menuRoot = document.querySelector('.menu-root');\r\n    if (!menuRoot) return false;\r\n\r\n    const style = window.getComputedStyle?.(menuRoot);\r\n    if (!style) return menuRoot.style.display !== 'none';\r\n\r\n    return style.display !== 'none' && style.visibility !== 'hidden' && !menuRoot.hidden;\r\n}\r\n\r\nfunction isGameVisible() {\r\n    const gameRoot = document.getElementById('game-root');\r\n    if (!gameRoot) return false;\r\n\r\n    const style = window.getComputedStyle?.(gameRoot);\r\n    if (!style) {\r\n        return gameRoot.style.display !== 'none'\r\n            && gameRoot.style.visibility !== 'hidden'\r\n            && !gameRoot.hidden;\r\n    }\r\n\r\n    return style.display !== 'none' && style.visibility !== 'hidden' && !gameRoot.hidden;\r\n}\r\n\r\nfunction addDebugPanelCleanup(fn) {\r\n    if (typeof fn === 'function') {\r\n        debugPanelCleanups.push(fn);\r\n    }\r\n}\r\n\r\nfunction createEmptyExpansionState() {\r\n    return { sections: new Set(), subsections: new Set() };\r\n}\r\n\r\nfunction captureDebugPanelExpansionState() {\r\n    const panel = document.getElementById(DEBUG_PANEL_ID);\r\n    if (!panel) return createEmptyExpansionState();\r\n\r\n    const sections = new Set();\r\n    panel.querySelectorAll('.debug-panel-section-toggle').forEach((toggle) => {\r\n        const key = toggle.dataset.sectionKey ?? toggle.textContent;\r\n        if (toggle.classList.contains('expanded')) {\r\n            sections.add(key);\r\n        }\r\n    });\r\n\r\n    const subsections = new Set();\r\n    panel.querySelectorAll('.debug-panel-subsection-toggle').forEach((toggle) => {\r\n        const key = toggle.dataset.subsectionKey ?? toggle.textContent;\r\n        if (toggle.classList.contains('expanded')) {\r\n            subsections.add(key);\r\n        }\r\n    });\r\n\r\n    return { sections, subsections };\r\n}\r\n\r\nfunction applyDebugPanelExpansionState(panel) {\r\n    const { sections, subsections } = debugPanelExpansionState ?? createEmptyExpansionState();\r\n\r\n    panel.querySelectorAll('.debug-panel-section-toggle').forEach((toggle) => {\r\n        const key = toggle.dataset.sectionKey ?? toggle.textContent;\r\n        if (!sections.has(key)) return;\r\n        const content = toggle.nextElementSibling;\r\n        toggle.classList.add('expanded');\r\n        if (content) content.classList.add('active');\r\n    });\r\n\r\n    panel.querySelectorAll('.debug-panel-subsection-toggle').forEach((toggle) => {\r\n        const key = toggle.dataset.subsectionKey ?? toggle.textContent;\r\n        if (!subsections.has(key)) return;\r\n        const content = toggle.nextElementSibling;\r\n        toggle.classList.add('expanded');\r\n        if (content) content.classList.add('active');\r\n    });\r\n}\r\n\r\nfunction cleanupDebugPanelResources() {\r\n    debugPanelCleanups.forEach((fn) => {\r\n        try { fn?.(); } catch {}\r\n    });\r\n    debugPanelCleanups = [];\r\n    liveBindings.length = 0;\r\n}\r\n\r\nfunction registerLiveBinding(binding) {\r\n    if (!binding || typeof binding.refresh !== 'function') return;\r\n    liveBindings.push(binding);\r\n}\r\n\r\nfunction refreshLiveBindings(predicate) {\r\n    liveBindings.forEach((binding) => {\r\n        if (typeof predicate === 'function' && !predicate(binding)) return;\r\n        try { binding.refresh(); } catch {}\r\n    });\r\n}\r\n\r\nfunction setupLiveBindingListeners() {\r\n    if (typeof window === 'undefined') return;\r\n\r\n    const currencyHandler = (event) => {\r\n        const { key, slot } = event?.detail ?? {};\r\n        const targetSlot = slot ?? getActiveSlot();\r\n        refreshLiveBindings((binding) => binding.type === 'currency'\r\n            && binding.key === key\r\n            && binding.slot === targetSlot);\r\n    };\r\n    window.addEventListener('currency:change', currencyHandler, { passive: true });\r\n    addDebugPanelCleanup(() => window.removeEventListener('currency:change', currencyHandler));\r\n\r\n    const currencyMultiplierHandler = (event) => {\r\n        const { key, slot } = event?.detail ?? {};\r\n        const targetSlot = slot ?? getActiveSlot();\r\n        refreshLiveBindings((binding) => binding.type === 'currency-mult'\r\n            && binding.key === key\r\n            && binding.slot === targetSlot);\r\n    };\r\n    window.addEventListener('currency:multiplier', currencyMultiplierHandler, { passive: true });\r\n    addDebugPanelCleanup(() => window.removeEventListener('currency:multiplier', currencyMultiplierHandler));\r\n\r\n    const xpHandler = (event) => {\r\n        const { slot } = event?.detail ?? {};\r\n        const targetSlot = slot ?? getActiveSlot();\r\n        refreshLiveBindings((binding) => binding.type === 'xp'\r\n            && binding.slot === targetSlot);\r\n    };\r\n    window.addEventListener('xp:change', xpHandler, { passive: true });\r\n    addDebugPanelCleanup(() => window.removeEventListener('xp:change', xpHandler));\r\n\r\n    const mutationHandler = () => {\r\n        const targetSlot = getActiveSlot();\r\n        refreshLiveBindings((binding) => binding.type === 'mutation'\r\n            && binding.slot === targetSlot);\r\n        refreshLiveBindings((binding) => binding.type === 'stat-mult'\r\n            && binding.key === 'mutation'\r\n            && binding.slot === targetSlot);\r\n    };\r\n    window.addEventListener('mutation:change', mutationHandler, { passive: true });\r\n    addDebugPanelCleanup(() => window.removeEventListener('mutation:change', mutationHandler));\r\n\r\n    const upgradeHandler = () => {\r\n        const targetSlot = getActiveSlot();\r\n        refreshLiveBindings((binding) => binding.type === 'upgrade'\r\n            && binding.slot === targetSlot);\r\n        refreshLiveBindings((binding) => binding.type === 'currency-mult'\r\n            && binding.slot === targetSlot);\r\n        refreshLiveBindings((binding) => binding.type === 'stat-mult'\r\n            && binding.slot === targetSlot);\r\n    };\r\n    document.addEventListener('ccc:upgrades:changed', upgradeHandler, { passive: true });\r\n    addDebugPanelCleanup(() => document.removeEventListener('ccc:upgrades:changed', upgradeHandler));\r\n\r\n    const slotHandler = () => {\r\n        const targetSlot = getActiveSlot();\r\n        refreshLiveBindings((binding) => binding.slot === targetSlot);\r\n    };\r\n    window.addEventListener('saveSlot:change', slotHandler, { passive: true });\r\n    addDebugPanelCleanup(() => window.removeEventListener('saveSlot:change', slotHandler));\r\n\r\n    const unlockHandler = (event) => {\r\n        const { slot, key } = event?.detail ?? {};\r\n        const targetSlot = slot ?? getActiveSlot();\r\n        refreshLiveBindings((binding) => binding.type === 'unlock'\r\n            && (binding.slot == null || binding.slot === targetSlot)\r\n            && (binding.key == null || binding.key === key));\r\n    };\r\n    window.addEventListener('unlock:change', unlockHandler, { passive: true });\r\n    addDebugPanelCleanup(() => window.removeEventListener('unlock:change', unlockHandler));\r\n}\r\n\r\nconst XP_KEY_PREFIX = 'ccc:xp';\r\nconst XP_KEYS = {\r\n    unlock: (slot) => `${XP_KEY_PREFIX}:unlocked:${slot}`,\r\n    level:  (slot) => `${XP_KEY_PREFIX}:level:${slot}`,\r\n    progress: (slot) => `${XP_KEY_PREFIX}:progress:${slot}`,\r\n};\r\n\r\nconst MUTATION_KEY_PREFIX = 'ccc:mutation';\r\nconst MUTATION_KEYS = {\r\n    unlock: (slot) => `${MUTATION_KEY_PREFIX}:unlocked:${slot}`,\r\n    level:  (slot) => `${MUTATION_KEY_PREFIX}:level:${slot}`,\r\n    progress: (slot) => `${MUTATION_KEY_PREFIX}:progress:${slot}`,\r\n};\r\n\r\nconst STAT_MULTIPLIERS = [\r\n    { key: 'xp', label: 'XP' },\r\n    { key: 'mutation', label: 'MP' },\r\n];\r\n\r\nfunction getAreas() {\r\n    return [\r\n        {\r\n            key: AREA_KEYS.STARTER_COVE,\r\n            title: 'The Cove',\r\n            currencies: [\r\n                { key: CURRENCIES.COINS, label: 'Coins' },\r\n                { key: CURRENCIES.BOOKS, label: 'Books' },\r\n                { key: CURRENCIES.GOLD,  label: 'Gold'  },\r\n            ],\r\n            stats: [\r\n                { key: 'xp', label: 'XP' },\r\n                { key: 'mutation', label: 'MP' },\r\n            ],\r\n        },\r\n    ];\r\n}\r\n\r\n\r\nfunction ensureDebugPanelStyles() {\r\n    if (document.getElementById(DEBUG_PANEL_STYLE_ID)) return;\r\n\r\n    const existingLink = document.querySelector(`link[href$=\"css/misc/debug.css\"]`);\r\n    if (existingLink) {\r\n        existingLink.id = DEBUG_PANEL_STYLE_ID;\r\n        return;\r\n    }\r\n\r\n    const bundledStylesheet = document.querySelector('link[href$=\"styles.css\"]');\r\n    if (bundledStylesheet) {\r\n        const marker = document.createElement('meta');\r\n        marker.id = DEBUG_PANEL_STYLE_ID;\r\n        marker.setAttribute('data-debug-panel-styles', 'bundled');\r\n        document.head.appendChild(marker);\r\n        return;\r\n    }\r\n\r\n    const link = document.createElement('link');\r\n    link.rel = 'stylesheet';\r\n    link.href = 'css/misc/debug.css';\r\n    link.id = DEBUG_PANEL_STYLE_ID;\r\n    document.head.appendChild(link);\r\n}\r\n\r\nfunction applyMobileGhostTapToDropdown(select) {\r\n    if (!select || !IS_MOBILE || typeof window === 'undefined') return;\r\n\r\n    const mark = () => markGhostTapTarget(select, 0);\r\n    const hasPointerEvents = 'PointerEvent' in window;\r\n\r\n    if (hasPointerEvents) {\r\n        select.addEventListener('pointerdown', (event) => {\r\n            if (event.pointerType === 'mouse') return;\r\n            if (typeof event.button === 'number' && event.button !== 0) return;\r\n            mark();\r\n        }, { passive: true });\r\n    } else {\r\n        select.addEventListener('touchstart', mark, { passive: true });\r\n    }\r\n\r\n    select.addEventListener('click', mark, { passive: true });\r\n}\r\n\r\nfunction removeDebugPanelToggleButton() {\r\n    const existingButton = document.getElementById(DEBUG_PANEL_TOGGLE_ID);\r\n    if (existingButton) existingButton.remove();\r\n}\r\n\r\nfunction shouldShowDebugPanelToggleButton() {\r\n    return debugPanelAccess\r\n        && IS_MOBILE\r\n        && getActiveSlot() != null\r\n        && !isOnMenu()\r\n        && isGameVisible();\r\n}\r\n\r\nfunction onMenuVisibilityChange(event) {\r\n    if (event?.detail?.visible) {\r\n        closeDebugPanel();\r\n    }\r\n    createDebugPanelToggleButton();\r\n}\r\n\r\nfunction createSection(title, contentId, contentBuilder) {\r\n    const section = document.createElement('div');\r\n    section.className = 'debug-panel-section';\r\n\r\n    const toggle = document.createElement('button');\r\n    toggle.className = 'debug-panel-section-toggle';\r\n    toggle.type = 'button';\r\n    toggle.textContent = title;\r\n    const stateKey = contentId || `${title}-${sectionKeyCounter++}`;\r\n    toggle.dataset.sectionKey = stateKey;\r\n    section.appendChild(toggle);\r\n\r\n    const content = document.createElement('div');\r\n    content.className = 'debug-panel-section-content';\r\n    content.id = contentId;\r\n    content.dataset.sectionKey = stateKey;\r\n    contentBuilder(content);\r\n    section.appendChild(content);\r\n\r\n    let lastPointerType = null;\r\n\r\n    const handleToggle = (event) => {\r\n        if (event?.isTrusted && shouldSkipGhostTap(toggle)) return;\r\n        markGhostTapTarget(toggle);\r\n        const expanded = toggle.classList.toggle('expanded');\r\n        content.classList.toggle('active', expanded);\r\n    };\r\n\r\n    if (typeof window !== 'undefined' && 'PointerEvent' in window) {\r\n        toggle.addEventListener('pointerdown', (event) => {\r\n            lastPointerType = event.pointerType || null;\r\n            if (event.pointerType === 'mouse') return;\r\n            event.preventDefault();\r\n            handleToggle(event);\r\n        });\r\n    }\r\n\r\n    toggle.addEventListener('click', (event) => {\r\n        if (lastPointerType && lastPointerType !== 'mouse') {\r\n            lastPointerType = null;\r\n            return;\r\n        }\r\n        lastPointerType = null;\r\n        handleToggle(event);\r\n    });\r\n\r\n    return section;\r\n}\r\n\r\nfunction createSubsection(title, contentBuilder, { defaultExpanded = false } = {}) {\r\n    const container = document.createElement('div');\r\n    container.className = 'debug-panel-subsection';\r\n\r\n    const toggle = document.createElement('button');\r\n    toggle.type = 'button';\r\n    toggle.className = 'debug-panel-subsection-toggle';\r\n    toggle.textContent = title;\r\n    const stateKey = `${title}-${subsectionKeyCounter++}`;\r\n    toggle.dataset.subsectionKey = stateKey;\r\n    container.appendChild(toggle);\r\n\r\n    const content = document.createElement('div');\r\n    content.className = 'debug-panel-subsection-content';\r\n    content.dataset.subsectionKey = stateKey;\r\n    contentBuilder(content);\r\n    container.appendChild(content);\r\n\r\n    let lastPointerType = null;\r\n\r\n    const handleToggle = (event) => {\r\n        if (event?.isTrusted && shouldSkipGhostTap(toggle)) return;\r\n        markGhostTapTarget(toggle);\r\n        const expanded = toggle.classList.toggle('expanded');\r\n        content.classList.toggle('active', expanded);\r\n    };\r\n\r\n    if (typeof window !== 'undefined' && 'PointerEvent' in window) {\r\n        toggle.addEventListener('pointerdown', (event) => {\r\n            lastPointerType = event.pointerType || null;\r\n            if (event.pointerType === 'mouse') return;\r\n            event.preventDefault();\r\n            handleToggle(event);\r\n        });\r\n    }\r\n\r\n    toggle.addEventListener('click', (event) => {\r\n        if (lastPointerType && lastPointerType !== 'mouse') {\r\n            lastPointerType = null;\r\n            return;\r\n        }\r\n        lastPointerType = null;\r\n        handleToggle(event);\r\n    });\r\n\r\n    if (defaultExpanded) {\r\n        toggle.classList.add('expanded');\r\n        content.classList.add('active');\r\n    }\r\n\r\n    return container;\r\n}\r\n\r\nfunction bigNumEquals(a, b) {\r\n    if (a === b) return true;\r\n    if (a == null || b == null) return a == null && b == null;\r\n    if (typeof a?.cmp === 'function') {\r\n        try { return a.cmp(b) === 0; } catch {}\r\n    }\r\n    if (typeof b?.cmp === 'function') {\r\n        try { return b.cmp(a) === 0; } catch {}\r\n    }\r\n    try { return Object.is(String(a), String(b)); }\r\n    catch { return false; }\r\n}\r\n\r\nfunction bigNumToFiniteNumber(value) {\r\n    try {\r\n        const fromScientific = value?.toScientific?.(18);\r\n        const num = Number.parseFloat(fromScientific ?? value);\r\n        return Number.isFinite(num) ? num : Number.NaN;\r\n    } catch {\r\n        return Number.NaN;\r\n    }\r\n}\r\n\r\nfunction getCurrencyStorageKey(currencyKey, slot = getActiveSlot()) {\r\n    const resolvedSlot = slot ?? getActiveSlot();\r\n    if (resolvedSlot == null) return null;\r\n    return `${KEYS.CURRENCY[currencyKey]}:${resolvedSlot}`;\r\n}\r\n\r\nfunction getCurrencyValueForSlot(currencyKey, slot = getActiveSlot()) {\r\n    const resolvedSlot = slot ?? getActiveSlot();\r\n    if (resolvedSlot == null) return BigNum.fromInt(0);\r\n\r\n    const handle = bank?.[currencyKey];\r\n    if (handle) {\r\n        try { return handle.value ?? BigNum.fromInt(0); }\r\n        catch {}\r\n    }\r\n\r\n    try { return peekCurrency(resolvedSlot, currencyKey); }\r\n    catch { return BigNum.fromInt(0); }\r\n}\r\n\r\nfunction applyCurrencyState(currencyKey, value, slot = getActiveSlot()) {\r\n    const resolvedSlot = slot ?? getActiveSlot();\r\n    const previous = getCurrencyValueForSlot(currencyKey, resolvedSlot);\r\n    if (resolvedSlot == null || resolvedSlot !== getActiveSlot()) {\r\n        return { previous, next: previous };\r\n    }\r\n\r\n    const storageKey = getCurrencyStorageKey(currencyKey, resolvedSlot);\r\n    const wasLocked = storageKey && isStorageKeyLocked(storageKey);\r\n\r\n    if (wasLocked) unlockStorageKey(storageKey);\r\n\r\n    let next = previous;\r\n    try {\r\n        markSaveSlotModified(resolvedSlot);\r\n        const effective = setCurrency(currencyKey, value, { previous });\r\n        next = effective ?? previous;\r\n        if (storageKey) primeStorageWatcherSnapshot(storageKey);\r\n    } catch {}\r\n    finally {\r\n        if (wasLocked) lockStorageKey(storageKey);\r\n    }\r\n\r\n    refreshLiveBindings((binding) => binding.type === 'currency'\r\n        && binding.key === currencyKey\r\n        && binding.slot === resolvedSlot);\r\n\r\n    return { previous, next };\r\n}\r\n\r\nfunction buildOverrideKey(slot, key) {\r\n    return `${slot ?? 'null'}::${key}`;\r\n}\r\n\r\nfunction getCurrencyOverride(slot, key) {\r\n    return currencyOverrides.get(buildOverrideKey(slot, key)) ?? null;\r\n}\r\n\r\nfunction getCurrencyMultiplierStorageKey(currencyKey, slot = getActiveSlot()) {\r\n    const resolvedSlot = slot ?? getActiveSlot();\r\n    if (!currencyKey || resolvedSlot == null) return null;\r\n    return `${KEYS.MULTIPLIER[currencyKey]}:${resolvedSlot}`;\r\n}\r\n\r\nfunction isCurrencyMultiplierLocked(currencyKey, slot = getActiveSlot()) {\r\n    return isStorageKeyLocked(getCurrencyMultiplierStorageKey(currencyKey, slot));\r\n}\r\n\r\nfunction clearCurrencyMultiplierOverride(currencyKey, slot = getActiveSlot()) {\r\n    const cacheKey = buildOverrideKey(slot, currencyKey);\r\n    currencyOverrides.delete(cacheKey);\r\n    currencyOverrideBaselines.delete(cacheKey);\r\n    refreshLiveBindings((binding) => binding.type === 'currency-mult'\r\n        && binding.key === currencyKey\r\n        && binding.slot === slot);\r\n}\r\n\r\nfunction getStatOverride(slot, key) {\r\n    const lockAwareRefresh = !isStatMultiplierLocked(key, slot);\r\n    const cacheKey = buildOverrideKey(slot, key);\r\n    const cached = statOverrides.get(cacheKey);\r\n    if (!lockAwareRefresh && cached) return cached;\r\n\r\n    const fromStorage = loadStatMultiplierOverrideFromStorage(key, slot);\r\n    if (!fromStorage) {\r\n        if (lockAwareRefresh) statOverrides.delete(cacheKey);\r\n        return null;\r\n    }\r\n\r\n    statOverrides.set(cacheKey, fromStorage);\r\n    return fromStorage;\r\n}\r\n\r\nfunction notifyStatMultiplierChange(statKey, slot) {\r\n    refreshLiveBindings((binding) => binding.type === 'stat-mult'\r\n        && binding.key === statKey\r\n        && binding.slot === slot);\r\n}\r\n\r\nfunction clearStatMultiplierOverride(statKey, slot = getActiveSlot()) {\r\n    const storageKey = getStatMultiplierStorageKey(statKey, slot);\r\n    statOverrides.delete(buildOverrideKey(slot, statKey));\r\n    statOverrideBaselines.delete(buildOverrideKey(slot, statKey));\r\n    if (!storageKey || typeof localStorage === 'undefined') return;\r\n    if (isStorageKeyLocked(storageKey)) return;\r\n    try { localStorage.removeItem(storageKey); } catch {}\r\n    notifyStatMultiplierChange(statKey, slot);\r\n}\r\n\r\nfunction isStatMultiplierLocked(statKey, slot = getActiveSlot()) {\r\n    return isStorageKeyLocked(getStatMultiplierStorageKey(statKey, slot));\r\n}\r\n\r\nfunction getLockedStatOverride(slot, statKey) {\r\n    if (!isStatMultiplierLocked(statKey, slot)) return null;\r\n    return getStatOverride(slot, statKey);\r\n}\r\n\r\nfunction getStatMultiplierDisplayValue(statKey, slot = getActiveSlot()) {\r\n    const gameValue = getGameStatMultiplier(statKey);\r\n    const effectiveOverride = getEffectiveStatMultiplierOverride(statKey, slot, gameValue);\r\n    return effectiveOverride ?? gameValue;\r\n}\r\n\r\nfunction getStatMultiplierStorageKey(statKey, slot = getActiveSlot()) {\r\n    if (!statKey) return null;\r\n    const resolvedSlot = slot ?? getActiveSlot();\r\n    if (resolvedSlot == null) return null;\r\n    return `${STAT_MULTIPLIER_STORAGE_PREFIX}:${statKey}:${resolvedSlot}`;\r\n}\r\n\r\nfunction getGameStatMultiplier(statKey) {\r\n    try {\r\n        if (statKey === 'xp') {\r\n            const { xpGainMultiplier } = computeUpgradeEffects(AREA_KEYS.STARTER_COVE) ?? {};\r\n            if (xpGainMultiplier) return xpGainMultiplier;\r\n        } else if (statKey === 'mutation') {\r\n            const valueMult = getMpValueMultiplierBn?.();\r\n            if (valueMult) return valueMult;\r\n\r\n            const mult = getMutationMultiplier();\r\n            if (mult) return mult;\r\n        }\r\n    } catch {}\r\n\r\n    return BigNum.fromInt(1);\r\n}\r\n\r\nfunction loadStatMultiplierOverrideFromStorage(statKey, slot = getActiveSlot()) {\r\n    const storageKey = getStatMultiplierStorageKey(statKey, slot);\r\n    if (!storageKey || typeof localStorage === 'undefined') return null;\r\n    const raw = localStorage.getItem(storageKey);\r\n    if (!raw) return null;\r\n    try { return BigNum.fromAny(raw); }\r\n    catch { return null; }\r\n}\r\n\r\nfunction storeStatMultiplierOverride(statKey, slot, value) {\r\n    const storageKey = getStatMultiplierStorageKey(statKey, slot);\r\n    if (!storageKey || typeof localStorage === 'undefined') return;\r\n    try {\r\n        const bn = value instanceof BigNum ? value : BigNum.fromAny(value ?? 1);\r\n        const locked = isStorageKeyLocked(storageKey);\r\n        const setter = locked && originalSetItem ? originalSetItem : localStorage.setItem.bind(localStorage);\r\n        if (locked && !originalSetItem) unlockStorageKey(storageKey);\r\n        setter(storageKey, bn.toStorage?.() ?? String(bn));\r\n        if (locked && !originalSetItem) lockStorageKey(storageKey);\r\n    } catch {}\r\n}\r\n\r\nfunction applyCurrencyOverrideForSlot(currencyKey, slot = getActiveSlot()) {\r\n    if (slot == null) return;\r\n    const override = getCurrencyOverride(slot, currencyKey);\r\n    if (!override) return;\r\n    if (slot !== getActiveSlot()) return;\r\n\r\n    const cacheKey = buildOverrideKey(slot, currencyKey);\r\n    if (currencyOverrideApplications.has(cacheKey)) return;\r\n\r\n    currencyOverrideApplications.add(cacheKey);\r\n    try {\r\n        const current = bank?.[currencyKey]?.mult?.get?.();\r\n        if (!bigNumEquals(current, override)) {\r\n            bank?.[currencyKey]?.mult?.set?.(override);\r\n        }\r\n    } catch {} finally {\r\n        currencyOverrideApplications.delete(cacheKey);\r\n    }\r\n}\r\n\r\nlet currencyListenerAttached = false;\r\nfunction ensureCurrencyOverrideListener() {\r\n    if (currencyListenerAttached || typeof window === 'undefined') return;\r\n    currencyListenerAttached = true;\r\n    try {\r\n        window.addEventListener('currency:multiplier', (event) => {\r\n            const { key, slot, mult } = event?.detail ?? {};\r\n            const targetSlot = slot ?? getActiveSlot();\r\n            const cacheKey = buildOverrideKey(targetSlot, key);\r\n            if (!targetSlot || !currencyOverrides.has(cacheKey)) return;\r\n            if (currencyOverrideApplications.has(cacheKey)) return;\r\n\r\n            const baseline = currencyOverrideBaselines.get(cacheKey);\r\n            const override = getCurrencyOverride(targetSlot, key);\r\n\r\n            if (baseline && override && mult) {\r\n                const baselineNum = bigNumToFiniteNumber(baseline);\r\n                const nextNum = bigNumToFiniteNumber(mult);\r\n\r\n                if (\r\n                    Number.isFinite(baselineNum)\r\n                    && Number.isFinite(nextNum)\r\n                    && baselineNum !== 0\r\n                ) {\r\n                    const ratio = nextNum / baselineNum;\r\n                    if (ratio && ratio !== 1) {\r\n                        try {\r\n                            const scaledOverride = override.mulDecimal?.(ratio) ?? override;\r\n                            currencyOverrides.set(cacheKey, scaledOverride);\r\n                        } catch {}\r\n                    }\r\n                }\r\n\r\n                currencyOverrideBaselines.set(cacheKey, mult);\r\n            } else if (mult) {\r\n                currencyOverrideBaselines.set(cacheKey, mult);\r\n            }\r\n\r\n            applyCurrencyOverrideForSlot(key, targetSlot);\r\n        }, { passive: true });\r\n        window.addEventListener('saveSlot:change', () => {\r\n            applyAllCurrencyOverridesForActiveSlot();\r\n        }, { passive: true });\r\n    } catch {}\r\n}\r\n\r\nexport function applyAllCurrencyOverridesForActiveSlot() {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) return;\r\n    Object.values(CURRENCIES).forEach((key) => {\r\n        applyCurrencyOverrideForSlot(key, slot);\r\n    });\r\n}\r\n\r\nexport function setDebugCurrencyMultiplierOverride(currencyKey, value, slot = getActiveSlot()) {\r\n    if (!currencyKey || slot == null) return null;\r\n    ensureCurrencyOverrideListener();\r\n    let bn;\r\n    try { bn = value instanceof BigNum ? value.clone?.() ?? value : BigNum.fromAny(value ?? 1); }\r\n    catch { bn = BigNum.fromInt(1); }\r\n    const cacheKey = buildOverrideKey(slot, currencyKey);\r\n    currencyOverrides.set(cacheKey, bn);\r\n    const gameValue = bank?.[currencyKey]?.mult?.get?.();\r\n    currencyOverrideBaselines.set(cacheKey, gameValue);\r\n    applyCurrencyOverrideForSlot(currencyKey, slot);\r\n    return bn;\r\n}\r\n\r\n\r\nexport function getDebugCurrencyMultiplierOverride(currencyKey, slot = getActiveSlot()) {\r\n    if (!currencyKey || slot == null) return null;\r\n    return getCurrencyOverride(slot, currencyKey);\r\n}\r\n\r\nexport function setDebugStatMultiplierOverride(statKey, value, slot = getActiveSlot()) {\r\n    if (!statKey || slot == null) return null;\r\n    let bn;\r\n    try { bn = value instanceof BigNum ? value.clone?.() ?? value : BigNum.fromAny(value ?? 1); }\r\n    catch { bn = BigNum.fromInt(1); }\r\n    statOverrides.set(buildOverrideKey(slot, statKey), bn);\r\n    statOverrideBaselines.set(buildOverrideKey(slot, statKey), getGameStatMultiplier(statKey));\r\n    storeStatMultiplierOverride(statKey, slot, bn);\r\n    notifyStatMultiplierChange(statKey, slot);\r\n    return bn;\r\n}\r\n\r\nexport function getDebugStatMultiplierOverride(statKey, slot = getActiveSlot()) {\r\n    if (!statKey || slot == null) return null;\r\n    return getStatOverride(slot, statKey);\r\n}\r\n\r\nexport function applyStatMultiplierOverride(statKey, amount, slot = getActiveSlot()) {\r\n    const gameValue = getGameStatMultiplier(statKey);\r\n    const override = getEffectiveStatMultiplierOverride(statKey, slot, gameValue);\r\n    if (!override) return amount;\r\n\r\n    let base;\r\n    try {\r\n        base = amount instanceof BigNum ? amount.clone?.() ?? amount : BigNum.fromAny(amount ?? 0);\r\n    } catch {\r\n        return amount;\r\n    }\r\n\r\n    // If the caller is passing the raw in-game multiplier itself (e.g. XP Value,\r\n    // MP Value, etc.), avoid ratio math and just return the override directly.\r\n    // This prevents weird cases like 0.999... when we conceptually want 1.000...\r\n    try {\r\n        if (bigNumEquals(base, gameValue)) {\r\n            return override;\r\n        }\r\n    } catch {\r\n        // fall through and apply ratio logic below\r\n    }\r\n\r\n    try {\r\n        if (base.isZero?.()) return base;\r\n    } catch {\r\n        return base;\r\n    }\r\n\r\n    const cacheKey = buildOverrideKey(slot, statKey);\r\n    const baseline = statOverrideBaselines.get(cacheKey);\r\n    const multiplierForRatio =\r\n        (isStatMultiplierLocked(statKey, slot) && baseline) ? baseline : gameValue;\r\n\r\n    const overrideNum = bigNumToFiniteNumber(override);\r\n    const gameValueNum = bigNumToFiniteNumber(multiplierForRatio);\r\n    const ratio =\r\n        Number.isFinite(overrideNum) &&\r\n        Number.isFinite(gameValueNum) &&\r\n        gameValueNum !== 0\r\n            ? overrideNum / gameValueNum\r\n            : Number.NaN;\r\n\r\n    if (Number.isFinite(ratio) && ratio !== 1) {\r\n        try { return base.mulDecimal?.(ratio) ?? base; }\r\n        catch {}\r\n    }\r\n\r\n    return base;\r\n}\r\n\r\nfunction getEffectiveStatMultiplierOverride(statKey, slot, gameValue) {\r\n    const override = getStatOverride(slot, statKey);\r\n    const cacheKey = buildOverrideKey(slot, statKey);\r\n    if (!override) {\r\n        statOverrideBaselines.delete(cacheKey);\r\n        return null;\r\n    }\r\n\r\n    const baseline = statOverrideBaselines.get(cacheKey);\r\n    const locked = isStatMultiplierLocked(statKey, slot);\r\n\r\n    if (!baseline) {\r\n        statOverrideBaselines.set(cacheKey, gameValue);\r\n    } else if (!bigNumEquals(baseline, gameValue)) {\r\n        statOverrideBaselines.set(cacheKey, gameValue);\r\n        if (locked) {\r\n            return override;\r\n        }\r\n        statOverrideBaselines.set(cacheKey, gameValue);\r\n        clearStatMultiplierOverride(statKey, slot);\r\n        return null;\r\n    }\r\n\r\n    return override;\r\n}\r\n\r\nfunction ensureStorageLockPatch() {\r\n    if (storageLockPatched || typeof localStorage === 'undefined') return;\r\n    storageLockPatched = true;\r\n    try {\r\n        originalSetItem = localStorage.setItem.bind(localStorage);\r\n        originalRemoveItem = localStorage.removeItem.bind(localStorage);\r\n        localStorage.setItem = (key, value) => {\r\n            if (lockedStorageKeys.has(key)) return;\r\n            return originalSetItem(key, value);\r\n        };\r\n        localStorage.removeItem = (key) => {\r\n            if (lockedStorageKeys.has(key)) return;\r\n            return originalRemoveItem(key);\r\n        };\r\n    } catch {}\r\n}\r\n\r\nfunction isStorageKeyLocked(key) {\r\n    return key != null && lockedStorageKeys.has(key);\r\n}\r\n\r\nfunction lockStorageKey(key) {\r\n    if (!key) return;\r\n    ensureStorageLockPatch();\r\n    lockedStorageKeys.add(key);\r\n}\r\n\r\nfunction unlockStorageKey(key) {\r\n    if (!key) return;\r\n    lockedStorageKeys.delete(key);\r\n}\r\n\r\nfunction toggleStorageLock(key) {\r\n    if (!key) return false;\r\n    if (isStorageKeyLocked(key)) {\r\n        unlockStorageKey(key);\r\n        return false;\r\n    }\r\n    lockStorageKey(key);\r\n    return true;\r\n}\r\n\r\nfunction createLockToggle(storageKey, { onToggle } = {}) {\r\n    const button = document.createElement('button');\r\n    button.type = 'button';\r\n    button.className = 'debug-lock-button';\r\n\r\n    const refresh = () => {\r\n        const locked = isStorageKeyLocked(storageKey);\r\n        button.textContent = locked ? 'L' : 'UL';\r\n        button.classList.toggle('locked', locked);\r\n    };\r\n\r\n    button.addEventListener('click', () => {\r\n        toggleStorageLock(storageKey);\r\n        if (typeof onToggle === 'function') {\r\n            try { onToggle(isStorageKeyLocked(storageKey)); }\r\n            catch {}\r\n        }\r\n        refresh();\r\n    });\r\n\r\n    refresh();\r\n    return { button, refresh };\r\n}\r\n\r\nfunction createCompositeLockToggle(resolveKeys, { onToggle } = {}) {\r\n    const button = document.createElement('button');\r\n    button.type = 'button';\r\n    button.className = 'debug-lock-button';\r\n\r\n    const getKeys = () =>\r\n        Array.from(new Set((resolveKeys?.() ?? []).filter(Boolean)));\r\n\r\n    const isLocked = () => {\r\n        const keys = getKeys();\r\n        return keys.length > 0 && keys.every((key) => isStorageKeyLocked(key));\r\n    };\r\n\r\n    const hasAnyLocked = () => {\r\n        const keys = getKeys();\r\n        return keys.length > 0 && keys.some((key) => isStorageKeyLocked(key));\r\n    };\r\n\r\n    const refresh = () => {\r\n        const keys = getKeys();\r\n        const anyLocked = hasAnyLocked();\r\n        button.textContent = anyLocked ? 'L' : 'UL';\r\n        button.classList.toggle('locked', anyLocked);\r\n        button.disabled = keys.length === 0;\r\n    };\r\n\r\n    button.addEventListener('click', () => {\r\n        const keys = getKeys();\r\n        if (keys.length === 0) return;\r\n\r\n        const locked = isLocked();\r\n        keys.forEach((key) => {\r\n            if (locked) {\r\n                unlockStorageKey(key);\r\n            } else {\r\n                lockStorageKey(key);\r\n            }\r\n        });\r\n\r\n        if (typeof onToggle === 'function') {\r\n            try { onToggle(isLocked()); }\r\n            catch {}\r\n        }\r\n\r\n        refresh();\r\n    });\r\n\r\n    refresh();\r\n    return { button, refresh, isLocked };\r\n}\r\n\r\napplyAllCurrencyOverridesForActiveSlot();\r\nensureCurrencyOverrideListener();\r\n\r\nfunction collapseAllDebugCategories() {\r\n    const panel = document.getElementById(DEBUG_PANEL_ID);\r\n    if (!panel) return;\r\n\r\n    panel.querySelectorAll('.debug-panel-section-toggle').forEach((toggle) => {\r\n        toggle.classList.remove('expanded');\r\n        const content = toggle.nextElementSibling;\r\n        if (content) content.classList.remove('active');\r\n    });\r\n\r\n    panel.querySelectorAll('.debug-panel-subsection-toggle').forEach((toggle) => {\r\n        toggle.classList.remove('expanded');\r\n        const content = toggle.nextElementSibling;\r\n        if (content) content.classList.remove('active');\r\n    });\r\n}\r\n\r\nfunction withTemporaryUnlock(keys, fn) {\r\n    const uniqueKeys = Array.from(new Set((keys ?? []).filter(Boolean)));\r\n    const relock = [];\r\n\r\n    uniqueKeys.forEach((key) => {\r\n        if (isStorageKeyLocked(key)) {\r\n            relock.push(key);\r\n            unlockStorageKey(key);\r\n        }\r\n    });\r\n\r\n    try {\r\n        return fn?.();\r\n    } finally {\r\n        relock.forEach((key) => lockStorageKey(key));\r\n    }\r\n}\r\n\r\nfunction formatBigNumForInput(value) {\r\n    try {\r\n        const bn = value instanceof BigNum ? value : BigNum.fromAny(value ?? 0);\r\n        if (bn.isInfinite?.()) {\r\n            const precision = Number.parseInt(bn?.p, 10) || BigNum.DEFAULT_PRECISION;\r\n            return `BN:${precision}:1:${BigNum.MAX_E}`;\r\n        }\r\n        const storage = bn.toStorage?.();\r\n        const [, pStr = `${BigNum.DEFAULT_PRECISION}`, sigPart = '0', expPart = '0'] = (storage || '').split(':');\r\n        const precision = Number.parseInt(pStr, 10) || BigNum.DEFAULT_PRECISION;\r\n        if (bn.isZero?.()) {\r\n            return `BN:${precision}:${'0'.repeat(precision)}:-17`;\r\n        }\r\n        const paddedSig = sigPart.padStart(precision, '0');\r\n        return `BN:${precision}:${paddedSig}:${expPart}`;\r\n    } catch {\r\n        return String(value ?? '');\r\n    }\r\n}\r\n\r\nfunction parseBigNumInput(raw) {\r\n    const trimmed = String(raw ?? '').trim();\r\n    if (!trimmed) return BigNum.fromInt(0);\r\n    try {\r\n        if (/^inf(?:inity)?$/i.test(trimmed)) {\r\n            return BigNum.fromAny('Infinity');\r\n        }\r\n        return BigNum.fromAny(trimmed);\r\n    } catch {\r\n        return null;\r\n    }\r\n}\r\n\r\nfunction setInputValidity(input, valid) {\r\n    input.classList.toggle('debug-invalid', !valid);\r\n}\r\n\r\nfunction flagDebugUsage() {\r\n    const slot = getActiveSlot();\r\n    try { markSaveSlotModified(slot); }\r\n    catch {}\r\n    try { window.dispatchEvent(new CustomEvent('debug:change', { detail: { slot } })); }\r\n    catch {}\r\n}\r\n\r\nfunction getActionLogKey(slot = getActiveSlot()) {\r\n    if (slot == null) return null;\r\n    return `${ACTION_LOG_STORAGE_PREFIX}:${slot}`;\r\n}\r\n\r\nfunction getCurrentActionLog(slot = getActiveSlot()) {\r\n    const key = getActionLogKey(slot);\r\n    if (!key) return [];\r\n\r\n    let raw = null;\r\n    try { raw = localStorage.getItem(key); }\r\n    catch {}\r\n    if (!raw) return [];\r\n\r\n    try {\r\n        const parsed = JSON.parse(raw);\r\n        return Array.isArray(parsed) ? parsed : [];\r\n    } catch {\r\n        return [];\r\n    }\r\n}\r\n\r\nfunction persistActionLog(entries, slot = getActiveSlot()) {\r\n    const key = getActionLogKey(slot);\r\n    if (!key || typeof localStorage === 'undefined') return;\r\n\r\n    const trimmed = (Array.isArray(entries) ? entries : []).slice(0, MAX_ACTION_LOG_ENTRIES);\r\n    try { localStorage.setItem(key, JSON.stringify(trimmed)); }\r\n    catch {}\r\n}\r\n\r\nfunction appendActionLogEntry(entry, slot = getActiveSlot()) {\r\n    const log = getCurrentActionLog(slot);\r\n    log.unshift(entry);\r\n    if (log.length > MAX_ACTION_LOG_ENTRIES) {\r\n        log.length = MAX_ACTION_LOG_ENTRIES;\r\n    }\r\n    persistActionLog(log, slot);\r\n    return log;\r\n}\r\n\r\nfunction logAction(message) {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) return;\r\n\r\n    const now = new Date();\r\n    const entry = {\r\n        time: now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),\r\n        message,\r\n        timestamp: now.getTime(),\r\n    };\r\n    appendActionLogEntry(entry, slot);\r\n    updateActionLogDisplay();\r\n}\r\n\r\nfunction updateActionLogDisplay() {\r\n    if (!actionLogContainer) return;\r\n\r\n    const actionLog = getCurrentActionLog();\r\n    if (actionLog.length === 0) {\r\n        actionLogContainer.innerHTML = '';\r\n        const msg = document.createElement('div');\r\n        msg.className = 'action-log-empty';\r\n        msg.textContent = 'Actions you perform in the Debug Panel will be logged permanently in this action log.';\r\n        actionLogContainer.appendChild(msg);\r\n        return;\r\n    }\r\n\r\n    actionLogContainer.innerHTML = actionLog.map((entry) => {\r\n        let formattedMessage = entry.message?.replace?.(/\\[GOLD\\](.*?)\\[\\/GOLD\\]/g, '<span class=\"action-log-gold\">$1</span>') ?? '';\r\n\t\tformattedMessage = formattedMessage.replace(/\\b(?:Level|Lv)\\s?(\\d+)\\b/g, '<span class=\"action-log-level\">Lv$1</span>');\r\n        formattedMessage = formattedMessage.replace(/(\\d[\\d,.]*(?:e[+-]?\\d+)*(?:[KMBTQa-zA-Z]*))/g, (match) => /\\d/.test(match) ? `<span class=\"action-log-number\">${match}</span>` : match);\r\n\t\tformattedMessage = formattedMessage.replace(/<span[^>]*class=\"[^\"]*infinity-symbol[^\"]*\"[^>]*>\u221E<\\/span>/g, '<span class=\"action-log-number\">inf</span>');\r\n\t\tformattedMessage = formattedMessage.replace(/\u221E/g,'<span class=\"action-log-number\">inf</span>');\r\n\r\n\r\n        return `<div class=\"action-log-entry\"><span class=\"action-log-time\">${entry.time}:</span><span class=\"action-log-message\">${formattedMessage}</span></div>`;\r\n    }).join('');\r\n}\r\n\r\nfunction dialogueStateStorageKey(slot = getActiveSlot()) {\r\n    if (slot == null) return null;\r\n    return `${MERCHANT_DLG_STATE_KEY_BASE}:${slot}`;\r\n}\r\n\r\nfunction persistDialogueState(state, slot = getActiveSlot()) {\r\n    const key = dialogueStateStorageKey(slot);\r\n    if (!key) return;\r\n    try {\r\n        const payload = JSON.stringify(state || {});\r\n        localStorage.setItem(key, payload);\r\n    } catch {}\r\n}\r\n\r\nfunction loadDialogueState(slot = getActiveSlot()) {\r\n    const key = dialogueStateStorageKey(slot);\r\n    if (!key) return {};\r\n    try {\r\n        const raw = localStorage.getItem(key);\r\n        return raw ? JSON.parse(raw) : {};\r\n    } catch {\r\n        return {};\r\n    }\r\n}\r\n\r\nfunction grantDialogueReward(reward) {\r\n    if (!reward) return;\r\n    if (reward.type === 'coins') {\r\n        try { bank.coins.add(reward.amount); }\r\n        catch (e) { console.warn('Failed to grant coin reward:', reward, e); }\r\n        return;\r\n    }\r\n    if (reward.type === 'books') {\r\n        try {\r\n            bank.books.addWithMultiplier?.(reward.amount) ?? bank.books.add(reward.amount);\r\n        } catch (e) {\r\n            console.warn('Failed to grant book reward:', reward, e);\r\n        }\r\n        return;\r\n    }\r\n    try { window.dispatchEvent(new CustomEvent('merchantReward', { detail: reward })); }\r\n    catch {}\r\n}\r\n\r\nfunction completeAllDialoguesForDebug() {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) return { completed: 0 };\r\n\r\n    const state = loadDialogueState(slot);\r\n    let completed = 0;\r\n\r\n    Object.entries(DLG_CATALOG).forEach(([id, meta]) => {\r\n        const key = String(id);\r\n        const prev = state[key] || {};\r\n        const alreadyClaimed = !!prev.claimed;\r\n        const next = Object.assign({}, prev, { status: 'unlocked', claimed: true });\r\n        state[key] = next;\r\n        if (!alreadyClaimed) {\r\n            completed += 1;\r\n            grantDialogueReward(meta.reward);\r\n        }\r\n    });\r\n\r\n    persistDialogueState(state, slot);\r\n    return { completed };\r\n}\r\n\r\nfunction restoreAllDialoguesForDebug() {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) return { restored: 0 };\r\n\r\n    const state = loadDialogueState(slot);\r\n    let restored = 0;\r\n\r\n    Object.entries(DLG_CATALOG).forEach(([id]) => {\r\n        const key = String(id);\r\n        const prev = state[key] || {};\r\n        if (prev.claimed) restored += 1;\r\n        state[key] = Object.assign({}, prev, { claimed: false });\r\n    });\r\n\r\n    persistDialogueState(state, slot);\r\n    return { restored };\r\n}\r\n\r\nfunction createInputRow(labelText, initialValue, onCommit, { idLabel, storageKey, onLockChange } = {}) {\r\n    const row = document.createElement('div');\r\n    row.className = 'debug-panel-row';\r\n\r\n    const label = document.createElement('label');\r\n    label.textContent = labelText;\r\n    if (idLabel != null) {\r\n        label.append(' ');\r\n        const idSpan = document.createElement('span');\r\n        idSpan.className = 'debug-panel-id';\r\n        idSpan.textContent = `(ID: ${idLabel})`;\r\n        label.appendChild(idSpan);\r\n    }\r\n    row.appendChild(label);\r\n\r\n    const input = document.createElement('input');\r\n    input.type = 'text';\r\n    input.className = 'debug-panel-input';\r\n    let editing = false;\r\n    let pendingValue = null;\r\n    let skipBlurCommit = false;\r\n    const lockToggle = storageKey ? createLockToggle(storageKey, { onToggle: onLockChange }) : null;\r\n\r\n    const setValue = (value) => {\r\n        if (editing) {\r\n            pendingValue = value;\r\n            return;\r\n        }\r\n        pendingValue = null;\r\n        input.value = formatBigNumForInput(value);\r\n    };\r\n\r\n    row.appendChild(input);\r\n    if (lockToggle) {\r\n        row.appendChild(lockToggle.button);\r\n    }\r\n\r\n    const commitValue = () => {\r\n        const parsed = parseBigNumInput(input.value);\r\n        if (!parsed) {\r\n            setInputValidity(input, false);\r\n            return;\r\n        }\r\n        setInputValidity(input, true);\r\n\r\n        const wasLocked = storageKey && isStorageKeyLocked(storageKey);\r\n        if (wasLocked) unlockStorageKey(storageKey);\r\n        try {\r\n            onCommit(parsed, { input, setValue });\r\n        } finally {\r\n            if (wasLocked) lockStorageKey(storageKey);\r\n            if (lockToggle) lockToggle.refresh();\r\n        }\r\n    };\r\n\r\n    input.addEventListener('focus', () => { editing = true; });\r\n    input.addEventListener('change', commitValue);\r\n    input.addEventListener('keydown', (event) => {\r\n        if (event.key === 'Enter') {\r\n            event.preventDefault();\r\n            skipBlurCommit = true;\r\n            commitValue();\r\n            input.blur();\r\n        }\r\n    });\r\n    input.addEventListener('blur', () => {\r\n        editing = false;\r\n        if (!skipBlurCommit) {\r\n            commitValue();\r\n        }\r\n        skipBlurCommit = false;\r\n        if (pendingValue != null) {\r\n            const next = pendingValue;\r\n            pendingValue = null;\r\n            setValue(next);\r\n        }\r\n    });\r\n\r\n    setValue(initialValue);\r\n    if (lockToggle) lockToggle.refresh();\r\n\r\n    return { row, input, setValue, isEditing: () => editing };\r\n}\r\n\r\nfunction createUnlockToggleRow({ labelText, description, isUnlocked, onEnable, onDisable, slot }) {\r\n    const row = document.createElement('div');\r\n    row.className = 'debug-panel-row debug-unlock-row';\r\n\r\n    const toggle = document.createElement('label');\r\n    toggle.className = 'flag-toggle';\r\n    toggle.setAttribute('aria-label', labelText);\r\n\r\n    const input = document.createElement('input');\r\n    input.type = 'checkbox';\r\n\r\n    const slider = document.createElement('span');\r\n    slider.className = 'flag-slider';\r\n\r\n    toggle.appendChild(input);\r\n    toggle.appendChild(slider);\r\n\r\n    const textContainer = document.createElement('div');\r\n    textContainer.className = 'debug-unlock-text';\r\n\r\n    const title = document.createElement('span');\r\n    title.className = 'debug-unlock-title';\r\n    title.textContent = labelText;\r\n    textContainer.appendChild(title);\r\n\r\n    if (description) {\r\n        const desc = document.createElement('span');\r\n        desc.className = 'debug-unlock-desc';\r\n        desc.textContent = `- ${description}`;\r\n        textContainer.appendChild(desc);\r\n    }\r\n\r\n    row.appendChild(toggle);\r\n    row.appendChild(textContainer);\r\n\r\n    const toggleRow = () => {\r\n        input.checked = !input.checked;\r\n        input.dispatchEvent(new Event('change', { bubbles: true }));\r\n    };\r\n\r\n    row.addEventListener('click', (event) => {\r\n        if (toggle.contains(event.target)) return;\r\n        toggleRow();\r\n    });\r\n\r\n    let lastKnown = false;\r\n\r\n    const refresh = () => {\r\n        let unlocked = false;\r\n        try { unlocked = typeof isUnlocked === 'function' ? !!isUnlocked() : false; }\r\n        catch {}\r\n        input.checked = unlocked;\r\n        lastKnown = unlocked;\r\n        return unlocked;\r\n    };\r\n\r\n    input.addEventListener('change', () => {\r\n        const previous = lastKnown;\r\n        const unlocked = input.checked;\r\n        try {\r\n            if (unlocked) {\r\n                onEnable?.();\r\n            } else {\r\n                onDisable?.();\r\n            }\r\n        } catch {}\r\n        flagDebugUsage();\r\n        const refreshed = refresh();\r\n        if (previous !== refreshed) {\r\n            logAction(`Toggled ${labelText} [GOLD]${previous ? 'True' : 'False'}[/GOLD] \u2192 [GOLD]${refreshed ? 'True' : 'False'}[/GOLD]`);\r\n        }\r\n    });\r\n\r\n    refresh();\r\n    registerLiveBinding({ type: 'unlock', slot, refresh });\r\n    return row;\r\n}\r\n\r\nfunction formatCalculatorResult(value) {\r\n    try {\r\n        if (value instanceof BigNum || typeof value?.toScientific === 'function') {\r\n            return formatNumber(value);\r\n        }\r\n        const num = Number(value);\r\n        if (Number.isFinite(num)) {\r\n            return formatNumber(num);\r\n        }\r\n        return String(value ?? '\u2014');\r\n    } catch {\r\n        return '\u2014';\r\n    }\r\n}\r\n\r\nfunction createCalculatorRow({ labelText, inputs = [], compute }) {\r\n    const row = document.createElement('div');\r\n    row.className = 'debug-panel-row debug-calculator-row';\r\n\r\n    const label = document.createElement('label');\r\n    label.textContent = labelText;\r\n    row.appendChild(label);\r\n\r\n    const controls = document.createElement('div');\r\n    controls.className = 'debug-calculator-inputs';\r\n    row.appendChild(controls);\r\n\r\n    const output = document.createElement('div');\r\n    output.className = 'debug-calculator-output';\r\n    output.textContent = '\u2014';\r\n    row.appendChild(output);\r\n\r\n    const fieldEls = [];\r\n\r\n    const recompute = () => {\r\n        const values = {};\r\n        let hasError = false;\r\n\r\n        fieldEls.forEach(({ config, el }) => {\r\n            if (config.type === 'select') {\r\n                values[config.key] = el.value;\r\n                return;\r\n            }\r\n\r\n            const parsed = parseBigNumInput(el.value);\r\n            const valid = parsed instanceof BigNum;\r\n            setInputValidity(el, valid);\r\n            if (!valid) {\r\n                hasError = true;\r\n                return;\r\n            }\r\n            values[config.key] = parsed;\r\n        });\r\n\r\n        if (hasError || typeof compute !== 'function') {\r\n            output.textContent = '\u2014';\r\n            return;\r\n        }\r\n\r\n        try {\r\n            const result = compute(values);\r\n            output.innerHTML = formatCalculatorResult(result);\r\n        } catch {\r\n            output.textContent = '\u2014';\r\n        }\r\n    };\r\n\r\n    inputs.forEach((inputConfig) => {\r\n        const config = Object.assign({ type: 'text', defaultValue: '' }, inputConfig);\r\n        if (!config.key) return;\r\n\r\n        if (config.type === 'select') {\r\n            const select = document.createElement('select');\r\n            select.className = 'debug-panel-input';\r\n            (config.options || []).forEach(({ value, label: optLabel }) => {\r\n                const option = document.createElement('option');\r\n                option.value = value;\r\n                option.textContent = optLabel ?? value;\r\n                if (config.defaultValue != null && config.defaultValue === value) {\r\n                    option.selected = true;\r\n                }\r\n                select.appendChild(option);\r\n            });\r\n            select.addEventListener('change', recompute);\r\n            applyMobileGhostTapToDropdown(select);\r\n            controls.appendChild(select);\r\n            fieldEls.push({ config, el: select });\r\n        } else {\r\n            const input = document.createElement('input');\r\n            input.type = 'text';\r\n            input.className = 'debug-panel-input';\r\n            input.placeholder = config.label || '';\r\n            input.value = config.defaultValue ?? '';\r\n            input.addEventListener('input', recompute);\r\n            input.addEventListener('keydown', (event) => {\r\n                if (event.key === 'Enter') {\r\n                    event.preventDefault();\r\n                    recompute();\r\n                }\r\n            });\r\n            controls.appendChild(input);\r\n            fieldEls.push({ config, el: input });\r\n        }\r\n    });\r\n\r\n    recompute();\r\n\r\n    return row;\r\n}\r\n\r\nfunction applyXpState({ level, progress }) {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) return;\r\n\r\n    // If we're manually editing XP stats from the debug panel, the XP system\r\n    // should be treated as unlocked.\r\n    try { unlockXpSystem(); } catch {}\r\n\r\n    const unlockKey = XP_KEYS.unlock(slot);\r\n    try { localStorage.setItem(unlockKey, '1'); } catch {}\r\n    primeStorageWatcherSnapshot(unlockKey, '1');\r\n\r\n    if (level != null) {\r\n        try {\r\n            const raw = level.toStorage?.() ?? BigNum.fromAny(level).toStorage();\r\n            const key = XP_KEYS.level(slot);\r\n            localStorage.setItem(key, raw);\r\n            primeStorageWatcherSnapshot(key, raw);\r\n        } catch {}\r\n    }\r\n\r\n    if (progress != null) {\r\n        try {\r\n            const raw = progress.toStorage?.() ?? BigNum.fromAny(progress).toStorage();\r\n            const key = XP_KEYS.progress(slot);\r\n            localStorage.setItem(key, raw);\r\n            primeStorageWatcherSnapshot(key, raw);\r\n        } catch {}\r\n    }\r\n\r\n    try {\r\n        initXpSystem({ forceReload: true });\r\n    } catch {}\r\n\r\n    // Let any XP listeners know we've made a manual change so dependent UI (like\r\n    // the Forge reset panel) can refresh immediately without waiting for normal\r\n    // gameplay hooks to fire.\r\n    try {\r\n        broadcastXpChange({ changeType: 'debug-panel', slot });\r\n    } catch {}\r\n\r\n    // Also keep ALL debug live bindings in sync (including the Unlocks tab\r\n    // \"Unlock XP\" flag, which reads getXpState().unlocked).\r\n    try {\r\n        refreshLiveBindings();\r\n    } catch {}\r\n}\r\n\r\nfunction applyMutationState({ level, progress }) {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) return;\r\n\r\n    // If the MP system isn't unlocked yet, setting its level/progress should\r\n    // auto-enable the relevant unlock flags so the UI and systems stay in\r\n    // sync.\r\n    try {\r\n        const forgeUnlocked = typeof isForgeUnlocked === 'function' ? isForgeUnlocked() : false;\r\n        const forgeOverride = typeof getForgeDebugOverrideState === 'function'\r\n            ? getForgeDebugOverrideState()\r\n            : null;\r\n        if (!forgeUnlocked && forgeOverride !== true) {\r\n            setForgeDebugOverride?.(true);\r\n        }\r\n    } catch {}\r\n\r\n    try {\r\n        if (typeof hasDoneForgeReset === 'function' && !hasDoneForgeReset()) {\r\n            setForgeResetCompleted?.(true);\r\n        }\r\n    } catch {}\r\n\r\n    try { setMutationUnlockedForDebug(true); } catch {}\r\n\r\n    try { updateResetPanel?.(); } catch {}\r\n\r\n    // Make sure the mutation / MP system is treated as unlocked if we're\r\n    // manually editing its stats from the debug panel.\r\n    try { initMutationSystem(); } catch {}\r\n    try { unlockMutationSystem(); } catch {}\r\n\r\n    const unlockKey = MUTATION_KEYS.unlock(slot);\r\n    try { localStorage.setItem(unlockKey, '1'); } catch {}\r\n    primeStorageWatcherSnapshot(unlockKey, '1');\r\n\r\n    if (level != null) {\r\n        try {\r\n            const raw = level.toStorage?.() ?? BigNum.fromAny(level).toStorage();\r\n            const key = MUTATION_KEYS.level(slot);\r\n            localStorage.setItem(key, raw);\r\n            primeStorageWatcherSnapshot(key, raw);\r\n        } catch {}\r\n    }\r\n\r\n    if (progress != null) {\r\n        try {\r\n            const raw = progress.toStorage?.() ?? BigNum.fromAny(progress).toStorage();\r\n            const key = MUTATION_KEYS.progress(slot);\r\n            localStorage.setItem(key, raw);\r\n            primeStorageWatcherSnapshot(key, raw);\r\n        } catch {}\r\n    }\r\n\r\n    try {\r\n        initMutationSystem({ forceReload: true });\r\n    } catch {}\r\n\r\n    try {\r\n        broadcastMutationChange({ changeType: 'debug-panel', slot });\r\n    } catch {}\r\n\r\n    // Keep all debug rows that depend on mutation / MP state in sync.\r\n    try {\r\n        refreshLiveBindings();\r\n    } catch {}\r\n}\r\n\r\nfunction buildAreaCurrencies(container, area) {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) {\r\n        const msg = document.createElement('div');\r\n        msg.className = 'debug-panel-empty';\r\n        msg.textContent = 'Select a save slot to edit currency values.';\r\n        container.appendChild(msg);\r\n        return;\r\n    }\r\n\r\n    const areaLabel = area?.title ?? area?.key ?? 'Unknown Area';\r\n\r\n    area.currencies.forEach((currency) => {\r\n        const storageKey = getCurrencyStorageKey(currency.key, slot);\r\n        const current = getCurrencyValueForSlot(currency.key, slot);\r\n        const currencyRow = createInputRow(currency.label, current, (value, { setValue }) => {\r\n            const latestSlot = getActiveSlot();\r\n            if (latestSlot == null) return;\r\n            if (latestSlot !== slot) return;\r\n\r\n            const { previous, next } = applyCurrencyState(currency.key, value, latestSlot);\r\n            setValue(next);\r\n            if (!bigNumEquals(previous, next)) {\r\n                flagDebugUsage();\r\n                logAction(`Modified ${currency.label} (${areaLabel}) ${formatNumber(previous)} \u2192 ${formatNumber(next)}`);\r\n            }\r\n        }, {\r\n            storageKey,\r\n            onLockChange: () => currencyRow.setValue(getCurrencyValueForSlot(currency.key, getActiveSlot())),\r\n        });\r\n        registerLiveBinding({\r\n            type: 'currency',\r\n            key: currency.key,\r\n            slot,\r\n            refresh: () => {\r\n                if (slot !== getActiveSlot()) return;\r\n                const latest = getCurrencyValueForSlot(currency.key, slot);\r\n                currencyRow.setValue(latest);\r\n            },\r\n        });\r\n        container.appendChild(currencyRow.row);\r\n    });\r\n}\r\n\r\nfunction buildAreaStats(container, area) {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) {\r\n        const msg = document.createElement('div');\r\n        msg.className = 'debug-panel-empty';\r\n        msg.textContent = 'Select a save slot to edit stats.';\r\n        container.appendChild(msg);\r\n        return;\r\n    }\r\n\r\n    const xp = getXpState();\r\n    const mutation = getMutationState();\r\n    const areaLabel = area?.title ?? area?.key ?? 'Unknown Area';\r\n\r\n    const xpLevelKey = XP_KEYS.level(slot);\r\n    const xpLevelRow = createInputRow('XP Level', xp.xpLevel, (value, { setValue }) => {\r\n        const prev = getXpState().xpLevel;\r\n        applyXpState({ level: value });\r\n        const latest = getXpState();\r\n        setValue(latest.xpLevel);\r\n        if (!bigNumEquals(prev, latest.xpLevel)) {\r\n            flagDebugUsage();\r\n            logAction(`Modified XP Level (${areaLabel}) ${formatNumber(prev)} \u2192 ${formatNumber(latest.xpLevel)}`);\r\n        }\r\n    }, { storageKey: xpLevelKey });\r\n    registerLiveBinding({\r\n        type: 'xp',\r\n        slot,\r\n        refresh: () => {\r\n            if (slot !== getActiveSlot()) return;\r\n            xpLevelRow.setValue(getXpState().xpLevel);\r\n        },\r\n    });\r\n    container.appendChild(xpLevelRow.row);\r\n\r\n    const xpProgressKey = XP_KEYS.progress(slot);\r\n    const xpProgressRow = createInputRow('XP Progress', xp.progress, (value, { setValue }) => {\r\n        const prev = getXpState();\r\n        const prevLevel = prev?.xpLevel?.clone?.() ?? prev?.xpLevel;\r\n        const prevProgress = prev?.progress?.clone?.() ?? prev?.progress;\r\n        applyXpState({ progress: value });\r\n        const latest = getXpState();\r\n        setValue(latest.progress);\r\n        xpLevelRow.setValue(latest.xpLevel);\r\n        if (!bigNumEquals(prevProgress, latest.progress) || !bigNumEquals(prevLevel, latest.xpLevel)) {\r\n            flagDebugUsage();\r\n            logAction(`Modified XP Progress (${areaLabel}) ${formatNumber(prevProgress)} \u2192 ${formatNumber(latest.progress)}`);\r\n        }\r\n    }, { storageKey: xpProgressKey });\r\n    registerLiveBinding({\r\n        type: 'xp',\r\n        slot,\r\n        refresh: () => {\r\n            if (slot !== getActiveSlot()) return;\r\n            xpProgressRow.setValue(getXpState().progress);\r\n        },\r\n    });\r\n    container.appendChild(xpProgressRow.row);\r\n\r\n    const mpLevelKey = MUTATION_KEYS.level(slot);\r\n    const mpLevelRow = createInputRow('MP Level', mutation.level, (value, { setValue }) => {\r\n        const prev = getMutationState().level;\r\n        applyMutationState({ level: value });\r\n        const latest = getMutationState();\r\n        setValue(latest.level);\r\n        if (!bigNumEquals(prev, latest.level)) {\r\n            flagDebugUsage();\r\n            logAction(`Modified MP Level (${areaLabel}) ${formatNumber(prev)} \u2192 ${formatNumber(latest.level)}`);\r\n        }\r\n    }, { storageKey: mpLevelKey });\r\n    registerLiveBinding({\r\n        type: 'mutation',\r\n        slot,\r\n        refresh: () => {\r\n            if (slot !== getActiveSlot()) return;\r\n            mpLevelRow.setValue(getMutationState().level);\r\n        },\r\n    });\r\n    container.appendChild(mpLevelRow.row);\r\n\r\n    const mpProgressKey = MUTATION_KEYS.progress(slot);\r\n    const mpProgressRow = createInputRow('MP Progress', mutation.progress, (value, { setValue }) => {\r\n        const prev = getMutationState();\r\n        const prevLevel = prev?.level?.clone?.() ?? prev?.level;\r\n        const prevProgress = prev?.progress?.clone?.() ?? prev?.progress;\r\n        applyMutationState({ progress: value });\r\n        const latest = getMutationState();\r\n        setValue(latest.progress);\r\n        mpLevelRow.setValue(latest.level);\r\n        if (!bigNumEquals(prevProgress, latest.progress) || !bigNumEquals(prevLevel, latest.level)) {\r\n            flagDebugUsage();\r\n            logAction(`Modified MP Progress (${areaLabel}) ${formatNumber(prevProgress)} \u2192 ${formatNumber(latest.progress)}`);\r\n        }\r\n    }, { storageKey: mpProgressKey });\r\n    registerLiveBinding({\r\n        type: 'mutation',\r\n        slot,\r\n        refresh: () => {\r\n            if (slot !== getActiveSlot()) return;\r\n            mpProgressRow.setValue(getMutationState().progress);\r\n        },\r\n    });\r\n    container.appendChild(mpProgressRow.row);\r\n}\r\n\r\nfunction buildAreaUpgrades(container, area) {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) {\r\n        const msg = document.createElement('div');\r\n        msg.className = 'debug-panel-empty';\r\n        msg.textContent = 'Select a save slot to edit upgrades.';\r\n        container.appendChild(msg);\r\n        return;\r\n    }\r\n\r\n    const upgrades = getUpgradesForArea(area.key);\r\n    if (!upgrades || upgrades.length === 0) {\r\n        const msg = document.createElement('div');\r\n        msg.className = 'debug-panel-empty';\r\n        msg.textContent = 'No upgrades found for this area yet.';\r\n        container.appendChild(msg);\r\n        return;\r\n    }\r\n\r\n    const areaLabel = area?.title ?? area?.key ?? 'Unknown Area';\r\n\r\n    upgrades.forEach((upg) => {\r\n        const idLabel = upg.id ?? upg.tie ?? upg.tieKey;\r\n        const title = upg.title || `Upgrade ${idLabel ?? ''}`.trim();\r\n        const current = getLevel(area.key, upg.id ?? upg.tie);\r\n        const upgradeRow = createInputRow(title, current, (value, { setValue }) => {\r\n            const latestSlot = getActiveSlot();\r\n            if (latestSlot == null) return;\r\n            const previous = getLevel(area.key, upg.id ?? upg.tie);\r\n            try { setLevel(area.key, upg.id ?? upg.tie, value, false); } catch {}\r\n            const refreshed = getLevel(area.key, upg.id ?? upg.tie);\r\n            setValue(refreshed);\r\n            if (!bigNumEquals(previous, refreshed)) {\r\n                flagDebugUsage();\r\n                logAction(`Modified ${title} (${areaLabel} - ID: ${idLabel ?? 'Unknown'}) Lv${formatNumber(previous)} \u2192 Lv${formatNumber(refreshed)}`);\r\n            }\r\n        }, { idLabel });\r\n        registerLiveBinding({\r\n            type: 'upgrade',\r\n            slot,\r\n            refresh: () => {\r\n                if (slot !== getActiveSlot()) return;\r\n                const refreshed = getLevel(area.key, upg.id ?? upg.tie);\r\n                upgradeRow.setValue(refreshed);\r\n            },\r\n        });\r\n        container.appendChild(upgradeRow.row);\r\n    });\r\n}\r\n\r\nfunction buildAreaCurrencyMultipliers(container, area) {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) {\r\n        const msg = document.createElement('div');\r\n        msg.className = 'debug-panel-empty';\r\n        msg.textContent = 'Select a save slot to edit currency multipliers.';\r\n        container.appendChild(msg);\r\n        return;\r\n    }\r\n\r\n    const areaLabel = area?.title ?? area?.key ?? 'Unknown Area';\r\n\r\n    area.currencies.forEach((currency) => {\r\n        const handle = bank?.[currency.key]?.mult;\r\n        const currentOverride = getDebugCurrencyMultiplierOverride(currency.key, slot);\r\n        const current = currentOverride ?? handle?.get?.() ?? BigNum.fromInt(1);\r\n        const storageKey = `${KEYS.MULTIPLIER[currency.key]}:${slot}`;\r\n        const row = createInputRow(`${currency.label} Multiplier`, current, (value, { setValue }) => {\r\n            const latestSlot = getActiveSlot();\r\n            if (latestSlot == null) return;\r\n            const previous = getDebugCurrencyMultiplierOverride(currency.key, latestSlot)\r\n                ?? handle?.get?.()\r\n                ?? BigNum.fromInt(1);\r\n            try { setDebugCurrencyMultiplierOverride(currency.key, value, latestSlot); } catch {}\r\n            applyAllCurrencyOverridesForActiveSlot();\r\n            const refreshedOverride = getDebugCurrencyMultiplierOverride(currency.key, latestSlot);\r\n            const refreshed = refreshedOverride ?? handle?.get?.() ?? BigNum.fromInt(1);\r\n            setValue(refreshed);\r\n            if (!bigNumEquals(previous, refreshed)) {\r\n                flagDebugUsage();\r\n                logAction(`Modified ${currency.label} Multiplier (${areaLabel}) ${formatNumber(previous)} \u2192 ${formatNumber(refreshed)}`);\r\n            }\r\n        }, { storageKey });\r\n        registerLiveBinding({\r\n            type: 'currency-mult',\r\n            key: currency.key,\r\n            slot,\r\n            refresh: () => {\r\n                if (slot !== getActiveSlot()) return;\r\n                const latestOverride = getDebugCurrencyMultiplierOverride(currency.key, slot);\r\n                const latest = latestOverride ?? handle?.get?.() ?? BigNum.fromInt(1);\r\n                row.setValue(latest);\r\n            },\r\n        });\r\n        container.appendChild(row.row);\r\n    });\r\n}\r\n\r\nfunction setAllCurrenciesToInfinity() {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) return 0;\r\n\r\n    const inf = BigNum.fromAny('Infinity');\r\n    let updated = 0;\r\n\r\n    Object.values(CURRENCIES).forEach((key) => {\r\n        const handle = bank?.[key];\r\n        if (!handle) return;\r\n        try {\r\n            const current = handle.value ?? handle.get?.();\r\n            const isAlreadyInf =\r\n                current?.isInfinite?.() ||\r\n                bigNumEquals(current, inf);\r\n\r\n            if (isAlreadyInf) return;\r\n\r\n            handle.set(inf);\r\n            updated += 1;\r\n        } catch {}\r\n    });\r\n\r\n    return updated;\r\n}\r\n\r\nfunction setAllCurrenciesToZero() {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) return 0;\r\n\r\n    const zero = BigNum.fromInt(0);\r\n    let updated = 0;\r\n\r\n    Object.values(CURRENCIES).forEach((key) => {\r\n        const handle = bank?.[key];\r\n        if (!handle) return;\r\n        try {\r\n            handle.set?.(zero);\r\n            updated += 1;\r\n        } catch {}\r\n    });\r\n\r\n    return updated;\r\n}\r\n\r\nfunction setAllStatsToInfinity() {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) return 0;\r\n\r\n    const inf = BigNum.fromAny('Infinity');\r\n    let touched = 0;\r\n\r\n    let xpState;\r\n    let mutationState;\r\n\r\n    try { xpState = getXpState(); } catch {}\r\n    try { mutationState = getMutationState(); } catch {}\r\n\r\n    // XP: only touch if unlocked and level/progress aren\u2019t already infinite\r\n    try {\r\n        if (xpState?.unlocked) {\r\n            const levelInf =\r\n                xpState?.xpLevel?.isInfinite?.() ||\r\n                bigNumEquals(xpState?.xpLevel, inf);\r\n            const progInf =\r\n                xpState?.progress?.isInfinite?.() ||\r\n                bigNumEquals(xpState?.progress, inf);\r\n\r\n            if (!levelInf || !progInf) {\r\n                applyXpState({ level: inf, progress: inf });\r\n                touched += 1; // count \"XP\" as one stat block\r\n            }\r\n        }\r\n    } catch {}\r\n\r\n    // MP / Mutation: only if unlocked\r\n    try {\r\n        if (mutationState?.unlocked) {\r\n            const levelInf =\r\n                mutationState?.level?.isInfinite?.() ||\r\n                bigNumEquals(mutationState?.level, inf);\r\n            const progInf =\r\n                mutationState?.progress?.isInfinite?.() ||\r\n                bigNumEquals(mutationState?.progress, inf);\r\n\r\n            if (!levelInf || !progInf) {\r\n                applyMutationState({ level: inf, progress: inf });\r\n                touched += 1; // count \"MP\" as one stat block\r\n            }\r\n        }\r\n    } catch {}\r\n\r\n    const isStatUnlocked = (statKey) => {\r\n        if (statKey === 'xp') return !!xpState?.unlocked;\r\n        if (statKey === 'mutation') return !!mutationState?.unlocked;\r\n        return true;\r\n    };\r\n\r\n    // Stat multipliers (XP, MP, etc.)\r\n    STAT_MULTIPLIERS.forEach(({ key }) => {\r\n        try {\r\n            if (!isStatUnlocked(key)) return;\r\n\r\n            const current = getStatMultiplierDisplayValue(key, slot);\r\n            const isAlreadyInf =\r\n                current?.isInfinite?.() ||\r\n                bigNumEquals(current, inf);\r\n\r\n            if (isAlreadyInf) return;\r\n\r\n            setDebugStatMultiplierOverride(key, inf, slot);\r\n            touched += 1;\r\n        } catch {}\r\n    });\r\n\r\n    return touched;\r\n}\r\n\r\nfunction setAllStatsToZero() {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) return 0;\r\n\r\n    const zero = BigNum.fromInt(0);\r\n    let touched = 0;\r\n\r\n    let xpState;\r\n    let mutationState;\r\n\r\n    try { xpState = getXpState(); } catch {}\r\n    try { mutationState = getMutationState(); } catch {}\r\n\r\n    try {\r\n        if (xpState?.unlocked) {\r\n            applyXpState({ level: zero, progress: zero });\r\n            touched += 1;\r\n        }\r\n    } catch {}\r\n\r\n    try {\r\n        if (mutationState?.unlocked) {\r\n            applyMutationState({ level: zero, progress: zero });\r\n            touched += 1;\r\n        }\r\n    } catch {}\r\n\r\n    const isStatUnlocked = (statKey) => {\r\n        if (statKey === 'xp') return !!xpState?.unlocked;\r\n        if (statKey === 'mutation') return !!mutationState?.unlocked;\r\n        return true;\r\n    };\r\n\r\n    STAT_MULTIPLIERS.forEach(({ key }) => {\r\n        try {\r\n            if (!isStatUnlocked(key)) return;\r\n\r\n            setDebugStatMultiplierOverride(key, zero, slot);\r\n            touched += 1;\r\n        } catch {}\r\n    });\r\n\r\n    return touched;\r\n}\r\n\r\nfunction getUnlockRowDefinitions(slot) {\r\n    return [\r\n        {\r\n            labelText: 'Unlock XP',\r\n            description: 'If true, unlocks the XP system',\r\n            isUnlocked: () => {\r\n                try { return !!getXpState()?.unlocked; }\r\n                catch { return false; }\r\n            },\r\n            onEnable: () => {\r\n                try { unlockXpSystem(); }\r\n                catch {}\r\n                try { initXpSystem({ forceReload: true }); }\r\n                catch {}\r\n            },\r\n            onDisable: () => {\r\n                try { resetXpProgress({ keepUnlock: false }); }\r\n                catch {}\r\n                try { setForgeDebugOverride(false); }\r\n                catch {}\r\n                try { updateResetPanel(); }\r\n                catch {}\r\n            },\r\n            slot,\r\n        },\r\n        {\r\n            labelText: 'Unlock MP',\r\n            description: 'If true, unlocks the MP system',\r\n            isUnlocked: () => {\r\n                try {\r\n                    const override = getForgeDebugOverrideState();\r\n                    if (override != null) return override;\r\n                } catch {}\r\n                try { return !!isForgeUnlocked(); }\r\n                catch { return false; }\r\n                return false;\r\n            },\r\n            onEnable: () => {\r\n                try { setForgeDebugOverride(true); }\r\n                catch {}\r\n                try { updateResetPanel(); }\r\n                catch {}\r\n            },\r\n            onDisable: () => {\r\n                try { setForgeDebugOverride(false); }\r\n                catch {}\r\n                try { updateResetPanel(); }\r\n                catch {}\r\n            },\r\n        },\r\n        {\r\n            labelText: 'Unlock MP',\r\n            description: 'If true, unlocks the MP system',\r\n            isUnlocked: () => {\r\n                try { return hasDoneForgeReset(); }\r\n                catch { return false; }\r\n            },\r\n            onEnable: () => {\r\n                try { setForgeResetCompleted(true); }\r\n                catch {}\r\n                try { setMutationUnlockedForDebug(true); }\r\n                catch {}\r\n                try { updateResetPanel(); }\r\n                catch {}\r\n            },\r\n            onDisable: () => {\r\n                try { setForgeResetCompleted(false); }\r\n                catch {}\r\n                try { setMutationUnlockedForDebug(false); }\r\n                catch {}\r\n                try { updateResetPanel(); }\r\n                catch {}\r\n            },\r\n            slot,\r\n        },\r\n        {\r\n            labelText: 'Unlock Shop',\r\n            description: 'If true, makes the Shop button visible',\r\n            isUnlocked: () => {\r\n                try { return isShopUnlocked(); }\r\n                catch { return false; }\r\n            },\r\n            onEnable: () => {\r\n                try { unlockShop(); }\r\n                catch {}\r\n            },\r\n            onDisable: () => {\r\n                try { lockShop(); }\r\n                catch {}\r\n            },\r\n            slot,\r\n        },\r\n        {\r\n            labelText: 'Unlock Map',\r\n            description: 'If true, makes the Map button visible',\r\n            isUnlocked: () => {\r\n                try { return isMapUnlocked(); }\r\n                catch { return false; }\r\n            },\r\n            onEnable: () => {\r\n                try { unlockMap(); }\r\n                catch {}\r\n            },\r\n            onDisable: () => {\r\n                try { lockMap(); }\r\n                catch {}\r\n            },\r\n            slot,\r\n        },\r\n    ];\r\n}\r\n\r\nfunction setAllUnlockToggles(targetState) {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) return 0;\r\n\r\n    let toggled = 0;\r\n    getUnlockRowDefinitions(slot).forEach((rowDef) => {\r\n        let unlocked = false;\r\n        try { unlocked = typeof rowDef.isUnlocked === 'function' ? !!rowDef.isUnlocked() : false; }\r\n        catch {}\r\n\r\n        if (unlocked === targetState) return;\r\n\r\n        try {\r\n            if (targetState) {\r\n                rowDef.onEnable?.();\r\n            } else {\r\n                rowDef.onDisable?.();\r\n            }\r\n            toggled += 1;\r\n        } catch {}\r\n    });\r\n\r\n    try { refreshLiveBindings(); } catch {}\r\n\r\n    return toggled;\r\n}\r\n\r\nfunction unlockAllUnlockUpgrades() {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) return { unlocks: 0, toggles: 0 };\r\n    let unlocked = 0;\r\n    getAreas().forEach((area) => {\r\n        getUpgradesForArea(area.key).forEach((upg) => {\r\n            if (!upg?.unlockUpgrade) return;\r\n            try { markUpgradePermanentlyUnlocked(area.key, upg, slot); unlocked += 1; }\r\n            catch {}\r\n        });\r\n    });\r\n    try { unlockShop(); } catch {}\r\n    try { unlockMap(); } catch {}\r\n    const toggled = setAllUnlockToggles(true);\r\n    return { unlocks: unlocked, toggles: toggled };\r\n}\r\n\r\nfunction lockAllUnlockUpgrades() {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) return { locks: 0, toggles: 0 };\r\n    let locked = 0;\r\n    getAreas().forEach((area) => {\r\n        getUpgradesForArea(area.key).forEach((upg) => {\r\n            if (!upg?.unlockUpgrade) return;\r\n            try { clearPermanentUpgradeUnlock(area.key, upg, slot); locked += 1; }\r\n            catch {}\r\n        });\r\n    });\r\n    try { lockShop(); } catch {}\r\n    try { lockMap(); } catch {}\r\n    const toggled = setAllUnlockToggles(false);\r\n    return { locks: locked, toggles: toggled };\r\n}\r\n\r\nfunction getResetTargetLockKeys(target, slot = getActiveSlot()) {\r\n    const resolvedSlot = slot ?? getActiveSlot();\r\n    if (resolvedSlot == null) return [];\r\n\r\n    const keys = new Set();\r\n    const add = (key) => { if (key) keys.add(key); };\r\n\r\n    const addCurrencyKeys = (currencyKey) => {\r\n        add(getCurrencyStorageKey(currencyKey, resolvedSlot));\r\n        add(getCurrencyMultiplierStorageKey(currencyKey, resolvedSlot));\r\n    };\r\n\r\n    const addStatMultiplier = (statKey) => add(getStatMultiplierStorageKey(statKey, resolvedSlot));\r\n\r\n    const addStatKeys = (statKey) => {\r\n        addStatMultiplier(statKey);\r\n        if (statKey === 'xp' || statKey === 'xpLevel' || statKey === 'xpProgress') {\r\n            add(XP_KEYS.level(resolvedSlot));\r\n            add(XP_KEYS.progress(resolvedSlot));\r\n        }\r\n        if (statKey === 'mutation' || statKey === 'mp' || statKey === 'mpLevel' || statKey === 'mpProgress') {\r\n            add(MUTATION_KEYS.level(resolvedSlot));\r\n            add(MUTATION_KEYS.progress(resolvedSlot));\r\n        }\r\n    };\r\n\r\n    if (target === 'all') {\r\n        Object.values(CURRENCIES).forEach(addCurrencyKeys);\r\n        addStatKeys('xp');\r\n        addStatKeys('mutation');\r\n        STAT_MULTIPLIERS.forEach(({ key }) => addStatMultiplier(key));\r\n        return Array.from(keys);\r\n    }\r\n\r\n    if (target === 'allCurrencies') {\r\n        Object.values(CURRENCIES).forEach(addCurrencyKeys);\r\n        return Array.from(keys);\r\n    }\r\n\r\n    if (target === 'allUnlockedStats') {\r\n        if (getXpState()?.unlocked) addStatKeys('xp');\r\n        if (getMutationState()?.unlocked) addStatKeys('mutation');\r\n        return Array.from(keys);\r\n    }\r\n\r\n    if (target === 'allUnlocked') {\r\n        Object.values(CURRENCIES).forEach(addCurrencyKeys);\r\n        if (getXpState()?.unlocked) addStatKeys('xp');\r\n        if (getMutationState()?.unlocked) addStatKeys('mutation');\r\n        return Array.from(keys);\r\n    }\r\n\r\n    if (target.startsWith('currency:')) {\r\n        addCurrencyKeys(target.slice('currency:'.length));\r\n        return Array.from(keys);\r\n    }\r\n\r\n    if (target.startsWith('statmult:')) {\r\n        addStatMultiplier(target.slice('statmult:'.length));\r\n        return Array.from(keys);\r\n    }\r\n\r\n    if (target.startsWith('stat:')) {\r\n        addStatKeys(target.slice('stat:'.length));\r\n        return Array.from(keys);\r\n    }\r\n\r\n    return Array.from(keys);\r\n}\r\n\r\nfunction resetCurrencyAndMultiplier(currencyKey) {\r\n    try {\r\n        // Reset the banked amount\r\n        bank?.[currencyKey]?.set?.(BigNum.fromInt(0));\r\n    } catch {}\r\n\r\n    try {\r\n        // Clear any debug override for this currency\r\n        clearCurrencyMultiplierOverride(currencyKey);\r\n    } catch {}\r\n\r\n    try {\r\n        // Put the actual in-game multiplier back to 1x\r\n        setCurrencyMultiplierBN(currencyKey, BigNum.fromInt(1));\r\n    } catch {}\r\n}\r\n\r\nfunction resetStatsAndMultipliers(target) {\r\n    if (target === 'all') {\r\n        // All currencies + multipliers: clear overrides and put real multipliers back to 1x\r\n        Object.values(CURRENCIES).forEach((key) => resetCurrencyAndMultiplier(key));\r\n\r\n        const zero = BigNum.fromInt(0);\r\n\r\n        // XP + MP (mutation) state \u2192 0\r\n        applyXpState({ level: zero, progress: zero });\r\n        applyMutationState({ level: zero, progress: zero });\r\n\r\n        // For stats, behave like the stat multiplier debug field:\r\n        // create a temporary 1x override that will be auto-cleared on the next\r\n        // normal game multiplier update (XP Value, MP Value, etc.).\r\n        STAT_MULTIPLIERS.forEach(({ key }) => {\r\n            try { setDebugStatMultiplierOverride(key, BigNum.fromInt(1)); } catch {}\r\n        });\r\n\r\n        const totalCount = Object.values(CURRENCIES).length + STAT_MULTIPLIERS.length + 2; // XP + MP\r\n        return { label: '[GOLD]all[/GOLD] currency/stats', count: totalCount };\r\n    }\r\n\r\n    if (target === 'allCurrencies') {\r\n        let currencyCount = 0;\r\n        Object.values(CURRENCIES).forEach((key) => {\r\n            resetCurrencyAndMultiplier(key);\r\n            currencyCount += 1;\r\n        });\r\n\r\n        const label = currencyCount === 1 ? '1 currency' : `${currencyCount} currencies`;\r\n        return { label, count: currencyCount };\r\n    }\r\n\r\n    if (target === 'allUnlockedStats') {\r\n        const zero = BigNum.fromInt(0);\r\n        let resetCount = 0;\r\n\r\n        try {\r\n            if (getXpState()?.unlocked) {\r\n                applyXpState({ level: zero, progress: zero });\r\n                try { setDebugStatMultiplierOverride('xp', BigNum.fromInt(1)); } catch {}\r\n                resetCount += 1;\r\n            }\r\n        } catch {}\r\n\r\n        try {\r\n            if (getMutationState()?.unlocked) {\r\n                applyMutationState({ level: zero, progress: zero });\r\n                try { setDebugStatMultiplierOverride('mutation', BigNum.fromInt(1)); } catch {}\r\n                resetCount += 1;\r\n            }\r\n        } catch {}\r\n\r\n        const label = resetCount === 1 ? '1 unlocked stat' : `${resetCount} unlocked stats`;\r\n        return { label, count: resetCount };\r\n    }\r\n\r\n    if (target === 'allUnlocked') {\r\n        let currencyCount = 0;\r\n        Object.values(CURRENCIES).forEach((key) => {\r\n            resetCurrencyAndMultiplier(key);\r\n            currencyCount += 1;\r\n        });\r\n\r\n        const zero = BigNum.fromInt(0);\r\n        let resetCount = 0;\r\n\r\n        try {\r\n            if (getXpState()?.unlocked) {\r\n                applyXpState({ level: zero, progress: zero });\r\n                try { setDebugStatMultiplierOverride('xp', BigNum.fromInt(1)); } catch {}\r\n                resetCount += 1;\r\n            }\r\n        } catch {}\r\n\r\n        try {\r\n            if (getMutationState()?.unlocked) {\r\n                applyMutationState({ level: zero, progress: zero });\r\n                try { setDebugStatMultiplierOverride('mutation', BigNum.fromInt(1)); } catch {}\r\n                resetCount += 1;\r\n            }\r\n        } catch {}\r\n\r\n        const parts = [];\r\n\r\n        if (resetCount === 1) parts.push('1 unlocked stat');\r\n        else parts.push(`${resetCount} unlocked stats`);\r\n\r\n        parts.push(currencyCount === 1 ? '1 currency' : `${currencyCount} currencies`);\r\n\r\n        return { label: parts.join(' and '), count: resetCount + currencyCount };\r\n    }\r\n\r\n    if (target.startsWith('currency:')) {\r\n        const currencyKey = target.slice('currency:'.length);\r\n        resetCurrencyAndMultiplier(currencyKey);\r\n        return { label: `${currencyKey}`, count: 1 };\r\n    }\r\n\r\n    if (target.startsWith('statmult:')) {\r\n        const statKey = target.slice('statmult:'.length);\r\n        // \"Reset this stat multiplier\" = remove any debug override,\r\n        // let the game recalculate the multiplier normally.\r\n        try { clearStatMultiplierOverride(statKey); } catch {}\r\n        return { label: `${statKey} multiplier`, count: 1 };\r\n    }\r\n\r\n    if (!target.startsWith('stat:')) {\r\n        return { label: `unknown target ${target}`, count: 0 };\r\n    }\r\n\r\n    const statKey = target.slice('stat:'.length);\r\n    const zero = BigNum.fromInt(0);\r\n\r\n    // Treat any XP-related key as \"XP\": level + progress + multiplier.\r\n    if (statKey === 'xp' || statKey === 'xpLevel' || statKey === 'xpProgress') {\r\n        applyXpState({ level: zero, progress: zero });\r\n        // Temporarily force XP multiplier to 1x (override cleared on next real update)\r\n        try { setDebugStatMultiplierOverride('xp', BigNum.fromInt(1)); } catch {}\r\n        return { label: 'XP', count: 1 };\r\n    }\r\n\r\n    // Treat any MP / mutation key as \"MP\": level + progress + multiplier.\r\n    if (\r\n        statKey === 'mutation' ||\r\n        statKey === 'mp' ||\r\n        statKey === 'mpLevel' ||\r\n        statKey === 'mpProgress'\r\n    ) {\r\n        applyMutationState({ level: zero, progress: zero });\r\n        // Temporarily force MP multiplier to 1x, same semantics as XP\r\n        try { setDebugStatMultiplierOverride('mutation', BigNum.fromInt(1)); } catch {}\r\n        return 'MP';\r\n    }\r\n\r\n    // Fallback: generic stat multiplier reset -> same semantics as the debug stat input\r\n    try { setDebugStatMultiplierOverride(statKey, BigNum.fromInt(1)); } catch {}\r\n    return `stat ${statKey}`;\r\n}\r\n\r\nfunction buildAreaStatMultipliers(container, area) {\r\n    const slot = getActiveSlot();\r\n    if (slot == null) {\r\n        const msg = document.createElement('div');\r\n        msg.className = 'debug-panel-empty';\r\n        msg.textContent = 'Select a save slot to edit stat multipliers.';\r\n        container.appendChild(msg);\r\n        return;\r\n    }\r\n\r\n    const areaLabel = area?.title ?? area?.key ?? 'Unknown Area';\r\n\r\n    STAT_MULTIPLIERS.forEach((stat) => {\r\n        const storageKey = getStatMultiplierStorageKey(stat.key, slot);\r\n        const row = createInputRow(\r\n            `${stat.label} Multiplier`,\r\n            getStatMultiplierDisplayValue(stat.key, slot),\r\n            (value, { setValue }) => {\r\n                const latestSlot = getActiveSlot();\r\n                if (latestSlot == null) return;\r\n                const previous = getStatMultiplierDisplayValue(stat.key, latestSlot);\r\n                try { setDebugStatMultiplierOverride(stat.key, value, latestSlot); } catch {}\r\n                const refreshed = getStatMultiplierDisplayValue(stat.key, latestSlot);\r\n                setValue(refreshed);\r\n                if (!bigNumEquals(previous, refreshed)) {\r\n                    flagDebugUsage();\r\n                    logAction(\r\n                        `Modified ${stat.label} Multiplier (${areaLabel}) ${formatNumber(previous)} \u2192 ${formatNumber(refreshed)}`\r\n                    );\r\n                }\r\n            },\r\n            {\r\n                storageKey,\r\n                onLockChange: (locked) => {\r\n                    const latestSlot = getActiveSlot();\r\n                    if (latestSlot == null) return;\r\n                    if (locked) {\r\n                        const existingOverride = getLockedStatOverride(latestSlot, stat.key);\r\n                        if (existingOverride) return;\r\n                        try {\r\n                            setDebugStatMultiplierOverride(\r\n                                stat.key,\r\n                                getGameStatMultiplier(stat.key),\r\n                                latestSlot\r\n                            );\r\n                        } catch {}\r\n                    } else {\r\n                        getEffectiveStatMultiplierOverride(\r\n                            stat.key,\r\n                            latestSlot,\r\n                            getGameStatMultiplier(stat.key)\r\n                        );\r\n                    }\r\n                    row.setValue(getStatMultiplierDisplayValue(stat.key, latestSlot));\r\n                },\r\n            }\r\n        );\r\n\r\n        registerLiveBinding({\r\n            type: 'stat-mult',\r\n            key: stat.key,\r\n            slot,\r\n            refresh: () => {\r\n                if (slot !== getActiveSlot()) return;\r\n                const latest = getStatMultiplierDisplayValue(stat.key, slot);\r\n                row.setValue(latest);\r\n            },\r\n        });\r\n\r\n        registerLiveBinding({\r\n            type: 'upgrade',\r\n            key: stat.key,\r\n            slot,\r\n            refresh: () => {\r\n                if (slot !== getActiveSlot()) return;\r\n                const latest = getStatMultiplierDisplayValue(stat.key, slot);\r\n                row.setValue(latest);\r\n            },\r\n        });\r\n\r\n        if (stat.key === 'mutation') {\r\n            registerLiveBinding({\r\n                type: 'mutation',\r\n                key: stat.key,\r\n                slot,\r\n                refresh: () => {\r\n                    if (slot !== getActiveSlot()) return;\r\n                    const latest = getStatMultiplierDisplayValue(stat.key, slot);\r\n                    row.setValue(latest);\r\n                },\r\n            });\r\n        }\r\n\r\n        container.appendChild(row.row);\r\n    });\r\n}\r\n\r\nfunction buildAreaCalculators(container) {\r\n    const calculators = [\r\n        {\r\n            title: 'Currencies',\r\n            rows: [\r\n                {\r\n                    label: 'Pending Gold (Forge)',\r\n                    inputs: [\r\n                        { key: 'coins', label: 'Coins' },\r\n                        { key: 'xpLevel', label: 'XP Level' },\r\n                    ],\r\n                    compute: ({ coins, xpLevel }) => computeForgeGoldFromInputs(coins, xpLevel),\r\n                },\r\n            ],\r\n        },\r\n        {\r\n            title: 'Stats',\r\n            rows: [\r\n                {\r\n                    label: 'XP Requirement',\r\n                    inputs: [\r\n                        { key: 'xpLevel', label: 'XP Level' },\r\n                    ],\r\n                    compute: ({ xpLevel }) => getXpRequirementForXpLevel(xpLevel),\r\n                },\r\n                {\r\n                    label: 'XP Level Coin Multiplier',\r\n                    inputs: [\r\n                        { key: 'xpLevel', label: 'XP Level' },\r\n                    ],\r\n                    compute: ({ xpLevel }) => computeCoinMultiplierForXpLevel(xpLevel),\r\n                },\r\n                {\r\n                    label: 'MP Requirement',\r\n                    inputs: [\r\n                        { key: 'mpLevel', label: 'MP Level' },\r\n                    ],\r\n                    compute: ({ mpLevel }) => computeMutationRequirementForLevel(mpLevel),\r\n                },\r\n                {\r\n                    label: 'MP Level Coin/XP Multiplier',\r\n                    inputs: [\r\n                        { key: 'mpLevel', label: 'MP Level' },\r\n                    ],\r\n                    compute: ({ mpLevel }) => computeMutationMultiplierForLevel(mpLevel),\r\n                },\r\n            ],\r\n        },\r\n        {\r\n            title: 'Other',\r\n            rows: [\r\n                {\r\n                    label: 'Default Upgrade Level Cost',\r\n                    inputs: [\r\n                        { key: 'baseCost', label: 'Base Cost' },\r\n                        { key: 'level', label: 'Current Upgrade Level' },\r\n                        {\r\n                            key: 'mode',\r\n                            type: 'select',\r\n                            defaultValue: 'NM',\r\n                            options: [\r\n                                { value: 'NM', label: 'No Milestones' },\r\n                                { value: 'HM', label: 'Has Milestones' },\r\n                            ],\r\n                        },\r\n                    ],\r\n                    compute: ({ baseCost, level, mode }) => computeDefaultUpgradeCost(baseCost, level, mode),\r\n                },\r\n            ],\r\n        },\r\n    ];\r\n\r\n    calculators.forEach((group) => {\r\n        const subsection = createSubsection(group.title, (sub) => {\r\n            if (!group.rows || group.rows.length === 0) {\r\n                const msg = document.createElement('div');\r\n                msg.className = 'debug-panel-empty';\r\n                msg.textContent = 'No calculators available yet.';\r\n                sub.appendChild(msg);\r\n                return;\r\n            }\r\n\r\n            group.rows.forEach((row) => {\r\n                const calculatorRow = createCalculatorRow({\r\n                    labelText: row.label,\r\n                    inputs: row.inputs,\r\n                    compute: row.compute,\r\n                });\r\n                sub.appendChild(calculatorRow);\r\n            });\r\n        });\r\n\r\n        container.appendChild(subsection);\r\n    });\r\n}\r\n\r\nfunction buildAreasContent(content) {\r\n    content.innerHTML = '';\r\n\r\n    const slot = getActiveSlot();\r\n    if (slot == null) {\r\n        const placeholder = document.createElement('div');\r\n        placeholder.className = 'debug-panel-empty';\r\n        placeholder.textContent = 'Areas are available once a save slot is selected.';\r\n        content.appendChild(placeholder);\r\n        return;\r\n    }\r\n\r\n    applyAllCurrencyOverridesForActiveSlot();\r\n\r\n    const areas = getAreas();\r\n\r\n    areas.forEach((area) => {\r\n        const areaContainer = createSubsection(area.title, (areaContent) => {\r\n            const currencies = createSubsection('Currencies', (sub) => {\r\n                buildAreaCurrencies(sub, area);\r\n            });\r\n            const stats = createSubsection('Stats', (sub) => {\r\n                buildAreaStats(sub, area);\r\n            });\r\n            const multipliers = createSubsection('Multipliers', (sub) => {\r\n                const currencyMultipliers = createSubsection('Currencies', (subsection) => {\r\n                    buildAreaCurrencyMultipliers(subsection, area);\r\n                });\r\n                const statMultipliers = createSubsection('Stats', (subsection) => {\r\n                    buildAreaStatMultipliers(subsection, area);\r\n                });\r\n\r\n                sub.appendChild(currencyMultipliers);\r\n                sub.appendChild(statMultipliers);\r\n            });\r\n            const upgrades = createSubsection('Upgrades', (sub) => {\r\n                buildAreaUpgrades(sub, area);\r\n            });\r\n            const calculators = createSubsection('Calculators', (sub) => {\r\n                buildAreaCalculators(sub);\r\n            });\r\n\t\t\t\r\n            areaContent.appendChild(currencies);\r\n            areaContent.appendChild(stats);\r\n            areaContent.appendChild(multipliers);\r\n            areaContent.appendChild(upgrades);\r\n            areaContent.appendChild(calculators);\r\n        });\r\n        areaContainer.classList.add('debug-panel-area');\r\n\r\n        content.appendChild(areaContainer);\r\n    });\r\n}\r\n\r\nfunction buildMiscContent(content) {\r\n    content.innerHTML = '';\r\n\r\n    const slot = getActiveSlot();\r\n    if (slot == null) {\r\n        const placeholder = document.createElement('div');\r\n        placeholder.className = 'debug-panel-empty';\r\n        placeholder.textContent = 'Miscellaneous tools are available once a save slot is selected.';\r\n        content.appendChild(placeholder);\r\n        return;\r\n    }\r\n\r\n    const buttons = [\r\n        {\r\n            label: 'Complete Dialogues',\r\n            onClick: () => {\r\n                const { completed } = completeAllDialoguesForDebug();\r\n                flagDebugUsage();\r\n                logAction(`Completed all dialogues (${completed} newly claimed).`);\r\n            },\r\n        },\r\n        {\r\n            label: 'Restore Dialogues',\r\n            onClick: () => {\r\n                const { restored } = restoreAllDialoguesForDebug();\r\n                flagDebugUsage();\r\n                const entryLabel = restored === 1 ? 'entry' : 'entries';\r\n                logAction(`Restored dialogues to unclaimed state (${restored} ${entryLabel} reset).`);\r\n            },\r\n        },\r\n        {\r\n            label: 'All Currencies Inf',\r\n            onClick: () => {\r\n                const touched = setAllCurrenciesToInfinity();\r\n                flagDebugUsage();\r\n                logAction(`Set all currencies to Infinity (${touched} ${touched === 1 ? 'currency' : 'currencies'} updated).`);\r\n            },\r\n        },\r\n        {\r\n            label: 'All Stats Inf',\r\n            onClick: () => {\r\n                                const touched = setAllStatsToInfinity();\r\n                flagDebugUsage();\r\n                logAction(`Set all stats to Infinity (${touched} ${touched === 1 ? 'stat' : 'stats'} updated).`);\r\n            },\r\n        },\r\n\t\t{\r\n            label: 'All Currencies 0',\r\n            onClick: () => {\r\n                const touched = setAllCurrenciesToZero();\r\n                flagDebugUsage();\r\n                logAction(`Set all currencies to 0 (${touched} ${touched === 1 ? 'currency' : 'currencies'} updated).`);\r\n            },\r\n        },\r\n        {\r\n            label: 'All Stats 0',\r\n            onClick: () => {\r\n                const touched = setAllStatsToZero();\r\n                flagDebugUsage();\r\n                logAction(`Set all unlocked stats to 0 (${touched} ${touched === 1 ? 'stat' : 'stats'} updated).`);\r\n            },\r\n        },\r\n        {\r\n            label: 'Unlock All Unlocks',\r\n            onClick: () => {\r\n                const { unlocks, toggles } = unlockAllUnlockUpgrades();\r\n                flagDebugUsage();\r\n                logAction(`Unlocked all unlock-type upgrades (${unlocks} entries) and unlock flags (${toggles} toggled).`);\r\n            },\r\n        },\r\n        {\r\n            label: 'Lock All Unlocks',\r\n            onClick: () => {\r\n                const { locks, toggles } = lockAllUnlockUpgrades();\r\n                flagDebugUsage();\r\n                logAction(`Locked all unlock-type upgrades (${locks} entries) and unlock flags (${toggles} toggled).`);\r\n            },\r\n        },\r\n        {\r\n            label: 'Wipe Action Log',\r\n            onClick: () => {\r\n                persistActionLog([], slot);\r\n                updateActionLogDisplay();\r\n                flagDebugUsage();\r\n                logAction('Action log wiped and reset.');\r\n            },\r\n        },\r\n    ];\r\n\r\n    const buttonGrid = document.createElement('div');\r\n    buttonGrid.className = 'debug-misc-button-list';\r\n    buttons.forEach((cfg) => {\r\n        const btn = document.createElement('button');\r\n        btn.type = 'button';\r\n        btn.className = 'debug-panel-toggle debug-misc-button';\r\n        btn.textContent = cfg.label;\r\n        btn.addEventListener('click', cfg.onClick);\r\n        buttonGrid.appendChild(btn);\r\n    });\r\n    content.appendChild(buttonGrid);\r\n\r\n    const resetRow = document.createElement('div');\r\n    resetRow.className = 'debug-panel-row';\r\n    const resetLabel = document.createElement('label');\r\n    resetLabel.textContent = 'Reset Values & Multis For:';\r\n    resetRow.appendChild(resetLabel);\r\n\r\n    const resetSelect = document.createElement('select');\r\n    resetSelect.className = 'debug-panel-input debug-reset-values-select';\r\n    applyMobileGhostTapToDropdown(resetSelect);\r\n\r\n    getAreas().forEach((area) => {\r\n        const group = document.createElement('optgroup');\r\n        group.label = area.title || area.key;\r\n        area.currencies.forEach((currency) => {\r\n            const opt = document.createElement('option');\r\n            opt.value = `currency:${currency.key}`;\r\n            opt.textContent = `${area.title || area.key} \u2192 ${currency.label}`;\r\n            group.appendChild(opt);\r\n        });\r\n        area.stats.forEach((stat) => {\r\n            const opt = document.createElement('option');\r\n            opt.value = `stat:${stat.key}`;\r\n            opt.textContent = `${area.title || area.key} \u2192 ${stat.label}`;\r\n            group.appendChild(opt);\r\n        });\r\n        resetSelect.appendChild(group);\r\n    });\r\n\r\n    const allCurrenciesOption = document.createElement('option');\r\n    allCurrenciesOption.value = 'allCurrencies';\r\n    allCurrenciesOption.textContent = 'All Currencies';\r\n    resetSelect.appendChild(allCurrenciesOption);\r\n\r\n    const allUnlockedStatsOption = document.createElement('option');\r\n    allUnlockedStatsOption.value = 'allUnlockedStats';\r\n    allUnlockedStatsOption.textContent = 'All Unlocked Stats';\r\n    resetSelect.appendChild(allUnlockedStatsOption);\r\n\t\r\n\tconst allUnlockedOption = document.createElement('option');\r\n    allUnlockedOption.value = 'allUnlocked';\r\n    allUnlockedOption.textContent = 'All Unlocked Stats & Currs';\r\n    resetSelect.appendChild(allUnlockedOption);\r\n\r\n    const allOption = document.createElement('option');\r\n    allOption.value = 'all';\r\n    allOption.textContent = 'All';\r\n    resetSelect.appendChild(allOption);\r\n\r\n    const resolveResetLockKeys = () =>\r\n    getResetTargetLockKeys('all', getActiveSlot());\r\n\r\n\tconst resetLockToggle = createCompositeLockToggle(resolveResetLockKeys);\r\n\r\n    resetRow.appendChild(resetSelect);\r\n    resetRow.appendChild(resetLockToggle.button);\r\n\r\n    const resetBtn = document.createElement('button');\r\n    resetBtn.type = 'button';\r\n    resetBtn.className = 'debug-panel-toggle reset-check';\r\n    resetBtn.textContent = '\u2705';\r\n    resetBtn.addEventListener('click', () => {\r\n        const target = resetSelect.value || 'all';\r\n        const lockKeys = resolveResetLockKeys();\r\n        const shouldRelock = resetLockToggle.isLocked();\r\n        const result = withTemporaryUnlock(lockKeys, () => resetStatsAndMultipliers(target))\r\n            ?? { label: target, count: 0 };\r\n        if (shouldRelock) {\r\n            lockKeys.forEach((key) => lockStorageKey(key));\r\n        }\r\n        resetLockToggle.refresh();\r\n        const { label, count } = result;\r\n        const nounPhrase = count === 1 ? 'value and multiplier' : 'values and multipliers';\r\n        flagDebugUsage();\r\n        logAction(`Reset ${nounPhrase} for ${label} to defaults.`);\r\n    });\r\n    resetRow.appendChild(resetBtn);\r\n    content.appendChild(resetRow);\r\n\r\n    const actionLogRow = document.createElement('div');\r\n    actionLogRow.className = 'debug-panel-row';\r\n\r\nconst wipeSlotBtn = document.createElement('button');\r\nwipeSlotBtn.type = 'button';\r\nwipeSlotBtn.className = 'debug-panel-toggle debug-danger-button';\r\nwipeSlotBtn.textContent = 'Wipe Slot & Refresh';\r\nwipeSlotBtn.addEventListener('click', () => {\r\n    const confirmWipe = window.confirm?.(\r\n        'Are you sure you want to wipe current slot data and refresh the page? This cannot be undone.'\r\n    );\r\n    if (!confirmWipe) return;\r\n\r\n    try {\r\n        localStorage.setItem('ccc:pendingSlotWipe', String(slot));\r\n    } catch {}\r\n\r\n    try {\r\n        localStorage.removeItem('ccc:saveSlot');\r\n    } catch {}\r\n\r\n    try {\r\n        const menuRoot = document.querySelector('.menu-root');\r\n        const gameRoot = document.getElementById('game-root');\r\n        if (menuRoot) {\r\n            menuRoot.hidden = false;\r\n            menuRoot.style.display = '';\r\n            menuRoot.style.visibility = '';\r\n        }\r\n        if (gameRoot) {\r\n            gameRoot.hidden = true;\r\n            gameRoot.style.display = 'none';\r\n        }\r\n    } catch {}\r\n\r\n    try {\r\n        setTimeout(() => {\r\n            try { window.location.reload(); } catch {}\r\n        }, 16);\r\n    } catch {\r\n        try { window.location.reload(); } catch {}\r\n    }\r\n});\r\nactionLogRow.appendChild(wipeSlotBtn);\r\n\r\n    content.appendChild(actionLogRow);\r\n}\r\n\r\nfunction buildUnlocksContent(content) {\r\n    content.innerHTML = '';\r\n\r\n    const slot = getActiveSlot();\r\n    if (slot == null) {\r\n        const placeholder = document.createElement('div');\r\n        placeholder.className = 'debug-panel-empty';\r\n        placeholder.textContent = 'Unlocks are available once a save slot is selected.';\r\n        content.appendChild(placeholder);\r\n        return;\r\n    }\r\n\r\n    try { initXpSystem(); }\r\n    catch {}\r\n\r\n    const rows = getUnlockRowDefinitions(slot);\r\n\r\n    rows.forEach((rowDef) => {\r\n        content.appendChild(createUnlockToggleRow(rowDef));\r\n    });\r\n}\r\n\r\nfunction buildDebugPanel() {\r\n    if (!debugPanelAccess || isOnMenu()) return;\r\n    cleanupDebugPanelResources();\r\n    ensureDebugPanelStyles();\r\n    sectionKeyCounter = 0;\r\n    subsectionKeyCounter = 0;\r\n\r\n    const existingPanel = document.getElementById(DEBUG_PANEL_ID);\r\n    if (existingPanel) existingPanel.remove();\r\n\r\n    const panel = document.createElement('div');\r\n    panel.id = DEBUG_PANEL_ID;\r\n    panel.className = 'debug-panel';\r\n\r\n    const header = document.createElement('div');\r\n    header.className = 'debug-panel-header';\r\n\r\n    const titleContainer = document.createElement('div');\r\n\r\n    const title = document.createElement('div');\r\n    title.className = 'debug-panel-title';\r\n    title.textContent = 'Debug Panel';\r\n\r\n    const closeButtonContainer = document.createElement('div');\r\n    closeButtonContainer.className = 'debug-panel-close-buttons';\r\n\r\n    const closeButton = document.createElement('button');\r\n    closeButton.className = 'debug-panel-close';\r\n    closeButton.type = 'button';\r\n    closeButton.setAttribute('aria-label', 'Close Debug Panel');\r\n    closeButton.textContent = 'Close';\r\n    closeButton.addEventListener('click', () => closeDebugPanel({ preserveExpansionState: true }));\r\n\r\n    const collapseCloseButton = document.createElement('button');\r\n    collapseCloseButton.className = 'debug-panel-close debug-panel-close-collapse';\r\n    collapseCloseButton.type = 'button';\r\n    collapseCloseButton.setAttribute('aria-label', 'Close Debug Panel and Collapse Sections');\r\n    collapseCloseButton.textContent = 'Close & Collapse';\r\n    collapseCloseButton.addEventListener('click', () => closeDebugPanel());\r\n\r\n    closeButtonContainer.appendChild(closeButton);\r\n    closeButtonContainer.appendChild(collapseCloseButton);\r\n\r\n    titleContainer.appendChild(title);\r\n    const info = document.createElement('div');\r\n    info.className = 'debug-panel-info';\r\n\r\n    const infoLines = [\r\n        { text: 'C: Close and preserve panels', hideOnMobile: true },\r\n        { text: 'Shift+C: Close and collapse panels', hideOnMobile: true },\r\n        { text: 'Input fields can take a normal, scientific, or BN number as input' },\r\n        { text: 'Input value \"inf\" sets a value to infinity or an upgrade to its level cap' },\r\n        { text: 'Toggle UL/L (Unlocked/Locked) on a value to freeze it from accruing normally' },\r\n    ];\r\n\r\n    infoLines.forEach(({ text, hideOnMobile }) => {\r\n        const infoLine = document.createElement('div');\r\n        infoLine.className = 'debug-panel-info-line';\r\n        if (hideOnMobile) infoLine.classList.add('debug-panel-info-mobile-hidden');\r\n        infoLine.textContent = text;\r\n        info.appendChild(infoLine);\r\n    });\r\n\r\n    titleContainer.appendChild(info);\r\n\r\n    header.appendChild(titleContainer);\r\n    header.appendChild(closeButtonContainer);\r\n    panel.appendChild(header);\r\n\r\n    panel.appendChild(createSection('Areas: main currency/stat/upgrade management for each area', 'debug-areas', content => {\r\n        buildAreasContent(content);\r\n    }));\r\n\r\n    panel.appendChild(createSection('Unlocks: modify specific unlock flags', 'debug-unlocks', content => {\r\n        buildUnlocksContent(content);\r\n    }));\r\n\r\n    panel.appendChild(createSection('Action Log: keep track of everything you do', 'debug-action-log', content => {\r\n        const container = document.createElement('div');\r\n        container.id = 'action-log-entries';\r\n        container.className = 'debug-panel-action-log';\r\n        container.style.maxHeight = '240px';\r\n        container.style.overflowY = 'auto';\r\n        content.appendChild(container);\r\n        actionLogContainer = container;\r\n        updateActionLogDisplay();\r\n        addDebugPanelCleanup(() => { actionLogContainer = null; });\r\n    }));\r\n\t\r\n    panel.appendChild(createSection('Miscellaneous: helpful miscellaneous functions', 'debug-misc', content => {\r\n        buildMiscContent(content);\r\n    }));\r\n\r\n    applyDebugPanelExpansionState(panel);\r\n\r\n    document.body.appendChild(panel);\r\n\r\n    if (debugPanelScrollTop > 0) {\r\n        try { panel.scrollTop = debugPanelScrollTop; }\r\n        catch {}\r\n    }\r\n    setupLiveBindingListeners();\r\n    debugPanelOpen = true;\r\n}\r\n\r\nfunction openDebugPanel() {\r\n    if (!debugPanelAccess || isOnMenu()) return;\r\n    if (getActiveSlot() == null) {\r\n        closeDebugPanel();\r\n        return;\r\n    }\r\n    if (debugPanelOpen) return;\r\n    buildDebugPanel();\r\n}\r\n\r\nfunction closeDebugPanel({ preserveExpansionState = false } = {}) {\r\n    debugPanelExpansionState = preserveExpansionState\r\n        ? captureDebugPanelExpansionState()\r\n        : createEmptyExpansionState();\r\n    const panel = document.getElementById(DEBUG_PANEL_ID);\r\n    if (panel) {\r\n        try { debugPanelScrollTop = panel.scrollTop ?? 0; }\r\n        catch { debugPanelScrollTop = 0; }\r\n        panel.remove();\r\n    }\r\n    cleanupDebugPanelResources();\r\n    debugPanelOpen = false;\r\n}\r\n\r\nfunction toggleDebugPanel() {\r\n    if (!debugPanelAccess || isOnMenu() || getActiveSlot() == null) {\r\n        closeDebugPanel();\r\n        return;\r\n    }\r\n    if (debugPanelOpen) {\r\n        closeDebugPanel({ preserveExpansionState: true });\r\n    } else {\r\n        openDebugPanel();\r\n    }\r\n}\r\n\r\nfunction teardownDebugPanel() {\r\n    closeDebugPanel();\r\n    removeDebugPanelToggleButton();\r\n}\r\n\r\nfunction createDebugPanelToggleButton() {\r\n    if (!shouldShowDebugPanelToggleButton()) {\r\n        removeDebugPanelToggleButton();\r\n        closeDebugPanel();\r\n        return;\r\n    }\r\n    ensureDebugPanelStyles();\r\n\r\n    removeDebugPanelToggleButton();\r\n\r\n    const button = document.createElement('button');\r\n    button.id = DEBUG_PANEL_TOGGLE_ID;\r\n    button.className = 'debug-panel-toggle-button';\r\n    button.type = 'button';\r\n    button.textContent = 'Debug Panel';\r\n    let lastPointerType = null;\r\n\r\n    const handleToggle = (event) => {\r\n        if (event.isTrusted && shouldSkipGhostTap(button)) return;\r\n        markGhostTapTarget(button);\r\n        toggleDebugPanel();\r\n    };\r\n\r\n    button.addEventListener('pointerdown', (event) => {\r\n        lastPointerType = event.pointerType || null;\r\n        if (event.pointerType === 'mouse') return;\r\n        event.preventDefault();\r\n        handleToggle(event);\r\n    });\r\n\r\n    button.addEventListener('click', (event) => {\r\n        if (lastPointerType && lastPointerType !== 'mouse') {\r\n            lastPointerType = null;\r\n            return;\r\n        }\r\n        lastPointerType = null;\r\n        handleToggle(event);\r\n    });\r\n\r\n    document.body.appendChild(button);\r\n}\r\n\r\nfunction applyDebugPanelAccess(enabled) {\r\n    debugPanelAccess = !!enabled;\r\n    if (!debugPanelAccess) {\r\n        teardownDebugPanel();\r\n        return;\r\n    }\r\n    createDebugPanelToggleButton();\r\n}\r\n\r\napplyDebugPanelAccess(false);\r\n\r\ndocument.addEventListener('keydown', event => {\r\n    if (!debugPanelAccess || isOnMenu()) return;\r\n    if (event.key?.toLowerCase() !== 'c') return;\r\n    if (event.ctrlKey) return;\r\n\r\n    if (getActiveSlot() == null) return;\r\n\r\n    if (event.shiftKey) {\r\n        if (debugPanelOpen) {\r\n            collapseAllDebugCategories();\r\n            closeDebugPanel();\r\n        } else {\r\n            openDebugPanel();\r\n        }\r\n        event.preventDefault();\r\n        return;\r\n    }\r\n\r\n    if (!debugPanelOpen) {\r\n        openDebugPanel();\r\n    } else {\r\n        closeDebugPanel({ preserveExpansionState: true });\r\n    }\r\n\t\r\n    event.preventDefault();\r\n});\r\n\r\ndocument.addEventListener('DOMContentLoaded', () => {\r\n    createDebugPanelToggleButton();\r\n});\r\n\r\nwindow.addEventListener('menu:visibilitychange', onMenuVisibilityChange);\r\n\r\nwindow.addEventListener('saveSlot:change', () => {\r\n    createDebugPanelToggleButton();\r\n    if (debugPanelOpen) {\r\n        buildDebugPanel();\r\n    }\r\n});\r\n\r\nexport function setDebugPanelAccess(enabled) {\r\n    applyDebugPanelAccess(enabled);\r\n}\r\n", "// js/game/mutationSystem.js\r\n\r\nimport { BigNum } from '../util/bigNum.js';\r\nimport { getActiveSlot, watchStorageKey, primeStorageWatcherSnapshot } from '../util/storage.js';\r\nimport { applyStatMultiplierOverride } from '../util/debugPanel.js';\r\nimport { formatNumber } from '../util/numFormat.js';\r\nimport { approxLog10BigNum, bigNumFromLog10 } from './upgrades.js';\r\nimport { syncXpMpHudLayout } from '../ui/hudLayout.js';\r\nimport { refreshCoinMultiplierFromXpLevel } from './xpSystem.js';\r\n\r\nconst KEY_PREFIX = 'ccc:mutation';\r\nconst KEY_UNLOCK = (slot) => `${KEY_PREFIX}:unlocked:${slot}`;\r\nconst KEY_LEVEL = (slot) => `${KEY_PREFIX}:level:${slot}`;\r\nconst KEY_PROGRESS = (slot) => `${KEY_PREFIX}:progress:${slot}`;\r\n\r\nconst BN = BigNum;\r\nconst bnZero = () => BN.fromInt(0);\r\nconst bnOne = () => BN.fromInt(1);\r\n\r\nconst MP_LOG10_BASE = Math.log10(2);\r\nconst CONST_RATIO = (10 - 1) / (Math.pow(1.12, 50) - 1);\r\n\r\nfunction toStorageSafe(value) {\r\n  try { return value?.toStorage?.(); }\r\n  catch { return null; }\r\n}\r\n\r\nconst mutationState = {\r\n  unlocked: false,\r\n  level: bnZero(),\r\n  progress: bnZero(),\r\n  requirement: bnZero(),\r\n  slot: null,\r\n};\r\n\r\nconst hudRefs = {\r\n  container: null,\r\n  bar: null,\r\n  fill: null,\r\n  levelValue: null,\r\n  progress: null,\r\n};\r\n\r\nconst listeners = new Set();\r\nconst watcherCleanups = [];\r\nlet watchersBoundSlot = null;\r\nlet initialized = false;\r\nlet unregisterCoinMultiplierProvider = null;\r\nlet unregisterXpGainMultiplierProvider = null;\r\n\r\nfunction scheduleCoinMultiplierRefresh() {\r\n  try { refreshCoinMultiplierFromXpLevel(); } catch {}\r\n}\r\n\r\nfunction ensureExternalMultiplierProviders() {\r\n  if (typeof unregisterCoinMultiplierProvider === 'function') {\r\n    try { unregisterCoinMultiplierProvider(); } catch {}\r\n    unregisterCoinMultiplierProvider = null;\r\n  }\r\n  if (typeof unregisterXpGainMultiplierProvider === 'function') {\r\n    try { unregisterXpGainMultiplierProvider(); } catch {}\r\n    unregisterXpGainMultiplierProvider = null;\r\n  }\r\n}\r\n\r\nfunction cloneBigNum(value) {\r\n  if (value instanceof BN) {\r\n    try { return value.clone?.() ?? BN.fromAny(value); }\r\n    catch { return bnZero(); }\r\n  }\r\n  try { return BN.fromAny(value ?? 0); }\r\n  catch { return bnZero(); }\r\n}\r\n\r\nfunction quantizeRequirement(value) {\r\n  if (!value || typeof value !== 'object') return bnZero();\r\n  if (value.isInfinite?.()) return value.clone?.() ?? value;\r\n  const sci = typeof value.toScientific === 'function' ? value.toScientific(18) : '';\r\n  if (!sci || sci === 'Infinity') return value.clone?.() ?? value;\r\n  const match = sci.match(/^(\\d+(?:\\.\\d+)?)e([+-]?\\d+)$/i);\r\n  if (!match) return value.clone?.() ?? value;\r\n  const exp = parseInt(match[2], 10);\r\n  const digits = exp + 1;\r\n  if (digits <= 18) {\r\n    const floored = value.floorToInteger?.() ?? value.clone?.() ?? value;\r\n    const plain = floored.toPlainIntegerString?.();\r\n    if (!plain || plain === 'Infinity') return floored;\r\n    try {\r\n      const quant = (BigInt(plain) / 100n) * 100n;\r\n      if (quant <= 0n) return BN.fromInt(100);\r\n      return BN.fromAny(quant.toString());\r\n    } catch {\r\n      return floored;\r\n    }\r\n  }\r\n  return value.clone?.() ?? value;\r\n}\r\n\r\nfunction levelToNumber(level) {\r\n  if (!level || typeof level !== 'object') return 0;\r\n  if (level.isInfinite?.()) return Number.POSITIVE_INFINITY;\r\n  try {\r\n    const plain = level.toPlainIntegerString?.();\r\n    if (plain && plain !== 'Infinity' && plain.length <= 15) {\r\n      const num = Number(plain);\r\n      if (Number.isFinite(num)) return num;\r\n    }\r\n  } catch {}\r\n  const approxLog = approxLog10BigNum(level);\r\n  if (!Number.isFinite(approxLog)) return Number.POSITIVE_INFINITY;\r\n  if (approxLog > 308) return Number.POSITIVE_INFINITY;\r\n  return Math.pow(10, approxLog);\r\n}\r\n\r\nfunction computeRequirement(levelBn) {\r\n  // Original requirement curve, returning log10(requirement)\r\n  function baseRequirementLog10(baseLevel) {\r\n    const m = Math.max(0, baseLevel + 1);\r\n    const tail = Math.max(0, m - 10);\r\n\r\n    const poly = -0.0022175354763501742 * m * m\r\n      + 0.20449967884058884 * m\r\n      + 2.016778189084622\r\n      + 0.20418426693226513 * Math.pow(tail, 1.6418337930413576);\r\n    if (!Number.isFinite(poly)) {\r\n      return Number.POSITIVE_INFINITY;\r\n    }\r\n\r\n    let factor = 1;\r\n    if (m > 10) {\r\n      const powTerm = Math.pow(1.12, m - 10);\r\n      if (!Number.isFinite(powTerm)) {\r\n        return Number.POSITIVE_INFINITY;\r\n      }\r\n      factor += CONST_RATIO * (powTerm - 1);\r\n      if (!Number.isFinite(factor)) {\r\n        return Number.POSITIVE_INFINITY;\r\n      }\r\n    }\r\n\r\n    const totalLog10 = poly * factor;\r\n    if (!Number.isFinite(totalLog10)) {\r\n      return Number.POSITIVE_INFINITY;\r\n    }\r\n    return totalLog10;\r\n  }\r\n\r\n  const levelNum = levelToNumber(levelBn);\r\n  if (!Number.isFinite(levelNum)) {\r\n    // Infinite / NaN level \u2192 infinite requirement\r\n    return BN.fromAny('Infinity');\r\n  }\r\n\r\n  const baseLevel = Math.max(0, levelNum);\r\n\r\n  // Hard wall: mutation 100+ is impossible\r\n  if (baseLevel >= 100) {\r\n    return BN.fromAny('Infinity');\r\n  }\r\n\r\n  let totalLog10;\r\n\r\n  if (baseLevel <= 49) {\r\n    // 0\u201349: original scaling\r\n    totalLog10 = baseRequirementLog10(baseLevel);\r\n  } else {\r\n    // 50\u201399: double-exponential insanity zone.\r\n    //\r\n    // Define x so:\r\n    //   level 50 \u2192 x = 1\r\n    //   level 99 \u2192 x = 50\r\n    const x = baseLevel - 49; // 1..50\r\n\r\n    // We work in \"second exponent\" space:\r\n    //   secondExp = log10( log10(requirement) )\r\n    //\r\n    // Targets:\r\n    //   level 50 (x=1)  \u2192 secondExp \u2248 3    \u2192 log10 \u2248 1e3   \u2192 ~1e1000 MP\r\n    //   level 99 (x=50) \u2192 secondExp \u2248 303  \u2192 log10 \u2248 1e303 \u2192 ~1e1e303 MP\r\n    //\r\n    // Use quadratic: secondExp(x) = A * x^2 + B\r\n    // Solve:\r\n    //   A + B        = 3\r\n    //   2500*A + B   = 303\r\n    // \u21D2 A = 300 / 2499, B = 3 - A\r\n    const A = 300 / (50 * 50 - 1); // 300 / 2499\r\n    const B = 3 - A;\r\n\r\n    const secondExp = A * x * x + B;\r\n    if (!Number.isFinite(secondExp)) {\r\n      return BN.fromAny('Infinity');\r\n    }\r\n\r\n    // log10(requirement) = 10 ^ secondExp\r\n    totalLog10 = Math.pow(10, secondExp);\r\n  }\r\n\r\n  if (!Number.isFinite(totalLog10) || totalLog10 <= 0) {\r\n    return BN.fromAny('Infinity');\r\n  }\r\n\r\n  const raw = bigNumFromLog10(totalLog10);\r\n  return quantizeRequirement(raw);\r\n}\r\n\r\nfunction ensureRequirement() {\r\n  const lvl = mutationState.level;\r\n\r\n  const levelIsInf = !!(\r\n    lvl &&\r\n    typeof lvl === 'object' &&\r\n    (lvl.isInfinite?.() || (typeof lvl.isInfinite === 'function' && lvl.isInfinite()))\r\n  );\r\n\r\n  if (levelIsInf) {\r\n    try {\r\n      const inf = BigNum.fromAny('Infinity');\r\n      mutationState.requirement = inf.clone?.() ?? inf;\r\n      mutationState.progress = inf.clone?.() ?? inf;\r\n    } catch {\r\n      if (!mutationState.requirement || typeof mutationState.requirement !== 'object') {\r\n        mutationState.requirement = BigNum.fromInt(0);\r\n      }\r\n      if (!mutationState.progress || typeof mutationState.progress !== 'object') {\r\n        mutationState.progress = BigNum.fromInt(0);\r\n      }\r\n    }\r\n    return;\r\n  }\r\n\r\n  const req = computeRequirement(mutationState.level);\r\n  mutationState.requirement = req;\r\n}\r\n\r\n\r\nfunction progressRatio(progressBn, requirement) {\r\n  if (!requirement || typeof requirement !== 'object') return 0;\r\n  if (!progressBn || typeof progressBn !== 'object') return 0;\r\n\r\n  const reqInf = requirement.isInfinite?.();\r\n  const progInf = progressBn.isInfinite?.();\r\n\r\n  // If both are infinite, treat the bar as \"full\".\r\n  if (reqInf) {\r\n    if (progInf) return 1;\r\n    return 0;\r\n  }\r\n\r\n  const reqZero = requirement.isZero?.();\r\n  if (reqZero) return 0;\r\n\r\n  const progZero = progressBn.isZero?.();\r\n  if (progZero) return 0;\r\n\r\n  const logProg = approxLog10BigNum(progressBn);\r\n  const logReq = approxLog10BigNum(requirement);\r\n  if (!Number.isFinite(logProg) || !Number.isFinite(logReq)) {\r\n    return logProg >= logReq ? 1 : 0;\r\n  }\r\n\r\n  const diff = logProg - logReq;\r\n  const ratio = Math.pow(10, diff);\r\n  if (!Number.isFinite(ratio)) {\r\n    return diff >= 0 ? 1 : 0;\r\n  }\r\n  if (ratio <= 0) return 0;\r\n  if (ratio >= 1) return 1;\r\n  return ratio;\r\n}\r\n\r\nfunction ensureHudRefs() {\r\n  if (hudRefs.container && hudRefs.container.isConnected) return true;\r\n  hudRefs.container = document.querySelector('[data-mp-hud].mp-counter');\r\n  if (!hudRefs.container) return false;\r\n  hudRefs.bar = hudRefs.container.querySelector('.mp-bar');\r\n  hudRefs.fill = hudRefs.container.querySelector('.mp-bar__fill');\r\n  hudRefs.levelValue = hudRefs.container.querySelector('.mp-level-value');\r\n  hudRefs.progress = hudRefs.container.querySelector('[data-mp-progress]');\r\n  return true;\r\n}\r\n\r\nfunction formatBn(bn) {\r\n  try { return formatNumber(bn); }\r\n  catch {\r\n    try { return bn.toPlainIntegerString?.() ?? String(bn); }\r\n    catch { return '0'; }\r\n  }\r\n}\r\n\r\nfunction updateHud() {\r\n  if (!ensureHudRefs()) return;\r\n  const { container, bar, fill, levelValue, progress } = hudRefs;\r\n  if (!container) return;\r\n  if (!mutationState.unlocked) {\r\n    container.setAttribute('hidden', '');\r\n    if (fill) {\r\n      fill.style.setProperty('--mp-fill', '0%');\r\n      fill.style.width = '0%';\r\n    }\r\n    if (levelValue) levelValue.textContent = '0';\r\n    if (progress) {\r\n      const reqHtml = formatBn(mutationState.requirement);\r\n      progress.innerHTML = `0<span class=\"mp-progress-separator\">/</span><span class=\"mp-progress-required\">${reqHtml}</span><span class=\"mp-progress-suffix\">MP</span>`;\r\n    }\r\n    if (bar) {\r\n      bar.setAttribute('aria-valuenow', '0');\r\n      const reqPlain = formatBn(mutationState.requirement).replace(/<[^>]*>/g, '');\r\n      bar.setAttribute('aria-valuetext', `0 / ${reqPlain || '10'} MP`);\r\n    }\r\n    syncXpMpHudLayout();\r\n    return;\r\n  }\r\n\r\n  container.removeAttribute('hidden');\r\n  const req = mutationState.requirement;\r\n  const ratio = progressRatio(mutationState.progress, req);\r\n  const pct = `${(ratio * 100).toFixed(2)}%`;\r\n  if (fill) {\r\n    fill.style.setProperty('--mp-fill', pct);\r\n    fill.style.width = pct;\r\n  }\r\n  if (levelValue) {\r\n    levelValue.innerHTML = formatBn(mutationState.level);\r\n  }\r\n  if (progress) {\r\n    const currentHtml = formatBn(mutationState.progress);\r\n    const reqHtml = formatBn(req);\r\n    progress.innerHTML = `<span class=\"mp-progress-current\">${currentHtml}</span><span class=\"mp-progress-separator\">/</span><span class=\"mp-progress-required\">${reqHtml}</span><span class=\"mp-progress-suffix\">MP</span>`;\r\n  }\r\n  if (bar) {\r\n    bar.setAttribute('aria-valuenow', (ratio * 100).toFixed(2));\r\n    const currPlain = formatBn(mutationState.progress).replace(/<[^>]*>/g, '');\r\n    const reqPlain = formatBn(req).replace(/<[^>]*>/g, '');\r\n    bar.setAttribute('aria-valuetext', `${currPlain} / ${reqPlain} MP`);\r\n  }\r\n  syncXpMpHudLayout();\r\n}\r\n\r\nfunction emitChange(reason = 'update', extraDetail = {}) {\r\n  const snapshot = getMutationState();\r\n  const detail = {\r\n    ...snapshot,\r\n    slot: mutationState.slot ?? getActiveSlot(),\r\n    changeType: reason,\r\n    ...extraDetail,\r\n  };\r\n\r\n  listeners.forEach((cb) => {\r\n    try { cb(snapshot, reason); } catch {}\r\n  });\r\n\r\n  if (typeof window !== 'undefined') {\r\n    try { window.dispatchEvent(new CustomEvent('mutation:change', { detail })); } catch {}\r\n  }\r\n\r\n  return detail;\r\n}\r\n\r\nfunction persistState() {\r\n  let slot = mutationState.slot;\r\n  if (slot == null) {\r\n    slot = getActiveSlot();\r\n    if (slot != null) {\r\n      mutationState.slot = slot;\r\n    }\r\n  }\r\n  if (slot == null) return;\r\n  try { localStorage.setItem(KEY_UNLOCK(slot), mutationState.unlocked ? '1' : '0'); }\r\n  catch {}\r\n  try { localStorage.setItem(KEY_LEVEL(slot), mutationState.level.toStorage()); }\r\n  catch {}\r\n  try { localStorage.setItem(KEY_PROGRESS(slot), mutationState.progress.toStorage()); }\r\n  catch {}\r\n  primeStorageWatcherSnapshot(KEY_UNLOCK(slot));\r\n  primeStorageWatcherSnapshot(KEY_LEVEL(slot));\r\n  primeStorageWatcherSnapshot(KEY_PROGRESS(slot));\r\n\r\n  // If storage writes are being blocked (e.g., via the Debug Panel lock toggle),\r\n  // fall back to the persisted values so in-memory state doesn't keep drifting\r\n  // away from the locked snapshot during gameplay.\r\n  const persisted = (() => {\r\n    let unlocked = mutationState.unlocked;\r\n    let level = mutationState.level;\r\n    let progress = mutationState.progress;\r\n    try { unlocked = localStorage.getItem(KEY_UNLOCK(slot)) === '1'; }\r\n    catch {}\r\n    try {\r\n      const rawLevel = localStorage.getItem(KEY_LEVEL(slot));\r\n      if (rawLevel) level = BN.fromAny(rawLevel);\r\n    } catch {}\r\n    try {\r\n      const rawProgress = localStorage.getItem(KEY_PROGRESS(slot));\r\n      if (rawProgress) progress = BN.fromAny(rawProgress);\r\n    } catch {}\r\n    return { unlocked, level, progress };\r\n  })();\r\n\r\n  const persistedLevelRaw = toStorageSafe(persisted.level);\r\n  const persistedProgressRaw = toStorageSafe(persisted.progress);\r\n  const expectedLevelRaw = toStorageSafe(mutationState.level);\r\n  const expectedProgressRaw = toStorageSafe(mutationState.progress);\r\n\r\n  const unlockMismatch = persisted.unlocked !== mutationState.unlocked;\r\n  const levelMismatch = persistedLevelRaw != null && expectedLevelRaw != null && persistedLevelRaw !== expectedLevelRaw;\r\n  const progressMismatch = persistedProgressRaw != null && expectedProgressRaw != null && persistedProgressRaw !== expectedProgressRaw;\r\n\r\n  if (unlockMismatch || levelMismatch || progressMismatch) {\r\n    applyState(persisted, { skipPersist: true });\r\n  }\r\n}\r\n\r\nfunction normalizeProgress() {\r\n  if (!mutationState.unlocked) return;\r\n\r\n  ensureRequirement();\r\n  let currentReq = mutationState.requirement;\r\n  if (!currentReq || typeof currentReq !== 'object') return;\r\n\r\n  // If the requirement is infinite, you can keep stacking MP forever,\r\n  // but you'll never spend it to gain more levels.\r\n  if (currentReq.isInfinite?.()) {\r\n    return;\r\n  }\r\n\r\n  let guard = 0;\r\n  const limit = 100000;\r\n\r\n  while (mutationState.progress.cmp?.(currentReq) >= 0 && guard < limit) {\r\n    // Spend MP to gain a level\r\n    mutationState.progress = mutationState.progress.sub(currentReq);\r\n    mutationState.level = mutationState.level.add(bnOne());\r\n\r\n    // Recompute requirement for the new level\r\n    ensureRequirement();\r\n    currentReq = mutationState.requirement;\r\n\r\n    if (!currentReq || typeof currentReq !== 'object') {\r\n      mutationState.progress = bnZero();\r\n      break;\r\n    }\r\n\r\n    // If the requirement becomes infinite while levelling up,\r\n    // stop levelling, but KEEP the leftover progress instead of nuking it.\r\n    if (currentReq.isInfinite?.()) {\r\n      break;\r\n    }\r\n\r\n    guard += 1;\r\n  }\r\n\r\n  // Safety: if we somehow loop too much, just bail and zero progress\r\n  if (guard >= limit) {\r\n    mutationState.progress = bnZero();\r\n  }\r\n}\r\n\r\nfunction applyState(newState, { skipPersist = false } = {}) {\r\n  mutationState.unlocked = !!newState.unlocked;\r\n  mutationState.level = cloneBigNum(newState.level);\r\n  mutationState.progress = cloneBigNum(newState.progress);\r\n  if (!mutationState.unlocked) {\r\n    mutationState.level = bnZero();\r\n    mutationState.progress = bnZero();\r\n  }\r\n  ensureRequirement();\r\n  if (!skipPersist) persistState();\r\n  updateHud();\r\n  emitChange('load');\r\n  scheduleCoinMultiplierRefresh();\r\n}\r\n\r\nfunction readStateFromStorage(slot) {\r\n  const targetSlot = slot ?? getActiveSlot();\r\n  if (targetSlot == null) {\r\n    applyState({ unlocked: false, level: bnZero(), progress: bnZero() }, { skipPersist: true });\r\n    mutationState.slot = null;\r\n    return;\r\n  }\r\n  let unlocked = false;\r\n  let level = bnZero();\r\n  let progress = bnZero();\r\n  try { unlocked = localStorage.getItem(KEY_UNLOCK(targetSlot)) === '1'; }\r\n  catch {}\r\n  try {\r\n    const rawLvl = localStorage.getItem(KEY_LEVEL(targetSlot));\r\n    if (rawLvl) level = BN.fromAny(rawLvl);\r\n  } catch {}\r\n  try {\r\n    const rawProg = localStorage.getItem(KEY_PROGRESS(targetSlot));\r\n    if (rawProg) progress = BN.fromAny(rawProg);\r\n  } catch {}\r\n  applyState({ unlocked, level, progress }, { skipPersist: true });\r\n  mutationState.slot = targetSlot;\r\n}\r\n\r\nfunction cleanupWatchers() {\r\n  while (watcherCleanups.length) {\r\n    const stop = watcherCleanups.pop();\r\n    try { stop?.(); } catch {}\r\n  }\r\n}\r\n\r\nfunction bindStorageWatchers(slot) {\r\n  if (watchersBoundSlot === slot) return;\r\n  cleanupWatchers();\r\n  watchersBoundSlot = slot;\r\n  if (slot == null) return;\r\n  watcherCleanups.push(watchStorageKey(KEY_UNLOCK(slot), {\r\n    onChange(value) {\r\n      const nextUnlocked = value === '1';\r\n      if (mutationState.unlocked !== nextUnlocked) {\r\n        mutationState.unlocked = nextUnlocked;\r\n        if (!nextUnlocked) {\r\n          mutationState.level = bnZero();\r\n          mutationState.progress = bnZero();\r\n        }\r\n        ensureRequirement();\r\n        updateHud();\r\n        emitChange('storage');\r\n        scheduleCoinMultiplierRefresh();\r\n      }\r\n    },\r\n  }));\r\n  watcherCleanups.push(watchStorageKey(KEY_LEVEL(slot), {\r\n    onChange(value) {\r\n      if (!value) return;\r\n      try {\r\n        const next = BN.fromAny(value);\r\n        if (mutationState.level.cmp?.(next) !== 0) {\r\n          mutationState.level = next;\r\n          ensureRequirement();\r\n          updateHud();\r\n          emitChange('storage');\r\n          scheduleCoinMultiplierRefresh();\r\n        }\r\n      } catch {}\r\n    },\r\n  }));\r\n  watcherCleanups.push(watchStorageKey(KEY_PROGRESS(slot), {\r\n    onChange(value) {\r\n      if (!value) return;\r\n      try {\r\n        const next = BN.fromAny(value);\r\n        if (mutationState.progress.cmp?.(next) !== 0) {\r\n          mutationState.progress = next;\r\n          ensureRequirement();\r\n          updateHud();\r\n          emitChange('storage');\r\n        }\r\n      } catch {}\r\n    },\r\n  }));\r\n}\r\n\r\nexport function initMutationSystem({ forceReload = false } = {}) {\r\n  ensureExternalMultiplierProviders();\r\n  if (initialized) {\r\n    const activeSlot = getActiveSlot();\r\n    const slotChanged = activeSlot !== mutationState.slot;\r\n    if (slotChanged || forceReload) {\r\n      readStateFromStorage(activeSlot);\r\n    }\r\n    bindStorageWatchers(activeSlot);\r\n    ensureHudRefs();\r\n    updateHud();\r\n    return getMutationState();\r\n  }\r\n  initialized = true;\r\n  ensureHudRefs();\r\n  const slot = getActiveSlot();\r\n  mutationState.slot = slot;\r\n  readStateFromStorage(slot);\r\n  bindStorageWatchers(slot);\r\n  updateHud();\r\n  scheduleCoinMultiplierRefresh();\r\n  if (typeof window !== 'undefined') {\r\n    window.addEventListener('saveSlot:change', () => {\r\n      const nextSlot = getActiveSlot();\r\n      mutationState.slot = nextSlot;\r\n      readStateFromStorage(nextSlot);\r\n      bindStorageWatchers(nextSlot);\r\n      updateHud();\r\n      scheduleCoinMultiplierRefresh();\r\n      emitChange('slot');\r\n    });\r\n  }\r\n  return getMutationState();\r\n}\r\n\r\nexport function getMutationState() {\r\n  return {\r\n    unlocked: mutationState.unlocked,\r\n    level: cloneBigNum(mutationState.level),\r\n    progress: cloneBigNum(mutationState.progress),\r\n    requirement: cloneBigNum(mutationState.requirement),\r\n  };\r\n}\r\n\r\nexport function isMutationUnlocked() {\r\n  return !!mutationState.unlocked;\r\n}\r\n\r\nexport function unlockMutationSystem() {\r\n  initMutationSystem();\r\n  if (mutationState.unlocked) return false;\r\n  mutationState.unlocked = true;\r\n  ensureRequirement();\r\n  persistState();\r\n  updateHud();\r\n  emitChange('unlock');\r\n  scheduleCoinMultiplierRefresh();\r\n  return true;\r\n}\r\n\r\nexport function setMutationUnlockedForDebug(unlocked) {\r\n  initMutationSystem();\r\n  const nextUnlocked = !!unlocked;\r\n  applyState({\r\n    unlocked: nextUnlocked,\r\n    level: nextUnlocked ? mutationState.level : bnZero(),\r\n    progress: nextUnlocked ? mutationState.progress : bnZero(),\r\n  });\r\n}\r\n\r\nexport function addMutationPower(amount) {\r\n  initMutationSystem();\r\n  if (!mutationState.unlocked) return getMutationState();\r\n\r\n  if (mutationState.level && mutationState.level.isInfinite?.()) {\r\n    if (!mutationState.progress?.isInfinite?.()) {\r\n      try { mutationState.progress = BN.fromAny('Infinity'); } catch {}\r\n    }\r\n    if (!mutationState.requirement?.isInfinite?.()) {\r\n      try { mutationState.requirement = BN.fromAny('Infinity'); } catch {}\r\n    }\r\n    return getMutationState();\r\n  }\r\n\r\n  let inc;\r\n  try {\r\n    inc = amount instanceof BN ? amount : BN.fromAny(amount ?? 0);\r\n  } catch {\r\n    inc = bnZero();\r\n  }\r\n\r\n  inc = applyStatMultiplierOverride('mutation', inc);\r\n\r\n  if (inc.isZero?.()) return getMutationState();\r\n\r\n  const incClone = inc.clone?.() ?? inc;\r\n  const prevLevel = mutationState.level.clone?.() ?? mutationState.level;\r\n  const prevProgress = mutationState.progress.clone?.() ?? mutationState.progress;\r\n\r\n  // Add MP\r\n  mutationState.progress = mutationState.progress.add(incClone);\r\n\r\n  // If MP overflows to BigNum Infinity, treat that as reaching mutation Infinity.\r\n  const progInf = mutationState.progress.isInfinite?.();\r\n  if (progInf) {\r\n    try {\r\n      mutationState.level = BN.fromAny('Infinity');\r\n    } catch {}\r\n\r\n    // Keep progress locked at Infinity once we reach mutation \u221E\r\n    try {\r\n      mutationState.progress = BN.fromAny('Infinity');\r\n    } catch {\r\n      mutationState.progress = bnZero();\r\n    }\r\n\r\n    try {\r\n      mutationState.requirement = BN.fromAny('Infinity');\r\n    } catch {}\r\n  } else {\r\n    // Normal levelling logic (now friendly to \u221E requirements)\r\n    normalizeProgress();\r\n  }\r\n\r\n  persistState();\r\n  updateHud();\r\n\r\n  const levelsGained = mutationState.level.sub(prevLevel);\r\n  if (!levelsGained.isZero?.()) {\r\n    scheduleCoinMultiplierRefresh();\r\n  }\r\n\r\n  const detail = emitChange('progress', {\r\n    delta: incClone.clone?.() ?? incClone,\r\n    levelsGained: levelsGained.clone?.() ?? levelsGained,\r\n    level: mutationState.level.clone?.() ?? mutationState.level,\r\n    progress: mutationState.progress.clone?.() ?? mutationState.progress,\r\n    requirement: mutationState.requirement.clone?.() ?? mutationState.requirement,\r\n    previousLevel: prevLevel.clone?.() ?? prevLevel,\r\n    previousProgress: prevProgress.clone?.() ?? prevProgress,\r\n  });\r\n\r\n  return detail;\r\n}\r\n\r\nexport function broadcastMutationChange(detailOverrides = {}) {\r\n  initMutationSystem();\r\n  const reason = detailOverrides.changeType ?? 'manual';\r\n  return emitChange(reason, detailOverrides);\r\n}\r\n\r\nexport function computeMutationMultiplierForLevel(levelValue) {\r\n  let levelBn;\r\n  if (levelValue instanceof BN) {\r\n    try { levelBn = levelValue.clone?.() ?? levelValue; }\r\n    catch { levelBn = bnZero(); }\r\n  } else if (typeof levelValue === 'bigint') {\r\n    try { levelBn = BigNum.fromAny(levelValue.toString()); }\r\n    catch { levelBn = bnZero(); }\r\n  } else {\r\n    try { levelBn = BigNum.fromAny(levelValue ?? 0); }\r\n    catch { levelBn = bnZero(); }\r\n  }\r\n\r\n  // If the stored mutation level itself is infinite, every multiplier that\r\n  // depends on it becomes infinite as well.\r\n  if (levelBn && levelBn.isInfinite?.()) {\r\n    try { return BN.fromAny('Infinity'); }\r\n    catch { return bnOne(); }\r\n  }\r\n\r\n  const levelNum = levelToNumber(levelBn);\r\n\r\n  // If levelToNumber can't represent this cleanly (NaN / Infinity), also\r\n  // treat that as infinite multiplier.\r\n  if (!Number.isFinite(levelNum)) {\r\n    try { return BN.fromAny('Infinity'); }\r\n    catch { return bnOne(); }\r\n  }\r\n\r\n  if (levelNum <= 0) return bnOne();\r\n\r\n  const log10 = levelNum * MP_LOG10_BASE;\r\n  return bigNumFromLog10(log10);\r\n}\r\n\r\nexport function computeMutationRequirementForLevel(levelValue) {\r\n  let levelBn;\r\n  try { levelBn = levelValue instanceof BN ? levelValue : BN.fromAny(levelValue ?? 0); }\r\n  catch { levelBn = bnZero(); }\r\n  try { return computeRequirement(levelBn); }\r\n  catch { return bnZero(); }\r\n}\r\n\r\nexport function getMutationMultiplier() {\r\n  initMutationSystem();\r\n  if (!mutationState.unlocked) return bnOne();\r\n  try { return computeMutationMultiplierForLevel(mutationState.level); }\r\n  catch { return bnOne(); }\r\n}\r\n\r\nexport function getMutationCoinSprite() {\r\n  if (!mutationState.unlocked || mutationState.level.isZero?.()) {\r\n    return 'img/currencies/coin/coin.png';\r\n  }\r\n\r\n  const levelNum = levelToNumber(mutationState.level);\r\n  if (!Number.isFinite(levelNum)) {\r\n    return 'img/mutations/m25.png';\r\n  }\r\n  const idx = Math.max(1, Math.min(25, Math.floor(levelNum)));\r\n\r\n  return `img/mutations/m${idx}.png`;\r\n}\r\n\r\n\r\nexport function onMutationChange(callback) {\r\n  if (typeof callback !== 'function') return () => {};\r\n  listeners.add(callback);\r\n  return () => { listeners.delete(callback); };\r\n}\r\n\r\nif (typeof window !== 'undefined') {\r\n  window.mutationSystem = window.mutationSystem || {};\r\n  Object.assign(window.mutationSystem, {\r\n    initMutationSystem,\r\n    unlockMutationSystem,\r\n    addMutationPower,\r\n    getMutationState,\r\n    getMutationMultiplier,\r\n    isMutationUnlocked,\r\n  });\r\n}\r\n", "// spawner.js\r\n\r\nimport { takePreloadedAudio } from '../util/audioCache.js';\r\nimport { getMutationState, onMutationChange } from './mutationSystem.js';\r\nimport { IS_MOBILE } from '../main.js';\r\n\r\nlet mutationUnlockedSnapshot = false;\r\nlet mutationLevelSnapshot = 0n;\r\n\r\nfunction updateMutationSnapshot(state) {\r\n  if (!state || typeof state !== 'object') {\r\n    mutationUnlockedSnapshot = false;\r\n    mutationLevelSnapshot = 0n;\r\n    return;\r\n  }\r\n  mutationUnlockedSnapshot = !!state.unlocked;\r\n  try {\r\n    const level = state.level;\r\n    const plain = typeof level?.toPlainIntegerString === 'function'\r\n      ? level.toPlainIntegerString()\r\n      : null;\r\n    mutationLevelSnapshot = plain && plain !== 'Infinity' ? BigInt(plain) : 0n;\r\n  } catch {\r\n    mutationLevelSnapshot = 0n;\r\n  }\r\n}\r\n\r\ntry {\r\n  updateMutationSnapshot(getMutationState());\r\n} catch {\r\n  mutationUnlockedSnapshot = false;\r\n  mutationLevelSnapshot = 0n;\r\n}\r\n\r\ntry {\r\n  onMutationChange((snapshot) => { updateMutationSnapshot(snapshot); });\r\n} catch {}\r\n\r\nexport function createSpawner({\r\n    playfieldSelector = '.area-cove .playfield',\r\n    waterSelector = '.water-base',\r\n    surgesHost = '.surges',\r\n    coinsHost = '.coins-layer',\r\n    coinSrc = 'img/coin/coin.png',\r\n    coinSize = 40,\r\n    animationName = 'coin-from-wave',\r\n    animationDurationMs = 1500,\r\n    surgeLifetimeMs = 1400,\r\n    surgeWidthVw = 22,\r\n    coinsPerSecond = 1,\r\n    perFrameBudget = 24,\r\n    backlogCap = 600,\r\n    maxActiveCoins = 1500,\r\n    initialBurst = 1,\r\n\tcoinTtlMs = 60000,\r\n\twaveSoundSrc = 'sounds/wave_spawn.mp3',\r\n    waveSoundDesktopVolume = 0.40,\r\n    waveSoundMobileVolume  = 0.16,\r\n    waveSoundMinIntervalMs = 160,\r\n    enableDropShadow = false,\r\n} = {}) {\r\n\r\n    let currentCoinSrc = coinSrc;\r\n    const isTouch = window.matchMedia('(hover: none) and (pointer: coarse)').matches;\r\n\tconst MOBILE_BACKLOG_CAP = 50;\r\n\tlet burstUntil = 0;\r\n\r\n\tconst BURST_WINDOW_MS        = 120;\r\n\tconst BURST_TIME_BUDGET_MS   = 10.0;\r\n\tconst BURST_HARD_CAP         = 400;\r\n\tconst ONE_SHOT_THRESHOLD     = 180;\r\n\tconst NORMAL_TIME_BUDGET_MS  = 2.0;\r\n\r\n\r\n    // ---------- resolve and keep DOM references ----------\r\n    const refs = {\r\n        pf: document.querySelector(playfieldSelector),\r\n        w: document.querySelector(waterSelector),\r\n        s: document.querySelector(surgesHost),\r\n        c: document.querySelector(coinsHost),\r\n        hud: document.getElementById('hud-bottom'),\r\n    };\r\n\r\n    function validRefs() {\r\n        return !!(refs.pf && refs.w && refs.s && refs.c);\r\n    }\r\n\r\n    if (!validRefs()) {\r\n        console.warn('[Spawner] Missing required nodes. Check your selectors:', {\r\n            playfieldSelector,\r\n            waterSelector,\r\n            surgesHost,\r\n            coinsHost\r\n        });\r\n    }\r\n\r\n    // ---------- cached layout metrics (refreshed on resize/visibility) ----------\r\n    let M = {\r\n        pfRect: null,\r\n        wRect: null,\r\n        safeBottom: 0,\r\n        pfW: 0\r\n    };\r\n\r\n    function computeMetrics() {\r\n        if (!validRefs())\r\n            return false;\r\n        const pfRect = refs.pf.getBoundingClientRect();\r\n        const wRect = refs.w.getBoundingClientRect();\r\n        const hudH = refs.hud ? refs.hud.getBoundingClientRect().height : 0;\r\n\r\n        M = {\r\n            pfRect,\r\n            wRect,\r\n            safeBottom: pfRect.height - hudH,\r\n            pfW: pfRect.width\r\n        };\r\n        return true;\r\n    }\r\n\r\n    computeMetrics();\r\n\r\n    const ro = 'ResizeObserver' in window ? new ResizeObserver(() => computeMetrics()) : null;\r\n    if (ro && refs.pf)\r\n        ro.observe(refs.pf);\r\n    document.addEventListener('visibilitychange', () => {\r\n        if (!document.hidden)\r\n            computeMetrics();\r\n    });\r\n\r\n    // ---------- small utilities ----------\r\n    const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));\r\n\r\n    // ---------- pools ----------\r\n    const COIN_POOL_MAX = Math.max(2000, maxActiveCoins * 3);\r\n    const SURGE_POOL_MAX = 800;\r\n    const COIN_MARGIN = 12;\r\n\r\n    const coinPool = [];\r\n    const surgePool = [];\r\n\r\n    function makeCoin() {\r\n        const el = document.createElement('div');\r\n        el.className = 'coin';\r\n        el.style.position = 'absolute';\r\n        el.style.width = `${coinSize}px`;\r\n        el.style.height = `${coinSize}px`;\r\n        el.style.background = `url(${currentCoinSrc}) center/contain no-repeat`;\r\n        el.style.borderRadius = '50%';\r\n        el.style.pointerEvents = 'none';\r\n        el.style.willChange = 'transform, opacity';\r\n        el.style.contain = 'layout paint style size';\r\n        if (enableDropShadow)\r\n            el.style.filter = 'drop-shadow(0 2px 2px rgba(0,0,0,.35))';\r\n        return el;\r\n    }\r\n    const getCoin = () => (coinPool.length ? coinPool.pop() : makeCoin());\r\n     function releaseCoin(el) {\r\n   el.style.animation = 'none';\r\n   el.style.transform = '';\r\n   el.style.opacity = '1';\r\n    delete el.dataset.dieAt;\r\n    delete el.dataset.jitter;\r\n    delete el.dataset.collected;\r\n\r\n   if (el.parentNode)\r\n     el.remove();\r\n   if (coinPool.length < COIN_POOL_MAX)\r\n     coinPool.push(el);\r\n }\r\n\r\n    function makeSurge() {\r\n        const el = document.createElement('div');\r\n        el.className = 'wave-surge';\r\n        el.style.willChange = 'transform, opacity';\r\n        return el;\r\n    }\r\n    const getSurge = () => (surgePool.length ? surgePool.pop() : makeSurge());\r\n    function releaseSurge(el) {\r\n        el.classList.remove('run');\r\n        if (el.parentNode)\r\n            el.remove();\r\n        if (surgePool.length < SURGE_POOL_MAX)\r\n            surgePool.push(el);\r\n    }\r\n\t\r\n\t  // ---- Wave spawn SFX ----\r\nconst waveURL = new URL(waveSoundSrc, document.baseURI).href;\r\nlet waveHtmlEl = null;       // single HTMLAudio element for mobile fallback\r\nlet waveHtmlSource = null;   // MediaElementSourceNode connected to WA gain\r\n\r\nlet waveLastAt = 0;\r\n// Desktop/mobile-aware HTMLAudio play \u2014 on mobile, pipe through WebAudio gain\r\nlet wavePool = null, waveIdx = 0;\r\n\r\nfunction ensureWavePool() {\r\n  if (wavePool)\r\n    return wavePool;\r\n\r\n  const preloaded = takePreloadedAudio(waveSoundSrc);\r\n  const poolSize = 4;\r\n  wavePool = Array.from({ length: poolSize }, (_, idx) => {\r\n    if (idx === 0 && preloaded) {\r\n      preloaded.preload = 'auto';\r\n      try { preloaded.currentTime = 0; } catch (_) {}\r\n      preloaded.volume = 1;\r\n      return preloaded;\r\n    }\r\n    const a = new Audio(waveURL);\r\n    a.preload = 'auto';\r\n    a.load?.();\r\n    return a;\r\n  });\r\n\r\n  if (preloaded) {\r\n    for (let i = 1; i < wavePool.length; i++) {\r\n      wavePool[i].load?.();\r\n    }\r\n  }\r\n\r\n  return wavePool;\r\n}\r\n\r\nfunction playWaveHtmlVolume(vol) {\r\n  if (IS_MOBILE) {\r\n    try {\r\n      // Ensure WA context & gain (uses your mobile volume)\r\n      ac = ac || new (window.AudioContext || window.webkitAudioContext)();\r\n      if (ac.state === 'suspended') ac.resume();\r\n      gain = gain || ac.createGain();\r\n      gain.gain.value = waveSoundMobileVolume;\r\n      gain.connect(ac.destination);\r\n\r\n      // Reuse one <audio> element and feed it into WA (so gain controls loudness)\r\n      if (!waveHtmlEl) {\r\n        waveHtmlEl = new Audio(waveURL);\r\n        waveHtmlEl.preload = 'auto';\r\n        waveHtmlEl.playsInline = true;\r\n        waveHtmlEl.crossOrigin = 'anonymous';\r\n      }\r\n      if (!waveHtmlSource) {\r\n        waveHtmlSource = ac.createMediaElementSource(waveHtmlEl);\r\n        waveHtmlSource.connect(gain);\r\n      }\r\n\r\n      waveHtmlEl.muted = false;   // final volume is controlled by WA gain\r\n      waveHtmlEl.volume = 1.0;    // keep element at 1.0; WA gain applies mobile volume\r\n      waveHtmlEl.currentTime = 0;\r\n      waveHtmlEl.play().catch(() => {});\r\n      return; // \u2190 mobile path handled here\r\n    } catch (e) {\r\n      // If WA couldn\u2019t initialize (very rare after a gesture), avoid a loud blast:\r\n      try { const a = new Audio(waveURL); a.muted = true; a.play().catch(() => {}); } catch {}\r\n      return;\r\n    }\r\n  }\r\n\r\n  const pool = ensureWavePool();\r\n  const a = pool[waveIdx++ % pool.length];\r\n  a.volume = vol;\r\n  try { a.currentTime = 0; a.play(); } catch {}\r\n}\r\n\r\n// Mobile: WebAudio (with HTML fallback if WA isn\u2019t ready)\r\nlet ac = null, gain = null, waveBuf = null, waveLoading = false;\r\nasync function ensureWaveWA() {\r\n  if (waveBuf || waveLoading) return;\r\n  waveLoading = true;\r\n  try {\r\n    ac = ac || new (window.AudioContext || window.webkitAudioContext)();\r\n    gain = gain || ac.createGain();\r\n    gain.gain.value = waveSoundMobileVolume;   // <-- mobile gain\r\n    gain.connect(ac.destination);\r\n\r\n    const res = await fetch(waveURL, { cache: 'force-cache' });\r\n    const arr = await res.arrayBuffer();\r\n    waveBuf = await new Promise((ok, err) =>\r\n      ac.decodeAudioData ? ac.decodeAudioData(arr, ok, err) : ok(null)\r\n    );\r\n    if (ac.state === 'suspended') { try { await ac.resume(); } catch {} }\r\n  } catch (_) {} finally { waveLoading = false; }\r\n}\r\n\r\nfunction playWaveMobile() {\r\n  try { if (ac && ac.state === 'suspended') ac.resume(); } catch {}\r\n  if (waveBuf && ac && gain) {\r\n    try {\r\n      const src = ac.createBufferSource();\r\n      src.buffer = waveBuf;\r\n      src.connect(gain);\r\n      src.start();\r\n      return;\r\n    } catch {}\r\n  }\r\n  // WA not ready yet \u2192 use HTML fallback at MOBILE volume (fix for \"first wave too loud\")\r\n  playWaveHtmlVolume(waveSoundMobileVolume);\r\n  ensureWaveWA();\r\n}\r\n\r\n// Gesture warm (iOS Safari)\r\nconst warmWave = () => { if (IS_MOBILE) ensureWaveWA(); };\r\n['pointerdown','touchstart'].forEach(evt =>\r\n  window.addEventListener(evt, warmWave, { once: true, passive: true, capture: true })\r\n);\r\n\r\nensureWavePool();\r\n\r\ndocument.addEventListener('visibilitychange', () => {\r\n  if (!document.hidden && IS_MOBILE && ac && ac.state === 'suspended') {\r\n    try { ac.resume(); } catch {}\r\n  }\r\n});\r\n\r\nfunction playWaveOncePerBurst() {\r\n  const now = performance.now();\r\n  if (now - waveLastAt < waveSoundMinIntervalMs) return; // rate-limit\r\n  waveLastAt = now;\r\n  if (IS_MOBILE) playWaveMobile();\r\n  else          playWaveHtmlVolume(waveSoundDesktopVolume);\r\n}\r\n\r\n\r\n\r\n    // ---------- spawn planning ----------\r\n    function planCoinFromWave(wave) {\r\n        if (!wave) return null;\r\n        const { x: waveX, y: waveTop, w: waveW } = wave;\r\n\r\n        const crestCenter = waveX + waveW / 2 + (Math.random() * 60 - 30);\r\n        const startX = crestCenter - coinSize / 2;\r\n        const startY = waveTop + 10 - coinSize / 2;\r\n\r\n        const drift = Math.random() * 100 - 50;\r\n        const endX = clamp(startX + drift, COIN_MARGIN, M.pfW - coinSize - COIN_MARGIN);\r\n        const minY = Math.max(M.wRect.height + 80, 120);\r\n        const maxY = Math.max(minY + 40, M.safeBottom - coinSize - 6);\r\n        const endY = clamp(minY + Math.random() * (maxY - minY), minY, maxY);\r\n\r\n        const midX = startX + (endX - startX) * 0.66;\r\n        const jitterMs = Math.random() * 100;\r\n\r\n        return {\r\n            x0: startX,\r\n            y0: startY,\r\n            xMid: midX,\r\n            y1: endY,\r\n            x1: endX,\r\n            jitterMs,\r\n        };\r\n    }\r\n\r\n    function planSpawn() {\r\n        if (!validRefs())\r\n            return null;\r\n        if (!M.pfRect || !M.wRect)\r\n            computeMetrics();\r\n\r\n        if (maxActiveCoins !== Infinity && refs.c.childElementCount >= maxActiveCoins) {\r\n            const oldest = refs.c.firstElementChild;\r\n            if (oldest)\r\n                releaseCoin(oldest);\r\n        }\r\n\r\n        const pfW = M.pfW;\r\n        const waveW = clamp(pfW * (surgeWidthVw / 100), 220, 520);\r\n        const leftMax = Math.max(1, pfW - waveW - COIN_MARGIN * 2);\r\n        const waveX = Math.random() * leftMax + COIN_MARGIN;\r\n\r\n        const waterToPfTop = M.wRect.top - M.pfRect.top;\r\n        const waveTop = Math.max(0, waterToPfTop + M.wRect.height * 0.05);\r\n\r\n        const wave = {\r\n            x: waveX,\r\n            y: waveTop,\r\n            w: waveW\r\n        };\r\n\r\n        const coinPlan = planCoinFromWave(wave);\r\n        if (!coinPlan) return null;\r\n\r\n    return {\r\n        wave,\r\n        coin: coinPlan\r\n    };\r\n}\r\n\r\nfunction commitBatch(batch) {\r\n  if (!batch.length || !validRefs()) return;\r\n\r\n  const wavesFrag = document.createDocumentFragment();\r\n  const coinsFrag = document.createDocumentFragment();\r\n  const newCoins = [];\r\n  const newSurges = [];\r\n\r\n  for (const { wave, coin } of batch) {\r\n    if (wave) {\r\n      const surge = getSurge();\r\n      surge.style.left = `${wave.x}px`;\r\n      surge.style.top = `${wave.y}px`;\r\n      surge.style.width = `${wave.w}px`;\r\n      wavesFrag.appendChild(surge);\r\n      newSurges.push(surge);\r\n    }\r\n\r\n    const el = getCoin();\r\n    el.style.background = `url(${currentCoinSrc}) center/contain no-repeat`;\r\n    el.style.setProperty('--x0', `${coin.x0}px`);\r\n    el.style.setProperty('--y0', `${coin.y0}px`);\r\n    el.style.setProperty('--xmid', `${coin.xMid}px`);\r\n    el.style.setProperty('--y1', `${coin.y1}px`);\r\n    el.style.setProperty('--x1', `${coin.x1}px`);\r\n    el.style.transform = `translate3d(${coin.x0}px, ${coin.y0}px, 0)`;\r\n    el.dataset.jitter = String(coin.jitterMs);\r\n    const animMs = Number(coin.durationMs);\r\n    if (Number.isFinite(animMs) && animMs > 0) {\r\n      el.dataset.animMs = String(Math.max(300, animMs));\r\n    } else if (el.dataset.animMs) {\r\n      delete el.dataset.animMs;\r\n    }\r\n    el.dataset.dieAt = String(performance.now() + coinTtlMs);\r\n    if (mutationUnlockedSnapshot) {\r\n      el.dataset.mutationLevel = mutationLevelSnapshot.toString();\r\n    } else {\r\n      el.dataset.mutationLevel = '0';\r\n    }\r\n\r\n    coinsFrag.appendChild(el);\r\n    newCoins.push(el);\r\n  }\r\n\r\n  refs.s.appendChild(wavesFrag);\r\n  refs.c.appendChild(coinsFrag);\r\n\r\n  requestAnimationFrame(() => {\r\n    if (newSurges.length) playWaveOncePerBurst();\r\n\r\n    for (const surge of newSurges) {\r\n      surge.classList.remove('run');\r\n      void surge.offsetWidth;\r\n      surge.classList.add('run');\r\n      const onEnd = (e) => {\r\n        if (e.target === surge) releaseSurge(surge);\r\n      };\r\n      surge.addEventListener('animationend', onEnd, { once: true });\r\n    }\r\n      for (const el of newCoins) {\r\n        const jitter = Number(el.dataset.jitter) || 0;\r\n        const animMs = Number(el.dataset.animMs);\r\n        const duration = Number.isFinite(animMs) && animMs > 0 ? Math.max(300, animMs) : animationDurationMs;\r\n        el.style.animation = 'none';\r\n        void el.offsetWidth;\r\n        el.style.animation = `${animationName} ${duration}ms ease-out ${jitter}ms 1 both`;\r\n      }\r\n  });\r\n}\r\n\r\n    function spawnBurst(n = 1) {\r\n        if (!validRefs())\r\n            return;\r\n        if (!M.pfRect || !M.wRect)\r\n            computeMetrics();\r\n        const batch = [];\r\n        for (let i = 0; i < n; i++) {\r\n            const plan = planSpawn();\r\n            if (plan) {\r\n                batch.push(plan);\r\n            }\r\n        }\r\n        if (batch.length)\r\n            commitBatch(batch);\r\n    }\r\n\r\n    // ---------- RAF loop with accumulator + micro-batching + backpressure ----------\r\n    let rate = coinsPerSecond;\r\n    let rafId = null;\r\n    let last = performance.now();\r\n    let carry = 0; // fractional coins\r\n    let queued = 0; // whole coins awaiting spawn\r\n\tlet ttlCursor = null;\r\n\tconst ttlChecksPerFrame = 200;\r\n\r\n   function loop(now) {\r\n  if (!M.pfRect || !M.wRect) computeMetrics();\r\n\r\n  const dt = (now - last) / 1000;  // keep backlog intact on resume\r\n  last = now;\r\n\r\n  // ---- TTL cleanup (pool-friendly) ----\r\n  {\r\n    let checked = 0;\r\n    let node = ttlCursor || (refs.c && refs.c.firstElementChild);\r\n    while (node && checked < ttlChecksPerFrame) {\r\n      const next = node.nextElementSibling;\r\n      const dieAt = Number((node.dataset && node.dataset.dieAt) || 0);\r\n      if (dieAt && now >= dieAt) {\r\n        releaseCoin(node);\r\n      }\r\n      node = next;\r\n      checked++;\r\n    }\r\n    ttlCursor = node || null;\r\n  }\r\n\r\n  // ---- Backlog accumulation (mobile cap = 100) ----\r\n  carry += rate * dt;\r\n  const due = carry | 0;\r\n const cap = isTouch ? MOBILE_BACKLOG_CAP : backlogCap;\r\n\r\n  // keep any existing queued clamped to the active cap\r\n  if (queued > cap) queued = cap;\r\n\r\nif (due > 0) {\r\n  queued = Math.min(cap, queued + due);\r\n  carry -= due;\r\n}\r\n\r\n\r\n  // ---- Spawn targets & time budgets ----\r\n  let spawnTarget = Math.min(queued, perFrameBudget);\r\n  let timeBudgetMs = NORMAL_TIME_BUDGET_MS;\r\n\r\n  // Mobile burst window: make it feel \"all at once\" but cap work per frame\r\n  if (isTouch && now < burstUntil && queued > 0) {\r\n    // If backlog is modest, allow a one-shot flush (within a higher time budget)\r\n    if (queued <= ONE_SHOT_THRESHOLD) {\r\n      spawnTarget  = queued;\r\n      timeBudgetMs = BURST_TIME_BUDGET_MS;\r\n    } else {\r\n      // Large backlog: aggressive but capped\r\n      spawnTarget  = Math.min(queued, BURST_HARD_CAP);\r\n      timeBudgetMs = BURST_TIME_BUDGET_MS;\r\n    }\r\n  }\r\n\r\n  // ---- Build batch under time budget ----\r\n  if (spawnTarget > 0) {\r\n    const t0 = performance.now();\r\n    const batch = [];\r\n    let baseSpawned = 0;\r\n    for (let i = 0; i < spawnTarget; i++) {\r\n      if (performance.now() - t0 > timeBudgetMs) break;\r\n      const plan = planSpawn();\r\n      if (plan) {\r\n        batch.push(plan);\r\n        baseSpawned += 1;\r\n      }\r\n    }\r\n    if (batch.length) {\r\n      commitBatch(batch);\r\n      if (baseSpawned > 0) {\r\n        queued = Math.max(0, queued - baseSpawned);\r\n      }\r\n    }\r\n  }\r\n\r\n  rafId = requestAnimationFrame(loop);\r\n}\r\n\r\n\r\n\r\n\r\n    function start() {\r\n      if (rafId) return;\r\n      if (!validRefs()) {\r\n        console.warn('[Spawner] start() called but required nodes are missing.');\r\n        return;\r\n      }\r\n      computeMetrics();\r\n\r\n    if (initialBurst > 0 && rafId === null) {\r\n      spawnBurst(initialBurst);\r\n\t}\r\n\r\n    last = performance.now();\r\n    rafId = requestAnimationFrame(loop);\r\n  }\r\n\r\n\r\n    function stop() {\r\n        if (!rafId)\r\n            return;\r\n        cancelAnimationFrame(rafId);\r\n        rafId = null;\r\n    }\r\n\r\n    function setRate(n) {\r\n        rate = Math.max(0, Number(n) || 0);\r\n    }\r\n\r\n    function setCoinSprite(src) {\r\n      if (!src) return;\r\n      currentCoinSrc = src;\r\n    }\r\n\r\n    // Resume clean when tab is visible again\r\n   document.addEventListener('visibilitychange', () => {\r\n    if (!document.hidden) {\r\n      if (isTouch) burstUntil = performance.now() + BURST_WINDOW_MS;\r\n      if (!rafId) start();\r\n    }\r\n  });\r\n\r\n    return {\r\n        start,\r\n        stop,\r\n        setRate,\r\n        setCoinSprite,\r\n    };\r\n}\r\n", "// js/game/coinPickup.js\r\n\r\nimport { bank, CURRENCIES, getActiveSlot, isCurrencyLocked } from '../util/storage.js';\r\nimport { BigNum } from '../util/bigNum.js';\r\nimport { formatNumber } from '../util/numFormat.js';\r\nimport { unlockShop } from '../ui/hudButtons.js';\r\nimport { addXp, isXpSystemUnlocked } from './xpSystem.js';\r\nimport { IS_MOBILE } from '../main.js';\r\nimport {\r\n  addMutationPower,\r\n  isMutationUnlocked,\r\n  getMutationState,\r\n  onMutationChange,\r\n  computeMutationMultiplierForLevel,\r\n} from './mutationSystem.js';\r\nimport { getMpValueMultiplierBn, getMagnetLevel } from './upgrades.js';\r\n\r\nlet mutationUnlockedSnapshot = false;\r\nlet mutationLevelIsInfiniteSnapshot = false;\r\nlet mutationUnsub = null;\r\n\r\nfunction updateMutationSnapshot(state) {\r\n  if (!state || typeof state !== 'object') {\r\n    mutationUnlockedSnapshot = false;\r\n    mutationLevelIsInfiniteSnapshot = false;\r\n    mutationMultiplierCache.clear();\r\n    return;\r\n  }\r\n\r\n  mutationUnlockedSnapshot = !!state.unlocked;\r\n  mutationLevelIsInfiniteSnapshot = !!state.level?.isInfinite?.();\r\n\r\n  if (!mutationUnlockedSnapshot) {\r\n    mutationMultiplierCache.clear();\r\n  } else if (mutationLevelIsInfiniteSnapshot) {\r\n    mutationMultiplierCache.clear();\r\n  }\r\n}\r\n\r\nfunction initMutationSnapshot() {\r\n  if (typeof mutationUnsub === 'function') {\r\n    try { mutationUnsub(); } catch {}\r\n  }\r\n  try {\r\n    updateMutationSnapshot(getMutationState());\r\n  } catch {\r\n    mutationUnlockedSnapshot = false;\r\n    mutationMultiplierCache.clear();\r\n  }\r\n  try {\r\n    mutationUnsub = onMutationChange((snapshot) => { updateMutationSnapshot(snapshot); });\r\n  } catch {\r\n    mutationUnsub = null;\r\n  }\r\n}\r\n\r\nlet coinPickup = null;\r\n\r\nconst XP_PER_COIN = BigNum.fromInt(1);\r\nconst BASE_COIN_VALUE = BigNum.fromInt(1);\r\nconst BN_ONE = BigNum.fromInt(1);\r\n\r\nlet BN_INF;\r\ntry {\r\n  BN_INF = BigNum.fromAny('Infinity');\r\n} catch {\r\n  BN_INF = null;\r\n}\r\n\r\nconst mutationMultiplierCache = new Map();\r\nlet COIN_MULTIPLIER = '1';\r\nlet mpValueMultiplierBn = BigNum.fromInt(1);\r\nlet mpMultiplierListenersBound = false;\r\n\r\nexport function setCoinMultiplier(x) {\r\n  COIN_MULTIPLIER = x;\r\n  try {\r\n    if (bank.coins?.mult?.set) {\r\n      bank.coins.mult.set(x);\r\n    }\r\n  } catch {}\r\n}\r\n\r\nfunction refreshMpValueMultiplierCache() {\r\n  try {\r\n    const next = getMpValueMultiplierBn();\r\n    if (next instanceof BigNum) {\r\n      mpValueMultiplierBn = next.clone?.() ?? next;\r\n    } else if (next != null) {\r\n      mpValueMultiplierBn = BigNum.fromAny(next);\r\n    } else {\r\n      mpValueMultiplierBn = BigNum.fromInt(1);\r\n    }\r\n  } catch {\r\n    mpValueMultiplierBn = BigNum.fromInt(1);\r\n  }\r\n}\r\n\r\nfunction ensureMpValueMultiplierSync() {\r\n  if (mpMultiplierListenersBound) return;\r\n  mpMultiplierListenersBound = true;\r\n  refreshMpValueMultiplierCache();\r\n  if (typeof document !== 'undefined') {\r\n    document.addEventListener('ccc:upgrades:changed', refreshMpValueMultiplierCache);\r\n  }\r\n  if (typeof window !== 'undefined') {\r\n    window.addEventListener('saveSlot:change', refreshMpValueMultiplierCache);\r\n  }\r\n}\r\n\r\nfunction resolveCoinBase(el) {\r\n  if (el?.dataset?.bn) {\r\n    try { return BigNum.fromAny(el.dataset.bn); } catch {}\r\n  }\r\n  if (el?.dataset?.value) {\r\n    try { return BigNum.fromAny(el.dataset.value); } catch {}\r\n  }\r\n  try { return BASE_COIN_VALUE.clone?.() ?? BigNum.fromInt(1); }\r\n  catch { return BigNum.fromInt(1); }\r\n}\r\n\r\nconst MAGNET_UNIT_RATIO = 0.03;\r\nconst MAGNET_COLLECTION_BUFFER = 8;\r\n\r\nfunction computeMagnetUnitPx() {\r\n  if (typeof window === 'undefined' || typeof document === 'undefined') return 0;\r\n  const root = document.documentElement;\r\n  const vw = Math.max(0, window.innerWidth || root?.clientWidth || 0);\r\n  const vh = Math.max(0, window.innerHeight || root?.clientHeight || 0);\r\n  if (!(vw > 0 && vh > 0)) return 0;\r\n  const minDim = Math.min(vw, vh);\r\n  return minDim * MAGNET_UNIT_RATIO;\r\n}\r\n\r\nfunction createMagnetController({ playfield, coinsLayer, coinSelector, collectFn }) {\r\n  if (!playfield || !coinsLayer || typeof collectFn !== 'function') {\r\n    return { destroy() {} };\r\n  }\r\n  if (typeof window === 'undefined' || typeof document === 'undefined') {\r\n    return { destroy() {} };\r\n  }\r\n\r\n  const indicator = document.createElement('div');\r\n  indicator.className = 'magnet-indicator';\r\n  indicator.setAttribute('aria-hidden', 'true');\r\n  playfield.appendChild(indicator);\r\n\r\n  let pointerInside = false;\r\n  let pointerClientX = 0;\r\n  let pointerClientY = 0;\r\n  let localX = 0;\r\n  let localY = 0;\r\n  let unitPx = computeMagnetUnitPx();\r\n  let magnetLevel = 0;\r\n  let radiusPx = 0;\r\n  let rafId = 0;\r\n  let destroyed = false;\r\n\r\n  const hideIndicator = () => {\r\n    indicator.classList.remove('is-visible');\r\n    indicator.style.transform = 'translate3d(-9999px, -9999px, 0)';\r\n  };\r\n\r\n  const updateIndicator = () => {\r\n    if (!pointerInside || radiusPx <= 0) {\r\n      hideIndicator();\r\n      return;\r\n    }\r\n    const diameter = radiusPx * 2;\r\n    indicator.style.width = `${diameter}px`;\r\n    indicator.style.height = `${diameter}px`;\r\n    indicator.style.transform = `translate3d(${localX - radiusPx}px, ${localY - radiusPx}px, 0)`;\r\n    indicator.classList.add('is-visible');\r\n  };\r\n\r\n  const sweepCoins = () => {\r\n    if (!pointerInside || radiusPx <= 0) return;\r\n    const coins = coinsLayer.querySelectorAll(coinSelector);\r\n    const radiusWithBuffer = radiusPx + MAGNET_COLLECTION_BUFFER;\r\n    for (let i = 0; i < coins.length; i += 1) {\r\n      const coin = coins[i];\r\n      if (!(coin instanceof HTMLElement) || coin.dataset.collected === '1') continue;\r\n      const rect = coin.getBoundingClientRect();\r\n      const coinX = rect.left + rect.width / 2;\r\n      const coinY = rect.top + rect.height / 2;\r\n      const dx = coinX - pointerClientX;\r\n      const dy = coinY - pointerClientY;\r\n      if (Math.hypot(dx, dy) <= radiusWithBuffer) {\r\n        collectFn(coin);\r\n      }\r\n    }\r\n  };\r\n\r\n  const runSweep = () => {\r\n    rafId = 0;\r\n    if (!pointerInside || radiusPx <= 0 || destroyed) return;\r\n    sweepCoins();\r\n    ensureSweepLoop();\r\n  };\r\n\r\n  const ensureSweepLoop = () => {\r\n    if (!pointerInside || radiusPx <= 0 || rafId || destroyed) return;\r\n    rafId = requestAnimationFrame(runSweep);\r\n  };\r\n\r\n  const updatePointerFromEvent = (e) => {\r\n    if (!e || destroyed) return;\r\n    if (typeof e.clientX !== 'number' || typeof e.clientY !== 'number') return;\r\n    pointerClientX = e.clientX;\r\n    pointerClientY = e.clientY;\r\n    const rect = playfield.getBoundingClientRect();\r\n    localX = pointerClientX - rect.left;\r\n    localY = pointerClientY - rect.top;\r\n    pointerInside = localX >= 0 && localX <= rect.width && localY >= 0 && localY <= rect.height;\r\n    updateIndicator();\r\n    ensureSweepLoop();\r\n  };\r\n\r\n  const handlePointerLeave = () => {\r\n    pointerInside = false;\r\n    hideIndicator();\r\n  };\r\n\r\n  const refreshMagnetLevel = () => {\r\n    const nextLevel = getMagnetLevel();\r\n    magnetLevel = nextLevel;\r\n    radiusPx = magnetLevel * unitPx;\r\n    updateIndicator();\r\n    ensureSweepLoop();\r\n  };\r\n\r\n  const handleResize = () => {\r\n    unitPx = computeMagnetUnitPx();\r\n    radiusPx = magnetLevel * unitPx;\r\n    updateIndicator();\r\n    ensureSweepLoop();\r\n  };\r\n\r\n  const destroy = () => {\r\n    destroyed = true;\r\n    if (rafId) {\r\n      cancelAnimationFrame(rafId);\r\n      rafId = 0;\r\n    }\r\n    try { window.removeEventListener('resize', handleResize); } catch {}\r\n    try { window.removeEventListener('saveSlot:change', refreshMagnetLevel); } catch {}\r\n    try { document.removeEventListener('ccc:upgrades:changed', refreshMagnetLevel); } catch {}\r\n    try { playfield.removeEventListener('pointermove', updatePointerFromEvent); } catch {}\r\n    try { playfield.removeEventListener('pointerdown', updatePointerFromEvent); } catch {}\r\n    try { playfield.removeEventListener('pointerenter', updatePointerFromEvent); } catch {}\r\n    try { playfield.removeEventListener('pointerleave', handlePointerLeave); } catch {}\r\n    try { playfield.removeEventListener('pointercancel', handlePointerLeave); } catch {}\r\n    try { indicator.remove(); } catch {}\r\n  };\r\n\r\n  const pointerOpts = { passive: true };\r\n  playfield.addEventListener('pointermove', updatePointerFromEvent, pointerOpts);\r\n  playfield.addEventListener('pointerdown', updatePointerFromEvent, pointerOpts);\r\n  playfield.addEventListener('pointerenter', updatePointerFromEvent, pointerOpts);\r\n  playfield.addEventListener('pointerleave', handlePointerLeave, pointerOpts);\r\n  playfield.addEventListener('pointercancel', handlePointerLeave, pointerOpts);\r\n  window.addEventListener('resize', handleResize);\r\n  window.addEventListener('saveSlot:change', refreshMagnetLevel);\r\n  document.addEventListener('ccc:upgrades:changed', refreshMagnetLevel);\r\n\r\n  refreshMagnetLevel();\r\n\r\n  return { destroy };\r\n}\r\n\r\nexport function initCoinPickup({\r\n  playfieldSelector   = '.area-cove .playfield',\r\n  coinsLayerSelector  = '.area-cove .coins-layer',\r\n  hudAmountSelector   = '.hud-top .coin-amount',\r\n  coinSelector        = '.coin, [data-coin], .coin-sprite',\r\n  soundSrc            = 'sounds/coin_pickup.mp3',\r\n  storageKey          = 'ccc:coins',\r\n  disableAnimation    = IS_MOBILE,\r\n} = {}) {\r\n  if (coinPickup?.destroy) {\r\n    coinPickup.destroy();\r\n  }\r\n  \r\n  const pf  = document.querySelector(playfieldSelector);\r\n  const cl  = document.querySelector(coinsLayerSelector);\r\n  const amt = document.querySelector(hudAmountSelector);\r\n  if (!pf || !cl || !amt) {\r\n    console.warn('[coinPickup] missing required nodes', { pf: !!pf, cl: !!cl, amt: !!amt });\r\n    return { destroy(){} };\r\n  }\r\n\r\n  initMutationSnapshot();\r\n  ensureMpValueMultiplierSync();\r\n\r\n  pf.style.touchAction = 'none';\r\n\r\n  let magnetController = null;\r\n  let coins = bank.coins.value;\r\n  let coinMultiplierBn = null;\r\n  let coinMultiplierIsInfinite = false;\r\n\r\n  const refreshCoinMultiplierCache = () => {\r\n    try {\r\n      const multHandle = bank?.coins?.mult;\r\n      if (!multHandle || typeof multHandle.get !== 'function') {\r\n        coinMultiplierBn = null;\r\n        coinMultiplierIsInfinite = false;\r\n        return;\r\n      }\r\n      const next = multHandle.get();\r\n      if (!next) {\r\n        coinMultiplierBn = BigNum.fromInt(1);\r\n        coinMultiplierIsInfinite = false;\r\n        return;\r\n      }\r\n      coinMultiplierBn = next.clone?.() ?? BigNum.fromAny(next);\r\n      coinMultiplierIsInfinite = !!coinMultiplierBn?.isInfinite?.();\r\n    } catch {\r\n      coinMultiplierBn = null;\r\n      coinMultiplierIsInfinite = false;\r\n    }\r\n  };\r\n\r\n  const applyCoinMultiplier = (value) => {\r\n    let base;\r\n    try {\r\n      base = value instanceof BigNum\r\n        ? (value.clone?.() ?? value)\r\n        : BigNum.fromAny(value ?? 0);\r\n    } catch {\r\n      try {\r\n        return bank?.coins?.mult?.applyTo ? bank.coins.mult.applyTo(value) : BigNum.fromInt(0);\r\n      } catch {\r\n        return BigNum.fromInt(0);\r\n      }\r\n    }\r\n\r\n    if (!coinMultiplierBn) refreshCoinMultiplierCache();\r\n    const mult = coinMultiplierBn;\r\n    if (!mult) {\r\n      try { return bank?.coins?.mult?.applyTo ? bank.coins.mult.applyTo(base) : base.clone?.() ?? base; }\r\n      catch { return base.clone?.() ?? base; }\r\n    }\r\n    const multIsInf = coinMultiplierIsInfinite || mult.isInfinite?.();\r\n    if (multIsInf) {\r\n      try { return BigNum.fromAny('Infinity'); }\r\n      catch { return base.clone?.() ?? base; }\r\n    }\r\n    if (base.isZero?.()) {\r\n      return base.clone?.() ?? base;\r\n    }\r\n    try {\r\n      return base.mulBigNumInteger(mult);\r\n    } catch {\r\n      try { return bank?.coins?.mult?.applyTo ? bank.coins.mult.applyTo(base) : base.clone?.() ?? base; }\r\n      catch { return base.clone?.() ?? base; }\r\n    }\r\n  };\r\n  const updateHud = () => {\r\n    const formatted = formatNumber(coins);\r\n    if (formatted.includes('<span')) {\r\n      amt.innerHTML = formatted;\r\n    } else {\r\n      amt.textContent = formatted;\r\n    }\r\n  };\r\n  refreshCoinMultiplierCache();\r\n  updateHud();\r\n\r\n  const cloneBn = (value) => {\r\n    if (!value) return BigNum.fromInt(0);\r\n    if (typeof value.clone === 'function') {\r\n      try { return value.clone(); } catch {}\r\n    }\r\n    try { return BigNum.fromAny(value); } catch { return BigNum.fromInt(0); }\r\n  };\r\n\r\nconst computeMutationMultiplier = (spawnLevelStr) => {\r\n  if (!mutationUnlockedSnapshot) return null;\r\n\r\n  // Global override: once mutation level itself is \u221E,\r\n  // every coin gets an \u221E multiplier regardless of its spawn level.\r\n  if (mutationLevelIsInfiniteSnapshot) {\r\n    if (BN_INF) {\r\n      try { return BN_INF.clone?.() ?? BN_INF; }\r\n      catch { return BN_INF; }\r\n    }\r\n    // Fallback if Infinity construction failed for some reason\r\n    return null;\r\n  }\r\n\r\n  if (!spawnLevelStr) return null;\r\n  const key = String(spawnLevelStr).trim();\r\n  if (!key) return null;\r\n\r\n  const cached = mutationMultiplierCache.get(key);\r\n  if (cached) {\r\n    try { return cached.clone?.() ?? BigNum.fromAny(cached); }\r\n    catch { mutationMultiplierCache.delete(key); }\r\n  }\r\n\r\n  let levelBn;\r\n  try {\r\n    levelBn = BigNum.fromAny(key);\r\n  } catch {\r\n    return null;\r\n  }\r\n\r\n  let multiplier;\r\n  try {\r\n    multiplier = computeMutationMultiplierForLevel(levelBn);\r\n  } catch {\r\n    multiplier = null;\r\n  }\r\n\r\n  if (!multiplier) return null;\r\n  const isIdentity = multiplier.cmp?.(BN_ONE) === 0;\r\n  const stored = multiplier.clone?.() ?? multiplier;\r\n  mutationMultiplierCache.set(key, stored);\r\n  if (isIdentity) return null;\r\n  try { return stored.clone?.() ?? stored; }\r\n  catch { return stored; }\r\n};\r\n\r\n  let pendingCoinGain = null;\r\n  let pendingXpGain = null;\r\n  let pendingMutGain = null;\r\n  let flushScheduled = false;\r\n\r\n  const mergeGain = (current, gain) => {\r\n    if (!gain) return current;\r\n    if (!current) return cloneBn(gain);\r\n    try { return current.add(gain); }\r\n    catch {\r\n      try {\r\n        const base = cloneBn(current);\r\n        return base.add(gain);\r\n      } catch {\r\n        return cloneBn(gain);\r\n      }\r\n    }\r\n  };\r\n\r\n  const flushPendingGains = () => {\r\n    const coinGain = pendingCoinGain;\r\n    pendingCoinGain = null;\r\n    if (coinGain && !coinGain.isZero?.()) {\r\n      try { bank.coins.add(coinGain); } catch {}\r\n    }\r\n\r\n    const xpGain = pendingXpGain;\r\n    pendingXpGain = null;\r\n    if (xpGain && !xpGain.isZero?.()) {\r\n      try { addXp(xpGain); } catch {}\r\n    }\r\n\r\n    const mutGain = pendingMutGain;\r\n    pendingMutGain = null;\r\n    if (mutGain && !mutGain.isZero?.()) {\r\n      try { addMutationPower(mutGain); } catch {}\r\n    }\r\n  };\r\n\r\n  const scheduleFlush = () => {\r\n    if (flushScheduled) return;\r\n    flushScheduled = true;\r\n    requestAnimationFrame(() => {\r\n      flushScheduled = false;\r\n      flushPendingGains();\r\n    });\r\n  };\r\n\r\n  const queueCoinGain = (gain) => {\r\n    pendingCoinGain = mergeGain(pendingCoinGain, gain);\r\n    scheduleFlush();\r\n  };\r\n\r\n  const queueXpGain = (gain) => {\r\n    pendingXpGain = mergeGain(pendingXpGain, gain);\r\n    scheduleFlush();\r\n  };\r\n\r\n  const queueMutationGain = (gain) => {\r\n    pendingMutGain = mergeGain(pendingMutGain, gain);\r\n    scheduleFlush();\r\n  };\r\n\r\n  if (typeof window !== 'undefined') {\r\n    window.addEventListener('beforeunload', flushPendingGains, { passive: true });\r\n  }\r\n\r\n  try {\r\n    if (bank.coins?.mult?.get && bank.coins?.mult?.set) {\r\n      const curr = bank.coins.mult.get(); // BN\r\n      if (curr.toPlainIntegerString() === '1' && COIN_MULTIPLIER && COIN_MULTIPLIER !== '1') {\r\n        bank.coins.mult.set(COIN_MULTIPLIER);\r\n      }\r\n    }\r\n  } catch {}\r\n\r\n  const onCurrencyChange = (e) => {\r\n    if (!e?.detail) return;\r\n    if (e.detail.key === 'coins') {\r\n      coins = e.detail.value;\r\n      updateHud();\r\n    }\r\n  };\r\n  window.addEventListener('currency:change', onCurrencyChange);\r\n\r\n  const onCoinMultiplierChange = (event) => {\r\n    if (!event?.detail || event.detail.key !== 'coins') return;\r\n    try {\r\n      const { mult } = event.detail;\r\n      if (mult instanceof BigNum) {\r\n        coinMultiplierBn = mult.clone?.() ?? mult;\r\n      } else if (mult != null) {\r\n        coinMultiplierBn = BigNum.fromAny(mult);\r\n      } else {\r\n        coinMultiplierBn = BigNum.fromInt(1);\r\n      }\r\n      coinMultiplierIsInfinite = !!coinMultiplierBn?.isInfinite?.();\r\n    } catch {\r\n      coinMultiplierBn = null;\r\n      coinMultiplierIsInfinite = false;\r\n    }\r\n  };\r\n  window.addEventListener('currency:multiplier', onCoinMultiplierChange);\r\n\r\n  // ----- Slot-scoped shop unlock/progress keys -----\r\n  const slot = getActiveSlot();\r\n  if (slot == null) {\r\n    console.warn('[coinPickup] init called before a save slot is selected.');\r\n    return { destroy(){} };\r\n  }\r\n  const SHOP_UNLOCK_KEY   = `ccc:unlock:shop:${slot}`;\r\n  const SHOP_PROGRESS_KEY = `ccc:unlock:shop:progress:${slot}`;\r\n  // const MAP_UNLOCK_KEY = `ccc:unlock:map:${slot}`; // (future)\r\n\r\n  // (optional) migrate any legacy unsuffixed keys once\r\n  const legacyP = localStorage.getItem('ccc:unlock:shop:progress');\r\n  const legacyU = localStorage.getItem('ccc:unlock:shop');\r\n  if (legacyP != null && localStorage.getItem(SHOP_PROGRESS_KEY) == null) {\r\n    localStorage.setItem(SHOP_PROGRESS_KEY, legacyP);\r\n  }\r\n  if (legacyU != null && localStorage.getItem(SHOP_UNLOCK_KEY) == null) {\r\n    localStorage.setItem(SHOP_UNLOCK_KEY, legacyU);\r\n  }\r\n  localStorage.removeItem('ccc:unlock:shop:progress');\r\n  localStorage.removeItem('ccc:unlock:shop');\r\n\r\n  // normalize existing progress for this slot\r\n  {\r\n    const p = parseInt(localStorage.getItem(SHOP_PROGRESS_KEY) || '0', 10);\r\n    localStorage.setItem(SHOP_PROGRESS_KEY, String(p));\r\n    if (p >= 10 && localStorage.getItem(SHOP_UNLOCK_KEY) !== '1') {\r\n      try { unlockShop(); } catch {}\r\n      localStorage.setItem(SHOP_UNLOCK_KEY, '1');\r\n    }\r\n  }\r\n\r\n  // ----- Helpers -----\r\n  const DESKTOP_VOLUME = 0.3;\r\n  const MOBILE_VOLUME  = 0.12;\r\n  const resolvedSrc = new URL(soundSrc, document.baseURI).href;\r\n\r\n  // coins test\r\n  const isCoin = (el) => el instanceof HTMLElement && el.dataset.collected !== '1' && el.matches(coinSelector);\r\n\r\n  // Make current & future coins receptive to events even if CSS had pointer-events:none\r\n  function ensureInteractive(el){ try { el.style.pointerEvents = 'auto'; } catch {} }\r\n  cl.querySelectorAll(coinSelector).forEach(ensureInteractive);\r\n  const mo = new MutationObserver((recs) => {\r\n    for (const r of recs){\r\n      r.addedNodes.forEach(n => { if (n instanceof HTMLElement && n.matches(coinSelector)) { ensureInteractive(n); bindCoinDirect(n); } });\r\n    }\r\n  });\r\n  mo.observe(cl, { childList: true, subtree: true });\r\n\r\n  // ----- Audio (Mobile: WebAudio + fallback) -----\r\n  let ac = null, masterGain = null, buffer = null;\r\n  let webAudioReady = false, webAudioLoading = false, webAudioAttempted = false;\r\n  let queuedPlays = 0;\r\n\r\n  let mobileFallback = null;\r\n  function playCoinMobileFallback(){\r\n    if (!mobileFallback){\r\n      mobileFallback = new Audio(resolvedSrc);\r\n      mobileFallback.preload = 'auto';\r\n    }\r\n    // Re-apply the intended volume on every play (guards against drift)\r\n    mobileFallback.muted = false;\r\n    mobileFallback.volume = MOBILE_VOLUME;\r\n    try {\r\n      mobileFallback.currentTime = 0;\r\n      mobileFallback.play();\r\n    } catch {}\r\n  }\r\n\r\n  async function initWebAudioOnce(){\r\n    if (webAudioReady || webAudioLoading) return;\r\n    if (!('AudioContext' in window || 'webkitAudioContext' in window)) return;\r\n\r\n    webAudioLoading = true; webAudioAttempted = true;\r\n    ac = new (window.AudioContext || window.webkitAudioContext)();\r\n    masterGain = ac.createGain();\r\n    masterGain.gain.value = MOBILE_VOLUME;\r\n    masterGain.connect(ac.destination);\r\n\r\n    try {\r\n      const res = await fetch(resolvedSrc, { cache: 'force-cache' });\r\n      const arr = await res.arrayBuffer();\r\n      buffer = await new Promise((ok, err) => ac.decodeAudioData(arr, ok, err));\r\n      if (ac.state === 'suspended') { try { await ac.resume(); } catch {} }\r\n      webAudioReady = true;\r\n    } catch (e) {\r\n      console.warn('[coinPickup] WebAudio init failed:', e);\r\n    } finally {\r\n      webAudioLoading = false;\r\n    }\r\n  }\r\n\r\n  function playCoinWebAudio(){\r\n    if (ac && ac.state === 'suspended'){ try { ac.resume(); } catch {} }\r\n\r\n    if (IS_MOBILE && (!webAudioReady || !ac || !buffer || !masterGain || (ac && ac.state !== 'running'))) {\r\n      if (!webAudioLoading) initWebAudioOnce();\r\n      playCoinMobileFallback();   // respects MOBILE_VOLUME\r\n      return true;\r\n    }\r\n\r\n    // Desktop: if this ever happens (unlikely), let WA path return to caller\r\n    if (!webAudioReady || !ac || !buffer || !masterGain) {\r\n      if (!webAudioLoading) initWebAudioOnce();\r\n      return true;\r\n    }\r\n\r\n    try {\r\n      const src = ac.createBufferSource();\r\n      src.buffer = buffer;\r\n      try { src.detune = 0; } catch {}\r\n\r\n      // Re-assert the correct volume on every play\r\n      masterGain.gain.setValueAtTime(MOBILE_VOLUME, ac.currentTime);\r\n\r\n      src.connect(masterGain);\r\n      const t = ac.currentTime + Math.random()*0.006; // avoid phasing when many play\r\n      src.start(t);\r\n      return true;\r\n    } catch (e){\r\n      console.warn('[coinPickup] playCoinWebAudio error:', e);\r\n      if (IS_MOBILE) playCoinMobileFallback();\r\n      return false;\r\n    }\r\n  }\r\n\r\n  function playSound(){\r\n    if (IS_MOBILE) return playCoinWebAudio();\r\n    return playCoinHtmlAudio();\r\n  }\r\n\r\n  // Warm WebAudio eager on any gesture (window + playfield), capture=true so overlays don\u2019t block\r\n  const warm = () => { if (IS_MOBILE) initWebAudioOnce(); };\r\n  ['pointerdown', 'touchstart', 'click'].forEach(evt => {\r\n    window.addEventListener(evt, warm, { once: true, passive: true, capture: true });\r\n    pf.addEventListener(evt, warm, { once: true, passive: true, capture: true });\r\n  });\r\n\r\n  // ----- Desktop audio pool -----\r\n  let pool = null, pIdx = 0, lastAt = 0;\r\n  if (!IS_MOBILE){\r\n    pool = Array.from({ length: 8 }, () => { const a = new Audio(resolvedSrc); a.preload = 'auto'; a.volume = 0.3; return a; });\r\n  }\r\n  function playCoinHtmlAudio(){\r\n    const now = performance.now(); if ((now - lastAt) < 40) return; lastAt = now;\r\n    const a = pool[pIdx++ % pool.length];\r\n    try { a.currentTime = 0; a.play(); } catch {}\r\n  }\r\n\r\n  // ----- Collecting -----\r\n  function animateAndRemove(el){\r\n    if (disableAnimation) { el.remove(); return; }\r\n    const cs = getComputedStyle(el);\r\n    const start = cs.transform && cs.transform !== 'none' ? cs.transform : 'translate3d(0,0,0)';\r\n    el.style.setProperty('--ccc-start', start);\r\n    el.classList.add('coin--collected');\r\n    const done = () => { el.removeEventListener('animationend', done); el.remove(); };\r\n    el.addEventListener('animationend', done);\r\n    setTimeout(done, 600);\r\n  }\r\n\r\nfunction collect(el) {\r\n  if (!isCoin(el)) return false;\r\n  el.dataset.collected = '1';\r\n\r\n  playSound();\r\n  animateAndRemove(el);\r\n\r\n  const base = resolveCoinBase(el);\r\n  const coinsLocked = isCurrencyLocked(CURRENCIES.COINS);\r\n\r\n  let inc = applyCoinMultiplier(base);\r\n  let xpInc = cloneBn(XP_PER_COIN);\r\n\r\n  const spawnLevelStr = el.dataset.mutationLevel || null;\r\n  const mutationMultiplier = computeMutationMultiplier(spawnLevelStr);\r\n  if (mutationMultiplier) {\r\n    try { inc = inc.mulBigNumInteger(mutationMultiplier); } catch {}\r\n    try { xpInc = xpInc.mulBigNumInteger(mutationMultiplier); } catch {}\r\n  }\r\n\r\n  const incIsZero = typeof inc?.isZero === 'function' ? inc.isZero() : false;\r\n  if (!incIsZero && !coinsLocked) {\r\n    try {\r\n      coins = coins?.add ? coins.add(inc) : cloneBn(inc);\r\n    } catch {\r\n      coins = cloneBn(inc);\r\n    }\r\n  }\r\n  updateHud();\r\n  if (!incIsZero) {\r\n    queueCoinGain(inc);\r\n  }\r\n\r\n  const xpEnabled = typeof isXpSystemUnlocked === 'function' ? isXpSystemUnlocked() : true;\r\n  const xpIsZero = typeof xpInc?.isZero === 'function' ? xpInc.isZero() : false;\r\n  if (xpEnabled && !xpIsZero) {\r\n    queueXpGain(xpInc);\r\n  }\r\n\r\n  if (typeof isMutationUnlocked === 'function' && isMutationUnlocked()) {\r\n    const mpGain = cloneBn(mpValueMultiplierBn);\r\n    if (!mpGain.isZero?.()) {\r\n      queueMutationGain(mpGain);\r\n    }\r\n  }\r\n\r\n  if (localStorage.getItem(SHOP_UNLOCK_KEY) !== '1') {\r\n    const next = parseInt(localStorage.getItem(SHOP_PROGRESS_KEY) || '0', 10) + 1;\r\n    localStorage.setItem(SHOP_PROGRESS_KEY, String(next));\r\n    if (next >= 10) {\r\n      try { unlockShop(); } catch {}\r\n      localStorage.setItem(SHOP_UNLOCK_KEY, '1');\r\n    }\r\n  }\r\n\r\n  return true;\r\n}\r\n\r\n  magnetController = createMagnetController({\r\n    playfield: pf,\r\n    coinsLayer: cl,\r\n    coinSelector,\r\n    collectFn: collect,\r\n  });\r\n\r\n  // direct coin events as a safety net (helps if elementsFromPoint misses due to CSS)\r\n  function bindCoinDirect(coin){\r\n    coin.addEventListener('pointerdown', (e) => { collect(coin); }, { passive: true });\r\n    coin.addEventListener('mouseenter', () => { if (!IS_MOBILE) collect(coin); }, { passive: true });\r\n  }\r\n  cl.querySelectorAll(coinSelector).forEach(bindCoinDirect);\r\n\r\n  // Brush sweep \u2014 checks several offsets so you can \u201Cgraze\u201D coins while swiping\r\n  const BRUSH_R = 18; // px\r\n  const OFF = [[0,0],[BRUSH_R,0],[-BRUSH_R,0],[0,BRUSH_R],[0,-BRUSH_R]];\r\n  function brushAt(x,y){\r\n    // Primary: use hit-test stack\r\n    for (let k=0;k<OFF.length;k++){\r\n      const px = x + OFF[k][0], py = y + OFF[k][1];\r\n      const stack = document.elementsFromPoint(px, py);\r\n      for (let i=0;i<stack.length;i++){\r\n        const el = stack[i];\r\n        if (isCoin(el)) { collect(el); }\r\n      }\r\n    }\r\n  }\r\n\r\n  // Schedule brush per frame for performance\r\n  let pending = null, brushScheduled = false;\r\n  function scheduleBrush(x,y){\r\n    pending = {x,y};\r\n    if (!brushScheduled){\r\n      brushScheduled = true;\r\n      requestAnimationFrame(() => {\r\n        if (pending){ brushAt(pending.x, pending.y); pending = null; }\r\n        brushScheduled = false;\r\n      });\r\n    }\r\n  }\r\n\r\n  // Touch / pen\r\n  pf.addEventListener('pointerdown', (e) => { if (e.pointerType !== 'mouse') scheduleBrush(e.clientX, e.clientY); }, { passive: true });\r\n  pf.addEventListener('pointermove', (e) => { if (e.pointerType !== 'mouse') scheduleBrush(e.clientX, e.clientY); }, { passive: true });\r\n  pf.addEventListener('pointerup',   (e) => { if (e.pointerType !== 'mouse') scheduleBrush(e.clientX, e.clientY); }, { passive: true });\r\n\r\n  // Desktop mouse hover sweep (lightly throttled by rAF above)\r\n  pf.addEventListener('mousemove', (e) => { scheduleBrush(e.clientX, e.clientY); }, { passive: true });\r\n\r\n  // Public API + cleanup\r\n  function setMobileVolume(v){\r\n    const vol = Math.max(0, Math.min(1, Number(v) || 0));\r\n    if (masterGain && ac) masterGain.gain.setValueAtTime(vol, ac.currentTime);\r\n    if (mobileFallback) mobileFallback.volume = vol;\r\n  }\r\n\r\n  const destroy = () => {\r\n    flushPendingGains();\r\n    if (typeof window !== 'undefined') {\r\n      window.removeEventListener('beforeunload', flushPendingGains);\r\n      window.removeEventListener('currency:multiplier', onCoinMultiplierChange);\r\n      window.removeEventListener('currency:change', onCurrencyChange);\r\n    }\r\n    if (typeof mutationUnsub === 'function') {\r\n      try { mutationUnsub(); } catch {}\r\n      mutationUnsub = null;\r\n    }\r\n    if (magnetController?.destroy) {\r\n      try { magnetController.destroy(); } catch {}\r\n      magnetController = null;\r\n    }\r\n    try { mo.disconnect(); } catch {}\r\n    try { ['pointerdown','pointermove','pointerup','mousemove'].forEach(evt => pf.replaceWith(pf.cloneNode(true))); } catch {}\r\n  };\r\n\r\n  coinPickup = { destroy };\r\n\r\n  return {\r\n    get count(){ return coins; },\r\n    set count(v){\r\n      coins = BigNum.fromAny ? BigNum.fromAny(v) : BigNum.fromInt(Number(v) || 0);\r\n      updateHud();\r\n      // Note: saving is handled via bank.set inside bank.coins.add in storage\r\n    },\r\n    setMobileVolume,\r\n    destroy,\r\n  };\r\n}\r\n", "// js/util/saveIntegrity.js\r\n// If a player modifies their save file manually (e.g., console commands, local storage editing, JSON tampering),\r\n// A one-way flag, `hasModifiedSave`, will become true and turn the shop button's color brown,\r\n// Which I like to call the poop-shop of shame.\r\n// Used to detect cheaters.\r\nimport {\r\n  STORAGE_PREFIX,\r\n  getActiveSlot,\r\n  getSlotSignature,\r\n  setSlotSignature,\r\n  markSaveSlotModified,\r\n  getSlotSignatureKey,\r\n  hasModifiedSave,\r\n} from './storage.js';\r\n\r\nconst SIGNATURE_POLL_INTERVAL_MS = 10000;\r\nconst TRUSTED_MUTATION_GRACE_MS = 750;\r\nconst TRUSTED_SWEEP_DELAY_MS = 50;\r\nlet watcherId = null;\r\nlet trustedSweepTimer = null;\r\n\r\nconst trustedSlotsUntil = new Map();\r\n\r\nfunction nowMs() {\r\n  if (typeof performance !== 'undefined' && typeof performance.now === 'function') {\r\n    return performance.now();\r\n  }\r\n  return Date.now();\r\n}\r\n\r\nfunction noteTrustedSlot(slot, ttl = TRUSTED_MUTATION_GRACE_MS) {\r\n  if (!slot || slot <= 0) return;\r\n  trustedSlotsUntil.set(slot, nowMs() + ttl);\r\n}\r\n\r\nfunction slotRecentlyTrusted(slot) {\r\n  if (!slot || slot <= 0) return false;\r\n  const expiry = trustedSlotsUntil.get(slot);\r\n  if (expiry == null) return false;\r\n  if (expiry <= nowMs()) {\r\n    trustedSlotsUntil.delete(slot);\r\n    return false;\r\n  }\r\n  return true;\r\n}\r\n\r\nfunction resetTrustedSlots() {\r\n  trustedSlotsUntil.clear();\r\n}\r\n\r\nfunction hasLocalStorage() {\r\n  try {\r\n    return typeof localStorage !== 'undefined';\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\n// In-memory snapshot of expected localStorage state per slot.\r\n// This lets us detect manual/out-of-band changes while the game is running.\r\nconst expectedStateBySlot = new Map();\r\nlet integrityInternalWriteDepth = 0;\r\n\r\nfunction parseSlotFromKey(key) {\r\n  if (!key) return null;\r\n  const match = /:(\\d+)$/.exec(String(key));\r\n  if (!match) return null;\r\n  const slot = Number.parseInt(match[1], 10);\r\n  return Number.isFinite(slot) && slot > 0 ? slot : null;\r\n}\r\n\r\nfunction rebuildExpectedStateForSlot(slot) {\r\n  const snapshot = new Map();\r\n  if (!hasLocalStorage()) {\r\n    expectedStateBySlot.set(slot, snapshot);\r\n    return snapshot;\r\n  }\r\n  try {\r\n    for (let i = 0; i < localStorage.length; i += 1) {\r\n      const key = localStorage.key(i);\r\n      if (!key || !key.startsWith(STORAGE_PREFIX)) continue;\r\n      const keySlot = parseSlotFromKey(key);\r\n      if (keySlot == null || keySlot !== slot) continue;\r\n      let value = '';\r\n      try {\r\n        value = localStorage.getItem(key) ?? '';\r\n      } catch {\r\n        value = '';\r\n      }\r\n      snapshot.set(key, value);\r\n    }\r\n  } catch {}\r\n  expectedStateBySlot.set(slot, snapshot);\r\n  return snapshot;\r\n}\r\n\r\nfunction ensureExpectedStateForSlot(slot) {\r\n  if (!Number.isFinite(slot) || slot <= 0) return null;\r\n  if (expectedStateBySlot.has(slot)) return expectedStateBySlot.get(slot);\r\n  return rebuildExpectedStateForSlot(slot);\r\n}\r\n\r\nexport function beforeSlotWrite(key) {\r\n  if (!hasLocalStorage()) return;\r\n  if (integrityInternalWriteDepth > 0) return;\r\n\r\n  const strKey = String(key);\r\n  if (!strKey.startsWith(STORAGE_PREFIX)) return;\r\n\r\n  const slot = parseSlotFromKey(strKey);\r\n\r\n  if (slot == null) return;\r\n\r\n  const snapshot = ensureExpectedStateForSlot(slot);\r\n  if (!snapshot) return;\r\n\r\n  try {\r\n    for (const [snapKey, expectedValue] of snapshot.entries()) {\r\n      let actualValue = '';\r\n      try {\r\n        actualValue = localStorage.getItem(snapKey) ?? '';\r\n      } catch {\r\n        actualValue = '';\r\n      }\r\n      if (actualValue !== expectedValue) {\r\n        if (integrityInternalWriteDepth === 0) {\r\n          integrityInternalWriteDepth += 1;\r\n          try {\r\n            markSaveSlotModified(slot);\r\n          } finally {\r\n            integrityInternalWriteDepth -= 1;\r\n          }\r\n        }\r\n        rebuildExpectedStateForSlot(slot);\r\n        return;\r\n      }\r\n    }\r\n  } catch {}\r\n}\r\n\r\nexport function afterSlotWrite(key, value) {\r\n  const strKey = String(key);\r\n  if (!strKey.startsWith(STORAGE_PREFIX)) return;\r\n  const slot = parseSlotFromKey(strKey);\r\n  if (slot == null) return;\r\n\r\n  const snapshot = ensureExpectedStateForSlot(slot) || new Map();\r\n  snapshot.set(strKey, String(value ?? ''));\r\n  expectedStateBySlot.set(slot, snapshot);\r\n}\r\n\r\nfunction computeSignature(entries = []) {\r\n  let hash = 0;\r\n  for (const entry of entries) {\r\n    for (let i = 0; i < entry.length; i += 1) {\r\n      hash = ((hash << 5) - hash + entry.charCodeAt(i)) >>> 0;\r\n    }\r\n    hash = (hash + 0x9e3779b1) >>> 0;\r\n  }\r\n  return `${entries.length}|${hash.toString(16)}`;\r\n}\r\n\r\nfunction collectEntriesBySlot() {\r\n  const map = new Map();\r\n  if (!hasLocalStorage()) return map;\r\n  try {\r\n    for (let i = 0; i < localStorage.length; i += 1) {\r\n      const key = localStorage.key(i);\r\n      if (!key || !key.startsWith(STORAGE_PREFIX)) continue;\r\n      const slotMatch = key.match(/:(\\d+)$/);\r\n      if (!slotMatch) continue;\r\n      const slot = parseInt(slotMatch[1], 10);\r\n      if (!Number.isFinite(slot) || slot <= 0) continue;\r\n      const sigKey = getSlotSignatureKey(slot);\r\n      if (key === sigKey) {\r\n        if (!map.has(slot)) map.set(slot, []);\r\n        continue;\r\n      }\r\n      let value = '';\r\n      try { value = localStorage.getItem(key) ?? ''; }\r\n      catch {}\r\n      if (!map.has(slot)) map.set(slot, []);\r\n      map.get(slot).push(`${key}=${value}`);\r\n    }\r\n  } catch {}\r\n  map.forEach((entries) => entries.sort());\r\n  return map;\r\n}\r\n\r\nfunction getCandidateSlots(entriesBySlot) {\r\n  const slots = new Set();\r\n  if (entriesBySlot) {\r\n    entriesBySlot.forEach((_, slot) => slots.add(slot));\r\n  }\r\n  const active = getActiveSlot();\r\n  if (Number.isFinite(active) && active > 0) slots.add(active);\r\n  if (typeof document !== 'undefined') {\r\n    document.querySelectorAll('.slot-card').forEach((_, idx) => slots.add(idx + 1));\r\n  }\r\n  return [...slots].filter((slot) => Number.isFinite(slot) && slot > 0);\r\n}\r\n\r\nfunction verifySlotIntegrity(slot, entries) {\r\n  if (!slot || slot <= 0) return;\r\n  const list = Array.isArray(entries) ? entries : [];\r\n  const stored = getSlotSignature(slot);\r\n  if (list.length === 0) {\r\n    if (stored) {\r\n      if (!slotRecentlyTrusted(slot)) {\r\n        markSaveSlotModified(slot);\r\n      }\r\n      setSlotSignature(slot, null);\r\n    }\r\n    return;\r\n  }\r\n  const signature = computeSignature(list);\r\n  const mismatch = signature !== stored;\r\n  if (stored && mismatch && !slotRecentlyTrusted(slot)) {\r\n    markSaveSlotModified(slot);\r\n  }\r\n  if (signature !== stored) {\r\n    setSlotSignature(slot, signature);\r\n  }\r\n}\r\n\r\nfunction runIntegrityCheck() {\r\n  if (!hasLocalStorage()) return;\r\n  const entriesBySlot = collectEntriesBySlot();\r\n  const slots = getCandidateSlots(entriesBySlot);\r\n  slots.forEach((slot) => {\r\n    const entries = entriesBySlot.get(slot) ?? [];\r\n    verifySlotIntegrity(slot, entries);\r\n  });\r\n}\r\n\r\nfunction scheduleTrustedMutationSweep() {\r\n  if (trustedSweepTimer != null) return;\r\n  const root = typeof window !== 'undefined' ? window : globalThis;\r\n  trustedSweepTimer = root.setTimeout(() => {\r\n    trustedSweepTimer = null;\r\n    runIntegrityCheck();\r\n  }, TRUSTED_SWEEP_DELAY_MS);\r\n}\r\n\r\nfunction handleStorageMutationEvent(event) {\r\n  const detail = event?.detail;\r\n  if (!detail) return;\r\n  const rawSlot = typeof detail.slot === 'number' ? detail.slot : Number.parseInt(detail.slot, 10);\r\n  const slot = Number.isFinite(rawSlot) ? rawSlot : null;\r\n  if (!Number.isFinite(slot) || slot <= 0) return;\r\n  if (detail.trusted) {\r\n    noteTrustedSlot(slot);\r\n    scheduleTrustedMutationSweep();\r\n    return;\r\n  }\r\n  trustedSlotsUntil.delete(slot);\r\n  runIntegrityCheck();\r\n}\r\n\r\nfunction ensureWatcher() {\r\n  if (typeof window === 'undefined') return;\r\n  if (watcherId != null) return;\r\n  watcherId = window.setInterval(runIntegrityCheck, SIGNATURE_POLL_INTERVAL_MS);\r\n}\r\n\r\nconst POOP_SHOP_BG  = 'linear-gradient(180deg,#a9793d,#7b5534)';\r\nconst POOP_SHOP_FLAG = '1';\r\n\r\nlet poopShopTimer = null;\r\n\r\nfunction getShopButtonElement() {\r\n  if (typeof document === 'undefined') return null;\r\n  return document.querySelector('.hud-bottom .game-btn[data-btn=\"shop\"]');\r\n}\r\n\r\nfunction enforcePoopShopStyle() {\r\n  const btn = getShopButtonElement();\r\n  if (!btn) return;\r\n\r\n  const isModded = hasModifiedSave();\r\n\r\n  if (!isModded) {\r\n    if (btn.dataset.poopShopApplied === POOP_SHOP_FLAG || btn.style.backgroundImage || btn.style.background) {\r\n      btn.style.backgroundImage = '';\r\n      btn.style.background = '';\r\n      delete btn.dataset.poopShopApplied;\r\n    }\r\n    return;\r\n  }\r\n\r\n  const current = btn.style.backgroundImage || btn.style.background;\r\n  if (current !== POOP_SHOP_BG || btn.dataset.poopShopApplied !== POOP_SHOP_FLAG) {\r\n    btn.style.backgroundImage = POOP_SHOP_BG;\r\n    btn.dataset.poopShopApplied = POOP_SHOP_FLAG;\r\n  }\r\n}\r\n\r\nfunction startPoopShopEnforcer() {\r\n  if (typeof window === 'undefined') return;\r\n  if (poopShopTimer != null) return;\r\n\r\n  enforcePoopShopStyle();\r\n  poopShopTimer = window.setInterval(enforcePoopShopStyle, 50);\r\n\r\n  window.addEventListener('saveSlot:change', enforcePoopShopStyle);\r\n  window.addEventListener('saveSlot:modified', (ev) => {\r\n    try {\r\n      const active = getActiveSlot();\r\n      if (ev?.detail?.slot === active) {\r\n        enforcePoopShopStyle();\r\n      }\r\n    } catch {\r\n      enforcePoopShopStyle();\r\n    }\r\n  });\r\n}\r\n\r\nfunction init() {\r\n  if (typeof window === 'undefined') return;\r\n  runIntegrityCheck();\r\n  ensureWatcher();\r\n  startPoopShopEnforcer();\r\n  window.addEventListener('saveSlot:change', () => runIntegrityCheck());\r\n  window.addEventListener('saveIntegrity:storageMutation', handleStorageMutationEvent, { passive: true });\r\n  if (typeof document !== 'undefined') {\r\n    document.addEventListener('visibilitychange', () => {\r\n      if (!document.hidden) {\r\n        resetTrustedSlots();\r\n        runIntegrityCheck();\r\n        enforcePoopShopStyle();\r\n      }\r\n    });\r\n  }\r\n}\r\n\r\ninit();\r\n", "// js/ui/popups.js\r\n\r\nimport { BigNum } from '../util/bigNum.js';\r\nimport { formatNumber } from '../util/numFormat.js';\r\nimport { CURRENCIES } from '../util/storage.js';\r\n\r\nconst DEFAULT_DURATION = 3200;\r\n\r\nconst POPUP_ORDER = ['coins', 'xp', 'books', 'gold', 'mp'];\r\n\r\nconst POPUP_META = {\r\n  [CURRENCIES.COINS]: {\r\n    icon: 'img/currencies/coin/coin.png',\r\n    iconAlt: 'Coin',\r\n  },\r\n  xp: {\r\n    icon: 'img/stats/xp/xp.png',\r\n    iconAlt: 'XP',\r\n  },\r\n  [CURRENCIES.BOOKS]: {\r\n    icon: 'img/currencies/book/book.png',\r\n    iconAlt: 'Book',\r\n  },\r\n  [CURRENCIES.GOLD]: {\r\n    icon: 'img/currencies/gold/gold.png',\r\n    iconAlt: 'Gold',\r\n  },\r\n  mp: {\r\n    icon: 'img/stats/mp/mp.png',\r\n    iconAlt: 'Mutation Power',\r\n  },\r\n};\r\n\r\nlet container = null;\r\nlet initialized = false;\r\nconst lastKnownAmounts = new Map();\r\nconst activePopups = new Map();\r\n\r\nfunction ensureContainer() {\r\n  if (container) return container;\r\n  container = document.createElement('div');\r\n  container.className = 'currency-popups';\r\n  container.setAttribute('aria-live', 'polite');\r\n  container.setAttribute('aria-atomic', 'false');\r\n  document.body.appendChild(container);\r\n  return container;\r\n}\r\n\r\nfunction bnFromAny(value) {\r\n  if (value == null) return null;\r\n  if (value instanceof BigNum) return value.clone?.() ?? value;\r\n  if (typeof value.clone === 'function' && value.sig != null) {\r\n    try { return value.clone(); } catch {}\r\n  }\r\n  try { return BigNum.fromAny(value); } catch { return null; }\r\n}\r\n\r\nfunction isZero(bn) {\r\n  if (!bn) return true;\r\n  if (typeof bn.isZero === 'function') {\r\n    try { return bn.isZero(); } catch { return false; }\r\n  }\r\n  return false;\r\n}\r\n\r\nfunction updateEntry(entry) {\r\n  if (!entry) return;\r\n  const { amountEl, amount, meta } = entry;\r\n  const formatted = meta.formatAmount ? meta.formatAmount(amount) : formatNumber(amount);\r\n  if (amountEl) amountEl.innerHTML = formatted;\r\n}\r\n\r\nfunction scheduleRemoval(entry, duration = DEFAULT_DURATION) {\r\n  if (!entry) return;\r\n  if (entry.timeoutId) return; // already scheduled; do NOT reset\r\n  entry.timeoutId = window.setTimeout(() => {\r\n    activePopups.delete(entry.type);\r\n    entry.element.classList.remove('is-visible');\r\n    entry.element.classList.add('is-leaving');\r\n    const remove = () => {\r\n      entry.element.removeEventListener('transitionend', remove);\r\n      entry.element.remove();\r\n    };\r\n    entry.element.addEventListener('transitionend', remove, { once: true });\r\n    window.setTimeout(remove, 480);\r\n  }, duration);\r\n}\r\n\r\nfunction createPopupEntry(type, meta, amount) {\r\n  ensureContainer();\r\n  const element = document.createElement('div');\r\n  element.className = 'currency-popup';\r\n  element.setAttribute('role', 'status');\r\n\r\n  const plus = document.createElement('span');\r\n  plus.className = 'currency-popup__plus';\r\n  plus.textContent = '+';\r\n\r\n  const icon = document.createElement('img');\r\n  icon.className = 'currency-popup__icon';\r\n  icon.src = meta.icon;\r\n  icon.alt = meta.iconAlt || '';\r\n\r\n  const text = document.createElement('span');\r\n  text.className = 'currency-popup__text';\r\n\r\n  const amountEl = document.createElement('span');\r\n  amountEl.className = 'currency-popup__amount';\r\n\r\n  text.append(amountEl);\r\n  element.append(plus, icon, text);\r\n\r\n  return {\r\n    type,\r\n    meta,\r\n    element,\r\n    amountEl,\r\n    amount: amount.clone?.() ?? amount,\r\n    timeoutId: null,\r\n  };\r\n}\r\n\r\nfunction showPopup(type, amount, overrides = {}) {\r\n  const baseMeta = POPUP_META[type];\r\n  const meta = Object.assign({ duration: DEFAULT_DURATION, accumulate: true }, baseMeta || {}, overrides);\r\n  if (!meta.icon) return;\r\n\r\n  const bnAmount = bnFromAny(amount);\r\n  if (!bnAmount || isZero(bnAmount)) return;\r\n\r\n  const existing = meta.accumulate !== false ? activePopups.get(type) : null;\r\n\r\n  if (existing) {\r\n    // Update the number but DO NOT reset its lifetime or animations.\r\n    existing.amount = existing.amount.add(bnAmount);\r\n    existing.meta = meta;\r\n    updateEntry(existing);\r\n    return;\r\n  }\r\n\r\n  const entry = createPopupEntry(type, meta, bnAmount);\r\n  entry.meta = meta;\r\n  updateEntry(entry);\r\n  activePopups.set(type, entry);\r\n\r\n  const host = ensureContainer();\r\n\r\n  // Insert based on order (coins first, xp second, books last)\r\n  const index = POPUP_ORDER.indexOf(type);\r\n  let insertBefore = null;\r\n  if (index >= 0) {\r\n    for (let i = index + 1; i < POPUP_ORDER.length; i++) {\r\n      const next = activePopups.get(POPUP_ORDER[i]);\r\n      if (next?.element?.parentNode === host) {\r\n        insertBefore = next.element;\r\n        break;\r\n      }\r\n    }\r\n  }\r\n\r\n  if (insertBefore) host.insertBefore(entry.element, insertBefore);\r\n  else host.appendChild(entry.element);\r\n\r\n  requestAnimationFrame(() => entry.element.classList.add('is-visible'));\r\n  scheduleRemoval(entry, meta.duration); // scheduled ONCE at creation\r\n}\r\n\r\nfunction syncLastKnown() {\r\n  try {\r\n    const all = getAllCurrencies();\r\n    Object.entries(all).forEach(([key, value]) => {\r\n      const bn = bnFromAny(value) || BigNum.fromInt(0);\r\n      lastKnownAmounts.set(key, bn.clone?.() ?? bn);\r\n    });\r\n    if (!lastKnownAmounts.has('mp')) {\r\n      lastKnownAmounts.set('mp', BigNum.fromInt(0));\r\n    }\r\n  } catch {\r\n    lastKnownAmounts.clear();\r\n  }\r\n}\r\n\r\nfunction clearActivePopups() {\r\n  activePopups.forEach((entry) => {\r\n    if (entry.timeoutId) clearTimeout(entry.timeoutId);\r\n    entry.element.remove();\r\n  });\r\n  activePopups.clear();\r\n}\r\n\r\nfunction handleCurrencyChange(event) {\r\n  const detail = event?.detail;\r\n  if (!detail?.key) return;\r\n  const key = detail.key;\r\n  const current = bnFromAny(detail.value) || BigNum.fromInt(0);\r\n  const prev = lastKnownAmounts.get(key) || BigNum.fromInt(0);\r\n  const zero = BigNum.fromInt(0);\r\n  let delta = null;\r\n  const detailDelta = detail.delta != null ? bnFromAny(detail.delta) : null;\r\n  if (detailDelta && typeof detailDelta.cmp === 'function' && detailDelta.cmp(zero) > 0) {\r\n    delta = detailDelta;\r\n  } else if (typeof current.cmp === 'function' && current.cmp(prev) > 0) {\r\n    delta = current.sub(prev);\r\n  }\r\n  if (delta && !(typeof delta.isZero === 'function' && delta.isZero())) {\r\n    showPopup(key, delta);\r\n  }\r\n  lastKnownAmounts.set(key, current.clone?.() ?? current);\r\n}\r\n\r\nfunction handleXpChange(event) {\r\n  const detail = event?.detail;\r\n  if (!detail) return;\r\n  const xpAdded = bnFromAny(detail.xpAdded);\r\n  if (xpAdded && !isZero(xpAdded)) showPopup('xp', xpAdded);\r\n}\r\n\r\nfunction handleMutationChange(event) {\r\n  const detail = event?.detail;\r\n  if (!detail) return;\r\n  const delta = bnFromAny(detail.delta);\r\n  if (delta && !isZero(delta)) {\r\n    showPopup('mp', delta);\r\n  }\r\n  const nextProgress = bnFromAny(detail.progress);\r\n  if (nextProgress) {\r\n    lastKnownAmounts.set('mp', nextProgress.clone?.() ?? nextProgress);\r\n  }\r\n}\r\n\r\nfunction handleSlotChange() {\r\n  clearActivePopups();\r\n  syncLastKnown();\r\n}\r\n\r\nexport function initPopups() {\r\n  if (initialized) return;\r\n  initialized = true;\r\n  ensureContainer();\r\n  syncLastKnown();\r\n  window.addEventListener('currency:change', handleCurrencyChange);\r\n  window.addEventListener('xp:change', handleXpChange);\r\n  window.addEventListener('mutation:change', handleMutationChange);\r\n  window.addEventListener('saveSlot:change', handleSlotChange);\r\n}\r\n\r\nexport function teardownpopups() {\r\n  if (!initialized) return;\r\n  window.removeEventListener('currency:change', handleCurrencyChange);\r\n  window.removeEventListener('xp:change', handleXpChange);\r\n  window.removeEventListener('mutation:change', handleMutationChange);\r\n  window.removeEventListener('saveSlot:change', handleSlotChange);\r\n  clearActivePopups();\r\n  lastKnownAmounts.clear();\r\n  if (container) container.remove();\r\n  container = null;\r\n  initialized = false;\r\n}\r\n", "// js/util/suspendSafeguard.js\r\n// Improves local storage tracking by supplying helper functions for saveIntegrity.js,\r\n// And also supplies frequent IndexedDB snapshots to back up progress if\r\n// Local storage ever becomes corrupted (safeguard against abrupt page suspensions)\r\nimport { beforeSlotWrite, afterSlotWrite } from './saveIntegrity.js';\r\n\r\nconst STORAGE_PREFIX = 'ccc:';\r\nconst DB_NAME = 'ccc:safety';\r\nconst DB_VERSION = 1;\r\nconst STORE_NAME = 'snapshots';\r\nconst SNAPSHOT_KEY = 'latest';\r\nconst SLOT_SIGNATURE_PREFIX = `${STORAGE_PREFIX}slotSig`;\r\nconst SLOT_MOD_FLAG_PREFIX = `${STORAGE_PREFIX}slotMod`;\r\nconst FLUSH_DEBOUNCE_MS = 1000;\r\n\r\nlet dbPromise = null;\r\nlet flushTimer = null;\r\nlet dirty = false;\r\nlet lastDirtyReason = 'init';\r\nlet installAttempted = false;\r\nlet restoreAttempted = false;\r\nlet pendingImmediateFlush = false;\r\n\r\nfunction canUseIndexedDb() {\r\n  if (typeof indexedDB === 'undefined') return false;\r\n  try {\r\n    return typeof indexedDB.open === 'function';\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\nfunction canUseLocalStorage() {\r\n  if (typeof localStorage === 'undefined') return false;\r\n  try {\r\n    const testKey = `${STORAGE_PREFIX}__test__`;\r\n    localStorage.setItem(testKey, '1');\r\n    localStorage.removeItem(testKey);\r\n    return true;\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\nasync function openDatabase() {\r\n  if (!canUseIndexedDb()) throw new Error('IndexedDB unavailable');\r\n  if (dbPromise) return dbPromise;\r\n\r\n  dbPromise = new Promise((resolve, reject) => {\r\n    let resolved = false;\r\n    try {\r\n      const request = indexedDB.open(DB_NAME, DB_VERSION);\r\n      request.onupgradeneeded = () => {\r\n        try {\r\n          const db = request.result;\r\n          if (!db.objectStoreNames.contains(STORE_NAME)) {\r\n            db.createObjectStore(STORE_NAME);\r\n          }\r\n        } catch (err) {\r\n          console.warn('Failed to upgrade suspend safeguard DB', err);\r\n        }\r\n      };\r\n      request.onsuccess = () => {\r\n        resolved = true;\r\n        const db = request.result;\r\n        db.onversionchange = () => {\r\n          try { db.close(); } catch {}\r\n          dbPromise = null;\r\n        };\r\n        resolve(db);\r\n      };\r\n      request.onerror = () => {\r\n        if (!resolved) {\r\n          reject(request.error || new Error('Failed to open suspend safeguard DB'));\r\n        }\r\n      };\r\n      request.onblocked = () => {\r\n        // Nothing special, but ensure promise settles eventually\r\n      };\r\n    } catch (err) {\r\n      reject(err);\r\n    }\r\n  }).catch((err) => {\r\n    dbPromise = null;\r\n    throw err;\r\n  });\r\n\r\n  return dbPromise;\r\n}\r\n\r\nfunction captureSnapshot() {\r\n  if (!canUseLocalStorage()) return null;\r\n  const data = {};\r\n  let captured = false;\r\n  try {\r\n    for (let i = 0; i < localStorage.length; i++) {\r\n      const key = localStorage.key(i);\r\n      if (!key || !key.startsWith(STORAGE_PREFIX)) continue;\r\n      let value = null;\r\n      try {\r\n        value = localStorage.getItem(key);\r\n      } catch {\r\n        value = null;\r\n      }\r\n      if (value == null) continue;\r\n      data[key] = value;\r\n      captured = true;\r\n    }\r\n  } catch (err) {\r\n    console.warn('Failed to read localStorage for snapshot', err);\r\n    return null;\r\n  }\r\n\r\n  return {\r\n    data,\r\n    savedAt: Date.now(),\r\n    hasData: captured,\r\n  };\r\n}\r\n\r\nasync function putSnapshot(snapshot) {\r\n  try {\r\n    const db = await openDatabase();\r\n    await new Promise((resolve, reject) => {\r\n      let settled = false;\r\n      const tx = db.transaction(STORE_NAME, 'readwrite');\r\n      tx.oncomplete = () => { if (!settled) { settled = true; resolve(true); } };\r\n      tx.onabort = () => { if (!settled) { settled = true; reject(tx.error || new Error('Snapshot transaction aborted')); } };\r\n      tx.onerror = () => { if (!settled) { settled = true; reject(tx.error || new Error('Snapshot transaction error')); } };\r\n      const store = tx.objectStore(STORE_NAME);\r\n      const request = store.put(snapshot, SNAPSHOT_KEY);\r\n      request.onerror = () => {\r\n        if (!settled) {\r\n          settled = true;\r\n          reject(request.error || new Error('Snapshot write failed'));\r\n        }\r\n      };\r\n    });\r\n    return true;\r\n  } catch (err) {\r\n    console.warn('Failed to persist suspend snapshot', err);\r\n    return false;\r\n  }\r\n}\r\n\r\nasync function readSnapshot() {\r\n  try {\r\n    const db = await openDatabase();\r\n    return await new Promise((resolve, reject) => {\r\n      let settled = false;\r\n      const tx = db.transaction(STORE_NAME, 'readonly');\r\n      tx.oncomplete = () => { if (!settled) { settled = true; resolve(null); } };\r\n      tx.onabort = () => { if (!settled) { settled = true; reject(tx.error || new Error('Snapshot read aborted')); } };\r\n      tx.onerror = () => { if (!settled) { settled = true; reject(tx.error || new Error('Snapshot read error')); } };\r\n      const store = tx.objectStore(STORE_NAME);\r\n      const request = store.get(SNAPSHOT_KEY);\r\n      request.onsuccess = () => {\r\n        if (settled) return;\r\n        settled = true;\r\n        resolve(request.result || null);\r\n      };\r\n      request.onerror = () => {\r\n        if (!settled) {\r\n          settled = true;\r\n          reject(request.error || new Error('Snapshot get failed'));\r\n        }\r\n      };\r\n    });\r\n  } catch (err) {\r\n    console.warn('Failed to load suspend snapshot', err);\r\n    return null;\r\n  }\r\n}\r\n\r\nfunction requestPersistentStorage() {\r\n  try {\r\n    if (navigator?.storage?.persist) {\r\n      navigator.storage.persist().catch(() => {});\r\n    }\r\n  } catch {}\r\n}\r\n\r\nfunction captureStackTrace() {\r\n  try {\r\n    throw new Error('ccc-storage-write');\r\n  } catch (err) {\r\n    return err?.stack || '';\r\n  }\r\n}\r\n\r\nfunction parseSlotFromKey(key) {\r\n  if (!key) return null;\r\n  const match = /:(\\d+)$/.exec(String(key));\r\n  if (!match) return null;\r\n  const slot = parseInt(match[1], 10);\r\n  return Number.isFinite(slot) && slot > 0 ? slot : null;\r\n}\r\n\r\nconst DEVTOOLS_CONSOLE_FRAME_RE = /\\bat <anonymous>:\\d+:\\d+\\b/;\r\n\r\nfunction isTrustedStorageStack(stack) {\r\n  if (typeof stack !== 'string' || stack.length === 0) return false;\r\n  \r\n  if (DEVTOOLS_CONSOLE_FRAME_RE.test(stack)) return false;\r\n\r\n  return true;\r\n}\r\n\r\nfunction notifySaveIntegrityOfStorageMutation(key, stack) {\r\n  if (typeof window === 'undefined') return;\r\n  if (!key) return;\r\n  const strKey = String(key);\r\n  if (!strKey.startsWith(STORAGE_PREFIX)) return;\r\n  if (strKey.startsWith(SLOT_SIGNATURE_PREFIX) || strKey.startsWith(SLOT_MOD_FLAG_PREFIX)) return;\r\n  const slot = parseSlotFromKey(strKey);\r\n  if (slot == null) return;\r\n  try {\r\n    const detail = {\r\n      key: strKey,\r\n      slot,\r\n      trusted: isTrustedStorageStack(stack),\r\n    };\r\n    window.dispatchEvent(new CustomEvent('saveIntegrity:storageMutation', { detail }));\r\n  } catch {}\r\n}\r\n\r\nfunction installStorageHooks() {\r\n  if (typeof localStorage === 'undefined') return;\r\n  try {\r\n    const proto = Object.getPrototypeOf(localStorage);\r\n    if (!proto || proto.__cccStoragePatched) return;\r\n\r\n    const originalSet = proto.setItem;\r\n    const originalRemove = proto.removeItem;\r\n    const originalClear = proto.clear;\r\n\r\nif (typeof originalSet === 'function') {\r\n  proto.setItem = function patchedSetItem(key, value) {\r\n    const stack = captureStackTrace();\r\n    const strKey = String(key);\r\n\r\n\tconst isTrackedGameKey =\r\n      this === localStorage &&\r\n      strKey.startsWith(STORAGE_PREFIX);\r\n\r\n\r\n    // Before we write, verify nothing in this slot changed behind our back.\r\n    if (isTrackedGameKey) {\r\n      try {\r\n        beforeSlotWrite(strKey);\r\n      } catch {}\r\n    }\r\n\r\n    let result;\r\n    try {\r\n      result = originalSet.apply(this, arguments);\r\n    } finally {\r\n      try {\r\n        if (isTrackedGameKey) {\r\n          markProgressDirty('setItem');\r\n          // Keep the in-memory expected state in sync with what we just wrote.\r\n          try {\r\n            afterSlotWrite(strKey, value);\r\n          } catch {}\r\n        }\r\n\r\n        // We still want integrity events for game keys, but we've already\r\n        // excluded slotSig/slotMod inside notifySaveIntegrityOfStorageMutation.\r\n        if (this === localStorage && strKey.startsWith(STORAGE_PREFIX)) {\r\n          notifySaveIntegrityOfStorageMutation(strKey, stack);\r\n        }\r\n      } catch {}\r\n    }\r\n    return result;\r\n  };\r\n}\r\n\r\n    if (typeof originalRemove === 'function') {\r\n      proto.removeItem = function patchedRemoveItem(key) {\r\n        const stack = captureStackTrace();\r\n        let result;\r\n        try {\r\n          result = originalRemove.apply(this, arguments);\r\n        } finally {\r\n          try {\r\n            if (this === localStorage && String(key).startsWith(STORAGE_PREFIX)) {\r\n              markProgressDirty('removeItem');\r\n              notifySaveIntegrityOfStorageMutation(key, stack);\r\n            }\r\n          } catch {}\r\n        }\r\n        return result;\r\n      };\r\n    }\r\n\r\n    if (typeof originalClear === 'function') {\r\n      proto.clear = function patchedClear() {\r\n        const stack = captureStackTrace();\r\n        let result;\r\n        try {\r\n          result = originalClear.apply(this, arguments);\r\n        } finally {\r\n          try {\r\n            if (this === localStorage) {\r\n              markProgressDirty('clear');\r\n              notifySaveIntegrityOfStorageMutation(null, stack);\r\n            }\r\n          } catch {}\r\n        }\r\n        return result;\r\n      };\r\n    }\r\n\r\n    Object.defineProperty(proto, '__cccStoragePatched', {\r\n      value: true,\r\n      enumerable: false,\r\n      configurable: false,\r\n      writable: false,\r\n    });\r\n  } catch (err) {\r\n    console.warn('Failed to patch Storage prototype for suspend safeguards', err);\r\n  }\r\n}\r\n\r\nfunction scheduleFlush(reason = 'idle') {\r\n  lastDirtyReason = reason || lastDirtyReason;\r\n  dirty = true;\r\n  if (flushTimer) return;\r\n  flushTimer = setTimeout(() => {\r\n    flushTimer = null;\r\n    if (!dirty) return;\r\n    const reasonToUse = lastDirtyReason;\r\n    dirty = false;\r\n    void flushBackupSnapshot(reasonToUse);\r\n  }, FLUSH_DEBOUNCE_MS);\r\n}\r\n\r\nfunction cancelFlushTimer() {\r\n  if (!flushTimer) return;\r\n  clearTimeout(flushTimer);\r\n  flushTimer = null;\r\n}\r\n\r\nexport function markProgressDirty(reason = 'dirty') {\r\n  try {\r\n    scheduleFlush(reason);\r\n  } catch {}\r\n}\r\n\r\nasync function performFlush(reason = 'manual') {\r\n  if (!canUseLocalStorage() || !canUseIndexedDb()) return false;\r\n  const snapshot = captureSnapshot();\r\n  if (!snapshot) return false;\r\n  snapshot.reason = reason;\r\n  pendingImmediateFlush = false;\r\n  const ok = await putSnapshot(snapshot);\r\n  if (!ok) {\r\n    // Keep dirty flag so another attempt can happen later\r\n    dirty = true;\r\n    scheduleFlush('retry');\r\n  }\r\n  return ok;\r\n}\r\n\r\nexport async function flushBackupSnapshot(reason = 'manual', { immediate = false } = {}) {\r\n  if (!canUseLocalStorage() || !canUseIndexedDb()) return false;\r\n  if (immediate) {\r\n    cancelFlushTimer();\r\n    dirty = false;\r\n    pendingImmediateFlush = true;\r\n    return performFlush(reason);\r\n  }\r\n  dirty = true;\r\n  lastDirtyReason = reason || lastDirtyReason;\r\n  return performFlush(reason);\r\n}\r\n\r\nfunction flushBeforeSuspend(reason) {\r\n  if (!canUseIndexedDb() || !canUseLocalStorage()) return;\r\n  cancelFlushTimer();\r\n  dirty = false;\r\n  pendingImmediateFlush = true;\r\n  void performFlush(reason);\r\n}\r\n\r\nfunction hasAnyPrefixedKeys() {\r\n  if (!canUseLocalStorage()) return false;\r\n  try {\r\n    for (let i = 0; i < localStorage.length; i++) {\r\n      const key = localStorage.key(i);\r\n      if (key && key.startsWith(STORAGE_PREFIX)) return true;\r\n    }\r\n  } catch {}\r\n  return false;\r\n}\r\n\r\nexport async function restoreFromBackupIfNeeded() {\r\n  if (restoreAttempted) return false;\r\n  restoreAttempted = true;\r\n  if (!canUseLocalStorage() || !canUseIndexedDb()) return false;\r\n\r\n  let shouldRestore = false;\r\n  try {\r\n    if (!hasAnyPrefixedKeys()) {\r\n      shouldRestore = true;\r\n    } else {\r\n      const activeSlot = localStorage.getItem(`${STORAGE_PREFIX}saveSlot`);\r\n      if (activeSlot) {\r\n        const coinKey = `${STORAGE_PREFIX}coins:${activeSlot}`;\r\n        if (localStorage.getItem(coinKey) == null) {\r\n          shouldRestore = true;\r\n        }\r\n      }\r\n    }\r\n  } catch {\r\n    shouldRestore = false;\r\n  }\r\n\r\n  if (!shouldRestore) return false;\r\n\r\n  const snapshot = await readSnapshot();\r\n  if (!snapshot?.data) return false;\r\n\r\n  let restored = false;\r\n  try {\r\n    for (const [key, value] of Object.entries(snapshot.data)) {\r\n      if (value == null) continue;\r\n      if (localStorage.getItem(key) === null) {\r\n        localStorage.setItem(key, value);\r\n        restored = true;\r\n      }\r\n    }\r\n  } catch (err) {\r\n    console.warn('Failed to restore snapshot into localStorage', err);\r\n  }\r\n\r\n  if (restored) {\r\n    markProgressDirty('restored');\r\n  }\r\n\r\n  return restored;\r\n}\r\n\r\nexport function installSuspendSafeguards() {\r\n  if (installAttempted) return;\r\n  installAttempted = true;\r\n  if (typeof window === 'undefined') return;\r\n\r\n  requestPersistentStorage();\r\n  installStorageHooks();\r\n\r\n  const onVisibilityChange = () => {\r\n    if (document.hidden) {\r\n      flushBeforeSuspend('visibility-hidden');\r\n    } else {\r\n      markProgressDirty('visibility-visible');\r\n    }\r\n  };\r\n\r\n  try { document.addEventListener('visibilitychange', onVisibilityChange, { passive: true }); } catch {}\r\n  try { window.addEventListener('pagehide', () => flushBeforeSuspend('pagehide'), { capture: true }); } catch {}\r\n  try { window.addEventListener('beforeunload', () => flushBeforeSuspend('beforeunload')); } catch {}\r\n  try { document.addEventListener('freeze', () => flushBeforeSuspend('freeze')); } catch {}\r\n  try { window.addEventListener('pageshow', () => markProgressDirty('pageshow')); } catch {}\r\n  try { window.addEventListener('focus', () => markProgressDirty('focus')); } catch {}\r\n  try { window.addEventListener('storage', (event) => {\r\n    if (!event) return;\r\n    if (event.storageArea !== localStorage) return;\r\n    if (event.key && !String(event.key).startsWith(STORAGE_PREFIX)) return;\r\n    markProgressDirty('storage-event');\r\n  }); } catch {}\r\n\r\n  markProgressDirty('boot');\r\n}\r\n\r\nexport function getSuspendMetadata() {\r\n  return {\r\n    pendingImmediateFlush,\r\n    dirty,\r\n    lastDirtyReason,\r\n  };\r\n}\r\n", "// js/main.js\r\n\r\nexport const DEBUG_PANEL_ACCESS = true; // I will change this to false for prod so the readme makes sense\r\nexport const IS_MOBILE = (() => {\r\n  if (typeof window === 'undefined') return false;\r\n\r\n  if (typeof window.IS_MOBILE !== 'undefined') {\r\n    return !!window.IS_MOBILE;\r\n  }\r\n\r\n  const detected = (window.matchMedia?.('(any-pointer: coarse)')?.matches) || ('ontouchstart' in window);\r\n  window.IS_MOBILE = detected;\r\n  return detected;\r\n})();\r\n\r\nlet initSlots;\r\nlet createSpawner;\r\nlet initCoinPickup;\r\nlet initHudButtons;\r\nlet installGhostTapGuard;\r\nlet bank;\r\nlet getHasOpenedSaveSlot;\r\nlet setHasOpenedSaveSlot;\r\nlet ensureStorageDefaults;\r\nlet getUpgAreaKey;\r\nlet computeUpgradeEffects;\r\nlet initXpSystem;\r\nlet onUpgradesChanged;\r\nlet registerPreloadedAudio;\r\nlet initPopups;\r\nlet installSuspendSafeguards;\r\nlet restoreSuspendBackup;\r\nlet markProgressDirty;\r\nlet flushBackupSnapshot;\r\nlet initResetSystemGame;\r\nlet initMutationSystem;\r\nlet getMutationCoinSprite;\r\nlet onMutationChangeGame;\r\nlet setDebugPanelAccess;\r\n\r\nconst pendingPreloadedAudio = [];\r\n\r\nfunction disableMobileZoomGestures() {\r\n  if (!IS_MOBILE) return;\r\n\r\n  let lastTouchEnd = 0;\r\n  const TOUCH_DELAY_MS = 350;\r\n\r\n  document.addEventListener('touchend', (event) => {\r\n    const now = performance.now();\r\n    if (now - lastTouchEnd <= TOUCH_DELAY_MS) {\r\n      event.preventDefault();\r\n    }\r\n    lastTouchEnd = now;\r\n  }, { passive: false });\r\n\r\n  document.addEventListener('gesturestart', (event) => {\r\n    event.preventDefault();\r\n  }, { passive: false });\r\n\r\n  document.addEventListener('dblclick', (event) => {\r\n    event.preventDefault();\r\n  }, { passive: false });\r\n}\r\n\r\ndisableMobileZoomGestures();\r\n\r\nexport const AREAS = {\r\n  MENU: 0,\r\n  STARTER_COVE: 1,\r\n};\r\n\r\nlet currentArea = AREAS.MENU;\r\nlet spawner = null;\r\n\r\n/* ---------------------------\r\n   LOADER UI (immediate black + progress)\r\n----------------------------*/\r\nconst nextFrame = () => new Promise(r => requestAnimationFrame(r));\r\nconst twoFrames = async () => { await nextFrame(); await nextFrame(); };\r\nfunction showLoader(text = 'Loading assets...') {\r\n  let root = document.getElementById('boot-loader');\r\n  if (!root) {\r\n    root = document.createElement('div');\r\n    root.id = 'boot-loader';\r\n    root.className = 'loading-screen';\r\n    document.body.appendChild(root);\r\n  }\r\n\r\n  root.innerHTML = '';\r\n  Object.assign(root.style, {\r\n    position: 'fixed',\r\n    inset: '0',\r\n    background: '#000',\r\n    color: '#fff',\r\n    display: 'grid',\r\n    placeItems: 'center',\r\n    zIndex: '2147483647',\r\n    opacity: '1', \r\n    transition: 'opacity 0.4s ease',\r\n  });\r\n\r\n  const wrap = document.createElement('div');\r\n  wrap.style.textAlign = 'center';\r\n  wrap.style.fontFamily = 'system-ui, -apple-system, Segoe UI, Roboto, sans-serif';\r\n\r\n  const label = document.createElement('div');\r\n  label.textContent = text;\r\n  Object.assign(label.style, {\r\n    fontSize: 'clamp(16px, 2.4vw, 22px)',\r\n    letterSpacing: '.04em',\r\n    opacity: '.92',\r\n  });\r\n\r\n  const bar = document.createElement('div');\r\n  Object.assign(bar.style, {\r\n    width: 'min(420px, 70vw)',\r\n    height: '10px',\r\n    background: 'rgba(255,255,255,.15)',\r\n    borderRadius: '999px',\r\n    margin: '12px auto 6px',\r\n    overflow: 'hidden',\r\n  });\r\n\r\n  const fill = document.createElement('div');\r\n  Object.assign(fill.style, {\r\n    width: '0%',\r\n    height: '100%',\r\n    background: '#fff',\r\n    transform: 'translateZ(0)',\r\n    transition: 'width .15s linear',\r\n  });\r\n\r\n  const pct = document.createElement('div');\r\n  pct.textContent = '0%';\r\n  Object.assign(pct.style, { fontSize: '12px', opacity: '.85' });\r\n\r\n  bar.appendChild(fill);\r\n  wrap.append(label, bar, pct);\r\n  root.appendChild(wrap);\r\n\r\n  const stuckMsg = document.createElement('div');\r\n  stuckMsg.textContent = 'If progress bar is stuck, try reloading the page.';\r\n  Object.assign(stuckMsg.style, {\r\n    marginTop: '16px',\r\n    fontSize: '14px',\r\n    opacity: '0',\r\n    transition: 'opacity 0.5s ease',\r\n    color: 'rgba(255,255,255,0.65)',\r\n  });\r\n  wrap.appendChild(stuckMsg);\r\n\r\n  const stuckTimeout = setTimeout(() => {\r\n    if (!root.__done) stuckMsg.style.opacity = '1';\r\n  }, 25000);\r\n\r\n  root.__mountedAt = performance.now();\r\n  root.__done = false;\r\n  root.__wrap = wrap;\r\n  root.__bar = bar;\r\n  root.__fill = fill;\r\n  root.__pct = pct;\r\n  root.__label = label;\r\n  root.__stuckMsg = stuckMsg;\r\n  root.__stuckTimeout = stuckTimeout;\r\n  return root;\r\n}\r\n\r\nfunction setLoaderProgress(loaderEl, fraction) {\r\n  if (!loaderEl || !loaderEl.__fill || !loaderEl.__pct) return;\r\n  const f = Math.max(0, Math.min(1, fraction || 0));\r\n  const pct = Math.round(f * 100);\r\n  loaderEl.__fill.style.width = pct + '%';\r\n  loaderEl.__pct.textContent = pct + '%';\r\n}\r\n\r\nfunction finishAndHideLoader(loaderEl) {\r\n  if (!loaderEl || loaderEl.__done) return;\r\n  loaderEl.__done = true;\r\n\r\n  const MIN_FINISHED_DWELL_MS = 500;\r\n  if (loaderEl.__label) loaderEl.__label.textContent = 'Finished loading assets';\r\n  loaderEl.offsetHeight;\r\n\r\n  setTimeout(() => {\r\n    loaderEl.style.opacity = '0';\r\n    const onEnd = () => {\r\n      loaderEl.remove();\r\n      document.documentElement.classList.remove('booting');\r\n    };\r\n    loaderEl.addEventListener('transitionend', onEnd, { once: true });\r\n    setTimeout(onEnd, 450);\r\n  }, MIN_FINISHED_DWELL_MS);\r\n}\r\n\r\n/* ---------------------------\r\n   PRELOADERS\r\n----------------------------*/\r\nasync function warmImage(url) {\r\n  const img = new Image();\r\n  img.src = url;\r\n\r\n  try {\r\n    if (img.decode) await img.decode();\r\n  } catch (_) {\r\n  }\r\n\r\n  await new Promise((resolve) => {\r\n    const ghost = document.createElement('img');\r\n    ghost.src = url;\r\n    ghost.alt = '';\r\n    ghost.style.cssText =\r\n      'position:fixed;left:-9999px;top:-9999px;width:1px;height:1px;opacity:0;pointer-events:none;';\r\n    document.body.appendChild(ghost);\r\n    requestAnimationFrame(() => { ghost.remove(); resolve(); });\r\n  });\r\n}\r\n\r\nfunction preloadImages(sources, onEach) {\r\n  return sources.map(src => new Promise(resolve => {\r\n    const img = new Image();\r\n    const done = () => { try { onEach?.(src); } catch {} resolve(src); };\r\n    img.onload = done;\r\n    img.onerror = done;\r\n    img.src = src;\r\n  }));\r\n}\r\n\r\nfunction preloadAudio(sources, onEach) {\r\n  return sources.map(url => new Promise(resolve => {\r\n    const a = new Audio();\r\n    const done = () => { try { onEach?.(url); } catch {} resolve(url); };\r\n    a.addEventListener('canplaythrough', () => {\r\n      if (typeof registerPreloadedAudio === 'function') {\r\n        registerPreloadedAudio(url, a);\r\n      } else {\r\n        pendingPreloadedAudio.push({ url, audio: a });\r\n      }\r\n      done();\r\n    }, { once: true });\r\n    a.addEventListener('error', done, { once: true });\r\n    a.preload = 'auto';\r\n    a.src = url;\r\n    a.load?.();\r\n  }));\r\n}\r\n\r\nfunction preloadFonts(onEach) {\r\n  if (document.fonts && document.fonts.ready) {\r\n    return [document.fonts.ready.then(() => { try { onEach?.('fonts'); } catch {} })];\r\n  }\r\n  return [Promise.resolve().then(() => { try { onEach?.('fonts'); } catch {} })];\r\n}\r\n\r\nasync function preloadAssetsWithProgress({ images = [], audio = [], fonts = true }, onProgress) {\r\n  const total = images.length + audio.length + (fonts ? 1 : 0);\r\n  if (total === 0) { onProgress?.(1); return; }\r\n  let done = 0;\r\n  const bump = () => { done++; onProgress?.(done / total); };\r\n\r\n  const tasks = [\r\n    ...preloadImages(images, bump),\r\n    ...preloadAudio(audio, bump),\r\n    ...(fonts ? preloadFonts(bump) : []),\r\n  ];\r\n\r\n  await Promise.all(tasks.map(p => p.catch(() => null)));\r\n}\r\n\r\n/* ---------------------------\r\n   GAME AREA CONTROL\r\n----------------------------*/\r\nfunction enterArea(areaID) {\r\n  if (currentArea === areaID) return;\r\n  currentArea = areaID;\r\n\r\n  const menuRoot = document.querySelector('.menu-root');\r\n  switch (areaID) {\r\n    case AREAS.STARTER_COVE: {\r\n      if (menuRoot) {\r\n        menuRoot.style.display = 'none';\r\n      }\r\n      document.body.classList.remove('menu-bg');\r\n      const gameRoot = document.getElementById('game-root');\r\n      if (gameRoot) {\r\n        gameRoot.hidden = false;\r\n        initHudButtons();\r\n      }\r\n\r\n      if (typeof initResetSystemGame === 'function') {\r\n        try { initResetSystemGame(); } catch {}\r\n      }\r\n\r\n      if (typeof initMutationSystem === 'function') {\r\n        try { initMutationSystem(); } catch {}\r\n      }\r\n\r\n      if (!spawner) {\r\n        spawner = createSpawner({\r\n          coinSrc: 'img/currencies/coin/coin.png',\r\n          coinSize: 40,\r\n          initialRate: 1,\r\n          surgeLifetimeMs: 1800,\r\n          surgeWidthVw: 22,\r\n        });\r\n        window.spawner = spawner;\r\n        const applyMutationSprite = () => {\r\n          if (!spawner || typeof spawner.setCoinSprite !== 'function') return;\r\n          try { spawner.setCoinSprite(getMutationCoinSprite?.()); } catch {}\r\n        };\r\n        applyMutationSprite();\r\n        onMutationChangeGame?.(applyMutationSprite);\r\n        initCoinPickup();\r\n                const applyUpgradesToSpawner = () => {\r\n                try {\r\n                        const areaKey = getUpgAreaKey();\r\n                        const eff = computeUpgradeEffects(areaKey);\r\n                        if (spawner && eff?.coinsPerSecondMult) {\r\n                          spawner.setRate(1 * eff.coinsPerSecondMult);\r\n                        }\r\n                  } catch {}\r\n                };\r\n                applyUpgradesToSpawner();\r\n                onUpgradesChanged(applyUpgradesToSpawner);\r\n\r\n      }\r\n      if (typeof initXpSystem === 'function') {\r\n        try { initXpSystem(); } catch {}\r\n      }\r\n      spawner.start();\r\n      if (spawner && typeof spawner.playEntranceWave === 'function') {\r\n        spawner.playEntranceWave();\r\n      }\r\n      break;\r\n    }\r\n\r\n    case AREAS.MENU: {\r\n      if (menuRoot) {\r\n        menuRoot.style.display = '';\r\n        menuRoot.removeAttribute('aria-hidden');\r\n      }\r\n      const gameRoot = document.getElementById('game-root');\r\n      if (gameRoot) gameRoot.hidden = true;\r\n\r\n      if (spawner) spawner.stop();\r\n      break;\r\n    }\r\n  }\r\n\r\n  try {\r\n    window.dispatchEvent(new CustomEvent('menu:visibilitychange', {\r\n      detail: { visible: areaID === AREAS.MENU },\r\n    }));\r\n  } catch {}\r\n}\r\n\r\n/* ---------------------------\r\n   BOOT FLOW\r\n----------------------------*/\r\ndocument.addEventListener('DOMContentLoaded', async () => {\r\n  const loader = showLoader('Loading assets...');\r\n\r\n  await nextFrame();\r\n\r\n  const modulePromise = Promise.all([\r\n    import('./util/slots.js'),\r\n    import('./game/spawner.js'),\r\n    import('./game/coinPickup.js'),\r\n    import('./ui/hudButtons.js'),\r\n    import('./util/storage.js'),\r\n    import('./util/saveIntegrity.js'),\r\n    import('./game/upgrades.js'),\r\n    import('./util/audioCache.js'),\r\n    import('./game/xpSystem.js'),\r\n    import('./ui/merchantDelve/resetTab.js'),\r\n    import('./game/mutationSystem.js'),\r\n    import('./ui/popups.js'),\r\n    import('./util/suspendSafeguard.js'),\r\n    import('./util/ghostTapGuard.js'),\r\n    import('./util/debugPanel.js'),\r\n  ]);\r\n\r\n  const ASSET_MANIFEST = {\r\n    images: [\r\n      'img/currencies/coin/coin.png',\r\n      'img/currencies/coin/coin_base.png',\r\n      'img/currencies/coin/coin_plus_base.png',\r\n      'img/currencies/book/book.png',\r\n      'img/currencies/book/book_base.png',\r\n      'img/currencies/book/book_plus_base.png',\r\n\t  'img/currencies/gold/gold.png',\r\n      'img/currencies/gold/gold_base.png',\r\n      'img/currencies/gold/gold_plus_base.png',\r\n      'img/sc_upg_icons/faster_coins.png',\r\n      'img/sc_upg_icons/book_val1.png',\r\n      'img/sc_upg_icons/coin_val1.png',\r\n      'img/sc_upg_icons/xp_val1.png',\r\n\t  'img/sc_upg_icons/faster_coins2.png',\r\n      'img/sc_upg_icons/coin_val2.png',\r\n      'img/sc_upg_icons/xp_val2.png',\r\n\t  'img/sc_upg_icons/mp_val1.png',\r\n\t  'img/sc_upg_icons/magnet.png',\r\n\t  'img/sc_upg_icons/xp_val_hm.png',\r\n      'img/stats/xp/xp.png',\r\n      'img/stats/xp/xp_base.png',\r\n      'img/stats/xp/xp_plus_base.png',\r\n\t  'img/stats/mp/mp.png',\r\n      'img/stats/mp/mp_base.png',\r\n      'img/stats/mp/mp_plus_base.png',\r\n\t  'img/misc/forge.png',\r\n      'img/misc/locked.png',\r\n      'img/misc/locked_base.png',\r\n      'img/misc/maxed.png',\r\n\t  'img/misc/merchant.png',\r\n      'img/misc/mysterious.png',\r\n      ...Array.from({ length: 25 }, (_, i) => `img/mutations/m${i + 1}.png`),\r\n    ],\r\n    audio: [\r\n      'sounds/coin_pickup.mp3',\r\n      'sounds/wave_spawn.mp3',\r\n      'sounds/merchant_typing.mp3',\r\n      'sounds/purchase_upg.mp3',\r\n\t  'sounds/forge_reset.mp3',\r\n\t  'sounds/evolve_upg.mp3',\r\n    ],\r\n    fonts: true,\r\n  };\r\n\r\n  let progress = 0;\r\n  const assetsPromise = preloadAssetsWithProgress(ASSET_MANIFEST, f => {\r\n    progress = f;\r\n    setLoaderProgress(loader, f);\r\n  });\r\n\r\n  const [\r\n    slotsModule,\r\n    spawnerModule,\r\n    coinPickupModule,\r\n    hudButtonsModule,\r\n    storageModule,\r\n    saveIntegrityModule,\r\n    upgradesModule,\r\n    audioCacheModule,\r\n    xpModule,\r\n    resetModule,\r\n    mutationModule,\r\n    popupModule,\r\n    safetyModule,\r\n    guardModule,\r\n    debugPanelModule,\r\n  ] = await modulePromise;\r\n\r\n  ({ initSlots } = slotsModule);\r\n  ({ createSpawner } = spawnerModule);\r\n  ({ initCoinPickup } = coinPickupModule);\r\n  ({ initHudButtons } = hudButtonsModule);\r\n  ({ bank, getHasOpenedSaveSlot, setHasOpenedSaveSlot, ensureStorageDefaults } = storageModule);\r\n  void saveIntegrityModule;\r\n  ({ getCurrentAreaKey: getUpgAreaKey, computeUpgradeEffects, onUpgradesChanged } = upgradesModule);\r\n  ({ registerPreloadedAudio } = audioCacheModule);\r\n  ({ initXpSystem } = xpModule);\r\n  ({ initResetSystem: initResetSystemGame } = resetModule);\r\n  ({ initMutationSystem, getMutationCoinSprite, onMutationChange: onMutationChangeGame } = mutationModule);\r\n  ({ initPopups } = popupModule);\r\n  ({ installSuspendSafeguards, restoreFromBackupIfNeeded: restoreSuspendBackup, markProgressDirty, flushBackupSnapshot } = safetyModule);\r\n  ({ installGhostTapGuard } = guardModule);\r\n  ({ setDebugPanelAccess } = debugPanelModule);\r\n\r\n  window.bank = bank;\r\n\r\n  if (typeof registerPreloadedAudio === 'function' && pendingPreloadedAudio.length) {\r\n    while (pendingPreloadedAudio.length) {\r\n      const entry = pendingPreloadedAudio.shift();\r\n      if (!entry) continue;\r\n      try { registerPreloadedAudio(entry.url, entry.audio); }\r\n      catch {}\r\n    }\r\n  }\r\n\r\n  installGhostTapGuard?.();\r\n  installSuspendSafeguards?.();\r\n  if (typeof setDebugPanelAccess === 'function') {\r\n    setDebugPanelAccess(DEBUG_PANEL_ACCESS);\r\n    window.setDebugPanelAccess = setDebugPanelAccess;\r\n  }\r\n\r\n  try {\r\n    await restoreSuspendBackup?.();\r\n  } catch {}\r\n\r\n  await assetsPromise;\r\n\r\n  await twoFrames();\r\n  document.documentElement.classList.remove('booting');\r\n\r\n  await nextFrame();\r\n\r\n  finishAndHideLoader(loader);\r\n\r\n  await Promise.all([ // fixes some image preload issue on mobile\r\n    warmImage('img/currencies/coin/coin_plus_base.png'),\r\n    warmImage('img/stats/xp/xp_plus_base.png'),\r\n\twarmImage('img/stats/mp/mp_plus_base.png'),\r\n  ]);\r\n\r\n  ensureStorageDefaults();\r\n  markProgressDirty?.('ensure-defaults');\r\n  initPopups();\r\n\r\n  const titleEl = document.getElementById('panel-title');\r\n  if (getHasOpenedSaveSlot()) {\r\n    document.body.classList.add('has-opened');\r\n    if (titleEl) titleEl.style.opacity = '0';\r\n  } else {\r\n    if (titleEl) titleEl.style.opacity = '1';\r\n  }\r\n\r\n  initSlots(() => {\r\n    setHasOpenedSaveSlot(true);\r\n    document.body.classList.add('has-opened');\r\n    if (titleEl) titleEl.style.opacity = '0';\r\n    enterArea(AREAS.STARTER_COVE);\r\n    markProgressDirty?.('slot-entered');\r\n  });\r\n\r\n  if (typeof window !== 'undefined' && flushBackupSnapshot) {\r\n    try {\r\n      window.cccRequestBackup = () => flushBackupSnapshot('manual', { immediate: true });\r\n    } catch {}\r\n  }\r\n});\r\n", "import './js/main.js';\r\n"],
  "mappings": "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AAC,IAAI,IAAI,EAC3H,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,KAAK,EAAE,CAAC,IAAI,KAAK,EAAE,CAAC,IAAI,KAAK,EAAE,CAAC,IAAI,IAAI,EAC3H,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,KAAK,EAAE,CAAC,IAAI,KAAK,EAAE,CAAC,IAAI,KAAK,EAAE,CAAC,IAAI,IAAI,EAC3H,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,KAAK,EAAE,CAAC,IAAI,KAAK,EAAE,CAAC,IAAI,KAAK,EAAE,CAAC,IAAI,IAAI,EAC3H,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,KAAK,EAAE,CAAC,IAAI,KAAK,EAAE,CAAC,IAAI,KAAK,EAAE,CAAC,IAAI,IAAI,EAC3H,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,KAAK,EAAE,CAAC,IAAI,KAAK,EAAE,CAAC,IAAI,KAAK,EAAE,CAAC,IAAI,IAAI,EAC3H,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,MAAM,EAAE,CAAC,IAAI,KAAK,EAAE,CAAC,GAAG,KAAK,EAAE,CAAC,GAAG,KAAK,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",
  "names": ["BigNum", "init_bigNum", "__esmMin", "_BigNum", "sig", "e", "p", "base", "off", "ee", "#normalize", "n", "str", "s", "match", "intPart", "fracPart", "expPart", "exponent", "digits", "pStr", "sigStr", "eStr", "pp", "baseStr", "offset", "caret", "offStr", "eNum", "input", "trimmed", "offsetSuffix", "b", "expCmp", "#compareExponent", "aligned", "#alignSig", "diffSig", "#expObj", "aPlain", "bPlain", "diff", "#pow10", "k", "#adjustExponent", "delta", "prev", "next", "applied", "leftover", "#totalExponentBigInt", "other", "a", "#expDiff", "absDiff", "limit", "#offsetAsNumber", "offNum", "#effectiveExponentNumber", "shift", "q", "diffNum", "out", "r", "baseSum", "offsetSum", "thisIsZero", "otherIsZero", "x", "maxScale", "fracRaw", "frac", "scale", "mult", "numer", "exp", "intDigits", "drop", "newSig", "numerBigInt", "nb", "head", "tail", "mant", "E", "extraZeros", "localeInt", "s", "num", "NF_INT", "addOneDigitString", "str", "carry", "a", "i", "d", "formatExponentString", "rawDigits", "sign", "ds", "n", "E", "exp", "suffix", "SUFFIX_BY_EXP", "intDigits", "decimals", "totalDigits", "head", "intStr", "fracStr", "mantInt", "mantFrac", "formatExponentChain", "expRaw", "topSign", "m", "int", "frac", "sign2", "kDigits", "kGe303", "k", "four", "mant", "sign2Prefix", "mantissaFourDigits", "sci", "mantissa", "rawExp", "formatNumber", "bn", "BigNum", "SUFFIX_ENTRIES", "init_numFormat", "__esmMin", "init_bigNum", "storage_exports", "__export", "CURRENCIES", "KEYS", "STORAGE_PREFIX", "bank", "clearAllStorage", "ensureCurrencyDefaults", "ensureMultiplierDefaults", "ensureStorageDefaults", "getActiveSlot", "getCurrency", "getCurrencyMultiplierBN", "getHasOpenedSaveSlot", "getSlotModifiedFlagKey", "getSlotSignature", "getSlotSignatureKey", "hasModifiedSave", "isCurrencyLocked", "markSaveSlotModified", "onCurrencyChange", "peekCurrency", "primeStorageWatcherSnapshot", "setActiveSlot", "setCurrency", "setCurrencyMultiplierBN", "setHasOpenedSaveSlot", "setSlotSignature", "watchStorageKey", "normalizeSlotValue", "slot", "n", "slotSignatureKey", "normalized", "SLOT_SIGNATURE_PREFIX", "slotModifiedKey", "SLOT_MODIFIED_PREFIX", "notifyCurrencySubscribers", "detail", "currencyChangeSubscribers", "entry", "handler", "key", "ensureStorageWatcherTimer", "storageWatcherTimer", "storageWatchers", "runStorageWatchers", "STORAGE_WATCH_INTERVAL_MS", "stopStorageWatcherTimerIfIdle", "parseWith", "raw", "valuesEqual", "a", "b", "entries", "parsed", "rawChanged", "valueChanged", "previousValue", "previousRaw", "parse", "equals", "onChange", "emitCurrentValue", "set", "rawValue", "bigNumEquals", "BigNum", "parseBigNumOrZero", "cleanupCurrencyWatchers", "currencyWatcherCleanup", "stop", "bindCurrencyWatchersForSlot", "currencyWatcherBoundSlot", "currencyKey", "storageKey", "value", "meta", "initCurrencyStorageWatchers", "v", "keyFor", "base", "isDebugLocked", "signature", "k", "km", "getMultiplierScaled", "theor", "scaledFromIntBN", "setMultiplierScaled", "delta", "previous", "prev", "deltaBn", "bn", "expectedRaw", "persistedRaw", "effectiveRaw", "effective", "intBN", "MULT_SCALE", "intFromScaled", "theorBN", "scaled", "MULT_SCALE_TAG", "payload", "theoreticalBN", "existingRaw", "intBNValue", "sub", "makeCurrencyHandle", "fn", "x", "formatNumber", "amt", "next", "val", "current", "factor", "pct", "amount", "mult", "baseAmount", "inc", "PREFIX", "init_storage", "__esmMin", "init_bigNum", "init_numFormat", "_", "prop", "setDeleteMode", "on", "deleteMode", "btn", "card", "removeAllKeysForSlot", "slot", "re", "toRemove", "i", "k", "initSlotsManager", "initialized", "manageBtn", "grid", "e", "onPointerDownCapture", "onClickCapture", "getActiveSlot", "KEYS", "refreshSlotsView", "init_slotsManager", "__esmMin", "init_storage", "init_slots", "slots_exports", "__export", "initSlots", "refreshSlotsView", "hasSlotData", "slot", "coinsTextFor", "peekCurrency", "renderSlotCards", "btn", "idx", "titleEl", "onSelect", "cards", "slotNum", "ev", "setActiveSlot", "ensureCurrencyDefaults", "ensureMultiplierDefaults", "setHasOpenedSaveSlot", "init_slots", "__esmMin", "init_bigNum", "init_slotsManager", "init_storage", "audioCache_exports", "__export", "registerPreloadedAudio", "takePreloadedAudio", "src", "element", "key", "normalize", "cache", "el", "init_audioCache", "__esmMin", "syncXpMpHudLayout", "hud", "xpEl", "mpEl", "xpVisible", "mpVisible", "init_hudLayout", "__esmMin", "xpSystem_exports", "__export", "addExternalCoinMultiplierProvider", "addExternalXpGainMultiplierProvider", "addXp", "broadcastXpChange", "computeCoinMultiplierForXpLevel", "getXpLevelStorageKey", "getXpRequirementForXpLevel", "getXpState", "initXpSystem", "isXpSystemUnlocked", "onXpChange", "refreshCoinMultiplierFromXpLevel", "resetXpProgress", "setExternalBookRewardProvider", "setExternalCoinMultiplierProvider", "setExternalXpGainMultiplierProvider", "unlockXpSystem", "slot", "getActiveSlot", "resolvedSlot", "KEY_XP_LEVEL", "bigIntToFloatApprox", "value", "str", "len", "headDigits", "head", "exponent", "scaled", "bigNumIsInfinite", "bn", "bigNumIsZero", "bigNumToFiniteNumber", "sci", "match", "mant", "exp", "num", "logBigNumToNumber", "maxLog10Bn", "computeBonusCountBn", "levelBn", "BigNum", "divided", "TEN_DIVISOR_DECIMAL", "floored", "bnOne", "computeLevelLogTerm", "LOG_STEP_DECIMAL", "computeBonusLogTerm", "bonusCount", "LOG_DECADE_BONUS_DECIMAL", "approximateCoinMultiplierFromBigNum", "infinityRequirementBn", "totalLog", "bonusLog", "logNumber", "approx", "bigNumFromLog10", "levelTerm", "combined", "enforceXpInfinityInvariant", "levelIsInf", "xpState", "progIsInf", "inf", "requirementBn", "bank", "notifyXpSubscribers", "detail", "xpChangeSubscribers", "entry", "handler", "bnZero", "cloneBigNumSafe", "bigNumEqualsSafe", "a", "b", "cleanupXpStorageWatchers", "xpStorageWatcherCleanups", "stop", "parseBigNumOrZero", "raw", "handleExternalXpStorageChange", "reason", "handlingExternalXpStorage", "xpStorageWatcherSlot", "prev", "ensureStateLoaded", "updateHud", "syncCoinMultiplierWithXpLevel", "current", "unlockedChanged", "levelChanged", "progressChanged", "xpLevelsGained", "xpAdded", "bindXpStorageWatchersForSlot", "watch", "key", "options", "watchStorageKey", "KEY_UNLOCK", "KEY_PROGRESS", "ensureXpStorageWatchers", "xpStorageWatchersInitialized", "stripHtml", "approxLog10", "sig", "expBase", "expOffset", "totalExponent", "mantissaLog", "trimmed", "digits", "headSlice", "ensureExactRequirementCacheUpTo", "levelBigInt", "target", "EXACT_REQUIREMENT_CACHE_LEVEL", "highestCachedExactLevel", "currentLevel", "currentRequirement", "xpRequirementCache", "nextLevel", "nextRequirement", "log10Value", "fractional", "mantissa", "exponentStr", "approximateRequirementFromLevel", "baseLevel", "baseRequirement", "baseLevelBn", "baseLog", "deltaLevel", "targetBonus", "baseBonus", "deltaBonus", "progressRatio", "progressBn", "requirement", "reqIsInf", "logProg", "logReq", "diff", "ratio", "ensureHudRefs", "hudRefs", "xpRequirementForXpLevel", "xpLevelInput", "xpLvlBn", "levelPlain", "targetLevelInfo", "targetLevel", "targetKey", "cachedExact", "approximate", "updateXpRequirement", "resetLockedXpState", "xpLevelBigIntInfo", "xpLevelValue", "plain", "force", "multApi", "levelInfo", "levelIsInfinite", "levelStorageKey", "lastSyncedCoinLevelWasInfinite", "lastSyncedCoinUsedApproximation", "lastSyncedCoinLevel", "lastSyncedCoinApproxKey", "multiplierBn", "EXACT_COIN_LEVEL_LIMIT", "working", "iterations", "i", "levelAdd", "finalMultiplier", "providers", "coinMultiplierProviders", "externalCoinMultiplierProvider", "provider", "maybe", "multIsInf", "lastSlot", "stateLoaded", "unlockedRaw", "persistState", "expected", "persisted", "unlocked", "level", "progress", "rawLevel", "rawProgress", "primeStorageWatcherSnapshot", "handleXpLevelUpRewards", "reward", "externalBookRewardProvider", "syncedLevelInfo", "container", "bar", "fill", "reqHtml", "formatNumber", "reqPlain", "syncXpMpHudLayout", "pct", "currentHtml", "currPlain", "forceReload", "keepUnlock", "wasUnlocked", "amount", "silent", "inc", "xpGainMultiplierProviders", "externalXpGainMultiplierProvider", "applyStatMultiplierOverride", "progressIsInf", "gainIsInf", "guard", "limit", "syncedLevelAfterAdd", "detailOverrides", "xpLevel", "levelValue", "xpLevelBn", "fn", "KEY_PREFIX", "LOG_STEP", "LOG_DECADE_BONUS", "init_xpSystem", "__esmMin", "init_bigNum", "init_storage", "init_debugPanel", "init_numFormat", "init_hudLayout", "resetTab_exports", "__export", "canPerformForgeReset", "computeForgeGoldFromInputs", "computePendingForgeGold", "getForgeDebugOverrideState", "hasDoneForgeReset", "initResetPanel", "initResetSystem", "isForgeUnlocked", "onForgeUpgradeUnlocked", "performForgeReset", "setForgeDebugOverride", "setForgeResetCompleted", "updateResetPanel", "playForgeResetSound", "forgeResetAudio", "FORGE_RESET_SOUND_SRC", "resetPendingGoldSignature", "pendingGoldInputSignature", "getPendingGoldWithMultiplier", "bank", "resetState", "cleanupWatchers", "watchers", "stop", "ensureValueListeners", "coinChangeUnsub", "onCurrencyChange", "detail", "CURRENCIES", "recomputePendingGold", "xpChangeUnsub", "onXpChange", "levelToNumber", "levelBn", "plain", "num", "approx", "approxLog10BigNum", "getXpLevelBn", "state", "getXpState", "bnZero", "computeForgeGold", "coinsBn", "logCoins", "BN", "logScaled", "pow2", "bigNumFromLog10", "levelNum", "levelFactor", "pow14", "bnOne", "floorLog", "pow115", "total", "floored", "ensureResetSlot", "slot", "getActiveSlot", "value", "FORGE_COMPLETED_KEY", "primeStorageWatcherSnapshot", "getForgeDebugOverride", "raw", "FORGE_DEBUG_OVERRIDE_KEY", "normalized", "setForgeUnlocked", "FORGE_UNLOCK_KEY", "readPersistentFlags", "ensurePersistentFlagsPrimed", "bindStorageWatchers", "watchersBoundSlot", "watchStorageKey", "next", "getPendingInputSignature", "coins", "level", "coinSig", "levelSig", "force", "signature", "meetsLevelRequirement", "canAccessForgeTab", "override", "getLevelNumber", "AREA_KEYS", "UPGRADE_TIES", "MIN_FORGE_LEVEL", "resetUpgrades", "upgrades", "getUpgradesForArea", "upg", "tieKey", "setLevel", "reward", "withMultiplier", "resetXpProgress", "initMutationSystem", "unlockMutationSystem", "formatBn", "formatNumber", "setLayerActive", "layer", "key", "buildPanel", "panelEl", "RESET_ICON_SRC", "GOLD_ICON_SRC", "btn", "updatePendingDisplay", "amountEl", "updateStatusDisplay", "el", "updateActionState", "bindGlobalEvents", "initialized", "isMutationUnlocked", "mutationUnsub", "onMutationChange", "sprite", "getMutationCoinSprite", "nextSlot", "init_resetTab", "__esmMin", "init_bigNum", "init_storage", "init_numFormat", "init_xpSystem", "init_upgrades", "init_mutationSystem", "BigNum", "upgrades_exports", "__export", "AREA_KEYS", "HM_EVOLUTION_INTERVAL", "MAX_LEVEL_DELTA", "UPGRADE_TIES", "approxLog10BigNum", "bigNumFromLog10", "buyMax", "buyOne", "buyTowards", "clearPermanentUpgradeUnlock", "computeDefaultUpgradeCost", "computeUpgradeEffects", "costToBuyOne", "estimateFlatBulk", "estimateGeometricBulk", "evaluateBulkPurchase", "evolveUpgrade", "formatMultForUi", "getCurrentAreaKey", "getHmEvolutions", "getHmNextMilestoneLevel", "getIconUrl", "getLevel", "getLevelNumber", "getMagnetLevel", "getMpValueMultiplierBn", "getUpgrade", "getUpgradeLockState", "getUpgradesForArea", "markUpgradePermanentlyUnlocked", "normalizeBigNum", "onUpgradesChanged", "peekNextPrice", "setLevel", "upgradeUiModel", "hasScaling", "upg", "scaling", "ensureUpgradeScaling", "c0", "BigNum", "c1", "cF", "isInfinityLevelForScaled", "lvlBn", "bn", "log10", "SCALED_INFINITY_LVL_LOG10", "value", "storage", "parts", "sigStr", "expPart", "offsetStr", "caret", "baseExp", "offset", "sigNum", "expSum", "log10Value", "p", "intPart", "frac", "mantissa", "sig", "exp", "shopStatusRank", "status", "SHOP_REVEAL_STATUS_ORDER", "classifyUpgradeStatus", "lockState", "upgradeRevealKey", "areaKey", "normArea", "normalizeAreaKey", "tieKey", "normalizeUpgradeTie", "rawId", "normalizeUpgradeId", "idStr", "trimmed", "upgradeLegacyRevealKey", "migrateUpgradeStateKey", "state", "fromKey", "toKey", "ensureShopRevealState", "slot", "getActiveSlot", "slotKey", "shopRevealStateCache", "parsed", "raw", "SHOP_REVEAL_STATE_KEY_BASE", "obj", "saveShopRevealState", "ensureShopPermaUnlockState", "shopPermaUnlockStateCache", "SHOP_PERMA_UNLOCK_KEY_BASE", "saveShopPermaUnlockState", "ensureShopPermaMystState", "shopPermaMystStateCache", "SHOP_PERMA_MYST_KEY_BASE", "saveShopPermaMystState", "markUpgradePermanentlyMysterious", "key", "legacyKey", "isUpgradePermanentlyMysterious", "permaState", "revealState", "upgId", "invalidateUpgradeState", "notifyChanged", "isUpgradePermanentlyUnlocked", "determineLockState", "ctx", "upgRef", "area", "SPECIAL_LOCK_STATE_TIES", "LOCKED_UPGRADE_ICON_DATA_URL", "currentLevel", "xpUnlocked", "safeIsXpUnlocked", "determineUnlockXpLockState", "safeHasMetMerchant", "revealText", "MYSTERIOUS_UPGRADE_ICON_DATA_URL", "HIDDEN_UPGRADE_TITLE", "xp31", "xpBn", "currentXpLevelBigNum", "levelBigNumToNumber", "hasDoneForgeReset", "LOCKED_UPGRADE_TITLE", "tieValue", "isXpAdjacentUpgrade", "XP_MYSTERY_UPGRADE_TIES", "normalizedId", "numericId", "idKey", "areaCandidates", "candidate", "XP_MYSTERY_LEGACY_KEYS", "isXpSystemUnlocked", "MERCHANT_MET_KEY_BASE", "getXpState", "bookValueMultiplierBn", "level", "L", "ensureLevelBigNum", "plain", "lvl", "normalizedUpgradeLevel", "levelValue", "maxSafe", "clamped", "hundredPercentPerLevelMultiplier", "asBigInt", "mergeLockStates", "base", "override", "merged", "keys", "normalized", "num", "digits", "lead", "leadNum", "leadLen", "exponent", "shift", "approx", "plainLevelDelta", "nextLevelBn", "prevLevelBn", "next", "prev", "nextPlain", "prevPlain", "diff", "decimalMultiplierString", "out", "baseCost", "upgType", "baseBn", "levelNumber", "evolutions", "preset", "resolveDefaultScalingRatio", "ratio", "costAtLevelUsingScaling", "normalizeHmEvolutionCount", "n", "activeEvolutionsForUpgrade", "active", "hmLevelCapForEvolutions", "cycles", "cap", "capBn", "formatBigNumAsHtml", "formatBigNumAsPlain", "hmMilestoneHits", "levelBn", "milestoneLevel", "interval", "delta", "hmMilestoneMultiplier", "multiplier", "hits", "result", "i", "resolveHmMilestones", "DEFAULT_AREA_KEY", "milestones", "normalizedArea", "safeMultiplyBigNum", "factor", "f", "applyHmEvolutionMeta", "capFmtHtml", "capFmtText", "computeHmMultipliers", "selfMult", "xpMult", "coinMult", "mpMult", "m", "mult", "target", "HM_EVOLUTION_EFFECT_MULT_BN", "hmNextMilestoneLevel", "best", "nextHits", "targetBi", "increment", "tryPreset", "name", "presetName", "presetFn", "DEFAULT_SCALING_PRESETS", "providedScaling", "ratioStr", "ratioLog10", "pow", "ratioLn", "ratioMinus1", "defaultPreset", "resolved", "baseLog10", "price", "anchor", "step", "logExpMinus1", "x", "negExp", "logSeriesTotal", "startLevel", "count", "startLn", "LN10", "growth", "numerLn", "denomLn", "totalCostBigNum", "targetLevel", "total", "tailCount", "headCount", "headLog", "tailStart", "totalLog", "log10OnePlusPow10", "nextDownPositive", "FLOAT64_VIEW", "INT64_VIEW", "safeDecrementCount", "dec", "countToBigNum", "floored", "str", "calculateBulkPurchase", "walletBn", "maxLevels", "options", "zero", "fastOnly", "startLevelNum", "maxLevelsNum", "capRoom", "MAX_LEVEL_DELTA_LIMIT", "room", "nextPrice", "remainingToHundred", "limit", "spent", "newSpent", "nextLevel", "reachedCap", "countBn", "nextStartLevel", "toUpgradeBigNum", "tail", "totalCount", "totalSpent", "walletLog", "firstPrice", "startPriceLog", "hardLimit", "lo", "hi", "spentLog", "doubled", "steps", "mid", "isConstantCost", "secondPrice", "farPrice", "farProbe", "roomBn", "ratioMinus1Log", "approxCount", "EPS", "tuneSteps", "MAX_TUNE_STEPS", "overshoot", "reduced", "safeTimes2", "y", "hiLog", "left", "right", "midLog", "guard", "decremented", "nextCost", "nextLog", "canUseNumericFinal", "finalLevel", "computeBulkMeta", "basePrice", "logBase", "logNext", "ratioLog", "denom", "priceBn", "wPlain", "pPlain", "q", "levelCapToNumber", "wl", "pl", "meta", "priceLog", "numerator", "hiBound", "iter", "nextPriceLog", "fallback", "formatNumber", "safeCloneBigNum", "emitUpgradeLevelChange", "prevLevelNum", "nextLevelNum", "oldBn", "newBn", "payload", "nmCostBN", "syncBookCurrencyMultiplierFromUpgrade", "levelOverride", "multHandle", "bank", "resolvedLevel", "storedLevel", "getAreaUpgradeOrder", "areaUpgradeOrderCache", "order", "rank", "REGISTRY", "normalizeAreaStateRecordOrder", "arr", "baseRank", "entries", "rec", "idx", "needsSort", "curr", "a", "b", "entry", "parseUpgradeStateArray", "readStateFromAvailableStorage", "includeLocal", "storages", "type", "getItem", "cacheAreaState", "areaStateMemoryCache", "areaStatePayloadCache", "clearCachedAreaState", "storageKey", "clearCachedUpgradeStates", "prefix", "upgradeStateCache", "keyForArea", "cleanupUpgradeStorageWatchers", "upgradeStorageWatcherCleanup", "stop", "handleUpgradeStorageChange", "rawPayload", "rawChanged", "valueChanged", "bindUpgradeStorageWatchersForSlot", "upgradeStorageWatcherBoundSlot", "watchStorageKey", "loadAreaState", "forceReload", "backupKey", "primary", "backup", "saveAreaState", "backupPayload", "storagesChecked", "storageHadValue", "cached", "cachedPayload", "stateArr", "primeStorageWatcherSnapshot", "resolveUpgradeIdentifier", "upgradeTieLookup", "requestedArea", "upgradeCacheKey", "resolvedId", "ensureUpgradeState", "u", "recNeedsSave", "hmEvolutions", "clampedStorage", "normalizedLvlStorage", "costLevelStorage", "nextCostStale", "nextCostBn", "infCap", "commitUpgradeState", "inBn", "currentLvlStorage", "hmUpg", "hmLvl", "computeUpgradeLockStateFor", "xpLevelBn", "xpLevel", "baseState", "isXpAdj", "xpRevealText", "unlockXpVisible", "meetText", "targetId", "custom", "revealKey", "permaUnlocked", "permaMystState", "hyphenKey", "needsRevealSave", "needsPermaSave", "needsPermaMystSave", "hiddenState", "isForgePlaceholder", "FORGE_PLACEHOLDER_TIES", "storedStatus", "xpReached31", "storedRank", "currentStatus", "currentRank", "applyStoredMysterious", "snap", "reasonText", "shouldSave", "normalizedStatus", "isForgePlaceholderForSave", "xpReached31Now", "isUpgradeLocked", "isHmReadyToEvolve", "safeEvol", "lvlNum", "nextBn", "nextNum", "clampToCap", "resetHmEvolutions", "desiredBn", "normalizeUpgradeIconPath", "iconPath", "path", "segments", "seg", "segment", "SHARED_ROOTS", "lower", "rawPrice", "costType", "walletEntry", "haveRaw", "nextEvol", "walletValue", "wallet", "prevLevel", "prevLevelStorage", "targetLevelBn", "purchased", "plainDelta", "nextStorage", "outcome", "remaining", "maxRoom", "ups", "cpsMult", "coinValueMultBn", "xpGainMultBn", "bookRewardMultBn", "bonus", "BASE_CPS", "registerXpUpgradeEffects", "initResetSystem", "addExternalCoinMultiplierProvider", "baseMultiplier", "lvl1", "safeLvl1", "lvl2", "addExternalXpGainMultiplierProvider", "baseGain", "gain", "setExternalBookRewardProvider", "baseReward", "refreshCoinMultiplierFromXpLevel", "cb", "listeners", "lvlFmtHtml", "lvlFmtText", "lvlCapBn", "lvlCapFmtHtml", "lvlCapFmtText", "nextPriceFmt", "have", "locked", "displayTitle", "displayDesc", "hmMilestones", "effect", "iconUrl", "BOOK_VALUE_TIE_KEY", "BN", "toBn", "E", "FLOAT64_BUFFER", "init_upgrades", "__esmMin", "init_storage", "init_bigNum", "init_numFormat", "init_xpSystem", "init_mutationSystem", "init_resetTab", "pNum", "pStr", "logL", "logTerm", "xNum", "xStr", "baseNum", "log10b", "val", "approxLvl", "_", "newLevel", "newLevelBn", "unlockXpSystem", "onForgeUpgradeUnlocked", "units", "unitsText", "baseMult", "MERCHANT_DIALOGUES", "init_merchantDialogues", "__esmMin", "ghostTapGuard_exports", "__export", "DEFAULT_TIMEOUT_MS", "clearGhostTapTarget", "consumeGhostTapGuard", "installGhostTapGuard", "markGhostTapTarget", "setGhostTapSelector", "shouldSkipGhostTap", "suppressNextGhostTap", "nowMs", "getDocument", "findTapTarget", "node", "ElementCtor", "selector", "el", "ELEMENT_SKIP_PROP", "timeout", "now", "delay", "lastMarkedTarget", "target", "until", "GLOBAL_SKIP_PROP", "targetDelay", "current", "onPointerStart", "event", "lastTouchMs", "lastTouchStartMs", "lastTouchDurationMs", "onTouchStart", "onPointerEnd", "onTouchEnd", "onClickCapture", "sinceTouchStart", "longPressMs", "options", "guardInstalled", "doc", "hasPointerEvents", "hasTouchEvents", "TARGET_SELECTOR", "extraSelector", "DEFAULT_LONG_PRESS_MS", "init_ghostTapGuard", "__esmMin", "hasMetMerchant", "sk", "MERCHANT_MET_KEY_BASE", "bindRapidActivation", "target", "handler", "once", "used", "pointerTriggered", "activePointerId", "run", "event", "shouldSkipGhostTap", "markGhostTapTarget", "cleanup", "resetPointerTrigger", "onClick", "onPointerDown", "suppressNextGhostTap", "onPointerUp", "onPointerCancel", "onTouchStart", "onTouchEnd", "onTouchCancel", "HAS_POINTER_EVENTS", "HAS_TOUCH_EVENTS", "dialogueStatusRank", "status", "DIALOGUE_STATUS_ORDER", "snapshotLockDisplay", "info", "buildUnlockedDialogueInfo", "meta", "bigNumToSafeInteger", "value", "plain", "parsed", "str", "numeric", "getPlayerProgress", "progress", "isXpSystemUnlocked", "state", "getXpState", "hasDoneForgeReset", "resolveDialogueLock", "rawState", "rawObj", "normalized", "DEFAULT_MYSTERIOUS_BLURB", "DEFAULT_LOCKED_BLURB", "DEFAULT_LOCK_MESSAGE", "MYSTERIOUS_ICON_SRC", "HIDDEN_DIALOGUE_TITLE", "LOCKED_DIALOGUE_TITLE", "ensureProgressEvents", "progressEventsBound", "onProgressChanged", "slot", "getActiveSlot", "key", "FORGE_COMPLETED_KEY_BASE", "watchStorageKey", "renderDialogueList", "completeDialogueOnce", "id", "loadDlgState", "k", "prev", "saveDlgState", "grantReward", "reward", "bank", "e", "rewardLabel", "MERCHANT_DLG_STATE_KEY_BASE", "s", "payload", "primeStorageWatcherSnapshot", "parseDlgStateRaw", "raw", "cleanupMerchantDlgStateWatcher", "stop", "merchantDlgWatcherCleanup", "handleMerchantDlgStateChange", "_", "bindMerchantDlgStateWatcherForSlot", "merchantDlgWatcherSlot", "storageKey", "ensureMerchantDlgStateWatcher", "merchantDlgWatcherInitialized", "ensureAudioCtx", "__audioCtx", "Ctx", "__typingGain", "IS_MOBILE", "pickSupportedSrc", "TYPING_SFX_SOURCE", "loadTypingBuffer", "__typingBuffer", "__bufferLoadPromise", "url", "arr", "buf", "err", "ensureTypingAudioElement", "__typingSfx", "a", "ensureElementGraph", "__typingSource", "setTypingGainForDevice", "primeTypingSfx", "__typingSfxPrimed", "prevLoop", "prevMuted", "startTypingSfx", "__isTypingActive", "__bufferSource", "stopTypingSfx", "typeText", "el", "full", "msPerChar", "skipTargets", "resolve", "skipping", "armed", "skip", "onKey", "targets", "t", "tick", "openDialogueLockInfo", "lockInfo", "merchantOverlayEl", "overlay", "cardEl", "nameEl", "messageEl", "closeBtn", "closed", "close", "onEsc", "blockInteraction", "doCloseFromBtn", "openDialogueModal", "MERCHANT_ICON_SRC", "onEscToCancel", "cancelWithoutReward", "textEl", "rowEl", "choicesEl", "ended", "closeModal", "engine", "DialogueEngine", "claimed", "script", "MERCHANT_DIALOGUES", "ensureMerchantScrollbar", "scroller", "merchantSheetEl", "bar", "thumb", "isTouch", "FADE_SCROLL_MS", "FADE_DRAG_MS", "supportsScrollEnd", "fadeTimer", "syncScrollShadow", "hasShadow", "updateBounds", "grabber", "header", "actions", "top", "bottom", "updateThumb", "scrollHeight", "clientHeight", "scrollTop", "barH", "visibleRatio", "thumbH", "maxScroll", "range", "y", "updateAll", "showBar", "scheduleHide", "delay", "onScroll", "onScrollEnd", "ro", "dragging", "dragStartY", "startScrollTop", "startDrag", "onDragMove", "thH", "scrollMax", "scrollDelta", "endDrag", "rect", "clickY", "targetY", "ensureMerchantOverlay", "content", "tabs", "panelsWrap", "panelDialogue", "panelReset", "panelMinigames", "resetUnlocked", "isForgeUnlocked", "merchantTabUnlockState", "MERCHANT_TABS_DEF", "def", "stored", "unlocked", "btn", "lockedLabel", "selectMerchantTab", "merchantTabs", "initResetSystem", "initResetPanel", "updateResetPanel", "unlockMerchantTabs", "merchantCloseBtn", "firstChat", "initDialogueTab", "merchantEventsBound", "closeMerchant", "onKeydownForMerchant", "onMerchantDragStart", "panel", "list", "stateDirty", "DLG_CATALOG", "entryState", "storedStatus", "storedRank", "rank", "snapshot", "isMysterious", "locked", "showComplete", "card", "title", "blurb", "iconSrc", "REWARD_ICON_SRC", "ariaLabel", "again", "runFirstMeet", "fc", "MERCHANT_MET_EVENT", "resetFirstChatOverlayState", "openMerchant", "merchantOpen", "activeEl", "merchantLastFocus", "met", "last", "MERCHANT_TAB_KEY_BASE", "clientY", "merchantDrag", "onMerchantDragMove", "onMerchantDragEnd", "onMerchantDragCancel", "dy", "cleanupMerchantDrag", "dt", "keys", "init_dlgTab", "__esmMin", "init_storage", "init_bigNum", "init_merchantDialogues", "init_xpSystem", "init_resetTab", "init_shopOverlay", "init_ghostTapGuard", "init_main", "base", "onEnd", "node", "nextNode", "options", "prepare", "opt", "resolveUpgradeId", "upgLike", "rawId", "parsed", "isForgeUnlockUpgrade", "FORGE_UNLOCK_UPGRADE_ID", "blockInteraction", "ms", "IS_MOBILE", "shield", "eat", "e", "ev", "openHmMilestoneDialog", "lines", "existing", "overlay", "dialog", "title", "list", "line", "li", "text", "closeBtn", "close", "onKeydown", "event", "stripTags", "html", "createSfxPlayer", "src", "mobileVolume", "desktopVolume", "base", "ac", "gain", "buffer", "bufferPromise", "bufferPromiseHandled", "pendingPlays", "ensureBase", "el", "takePreloadedAudio", "ensureWebAudio", "ensureBuffer", "srcUrl", "resp", "buf", "resolve", "reject", "settled", "onOk", "decoded", "onErr", "err", "ret", "playMobileFallback", "baseAudio", "playMobileWebAudio", "playBuffer", "node", "t", "plays", "i", "playDesktop", "a", "playPurchaseSfx", "purchaseSfx", "playEvolveSfx", "evolveSfx", "currencyIconHTML", "type", "CURRENCY_ICON_SRC", "ensureCustomScrollbar", "scroller", "shopOverlayEl", "bar", "thumb", "shopSheetEl", "isTouch", "FADE_SCROLL_MS", "FADE_DRAG_MS", "supportsScrollEnd", "syncScrollShadow", "hasShadow", "updateBounds", "grab", "header", "actions", "top", "bottom", "updateThumb", "scrollHeight", "clientHeight", "scrollTop", "barH", "visibleRatio", "thumbH", "maxScroll", "range", "y", "updateAll", "showBar", "scheduleHide", "delay", "onScroll", "onScrollEnd", "dragging", "dragStartY", "startScrollTop", "startDrag", "onDragMove", "thH", "scrollMax", "scrollDelta", "endDrag", "rect", "clickY", "targetY", "buildUpgradesData", "areaKey", "getCurrentAreaKey", "defs", "getUpgradesForArea", "upgrades", "def", "lvlBn", "getLevel", "lvlNum", "getLevelNumber", "lockState", "getUpgradeLockState", "icon", "getIconUrl", "desc", "locked", "hmReady", "upgradeUiModel", "levelsRemainingToCap", "upg", "currentLevelBn", "currentLevelNumber", "BigNum", "capBn", "fallback", "capPlain", "lvlPlain", "capInt", "lvlInt", "delta", "capNumber", "lvlNumber", "room", "computeAffordableLevels", "currentLevelNumeric", "lvl", "cap", "walletValue", "bank", "walletBn", "isHmType", "maxed", "nextLvlNum", "c0", "c1", "farProbeLevel", "cFar", "remainingBn", "lo", "hi", "mid", "midBn", "count", "evaluateBulkPurchase", "renderShopGrid", "grid", "key", "btn", "lockIcon", "hasMysteriousIcon", "isMysterious", "isPlainLocked", "isHM", "evolveReady", "levelIsInfinite", "canPlusBn", "plusBn", "levelHtml", "formatNumber", "levelPlain", "plusHtml", "plusPlain", "hasPlus", "rawCap", "levelDigits", "levelNumber", "hasFiniteCap", "capReached", "isBookValueUpgrade", "UPGRADE_TIES", "isSingleLevelCap", "isUnlockUpgrade", "showUnlockableBadge", "showUnlockedBadge", "badgeHtml", "badgePlain", "needsTwoLines", "reason", "ariaLabel", "numericLevel", "plainDigits", "isInf", "over999", "lvlSpan", "plusSpan", "tile", "baseImg", "costType", "useLockedBase", "fallbackBaseSrc", "BASE_ICON_SRC_BY_COST", "resolvedBaseSrc", "LOCKED_BASE_ICON_SRC", "iconImg", "TRANSPARENT_PX", "shouldSkipGhostTap", "markGhostTapTarget", "openUpgradeOverlay", "bought", "buyMax", "unlockMerchantTabs", "updateShopOverlay", "maxedOverlay", "MAXED_BASE_OVERLAY_SRC", "badge", "ensureShopOverlay", "grabber", "content", "delveBtn", "openDelveOverlay", "primeTypingSfx", "openMerchant", "delveBtnEl", "updateDelveGlow", "met", "hasMetMerchant", "__shopPostOpenPointer", "eventsBound", "onCloseClick", "closeShop", "hasPointerEvents", "onDelvePointerDown", "onDelveTouchStart", "onKeydownForShop", "onDragStart", "_shopBadgeTimer", "scheduleShopRerender", "shopOpen", "onUpgradesChanged", "MERCHANT_MET_EVENT", "ensureUpgradeOverlay", "upgOverlayEl", "upgSheetEl", "drag", "upgOpen", "onDragEnd", "dy", "shouldClose", "closeUpgradeMenu", "upgOverlayCleanup", "fn", "upgDef", "upgOpenLocal", "initialLockState", "initialLocked", "initialMysterious", "isEndlessXp", "ui", "spacer", "h", "s", "makeLine", "d", "recenterUnlockOverlayIfNeeded", "model", "isHiddenUpgrade", "headerRect", "actionsRect", "contentRect", "freeSpace", "topOffset", "rerender", "lockHidden", "isUnlockVisible", "level", "capHtml", "baseDesc", "info", "descText", "reasonText", "note", "effectText", "iconHTML", "nextPriceBn", "stopBuying", "costs", "lineCost", "lineMilestone", "milestoneCost", "deltaBn", "deltaPlain", "deltaNum", "spent", "lineHave", "milestonesRow", "viewMilestonesBtn", "milestones", "evolutions", "evolutionOffset", "HM_EVOLUTION_INTERVAL", "formatMilestoneLevel", "levelBn", "plain", "asNum", "b", "m", "milestoneLevelBn", "milestonePlain", "levelText", "mult", "formatMultForUi", "target", "achieved", "approxTarget", "suppressNextGhostTap", "canAffordNext", "evolveBtn", "evolved", "evolveUpgrade", "unlockBtn", "buyOne", "buyBtn", "performBuy", "fresh", "priceNow", "buyMaxBtn", "performBuyMax", "buyNextBtn", "performBuyNext", "diffPlain", "walletRaw", "reachable", "purchase", "buyTowards", "onCurrencyChange", "onKey", "openShop", "shopCloseTimer", "__shopOpenStamp", "focusable", "force", "forceClose", "overlayOpen", "clientY", "onDragCancel", "cleanupDrag", "dt", "PURCHASE_SFX_SRC", "EVOLVE_SFX_SRC", "MOBILE_PURCHASE_VOLUME", "DESKTOP_PURCHASE_VOLUME", "init_shopOverlay", "__esmMin", "init_storage", "init_bigNum", "init_numFormat", "init_main", "init_dlgTab", "init_audioCache", "init_upgrades", "init_ghostTapGuard", "activeSlot", "getActiveSlot", "targetSlot", "hudButtons_exports", "__export", "applyHudLayout", "initHudButtons", "isMapUnlocked", "isShopUnlocked", "lockMap", "lockShop", "unlockMap", "unlockShop", "slotKey", "base", "slot", "getActiveSlot", "isUnlocked", "key", "slotRaw", "ensureUnlockDefaults", "BASE_KEYS", "setUnlocked", "v", "val", "sk", "setButtonVisible", "visible", "el", "updateShopButtonTamperState", "btn", "hasModifiedSave", "phonePortrait", "isCoarse", "isPortrait", "hud", "mapBtn", "isMapVisible", "isPhonePortrait", "desiredNodes", "remainingNodes", "finalOrder", "idx", "frag", "node", "cs", "gap", "cw", "per", "help", "stats", "shop", "listenersBound", "event", "active", "actionsBound", "activate", "openShop", "onClick", "e", "shouldSkipGhostTap", "markGhostTapTarget", "hasPointerEvents", "onPointerDown", "onTouchStart", "init_hudButtons", "__esmMin", "init_shopOverlay", "init_storage", "init_ghostTapGuard", "debugPanel_exports", "__export", "applyAllCurrencyOverridesForActiveSlot", "applyStatMultiplierOverride", "getDebugCurrencyMultiplierOverride", "getDebugStatMultiplierOverride", "setDebugCurrencyMultiplierOverride", "setDebugPanelAccess", "setDebugStatMultiplierOverride", "isOnMenu", "menuRoot", "style", "isGameVisible", "gameRoot", "addDebugPanelCleanup", "fn", "debugPanelCleanups", "createEmptyExpansionState", "captureDebugPanelExpansionState", "panel", "DEBUG_PANEL_ID", "sections", "toggle", "key", "subsections", "applyDebugPanelExpansionState", "debugPanelExpansionState", "content", "cleanupDebugPanelResources", "liveBindings", "registerLiveBinding", "binding", "refreshLiveBindings", "predicate", "setupLiveBindingListeners", "currencyHandler", "event", "slot", "targetSlot", "getActiveSlot", "currencyMultiplierHandler", "xpHandler", "mutationHandler", "upgradeHandler", "slotHandler", "unlockHandler", "getAreas", "AREA_KEYS", "CURRENCIES", "ensureDebugPanelStyles", "DEBUG_PANEL_STYLE_ID", "existingLink", "marker", "link", "applyMobileGhostTapToDropdown", "select", "IS_MOBILE", "mark", "markGhostTapTarget", "removeDebugPanelToggleButton", "existingButton", "DEBUG_PANEL_TOGGLE_ID", "shouldShowDebugPanelToggleButton", "debugPanelAccess", "onMenuVisibilityChange", "closeDebugPanel", "createDebugPanelToggleButton", "createSection", "title", "contentId", "contentBuilder", "section", "stateKey", "sectionKeyCounter", "lastPointerType", "handleToggle", "shouldSkipGhostTap", "expanded", "createSubsection", "defaultExpanded", "container", "subsectionKeyCounter", "bigNumEquals", "a", "b", "bigNumToFiniteNumber", "value", "fromScientific", "num", "getCurrencyStorageKey", "currencyKey", "resolvedSlot", "KEYS", "getCurrencyValueForSlot", "BigNum", "handle", "bank", "peekCurrency", "applyCurrencyState", "previous", "storageKey", "wasLocked", "isStorageKeyLocked", "unlockStorageKey", "next", "markSaveSlotModified", "setCurrency", "primeStorageWatcherSnapshot", "lockStorageKey", "buildOverrideKey", "getCurrencyOverride", "currencyOverrides", "getCurrencyMultiplierStorageKey", "clearCurrencyMultiplierOverride", "cacheKey", "currencyOverrideBaselines", "getStatOverride", "lockAwareRefresh", "isStatMultiplierLocked", "cached", "statOverrides", "fromStorage", "loadStatMultiplierOverrideFromStorage", "notifyStatMultiplierChange", "statKey", "clearStatMultiplierOverride", "getStatMultiplierStorageKey", "statOverrideBaselines", "getLockedStatOverride", "getStatMultiplierDisplayValue", "gameValue", "getGameStatMultiplier", "getEffectiveStatMultiplierOverride", "STAT_MULTIPLIER_STORAGE_PREFIX", "xpGainMultiplier", "computeUpgradeEffects", "valueMult", "getMpValueMultiplierBn", "mult", "getMutationMultiplier", "raw", "storeStatMultiplierOverride", "bn", "locked", "setter", "originalSetItem", "applyCurrencyOverrideForSlot", "override", "currencyOverrideApplications", "current", "ensureCurrencyOverrideListener", "currencyListenerAttached", "baseline", "baselineNum", "nextNum", "ratio", "scaledOverride", "amount", "base", "multiplierForRatio", "overrideNum", "gameValueNum", "ensureStorageLockPatch", "storageLockPatched", "originalRemoveItem", "lockedStorageKeys", "toggleStorageLock", "createLockToggle", "onToggle", "button", "refresh", "createCompositeLockToggle", "resolveKeys", "getKeys", "isLocked", "keys", "hasAnyLocked", "anyLocked", "collapseAllDebugCategories", "withTemporaryUnlock", "uniqueKeys", "relock", "formatBigNumForInput", "storage", "pStr", "sigPart", "expPart", "precision", "paddedSig", "parseBigNumInput", "trimmed", "setInputValidity", "input", "valid", "flagDebugUsage", "getActionLogKey", "ACTION_LOG_STORAGE_PREFIX", "getCurrentActionLog", "parsed", "persistActionLog", "entries", "MAX_ACTION_LOG_ENTRIES", "appendActionLogEntry", "entry", "log", "logAction", "message", "now", "updateActionLogDisplay", "actionLogContainer", "actionLog", "msg", "formattedMessage", "match", "dialogueStateStorageKey", "MERCHANT_DLG_STATE_KEY_BASE", "persistDialogueState", "state", "payload", "loadDialogueState", "grantDialogueReward", "reward", "e", "completeAllDialoguesForDebug", "completed", "DLG_CATALOG", "id", "meta", "prev", "alreadyClaimed", "restoreAllDialoguesForDebug", "restored", "createInputRow", "labelText", "initialValue", "onCommit", "idLabel", "onLockChange", "row", "label", "idSpan", "editing", "pendingValue", "skipBlurCommit", "lockToggle", "setValue", "commitValue", "createUnlockToggleRow", "description", "isUnlocked", "onEnable", "onDisable", "slider", "textContainer", "desc", "toggleRow", "lastKnown", "unlocked", "refreshed", "formatCalculatorResult", "formatNumber", "createCalculatorRow", "inputs", "compute", "controls", "output", "fieldEls", "recompute", "values", "hasError", "config", "el", "result", "inputConfig", "optLabel", "option", "applyXpState", "level", "progress", "unlockXpSystem", "unlockKey", "XP_KEYS", "initXpSystem", "broadcastXpChange", "applyMutationState", "forgeUnlocked", "isForgeUnlocked", "forgeOverride", "getForgeDebugOverrideState", "setForgeDebugOverride", "hasDoneForgeReset", "setForgeResetCompleted", "setMutationUnlockedForDebug", "updateResetPanel", "initMutationSystem", "unlockMutationSystem", "MUTATION_KEYS", "broadcastMutationChange", "buildAreaCurrencies", "area", "areaLabel", "currency", "currencyRow", "latestSlot", "latest", "buildAreaStats", "xp", "getXpState", "mutation", "getMutationState", "xpLevelKey", "xpLevelRow", "xpProgressKey", "xpProgressRow", "prevLevel", "prevProgress", "mpLevelKey", "mpLevelRow", "mpProgressKey", "mpProgressRow", "buildAreaUpgrades", "upgrades", "getUpgradesForArea", "upg", "getLevel", "upgradeRow", "setLevel", "buildAreaCurrencyMultipliers", "setAllCurrenciesToInfinity", "inf", "updated", "setAllCurrenciesToZero", "zero", "setAllStatsToInfinity", "touched", "xpState", "mutationState", "levelInf", "progInf", "isStatUnlocked", "STAT_MULTIPLIERS", "setAllStatsToZero", "getUnlockRowDefinitions", "resetXpProgress", "isShopUnlocked", "unlockShop", "lockShop", "isMapUnlocked", "unlockMap", "lockMap", "setAllUnlockToggles", "targetState", "toggled", "rowDef", "unlockAllUnlockUpgrades", "markUpgradePermanentlyUnlocked", "lockAllUnlockUpgrades", "clearPermanentUpgradeUnlock", "getResetTargetLockKeys", "target", "add", "addCurrencyKeys", "addStatMultiplier", "addStatKeys", "resetCurrencyAndMultiplier", "setCurrencyMultiplierBN", "resetStatsAndMultipliers", "currencyCount", "resetCount", "parts", "buildAreaStatMultipliers", "stat", "buildAreaCalculators", "coins", "xpLevel", "computeForgeGoldFromInputs", "getXpRequirementForXpLevel", "computeCoinMultiplierForXpLevel", "mpLevel", "computeMutationRequirementForLevel", "computeMutationMultiplierForLevel", "baseCost", "mode", "computeDefaultUpgradeCost", "group", "subsection", "sub", "calculatorRow", "buildAreasContent", "placeholder", "areaContainer", "areaContent", "currencies", "stats", "multipliers", "currencyMultipliers", "statMultipliers", "calculators", "buildMiscContent", "buttons", "unlocks", "toggles", "locks", "buttonGrid", "cfg", "btn", "resetRow", "resetLabel", "resetSelect", "opt", "allCurrenciesOption", "allUnlockedStatsOption", "allUnlockedOption", "allOption", "resolveResetLockKeys", "resetLockToggle", "resetBtn", "lockKeys", "shouldRelock", "count", "nounPhrase", "actionLogRow", "wipeSlotBtn", "buildUnlocksContent", "buildDebugPanel", "existingPanel", "header", "titleContainer", "closeButtonContainer", "closeButton", "collapseCloseButton", "info", "text", "hideOnMobile", "infoLine", "debugPanelScrollTop", "debugPanelOpen", "openDebugPanel", "preserveExpansionState", "toggleDebugPanel", "teardownDebugPanel", "applyDebugPanelAccess", "enabled", "XP_KEY_PREFIX", "MUTATION_KEY_PREFIX", "init_debugPanel", "__esmMin", "init_bigNum", "init_numFormat", "init_storage", "init_xpSystem", "init_mutationSystem", "init_main", "init_upgrades", "init_resetTab", "init_hudButtons", "init_dlgTab", "init_ghostTapGuard", "mutationSystem_exports", "__export", "addMutationPower", "broadcastMutationChange", "computeMutationMultiplierForLevel", "computeMutationRequirementForLevel", "getMutationCoinSprite", "getMutationMultiplier", "getMutationState", "initMutationSystem", "isMutationUnlocked", "onMutationChange", "setMutationUnlockedForDebug", "unlockMutationSystem", "toStorageSafe", "value", "scheduleCoinMultiplierRefresh", "refreshCoinMultiplierFromXpLevel", "ensureExternalMultiplierProviders", "unregisterCoinMultiplierProvider", "unregisterXpGainMultiplierProvider", "cloneBigNum", "BN", "bnZero", "quantizeRequirement", "sci", "match", "floored", "plain", "quant", "levelToNumber", "level", "num", "approxLog", "approxLog10BigNum", "computeRequirement", "levelBn", "baseRequirementLog10", "baseLevel", "m", "tail", "poly", "factor", "powTerm", "CONST_RATIO", "totalLog10", "levelNum", "x", "A", "B", "secondExp", "raw", "bigNumFromLog10", "ensureRequirement", "lvl", "mutationState", "inf", "BigNum", "req", "progressRatio", "progressBn", "requirement", "reqInf", "progInf", "logProg", "logReq", "diff", "ratio", "ensureHudRefs", "hudRefs", "formatBn", "bn", "formatNumber", "updateHud", "container", "bar", "fill", "levelValue", "progress", "reqHtml", "reqPlain", "syncXpMpHudLayout", "pct", "currentHtml", "currPlain", "emitChange", "reason", "extraDetail", "snapshot", "detail", "getActiveSlot", "listeners", "cb", "persistState", "slot", "KEY_UNLOCK", "KEY_LEVEL", "KEY_PROGRESS", "primeStorageWatcherSnapshot", "persisted", "unlocked", "rawLevel", "rawProgress", "persistedLevelRaw", "persistedProgressRaw", "expectedLevelRaw", "expectedProgressRaw", "unlockMismatch", "levelMismatch", "progressMismatch", "applyState", "normalizeProgress", "currentReq", "guard", "limit", "bnOne", "newState", "skipPersist", "readStateFromStorage", "targetSlot", "rawLvl", "rawProg", "cleanupWatchers", "watcherCleanups", "stop", "bindStorageWatchers", "watchersBoundSlot", "watchStorageKey", "nextUnlocked", "next", "forceReload", "initialized", "activeSlot", "nextSlot", "amount", "inc", "applyStatMultiplierOverride", "incClone", "prevLevel", "prevProgress", "levelsGained", "detailOverrides", "log10", "MP_LOG10_BASE", "callback", "KEY_PREFIX", "init_mutationSystem", "__esmMin", "init_bigNum", "init_storage", "init_debugPanel", "init_numFormat", "init_upgrades", "init_hudLayout", "init_xpSystem", "spawner_exports", "__export", "createSpawner", "updateMutationSnapshot", "state", "mutationUnlockedSnapshot", "mutationLevelSnapshot", "level", "plain", "playfieldSelector", "waterSelector", "surgesHost", "coinsHost", "coinSrc", "coinSize", "animationName", "animationDurationMs", "surgeLifetimeMs", "surgeWidthVw", "coinsPerSecond", "perFrameBudget", "backlogCap", "maxActiveCoins", "initialBurst", "coinTtlMs", "waveSoundSrc", "waveSoundDesktopVolume", "waveSoundMobileVolume", "waveSoundMinIntervalMs", "enableDropShadow", "currentCoinSrc", "isTouch", "MOBILE_BACKLOG_CAP", "burstUntil", "BURST_WINDOW_MS", "BURST_TIME_BUDGET_MS", "BURST_HARD_CAP", "ONE_SHOT_THRESHOLD", "NORMAL_TIME_BUDGET_MS", "refs", "validRefs", "M", "computeMetrics", "pfRect", "wRect", "hudH", "ro", "clamp", "v", "lo", "hi", "COIN_POOL_MAX", "SURGE_POOL_MAX", "COIN_MARGIN", "coinPool", "surgePool", "makeCoin", "el", "getCoin", "releaseCoin", "makeSurge", "getSurge", "releaseSurge", "waveURL", "waveHtmlEl", "waveHtmlSource", "waveLastAt", "wavePool", "waveIdx", "ensureWavePool", "preloaded", "takePreloadedAudio", "_", "idx", "a", "i", "playWaveHtmlVolume", "vol", "IS_MOBILE", "ac", "gain", "pool", "waveBuf", "waveLoading", "ensureWaveWA", "arr", "ok", "err", "playWaveMobile", "src", "warmWave", "evt", "playWaveOncePerBurst", "now", "planCoinFromWave", "wave", "waveX", "waveTop", "waveW", "startX", "startY", "drift", "endX", "minY", "maxY", "endY", "midX", "jitterMs", "planSpawn", "oldest", "pfW", "leftMax", "waterToPfTop", "coinPlan", "commitBatch", "batch", "wavesFrag", "coinsFrag", "newCoins", "newSurges", "coin", "surge", "animMs", "onEnd", "e", "jitter", "duration", "spawnBurst", "n", "plan", "rate", "rafId", "last", "carry", "queued", "ttlCursor", "ttlChecksPerFrame", "loop", "dt", "checked", "node", "next", "dieAt", "due", "cap", "spawnTarget", "timeBudgetMs", "t0", "baseSpawned", "start", "stop", "setRate", "setCoinSprite", "init_spawner", "__esmMin", "init_audioCache", "init_mutationSystem", "init_main", "getMutationState", "onMutationChange", "snapshot", "coinPickup_exports", "__export", "initCoinPickup", "setCoinMultiplier", "updateMutationSnapshot", "state", "mutationUnlockedSnapshot", "mutationLevelIsInfiniteSnapshot", "mutationMultiplierCache", "initMutationSnapshot", "mutationUnsub", "getMutationState", "onMutationChange", "snapshot", "x", "COIN_MULTIPLIER", "bank", "refreshMpValueMultiplierCache", "next", "getMpValueMultiplierBn", "BigNum", "mpValueMultiplierBn", "ensureMpValueMultiplierSync", "mpMultiplierListenersBound", "resolveCoinBase", "el", "BASE_COIN_VALUE", "computeMagnetUnitPx", "root", "vw", "vh", "MAGNET_UNIT_RATIO", "createMagnetController", "playfield", "coinsLayer", "coinSelector", "collectFn", "indicator", "pointerInside", "pointerClientX", "pointerClientY", "localX", "localY", "unitPx", "magnetLevel", "radiusPx", "rafId", "destroyed", "hideIndicator", "updateIndicator", "diameter", "sweepCoins", "coins", "radiusWithBuffer", "MAGNET_COLLECTION_BUFFER", "i", "coin", "rect", "coinX", "coinY", "dx", "dy", "runSweep", "ensureSweepLoop", "updatePointerFromEvent", "e", "handlePointerLeave", "refreshMagnetLevel", "getMagnetLevel", "handleResize", "destroy", "pointerOpts", "playfieldSelector", "coinsLayerSelector", "hudAmountSelector", "soundSrc", "storageKey", "disableAnimation", "IS_MOBILE", "coinPickup", "pf", "cl", "amt", "magnetController", "coinMultiplierBn", "coinMultiplierIsInfinite", "refreshCoinMultiplierCache", "multHandle", "applyCoinMultiplier", "value", "base", "mult", "updateHud", "formatted", "formatNumber", "cloneBn", "computeMutationMultiplier", "spawnLevelStr", "BN_INF", "key", "cached", "levelBn", "multiplier", "computeMutationMultiplierForLevel", "isIdentity", "BN_ONE", "stored", "pendingCoinGain", "pendingXpGain", "pendingMutGain", "flushScheduled", "mergeGain", "current", "gain", "flushPendingGains", "coinGain", "xpGain", "addXp", "mutGain", "addMutationPower", "scheduleFlush", "queueCoinGain", "queueXpGain", "queueMutationGain", "onCurrencyChange", "onCoinMultiplierChange", "event", "slot", "getActiveSlot", "SHOP_UNLOCK_KEY", "SHOP_PROGRESS_KEY", "legacyP", "legacyU", "p", "unlockShop", "DESKTOP_VOLUME", "MOBILE_VOLUME", "resolvedSrc", "isCoin", "ensureInteractive", "mo", "recs", "r", "n", "bindCoinDirect", "ac", "masterGain", "buffer", "webAudioReady", "webAudioLoading", "webAudioAttempted", "queuedPlays", "mobileFallback", "playCoinMobileFallback", "initWebAudioOnce", "arr", "ok", "err", "playCoinWebAudio", "src", "t", "playSound", "playCoinHtmlAudio", "warm", "evt", "pool", "pIdx", "lastAt", "a", "now", "animateAndRemove", "cs", "start", "done", "collect", "coinsLocked", "isCurrencyLocked", "CURRENCIES", "inc", "xpInc", "XP_PER_COIN", "mutationMultiplier", "incIsZero", "xpEnabled", "isXpSystemUnlocked", "xpIsZero", "isMutationUnlocked", "mpGain", "BRUSH_R", "OFF", "brushAt", "y", "k", "px", "py", "stack", "pending", "brushScheduled", "scheduleBrush", "setMobileVolume", "v", "vol", "init_coinPickup", "__esmMin", "init_storage", "init_bigNum", "init_numFormat", "init_hudButtons", "init_xpSystem", "init_main", "init_mutationSystem", "init_upgrades", "saveIntegrity_exports", "__export", "afterSlotWrite", "beforeSlotWrite", "nowMs", "noteTrustedSlot", "slot", "ttl", "TRUSTED_MUTATION_GRACE_MS", "trustedSlotsUntil", "slotRecentlyTrusted", "expiry", "resetTrustedSlots", "hasLocalStorage", "parseSlotFromKey", "key", "match", "rebuildExpectedStateForSlot", "snapshot", "expectedStateBySlot", "i", "STORAGE_PREFIX", "keySlot", "value", "ensureExpectedStateForSlot", "integrityInternalWriteDepth", "strKey", "snapKey", "expectedValue", "actualValue", "markSaveSlotModified", "computeSignature", "entries", "hash", "entry", "collectEntriesBySlot", "map", "slotMatch", "sigKey", "getSlotSignatureKey", "getCandidateSlots", "entriesBySlot", "slots", "_", "active", "getActiveSlot", "idx", "verifySlotIntegrity", "list", "stored", "getSlotSignature", "setSlotSignature", "signature", "runIntegrityCheck", "scheduleTrustedMutationSweep", "trustedSweepTimer", "TRUSTED_SWEEP_DELAY_MS", "handleStorageMutationEvent", "event", "detail", "rawSlot", "ensureWatcher", "watcherId", "SIGNATURE_POLL_INTERVAL_MS", "getShopButtonElement", "enforcePoopShopStyle", "btn", "hasModifiedSave", "POOP_SHOP_FLAG", "POOP_SHOP_BG", "startPoopShopEnforcer", "poopShopTimer", "ev", "init", "init_saveIntegrity", "__esmMin", "init_storage", "popups_exports", "__export", "initPopups", "teardownpopups", "ensureContainer", "container", "bnFromAny", "value", "BigNum", "isZero", "bn", "updateEntry", "entry", "amountEl", "amount", "meta", "formatted", "formatNumber", "scheduleRemoval", "duration", "DEFAULT_DURATION", "activePopups", "remove", "createPopupEntry", "type", "element", "plus", "icon", "text", "showPopup", "overrides", "baseMeta", "POPUP_META", "bnAmount", "existing", "host", "index", "POPUP_ORDER", "insertBefore", "i", "next", "syncLastKnown", "all", "key", "lastKnownAmounts", "clearActivePopups", "handleCurrencyChange", "event", "detail", "current", "prev", "zero", "delta", "detailDelta", "handleXpChange", "xpAdded", "handleMutationChange", "nextProgress", "handleSlotChange", "initialized", "init_popups", "__esmMin", "init_bigNum", "init_numFormat", "init_storage", "CURRENCIES", "suspendSafeguard_exports", "__export", "flushBackupSnapshot", "getSuspendMetadata", "installSuspendSafeguards", "markProgressDirty", "restoreFromBackupIfNeeded", "canUseIndexedDb", "canUseLocalStorage", "testKey", "STORAGE_PREFIX", "openDatabase", "dbPromise", "resolve", "reject", "resolved", "request", "DB_NAME", "DB_VERSION", "db", "STORE_NAME", "err", "captureSnapshot", "data", "captured", "i", "key", "value", "putSnapshot", "snapshot", "settled", "tx", "SNAPSHOT_KEY", "readSnapshot", "requestPersistentStorage", "captureStackTrace", "parseSlotFromKey", "match", "slot", "isTrustedStorageStack", "stack", "DEVTOOLS_CONSOLE_FRAME_RE", "notifySaveIntegrityOfStorageMutation", "strKey", "SLOT_SIGNATURE_PREFIX", "SLOT_MOD_FLAG_PREFIX", "detail", "installStorageHooks", "proto", "originalSet", "originalRemove", "originalClear", "isTrackedGameKey", "beforeSlotWrite", "result", "afterSlotWrite", "scheduleFlush", "reason", "lastDirtyReason", "dirty", "flushTimer", "reasonToUse", "FLUSH_DEBOUNCE_MS", "cancelFlushTimer", "performFlush", "pendingImmediateFlush", "ok", "immediate", "flushBeforeSuspend", "hasAnyPrefixedKeys", "restoreAttempted", "shouldRestore", "activeSlot", "coinKey", "restored", "installAttempted", "onVisibilityChange", "event", "init_suspendSafeguard", "__esmMin", "init_saveIntegrity", "disableMobileZoomGestures", "IS_MOBILE", "lastTouchEnd", "TOUCH_DELAY_MS", "event", "now", "showLoader", "text", "root", "wrap", "label", "bar", "fill", "pct", "stuckMsg", "stuckTimeout", "setLoaderProgress", "loaderEl", "fraction", "f", "finishAndHideLoader", "MIN_FINISHED_DWELL_MS", "onEnd", "warmImage", "url", "img", "resolve", "ghost", "preloadImages", "sources", "onEach", "src", "done", "preloadAudio", "a", "registerPreloadedAudio", "pendingPreloadedAudio", "preloadFonts", "preloadAssetsWithProgress", "images", "audio", "fonts", "onProgress", "total", "bump", "tasks", "p", "enterArea", "areaID", "currentArea", "menuRoot", "AREAS", "gameRoot", "initHudButtons", "initResetSystemGame", "initMutationSystem", "spawner", "createSpawner", "applyMutationSprite", "getMutationCoinSprite", "onMutationChangeGame", "initCoinPickup", "applyUpgradesToSpawner", "areaKey", "getUpgAreaKey", "eff", "computeUpgradeEffects", "onUpgradesChanged", "initXpSystem", "initSlots", "installGhostTapGuard", "bank", "getHasOpenedSaveSlot", "setHasOpenedSaveSlot", "ensureStorageDefaults", "initPopups", "installSuspendSafeguards", "restoreSuspendBackup", "markProgressDirty", "flushBackupSnapshot", "setDebugPanelAccess", "nextFrame", "twoFrames", "init_main", "__esmMin", "detected", "r", "loader", "modulePromise", "ASSET_MANIFEST", "_", "i", "progress", "assetsPromise", "slotsModule", "spawnerModule", "coinPickupModule", "hudButtonsModule", "storageModule", "saveIntegrityModule", "upgradesModule", "audioCacheModule", "xpModule", "resetModule", "mutationModule", "popupModule", "safetyModule", "guardModule", "debugPanelModule", "entry", "titleEl", "init_main"]
}
