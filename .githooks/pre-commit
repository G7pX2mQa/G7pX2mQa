#!/usr/bin/env bash
set -euo pipefail

repo_root="$(git rev-parse --show-toplevel)"
cd "$repo_root"

changed_files="$(git diff --cached --name-only)"
js_changed=false
css_changed=false

if printf '%s\n' "$changed_files" | grep -Eq '^js/'; then
  js_changed=true
fi

if printf '%s\n' "$changed_files" | grep -Eq '^css/'; then
  css_changed=true
fi

if [ "$js_changed" = false ] && [ "$css_changed" = false ]; then
  # No staged asset changes; skip rebuilding bundles
  exit 0
fi

echo "Detected staged changes in js/ or css/. Running npm run sync-bundles to refresh tracked bundles..."
npm run sync-bundles

# Stage generated outputs so they are committed alongside the source changes
git add bundle.js bundle.js.map styles.css styles.css.map
