/* css/ui/delve.css */
:root {
  --merchant-bg: var(--shop-bg, hsla(215, 32%, 7%, 0.75));
  --merchant-card: var(--shop-card, hsl(220 18% 14% / 1));
  --merchant-card-soft: hsla(220, 18%, 14%, 0.85);
  --merchant-border: var(--shop-border, hsl(210 18% 28% / 1));
}

.merchant-overlay {
  position: fixed;
  inset: 0;
  z-index: 4001;
  pointer-events: none;
  user-select: none;
}
.merchant-overlay.is-open { pointer-events: auto; }

/* Merchant sheet adopts the same animation variables */
.merchant-sheet {
  position: absolute;
  inset: 0;
  background: var(--merchant-bg);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  display: grid;
  grid-template-rows: auto 1fr auto;
  transform: translateY(100%);
  transition: transform var(--shop-anim);
  box-shadow: var(--shop-shadow);
  --merchant-fade-size: clamp(18px, 5vw, 40px);
}
.merchant-overlay.is-open .merchant-sheet { transform: translateY(0); }

.shop-grabber, .merchant-grabber {
  padding-top: calc(8px + var(--safe-top));
  padding-bottom: 12px;
  display: grid;
  place-items: center;
  touch-action: none;
  -webkit-user-select: none;
  user-select: none;
}

.merchant-grabber,
.merchant-actions {
  background: var(--merchant-bg);
}

@media (pointer: fine) {
  .merchant-reset,
  .merchant-reset__status {
    -webkit-user-select: text;
    user-select: text;
  }

  .merchant-dialogue-list .dlg-title,
  .merchant-dialogue-list .dlg-blurb,
  .merchant-dialogue-list .dlg-reward,
  .merchant-dialogue-list .dlg-again {
    -webkit-user-select: text;
    user-select: text;
  }

  .merchant-reset img,
  .merchant-dialogue-list .coin-icon,
  .merchant-dialogue-list .book-icon {
    -webkit-user-select: none;
    user-select: none;
  }
}

.shop-grabber .grab-handle,
.merchant-grabber .grab-handle {
  width: 56px;
  height: 6px;
  border-radius: 999px;
  background: hsl(0 0% 100% / .35);
  box-shadow: inset 0 1px 0 hsl(0 0% 100% / .25);
}

/* Content + header */
.merchant-content {
  overflow-y: auto;
  padding: 0;
  scrollbar-gutter: stable both-edges;
  background: var(--merchant-bg);

  /* smooth scrolling on iOS */
  -webkit-overflow-scrolling: touch;

  /* we’ll draw our own overlay scrollbar */
  scrollbar-width: none;              /* Firefox */
}

.merchant-sheet.has-scroll-shadow .merchant-content {
  -webkit-mask-image: linear-gradient(180deg, transparent 0%, #000 var(--merchant-fade-size), #000 100%);
  mask-image: linear-gradient(180deg, transparent 0%, #000 var(--merchant-fade-size), #000 100%);
  -webkit-mask-repeat: no-repeat;
  mask-repeat: no-repeat;
}

.merchant-sheet.has-scroll-shadow .merchant-header::after {
  opacity: 1;
}

.merchant-content::-webkit-scrollbar {
  width: 0;
  height: 0;
  display: none;                      /* Chromium/WebKit */
}

/* Chromium/WebKit (incl. iOS) */
.merchant-content::-webkit-scrollbar {
  width: 12px;
}

.merchant-content::-webkit-scrollbar-track {
  background: hsl(220 18% 7% / .55);
  border-left: 1px solid var(--shop-border);
}

.merchant-content::-webkit-scrollbar-thumb {
  background: hsl(0 0% 100% / .22);
  border-radius: 10px;
}

.merchant-content::-webkit-scrollbar-thumb:hover {
  background: hsl(0 0% 100% / .32);
}

/* Overlay scrollbar for Merchant (same look as Shop) */
.merchant-scrollbar {
  position: absolute;                 /* lives inside .merchant-sheet */
  right: 6px;
  /* top/bottom are set from JS so it respects grabber/header/actions */
  width: 8px;
  border-radius: 6px;
  background: transparent;            /* no track fill */
  pointer-events: auto;
  z-index: 4;                         /* above content/header */
}

.merchant-scrollbar__thumb {
  width: 100%;
  min-height: 28px;                   /* readable minimum */
  border-radius: 6px;
  background: hsl(0 0% 100% / .28);
  box-shadow: inset 0 0 0 1px hsl(0 0% 100% / .12);
  transform: translateY(0);           /* JS updates this */
  transition: background .15s ease;
  cursor: grab;
}

.merchant-scrollbar__thumb:hover {
  /* desktop hover; harmless on mobile */
  background: hsl(0 0% 100% / .36);
}

.merchant-scrollbar__thumb.dragging {
  cursor: grabbing;
}

/* Mobile: hide custom scrollbar until actively scrolling or dragging */
@media (hover: none) and (pointer: coarse) {
  .merchant-scrollbar {
    opacity: 0;
    pointer-events: none;              /* don’t steal touches when hidden */
    transition: opacity .2s ease;
  }

  .merchant-sheet.is-scrolling .merchant-scrollbar,
  .merchant-scrollbar__thumb.dragging {
    opacity: 1;
    pointer-events: auto;              /* interactive when visible */
  }
}

.merchant-header {
  position: sticky;
  top: 0;
  z-index: 10;
  padding: 10px 12px 8px;
  background: transparent;
  backdrop-filter: inherit;
  -webkit-backdrop-filter: inherit;
  isolation: isolate;
}
.merchant-title {
  margin: 0 0 8px;
  font-weight: 700;
  text-align: center;
  color: white;
  position: relative;
  z-index: 2;
}
.merchant-line  {
  height: 2px;
  width: 100%;
  background: var(--shop-border);
  position: relative;
  z-index: 2;
}

.merchant-header::after {
  content: '';
  position: absolute;
  left: 0;
  right: 0;
  top: calc(100% - 1px);
  height: var(--merchant-fade-size);
  background: linear-gradient(180deg, var(--shop-bg), hsla(215, 32%, 7%, 0));
  opacity: 0;
  pointer-events: none;
  transition: opacity 160ms ease;
  z-index: 1;
}

/* Dialog row */
.merchant-dialog { padding: 12px; display: grid; }
.merchant-bubble {
  display: grid;
  grid-template-columns: auto 1fr;
  gap: 12px;
  align-items: start;
  background: var(--merchant-card);
  border: 1px solid var(--merchant-border);
  border-radius: var(--shop-radius);
  padding: 14px;
}
/* Regular Merchant dialogue bubble icon */
.merchant-icon {
  width: clamp(60px, 12vw, 96px);
  height: clamp(60px, 12vw, 96px);
  object-fit: contain;
  display: block;
}

.merchant-text {
  color: hsl(0 0% 100% / .9);
  font: 500 1rem/1.3 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
}

/* Merchant actions (footer) */
.merchant-actions {
  display: flex; justify-content: center; align-items: center; gap: 12px;
  padding: 12px 16px calc(12px + var(--safe-bottom));
}
.merchant-actions .merchant-close {
  min-width: 180px;
  height: 44px;
  border-radius: 0;
  border: 1px solid hsla(0, 80%, 40%, 0.45);
  background: hsla(0, 80%, 40%, 0.15);
  color: #fff;
  font-weight: 600;
  letter-spacing: .2px;
  cursor: pointer;
  transition: transform 120ms ease, background 120ms ease, border-color 120ms ease;
}
.merchant-actions .merchant-close:hover {
  background: hsla(0, 80%, 40%, 0.22);
}
.merchant-actions .merchant-close:active {
  transform: translateY(1px);
  background: hsla(0, 80%, 40%, 0.28);
}

/* First-time chat overlay (full-sheet scrim + centered card, no animation) */
.merchant-firstchat {
  position: absolute;
  inset: 0;
  display: none;               /* stays hidden until .is-visible */
  place-items: center;
  z-index: 50;                 /* above other sheet content */
  pointer-events: none;        /* we'll re-enable on the card */
  isolation: isolate;          /* keep blur from affecting the card */
}

/* When visible: show and absorb clicks */
.merchant-firstchat.is-visible {
  display: grid;
  pointer-events: auto;        /* absorb clicks so background is inert */
}

/* The blurred/dimmed scrim */
.merchant-firstchat::before {
  content: "";
  position: absolute;
  inset: 0;
  backdrop-filter: blur(12px) brightness(0.6);
  -webkit-backdrop-filter: blur(12px) brightness(0.6);
  background: var(--merchant-bg);
}

/* While first-chat is up, hide the sheet content and footer controls */
.merchant-overlay.firstchat-active .merchant-content,
.merchant-overlay.firstchat-active .merchant-actions {
  visibility: hidden;
}


/* The card sits above the blur and stays crisp */
.merchant-firstchat__card {
  position: relative;          /* create a new stacking context over ::before */
  width: min(720px, 92vw);
  background: var(--merchant-card);
  border: 1px solid var(--merchant-border);
  box-shadow: var(--shop-shadow);
  padding: 16px;
  pointer-events: auto;        /* clickable while the scrim eats background clicks */
}

/* Header + rule (unchanged, included here for completeness) */
.merchant-firstchat__header .name {
  font-weight: 700; color: white; margin-bottom: 8px; text-align: left;
}
.merchant-firstchat__header .rule {
  height: 2px; width: 100%; background: var(--shop-border); margin-bottom: 12px;
}

/* Row layout (icon left, text right) */
.merchant-firstchat__row {
  display: grid; grid-template-columns: auto 1fr; gap: 12px; align-items: start;
}
.merchant-firstchat__icon {
  width: clamp(60px, 12vw, 96px);
  height: clamp(60px, 12vw, 96px);
  object-fit: contain;
}
.merchant-firstchat__text { color: hsl(0 0% 100% / .9); }

/* Actions */
.merchant-firstchat__actions { display: flex; justify-content: flex-end; margin-top: 14px; }
.merchant-firstchat__continue {
  min-width: 140px; height: 38px;
  border: 1px solid hsla(150, 60%, 35%, 0.45);
  background: hsla(150, 60%, 35%, 0.15);
  color: #fff; font-weight: 600; letter-spacing: .2px; cursor: pointer;
}

/* Make the text feel interactive while it’s typing (tap/click to skip) */
.merchant-firstchat__text.is-typing {
  cursor: pointer;
}

.merchant-firstchat__choices {
  display: grid;
  gap: clamp(6px, 1.2vw, 10px);
  margin-top: 12px;
  opacity: 0;
  transform: translateY(6px);
  transition: opacity 140ms ease, transform 140ms ease;
  pointer-events: none;                 /* <— prevent early clicks */
}
.merchant-firstchat__choices.is-visible {
  opacity: 1;
  transform: translateY(0);
  pointer-events: auto;                 /* <— clickable only when visible */
}

.merchant-firstchat__choices .choice {
  min-height: 38px;
  padding: 8px 12px;
  text-align: left;
  border-radius: 8px;
  border: 1px solid var(--shop-border);
  background: hsl(0 0% 100% / .06);
  color: #fff;
  font-weight: 600;
  letter-spacing: .2px;
  cursor: pointer;
  transition: background 120ms ease, transform 90ms ease;
}
.merchant-firstchat__choices .choice:hover {
  background: hsl(0 0% 100% / .10);
}
.merchant-firstchat__choices .choice:active {
  transform: translateY(1px);
}

.merchant-lockinfo .merchant-firstchat__card {
  max-width: clamp(320px, 62vw, 420px);
}

.merchant-lockinfo__row {
  align-items: flex-start;
  gap: clamp(12px, 3vw, 18px);
}

.merchant-lockinfo__message {
  line-height: 1.45;
}

.merchant-lockinfo__actions {
  margin-top: 18px;
}

.merchant-lockinfo__close{
  min-width:130px;
  height:44px;
  border-radius:0;
  border:1px solid hsla(0,80%,40%,0.45);
  background:hsla(0,80%,40%,0.15);
  color:#fff; font-weight:600; letter-spacing:.2px; cursor:pointer;
  transition: transform 120ms ease, background 120ms ease, border-color 120ms ease;
}
.merchant-lockinfo__close:hover { background: hsla(0,80%,40%,0.22); }
.merchant-lockinfo__close:active{ transform: translateY(1px); background: hsla(0,80%,40%,0.28); }

.merchant-tabs {
  display: flex;
  gap: 8px;
  padding: 10px 12px 0;
}

.merchant-tab {
  padding: 6px 12px;
  border-radius: 10px;
  border: 1px solid var(--shop-border);
  background: hsl(0 0% 100% / .04);
  color: #fff;
  font-weight: 600;
  letter-spacing: .2px;
  cursor: pointer;
  transition: background 120ms ease, transform 90ms ease, opacity 120ms ease;
}
.merchant-tab:hover { background: hsl(0 0% 100% / .08); }
.merchant-tab:active { transform: translateY(1px); }

.merchant-tab.is-active {
  background: hsl(0 0% 100% / .12);
  box-shadow: inset 0 -2px 0 hsl(0 0% 100% / .18);
}

.merchant-tab.is-locked {
  opacity: .45;
  cursor: not-allowed;
}

/* Panels */
.merchant-panels { padding: 12px; }
.merchant-panel { display: none; }
.merchant-panel.is-active { display: block; }

.merchant-reset {
  display: grid;
  grid-template-columns: minmax(140px, 160px) 1fr;
  gap: 16px;
  align-items: stretch;
}

.merchant-reset__sidebar {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.merchant-reset__layer {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  border: 0;
  border-radius: 12px;
  background: rgba(255,255,255,0.04);
  color: #f5f8ff;
  font-weight: 600;
  cursor: pointer;
  transition: background 120ms ease;
}

.merchant-reset__layer img {
  width: 36px;
  height: 36px;
  object-fit: contain;
}

.merchant-reset__layer.is-active {
  background: linear-gradient(180deg, rgba(255,169,0,0.4), rgba(255,115,0,0.25));
  box-shadow: inset 0 0 0 2px rgba(255,179,0,0.35);
}

.merchant-reset__main {
  background: var(--merchant-card-soft);
  border: 1px solid var(--merchant-border);
  border-radius: 16px;
  padding: 18px 20px;
  display: flex;
  flex-direction: column;
  gap: 18px;
  box-shadow: inset 0 1px 0 rgba(255,255,255,0.04);
}

.merchant-reset__header {
  display: flex;
  gap: 16px;
  align-items: center;
}

.merchant-reset__icon {
  width: 56px;
  height: 56px;
  object-fit: contain;
}

.merchant-reset__titles h3 {
  margin: 0;
  font-size: 1.25rem;
  color: #ffe6c4;
}

.merchant-reset__titles p {
  margin: 4px 0 0;
  color: #d7deff;
  font-size: 0.9rem;
  line-height: 1.4;
}

.merchant-reset__body {
  display: flex;
  flex-direction: column;
  gap: 14px;
}

.merchant-reset__reward {
  display: inline-flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  background: rgba(255,186,0,0.12);
  border-radius: 12px;
  color: #ffd27f;
  font-weight: 700;
  font-size: 1.1rem;
}

.merchant-reset__reward img {
  width: 32px;
  height: 32px;
  object-fit: contain;
}

.merchant-reset__status {
  color: #f0f3ff;
  font-size: 0.95rem;
  line-height: 1.5;
  min-height: 44px;
}

.merchant-reset__action {
  align-self: flex-start;
  padding: 10px 22px;
  font-size: 1rem;
  font-weight: 700;
  border-radius: 999px;
  border: 0;
  background: linear-gradient(180deg, rgba(255,170,0,0.9), rgba(225,110,0,0.9));
  color: #200a00;
  cursor: pointer;
  transition: transform 120ms ease, opacity 120ms ease;
}

.merchant-reset__action:disabled {
  cursor: not-allowed;
  opacity: 0.45;
}

.merchant-reset__action:not(:disabled):active {
  transform: translateY(1px);
}

@media (max-width: 900px) {
  .merchant-reset {
    grid-template-columns: 1fr;
  }

  .merchant-reset__sidebar {
    flex-direction: row;
    overflow-x: auto;
  }

  .merchant-reset__layer {
    min-width: 140px;
    justify-content: center;
  }
}

@media (max-height: 500px) and (orientation: landscape) {
  .merchant-firstchat {
    align-items: flex-start; 
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    padding: 16px 0;
  }

  .merchant-firstchat__card {
    margin: auto;
    max-height: unset;
  }
}

/* Scrollable list that works on phones and desktop */
.merchant-dialogue-list {
  display: grid;
  gap: 10px;
  max-height: min(42vh, 520px);
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding-right: 2px; /* avoid scrollbar overlay on text */
  -ms-overflow-style: none;     /* IE/Edge */
  scrollbar-width: none;        /* Firefox */
}
.merchant-dialogue-list::-webkit-scrollbar { width: 0; height: 0; }

/* Dialogue entry cards */
.dlg-card {
  position: relative;              /* allow absolute-positioned right label */
  display: grid;
  grid-template-columns: 1fr;      /* left column only; right label is absolute */
  grid-auto-rows: min-content;
  gap: 4px;
  align-items: start;
  text-align: left;
  padding: clamp(8px,1.2vw,12px) clamp(10px,2vw,14px);
  border-radius: 12px;
  border: 2px solid var(--shop-border, rgba(255,255,255,.12));
  color: #fff;
  cursor: pointer;
  transition: background 120ms ease, transform 90ms ease, opacity 120ms ease;
}
.dlg-card:not(.is-complete):hover { background: rgba(255,255,255,.18); }
.dlg-card:active { transform: none; }
.dlg-card.is-locked,
.dlg-card:disabled {
  opacity: .45;
  cursor: not-allowed;
  background: #1f1f1f;
}

.dlg-card.is-locked:hover {
  background: #272831;
}

.dlg-card.is-mysterious {
  opacity: .45;
  background: #1f1f1f;
  border-style: solid;
}

.dlg-card.is-mysterious:hover { background: #272831; }
.dlg-card:not(.is-complete):not(.is-mysterious):not(.is-locked) { background: rgba(255,255,255,0.12); }
.dlg-card.is-complete { background: rgba(255,255,255,0.03); }
.dlg-card.is-complete:hover { background: rgba(255,255,255,0.06); }
.dlg-card:not(.is-locked):not(.is-mysterious):not(.is-complete):hover {
  background: rgba(255,255,255,.15);
  transition: background 120ms ease;
}


.dlg-card.has-again {
  padding-right: calc(clamp(10px,2vw,14px) + 110px);
}

/* Left column content */
.dlg-title { font-weight: 700; letter-spacing: .2px; }
.dlg-blurb { opacity: .75; font-size: .95em; }

/* Reward line */
.dlg-reward {
  display: inline-flex;
  align-items: center;
  gap: 3px;
  font-size: .95em;
  opacity: .85;
  justify-self: start;
  align-self: start;
  width: max-content;
  position: relative;
}

.dlg-reward .reward-label { opacity: .85; margin-right: 3px; }

.dlg-reward .coin { display: inline-flex; align-items: center; gap: 2px; }
.dlg-reward .coin-icon {
  width: 0.85em;
  height: 0.85em;
  flex: 0 0 0.85em;
  background: url('../../img/currencies/coin/coin.png') center / contain no-repeat;
  position: relative;
  top: 1px;
}

.dlg-reward .book { display: inline-flex; align-items: center; gap: 2px; }
.dlg-reward .book-icon {
  width: 0.85em;
  height: 0.85em;
  flex: 0 0 0.85em;
  background: url('../../img/currencies/book/book.png') center / contain no-repeat;
  position: relative;
  top: 1px;
}

.dlg-card.is-complete .dlg-title,
.dlg-card.is-complete .dlg-blurb,
.dlg-card.is-complete .dlg-reward {
  color: rgba(255,255,255,.55);
  opacity: .9;
}

/* Strike-through only across the reward content width */
.dlg-card.is-complete .dlg-reward::after {
  content: "";
  position: absolute;
  left: 0;
  top: 55%;
  width: calc(100% + 1px);
  height: 2px;
  background: #888888;
  transform: translateY(-50%);
  pointer-events: none;
  border-radius: 1px;         /* softer edges */
}

/* Replay hint (“Ask Again?”) */
.dlg-again {
  position: absolute;
  right: clamp(10px,2vw,14px);
  top: 50%;
  transform: translateY(-50%);
  color: rgba(255,255,255,.5);
  font-weight: 400;
  font-size: .95em;
  white-space: nowrap;
  pointer-events: none;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  letter-spacing: 0;
}
.dlg-again::before {
  content: '↻';
  opacity: .75;
  font-weight: 400;
}

@media (max-height: 500px) and (orientation: landscape) {
  .merchant-dialogue-list { max-height: 46vh; }
}

@media (pointer: coarse) {
  .dlg-reward .coin-icon,
  .dlg-reward .book-icon {
    top: 0;
  }
}
