<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>
    <title>CCC</title>

    <link rel="apple-touch-icon" sizes="180x180" href="favicon/apple-touch-icon.webp"/>
    <link rel="icon" type="image/webp" sizes="32x32" href="favicon/favicon-32x32.webp"/>
    <link rel="icon" type="image/webp" sizes="16x16" href="favicon/favicon-16x16.webp"/>
    <link rel="shortcut icon" href="favicon/favicon.ico" type="image/x-icon"/>

    <script>
      (function () {
        try {
          if (localStorage.getItem('ccc:hasOpenedSaveSlot') === 'true') {
            document.documentElement.classList.add('has-opened');
          }
        } catch (e) {}
      })();
    </script>

    <style>
      @media (pointer: coarse) {
        * {
          -webkit-user-select: none;
          -moz-user-select: none;
          -ms-user-select: none;
          user-select: none;
          -webkit-touch-callout: none;
          -webkit-tap-highlight-color: transparent;
          -webkit-user-drag: none;
        }
      }

      .loading-screen {
        position: fixed;
        inset: 0;
        background: #000;
        color: #fff;
        display: grid;
        place-items: center;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        z-index: 2147483647;
      }

      .loading-screen__text {
        font-size: 1.1rem;
        opacity: 0.9;
      }

      .booting .menu-root,
      .booting #game-root {
        display: none !important;
      }
    </style>

    <script>
      document.documentElement.classList.add('booting');
    </script>

    <link rel="stylesheet" href="./styles.css"/>
  </head>

  <body class="menu-bg">
    <main class="menu-root">
      <header class="menu-header">
        <h1 class="game-title">
          C<span class="sr-only"></span><span class="coin-o"></span>in
          C<span class="sr-only"></span><span class="coin-o"></span>llecting
          C<span class="sr-only"></span><span class="coin-o"></span>ve
        </h1>
      </header>

      <section class="menu-panel" role="region" aria-labelledby="panel-title">
        <div class="panel-header">
          <h2 id="panel-title" class="panel-title">Select a Save Slot</h2>
          <div class="panel-actions">
            <button class="btn btn-ghost" type="button" id="manage-saves">
              Manage save slots
            </button>
          </div>
        </div>

        <div class="slots-grid">
          <button class="slot-card" type="button" aria-label="Save Slot 1">
            <div class="slot-badge">Slot 1</div>
            <div class="slot-title">No save data</div>
          </button>

          <button class="slot-card" type="button" aria-label="Save Slot 2">
            <div class="slot-badge">Slot 2</div>
            <div class="slot-title">No save data</div>
          </button>

          <button class="slot-card" type="button" aria-label="Save Slot 3">
            <div class="slot-badge">Slot 3</div>
            <div class="slot-title">No save data</div>
          </button>
        </div>
      </section>
    </main>

    <main id="game-root" class="area area-cove" hidden>
      <div class="hud-top">
        <div class="coin-counter">
          <img src="img/currencies/coin/coin_plus_base.webp" alt="" class="coin-plus"/>
          <div class="coin-bar">
            <span class="coin-amount">0</span>
          </div>
        </div>

        <div class="xp-counter" data-xp-hud hidden>
          <img src="img/stats/xp/xp_plus_base.webp" alt="" class="xp-plus"/>

          <div class="xp-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" aria-valuetext="0 / 10 XP">
            <div class="xp-bar__fill" style="width: 0%"></div>
			
            <div class="xp-bar__frame">
              <div class="xp-bar__level">
                Level<span class="xp-level-value">0</span>
              </div>

              <div class="xp-bar__divider" aria-hidden="true"></div>

              <div class="xp-bar__progress" data-xp-progress>
                0<span class="xp-progress-separator">/</span>10<span class="xp-progress-suffix">XP</span>
              </div>
            </div>
          </div>
        </div>

        <div class="mp-counter" data-mp-hud hidden>
          <img src="img/stats/mp/mp_plus_base.webp" alt="" class="mp-plus"/>

          <div class="mp-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" aria-valuetext="0 / 10 MP">
            <div class="mp-bar__fill" style="width: 0%"></div>

            <div class="mp-bar__frame">
              <div class="mp-bar__level">
                Mutation<span class="mp-level-value">0</span>
              </div>

              <div class="mp-bar__divider" aria-hidden="true"></div>

              <div class="mp-bar__progress" data-mp-progress>
                0<span class="mp-progress-separator">/</span>10<span class="mp-progress-suffix">MP</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <section class="playfield" aria-label="Starter Cove Sand">
        <div class="waves" id="waves">
          <div class="water-base" id="water-base"></div>
          <div class="surges" id="surges"></div>
        </div>

        <div class="coins-layer" id="coins-layer"></div>
      </section>

      <nav class="hud-bottom" id="hud-bottom">
        <button class="game-btn btn-help" data-btn="help"><span>Help</span></button>
        <button class="game-btn btn-shop" data-btn="shop"><span>Shop</span></button>
        <button class="game-btn btn-stats" data-btn="stats"><span>Stats &amp; Settings</span></button>
        <button class="game-btn btn-map" data-btn="map"><span>Map</span></button>
      </nav>
    </main>
    <script src="./bundle.js"></script>
<script type="module">
  // 1. Updated Imports: Added 'createUserWithEmailAndPassword' and 'signInWithEmailAndPassword'
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
  import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
  import { 
    getAuth, 
    GoogleAuthProvider, 
    signInWithPopup, 
    onAuthStateChanged, 
    signOut,
    createUserWithEmailAndPassword, // <-- NEW
    signInWithEmailAndPassword      // <-- NEW
  } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

  // 2. YOUR CONFIG
  const firebaseConfig = {
    apiKey: "AIzaSyA9x_8eumoHuC9G5YQITElvlRmjEjpBDo0", 
    authDomain: "ccc-firebase-cf0ef.firebaseapp.com",
    projectId: "ccc-firebase-cf0ef",
    storageBucket: "ccc-firebase-cf0ef.firebasestorage.app",
    messagingSenderId: "398214123922",
    appId: "1:398214123922:web:0583d13fbf6ed44a6d314b",
    measurementId: "G-3X6HK77SB7"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  let currentUser = null;

  // --- GOOGLE LOGIN ---
  window.loginWithGoogle = async () => {
    try {
      await signInWithPopup(auth, provider);
      // onAuthStateChanged will handle the rest
    } catch (error) {
      console.error("Google Login failed:", error);
      alert("Google Login Error: " + error.message);
    }
  };

  // --- EMAIL SIGN UP (New Account) ---
  window.registerWithEmail = async () => {
    const email = document.getElementById("email-input").value;
    const pass = document.getElementById("pass-input").value;

    try {
      await createUserWithEmailAndPassword(auth, email, pass);
      alert("Account created!");
      // onAuthStateChanged will handle the rest
    } catch (error) {
      console.error("Registration failed:", error);
      alert("Error: " + error.message);
    }
  };

  // --- EMAIL LOGIN (Existing Account) ---
  window.loginWithEmail = async () => {
    const email = document.getElementById("email-input").value;
    const pass = document.getElementById("pass-input").value;

    try {
      await signInWithEmailAndPassword(auth, email, pass);
      // onAuthStateChanged will handle the rest
    } catch (error) {
      console.error("Login failed:", error);
      alert("Error: " + error.message);
    }
  };

  // --- LOGOUT ---
  window.logout = async () => {
    await signOut(auth);
    alert("Logged out!");
    location.reload(); // Reload page to reset game state
  };

  // --- SAVE GAME STATE ---
  window.saveGameState = async (coins, upgrades) => {
    if (!currentUser) {
      alert("You must be logged in to save!");
      return;
    }
    try {
      await setDoc(doc(db, "players", currentUser.uid), {
        coins: coins,
        upgrades: upgrades,
        email: currentUser.email, // Useful for you to see who is who
        lastSaved: Date.now()
      });
      console.log("Game Saved!");
      alert("Game Saved successfully!");
    } catch (e) {
      console.error("Error saving: ", e);
    }
  };

  // --- LOAD GAME STATE ---
  window.loadGameState = async () => {
    if (!currentUser) return;
    const docRef = doc(db, "players", currentUser.uid);
    const docSnap = await getDoc(docRef);

    if (docSnap.exists()) {
      const data = docSnap.data();
      console.log("Save loaded:", data);
      alert(`Loaded save! Coins: ${data.coins}`);
      // TODO: Update your actual game variables here
    } else {
      console.log("No save file found. Starting fresh.");
    }
  };
  
  // --- AUTH LISTENER (Runs automatically when login status changes) ---
  onAuthStateChanged(auth, (user) => {
    if (user) {
      currentUser = user;
      document.getElementById("auth-forms").style.display = "none"; // Hide inputs
      document.getElementById("user-panel").style.display = "block"; // Show user info
      document.getElementById("user-info").innerText = `Signed in as: ${user.email}`;
      loadGameState();
    } else {
      currentUser = null;
      document.getElementById("auth-forms").style.display = "block";
      document.getElementById("user-panel").style.display = "none";
    }
  });
</script>


<div id="firebase-ui" style="
    position: fixed; 
    top: 10px; 
    left: 10px; 
    z-index: 10000; 
    background-color: rgba(0, 0, 0, 0.85); 
    padding: 15px; 
    border-radius: 8px; 
    color: white; 
    font-family: sans-serif;
    width: 250px;
">
    
    <div id="auth-forms">
        <h4 style="margin-top:0;">Login / Sign Up</h4>
        
        <input type="email" id="email-input" placeholder="Email" style="width: 100%; margin-bottom: 5px; box-sizing: border-box;">
        <input type="password" id="pass-input" placeholder="Password" style="width: 100%; margin-bottom: 10px; box-sizing: border-box;">
        
        <div style="display: flex; gap: 5px; margin-bottom: 10px;">
            <button onclick="loginWithEmail()" style="flex: 1; cursor: pointer;">Login</button>
            <button onclick="registerWithEmail()" style="flex: 1; cursor: pointer;">Sign Up</button>
        </div>

        <hr style="border-color: #555;">
        
        <button onclick="loginWithGoogle()" style="width: 100%; cursor: pointer; font-weight: bold; background: #db4437; color: white; border: none; padding: 8px;">
            G Sign in with Google
        </button>
    </div>

    <div id="user-panel" style="display: none;">
        <p id="user-info" style="margin: 0 0 10px 0; font-size: 13px; color: #81c784;"></p>
        
        <button onclick="saveGameState(100, ['test'])" style="width: 100%; margin-bottom: 5px; cursor: pointer;">
            ðŸ’¾ Manual Save
        </button>
        
        <button onclick="logout()" style="width: 100%; cursor: pointer; background: #555; color: white; border: none;">
            Logout
        </button>
    </div>

</div>
  </body>
</html>
